<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>业务员奖金自动化计算系统</title>
    <!-- SheetJS库，用于解析Excel文件 -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        /* 导航栏 */
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 40px;
            font-size: 28px;
            font-weight: bold;
            text-align: center;
            letter-spacing: 2px;
        }

        /* 步骤指引 */
        .steps {
            display: flex;
            justify-content: space-around;
            padding: 30px 40px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            position: relative;
            color: #adb5bd;
            font-weight: 600;
        }

        .step::before {
            content: '';
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #dee2e6;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            font-size: 18px;
            color: white;
        }

        .step.active {
            color: #667eea;
        }

        .step.active::before {
            background: #667eea;
        }

        .step.completed::before {
            background: #28a745;
        }

        /* 主内容区 */
        main {
            padding: 40px;
        }

        section {
            display: none;
            animation: fadeIn 0.5s;
        }

        section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 上传区域 */
        .upload-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .upload-card {
            border: 3px dashed #dee2e6;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            background: #f8f9fa;
        }

        .upload-card:hover {
            border-color: #667eea;
            background: #f0f3ff;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
        }

        .upload-card.uploaded {
            border-color: #28a745;
            background: #f0fff4;
        }

        .upload-card h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .upload-card input[type="file"] {
            display: none;
        }

        .upload-icon {
            font-size: 48px;
            color: #adb5bd;
            margin-bottom: 15px;
        }

        .upload-card.uploaded .upload-icon {
            color: #28a745;
        }

        .upload-status {
            color: #28a745;
            font-weight: 600;
            margin-top: 10px;
        }

        /* 按钮 */
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* 数据表格 */
        .table-container {
            overflow-x: auto;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* 配置面板 */
        .config-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .config-panel h3 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .config-item {
            display: flex;
            flex-direction: column;
        }

        .config-item label {
            color: #6c757d;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
        }

        .config-item input {
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .config-item input:focus {
            outline: none;
            border-color: #667eea;
        }

        /* 消息提示 */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }

        .alert.show {
            display: block;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }

        /* 结果卡片 */
        .result-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .result-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .result-card h4 {
            font-size: 16px;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .result-card .value {
            font-size: 32px;
            font-weight: bold;
        }

        /* 加载动画 */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 按钮组 */
        .button-group {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        /* 切换开关 */
        .toggle-switch {
            display: flex;
            align-items: center;
            margin: 20px 0;
        }

        .toggle-switch input[type="checkbox"] {
            width: 50px;
            height: 26px;
            -webkit-appearance: none;
            appearance: none;
            background: #ccc;
            outline: none;
            border-radius: 26px;
            transition: 0.3s;
            cursor: pointer;
            margin-right: 10px;
            position: relative;
        }

        .toggle-switch input:checked {
            background: #667eea;
        }

        .toggle-switch input::before {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: white;
            top: 2px;
            left: 2px;
            transition: 0.3s;
        }

        .toggle-switch input:checked::before {
            left: 26px;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .container {
                border-radius: 0;
            }

            .navbar {
                font-size: 20px;
                padding: 20px;
            }

            main {
                padding: 20px;
            }

            .steps {
                flex-direction: column;
                gap: 15px;
            }

            .upload-container {
                grid-template-columns: 1fr;
            }

            .config-grid {
                grid-template-columns: 1fr;
            }
        }

        /* 数据统计区 */
        .data-summary {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-label {
            color: #6c757d;
            font-weight: 600;
        }

        .summary-value {
            color: #495057;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 导航栏 -->
        <nav class="navbar">
            业务员奖金自动化计算系统
        </nav>

        <!-- 步骤指引 -->
        <div class="steps">
            <div class="step active" data-step="1">
                <span>📤 上传数据</span>
            </div>
            <div class="step" data-step="2">
                <span>✓ 数据验证</span>
            </div>
            <div class="step" data-step="3">
                <span>⚙️ 计算处理</span>
            </div>
            <div class="step" data-step="4">
                <span>📊 结果展示</span>
            </div>
        </div>

        <!-- 主要内容区 -->
        <main>
            <!-- 消息提示 -->
            <div id="alert" class="alert"></div>

            <!-- 加载动画 -->
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>正在处理数据，请稍候...</p>
            </div>

            <!-- 步骤1: 上传数据 -->
            <section id="upload-section" class="active">
                <h2 style="margin-bottom: 30px; color: #495057;">📤 数据上传</h2>
                
                <div class="upload-container">
                    <div class="upload-card" id="employee-card" onclick="document.getElementById('employee-file').click()">
                        <div class="upload-icon">👥</div>
                        <h3>员工基础信息表</h3>
                        <p style="color: #6c757d; font-size: 14px;">包含：员工姓名、标准奖金、所属地区、业务类型</p>
                        <input type="file" id="employee-file" accept=".csv,.xlsx,.xls" onchange="handleFileUpload(this, 'employee')">
                        <div class="upload-status" id="employee-status"></div>
                    </div>

                    <div class="upload-card" id="payment-card" onclick="document.getElementById('payment-file').click()">
                        <div class="upload-icon">💰</div>
                        <h3>月度回款数据表</h3>
                        <p style="color: #6c757d; font-size: 14px;">包含：员工姓名、年月、月度任务、实际回款</p>
                        <input type="file" id="payment-file" accept=".csv,.xlsx,.xls" onchange="handleFileUpload(this, 'payment')">
                        <div class="upload-status" id="payment-status"></div>
                    </div>

                    <div class="upload-card" id="assessment-card" onclick="document.getElementById('assessment-file').click()">
                        <div class="upload-icon">📋</div>
                        <h3>211考核数据表 (可选)</h3>
                        <p style="color: #6c757d; font-size: 14px;">包含：员工姓名、年月、目标得分、实际得分</p>
                        <input type="file" id="assessment-file" accept=".csv,.xlsx,.xls" onchange="handleFileUpload(this, 'assessment')">
                        <div class="upload-status" id="assessment-status"></div>
                    </div>
                </div>

                <!-- 参数配置 -->
                <div class="config-panel">
                    <h3>⚙️ 参数配置</h3>
                    <div class="config-grid">
                        <div class="config-item">
                            <label>月度奖金比例 (%)</label>
                            <input type="number" id="monthly-ratio" value="70" min="0" max="100">
                        </div>
                        <div class="config-item">
                            <label>季度奖金比例 (%)</label>
                            <input type="number" id="quarterly-ratio" value="30" min="0" max="100">
                        </div>
                        <div class="config-item">
                            <label>完成率50%-80%罚款比例 (%)</label>
                            <input type="number" id="penalty1-ratio" value="10" min="0" max="100">
                        </div>
                        <div class="config-item">
                            <label>完成率<50%罚款比例 (%)</label>
                            <input type="number" id="penalty2-ratio" value="20" min="0" max="100">
                        </div>
                        <div class="config-item">
                            <label>211考核单位罚款金额 (元)</label>
                            <input type="number" id="kitchen-penalty" value="800" min="0">
                        </div>
                        <div class="config-item">
                            <label>季度返还完成率阈值 (%)</label>
                            <input type="number" id="refund-threshold" value="80" min="0" max="100">
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" id="validate-btn" onclick="validateData()" disabled>下一步：验证数据</button>
                </div>
            </section>

            <!-- 步骤2: 数据验证 -->
            <section id="validation-section">
                <h2 style="margin-bottom: 30px; color: #495057;">✓ 数据验证</h2>
                
                <div class="data-summary" id="data-summary"></div>
                
                <div id="validation-result"></div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="goToStep(1)">上一步</button>
                    <button class="btn btn-primary" id="calculate-btn" onclick="calculateBonus()">开始计算</button>
                </div>
            </section>

            <!-- 步骤3: 计算处理 -->
            <section id="calculation-section">
                <h2 style="margin-bottom: 30px; color: #495057;">⚙️ 计算处理</h2>
                <p style="text-align: center; color: #6c757d; font-size: 18px;">正在进行奖金计算...</p>
            </section>

            <!-- 步骤4: 结果展示 -->
            <section id="result-section">
                <h2 style="margin-bottom: 30px; color: #495057;">📊 计算结果</h2>
                
                <!-- 汇总卡片 -->
                <div class="result-cards">
                    <div class="result-card">
                        <h4>总计算人数</h4>
                        <div class="value" id="total-employees">0</div>
                    </div>
                    <div class="result-card">
                        <h4>月度奖金总额</h4>
                        <div class="value" id="total-monthly">¥0</div>
                    </div>
                    <div class="result-card">
                        <h4>季度奖金总额</h4>
                        <div class="value" id="total-quarterly">¥0</div>
                    </div>
                    <div class="result-card">
                        <h4>总奖金</h4>
                        <div class="value" id="total-bonus">¥0</div>
                    </div>
                </div>

                <!-- 显示/隐藏计算说明 -->
                <div class="toggle-switch">
                    <input type="checkbox" id="show-explanation" checked onchange="toggleExplanation()">
                    <label>显示计算说明列</label>
                </div>

                <!-- 月度奖金明细表 -->
                <h3 style="margin: 30px 0 20px 0; color: #495057;">月度奖金明细</h3>
                <div class="table-container">
                    <table id="monthly-result-table">
                        <thead>
                            <tr>
                                <th>员工姓名</th>
                                <th>所属地区</th>
                                <th>年月</th>
                                <th>标准奖金</th>
                                <th>月度任务</th>
                                <th>实际回款</th>
                                <th>完成率</th>
                                <th>基础奖金</th>
                                <th>回款负激励</th>
                                <th>211负激励</th>
                                <th>最终月度奖金</th>
                                <th class="explanation-col">计算说明</th>
                            </tr>
                        </thead>
                        <tbody id="monthly-result-body"></tbody>
                    </table>
                </div>

                <!-- 211厨电考核明细表 -->
                <h3 style="margin: 30px 0 20px 0; color: #495057;">211厨电考核明细（仅杭州地区）</h3>
                <div class="table-container">
                    <table id="assessment-result-table">
                        <thead>
                            <tr>
                                <th>员工姓名</th>
                                <th>所属地区</th>
                                <th>年月</th>
                                <th>目标得分</th>
                                <th>实际得分</th>
                                <th>完成率</th>
                                <th>扣款金额</th>
                                <th class="explanation-col">计算说明</th>
                            </tr>
                        </thead>
                        <tbody id="assessment-result-body"></tbody>
                    </table>
                </div>

                <!-- 回款整体汇总表 -->
                <h3 style="margin: 30px 0 20px 0; color: #495057;">回款整体汇总</h3>
                <div class="table-container">
                    <table id="payment-summary-table">
                        <thead>
                            <tr>
                                <th>员工姓名</th>
                                <th>所属地区</th>
                                <th>年月</th>
                                <th>月度任务</th>
                                <th>实际回款</th>
                                <th>月度完成率</th>
                                <th>所属季度</th>
                                <th>季度任务</th>
                                <th>季度回款</th>
                                <th>季度完成率</th>
                            </tr>
                        </thead>
                        <tbody id="payment-summary-body"></tbody>
                    </table>
                </div>

                <!-- 季度奖金汇总表 -->
                <h3 style="margin: 30px 0 20px 0; color: #495057;">季度奖金汇总</h3>
                <div class="table-container">
                    <table id="quarterly-result-table">
                        <thead>
                            <tr>
                                <th>员工姓名</th>
                                <th>季度任务</th>
                                <th>季度回款</th>
                                <th>季度完成率</th>
                                <th>基础季度奖金</th>
                                <th>返还金额</th>
                                <th>最终季度奖金</th>
                                <th class="explanation-col">计算说明</th>
                            </tr>
                        </thead>
                        <tbody id="quarterly-result-body"></tbody>
                    </table>
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="goToStep(1)">重新上传</button>
                    <button class="btn btn-success" onclick="exportToExcel('monthly')">导出月度奖金明细</button>
                    <button class="btn btn-success" onclick="exportToExcel('assessment')">导出211考核明细</button>
                    <button class="btn btn-success" onclick="exportToExcel('payment')">导出回款汇总</button>
                    <button class="btn btn-success" onclick="exportToExcel('quarterly')">导出季度奖金汇总</button>
                    <button class="btn btn-success" onclick="exportToExcel('all')">导出全部数据</button>
                </div>
            </section>
        </main>
    </div>

    <script>
        // 全局数据存储
        let appData = {
            employeeData: [],
            paymentData: [],
            assessmentData: [],
            config: {},
            results: {
                monthly: [],
                quarterly: [],
                assessment: [],
                paymentSummary: []
            }
        };

        // 文件上传状态
        let uploadStatus = {
            employee: false,
            payment: false,
            assessment: false
        };

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('系统初始化完成');
        });

        // 显示消息
        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alert');
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
            setTimeout(() => {
                alert.classList.remove('show');
            }, 5000);
        }

        // 切换步骤
        function goToStep(step) {
            // 隐藏所有section
            document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
            
            // 更新步骤状态
            document.querySelectorAll('.step').forEach((s, index) => {
                s.classList.remove('active');
                if (index < step - 1) {
                    s.classList.add('completed');
                } else if (index === step - 1) {
                    s.classList.add('active');
                }
            });

            // 显示对应section
            const sections = ['upload-section', 'validation-section', 'calculation-section', 'result-section'];
            document.getElementById(sections[step - 1]).classList.add('active');
        }

        // 文件上传处理
        async function handleFileUpload(input, type) {
            const file = input.files[0];
            if (!file) return;

            const fileName = file.name;
            const fileExtension = fileName.split('.').pop().toLowerCase();

            try {
                let data;
                if (fileExtension === 'csv') {
                    data = await parseCSV(file);
                } else if (fileExtension === 'xlsx' || fileExtension === 'xls') {
                    data = await parseExcel(file);
                } else {
                    showAlert('不支持的文件格式，请上传 CSV、XLSX 或 XLS 文件', 'error');
                    return;
                }

                // 存储数据
                if (type === 'employee') {
                    appData.employeeData = data;
                } else if (type === 'payment') {
                    appData.paymentData = data;
                } else if (type === 'assessment') {
                    appData.assessmentData = data;
                }

                // 更新UI
                uploadStatus[type] = true;
                document.getElementById(`${type}-card`).classList.add('uploaded');
                document.getElementById(`${type}-status`).textContent = `✓ 已上传 (${data.length} 条记录)`;

                // 检查是否可以进入下一步
                if (uploadStatus.employee && uploadStatus.payment) {
                    document.getElementById('validate-btn').disabled = false;
                }

                showAlert(`${file.name} 上传成功！`, 'success');
            } catch (error) {
                showAlert(`文件解析失败：${error.message}`, 'error');
                console.error('File parsing error:', error);
            }
        }

        // CSV解析
        function parseCSV(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const text = e.target.result;
                        const lines = text.split('\n').filter(line => line.trim());
                        const headers = lines[0].split(',').map(h => h.trim());
                        
                        const data = [];
                        for (let i = 1; i < lines.length; i++) {
                            const values = lines[i].split(',').map(v => v.trim());
                            const row = {};
                            headers.forEach((header, index) => {
                                row[header] = values[index];
                            });
                            data.push(row);
                        }
                        resolve(data);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error('文件读取失败'));
                reader.readAsText(file, 'UTF-8');
            });
        }

        // Excel解析（支持xlsx和xls）
        function parseExcel(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // 读取第一个工作表
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        // 转换为JSON格式
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                            raw: false,
                            defval: ''
                        });
                        
                        resolve(jsonData);
                    } catch (error) {
                        reject(new Error('Excel文件解析失败：' + error.message));
                    }
                };
                reader.onerror = () => reject(new Error('文件读取失败'));
                reader.readAsArrayBuffer(file);
            });
        }

        // 数据验证
        function validateData() {
            document.getElementById('loading').classList.add('show');
            
            setTimeout(() => {
                try {
                    // 验证员工数据
                    const requiredEmployeeFields = ['员工姓名', '标准奖金', '所属地区'];
                    validateFields(appData.employeeData, requiredEmployeeFields, '员工信息表');

                    // 验证回款数据
                    const requiredPaymentFields = ['员工姓名', '年月', '月度任务', '实际回款'];
                    validateFields(appData.paymentData, requiredPaymentFields, '回款数据表');

                    // 验证211考核数据（如果有）
                    if (appData.assessmentData.length > 0) {
                        const requiredAssessmentFields = ['员工姓名', '年月', '目标得分', '实际得分'];
                        validateFields(appData.assessmentData, requiredAssessmentFields, '211考核表');
                    }

                    // 显示数据摘要
                    showDataSummary();

                    document.getElementById('loading').classList.remove('show');
                    goToStep(2);
                    showAlert('数据验证通过！', 'success');
                } catch (error) {
                    document.getElementById('loading').classList.remove('show');
                    showAlert(error.message, 'error');
                }
            }, 500);
        }

        // 字段验证
        function validateFields(data, requiredFields, tableName) {
            if (!data || data.length === 0) {
                throw new Error(`${tableName}没有数据`);
            }

            const firstRow = data[0];
            const missingFields = requiredFields.filter(field => !(field in firstRow));
            
            if (missingFields.length > 0) {
                throw new Error(`${tableName}缺少必要字段：${missingFields.join(', ')}`);
            }

            // 检查数据完整性
            data.forEach((row, index) => {
                requiredFields.forEach(field => {
                    if (!row[field] || row[field].toString().trim() === '') {
                        throw new Error(`${tableName}第${index + 2}行的"${field}"字段为空`);
                    }
                });
            });
        }

        // 显示数据摘要
        function showDataSummary() {
            const summary = document.getElementById('data-summary');
            const employeeCount = appData.employeeData.length;
            const paymentCount = appData.paymentData.length;
            const assessmentCount = appData.assessmentData.length;

            // 统计月份
            const months = [...new Set(appData.paymentData.map(d => d['年月']))];
            const monthsText = months.join(', ');

            summary.innerHTML = `
                <h4 style="margin-bottom: 15px; color: #495057;">数据概览</h4>
                <div class="summary-item">
                    <span class="summary-label">员工总数：</span>
                    <span class="summary-value">${employeeCount} 人</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">回款记录数：</span>
                    <span class="summary-value">${paymentCount} 条</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">211考核记录数：</span>
                    <span class="summary-value">${assessmentCount} 条</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">涉及月份：</span>
                    <span class="summary-value">${monthsText}</span>
                </div>
            `;
        }

        // 奖金计算
        function calculateBonus() {
            document.getElementById('loading').classList.add('show');
            goToStep(3);

            setTimeout(() => {
                try {
                    // 读取配置
                    appData.config = {
                        monthlyRatio: parseFloat(document.getElementById('monthly-ratio').value) / 100,
                        quarterlyRatio: parseFloat(document.getElementById('quarterly-ratio').value) / 100,
                        penalty1Ratio: parseFloat(document.getElementById('penalty1-ratio').value) / 100,
                        penalty2Ratio: parseFloat(document.getElementById('penalty2-ratio').value) / 100,
                        kitchenPenalty: parseFloat(document.getElementById('kitchen-penalty').value),
                        refundThreshold: parseFloat(document.getElementById('refund-threshold').value) / 100
                    };

                    // 计算月度奖金
                    const monthlyResults = calculateMonthlyBonus();
                    appData.results.monthly = monthlyResults;

                    // 计算季度奖金
                    const quarterlyResults = calculateQuarterlyBonus(monthlyResults);
                    appData.results.quarterly = quarterlyResults;

                    // 生成211考核明细
                    const assessmentResults = generate211AssessmentDetails();
                    appData.results.assessment = assessmentResults;

                    // 生成回款汇总
                    const paymentSummary = generatePaymentSummary(monthlyResults, quarterlyResults);
                    appData.results.paymentSummary = paymentSummary;

                    // 显示结果
                    displayResults();

                    document.getElementById('loading').classList.remove('show');
                    goToStep(4);
                    showAlert('计算完成！', 'success');
                } catch (error) {
                    document.getElementById('loading').classList.remove('show');
                    showAlert(`计算出错：${error.message}`, 'error');
                    console.error('Calculation error:', error);
                }
            }, 1000);
        }

        // 月度奖金计算
        function calculateMonthlyBonus() {
            const results = [];

            appData.paymentData.forEach(payment => {
                const employeeName = payment['员工姓名'];
                const yearMonth = payment['年月'];
                
                // 查找员工信息
                const employee = appData.employeeData.find(e => e['员工姓名'] === employeeName);
                if (!employee) {
                    console.warn(`未找到员工信息：${employeeName}`);
                    return;
                }

                const standardBonus = parseFloat(employee['标准奖金']);
                const region = employee['所属地区'];
                const monthlyTarget = parseFloat(payment['月度任务']);
                const actualPayment = parseFloat(payment['实际回款']);
                const completionRate = actualPayment / monthlyTarget;

                // 基础奖金
                let baseBonus = standardBonus * appData.config.monthlyRatio * completionRate;

                // 负激励（仅杭州）
                let paymentPenalty = 0;
                let kitchenPenalty = 0;

                if (region === '杭州') {
                    // 回款负激励
                    if (completionRate < 0.8 && completionRate >= 0.5) {
                        paymentPenalty = standardBonus * appData.config.penalty1Ratio;
                    } else if (completionRate < 0.5) {
                        paymentPenalty = standardBonus * appData.config.penalty2Ratio;
                    }

                    // 211负激励
                    const assessment = appData.assessmentData.find(
                        a => a['员工姓名'] === employeeName && a['年月'] === yearMonth
                    );
                    
                    if (assessment) {
                        const targetScore = parseFloat(assessment['目标得分']);
                        const actualScore = parseFloat(assessment['实际得分']);
                        const assessmentRate = actualScore / targetScore;
                        kitchenPenalty = (1 - assessmentRate) * appData.config.kitchenPenalty;
                    }
                }

                const finalBonus = Math.max(0, baseBonus - paymentPenalty - kitchenPenalty);

                const explanation = `基础奖金=${baseBonus.toFixed(2)} - 回款罚款=${paymentPenalty.toFixed(2)} - 211罚款=${kitchenPenalty.toFixed(2)} = ${finalBonus.toFixed(2)}`;

                results.push({
                    employeeName,
                    yearMonth,
                    standardBonus,
                    region,
                    monthlyTarget,
                    actualPayment,
                    completionRate,
                    baseBonus,
                    paymentPenalty,
                    kitchenPenalty,
                    finalBonus,
                    explanation
                });
            });

            return results;
        }

        // 季度奖金计算
        function calculateQuarterlyBonus(monthlyResults) {
            const quarterlyData = {};

            // 按员工和季度分组
            monthlyResults.forEach(result => {
                const employeeName = result.employeeName;
                const yearMonth = result.yearMonth;
                const quarter = getQuarter(yearMonth);

                const key = `${employeeName}-${quarter}`;
                
                if (!quarterlyData[key]) {
                    quarterlyData[key] = {
                        employeeName,
                        quarter,
                        standardBonus: result.standardBonus,
                        region: result.region,
                        months: [],
                        totalTarget: 0,
                        totalPayment: 0,
                        totalPaymentPenalty: 0
                    };
                }

                quarterlyData[key].months.push(result);
                quarterlyData[key].totalTarget += result.monthlyTarget;
                quarterlyData[key].totalPayment += result.actualPayment;
                quarterlyData[key].totalPaymentPenalty += result.paymentPenalty;
            });

            // 计算季度奖金
            const results = [];
            Object.values(quarterlyData).forEach(data => {
                const completionRate = data.totalPayment / data.totalTarget;
                
                // 基础季度奖金
                let baseQuarterlyBonus = data.standardBonus * appData.config.quarterlyRatio * 3 * completionRate;

                // 一票否决
                if (completionRate < 0.5) {
                    baseQuarterlyBonus = 0;
                }

                // 奖金返还
                let refundAmount = 0;
                if (completionRate >= appData.config.refundThreshold) {
                    refundAmount = data.totalPaymentPenalty;
                }

                const finalBonus = baseQuarterlyBonus + refundAmount;

                const explanation = `季度基础奖金=${baseQuarterlyBonus.toFixed(2)} + 返还金额=${refundAmount.toFixed(2)} = ${finalBonus.toFixed(2)}`;

                results.push({
                    employeeName: data.employeeName,
                    quarter: data.quarter,
                    totalTarget: data.totalTarget,
                    totalPayment: data.totalPayment,
                    completionRate,
                    baseQuarterlyBonus,
                    refundAmount,
                    finalBonus,
                    explanation
                });
            });

            return results;
        }

        // 获取季度
        function getQuarter(yearMonth) {
            const [year, month] = yearMonth.split('-');
            const monthNum = parseInt(month);
            const quarter = Math.ceil(monthNum / 3);
            return `${year}-Q${quarter}`;
        }

        // 生成211考核明细
        function generate211AssessmentDetails() {
            const results = [];

            appData.assessmentData.forEach(assessment => {
                const employeeName = assessment['员工姓名'];
                const yearMonth = assessment['年月'];
                
                // 查找员工信息
                const employee = appData.employeeData.find(e => e['员工姓名'] === employeeName);
                if (!employee) {
                    console.warn(`未找到员工信息：${employeeName}`);
                    return;
                }

                const region = employee['所属地区'];
                const targetScore = parseFloat(assessment['目标得分']);
                const actualScore = parseFloat(assessment['实际得分']);
                const completionRate = actualScore / targetScore;
                const penalty = (1 - completionRate) * appData.config.kitchenPenalty;

                const explanation = `扣款计算: (1 - ${actualScore}/${targetScore}) × ${appData.config.kitchenPenalty} = ¥${penalty.toFixed(2)}`;

                results.push({
                    employeeName,
                    region,
                    yearMonth,
                    targetScore,
                    actualScore,
                    completionRate,
                    penalty,
                    explanation
                });
            });

            return results;
        }

        // 生成回款汇总
        function generatePaymentSummary(monthlyResults, quarterlyResults) {
            const results = [];
            const quarterlyMap = {};

            // 构建季度数据映射
            quarterlyResults.forEach(q => {
                const key = `${q.employeeName}-${q.quarter}`;
                quarterlyMap[key] = {
                    totalTarget: q.totalTarget,
                    totalPayment: q.totalPayment,
                    completionRate: q.completionRate
                };
            });

            // 处理每月数据
            monthlyResults.forEach(monthly => {
                const quarter = getQuarter(monthly.yearMonth);
                const key = `${monthly.employeeName}-${quarter}`;
                const quarterlyData = quarterlyMap[key] || { totalTarget: 0, totalPayment: 0, completionRate: 0 };

                results.push({
                    employeeName: monthly.employeeName,
                    region: monthly.region,
                    yearMonth: monthly.yearMonth,
                    monthlyTarget: monthly.monthlyTarget,
                    actualPayment: monthly.actualPayment,
                    monthlyCompletionRate: monthly.completionRate,
                    quarter: quarter,
                    quarterlyTarget: quarterlyData.totalTarget,
                    quarterlyPayment: quarterlyData.totalPayment,
                    quarterlyCompletionRate: quarterlyData.completionRate
                });
            });

            return results;
        }

        // 显示结果
        function displayResults() {
            // 计算汇总数据
            const totalEmployees = new Set(appData.results.monthly.map(r => r.employeeName)).size;
            const totalMonthly = appData.results.monthly.reduce((sum, r) => sum + r.finalBonus, 0);
            const totalQuarterly = appData.results.quarterly.reduce((sum, r) => sum + r.finalBonus, 0);
            const totalBonus = totalMonthly + totalQuarterly;

            document.getElementById('total-employees').textContent = totalEmployees;
            document.getElementById('total-monthly').textContent = `¥${totalMonthly.toFixed(2)}`;
            document.getElementById('total-quarterly').textContent = `¥${totalQuarterly.toFixed(2)}`;
            document.getElementById('total-bonus').textContent = `¥${totalBonus.toFixed(2)}`;

            // 显示月度明细
            displayMonthlyResults();

            // 显示211考核明细
            display211Results();

            // 显示回款汇总
            displayPaymentSummary();

            // 显示季度汇总
            displayQuarterlyResults();
        }

        // 显示月度明细
        function displayMonthlyResults() {
            const tbody = document.getElementById('monthly-result-body');
            tbody.innerHTML = '';

            appData.results.monthly.forEach(result => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${result.employeeName}</td>
                    <td>${result.region}</td>
                    <td>${result.yearMonth}</td>
                    <td>¥${result.standardBonus.toFixed(2)}</td>
                    <td>¥${result.monthlyTarget.toFixed(2)}</td>
                    <td>¥${result.actualPayment.toFixed(2)}</td>
                    <td>${(result.completionRate * 100).toFixed(2)}%</td>
                    <td>¥${result.baseBonus.toFixed(2)}</td>
                    <td style="color: #dc3545;">¥${result.paymentPenalty.toFixed(2)}</td>
                    <td style="color: #dc3545;">¥${result.kitchenPenalty.toFixed(2)}</td>
                    <td style="font-weight: bold; color: #28a745;">¥${result.finalBonus.toFixed(2)}</td>
                    <td class="explanation-col" style="font-size: 12px; color: #6c757d;">${result.explanation}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // 显示211考核明细
        function display211Results() {
            const tbody = document.getElementById('assessment-result-body');
            tbody.innerHTML = '';

            if (appData.results.assessment.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #6c757d; padding: 20px;">暂无211考核数据</td></tr>';
                return;
            }

            appData.results.assessment.forEach(result => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${result.employeeName}</td>
                    <td>${result.region}</td>
                    <td>${result.yearMonth}</td>
                    <td>${result.targetScore}</td>
                    <td>${result.actualScore}</td>
                    <td>${(result.completionRate * 100).toFixed(2)}%</td>
                    <td style="color: #dc3545; font-weight: bold;">¥${result.penalty.toFixed(2)}</td>
                    <td class="explanation-col" style="font-size: 12px; color: #6c757d;">${result.explanation}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // 显示回款汇总
        function displayPaymentSummary() {
            const tbody = document.getElementById('payment-summary-body');
            tbody.innerHTML = '';

            appData.results.paymentSummary.forEach(result => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${result.employeeName}</td>
                    <td>${result.region}</td>
                    <td>${result.yearMonth}</td>
                    <td>¥${result.monthlyTarget.toFixed(2)}</td>
                    <td>¥${result.actualPayment.toFixed(2)}</td>
                    <td>${(result.monthlyCompletionRate * 100).toFixed(2)}%</td>
                    <td>${result.quarter}</td>
                    <td>¥${result.quarterlyTarget.toFixed(2)}</td>
                    <td>¥${result.quarterlyPayment.toFixed(2)}</td>
                    <td>${(result.quarterlyCompletionRate * 100).toFixed(2)}%</td>
                `;
                tbody.appendChild(row);
            });
        }

        // 显示季度汇总
        function displayQuarterlyResults() {
            const tbody = document.getElementById('quarterly-result-body');
            tbody.innerHTML = '';

            appData.results.quarterly.forEach(result => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${result.employeeName}</td>
                    <td>¥${result.totalTarget.toFixed(2)}</td>
                    <td>¥${result.totalPayment.toFixed(2)}</td>
                    <td>${(result.completionRate * 100).toFixed(2)}%</td>
                    <td>¥${result.baseQuarterlyBonus.toFixed(2)}</td>
                    <td style="color: #28a745;">¥${result.refundAmount.toFixed(2)}</td>
                    <td style="font-weight: bold; color: #28a745;">¥${result.finalBonus.toFixed(2)}</td>
                    <td class="explanation-col" style="font-size: 12px; color: #6c757d;">${result.explanation}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // 切换计算说明显示
        function toggleExplanation() {
            const showExplanation = document.getElementById('show-explanation').checked;
            const explanationCols = document.querySelectorAll('.explanation-col');
            explanationCols.forEach(col => {
                col.style.display = showExplanation ? 'table-cell' : 'none';
            });
        }

        // 导出到Excel (CSV格式)
        function exportToExcel(type) {
            let csvContent = '';
            let filename = '';

            if (type === 'monthly' || type === 'all') {
                csvContent += '月度奖金明细\n';
                csvContent += '员工姓名,所属地区,年月,标准奖金,月度任务,实际回款,完成率,基础奖金,回款负激励,211负激励,最终月度奖金,计算说明\n';
                
                appData.results.monthly.forEach(result => {
                    csvContent += `${result.employeeName},${result.region},${result.yearMonth},${result.standardBonus},${result.monthlyTarget},${result.actualPayment},${(result.completionRate * 100).toFixed(2)}%,${result.baseBonus.toFixed(2)},${result.paymentPenalty.toFixed(2)},${result.kitchenPenalty.toFixed(2)},${result.finalBonus.toFixed(2)},"${result.explanation}"\n`;
                });
                
                filename = '月度奖金明细.csv';
            }

            if (type === 'assessment' || type === 'all') {
                if (type === 'all') csvContent += '\n\n';
                csvContent += '211厨电考核明细（仅杭州地区）\n';
                csvContent += '员工姓名,所属地区,年月,目标得分,实际得分,完成率,扣款金额,计算说明\n';
                
                appData.results.assessment.forEach(result => {
                    csvContent += `${result.employeeName},${result.region},${result.yearMonth},${result.targetScore},${result.actualScore},${(result.completionRate * 100).toFixed(2)}%,${result.penalty.toFixed(2)},"${result.explanation}"\n`;
                });
                
                filename = type === 'all' ? filename : '211厨电考核明细.csv';
            }

            if (type === 'payment' || type === 'all') {
                if (type === 'all') csvContent += '\n\n';
                csvContent += '回款整体汇总\n';
                csvContent += '员工姓名,所属地区,年月,月度任务,实际回款,月度完成率,所属季度,季度任务,季度回款,季度完成率\n';
                
                appData.results.paymentSummary.forEach(result => {
                    csvContent += `${result.employeeName},${result.region},${result.yearMonth},${result.monthlyTarget},${result.actualPayment},${(result.monthlyCompletionRate * 100).toFixed(2)}%,${result.quarter},${result.quarterlyTarget},${result.quarterlyPayment},${(result.quarterlyCompletionRate * 100).toFixed(2)}%\n`;
                });
                
                filename = type === 'all' ? filename : '回款整体汇总.csv';
            }

            if (type === 'quarterly' || type === 'all') {
                if (type === 'all') csvContent += '\n\n';
                csvContent += '季度奖金汇总\n';
                csvContent += '员工姓名,季度,季度任务,季度回款,季度完成率,基础季度奖金,返还金额,最终季度奖金,计算说明\n';
                
                appData.results.quarterly.forEach(result => {
                    csvContent += `${result.employeeName},${result.quarter},${result.totalTarget},${result.totalPayment},${(result.completionRate * 100).toFixed(2)}%,${result.baseQuarterlyBonus.toFixed(2)},${result.refundAmount.toFixed(2)},${result.finalBonus.toFixed(2)},"${result.explanation}"\n`;
                });
                
                filename = type === 'all' ? '奖金计算完整报告.csv' : '季度奖金汇总.csv';
            }

            // 添加BOM以支持中文
            const BOM = '\uFEFF';
            csvContent = BOM + csvContent;

            // 创建下载
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();

            showAlert(`${filename} 导出成功！`, 'success');
        }
    </script>
</body>
</html>
