<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸šåŠ¡å‘˜å¥–é‡‘è®¡ç®—ç³»ç»Ÿ v2.0 AIå¢å¼ºç‰ˆ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    /* ==================== CSSå˜é‡å®šä¹‰ ==================== */
    :root {
      /* ä¸»è‰²è°ƒ */
      --primary-color: #1890ff;
      --primary-hover: #40a9ff;
      --primary-active: #096dd9;
      
      /* è¾…åŠ©è‰² */
      --success-color: #52c41a;
      --warning-color: #faad14;
      --error-color: #f5222d;
      --info-color: #1890ff;
      
      /* ä¸­æ€§è‰² */
      --text-primary: #262626;
      --text-secondary: #8c8c8c;
      --text-disabled: #bfbfbf;
      
      /* èƒŒæ™¯è‰² */
      --bg-primary: #ffffff;
      --bg-secondary: #fafafa;
      --bg-hover: #f5f5f5;
      
      /* è¾¹æ¡†è‰² */
      --border-color: #d9d9d9;
      --border-light: #f0f0f0;
      
      /* é˜´å½± */
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.12);
      --shadow-lg: 0 8px 24px rgba(0,0,0,0.16);
    }

    /* ==================== åŸºç¡€æ ·å¼ ==================== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f0f2f5;
      color: var(--text-primary);
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 24px;
    }

    .hidden {
      display: none !important;
    }

    /* ==================== é¡µé¢å¤´éƒ¨ ==================== */
    .header {
      background: white;
      box-shadow: var(--shadow-sm);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 24px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .tabs {
      display: flex;
      gap: 8px;
    }

    .tab {
      padding: 8px 20px;
      background: transparent;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      color: var(--text-secondary);
      transition: all 0.3s;
    }

    .tab:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .tab.active {
      background: var(--primary-color);
      color: white;
    }

    /* ==================== é¡µé¢å®¹å™¨ ==================== */
    .page {
      padding: 24px 0;
    }

    section {
      background: white;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-sm);
    }

    section h2 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      color: var(--text-primary);
    }

    /* ==================== ä¸Šä¼ ç»„ä»¶ ==================== */
    .upload-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
    }

    .upload-item {
      padding: 20px;
      border: 2px dashed var(--border-color);
      border-radius: 8px;
      text-align: center;
      transition: all 0.3s;
      cursor: pointer;
    }

    .upload-item:hover {
      border-color: var(--primary-color);
      background: #f0f7ff;
    }

    .upload-item.uploaded {
      border-color: var(--success-color);
      background: #f6ffed;
      border-style: solid;
    }

    .upload-item label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 12px;
      color: var(--text-primary);
      cursor: pointer;
    }

    .upload-item input[type="file"] {
      display: none;
    }

    .upload-item .status {
      display: inline-block;
      margin-top: 8px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .upload-item .status.success {
      color: var(--success-color);
      font-weight: 500;
    }

    .upload-btn {
      display: inline-block;
      padding: 8px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 14px;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.3s;
    }

    .upload-btn:hover {
      border-color: var(--primary-color);
      color: var(--primary-color);
    }

    /* ==================== æŒ‰é’®ç»„ä»¶ ==================== */
    .btn-primary {
      padding: 10px 24px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary:hover {
      background: var(--primary-hover);
      box-shadow: var(--shadow-sm);
    }

    .btn-primary:active {
      background: var(--primary-active);
    }

    .btn-primary:disabled {
      background: #d9d9d9;
      color: rgba(0,0,0,0.25);
      cursor: not-allowed;
    }

    .btn-secondary {
      padding: 10px 24px;
      background: white;
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-secondary:hover {
      color: var(--primary-color);
      border-color: var(--primary-color);
    }

    .button-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    /* ==================== å‚æ•°é€‰æ‹©åŒº ==================== */
    .param-section {
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .param-section h2 {
      margin-bottom: 0;
      margin-right: 8px;
    }

    .param-section select {
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 14px;
      min-width: 200px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .param-section select:hover {
      border-color: var(--primary-color);
    }

    .param-section select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
    }

    /* ==================== è¡¨æ ¼ç»„ä»¶ ==================== */
    .table-container {
      margin-top: 16px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--border-light);
    }

    .table-actions {
      padding: 12px 16px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }

    .search-box {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .search-box input {
      padding: 6px 12px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 14px;
      width: 250px;
    }

    .search-box button {
      padding: 6px 12px;
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .search-box button:hover {
      border-color: var(--primary-color);
      color: var(--primary-color);
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      background: white;
    }

    .data-table thead {
      background: var(--bg-secondary);
      position: sticky;
      top: 0;
    }

    .data-table th {
      padding: 12px 16px;
      text-align: left;
      font-weight: 600;
      color: var(--text-primary);
      border-bottom: 2px solid var(--border-light);
      white-space: nowrap;
    }

    .data-table td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-light);
      color: var(--text-secondary);
    }

    .data-table tbody tr:hover {
      background: var(--bg-hover);
    }

    .data-table tbody tr:last-child td {
      border-bottom: none;
    }

    /* æ•°æ®çŠ¶æ€æ ·å¼ */
    .status-complete {
      color: var(--text-primary);
    }

    .status-missing {
      background: #fff2f0 !important;
    }

    .status-missing td {
      color: var(--error-color) !important;
    }

    .status-trial {
      background: #fffbe6 !important;
    }

    .negative-value {
      color: var(--error-color);
      font-weight: 500;
    }

    /* ==================== Result Tabs ==================== */
    .result-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      border-bottom: 1px solid var(--border-light);
      padding-bottom: 8px;
    }

    .result-tab {
      padding: 8px 16px;
      background: transparent;
      border: none;
      border-radius: 4px 4px 0 0;
      font-size: 14px;
      cursor: pointer;
      color: var(--text-secondary);
      transition: all 0.3s;
    }

    .result-tab:hover {
      color: var(--text-primary);
      background: var(--bg-hover);
    }

    .result-tab.active {
      color: var(--primary-color);
      background: var(--bg-hover);
      font-weight: 500;
    }

    /* ==================== ç»Ÿè®¡é¢æ¿ ==================== */
    .statistics-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      padding: 20px;
      background: white;
      border-radius: 8px;
      border: 1px solid var(--border-light);
      text-align: center;
      transition: all 0.3s;
    }

    .stat-card:hover {
      box-shadow: var(--shadow-sm);
      transform: translateY(-2px);
    }

    .stat-value {
      font-size: 28px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .stat-label {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .stat-card.success .stat-value { color: var(--success-color); }
    .stat-card.error .stat-value { color: var(--error-color); }
    .stat-card.warning .stat-value { color: var(--warning-color); }
    .stat-card.primary .stat-value { color: var(--primary-color); }
    .stat-card.info .stat-value { color: var(--info-color); }

    /* ==================== 211ç¼–è¾‘è¡¨æ ¼ ==================== */
    .editable-table {
      max-height: 500px;
      overflow-y: auto;
    }

    .edit-input {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 14px;
    }

    .edit-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
    }

    .btn-icon {
      padding: 6px 10px;
      background: transparent;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-icon:hover {
      background: #fff2f0;
      border-color: var(--error-color);
    }

    /* ==================== æ¶ˆæ¯æç¤º ==================== */
    .message {
      position: fixed;
      top: 24px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 24px;
      border-radius: 4px;
      box-shadow: var(--shadow-md);
      font-size: 14px;
      z-index: 9999;
      animation: slideDown 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    @keyframes slideUp {
      from {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
      to {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
      }
    }

    .message.success {
      background: #f6ffed;
      border: 1px solid #b7eb8f;
      color: #52c41a;
    }

    .message.error {
      background: #fff2f0;
      border: 1px solid #ffccc7;
      color: #f5222d;
    }

    .message.warning {
      background: #fffbe6;
      border: 1px solid #ffe58f;
      color: #faad14;
    }

    .message.info {
      background: #e6f7ff;
      border: 1px solid #91d5ff;
      color: #1890ff;
    }

    .message-icon {
      font-weight: bold;
      font-size: 16px;
    }

    /* ==================== åŠ è½½åŠ¨ç”» ==================== */
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }

    .loading-content {
      background: white;
      padding: 40px;
      border-radius: 8px;
      text-align: center;
    }

    .spinner {
      width: 40px;
      height: 40px;
      margin: 0 auto 16px;
      border: 4px solid var(--border-light);
      border-top-color: var(--primary-color);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ==================== å“åº”å¼è®¾è®¡ ==================== */
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 16px;
      }

      .upload-grid {
        grid-template-columns: 1fr;
      }

      .statistics-panel {
        grid-template-columns: repeat(2, 1fr);
      }

      .table-container {
        overflow-x: auto;
      }

      .data-table {
        font-size: 12px;
      }

      .data-table th,
      .data-table td {
        padding: 8px;
      }

      .search-box {
        width: 100%;
      }

      .search-box input {
        flex: 1;
      }
    }

    /* ==================== æ»šåŠ¨æ¡æ ·å¼ ==================== */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-secondary);
    }

    /* ==================== AIåŠ©æ‰‹æ ·å¼ ==================== */
    .ai-container {
      display: grid;
      grid-template-columns: 1.05fr 1.35fr;
      gap: 24px;
      height: calc(100vh - 250px);
    }

    .ai-chat-panel {
      display: flex;
      flex-direction: column;
      background: white;
      border-radius: 8px;
      box-shadow: var(--shadow-sm);
      overflow: hidden;
    }

    .ai-analysis-panel {
      display: flex;
      flex-direction: column;
      background: white;
      border-radius: 8px;
      box-shadow: var(--shadow-sm);
      padding: 24px;
      overflow-y: auto;
    }

    /* ===== AIæ–°ç‰ˆæŠ¥å‘Šæ’ç‰ˆ ===== */
    .section {
      background: #ffffff;
      border: 1px solid var(--border-light);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      font-size: 16px;
      color: var(--text-primary);
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--border-light);
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
    }

    .kpi-card {
      background: linear-gradient(180deg, #fafbff 0%, #ffffff 100%);
      border: 1px solid var(--border-light);
      border-radius: 10px;
      padding: 14px;
      text-align: center;
    }

    .kpi-value { font-size: 22px; font-weight: 700; color: var(--primary-color); }
    .kpi-label { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }

    .chip-list { display: flex; flex-wrap: wrap; gap: 8px; }
    .chip {
      padding: 6px 10px;
      background: #f4f6ff;
      border: 1px solid #e6e9ff;
      color: #556ee6;
      border-radius: 999px;
      font-size: 12px;
    }

    .badge { padding: 2px 8px; border-radius: 999px; font-size: 12px; font-weight: 500; }
    .badge-danger { background: #fff2f0; color: #f5222d; border: 1px solid #ffccc7; }
    .badge-warn { background: #fffbe6; color: #faad14; border: 1px solid #ffe58f; }
    .badge-ok { background: #f6ffed; color: #52c41a; border: 1px solid #b7eb8f; }

    .list { display: grid; gap: 12px; }
    .list-item {
      display: grid;
      grid-template-columns: 90px 1fr;
      align-items: start;
      gap: 12px;
      padding: 14px;
      border: 1px solid var(--border-light);
      border-radius: 8px;
      background: #fafafa;
      transition: all 0.2s;
    }
    .list-item:hover {
      background: #f5f5f5;
      box-shadow: var(--shadow-sm);
    }
    .list-item .title { font-weight: 600; color: var(--text-primary); line-height: 1.6; }
    .list-item .desc { 
      color: var(--text-secondary); 
      line-height: 1.8; 
    }
    .list-item .desc small {
      display: block;
      margin-top: 8px;
      font-size: 12px;
      opacity: 0.8;
    }
    
    /* AI åˆ†æå†…å®¹æ ·å¼ä¼˜åŒ– */
    .section .message-content,
    .ai-analysis-content {
      line-height: 2;
      color: var(--text-primary);
    }
    
    .ai-analysis-content p {
      margin-bottom: 16px;
      line-height: 2;
    }
    
    .ai-analysis-content ul,
    .ai-analysis-content ol {
      margin: 16px 0;
      padding-left: 24px;
    }
    
    .ai-analysis-content li {
      margin-bottom: 12px;
      line-height: 1.8;
    }
    
    .ai-analysis-content h1,
    .ai-analysis-content h2,
    .ai-analysis-content h3 {
      margin-top: 24px;
      margin-bottom: 16px;
      line-height: 1.5;
    }
    
    .ai-analysis-content h1 { font-size: 20px; }
    .ai-analysis-content h2 { font-size: 18px; }
    .ai-analysis-content h3 { font-size: 16px; }
    
    .ai-analysis-content strong {
      color: var(--text-primary);
      font-weight: 600;
    }
    
    .ai-analysis-content code {
      background: rgba(0,0,0,0.05);
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
    }
    
    .ai-analysis-content blockquote {
      border-left: 4px solid var(--primary-color);
      padding-left: 16px;
      margin: 16px 0;
      color: var(--text-secondary);
      font-style: italic;
    }

    .chat-header {
      padding: 16px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-messages {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
      background: #f8f9fa;
    }

    .message-bubble {
      margin-bottom: 16px;
      display: flex;
      gap: 12px;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message-bubble.user {
      flex-direction: row-reverse;
    }

    .message-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }

    .message-bubble.ai .message-avatar {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .message-bubble.user .message-avatar {
      background: var(--primary-color);
    }

    .message-content {
      max-width: 70%;
      padding: 16px 20px;
      border-radius: 12px;
      line-height: 1.8;
      word-wrap: break-word;
    }

    .message-bubble.ai .message-content {
      background: white;
      border: 1px solid #e1e8ed;
      box-shadow: var(--shadow-sm);
    }

    .message-bubble.user .message-content {
      background: var(--primary-color);
      color: white;
    }

    .message-content p {
      margin-bottom: 12px;
      line-height: 1.8;
    }

    .message-content h1,
    .message-content h2,
    .message-content h3 {
      margin-top: 16px;
      margin-bottom: 12px;
      line-height: 1.5;
      color: inherit;
    }

    .message-content h1 { font-size: 18px; }
    .message-content h2 { font-size: 16px; }
    .message-content h3 { font-size: 15px; }

    .message-content ul, .message-content ol {
      margin: 12px 0;
      padding-left: 24px;
    }

    .message-content li {
      margin-bottom: 8px;
      line-height: 1.6;
    }

    .message-content code {
      background: rgba(0,0,0,0.05);
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
    }

    .message-content strong {
      font-weight: 600;
      color: inherit;
    }
    
    .message-content blockquote {
      border-left: 3px solid rgba(0,0,0,0.1);
      padding-left: 12px;
      margin: 12px 0;
      opacity: 0.9;
    }

    .chat-input-area {
      padding: 16px 24px;
      background: white;
      border-top: 1px solid var(--border-light);
      display: flex;
      gap: 12px;
    }

    .chat-input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid var(--border-color);
      border-radius: 24px;
      font-size: 14px;
      outline: none;
      transition: all 0.3s;
    }

    .chat-input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(24, 144, 255, 0.1);
    }

    .btn-send {
      padding: 12px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 24px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn-send:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-send:disabled {
      background: #d9d9d9;
      cursor: not-allowed;
      transform: none;
    }

    .quick-questions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }

    .quick-question-btn {
      padding: 8px 16px;
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 20px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .quick-question-btn:hover {
      border-color: var(--primary-color);
      color: var(--primary-color);
      transform: translateY(-2px);
    }

    .analysis-card {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 16px;
      border-left: 4px solid var(--primary-color);
    }

    .analysis-card h3 {
      font-size: 16px;
      margin-bottom: 12px;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .analysis-card-content {
      color: var(--text-secondary);
      line-height: 1.8;
    }

    .loading-dots {
      display: inline-flex;
      gap: 4px;
    }

    .loading-dots span {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--primary-color);
      animation: bounce 1.4s infinite ease-in-out both;
    }

    .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
    .loading-dots span:nth-child(2) { animation-delay: -0.16s; }

    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    .ai-function-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .ai-function-card {
      background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
      border: 2px solid transparent;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }

    .ai-function-card:hover {
      border-color: #667eea;
      transform: translateY(-4px);
      box-shadow: 0 8px 16px rgba(102, 126, 234, 0.2);
    }

    .ai-function-card .icon {
      font-size: 32px;
      margin-bottom: 12px;
    }

    .ai-function-card .title {
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    .ai-function-card .desc {
      font-size: 13px;
      color: var(--text-secondary);
    }

    @media (max-width: 1024px) {
      .ai-container {
        grid-template-columns: 1fr;
        height: auto;
      }
    }
  </style>
</head>
<body>
  <!-- é¡µé¢å¤´éƒ¨ -->
  <header class="header">
    <div class="header-content">
      <div style="display: flex; align-items: center; gap: 16px;">
        <a href="../index.html" style="display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 4px; text-decoration: none; color: var(--text-primary); transition: all 0.3s; font-size: 14px;" onmouseover="this.style.borderColor='var(--primary-color)'; this.style.color='var(--primary-color)';" onmouseout="this.style.borderColor='var(--border-color)'; this.style.color='var(--text-primary)';">
          <span>â†</span>
          <span>è¿”å›é¦–é¡µ</span>
        </a>
        <h1>ğŸ’° ä¸šåŠ¡å‘˜å¥–é‡‘è®¡ç®—ç³»ç»Ÿ <span style="font-size: 14px; color: #667eea;">âœ¨ AIå¢å¼ºç‰ˆ</span></h1>
      </div>
      <nav class="tabs">
        <button class="tab active" onclick="switchPage('monthly')">æœˆåº¦è®¡ç®—</button>
        <button class="tab" onclick="switchPage('quarterly')">å­£åº¦è®¡ç®—</button>
        <button class="tab" onclick="switchPage('manage-211')">211ç®¡ç†</button>
        <button class="tab" onclick="switchPage('ai-assistant')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">ğŸ¤– AIåŠ©æ‰‹</button>
      </nav>
    </div>
  </header>

  <div class="container">
    <!-- ==================== æœˆåº¦è®¡ç®—é¡µé¢ ==================== -->
    <div class="page" id="monthly-page">
      <!-- æ•°æ®ä¸Šä¼ åŒº -->
      <section class="upload-section">
        <h2>ğŸ“ æ­¥éª¤1: ä¸Šä¼ åŸºç¡€æ•°æ®</h2>
        <div class="upload-grid">
          <div class="upload-item" onclick="document.getElementById('file-employee').click()">
            <label>å‘˜å·¥åŸºç¡€ä¿¡æ¯è¡¨</label>
            <input type="file" id="file-employee" accept=".xlsx,.xls" onchange="handleFileUpload(event, 'employee')">
            <div class="upload-btn">é€‰æ‹©æ–‡ä»¶</div>
            <span class="status">æœªä¸Šä¼ </span>
          </div>
          <div class="upload-item" onclick="document.getElementById('file-task').click()">
            <label>ä»»åŠ¡åˆ†é…è¡¨</label>
            <input type="file" id="file-task" accept=".xlsx,.xls" onchange="handleFileUpload(event, 'task')">
            <div class="upload-btn">é€‰æ‹©æ–‡ä»¶</div>
            <span class="status">æœªä¸Šä¼ </span>
          </div>
          <div class="upload-item" onclick="document.getElementById('file-sales').click()">
            <label>é”€å”®å‘˜å›æ¬¾æ±‡æ€»è¡¨</label>
            <input type="file" id="file-sales" accept=".xlsx,.xls" onchange="handleFileUpload(event, 'sales')">
            <div class="upload-btn">é€‰æ‹©æ–‡ä»¶</div>
            <span class="status">æœªä¸Šä¼ </span>
          </div>
          <div class="upload-item" onclick="document.getElementById('file-211').click()">
            <label>211å¨ç”µè¡¨</label>
            <input type="file" id="file-211" accept=".xlsx,.xls" onchange="handleFileUpload(event, 'exam211')">
            <div class="upload-btn">é€‰æ‹©æ–‡ä»¶</div>
            <span class="status">æœªä¸Šä¼ </span>
          </div>
        </div>
      </section>

      <!-- è®¡ç®—å‚æ•°åŒº -->
      <section class="param-section">
        <h2>ğŸ”¢ æ­¥éª¤2: é€‰æ‹©è®¡ç®—æœˆä»½</h2>
        <select id="month-select">
          <option value="">è¯·é€‰æ‹©æœˆä»½</option>
          <option value="1">1æœˆ</option>
          <option value="2">2æœˆ</option>
          <option value="3">3æœˆ</option>
          <option value="4">4æœˆ</option>
          <option value="5">5æœˆ</option>
          <option value="6">6æœˆ</option>
          <option value="7">7æœˆ</option>
          <option value="8">8æœˆ</option>
          <option value="9">9æœˆ</option>
          <option value="10">10æœˆ (é¢„ä¼°)</option>
          <option value="11">11æœˆ (é¢„ä¼°)</option>
          <option value="12">12æœˆ (é¢„ä¼°)</option>
        </select>
        <small style="color: var(--text-secondary); margin-left: 8px;">ğŸ’¡ åªæ˜¾ç¤ºæœ‰æ•°æ®çš„æœˆä»½</small>
        <button id="btn-calculate" class="btn-primary" onclick="startMonthlyCalculation()">ğŸš€ å¼€å§‹è®¡ç®—</button>
      </section>

      <!-- ç»“æœå±•ç¤ºåŒº -->
      <section class="result-section" id="result-section">
        <h2>ğŸ“Š è®¡ç®—ç»“æœ</h2>
        
        <!-- ç»Ÿè®¡é¢æ¿ -->
        <div id="statistics-container"></div>
        
        <!-- Tabåˆ‡æ¢ -->
        <div class="result-tabs">
          <button class="result-tab active" onclick="switchResultTab('monthly')">æœˆåº¦å¥–é‡‘æ˜ç»†</button>
          <button class="result-tab" onclick="switchResultTab('payment')">å›æ¬¾æ˜ç»†</button>
          <button class="result-tab" onclick="switchResultTab('211')">211è€ƒæ ¸</button>
        </div>
        
        <!-- è¡¨æ ¼å®¹å™¨ -->
        <div class="table-container">
          <div class="table-actions">
            <div class="search-box">
              <input type="text" id="table-search" placeholder="ğŸ” æœç´¢ä¸šåŠ¡å‘˜ã€åœ°åŒº...">
              <button onclick="filterTable(document.getElementById('table-search').value)">æœç´¢</button>
              <button onclick="clearTableFilter()">æ¸…é™¤</button>
            </div>
            <div style="display: flex; gap: 8px;">
              <button class="btn-secondary" onclick="switchToAIAndAnalyze()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">ğŸ¤– AIåˆ†æ</button>
              <button id="btn-export" class="btn-secondary" onclick="exportToExcel()">ğŸ“¥ å¯¼å‡ºExcel</button>
            </div>
          </div>
          <div id="table-wrapper" style="max-height: 600px; overflow-y: auto;">
            <p style="text-align: center; padding: 40px; color: var(--text-secondary);">æš‚æ— æ•°æ®ï¼Œè¯·å…ˆä¸Šä¼ æ–‡ä»¶å¹¶å¼€å§‹è®¡ç®—</p>
          </div>
        </div>
      </section>
    </div>

    <!-- ==================== å­£åº¦è®¡ç®—é¡µé¢ ==================== -->
    <div class="page hidden" id="quarterly-page">
      <section class="upload-section">
        <h2>ğŸ“ åŸºç¡€æ•°æ®çŠ¶æ€</h2>
        <div id="quarterly-data-status" style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 16px;">
          <p style="color: var(--text-secondary);">è¯·å…ˆåœ¨æœˆåº¦è®¡ç®—é¡µé¢ä¸Šä¼ å‘˜å·¥ä¿¡æ¯å’Œä»»åŠ¡åˆ†é…è¡¨</p>
        </div>
      </section>
      
      <section class="param-section">
        <h2>ğŸ”¢ é€‰æ‹©è®¡ç®—å­£åº¦</h2>
        <select id="quarter-select">
          <option value="">è¯·é€‰æ‹©å­£åº¦</option>
          <option value="Q1">ç¬¬ä¸€å­£åº¦ (1-3æœˆ)</option>
          <option value="Q2">ç¬¬äºŒå­£åº¦ (4-6æœˆ)</option>
          <option value="Q3">ç¬¬ä¸‰å­£åº¦ (7-9æœˆ)</option>
          <option value="Q4">ç¬¬å››å­£åº¦ (10-12æœˆ) - éœ€å®Œæ•´æ•°æ®</option>
        </select>
        <small style="color: var(--text-secondary); margin-left: 8px;">ğŸ’¡ å­£åº¦è®¡ç®—éœ€è¦è¯¥å­£åº¦æ‰€æœ‰æœˆä»½çš„æ•°æ®</small>
        <button id="btn-calculate-quarter" class="btn-primary" onclick="startQuarterlyCalculation()">ğŸš€ å¼€å§‹è®¡ç®—</button>
      </section>
      
      <section class="result-section">
        <h2>ğŸ“Š å­£åº¦å¥–é‡‘æ±‡æ€»</h2>
        <div class="table-container">
          <div class="table-actions">
            <div></div>
            <button id="btn-export-quarter" class="btn-secondary" onclick="exportQuarterlyToExcel()">ğŸ“¥ å¯¼å‡ºExcel</button>
          </div>
          <div id="quarter-table-wrapper" style="max-height: 600px; overflow-y: auto;">
            <p style="text-align: center; padding: 40px; color: var(--text-secondary);">æš‚æ— æ•°æ®ï¼Œè¯·é€‰æ‹©å­£åº¦å¹¶å¼€å§‹è®¡ç®—</p>
          </div>
        </div>
      </section>
    </div>

    <!-- ==================== 211ç®¡ç†é¡µé¢ ==================== -->
    <div class="page hidden" id="manage-211-page">
      <section class="upload-section">
        <h2>ğŸ“‹ 211å¨ç”µæ•°æ®ç®¡ç†</h2>
        <div class="button-group">
          <button class="btn-secondary" onclick="upload211ForManage()">ğŸ“¤ ä¸Šä¼ 211æ•°æ®</button>
          <button class="btn-secondary" onclick="download211Template()">ğŸ“„ ä¸‹è½½æ¨¡æ¿</button>
          <button class="btn-secondary" onclick="add211Row()">â• æ·»åŠ è®°å½•</button>
          <button class="btn-primary" onclick="save211Data()">ğŸ’¾ ä¿å­˜æ•°æ®</button>
        </div>
        <input type="file" id="file-211-manage" accept=".xlsx,.xls" style="display:none" onchange="handle211FileUpload(event)">
      </section>
      
      <section class="edit-section">
        <h2>âœï¸ åœ¨çº¿ç¼–è¾‘</h2>
        <div class="table-container editable-table">
          <table class="data-table" id="table-211-edit">
            <thead>
              <tr>
                <th>æœˆä»½</th>
                <th>å…·ä½“åœ°åŒº</th>
                <th>ä¸šåŠ¡äººå‘˜</th>
                <th>ä»»åŠ¡åˆ†å€¼</th>
                <th>å®Œæˆåˆ†å€¼</th>
                <th>å¤‡æ³¨</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="tbody-211-edit">
              <tr>
                <td colspan="7" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                  æš‚æ— æ•°æ®ï¼Œè¯·ä¸Šä¼ 211æ•°æ®æˆ–æ·»åŠ æ–°è®°å½•
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </div>

    <!-- ==================== AIåŠ©æ‰‹é¡µé¢ ==================== -->
    <div class="page hidden" id="ai-assistant-page">
      <section style="margin-bottom: 16px;">
        <h2 style="margin-bottom: 16px;">ğŸ¤– AIæ™ºèƒ½åˆ†æåŠ©æ‰‹</h2>
        <p style="color: var(--text-secondary); margin-bottom: 16px;">
          åŸºäºDeepSeek AIæŠ€æœ¯ï¼Œä¸ºæ‚¨æä¾›æ•°æ®åˆ†æã€è¶‹åŠ¿æ´å¯Ÿã€é£é™©é¢„è­¦å’Œä¼˜åŒ–å»ºè®®
        </p>
        
        <!-- AIåŠŸèƒ½å¡ç‰‡ -->
        <div class="ai-function-grid">
          <div class="ai-function-card" onclick="triggerAIAnalysis('comprehensive')">
            <div class="icon">ğŸ“Š</div>
            <div class="title">å…¨é¢æ•°æ®åˆ†æ</div>
            <div class="desc">ä¸€é”®ç”Ÿæˆå®Œæ•´çš„æ•°æ®åˆ†ææŠ¥å‘Š</div>
          </div>
          <div class="ai-function-card" onclick="triggerAIAnalysis('risk')">
            <div class="icon">âš ï¸</div>
            <div class="title">é£é™©é¢„è­¦</div>
            <div class="desc">è¯†åˆ«ä½å®Œæˆç‡å’Œå¼‚å¸¸æƒ…å†µ</div>
          </div>
          <div class="ai-function-card" onclick="triggerAIAnalysis('suggestion')">
            <div class="icon">ğŸ’¡</div>
            <div class="title">ä¼˜åŒ–å»ºè®®</div>
            <div class="desc">åŸºäºæ•°æ®ç»™å‡ºæ”¹è¿›æ–¹æ¡ˆ</div>
          </div>
          <div class="ai-function-card" onclick="triggerAIAnalysis('comparison')">
            <div class="icon">ğŸ“ˆ</div>
            <div class="title">å¯¹æ¯”åˆ†æ</div>
            <div class="desc">è·¨åœ°åŒºã€è·¨å‘˜å·¥æ•°æ®å¯¹æ¯”</div>
          </div>
          <div class="ai-function-card" onclick="triggerAIAnalysis('policy')" style="background: linear-gradient(135deg, #f093fb15 0%, #f5576c15 100%);">
            <div class="icon">ğŸ¯</div>
            <div class="title">æ”¿ç­–æ¨è</div>
            <div class="desc">ææˆæ”¿ç­–ä¼˜åŒ–ä¸è°ƒæ•´å»ºè®®</div>
          </div>
        </div>
      </section>

      <div class="ai-container">
        <!-- å·¦ä¾§ï¼šAIå¯¹è¯é¢æ¿ -->
        <div class="ai-chat-panel">
          <div class="chat-header">
            <span>ğŸ’¬ æ™ºèƒ½å¯¹è¯</span>
            <div style="display: flex; gap: 8px;">
              <button id="btn-stop-gen" onclick="stopAIStreaming()" style="display:none; background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer;">åœæ­¢ç”Ÿæˆ</button>
              <button onclick="clearChat()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer;">æ¸…ç©ºå¯¹è¯</button>
            </div>
          </div>
          
          <div class="chat-messages" id="chat-messages">
            <div class="message-bubble ai">
              <div class="message-avatar">ğŸ¤–</div>
              <div class="message-content">
                <p>æ‚¨å¥½ï¼æˆ‘æ˜¯AIåˆ†æåŠ©æ‰‹ï¼Œå¯ä»¥å¸®æ‚¨ï¼š</p>
                <ul>
                  <li>ğŸ“Š åˆ†æä¸šåŠ¡å‘˜è¡¨ç°å’Œæ•°æ®è¶‹åŠ¿</li>
                  <li>âš ï¸ è¯†åˆ«é£é™©ç‚¹å’Œå¼‚å¸¸æƒ…å†µ</li>
                  <li>ğŸ’¡ æä¾›ä¼˜åŒ–å»ºè®®å’Œæ”¹è¿›æ–¹æ¡ˆ</li>
                  <li>ğŸ” å›ç­”ä»»ä½•æ•°æ®ç›¸å…³é—®é¢˜</li>
                </ul>
                <p style="margin-top: 12px;">è¯·å…ˆä¸Šä¼ æ•°æ®å¹¶å®Œæˆè®¡ç®—ï¼Œç„¶åå‘æˆ‘æé—®ï¼</p>
              </div>
            </div>
          </div>
          
          <div class="quick-questions">
            <button class="quick-question-btn" onclick="askQuickQuestion('åˆ†ææœ¬æœˆæ•´ä½“å®Œæˆæƒ…å†µ')">ğŸ“Š æœ¬æœˆæ•´ä½“æƒ…å†µ</button>
            <button class="quick-question-btn" onclick="askQuickQuestion('å“ªäº›å‘˜å·¥å­˜åœ¨é£é™©ï¼Ÿ')">âš ï¸ é£é™©å‘˜å·¥</button>
            <button class="quick-question-btn" onclick="askQuickQuestion('å„åœ°åŒºè¡¨ç°å¦‚ä½•ï¼Ÿ')">ğŸ—ºï¸ åœ°åŒºå¯¹æ¯”</button>
            <button class="quick-question-btn" onclick="askQuickQuestion('å¦‚ä½•æå‡ä¸šç»©ï¼Ÿ')">ğŸ’¡ ä¼˜åŒ–å»ºè®®</button>
            <button class="quick-question-btn" onclick="askQuickQuestion('ææˆæ”¿ç­–éœ€è¦è°ƒæ•´å—ï¼Ÿ')">ğŸ¯ æ”¿ç­–ä¼˜åŒ–</button>
          </div>
          
          <div class="chat-input-area">
            <input type="text" id="chat-input" class="chat-input" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." onkeypress="if(event.key==='Enter') sendMessage()">
            <button id="btn-send-message" class="btn-send" onclick="sendMessage()">
              <span>å‘é€</span>
              <span>âœˆï¸</span>
            </button>
          </div>
        </div>

        <!-- å³ä¾§ï¼šåˆ†æç»“æœé¢æ¿ -->
        <div class="ai-analysis-panel" id="ai-analysis-panel">
          <div style="margin-bottom: 16px; display: flex; align-items: center; justify-content: space-between;">
            <h3 style="margin: 0; display: flex; align-items: center; gap: 8px;">
              <span>ğŸ“ˆ</span>
              <span>åˆ†æç»“æœ</span>
            </h3>
            <button id="btn-export-report" class="btn-secondary" onclick="exportAIReportPDF()" style="display: none;">
              <span>ğŸ“¥</span>
              <span>å¯¼å‡ºPDF</span>
            </button>
          </div>
          <div id="analysis-content" style="color: var(--text-secondary); text-align: center; padding: 60px 20px;">
            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ¯</div>
            <p>é€‰æ‹©ä¸Šæ–¹åŠŸèƒ½å¡ç‰‡å¼€å§‹åˆ†æ</p>
            <p style="font-size: 13px; margin-top: 8px;">æˆ–åœ¨å·¦ä¾§å¯¹è¯æ¡†ä¸­æé—®</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==================== å…¨å±€æ•°æ®å­˜å‚¨ ====================
    const AppData = {
      raw: {
        employee: null,
        task: null,
        sales: null,
        exam211: null
      },
      index: {
        employee: {},
        task: {},
        sales: {},
        exam211: {}
      },
      results: {
        monthly: [],
        quarterly: [],
        payment: [],
        exam211: []
      },
      config: {
        selectedMonth: null,
        selectedQuarter: null,
        currentResultTab: 'monthly'
      },
      ai: {
        chatHistory: [],
        apiConfig: {
          baseURL: 'https://api.deepseek.com/v1',
          apiKey: 'sk-96f5d6bd84e2470592d84d85e82ffb92',
          model: 'deepseek-chat',
          timeoutMs: 45000
        },
        controller: null,
        isStreaming: false
      }
    };

    // ==================== é¡µé¢åˆ‡æ¢åŠŸèƒ½ ====================
    function switchPage(pageName) {
      document.querySelectorAll('.page').forEach(page => {
        page.classList.add('hidden');
      });
      document.getElementById(`${pageName}-page`).classList.remove('hidden');
      
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // æ ¹æ®é¡µé¢åç§°æ¿€æ´»å¯¹åº”çš„tab
      const tabTexts = {
        'monthly': 'æœˆåº¦è®¡ç®—',
        'quarterly': 'å­£åº¦è®¡ç®—',
        'manage-211': '211ç®¡ç†',
        'ai-assistant': 'AIåŠ©æ‰‹'
      };
      
      const targetText = tabTexts[pageName];
      if (targetText) {
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach(tab => {
          if (tab.textContent.includes(targetText)) {
            tab.classList.add('active');
          }
        });
      }

      // å¦‚æœåˆ‡æ¢åˆ°å­£åº¦é¡µé¢ï¼Œæ›´æ–°æ•°æ®çŠ¶æ€
      if (pageName === 'quarterly') {
        updateQuarterlyDataStatus();
      }
    }

    function switchResultTab(tabName) {
      AppData.config.currentResultTab = tabName;
      
      document.querySelectorAll('.result-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      event.target.classList.add('active');

      // æ¸²æŸ“å¯¹åº”çš„è¡¨æ ¼
      if (tabName === 'monthly') {
        renderMonthlyReport();
      } else if (tabName === 'payment') {
        renderPaymentReport();
      } else if (tabName === '211') {
        render211Report();
      }
    }

    // ==================== æ¶ˆæ¯æç¤º ====================
    function showMessage(text, type = 'info', duration = 3000) {
      const existingMessage = document.querySelector('.message');
      if (existingMessage) {
        existingMessage.remove();
      }
      
      const message = document.createElement('div');
      message.className = `message ${type}`;
      
      const icons = {
        success: 'âœ“',
        error: 'âœ—',
        warning: 'âš ',
        info: 'â„¹'
      };
      message.innerHTML = `<span class="message-icon">${icons[type]}</span> ${text}`;
      
      document.body.appendChild(message);
      
      setTimeout(() => {
        message.style.animation = 'slideUp 0.3s ease';
        setTimeout(() => message.remove(), 300);
      }, duration);
    }

    // ==================== è¾…åŠ©å‡½æ•° ====================
    function formatPercent(value) {
      return (value * 100).toFixed(2) + '%';
    }

    function roundMoney(value) {
      return Math.round(value * 100) / 100;
    }

    function formatMoney(value) {
      if (value === null || value === undefined || value === '-') return '-';
      return value.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function isTrialEmployee(employee) {
      const å¤‡æ³¨ = employee.å¤‡æ³¨ || '';
      return å¤‡æ³¨.includes('è¯•ç”¨æœŸ') || å¤‡æ³¨.includes('è¯•ç”¨');
    }

    // ==================== Excelæ–‡ä»¶å¤„ç† ====================
    function handleFileUpload(event, dataType) {
      const file = event.target.files[0];
      if (!file) return;
      
      showMessage('æ­£åœ¨è¯»å–æ–‡ä»¶...', 'info');
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = e.target.result;
          const workbook = XLSX.read(data, { type: 'binary' });
          
          let jsonData = [];
          
          // å¯¹äºä»»åŠ¡åˆ†é…è¡¨ï¼Œéœ€è¦è¯»å–æ‰€æœ‰å·¥ä½œè¡¨å¹¶åˆå¹¶
          if (dataType === 'task') {
            console.log(`[${dataType}] æ£€æµ‹åˆ°å¤šä¸ªå·¥ä½œè¡¨:`, workbook.SheetNames);
            
            // éå†æ‰€æœ‰å·¥ä½œè¡¨
            workbook.SheetNames.forEach(sheetName => {
              const worksheet = workbook.Sheets[sheetName];
              const sheetData = XLSX.utils.sheet_to_json(worksheet);
              
              console.log(`[${dataType}] å·¥ä½œè¡¨ "${sheetName}" æ•°æ®è¡Œæ•°:`, sheetData.length);
              
              // åˆå¹¶æ•°æ®
              jsonData = jsonData.concat(sheetData);
            });
            
            console.log(`[${dataType}] åˆå¹¶åæ€»æ•°æ®è¡Œæ•°:`, jsonData.length);
          } else {
            // å…¶ä»–æ•°æ®ç±»å‹åªè¯»å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            jsonData = XLSX.utils.sheet_to_json(worksheet);
            
            console.log(`[${dataType}] åŸå§‹æ•°æ®è¡Œæ•°:`, jsonData.length);
          }
          
          if (jsonData.length > 0) {
            console.log(`[${dataType}] åˆ—å:`, Object.keys(jsonData[0]));
          }
          
          // å¦‚æœæ˜¯211æ•°æ®ï¼Œè¿‡æ»¤æ‰æ±‡æ€»è¡Œ
          let filteredCount = 0;
          if (dataType === 'exam211') {
            const originalLength = jsonData.length;
            jsonData = jsonData.filter(row => {
              const month = String(row['æœˆä»½'] || '');
              const name = row['ä¸šåŠ¡äººå‘˜'];
              return name && !month.includes('åˆè®¡') && !month.includes('å­£åº¦');
            });
            filteredCount = originalLength - jsonData.length;
            console.log('[211] è¿‡æ»¤åæ•°æ®è¡Œæ•°:', jsonData.length);
          }
          
          // éªŒè¯æ•°æ®
          const validation = validateData(jsonData, dataType);
          if (!validation.valid) {
            console.error(`[${dataType}] éªŒè¯å¤±è´¥:`, validation.error);
            showMessage(`æ•°æ®éªŒè¯å¤±è´¥: ${validation.error}`, 'error');
            return;
          }
          
          // å­˜å‚¨åŸå§‹æ•°æ®
          AppData.raw[dataType] = jsonData;
          
          // æ„å»ºç´¢å¼•
          switch(dataType) {
            case 'employee':
              AppData.index.employee = buildEmployeeIndex(jsonData);
              break;
            case 'task':
              AppData.index.task = buildTaskIndex(jsonData);
              break;
            case 'sales':
              AppData.index.sales = buildSalesIndex(jsonData);
              break;
            case 'exam211':
              AppData.index.exam211 = build211Index(jsonData);
              break;
          }
          
          updateUploadStatus(dataType, true);
          const successMsg = filteredCount > 0 
            ? `${getDataTypeName(dataType)}ä¸Šä¼ æˆåŠŸï¼å·²è‡ªåŠ¨è¿‡æ»¤${filteredCount}è¡Œæ±‡æ€»æ•°æ®`
            : dataType === 'task' 
            ? `${getDataTypeName(dataType)}ä¸Šä¼ æˆåŠŸï¼å·²è¯»å–${workbook.SheetNames.length}ä¸ªå·¥ä½œè¡¨ï¼Œå…±${jsonData.length}æ¡æ•°æ®`
            : `${getDataTypeName(dataType)}ä¸Šä¼ æˆåŠŸï¼`;
          showMessage(successMsg, 'success');
          
        } catch (error) {
          console.error(`[${dataType}] æ–‡ä»¶è§£æé”™è¯¯:`, error);
          console.error('é”™è¯¯å †æ ˆ:', error.stack);
          showMessage(`æ–‡ä»¶è§£æå¤±è´¥: ${error.message || 'è¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼'}`, 'error');
        }
      };
      
      reader.onerror = function(error) {
        console.error('æ–‡ä»¶è¯»å–é”™è¯¯:', error);
        showMessage('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      };
      
      reader.readAsBinaryString(file);
    }

    function updateUploadStatus(dataType, success) {
      // æ˜ å°„dataTypeåˆ°å®é™…çš„æ–‡ä»¶è¾“å…¥id
      const fileIdMap = {
        'employee': 'file-employee',
        'task': 'file-task',
        'sales': 'file-sales',
        'exam211': 'file-211'
      };
      
      const fileId = fileIdMap[dataType] || `file-${dataType}`;
      const fileInput = document.getElementById(fileId);
      
      if (!fileInput) {
        console.warn(`æ‰¾ä¸åˆ°æ–‡ä»¶è¾“å…¥å…ƒç´ : ${fileId}`);
        return;
      }
      
      const uploadItem = fileInput.closest('.upload-item');
      const statusSpan = uploadItem.querySelector('.status');
      
      if (success) {
        uploadItem.classList.add('uploaded');
        statusSpan.textContent = 'âœ“ å·²ä¸Šä¼ ';
        statusSpan.classList.add('success');
      } else {
        uploadItem.classList.remove('uploaded');
        statusSpan.textContent = 'æœªä¸Šä¼ ';
        statusSpan.classList.remove('success');
      }
    }

    function getDataTypeName(dataType) {
      const names = {
        'employee': 'å‘˜å·¥åŸºç¡€ä¿¡æ¯è¡¨',
        'task': 'ä»»åŠ¡åˆ†é…è¡¨',
        'sales': 'é”€å”®å‘˜å›æ¬¾æ±‡æ€»è¡¨',
        'exam211': '211å¨ç”µè¡¨'
      };
      return names[dataType] || dataType;
    }

    // ==================== æ•°æ®éªŒè¯ ====================
    function validateData(data, type) {
      const validationRules = {
        employee: {
          requiredColumns: ['å‘˜å·¥å§“å', 'æ ‡å‡†å¥–é‡‘', 'æ‰€å±åœ°åŒº', 'ä¸šåŠ¡ç±»å‹'],
          columnTypes: {
            'å‘˜å·¥å§“å': 'string',
            'æ ‡å‡†å¥–é‡‘': 'number',
            'æ‰€å±åœ°åŒº': 'string',
            'ä¸šåŠ¡ç±»å‹': 'string'
          }
        },
        task: {
          requiredColumns: ['è´Ÿè´£äºº'],
          columnTypes: {
            'è´Ÿè´£äºº': 'string'
          }
        },
        sales: {
          requiredColumns: ['é”€å”®å‘˜'],
          columnTypes: {
            'é”€å”®å‘˜': 'string'
          }
        },
        exam211: {
          requiredColumns: ['æœˆä»½', 'ä¸šåŠ¡äººå‘˜'],
          columnTypes: {
            'æœˆä»½': 'string',
            'ä¸šåŠ¡äººå‘˜': 'string'
          }
        }
      };
      
      const rules = validationRules[type];
      if (!rules) {
        return { valid: false, error: 'æœªçŸ¥çš„æ•°æ®ç±»å‹' };
      }
      
      if (!data || data.length === 0) {
        return { valid: false, error: 'æ•°æ®ä¸ºç©º' };
      }
      
      const firstRow = data[0];
      const missingColumns = rules.requiredColumns.filter(
        col => !(col in firstRow)
      );
      
      if (missingColumns.length > 0) {
        return { 
          valid: false, 
          error: `ç¼ºå°‘å¿…éœ€åˆ—: ${missingColumns.join(', ')}` 
        };
      }
      
      return { valid: true };
    }

    // ==================== ç´¢å¼•æ„å»º ====================
    function buildEmployeeIndex(data) {
      const index = {};
      
      data.forEach(row => {
        const name = row['å‘˜å·¥å§“å'];
        index[name] = {
          æ ‡å‡†å¥–é‡‘: row['æ ‡å‡†å¥–é‡‘'],
          æ‰€å±åœ°åŒº: row['æ‰€å±åœ°åŒº'],
          ä¸šåŠ¡ç±»å‹: row['ä¸šåŠ¡ç±»å‹'],
          å¤‡æ³¨: row['å¤‡æ³¨'] || '',
          æ˜¯å¦è¯•ç”¨æœŸ: isTrialEmployee(row)
        };
      });
      
      return index;
    }

    function buildTaskIndex(data) {
      const index = {};
      const months = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'];
      
      data.forEach(row => {
        const name = row['è´Ÿè´£äºº'];
        
        // è·³è¿‡æ— æ•ˆçš„è´Ÿè´£äººï¼ˆå¦‚ç©ºå€¼ã€NaNç­‰ï¼‰
        if (!name || name === 'NaN' || String(name).trim() === '') {
          return;
        }
        
        // å¦‚æœè¯¥è´Ÿè´£äººè¿˜ä¸å­˜åœ¨ï¼Œåˆå§‹åŒ–
        if (!index[name]) {
          index[name] = {};
        }
        
        // è¯»å–æœˆåº¦ä»»åŠ¡ï¼ˆæ”¯æŒ "1æœˆ" æˆ– "1" ä¸¤ç§æ ¼å¼ï¼‰
        months.forEach(month => {
          const value = row[`${month}æœˆ`] || row[month];
          if (value !== undefined && value !== null && value !== '') {
            // è½¬æ¢ä¸ºæ•°å­—å¹¶ä¹˜ä»¥10000ï¼ˆä¸‡å…ƒè½¬å…ƒï¼‰
            const numValue = parseFloat(value);
            if (!isNaN(numValue)) {
              index[name][month] = numValue * 10000;
            }
          }
        });
        
        // è¯»å–å­£åº¦ä»»åŠ¡
        ['Q1', 'Q2', 'Q3', 'Q4'].forEach(quarter => {
          const value = row[quarter];
          if (value !== undefined && value !== null && value !== '') {
            const numValue = parseFloat(value);
            if (!isNaN(numValue)) {
              index[name][quarter] = numValue * 10000;
            }
          }
        });
      });
      
      // è¾“å‡ºç´¢å¼•ç»Ÿè®¡
      const validEmployees = Object.keys(index).filter(name => {
        const hasData = Object.keys(index[name]).length > 0;
        return hasData;
      });
      
      console.log(`[ä»»åŠ¡ç´¢å¼•] æˆåŠŸæ„å»º ${validEmployees.length} ä¸ªå‘˜å·¥çš„ä»»åŠ¡æ•°æ®`);
      console.log(`[ä»»åŠ¡ç´¢å¼•] å‘˜å·¥åˆ—è¡¨:`, validEmployees.join(', '));
      
      return index;
    }

    function buildSalesIndex(data) {
      const index = {};
      const months = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'];
      
      data.forEach(row => {
        const name = row['é”€å”®å‘˜'];
        if (!index[name]) {
          index[name] = {};
        }
        
        // æ£€æŸ¥æ˜¯å¦æœ‰æœˆåº¦åˆ—
        let hasMonthColumns = false;
        months.forEach(month => {
          // å°è¯•å¤šç§åˆ—åæ ¼å¼: "1æœˆ", "1", "ä¸€æœˆ" ç­‰
          const value = row[`${month}æœˆ`] || row[month] || row[`${month}æœˆä»½`];
          if (value !== undefined && value !== null && value !== '') {
            index[name][month] = value;
            hasMonthColumns = true;
          }
        });
        
        // å¦‚æœæ²¡æœ‰æœˆåº¦åˆ—ä½†æœ‰æ€»å›æ¬¾æ•°æ®ï¼Œç»™å‡ºè­¦å‘Š
        if (!hasMonthColumns && row['å›æ¬¾'] !== undefined) {
          console.warn(`âš ï¸ é”€å”®å‘˜ ${name} åªæœ‰æ€»å›æ¬¾æ•°æ®(${row['å›æ¬¾']}),ç¼ºå°‘æœˆåº¦æ˜ç»†`);
          console.warn(`   è¯·åœ¨é”€å”®å‘˜å›æ¬¾æ±‡æ€»è¡¨ä¸­æ·»åŠ æœˆåº¦åˆ—: 1æœˆã€2æœˆã€3æœˆ...12æœˆ`);
        }
      });
      
      return index;
    }

    function build211Index(data) {
      const index = {};
      
      data.forEach(row => {
        const name = row['ä¸šåŠ¡äººå‘˜'];
        const month = String(row['æœˆä»½']).replace(/[æœˆ]/g, '').trim();
        
        // è¿‡æ»¤æ‰æ±‡æ€»è¡Œå’Œæ— æ•ˆæ•°æ®
        if (!name || !month || month.includes('åˆè®¡') || month.includes('å­£åº¦') || month === '') {
          return;
        }
        
        if (!index[name]) {
          index[name] = {};
        }
        
        // å…¼å®¹å¤šç§åˆ—å: "ä»»åŠ¡" æˆ– "ç›®æ ‡åˆ†å€¼" æˆ– "ä»»åŠ¡åˆ†å€¼"
        const taskValue = row['ä»»åŠ¡'] || row['ç›®æ ‡åˆ†å€¼'] || row['ä»»åŠ¡åˆ†å€¼'] || 10;
        // å…¼å®¹å¤šç§åˆ—å: "å®Œæˆ" æˆ– "å®Œæˆåˆ†å€¼" æˆ– "å®é™…å®Œæˆ"
        const completeValue = row['å®Œæˆ'] || row['å®Œæˆåˆ†å€¼'] || row['å®é™…å®Œæˆ'] || 0;
        
        index[name][month] = {
          ä»»åŠ¡: Number(taskValue) || 10,
          å®Œæˆ: Number(completeValue) || 0,
          å¤‡æ³¨: row['å¤‡æ³¨'] || ''
        };
      });
      
      return index;
    }

    // ==================== æœˆåº¦å¥–é‡‘è®¡ç®— ====================
    function calculateMonthlyBonus(employeeName, month) {
      const employee = AppData.index.employee[employeeName];
      if (!employee) {
        return { error: "å‘˜å·¥ä¿¡æ¯ä¸å­˜åœ¨" };
      }
      
      const æ ‡å‡†å¥–é‡‘ = employee.æ ‡å‡†å¥–é‡‘;
      const åœ°åŒº = employee.æ‰€å±åœ°åŒº;
      const æ˜¯å¦è¯•ç”¨æœŸ = employee.æ˜¯å¦è¯•ç”¨æœŸ;
      
      const ä»»åŠ¡ = AppData.index.task[employeeName]?.[month];
      const å›æ¬¾ = AppData.index.sales[employeeName]?.[month];
      
      if (ä»»åŠ¡ === undefined || å›æ¬¾ === undefined) {
        return {
          ä¸šåŠ¡å‘˜: employeeName,
          åœ°åŒº: åœ°åŒº,
          æœˆä»½: `${month}æœˆ`,
          ä»»åŠ¡: ä»»åŠ¡ || '-',
          å›æ¬¾: å›æ¬¾ || '-',
          å®Œæˆç‡: '-',
          åŸºç¡€å¥–é‡‘: '-',
          å›æ¬¾è´Ÿæ¿€åŠ±: '-',
          è´Ÿæ¿€åŠ±211: '-',
          å®å‘å¥–é‡‘: '-',
          ä¸ªç¨: '-',
          æ•°æ®çŠ¶æ€: "æ•°æ®ç¼ºå¤±",
          å¤‡æ³¨: `ç¼ºå¤±${ä»»åŠ¡ === undefined ? 'ä»»åŠ¡' : ''}${å›æ¬¾ === undefined ? 'å›æ¬¾' : ''}æ•°æ®`
        };
      }
      
      if (æ˜¯å¦è¯•ç”¨æœŸ) {
        return {
          ä¸šåŠ¡å‘˜: employeeName,
          åœ°åŒº: åœ°åŒº,
          æœˆä»½: `${month}æœˆ`,
          ä»»åŠ¡: ä»»åŠ¡,
          å›æ¬¾: å›æ¬¾,
          å®Œæˆç‡: formatPercent(å›æ¬¾ / ä»»åŠ¡),
          åŸºç¡€å¥–é‡‘: 0,
          å›æ¬¾è´Ÿæ¿€åŠ±: 0,
          è´Ÿæ¿€åŠ±211: 0,
          å®å‘å¥–é‡‘: 0,
          ä¸ªç¨: 0,
          å¤‡æ³¨: "è¯•ç”¨æœŸæ— è€ƒæ ¸å¥–é‡‘ï¼Œè´Ÿæ¿€åŠ±ä¸æ‰£",
          æ•°æ®çŠ¶æ€: "è¯•ç”¨æœŸ"
        };
      }
      
      const å®Œæˆç‡ = å›æ¬¾ / ä»»åŠ¡;
      const åŸºç¡€å¥–é‡‘ = æ ‡å‡†å¥–é‡‘ * 0.7 * å®Œæˆç‡;
      
      let å›æ¬¾è´Ÿæ¿€åŠ± = 0;
      let è´Ÿæ¿€åŠ±è¯´æ˜ = "";
      
      if (åœ°åŒº === "æ­å·") {
        if (å®Œæˆç‡ < 0.5) {
          å›æ¬¾è´Ÿæ¿€åŠ± = æ ‡å‡†å¥–é‡‘ * 0.2;
          è´Ÿæ¿€åŠ±è¯´æ˜ = "å®Œæˆç‡<50%ï¼Œæ‰£20%";
        } else if (å®Œæˆç‡ < 0.8) {
          å›æ¬¾è´Ÿæ¿€åŠ± = æ ‡å‡†å¥–é‡‘ * 0.1;
          è´Ÿæ¿€åŠ±è¯´æ˜ = "å®Œæˆç‡50%-80%ï¼Œæ‰£10%";
        } else {
          è´Ÿæ¿€åŠ±è¯´æ˜ = "å®Œæˆç‡â‰¥80%ï¼Œä¸æ‰£æ¬¾";
        }
      } else {
        è´Ÿæ¿€åŠ±è¯´æ˜ = "éæ­å·åœ°åŒº";
      }
      
      const exam211 = AppData.index.exam211[employeeName]?.[month];
      let è´Ÿæ¿€åŠ±211 = 0;
      
      if (exam211) {
        const { ä»»åŠ¡: ä»»åŠ¡åˆ†å€¼, å®Œæˆ: å®Œæˆåˆ†å€¼ } = exam211;
        è´Ÿæ¿€åŠ±211 = 800 - (å®Œæˆåˆ†å€¼ / ä»»åŠ¡åˆ†å€¼) * 800;
      } else {
        è´Ÿæ¿€åŠ±211 = 800;
      }
      
      const å®å‘å¥–é‡‘ = åŸºç¡€å¥–é‡‘ - å›æ¬¾è´Ÿæ¿€åŠ± - è´Ÿæ¿€åŠ±211;
      
      return {
        ä¸šåŠ¡å‘˜: employeeName,
        åœ°åŒº: åœ°åŒº,
        æœˆä»½: `${month}æœˆ`,
        ä»»åŠ¡: ä»»åŠ¡,
        å›æ¬¾: å›æ¬¾,
        å®Œæˆç‡: formatPercent(å®Œæˆç‡),
        åŸºç¡€å¥–é‡‘: roundMoney(åŸºç¡€å¥–é‡‘),
        å›æ¬¾è´Ÿæ¿€åŠ±: roundMoney(å›æ¬¾è´Ÿæ¿€åŠ±),
        è´Ÿæ¿€åŠ±211: roundMoney(è´Ÿæ¿€åŠ±211),
        å®å‘å¥–é‡‘: roundMoney(å®å‘å¥–é‡‘),
        ä¸ªç¨: 0,
        å¤‡æ³¨: è´Ÿæ¿€åŠ±è¯´æ˜,
        æ•°æ®çŠ¶æ€: "å®Œæ•´"
      };
    }

    // ==================== å­£åº¦å¥–é‡‘è®¡ç®— ====================
    function calculateQuarterlyBonus(employeeName, quarter) {
      const employee = AppData.index.employee[employeeName];
      if (!employee) {
        return { error: "å‘˜å·¥ä¿¡æ¯ä¸å­˜åœ¨" };
      }
      
      const æ ‡å‡†å¥–é‡‘ = employee.æ ‡å‡†å¥–é‡‘;
      const åœ°åŒº = employee.æ‰€å±åœ°åŒº;
      const æ˜¯å¦è¯•ç”¨æœŸ = employee.æ˜¯å¦è¯•ç”¨æœŸ;
      
      const quarterMonths = {
        'Q1': ['1', '2', '3'],
        'Q2': ['4', '5', '6'],
        'Q3': ['7', '8', '9'],
        'Q4': ['10', '11', '12']
      };
      const months = quarterMonths[quarter];
      
      let å­£åº¦ä»»åŠ¡ = 0;
      let å­£åº¦å›æ¬¾ = 0;
      let æ•°æ®å®Œæ•´ = true;
      
      for (const month of months) {
        const ä»»åŠ¡ = AppData.index.task[employeeName]?.[month];
        const å›æ¬¾ = AppData.index.sales[employeeName]?.[month];
        
        if (ä»»åŠ¡ === undefined || å›æ¬¾ === undefined) {
          æ•°æ®å®Œæ•´ = false;
          break;
        }
        
        å­£åº¦ä»»åŠ¡ += ä»»åŠ¡;
        å­£åº¦å›æ¬¾ += å›æ¬¾;
      }
      
      if (!æ•°æ®å®Œæ•´) {
        return {
          ä¸šåŠ¡å‘˜: employeeName,
          å­£åº¦: quarter,
          å­£åº¦ä»»åŠ¡: '-',
          å­£åº¦å›æ¬¾: '-',
          å®Œæˆç‡: '-',
          åŸºç¡€å¥–é‡‘: '-',
          è¿”è¿˜é‡‘é¢: '-',
          å®å‘å¥–é‡‘: '-',
          æ•°æ®çŠ¶æ€: "æ•°æ®ç¼ºå¤±",
          å¤‡æ³¨: "å­£åº¦æ•°æ®ä¸å®Œæ•´"
        };
      }
      
      if (æ˜¯å¦è¯•ç”¨æœŸ) {
        return {
          ä¸šåŠ¡å‘˜: employeeName,
          å­£åº¦: quarter,
          å­£åº¦ä»»åŠ¡: å­£åº¦ä»»åŠ¡,
          å­£åº¦å›æ¬¾: å­£åº¦å›æ¬¾,
          å®Œæˆç‡: formatPercent(å­£åº¦å›æ¬¾ / å­£åº¦ä»»åŠ¡),
          åŸºç¡€å¥–é‡‘: 0,
          è¿”è¿˜é‡‘é¢: 0,
          å®å‘å¥–é‡‘: 0,
          å¤‡æ³¨: "è¯•ç”¨æœŸæ— å­£åº¦å¥–é‡‘",
          æ•°æ®çŠ¶æ€: "è¯•ç”¨æœŸ"
        };
      }
      
      const å­£åº¦å®Œæˆç‡ = å­£åº¦å›æ¬¾ / å­£åº¦ä»»åŠ¡;
      
      let åŸºç¡€å¥–é‡‘ = 0;
      let å¤‡æ³¨ = "";
      
      if (åœ°åŒº === "æ­å·" && å­£åº¦å®Œæˆç‡ < 0.5) {
        åŸºç¡€å¥–é‡‘ = 0;
        å¤‡æ³¨ = "è§¦å‘çº¢çº¿ï¼Œå­£åº¦å®Œæˆç‡<50%ï¼Œå­£åº¦å¥–é‡‘å½’é›¶";
      } else {
        åŸºç¡€å¥–é‡‘ = æ ‡å‡†å¥–é‡‘ * 0.3 * 3 * å­£åº¦å®Œæˆç‡;
        å¤‡æ³¨ = `å­£åº¦å®Œæˆç‡${formatPercent(å­£åº¦å®Œæˆç‡)}`;
      }
      
      let è¿”è¿˜é‡‘é¢ = 0;
      
      if (åœ°åŒº === "æ­å·" && å­£åº¦å®Œæˆç‡ >= 0.8) {
        for (const month of months) {
          const ä»»åŠ¡ = AppData.index.task[employeeName][month];
          const å›æ¬¾ = AppData.index.sales[employeeName][month];
          const æœˆå®Œæˆç‡ = å›æ¬¾ / ä»»åŠ¡;
          
          if (æœˆå®Œæˆç‡ < 0.5) {
            è¿”è¿˜é‡‘é¢ += æ ‡å‡†å¥–é‡‘ * 0.2;
          } else if (æœˆå®Œæˆç‡ < 0.8) {
            è¿”è¿˜é‡‘é¢ += æ ‡å‡†å¥–é‡‘ * 0.1;
          }
        }
        
        if (è¿”è¿˜é‡‘é¢ > 0) {
          å¤‡æ³¨ += "ï¼Œè¿”è¿˜æœˆåº¦è´Ÿæ¿€åŠ±";
        }
      }
      
      const å®å‘å¥–é‡‘ = åŸºç¡€å¥–é‡‘ + è¿”è¿˜é‡‘é¢;
      
      return {
        ä¸šåŠ¡å‘˜: employeeName,
        å­£åº¦: quarter,
        å­£åº¦ä»»åŠ¡: å­£åº¦ä»»åŠ¡,
        å­£åº¦å›æ¬¾: å­£åº¦å›æ¬¾,
        å®Œæˆç‡: formatPercent(å­£åº¦å®Œæˆç‡),
        åŸºç¡€å¥–é‡‘: roundMoney(åŸºç¡€å¥–é‡‘),
        è¿”è¿˜é‡‘é¢: roundMoney(è¿”è¿˜é‡‘é¢),
        å®å‘å¥–é‡‘: roundMoney(å®å‘å¥–é‡‘),
        å¤‡æ³¨: å¤‡æ³¨,
        æ•°æ®çŠ¶æ€: "å®Œæ•´"
      };
    }

    // ==================== è®¡ç®—è§¦å‘ ====================
    function checkDataReady(requiredTypes) {
      for (const type of requiredTypes) {
        if (!AppData.raw[type] || AppData.raw[type].length === 0) {
          return false;
        }
      }
      return true;
    }

    function startMonthlyCalculation() {
      if (!checkDataReady(['employee', 'task', 'sales', 'exam211'])) {
        showMessage('è¯·å…ˆä¸Šä¼ æ‰€æœ‰å¿…éœ€çš„æ•°æ®æ–‡ä»¶', 'warning');
        return;
      }
      
      const month = document.getElementById('month-select').value;
      if (!month) {
        showMessage('è¯·é€‰æ‹©è®¡ç®—æœˆä»½', 'warning');
        return;
      }
      
      // æ£€æŸ¥å›æ¬¾æ•°æ®æ˜¯å¦æœ‰æœˆåº¦æ˜ç»†
      const hasMonthlyPayment = Object.values(AppData.index.sales).some(payments => 
        payments[month] !== undefined
      );
      
      if (!hasMonthlyPayment) {
        showMessage(`âš ï¸ é”€å”®å‘˜å›æ¬¾æ±‡æ€»è¡¨ä¸­æ²¡æœ‰${month}æœˆçš„æ•°æ®ï¼å¯èƒ½è¯¥æœˆæ•°æ®å°šæœªå½•å…¥`, 'warning', 5000);
        console.warn(`[æç¤º] ${month}æœˆæš‚æ— å›æ¬¾æ•°æ®`);
        console.warn(`[å»ºè®®] å¦‚æœ${month}æœˆæ•°æ®å°šæœªäº§ç”Ÿï¼Œè¯·é€‰æ‹©æœ‰æ•°æ®çš„æœˆä»½è¿›è¡Œè®¡ç®—`);
        console.warn(`[å»ºè®®] æˆ–åœ¨Excelä¸­ä¸º${month}æœˆå¡«å†™é¢„ä¼°å€¼ï¼Œå¹¶åœ¨å¤‡æ³¨ä¸­æ ‡æ³¨"é¢„ä¼°"`);
        console.info(`å½“å‰å¯ç”¨çš„æœˆä»½:`, Object.keys(AppData.index.sales).map(name => {
          return Object.keys(AppData.index.sales[name]).filter(m => m !== 'total');
        }).flat().filter((v, i, a) => a.indexOf(v) === i).sort((a, b) => Number(a) - Number(b)));
        return;
      }
      
      showMessage('æ­£åœ¨è®¡ç®—ï¼Œè¯·ç¨å€™...', 'info');
      
      setTimeout(() => {
        try {
          const employees = Object.keys(AppData.index.employee);
          const results = employees.map(name => calculateMonthlyBonus(name, month));
          
          AppData.results.monthly = results;
          AppData.results.payment = generatePaymentReport(month);
          AppData.results.exam211 = generate211Report(month);
          
          renderStatistics();
          renderMonthlyReport();
          
          showMessage('è®¡ç®—å®Œæˆï¼', 'success');
          
        } catch (error) {
          console.error('è®¡ç®—é”™è¯¯:', error);
          console.error('é”™è¯¯è¯¦æƒ…:', error.stack);
          showMessage('è®¡ç®—è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: ' + error.message, 'error');
        }
      }, 100);
    }

    function startQuarterlyCalculation() {
      if (!checkDataReady(['employee', 'task', 'sales'])) {
        showMessage('è¯·å…ˆåœ¨æœˆåº¦è®¡ç®—é¡µé¢ä¸Šä¼ å‘˜å·¥ä¿¡æ¯ã€ä»»åŠ¡åˆ†é…è¡¨å’Œå›æ¬¾æ•°æ®', 'warning');
        return;
      }
      
      const quarter = document.getElementById('quarter-select').value;
      if (!quarter) {
        showMessage('è¯·é€‰æ‹©è®¡ç®—å­£åº¦', 'warning');
        return;
      }
      
      showMessage('æ­£åœ¨è®¡ç®—å­£åº¦å¥–é‡‘ï¼Œè¯·ç¨å€™...', 'info');
      
      setTimeout(() => {
        try {
          const employees = Object.keys(AppData.index.employee);
          const results = employees.map(name => calculateQuarterlyBonus(name, quarter));
          
          AppData.results.quarterly = results;
          renderQuarterlyReport();
          
          showMessage('å­£åº¦å¥–é‡‘è®¡ç®—å®Œæˆï¼', 'success');
          
        } catch (error) {
          console.error('è®¡ç®—é”™è¯¯:', error);
          showMessage('è®¡ç®—è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯', 'error');
        }
      }, 100);
    }

    // ==================== æŠ¥è¡¨ç”Ÿæˆ ====================
    function generatePaymentReport(month) {
      const results = [];
      
      for (const [name, payments] of Object.entries(AppData.index.sales)) {
        if (payments[month] !== undefined) {
          const employee = AppData.index.employee[name];
          results.push({
            ä¸šåŠ¡å‘˜: name,
            é—¨åº—: employee?.æ‰€å±åœ°åŒº || '-',
            æœˆä»½: `${month}æœˆ`,
            å›æ¬¾é‡‘é¢: payments[month]
          });
        }
      }
      
      return results;
    }

    function generate211Report(month) {
      const results = [];
      
      for (const [name, exams] of Object.entries(AppData.index.exam211)) {
        if (exams[month]) {
          const exam = exams[month];
          const å®Œæˆç‡ = exam.å®Œæˆ / exam.ä»»åŠ¡;
          const æ‰£æ¬¾é‡‘é¢ = 800 - (exam.å®Œæˆ / exam.ä»»åŠ¡) * 800;
          
          results.push({
            ä¸šåŠ¡å‘˜: name,
            æœˆä»½: `${month}æœˆ`,
            ç›®æ ‡åˆ†å€¼: exam.ä»»åŠ¡,
            å®Œæˆåˆ†å€¼: exam.å®Œæˆ,
            å®Œæˆç‡: formatPercent(å®Œæˆç‡),
            æ‰£æ¬¾é‡‘é¢: roundMoney(æ‰£æ¬¾é‡‘é¢),
            å¤‡æ³¨: exam.å¤‡æ³¨ || `å®Œæˆ${exam.å®Œæˆ}/${exam.ä»»åŠ¡}åˆ†`
          });
        }
      }
      
      return results;
    }

    // ==================== UIæ¸²æŸ“ ====================
    function renderStatistics() {
      const data = AppData.results.monthly;
      if (!data || data.length === 0) return;
      
      const stats = {
        æ€»äººæ•°: data.length,
        æ•°æ®å®Œæ•´: data.filter(r => r.æ•°æ®çŠ¶æ€ === 'å®Œæ•´').length,
        æ•°æ®ç¼ºå¤±: data.filter(r => r.æ•°æ®çŠ¶æ€ === 'æ•°æ®ç¼ºå¤±').length,
        è¯•ç”¨æœŸ: data.filter(r => r.æ•°æ®çŠ¶æ€ === 'è¯•ç”¨æœŸ').length,
        æ€»å¥–é‡‘: data.reduce((sum, r) => sum + (typeof r.å®å‘å¥–é‡‘ === 'number' ? r.å®å‘å¥–é‡‘ : 0), 0),
        å¹³å‡å¥–é‡‘: 0
      };
      
      stats.å¹³å‡å¥–é‡‘ = stats.æ•°æ®å®Œæ•´ > 0 ? stats.æ€»å¥–é‡‘ / stats.æ•°æ®å®Œæ•´ : 0;
      
      const statsHtml = `
        <div class="statistics-panel">
          <div class="stat-card">
            <div class="stat-value">${stats.æ€»äººæ•°}</div>
            <div class="stat-label">æ€»äººæ•°</div>
          </div>
          <div class="stat-card success">
            <div class="stat-value">${stats.æ•°æ®å®Œæ•´}</div>
            <div class="stat-label">æ•°æ®å®Œæ•´</div>
          </div>
          <div class="stat-card error">
            <div class="stat-value">${stats.æ•°æ®ç¼ºå¤±}</div>
            <div class="stat-label">æ•°æ®ç¼ºå¤±</div>
          </div>
          <div class="stat-card warning">
            <div class="stat-value">${stats.è¯•ç”¨æœŸ}</div>
            <div class="stat-label">è¯•ç”¨æœŸ</div>
          </div>
          <div class="stat-card primary">
            <div class="stat-value">${formatMoney(stats.æ€»å¥–é‡‘)}</div>
            <div class="stat-label">æ€»å¥–é‡‘(å…ƒ)</div>
          </div>
          <div class="stat-card info">
            <div class="stat-value">${formatMoney(stats.å¹³å‡å¥–é‡‘)}</div>
            <div class="stat-label">å¹³å‡å¥–é‡‘(å…ƒ)</div>
          </div>
        </div>
      `;
      
      document.getElementById('statistics-container').innerHTML = statsHtml;
    }

    function renderMonthlyReport() {
      const data = AppData.results.monthly;
      if (!data || data.length === 0) {
        document.getElementById('table-wrapper').innerHTML = '<p style="text-align: center; padding: 40px; color: var(--text-secondary);">æš‚æ— æ•°æ®</p>';
        return;
      }
      
      const tableHtml = `
        <table class="data-table">
          <thead>
            <tr>
              <th>ä¸šåŠ¡å‘˜</th>
              <th>åœ°åŒº</th>
              <th>æœˆä»½</th>
              <th>ä»»åŠ¡(å…ƒ)</th>
              <th>å›æ¬¾(å…ƒ)</th>
              <th>å®Œæˆç‡</th>
              <th>åŸºç¡€å¥–é‡‘</th>
              <th>å›æ¬¾è´Ÿæ¿€åŠ±</th>
              <th>211è´Ÿæ¿€åŠ±</th>
              <th>å®å‘å¥–é‡‘</th>
              <th>ä¸ªç¨</th>
              <th>å¤‡æ³¨</th>
            </tr>
          </thead>
          <tbody>
            ${data.map(row => renderMonthlyRow(row)).join('')}
          </tbody>
        </table>
      `;
      
      document.getElementById('table-wrapper').innerHTML = tableHtml;
    }

    function renderMonthlyRow(row) {
      const statusClass = row.æ•°æ®çŠ¶æ€ === 'å®Œæ•´' ? 'status-complete' : 
                          row.æ•°æ®çŠ¶æ€ === 'æ•°æ®ç¼ºå¤±' ? 'status-missing' : 
                          'status-trial';
      
      const highlightNegative = (value) => {
        if (typeof value === 'number' && value < 0) {
          return `<span class="negative-value">${formatMoney(value)}</span>`;
        }
        return typeof value === 'number' ? formatMoney(value) : value;
      };
      
      return `
        <tr class="${statusClass}">
          <td><strong>${row.ä¸šåŠ¡å‘˜}</strong></td>
          <td>${row.åœ°åŒº}</td>
          <td>${row.æœˆä»½}</td>
          <td>${formatMoney(row.ä»»åŠ¡)}</td>
          <td>${formatMoney(row.å›æ¬¾)}</td>
          <td>${row.å®Œæˆç‡}</td>
          <td>${highlightNegative(row.åŸºç¡€å¥–é‡‘)}</td>
          <td>${highlightNegative(row.å›æ¬¾è´Ÿæ¿€åŠ±)}</td>
          <td>${highlightNegative(row.è´Ÿæ¿€åŠ±211)}</td>
          <td><strong>${highlightNegative(row.å®å‘å¥–é‡‘)}</strong></td>
          <td>${row.ä¸ªç¨ || 0}</td>
          <td>${row.å¤‡æ³¨ || '-'}</td>
        </tr>
      `;
    }

    function renderPaymentReport() {
      const data = AppData.results.payment;
      if (!data || data.length === 0) {
        document.getElementById('table-wrapper').innerHTML = '<p style="text-align: center; padding: 40px; color: var(--text-secondary);">æš‚æ— å›æ¬¾æ•°æ®</p>';
        return;
      }
      
      const tableHtml = `
        <table class="data-table">
          <thead>
            <tr>
              <th>ä¸šåŠ¡å‘˜</th>
              <th>é—¨åº—</th>
              <th>æœˆä»½</th>
              <th>å›æ¬¾é‡‘é¢(å…ƒ)</th>
            </tr>
          </thead>
          <tbody>
            ${data.map(row => `
              <tr>
                <td><strong>${row.ä¸šåŠ¡å‘˜}</strong></td>
                <td>${row.é—¨åº—}</td>
                <td>${row.æœˆä»½}</td>
                <td>${formatMoney(row.å›æ¬¾é‡‘é¢)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      
      document.getElementById('table-wrapper').innerHTML = tableHtml;
    }

    function render211Report() {
      const data = AppData.results.exam211;
      if (!data || data.length === 0) {
        document.getElementById('table-wrapper').innerHTML = '<p style="text-align: center; padding: 40px; color: var(--text-secondary);">æš‚æ— 211è€ƒæ ¸æ•°æ®</p>';
        return;
      }
      
      const tableHtml = `
        <table class="data-table">
          <thead>
            <tr>
              <th>ä¸šåŠ¡å‘˜</th>
              <th>æœˆä»½</th>
              <th>ç›®æ ‡åˆ†å€¼</th>
              <th>å®Œæˆåˆ†å€¼</th>
              <th>å®Œæˆç‡</th>
              <th>æ‰£æ¬¾é‡‘é¢(å…ƒ)</th>
              <th>å¤‡æ³¨</th>
            </tr>
          </thead>
          <tbody>
            ${data.map(row => `
              <tr>
                <td><strong>${row.ä¸šåŠ¡å‘˜}</strong></td>
                <td>${row.æœˆä»½}</td>
                <td>${row.ç›®æ ‡åˆ†å€¼}</td>
                <td>${row.å®Œæˆåˆ†å€¼}</td>
                <td>${row.å®Œæˆç‡}</td>
                <td class="${row.æ‰£æ¬¾é‡‘é¢ > 0 ? 'negative-value' : ''}">${formatMoney(row.æ‰£æ¬¾é‡‘é¢)}</td>
                <td>${row.å¤‡æ³¨}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      
      document.getElementById('table-wrapper').innerHTML = tableHtml;
    }

    function renderQuarterlyReport() {
      const data = AppData.results.quarterly;
      if (!data || data.length === 0) {
        document.getElementById('quarter-table-wrapper').innerHTML = '<p style="text-align: center; padding: 40px; color: var(--text-secondary);">æš‚æ— æ•°æ®</p>';
        return;
      }
      
      const tableHtml = `
        <table class="data-table">
          <thead>
            <tr>
              <th>ä¸šåŠ¡å‘˜</th>
              <th>å­£åº¦</th>
              <th>å­£åº¦ä»»åŠ¡(å…ƒ)</th>
              <th>å­£åº¦å›æ¬¾(å…ƒ)</th>
              <th>å®Œæˆç‡</th>
              <th>åŸºç¡€å¥–é‡‘</th>
              <th>è¿”è¿˜é‡‘é¢</th>
              <th>å®å‘å¥–é‡‘</th>
              <th>å¤‡æ³¨</th>
            </tr>
          </thead>
          <tbody>
            ${data.map(row => renderQuarterlyRow(row)).join('')}
          </tbody>
        </table>
      `;
      
      document.getElementById('quarter-table-wrapper').innerHTML = tableHtml;
    }

    function renderQuarterlyRow(row) {
      const statusClass = row.æ•°æ®çŠ¶æ€ === 'å®Œæ•´' ? 'status-complete' : 
                          row.æ•°æ®çŠ¶æ€ === 'æ•°æ®ç¼ºå¤±' ? 'status-missing' : 
                          'status-trial';
      
      return `
        <tr class="${statusClass}">
          <td><strong>${row.ä¸šåŠ¡å‘˜}</strong></td>
          <td>${row.å­£åº¦}</td>
          <td>${formatMoney(row.å­£åº¦ä»»åŠ¡)}</td>
          <td>${formatMoney(row.å­£åº¦å›æ¬¾)}</td>
          <td>${row.å®Œæˆç‡}</td>
          <td>${formatMoney(row.åŸºç¡€å¥–é‡‘)}</td>
          <td>${formatMoney(row.è¿”è¿˜é‡‘é¢)}</td>
          <td><strong>${formatMoney(row.å®å‘å¥–é‡‘)}</strong></td>
          <td>${row.å¤‡æ³¨}</td>
        </tr>
      `;
    }

    // ==================== è¡¨æ ¼æœç´¢ç­›é€‰ ====================
    function filterTable(keyword) {
      const tableWrapper = document.getElementById(
        AppData.config.currentResultTab === 'monthly' || 
        AppData.config.currentResultTab === 'payment' || 
        AppData.config.currentResultTab === '211' ? 'table-wrapper' : 'quarter-table-wrapper'
      );
      const rows = tableWrapper.querySelectorAll('tbody tr');
      
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        if (text.includes(keyword.toLowerCase())) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    }

    function clearTableFilter() {
      document.getElementById('table-search').value = '';
      const tableWrapper = document.getElementById('table-wrapper');
      const rows = tableWrapper.querySelectorAll('tbody tr');
      rows.forEach(row => row.style.display = '');
    }

    // ==================== Excelå¯¼å‡º ====================
    function exportToExcel() {
      const data = AppData.results.monthly;
      if (!data || data.length === 0) {
        showMessage('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º', 'warning');
        return;
      }
      
      try {
        const wb = XLSX.utils.book_new();
        
        const ws1 = XLSX.utils.json_to_sheet(data);
        XLSX.utils.book_append_sheet(wb, ws1, 'æœˆåº¦å¥–é‡‘æ˜ç»†');
        
        if (AppData.results.payment && AppData.results.payment.length > 0) {
          const ws2 = XLSX.utils.json_to_sheet(AppData.results.payment);
          XLSX.utils.book_append_sheet(wb, ws2, 'å›æ¬¾æ˜ç»†');
        }
        
        if (AppData.results.exam211 && AppData.results.exam211.length > 0) {
          const ws3 = XLSX.utils.json_to_sheet(AppData.results.exam211);
          XLSX.utils.book_append_sheet(wb, ws3, '211è€ƒæ ¸');
        }
        
        const month = document.getElementById('month-select').value;
        const filename = `å¥–é‡‘è®¡ç®—ç»“æœ_${month}æœˆ_${new Date().toISOString().slice(0,10)}.xlsx`;
        
        XLSX.writeFile(wb, filename);
        showMessage('å¯¼å‡ºæˆåŠŸï¼', 'success');
        
      } catch (error) {
        console.error('å¯¼å‡ºé”™è¯¯:', error);
        showMessage('å¯¼å‡ºå¤±è´¥', 'error');
      }
    }

    function exportQuarterlyToExcel() {
      const data = AppData.results.quarterly;
      if (!data || data.length === 0) {
        showMessage('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º', 'warning');
        return;
      }
      
      try {
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(data);
        XLSX.utils.book_append_sheet(wb, ws, 'å­£åº¦å¥–é‡‘æ±‡æ€»');
        
        const quarter = document.getElementById('quarter-select').value;
        const filename = `å­£åº¦å¥–é‡‘_${quarter}_${new Date().toISOString().slice(0,10)}.xlsx`;
        
        XLSX.writeFile(wb, filename);
        showMessage('å¯¼å‡ºæˆåŠŸï¼', 'success');
        
      } catch (error) {
        console.error('å¯¼å‡ºé”™è¯¯:', error);
        showMessage('å¯¼å‡ºå¤±è´¥', 'error');
      }
    }

    // ==================== 211æ•°æ®ç®¡ç† ====================
    function render211EditTable() {
      let data = AppData.raw.exam211 || [];
      
      // è¿‡æ»¤æ‰æ±‡æ€»è¡Œ
      data = data.filter(row => {
        const month = String(row['æœˆä»½'] || '');
        const name = row['ä¸šåŠ¡äººå‘˜'];
        return name && !month.includes('åˆè®¡') && !month.includes('å­£åº¦');
      });
      
      if (data.length === 0) {
        document.getElementById('tbody-211-edit').innerHTML = `
          <tr>
            <td colspan="7" style="text-align: center; padding: 40px; color: var(--text-secondary);">
              æš‚æ— æ•°æ®ï¼Œè¯·ä¸Šä¼ 211æ•°æ®æˆ–æ·»åŠ æ–°è®°å½•
            </td>
          </tr>
        `;
        return;
      }
      
      const tbody = data.map((row, index) => render211EditRow(row, index)).join('');
      document.getElementById('tbody-211-edit').innerHTML = tbody;
    }

    function render211EditRow(row, index) {
      return `
        <tr data-index="${index}">
          <td>
            <select class="edit-input" data-field="æœˆä»½">
              ${generateMonthOptions(row.æœˆä»½)}
            </select>
          </td>
          <td>
            <input type="text" class="edit-input" data-field="å…·ä½“åœ°åŒº" 
                   value="${row.å…·ä½“åœ°åŒº || ''}" placeholder="è¾“å…¥åœ°åŒº">
          </td>
          <td>
            <select class="edit-input" data-field="ä¸šåŠ¡äººå‘˜">
              ${generateEmployeeOptions(row.ä¸šåŠ¡äººå‘˜)}
            </select>
          </td>
          <td>
            <input type="number" class="edit-input" data-field="ä»»åŠ¡" 
                   value="${row.ä»»åŠ¡ || 10}" min="0" step="1">
          </td>
          <td>
            <input type="number" class="edit-input" data-field="å®Œæˆ" 
                   value="${row.å®Œæˆ || 0}" min="0" step="0.1">
          </td>
          <td>
            <input type="text" class="edit-input" data-field="å¤‡æ³¨" 
                   value="${row.å¤‡æ³¨ || ''}" placeholder="å¤‡æ³¨ä¿¡æ¯">
          </td>
          <td>
            <button class="btn-icon" onclick="delete211Row(${index})" title="åˆ é™¤">
              ğŸ—‘ï¸
            </button>
          </td>
        </tr>
      `;
    }

    function generateMonthOptions(selectedMonth) {
      const months = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'];
      return months.map(m => 
        `<option value="${m}" ${m === String(selectedMonth) ? 'selected' : ''}>${m}æœˆ</option>`
      ).join('');
    }

    function generateEmployeeOptions(selectedEmployee) {
      const employees = Object.keys(AppData.index.employee || {});
      let options = '<option value="">è¯·é€‰æ‹©</option>';
      
      options += employees.map(name => 
        `<option value="${name}" ${name === selectedEmployee ? 'selected' : ''}>${name}</option>`
      ).join('');
      
      return options;
    }

    function add211Row() {
      if (!AppData.raw.exam211) {
        AppData.raw.exam211 = [];
      }
      
      const newRow = {
        æœˆä»½: '1',
        å…·ä½“åœ°åŒº: '',
        ä¸šåŠ¡äººå‘˜: '',
        ä»»åŠ¡: 10,
        å®Œæˆ: 0,
        å¤‡æ³¨: ''
      };
      
      AppData.raw.exam211.push(newRow);
      render211EditTable();
      
      const tbody = document.getElementById('tbody-211-edit');
      tbody.lastElementChild.scrollIntoView({ behavior: 'smooth' });
      
      showMessage('å·²æ·»åŠ æ–°è®°å½•', 'success');
    }

    function delete211Row(index) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
        return;
      }
      
      AppData.raw.exam211.splice(index, 1);
      render211EditTable();
      showMessage('å·²åˆ é™¤è®°å½•', 'success');
    }

    function save211Data() {
      const tbody = document.getElementById('tbody-211-edit');
      const rows = tbody.querySelectorAll('tr[data-index]');
      const newData = [];
      
      rows.forEach(row => {
        const data = {};
        row.querySelectorAll('.edit-input').forEach(input => {
          const field = input.dataset.field;
          let value = input.value;
          
          if (field === 'ä»»åŠ¡' || field === 'å®Œæˆ') {
            value = parseFloat(value) || 0;
          } else if (field === 'æœˆä»½') {
            value = String(value).replace(/[æœˆ]/g, '');
          }
          
          data[field] = value;
        });
        
        newData.push(data);
      });
      
      const invalidRows = newData.filter(row => 
        !row.ä¸šåŠ¡äººå‘˜ || !row.æœˆä»½
      );
      
      if (invalidRows.length > 0) {
        showMessage('è¯·å¡«å†™å®Œæ•´çš„ä¸šåŠ¡äººå‘˜å’Œæœˆä»½ä¿¡æ¯', 'warning');
        return;
      }
      
      AppData.raw.exam211 = newData;
      AppData.index.exam211 = build211Index(newData);
      
      showMessage('ä¿å­˜æˆåŠŸï¼', 'success');
    }

    function download211Template() {
      const template = [
        {
          æœˆä»½: '1',
          å…·ä½“åœ°åŒº: 'ç¤ºä¾‹åœ°åŒº',
          ä¸šåŠ¡äººå‘˜: 'ç¤ºä¾‹å‘˜å·¥',
          ä»»åŠ¡: 10,
          å®Œæˆ: 8,
          å¤‡æ³¨: 'è¯•ç”¨æœŸå‘˜å·¥è¯·åœ¨æ­¤æ ‡æ³¨'
        }
      ];
      
      const ws = XLSX.utils.json_to_sheet(template);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, '211å¨ç”µæ¨¡æ¿');
      
      ws['!cols'] = [
        { wch: 10 },
        { wch: 15 },
        { wch: 15 },
        { wch: 12 },
        { wch: 12 },
        { wch: 30 }
      ];
      
      XLSX.writeFile(wb, '211å¨ç”µè€ƒæ ¸æ¨¡æ¿.xlsx');
      showMessage('æ¨¡æ¿ä¸‹è½½æˆåŠŸï¼', 'success');
    }

    function upload211ForManage() {
      document.getElementById('file-211-manage').click();
    }

    function handle211FileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = e.target.result;
          const workbook = XLSX.read(data, { type: 'binary' });
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];
          let jsonData = XLSX.utils.sheet_to_json(worksheet);
          
          // è¿‡æ»¤æ‰æ±‡æ€»è¡Œ
          const originalLength = jsonData.length;
          jsonData = jsonData.filter(row => {
            const month = String(row['æœˆä»½'] || '');
            const name = row['ä¸šåŠ¡äººå‘˜'];
            return name && !month.includes('åˆè®¡') && !month.includes('å­£åº¦');
          });
          const filteredCount = originalLength - jsonData.length;
          
          const validation = validateData(jsonData, 'exam211');
          if (!validation.valid) {
            showMessage(`æ•°æ®éªŒè¯å¤±è´¥: ${validation.error}`, 'error');
            return;
          }
          
          AppData.raw.exam211 = jsonData;
          AppData.index.exam211 = build211Index(jsonData);
          
          render211EditTable();
          const successMsg = filteredCount > 0 
            ? `211æ•°æ®ä¸Šä¼ æˆåŠŸï¼å·²è‡ªåŠ¨è¿‡æ»¤${filteredCount}è¡Œæ±‡æ€»æ•°æ®ï¼Œå…±è½½å…¥${jsonData.length}æ¡æœ‰æ•ˆè®°å½•`
            : `211æ•°æ®ä¸Šä¼ æˆåŠŸï¼å…±è½½å…¥${jsonData.length}æ¡è®°å½•`;
          showMessage(successMsg, 'success');
          
        } catch (error) {
          console.error('[211ç®¡ç†] æ–‡ä»¶è§£æé”™è¯¯:', error);
          console.error('é”™è¯¯å †æ ˆ:', error.stack);
          showMessage(`æ–‡ä»¶è§£æå¤±è´¥: ${error.message || 'è¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼'}`, 'error');
        }
      };
      
      reader.onerror = function(error) {
        console.error('æ–‡ä»¶è¯»å–é”™è¯¯:', error);
        showMessage('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      };
      
      reader.readAsBinaryString(file);
    }

    // ==================== å­£åº¦é¡µé¢æ•°æ®çŠ¶æ€ ====================
    function updateQuarterlyDataStatus() {
      const hasEmployee = AppData.raw.employee && AppData.raw.employee.length > 0;
      const hasTask = AppData.raw.task && AppData.raw.task.length > 0;
      const hasSales = AppData.raw.sales && AppData.raw.sales.length > 0;
      
      let statusHtml = '';
      
      if (hasEmployee && hasTask && hasSales) {
        statusHtml = `
          <p style="color: var(--success-color); display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 20px;">âœ“</span>
            <span>åŸºç¡€æ•°æ®å·²å‡†å¤‡å®Œæ¯•ï¼Œå¯ä»¥å¼€å§‹è®¡ç®—å­£åº¦å¥–é‡‘</span>
          </p>
        `;
      } else {
        statusHtml = `
          <p style="color: var(--warning-color); margin-bottom: 12px;">
            âš  è¯·å…ˆåœ¨æœˆåº¦è®¡ç®—é¡µé¢ä¸Šä¼ ä»¥ä¸‹æ•°æ®ï¼š
          </p>
          <ul style="margin-left: 24px; color: var(--text-secondary);">
            <li>${hasEmployee ? 'âœ“' : 'âœ—'} å‘˜å·¥åŸºç¡€ä¿¡æ¯è¡¨</li>
            <li>${hasTask ? 'âœ“' : 'âœ—'} ä»»åŠ¡åˆ†é…è¡¨</li>
            <li>${hasSales ? 'âœ“' : 'âœ—'} é”€å”®å‘˜å›æ¬¾æ±‡æ€»è¡¨</li>
          </ul>
        `;
      }
      
      document.getElementById('quarterly-data-status').innerHTML = statusHtml;
    }

    // ==================== AIåŠŸèƒ½æ¨¡å— ====================
    
    // åˆ‡æ¢åˆ°AIåŠ©æ‰‹å¹¶å¼€å§‹åˆ†æ
    function switchToAIAndAnalyze() {
      if (!AppData.results.monthly || AppData.results.monthly.length === 0) {
        showMessage('è¯·å…ˆå®Œæˆæœˆåº¦è®¡ç®—', 'warning');
        return;
      }
      
      // åˆ‡æ¢åˆ°AIåŠ©æ‰‹é¡µé¢
      switchPage('ai-assistant');
      
      // ç¨ç­‰ä¸€ä¸‹å†è§¦å‘åˆ†æï¼Œç¡®ä¿é¡µé¢å·²åˆ‡æ¢
      setTimeout(() => {
        triggerAIAnalysis('comprehensive');
      }, 300);
    }
    
    // åœæ­¢AIæµå¼ç”Ÿæˆ
    function stopAIStreaming() {
      if (AppData.ai.controller) {
        AppData.ai.controller.abort();
        AppData.ai.isStreaming = false;
        document.getElementById('btn-stop-gen').style.display = 'none';
        document.getElementById('btn-send-message').disabled = false;
        showMessage('å·²åœæ­¢ç”Ÿæˆ', 'info');
      }
    }
    
    // è°ƒç”¨DeepSeek APIï¼ˆæµå¼ï¼‰
    async function callDeepSeekAPIStream(messages, onChunk) {
      const { baseURL, apiKey, model, timeoutMs } = AppData.ai.apiConfig;
      
      // åˆ›å»ºå¯ä¸­æ–­çš„æ§åˆ¶å™¨
      AppData.ai.controller = new AbortController();
      AppData.ai.isStreaming = true;
      
      // æ˜¾ç¤ºåœæ­¢æŒ‰é’®
      document.getElementById('btn-stop-gen').style.display = 'block';
      document.getElementById('btn-send-message').disabled = true;
      
      try {
        const response = await fetch(`${baseURL}/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: messages,
            temperature: 0.5,
            max_tokens: 1500,
            stream: true
          }),
          signal: AppData.ai.controller.signal
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error?.message || 'è¯·æ±‚å¤±è´¥');
        }
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        let fullContent = '';
        
        while (true) {
          const { done, value } = await reader.read();
          
          if (done) break;
          
          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop();
          
          for (const line of lines) {
            if (line.startsWith('data: ')) {
              const data = line.slice(6);
              if (data === '[DONE]') continue;
              
              try {
                const json = JSON.parse(data);
                const content = json.choices[0]?.delta?.content || '';
                if (content) {
                  fullContent += content;
                  onChunk(content, fullContent);
                }
              } catch (e) {
                // å¿½ç•¥è§£æé”™è¯¯
              }
            }
          }
        }
        
        return fullContent;
        
      } catch (error) {
        if (error.name === 'AbortError') {
          throw new Error('ç”Ÿæˆå·²åœæ­¢');
        }
        console.error('AI APIè°ƒç”¨é”™è¯¯:', error);
        throw error;
      } finally {
        AppData.ai.isStreaming = false;
        document.getElementById('btn-stop-gen').style.display = 'none';
        document.getElementById('btn-send-message').disabled = false;
      }
    }
    
    // å‡†å¤‡æ•°æ®ä¸Šä¸‹æ–‡
    function prepareDataContext() {
      const context = {
        hasData: false,
        summary: {},
        monthlyResults: [],
        warnings: [],
        regionAnalysis: {},
        employeeAnalysis: [],
        policyAnalysis: {}
      };
      
      // æ£€æŸ¥æ˜¯å¦æœ‰è®¡ç®—ç»“æœ
      if (!AppData.results.monthly || AppData.results.monthly.length === 0) {
        return context;
      }
      
      context.hasData = true;
      const results = AppData.results.monthly;
      
      // åŸºç¡€ç»Ÿè®¡
      context.summary = {
        æ€»äººæ•°: results.length,
        æ•°æ®å®Œæ•´: results.filter(r => r.æ•°æ®çŠ¶æ€ === 'å®Œæ•´').length,
        æ•°æ®ç¼ºå¤±: results.filter(r => r.æ•°æ®çŠ¶æ€ === 'æ•°æ®ç¼ºå¤±').length,
        è¯•ç”¨æœŸ: results.filter(r => r.æ•°æ®çŠ¶æ€ === 'è¯•ç”¨æœŸ').length,
        æ€»å¥–é‡‘: results.reduce((sum, r) => sum + (typeof r.å®å‘å¥–é‡‘ === 'number' ? r.å®å‘å¥–é‡‘ : 0), 0)
      };
      
      // æœˆåº¦ç»“æœæ•°æ®ï¼ˆç²¾ç®€ç‰ˆï¼‰
      context.monthlyResults = results.filter(r => r.æ•°æ®çŠ¶æ€ === 'å®Œæ•´').map(r => ({
        ä¸šåŠ¡å‘˜: r.ä¸šåŠ¡å‘˜,
        åœ°åŒº: r.åœ°åŒº,
        ä»»åŠ¡: r.ä»»åŠ¡,
        å›æ¬¾: r.å›æ¬¾,
        å®Œæˆç‡: r.å®Œæˆç‡,
        å®å‘å¥–é‡‘: r.å®å‘å¥–é‡‘,
        å›æ¬¾è´Ÿæ¿€åŠ±: r.å›æ¬¾è´Ÿæ¿€åŠ±,
        è´Ÿæ¿€åŠ±211: r.è´Ÿæ¿€åŠ±211
      }));
      
      // åœ°åŒºåˆ†æ
      const regionMap = {};
      results.filter(r => r.æ•°æ®çŠ¶æ€ === 'å®Œæ•´').forEach(r => {
        if (!regionMap[r.åœ°åŒº]) {
          regionMap[r.åœ°åŒº] = {
            åœ°åŒº: r.åœ°åŒº,
            äººæ•°: 0,
            æ€»ä»»åŠ¡: 0,
            æ€»å›æ¬¾: 0,
            æ€»å¥–é‡‘: 0,
            å¹³å‡å®Œæˆç‡: 0,
            æ ‡å‡†å¥–é‡‘æ€»é¢: 0
          };
        }
        regionMap[r.åœ°åŒº].äººæ•°++;
        regionMap[r.åœ°åŒº].æ€»ä»»åŠ¡ += r.ä»»åŠ¡ || 0;
        regionMap[r.åœ°åŒº].æ€»å›æ¬¾ += r.å›æ¬¾ || 0;
        regionMap[r.åœ°åŒº].æ€»å¥–é‡‘ += r.å®å‘å¥–é‡‘ || 0;
        
        // è·å–æ ‡å‡†å¥–é‡‘
        const employeeInfo = AppData.index.employee[r.ä¸šåŠ¡å‘˜];
        if (employeeInfo) {
          regionMap[r.åœ°åŒº].æ ‡å‡†å¥–é‡‘æ€»é¢ += employeeInfo.æ ‡å‡†å¥–é‡‘ || 0;
        }
      });
      
      // è®¡ç®—å¹³å‡å®Œæˆç‡å’Œå¥–é‡‘å‘æ”¾ç‡
      Object.values(regionMap).forEach(region => {
        region.å¹³å‡å®Œæˆç‡ = region.æ€»ä»»åŠ¡ > 0 ? (region.æ€»å›æ¬¾ / region.æ€»ä»»åŠ¡) : 0;
        region.å¥–é‡‘å‘æ”¾ç‡ = region.æ ‡å‡†å¥–é‡‘æ€»é¢ > 0 ? (region.æ€»å¥–é‡‘ / region.æ ‡å‡†å¥–é‡‘æ€»é¢) : 0;
        region.äººå‡å¥–é‡‘ = region.äººæ•° > 0 ? (region.æ€»å¥–é‡‘ / region.äººæ•°) : 0;
      });
      
      context.regionAnalysis = regionMap;
      
      // å‘˜å·¥ç»©æ•ˆåˆ†æï¼ˆæ’åï¼‰
      context.employeeAnalysis = results.filter(r => r.æ•°æ®çŠ¶æ€ === 'å®Œæ•´').map(r => {
        const employeeInfo = AppData.index.employee[r.ä¸šåŠ¡å‘˜];
        const æ ‡å‡†å¥–é‡‘ = employeeInfo ? employeeInfo.æ ‡å‡†å¥–é‡‘ : 0;
        const å®Œæˆç‡æ•°å€¼ = parseFloat(r.å®Œæˆç‡) / 100;
        const å¥–é‡‘å‘æ”¾ç‡ = æ ‡å‡†å¥–é‡‘ > 0 ? (r.å®å‘å¥–é‡‘ / æ ‡å‡†å¥–é‡‘) : 0;
        
        return {
          ä¸šåŠ¡å‘˜: r.ä¸šåŠ¡å‘˜,
          åœ°åŒº: r.åœ°åŒº,
          æ ‡å‡†å¥–é‡‘: æ ‡å‡†å¥–é‡‘,
          å®å‘å¥–é‡‘: r.å®å‘å¥–é‡‘,
          å¥–é‡‘å‘æ”¾ç‡: å¥–é‡‘å‘æ”¾ç‡,
          å®Œæˆç‡: å®Œæˆç‡æ•°å€¼,
          å›æ¬¾è´Ÿæ¿€åŠ±: r.å›æ¬¾è´Ÿæ¿€åŠ±,
          è´Ÿæ¿€åŠ±211: r.è´Ÿæ¿€åŠ±211,
          æ€»æ‰£æ¬¾: (r.å›æ¬¾è´Ÿæ¿€åŠ± || 0) + (r.è´Ÿæ¿€åŠ±211 || 0)
        };
      }).sort((a, b) => b.å®Œæˆç‡ - a.å®Œæˆç‡);
      
      // æ”¿ç­–æ•ˆæœåˆ†æ
      const æ­å·å‘˜å·¥ = context.employeeAnalysis.filter(e => e.åœ°åŒº === 'æ­å·');
      const éæ­å·å‘˜å·¥ = context.employeeAnalysis.filter(e => e.åœ°åŒº !== 'æ­å·');
      
      context.policyAnalysis = {
        å½“å‰æ”¿ç­–: {
          æ­å·è´Ÿæ¿€åŠ±æ”¿ç­–: 'å®Œæˆç‡<50%æ‰£20%ï¼Œ50%-80%æ‰£10%',
          éæ­å·è´Ÿæ¿€åŠ±æ”¿ç­–: 'æ— è´Ÿæ¿€åŠ±',
          '211è€ƒæ ¸': 'å…¨å‘˜800å…ƒåŸºæ•°ï¼ŒæŒ‰å®Œæˆç‡æ‰£æ¬¾',
          æ ‡å‡†å¥–é‡‘: '70%åŸºç¡€+30%å­£åº¦'
        },
        æ­å·åœ°åŒº: {
          äººæ•°: æ­å·å‘˜å·¥.length,
          å¹³å‡å®Œæˆç‡: æ­å·å‘˜å·¥.length > 0 ? (æ­å·å‘˜å·¥.reduce((s, e) => s + e.å®Œæˆç‡, 0) / æ­å·å‘˜å·¥.length) : 0,
          å¹³å‡å¥–é‡‘å‘æ”¾ç‡: æ­å·å‘˜å·¥.length > 0 ? (æ­å·å‘˜å·¥.reduce((s, e) => s + e.å¥–é‡‘å‘æ”¾ç‡, 0) / æ­å·å‘˜å·¥.length) : 0,
          æ€»æ‰£æ¬¾: æ­å·å‘˜å·¥.reduce((s, e) => s + e.æ€»æ‰£æ¬¾, 0),
          ä½å®Œæˆç‡äººæ•°: æ­å·å‘˜å·¥.filter(e => e.å®Œæˆç‡ < 0.8).length
        },
        éæ­å·åœ°åŒº: {
          äººæ•°: éæ­å·å‘˜å·¥.length,
          å¹³å‡å®Œæˆç‡: éæ­å·å‘˜å·¥.length > 0 ? (éæ­å·å‘˜å·¥.reduce((s, e) => s + e.å®Œæˆç‡, 0) / éæ­å·å‘˜å·¥.length) : 0,
          å¹³å‡å¥–é‡‘å‘æ”¾ç‡: éæ­å·å‘˜å·¥.length > 0 ? (éæ­å·å‘˜å·¥.reduce((s, e) => s + e.å¥–é‡‘å‘æ”¾ç‡, 0) / éæ­å·å‘˜å·¥.length) : 0,
          æ€»æ‰£æ¬¾: éæ­å·å‘˜å·¥.reduce((s, e) => s + e.æ€»æ‰£æ¬¾, 0)
        }
      };
      
      // é£é™©é¢„è­¦
      results.forEach(r => {
        if (r.æ•°æ®çŠ¶æ€ === 'å®Œæ•´') {
          const å®Œæˆç‡æ•°å€¼ = parseFloat(r.å®Œæˆç‡) / 100;
          
          if (å®Œæˆç‡æ•°å€¼ < 0.5) {
            context.warnings.push({
              ç±»å‹: 'ä¸¥é‡é£é™©',
              ä¸šåŠ¡å‘˜: r.ä¸šåŠ¡å‘˜,
              åœ°åŒº: r.åœ°åŒº,
              é—®é¢˜: `å®Œæˆç‡ä»…${r.å®Œæˆç‡}ï¼Œè¿œä½äº50%`,
              å½±å“: `å›æ¬¾è´Ÿæ¿€åŠ±${r.å›æ¬¾è´Ÿæ¿€åŠ±}å…ƒ`
            });
          } else if (å®Œæˆç‡æ•°å€¼ < 0.8) {
            context.warnings.push({
              ç±»å‹: 'è­¦å‘Š',
              ä¸šåŠ¡å‘˜: r.ä¸šåŠ¡å‘˜,
              åœ°åŒº: r.åœ°åŒº,
              é—®é¢˜: `å®Œæˆç‡${r.å®Œæˆç‡}ï¼Œæœªè¾¾80%`,
              å½±å“: `å›æ¬¾è´Ÿæ¿€åŠ±${r.å›æ¬¾è´Ÿæ¿€åŠ±}å…ƒ`
            });
          }
          
          if (r.è´Ÿæ¿€åŠ±211 > 400) {
            context.warnings.push({
              ç±»å‹: '211é£é™©',
              ä¸šåŠ¡å‘˜: r.ä¸šåŠ¡å‘˜,
              åœ°åŒº: r.åœ°åŒº,
              é—®é¢˜: `211è€ƒæ ¸ä¸ä½³ï¼Œæ‰£æ¬¾${r.è´Ÿæ¿€åŠ±211}å…ƒ`,
              å½±å“: 'éœ€åŠ å¼ºå¨ç”µä¸šåŠ¡'
            });
          }
        }
      });
      
      return context;
    }
    
    // ç”Ÿæˆç³»ç»Ÿæç¤ºè¯
    function generateSystemPrompt(context, isStructured = false, analysisType = null) {
      if (!context.hasData) {
        return `ä½ æ˜¯ä¸€ä¸ªä¸šåŠ¡å‘˜å¥–é‡‘è®¡ç®—ç³»ç»Ÿçš„AIåŠ©æ‰‹ã€‚ç”¨æˆ·è¿˜æ²¡æœ‰ä¸Šä¼ æ•°æ®æˆ–å®Œæˆè®¡ç®—ã€‚
è¯·å‹å¥½åœ°æç¤ºç”¨æˆ·å…ˆä¸Šä¼ æ•°æ®å¹¶å®Œæˆè®¡ç®—ï¼Œæ‰èƒ½è¿›è¡Œæ•°æ®åˆ†æã€‚`;
      }
      
      // æ”¿ç­–æ¨èä¸“ç”¨æç¤ºè¯
      if (analysisType === 'policy') {
        const regionSummary = Object.values(context.regionAnalysis).map(r => 
          `${r.åœ°åŒº}: ${r.äººæ•°}äºº, å®Œæˆç‡${(r.å¹³å‡å®Œæˆç‡ * 100).toFixed(1)}%, å¥–é‡‘å‘æ”¾ç‡${(r.å¥–é‡‘å‘æ”¾ç‡ * 100).toFixed(1)}%, äººå‡å¥–é‡‘${formatMoney(r.äººå‡å¥–é‡‘)}å…ƒ`
        ).join('\n');
        
        return `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è–ªé…¬æ”¿ç­–åˆ†æä¸“å®¶ï¼Œç²¾é€šé”€å”®ææˆä½“ç³»è®¾è®¡å’Œä¼˜åŒ–ã€‚

**å½“å‰æ”¿ç­–ä½“ç³»ï¼š**
- æ ‡å‡†å¥–é‡‘æ„æˆï¼š70%æœˆåº¦åŸºç¡€ + 30%å­£åº¦å¥–é‡‘
- æ­å·åœ°åŒºè´Ÿæ¿€åŠ±ï¼šå®Œæˆç‡<50%æ‰£20%æ ‡å‡†å¥–é‡‘ï¼Œ50%-80%æ‰£10%
- å…¶ä»–åœ°åŒºï¼šæ— å›æ¬¾è´Ÿæ¿€åŠ±
- 211å¨ç”µè€ƒæ ¸ï¼šå…¨å‘˜800å…ƒåŸºæ•°ï¼ŒæŒ‰å®Œæˆç‡æ‰£æ¬¾
- å­£åº¦æ”¿ç­–ï¼šæ­å·å®Œæˆç‡â‰¥80%è¿”è¿˜æœˆåº¦è´Ÿæ¿€åŠ±

**æ•°æ®ç»Ÿè®¡ï¼š**
æ€»äººæ•°ï¼š${context.summary.æ€»äººæ•°}ï¼Œæ€»å¥–é‡‘ï¼š${formatMoney(context.summary.æ€»å¥–é‡‘)}å…ƒ

**å„åœ°åŒºè¡¨ç°ï¼š**
${regionSummary}

**æ­å·åœ°åŒºè¯¦ç»†ï¼š**
- äººæ•°ï¼š${context.policyAnalysis.æ­å·åœ°åŒº.äººæ•°}äºº
- å¹³å‡å®Œæˆç‡ï¼š${(context.policyAnalysis.æ­å·åœ°åŒº.å¹³å‡å®Œæˆç‡ * 100).toFixed(1)}%
- å¹³å‡å¥–é‡‘å‘æ”¾ç‡ï¼š${(context.policyAnalysis.æ­å·åœ°åŒº.å¹³å‡å¥–é‡‘å‘æ”¾ç‡ * 100).toFixed(1)}%
- æ€»æ‰£æ¬¾ï¼š${formatMoney(context.policyAnalysis.æ­å·åœ°åŒº.æ€»æ‰£æ¬¾)}å…ƒ
- ä½å®Œæˆç‡(<80%)äººæ•°ï¼š${context.policyAnalysis.æ­å·åœ°åŒº.ä½å®Œæˆç‡äººæ•°}äºº

**éæ­å·åœ°åŒºè¯¦ç»†ï¼š**
- äººæ•°ï¼š${context.policyAnalysis.éæ­å·åœ°åŒº.äººæ•°}äºº
- å¹³å‡å®Œæˆç‡ï¼š${(context.policyAnalysis.éæ­å·åœ°åŒº.å¹³å‡å®Œæˆç‡ * 100).toFixed(1)}%
- å¹³å‡å¥–é‡‘å‘æ”¾ç‡ï¼š${(context.policyAnalysis.éæ­å·åœ°åŒº.å¹³å‡å¥–é‡‘å‘æ”¾ç‡ * 100).toFixed(1)}%

**å‘˜å·¥ç»©æ•ˆTOP5ï¼š**
${context.employeeAnalysis.slice(0, 5).map((e, i) => 
  `${i + 1}. ${e.ä¸šåŠ¡å‘˜}(${e.åœ°åŒº}): å®Œæˆç‡${(e.å®Œæˆç‡ * 100).toFixed(1)}%, å¥–é‡‘å‘æ”¾ç‡${(e.å¥–é‡‘å‘æ”¾ç‡ * 100).toFixed(1)}%, æ‰£æ¬¾${formatMoney(e.æ€»æ‰£æ¬¾)}å…ƒ`
).join('\n')}

**ç»©æ•ˆå5åï¼š**
${context.employeeAnalysis.slice(-5).reverse().map((e, i) => 
  `${i + 1}. ${e.ä¸šåŠ¡å‘˜}(${e.åœ°åŒº}): å®Œæˆç‡${(e.å®Œæˆç‡ * 100).toFixed(1)}%, å¥–é‡‘å‘æ”¾ç‡${(e.å¥–é‡‘å‘æ”¾ç‡ * 100).toFixed(1)}%, æ‰£æ¬¾${formatMoney(e.æ€»æ‰£æ¬¾)}å…ƒ`
).join('\n')}

è¯·åŸºäºä»¥ä¸Šæ•°æ®ï¼Œä»æ¿€åŠ±æ•ˆæœã€æˆæœ¬æ§åˆ¶ã€å…¬å¹³æ€§ã€å¯æ“ä½œæ€§ç­‰è§’åº¦ï¼Œç»™å‡ºå…·ä½“çš„ã€å¯é‡åŒ–çš„æ”¿ç­–ä¼˜åŒ–å»ºè®®ã€‚å»ºè®®åº”åŒ…æ‹¬ï¼š
1. å…·ä½“è°ƒæ•´æ–¹æ¡ˆï¼ˆå¦‚é˜ˆå€¼ã€æ¯”ä¾‹ã€é‡‘é¢ï¼‰
2. é¢„æœŸæ•ˆæœï¼ˆå¦‚æå‡X%å®Œæˆç‡ï¼Œå‡å°‘Xå…ƒæ‰£æ¬¾ï¼‰
3. å®æ–½å»ºè®®ï¼ˆä¼˜å…ˆçº§ã€è¯•ç‚¹æ–¹æ¡ˆç­‰ï¼‰`;
      }
      
      if (isStructured) {
        return `ä½ æ˜¯ä¸“ä¸šçš„ä¸šåŠ¡æ•°æ®åˆ†æä¸“å®¶ã€‚åŸºäºä»¥ä¸‹æ•°æ®è¿›è¡Œåˆ†æï¼š

æ•°æ®æ¦‚è§ˆï¼šæ€»${context.summary.æ€»äººæ•°}äººï¼Œå®Œæ•´${context.summary.æ•°æ®å®Œæ•´}äººï¼Œæ€»å¥–é‡‘${formatMoney(context.summary.æ€»å¥–é‡‘)}å…ƒ

è¯¦ç»†æ•°æ®ï¼š${JSON.stringify(context.monthlyResults.slice(0, 8), null, 2)}

é£é™©é¢„è­¦ï¼š${JSON.stringify(context.warnings.slice(0, 5), null, 2)}

è¯·ç”¨ç®€æ´ã€ç›´è§‚çš„è¯­è¨€å›ç­”ï¼Œé‡ç‚¹çªå‡ºæ•°æ®æ´å¯Ÿå’Œå»ºè®®ã€‚`;
      }
      
      return `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä¸šåŠ¡æ•°æ®åˆ†æä¸“å®¶ï¼Œè´Ÿè´£åˆ†æä¸šåŠ¡å‘˜å¥–é‡‘è®¡ç®—ç³»ç»Ÿçš„æ•°æ®ã€‚

å½“å‰æ•°æ®æ¦‚è§ˆï¼š
- æ€»äººæ•°ï¼š${context.summary.æ€»äººæ•°}
- æ•°æ®å®Œæ•´ï¼š${context.summary.æ•°æ®å®Œæ•´}äºº
- æ€»å¥–é‡‘ï¼š${formatMoney(context.summary.æ€»å¥–é‡‘)}å…ƒ
- é£é™©é¢„è­¦ï¼š${context.warnings.length}æ¡

è¯·åŸºäºæ•°æ®å›ç­”ç”¨æˆ·é—®é¢˜ï¼Œè¦æ±‚ç®€æ´ä¸“ä¸šã€é‡ç‚¹çªå‡ºã€‚`;
    }
    
    // è§¦å‘AIåˆ†æï¼ˆåŠŸèƒ½å¡ç‰‡ï¼‰
    async function triggerAIAnalysis(type) {
      const context = prepareDataContext();
      
      if (!context.hasData) {
        showMessage('è¯·å…ˆä¸Šä¼ æ•°æ®å¹¶å®Œæˆæœˆåº¦è®¡ç®—', 'warning');
        return;
      }
      
      const prompts = {
        comprehensive: 'è¯·å¯¹å½“å‰æœˆåº¦æ•°æ®è¿›è¡Œå…¨é¢åˆ†æï¼ŒåŒ…æ‹¬ï¼šæ•´ä½“å®Œæˆæƒ…å†µã€å„åœ°åŒºè¡¨ç°ã€å‘˜å·¥è¡¨ç°æ’åã€å­˜åœ¨çš„é—®é¢˜å’Œä¼˜åŒ–å»ºè®®ã€‚',
        risk: 'è¯·è¯†åˆ«å½“å‰æ•°æ®ä¸­çš„æ‰€æœ‰é£é™©ç‚¹ï¼ŒåŒ…æ‹¬ï¼šä½å®Œæˆç‡å‘˜å·¥ã€211è€ƒæ ¸é—®é¢˜ã€å¯èƒ½å½±å“å­£åº¦å¥–é‡‘çš„æƒ…å†µï¼Œå¹¶ç»™å‡ºåº”å¯¹å»ºè®®ã€‚',
        suggestion: 'åŸºäºå½“å‰æ•°æ®ï¼Œè¯·ç»™å‡ºå…·ä½“çš„ä¼˜åŒ–å»ºè®®ï¼ŒåŒ…æ‹¬ï¼šå¦‚ä½•æå‡ä¸šç»©ã€å¦‚ä½•æ”¹è¿›ä»»åŠ¡åˆ†é…ã€å¦‚ä½•åŠ å¼ºè–„å¼±ç¯èŠ‚ã€‚',
        comparison: 'è¯·è¿›è¡Œè·¨åœ°åŒºå’Œè·¨å‘˜å·¥çš„å¯¹æ¯”åˆ†æï¼Œæ‰¾å‡ºè¡¨ç°ä¼˜ç§€å’Œéœ€è¦æ”¹è¿›çš„åœ°æ–¹ï¼Œåˆ†æå·®å¼‚åŸå› ã€‚',
        policy: `è¯·åŸºäºå½“å‰é”€å”®æ•°æ®ï¼Œåˆ†æææˆæ”¿ç­–çš„åˆç†æ€§å¹¶ç»™å‡ºä¼˜åŒ–å»ºè®®ï¼š

1. **æ ‡å‡†å¥–é‡‘è°ƒæ•´å»ºè®®**ï¼šåˆ†æå„åœ°åŒº/å„å‘˜å·¥çš„æ ‡å‡†å¥–é‡‘æ˜¯å¦åˆç†ï¼Œæ˜¯å¦éœ€è¦è°ƒæ•´
2. **åœ°åŒºæ”¿ç­–å·®å¼‚åŒ–**ï¼šè¯„ä¼°æ­å·åœ°åŒºçš„è´Ÿæ¿€åŠ±æ”¿ç­–æ•ˆæœï¼Œæ˜¯å¦éœ€è¦æ¨å¹¿åˆ°å…¶ä»–åœ°åŒºæˆ–è°ƒæ•´åŠ›åº¦
3. **211è€ƒæ ¸æ”¿ç­–**ï¼šè¯„ä¼°800å…ƒåŸºæ•°æ˜¯å¦åˆç†ï¼Œæ˜¯å¦éœ€è¦è°ƒæ•´è€ƒæ ¸æ ‡å‡†æˆ–å¥–æƒ©åŠ›åº¦
4. **å®Œæˆç‡é˜ˆå€¼ä¼˜åŒ–**ï¼šå½“å‰50%/80%çš„é˜ˆå€¼æ˜¯å¦åˆç†ï¼Œå»ºè®®æ›´æœ‰æ¿€åŠ±æ€§çš„é˜ˆå€¼è®¾ç½®
5. **å¥–é‡‘ç»“æ„ä¼˜åŒ–**ï¼šå½“å‰70%æœˆåº¦+30%å­£åº¦çš„ç»“æ„æ˜¯å¦æœ€ä¼˜ï¼Œå»ºè®®è°ƒæ•´æ¯”ä¾‹
6. **ææˆæ–¹æ¡ˆå»ºè®®**ï¼šåŸºäºå„åœ°åŒºå®Œæˆç‡å’Œå¥–é‡‘å‘æ”¾æƒ…å†µï¼Œå»ºè®®å·®å¼‚åŒ–ææˆæ–¹æ¡ˆ

è¯·ç»“åˆæ•°æ®ä¸­çš„åœ°åŒºåˆ†æã€å‘˜å·¥ç»©æ•ˆåˆ†æå’Œæ”¿ç­–æ•ˆæœåˆ†æï¼Œç»™å‡ºå…·ä½“çš„ã€å¯é‡åŒ–çš„æ”¿ç­–è°ƒæ•´å»ºè®®ã€‚`
      };
      
      const question = prompts[type];
      await sendAIMessage(question, true, type);
    }
    
    // å‘é€AIæ¶ˆæ¯ï¼ˆæµå¼ï¼‰
    async function sendAIMessage(userMessage, isSystemTriggered = false, analysisType = null) {
      const context = prepareDataContext();
      
      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢ï¼ˆå¦‚æœä¸æ˜¯ç³»ç»Ÿè§¦å‘çš„ï¼‰
      if (!isSystemTriggered) {
        addChatMessage('user', userMessage);
      } else {
        // ç³»ç»Ÿè§¦å‘çš„åˆ†æï¼Œåœ¨å³ä¾§é¢æ¿æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        document.getElementById('btn-export-report').style.display = 'none';
        document.getElementById('analysis-content').innerHTML = `
          <div style="text-align: center; color: var(--primary-color);">
            <div class="loading-dots" style="justify-content: center; margin-bottom: 12px;">
              <span></span><span></span><span></span>
            </div>
            <p>AIæ­£åœ¨å¿«é€Ÿåˆ†æ...</p>
          </div>
        `;
      }
      
      // åˆ›å»ºAIæ¶ˆæ¯å®¹å™¨
      const aiMessageId = addChatMessage('ai', `
        <div class="loading-dots">
          <span></span><span></span><span></span>
        </div>
        <span style="margin-left: 8px;">æ­£åœ¨ç”Ÿæˆ...</span>
      `);
      
      try {
        // æ„å»ºæ¶ˆæ¯å†å²
        const messages = [
          {
            role: 'system',
            content: generateSystemPrompt(context, isSystemTriggered, analysisType)
          },
          ...AppData.ai.chatHistory.slice(-6), // åªä¿ç•™æœ€è¿‘3è½®å¯¹è¯
          {
            role: 'user',
            content: userMessage
          }
        ];
        
        let fullResponse = '';
        
        // è°ƒç”¨æµå¼API
        await callDeepSeekAPIStream(messages, (chunk, full) => {
          fullResponse = full;
          
          // å®æ—¶æ›´æ–°å¯¹è¯æ¶ˆæ¯
          const messageElement = document.getElementById(aiMessageId);
          if (messageElement) {
            const contentDiv = messageElement.querySelector('.message-content');
            if (contentDiv) {
              contentDiv.innerHTML = marked.parse(full);
            }
          }
          
          // å¦‚æœæ˜¯ç³»ç»Ÿè§¦å‘ï¼Œå®æ—¶æ›´æ–°å³ä¾§é¢æ¿
          if (isSystemTriggered) {
            displayAnalysisResultStreaming(userMessage, full, context, analysisType);
          }
        });
        
        // ä¿å­˜å¯¹è¯å†å²ï¼ˆé™åˆ¶æœ€è¿‘6è½®ï¼‰
        AppData.ai.chatHistory.push(
          { role: 'user', content: userMessage },
          { role: 'assistant', content: fullResponse }
        );
        
        if (AppData.ai.chatHistory.length > 12) {
          AppData.ai.chatHistory = AppData.ai.chatHistory.slice(-12);
        }
        
      } catch (error) {
        removeChatMessage(aiMessageId);
        addChatMessage('ai', `âŒ ${error.message || 'AIæœåŠ¡å‡ºç°é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•'}`);
        
        if (isSystemTriggered) {
          document.getElementById('btn-export-report').style.display = 'none';
          document.getElementById('analysis-content').innerHTML = `
            <div style="color: var(--error-color); text-align: center; padding: 40px;">
              <div style="font-size: 48px; margin-bottom: 16px;">âš ï¸</div>
              <p>åˆ†æå¤±è´¥ï¼š${error.message}</p>
            </div>
          `;
        }
        showMessage('AIæœåŠ¡è°ƒç”¨å¤±è´¥', 'error');
      }
    }
    
    // æ·»åŠ èŠå¤©æ¶ˆæ¯
    function addChatMessage(role, content) {
      const messagesDiv = document.getElementById('chat-messages');
      const messageId = 'msg-' + Date.now();
      
      const messageHtml = `
        <div class="message-bubble ${role}" id="${messageId}">
          <div class="message-avatar">${role === 'ai' ? 'ğŸ¤–' : 'ğŸ‘¤'}</div>
          <div class="message-content">${role === 'ai' && content.includes('#') ? marked.parse(content) : content}</div>
        </div>
      `;
      
      messagesDiv.insertAdjacentHTML('beforeend', messageHtml);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      
      return messageId;
    }
    
    // ç§»é™¤èŠå¤©æ¶ˆæ¯
    function removeChatMessage(messageId) {
      const message = document.getElementById(messageId);
      if (message) {
        message.remove();
      }
    }
    
    // æ˜¾ç¤ºåˆ†æç»“æœï¼ˆæµå¼æ›´æ–°ï¼‰
    function displayAnalysisResultStreaming(question, answer, context, analysisType = null) {
      const analysisContent = document.getElementById('analysis-content');
      
      // è§£æAIå›å¤ï¼Œæå–å…³é”®ä¿¡æ¯
      const parsed = parseAIResponse(answer, context);
      
      let html = '';
      
      // å¦‚æœæ˜¯æ”¿ç­–æ¨èï¼Œæ˜¾ç¤ºç‰¹æ®Šçš„æ•°æ®é¢æ¿
      if (analysisType === 'policy') {
        html += `
          <div class="section">
            <div class="section-title">ğŸ¯ å½“å‰æ”¿ç­–æ¦‚è§ˆ</div>
            <div class="kpi-grid">
              <div class="kpi-card">
                <div class="kpi-value">${Object.keys(context.regionAnalysis).length}</div>
                <div class="kpi-label">åœ°åŒºæ•°é‡</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-value">${context.summary.æ€»äººæ•°}</div>
                <div class="kpi-label">å‘˜å·¥æ€»æ•°</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-value">${formatMoney(context.policyAnalysis.æ­å·åœ°åŒº.æ€»æ‰£æ¬¾ + context.policyAnalysis.éæ­å·åœ°åŒº.æ€»æ‰£æ¬¾)}</div>
                <div class="kpi-label">æ€»æ‰£æ¬¾(å…ƒ)</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-value">${((context.policyAnalysis.æ­å·åœ°åŒº.å¹³å‡å®Œæˆç‡ * context.policyAnalysis.æ­å·åœ°åŒº.äººæ•° + context.policyAnalysis.éæ­å·åœ°åŒº.å¹³å‡å®Œæˆç‡ * context.policyAnalysis.éæ­å·åœ°åŒº.äººæ•°) / context.summary.æ€»äººæ•° * 100).toFixed(1)}%</div>
                <div class="kpi-label">å¹³å‡å®Œæˆç‡</div>
              </div>
            </div>
          </div>
          
          <div class="section">
            <div class="section-title">ğŸ“ å„åœ°åŒºè¡¨ç°å¯¹æ¯”</div>
            <div class="list">
        `;
        
        Object.values(context.regionAnalysis).forEach(region => {
          const completionRate = (region.å¹³å‡å®Œæˆç‡ * 100).toFixed(1);
          const payoutRate = (region.å¥–é‡‘å‘æ”¾ç‡ * 100).toFixed(1);
          const badgeClass = region.å¹³å‡å®Œæˆç‡ >= 0.8 ? 'badge-ok' : region.å¹³å‡å®Œæˆç‡ >= 0.5 ? 'badge-warn' : 'badge-danger';
          
          html += `
            <div class="list-item">
              <div class="title">
                <span class="badge ${badgeClass}">${completionRate}%</span>
                <div style="margin-top: 6px; font-size: 14px; font-weight: 600;">${region.åœ°åŒº}</div>
              </div>
              <div class="desc">
                <div>äººæ•°ï¼š${region.äººæ•°}äºº | äººå‡å¥–é‡‘ï¼š${formatMoney(region.äººå‡å¥–é‡‘)}å…ƒ</div>
                <div style="margin-top: 4px;">å¥–é‡‘å‘æ”¾ç‡ï¼š${payoutRate}% | ä»»åŠ¡ï¼š${formatMoney(region.æ€»ä»»åŠ¡)}å…ƒ</div>
                <small>å›æ¬¾ï¼š${formatMoney(region.æ€»å›æ¬¾)}å…ƒ</small>
              </div>
            </div>
          `;
        });
        
        html += `
            </div>
          </div>
        `;
      } else {
        // å¸¸è§„åˆ†ææ˜¾ç¤ºæ•°æ®æ¦‚è§ˆ
        html += `
          <div class="section">
            <div class="section-title">ğŸ“Š æ•°æ®æ¦‚è§ˆ</div>
            <div class="kpi-grid">
              <div class="kpi-card">
                <div class="kpi-value">${context.summary.æ€»äººæ•°}</div>
                <div class="kpi-label">æ€»äººæ•°</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-value">${context.summary.æ•°æ®å®Œæ•´}</div>
                <div class="kpi-label">æ•°æ®å®Œæ•´</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-value">${context.warnings.length}</div>
                <div class="kpi-label">é£é™©é¢„è­¦</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-value">${formatMoney(context.summary.æ€»å¥–é‡‘)}</div>
                <div class="kpi-label">æ€»å¥–é‡‘(å…ƒ)</div>
              </div>
            </div>
          </div>
        `;
      }
      
      // é£é™©é¢„è­¦åŒºï¼ˆéæ”¿ç­–æ¨èæ—¶æ˜¾ç¤ºï¼‰
      if (context.warnings.length > 0 && analysisType !== 'policy') {
        html += `
          <div class="section">
            <div class="section-title">âš ï¸ é£é™©é¢„è­¦</div>
            <div class="list">
        `;
        
        context.warnings.slice(0, 5).forEach(w => {
          const badgeClass = w.ç±»å‹ === 'ä¸¥é‡é£é™©' ? 'badge-danger' : w.ç±»å‹ === '211é£é™©' ? 'badge-warn' : 'badge-warn';
          html += `
            <div class="list-item">
              <div class="title">
                <span class="badge ${badgeClass}">${w.ç±»å‹}</span>
                <div style="margin-top: 6px; font-size: 14px;">${w.ä¸šåŠ¡å‘˜}</div>
                <div style="margin-top: 2px; font-size: 12px; font-weight: 400; opacity: 0.7;">${w.åœ°åŒº}</div>
              </div>
              <div class="desc">
                <div style="margin-bottom: 8px;">${w.é—®é¢˜}</div>
                <small>${w.å½±å“}</small>
              </div>
            </div>
          `;
        });
        
        html += `
            </div>
          </div>
        `;
      }
      
      // AIåˆ†æç»“æœ
      const titleIcon = analysisType === 'policy' ? 'ğŸ’¡' : 'ğŸ¤–';
      const titleText = analysisType === 'policy' ? 'AIæ”¿ç­–å»ºè®®' : 'AIåˆ†æ';
      
      html += `
        <div class="section">
          <div class="section-title">${titleIcon} ${titleText}</div>
          <div class="ai-analysis-content">
            ${marked.parse(answer)}
          </div>
        </div>
      `;
      
      analysisContent.innerHTML = html;
      
      // æ˜¾ç¤ºå¯¼å‡ºæŒ‰é’®
      document.getElementById('btn-export-report').style.display = 'flex';
    }
    
    // å¯¼å‡ºAIæŠ¥å‘Šä¸ºPDF
    function exportAIReportPDF() {
      const analysisContent = document.getElementById('analysis-content');
      
      if (!analysisContent || analysisContent.textContent.includes('é€‰æ‹©ä¸Šæ–¹åŠŸèƒ½å¡ç‰‡å¼€å§‹åˆ†æ')) {
        showMessage('æš‚æ— åˆ†ææŠ¥å‘Šå¯å¯¼å‡º', 'warning');
        return;
      }
      
      try {
        // åˆ›å»ºä¸€ä¸ªæ–°çª—å£ç”¨äºæ‰“å°
        const printWindow = window.open('', '_blank');
        
        if (!printWindow) {
          showMessage('è¯·å…è®¸å¼¹å‡ºçª—å£ä»¥å¯¼å‡ºPDF', 'warning');
          return;
        }
        
        // ç”Ÿæˆæ‰“å°ç”¨çš„HTML
        const printHTML = `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AIåˆ†ææŠ¥å‘Š - ${new Date().toLocaleDateString('zh-CN')}</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    @page {
      size: A4;
      margin: 15mm;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'PingFang SC', 'Microsoft YaHei', sans-serif;
      color: #262626;
      line-height: 1.6;
      font-size: 12pt;
    }
    
    .container {
      max-width: 100%;
      margin: 0 auto;
    }
    
    .header {
      text-align: center;
      padding-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
      margin-bottom: 20px;
      page-break-after: avoid;
    }
    
    .header h1 {
      font-size: 24pt;
      color: #262626;
      margin-bottom: 10px;
      font-weight: 600;
    }
    
    .header .meta {
      color: #666;
      font-size: 10pt;
      margin-top: 8px;
    }
    
    .section {
      background: #ffffff;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 15px;
      page-break-inside: avoid;
    }
    
    .section-title {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
      font-size: 14pt;
      color: #262626;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e0e0e0;
      page-break-after: avoid;
    }
    
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-bottom: 10px;
    }
    
    .kpi-card {
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 10px;
      text-align: center;
    }
    
    .kpi-value {
      font-size: 18pt;
      font-weight: 700;
      color: #1890ff;
      margin-bottom: 4px;
    }
    
    .kpi-label {
      font-size: 9pt;
      color: #666;
    }
    
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 9pt;
      font-weight: 500;
    }
    
    .badge-danger {
      background: #fff2f0;
      color: #f5222d;
      border: 1px solid #ffccc7;
    }
    
    .badge-warn {
      background: #fffbe6;
      color: #faad14;
      border: 1px solid #ffe58f;
    }
    
    .badge-ok {
      background: #f6ffed;
      color: #52c41a;
      border: 1px solid #b7eb8f;
    }
    
    .list {
      display: grid;
      gap: 10px;
    }
    
    .list-item {
      display: grid;
      grid-template-columns: 80px 1fr;
      align-items: start;
      gap: 10px;
      padding: 10px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      background: #fafafa;
      page-break-inside: avoid;
    }
    
    .list-item .title {
      font-weight: 600;
      color: #262626;
      line-height: 1.4;
      font-size: 10pt;
    }
    
    .list-item .desc {
      color: #666;
      line-height: 1.6;
      font-size: 10pt;
    }
    
    .list-item .desc small {
      display: block;
      margin-top: 6px;
      font-size: 9pt;
      opacity: 0.8;
    }
    
    .ai-analysis-content {
      line-height: 1.8;
      color: #262626;
      font-size: 11pt;
    }
    
    .ai-analysis-content p {
      margin-bottom: 12px;
      line-height: 1.8;
    }
    
    .ai-analysis-content ul,
    .ai-analysis-content ol {
      margin: 12px 0;
      padding-left: 20px;
    }
    
    .ai-analysis-content li {
      margin-bottom: 8px;
      line-height: 1.6;
    }
    
    .ai-analysis-content h1,
    .ai-analysis-content h2,
    .ai-analysis-content h3 {
      margin-top: 16px;
      margin-bottom: 10px;
      line-height: 1.4;
      page-break-after: avoid;
    }
    
    .ai-analysis-content h1 { font-size: 16pt; }
    .ai-analysis-content h2 { font-size: 14pt; }
    .ai-analysis-content h3 { font-size: 12pt; }
    
    .ai-analysis-content strong {
      color: #262626;
      font-weight: 600;
    }
    
    .ai-analysis-content code {
      background: #f5f5f5;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      font-size: 10pt;
    }
    
    .ai-analysis-content blockquote {
      border-left: 3px solid #1890ff;
      padding-left: 12px;
      margin: 12px 0;
      color: #666;
      font-style: italic;
    }
    
    .footer {
      margin-top: 30px;
      padding-top: 15px;
      border-top: 1px solid #e0e0e0;
      text-align: center;
      color: #999;
      font-size: 9pt;
      page-break-inside: avoid;
    }
    
    @media print {
      body {
        background: white;
      }
      
      .no-print {
        display: none !important;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ’° ä¸šåŠ¡å‘˜å¥–é‡‘è®¡ç®—ç³»ç»Ÿ - AIåˆ†ææŠ¥å‘Š</h1>
      <div class="meta">
        <div>ç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}</div>
        <div style="margin-top: 4px;">è®¡ç®—æœˆä»½ï¼š${AppData.config.selectedMonth ? AppData.config.selectedMonth + 'æœˆ' : 'æœªé€‰æ‹©'}</div>
      </div>
    </div>
    
    ${analysisContent.innerHTML}
    
    <div class="footer">
      <p>æœ¬æŠ¥å‘Šç”± AI æ™ºèƒ½åˆ†æç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ</p>
      <p style="margin-top: 4px;">Â© 2025 ä¸šåŠ¡å‘˜å¥–é‡‘è®¡ç®—ç³»ç»Ÿ</p>
    </div>
  </div>
  
  <script>
    // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ‰“å¼€æ‰“å°å¯¹è¯æ¡†
    window.onload = function() {
      setTimeout(function() {
        window.print();
      }, 500);
    };
    
    // æ‰“å°åå…³é—­çª—å£ï¼ˆå¯é€‰ï¼‰
    window.onafterprint = function() {
      setTimeout(function() {
        window.close();
      }, 100);
    };
  <\/script>
</body>
</html>
`;
        
        // å†™å…¥HTMLåˆ°æ–°çª—å£
        printWindow.document.write(printHTML);
        printWindow.document.close();
        
        showMessage('æ­£åœ¨å‡†å¤‡PDFå¯¼å‡ºï¼Œè¯·åœ¨æ‰“å°å¯¹è¯æ¡†ä¸­é€‰æ‹©"å¦å­˜ä¸ºPDF"', 'info');
        
      } catch (error) {
        console.error('å¯¼å‡ºå¤±è´¥:', error);
        showMessage('å¯¼å‡ºå¤±è´¥ï¼š' + error.message, 'error');
      }
    }
    
    // è§£æAIå›å¤ï¼ˆæå–å…³é”®ä¿¡æ¯ï¼‰
    function parseAIResponse(text, context) {
      // ç®€å•çš„å…³é”®è¯æå–
      return {
        hasRisk: text.includes('é£é™©') || text.includes('è­¦å‘Š'),
        hasSuggestion: text.includes('å»ºè®®') || text.includes('ä¼˜åŒ–'),
        mentions: []
      };
    }
    
    // å‘é€æ¶ˆæ¯ï¼ˆç”¨æˆ·ç‚¹å‡»å‘é€æŒ‰é’®ï¼‰
    function sendMessage() {
      const input = document.getElementById('chat-input');
      const message = input.value.trim();
      
      if (!message) {
        showMessage('è¯·è¾“å…¥é—®é¢˜', 'warning');
        return;
      }
      
      input.value = '';
      sendAIMessage(message);
    }
    
    // å¿«é€Ÿæé—®
    function askQuickQuestion(question) {
      document.getElementById('chat-input').value = question;
      sendMessage();
    }
    
    // æ¸…ç©ºå¯¹è¯
    function clearChat() {
      if (!confirm('ç¡®å®šè¦æ¸…ç©ºå¯¹è¯å†å²å—ï¼Ÿ')) {
        return;
      }
      
      // åœæ­¢å½“å‰ç”Ÿæˆ
      if (AppData.ai.isStreaming) {
        stopAIStreaming();
      }
      
      AppData.ai.chatHistory = [];
      
      const messagesDiv = document.getElementById('chat-messages');
      messagesDiv.innerHTML = `
        <div class="message-bubble ai">
          <div class="message-avatar">ğŸ¤–</div>
          <div class="message-content">
            <p>å¯¹è¯å·²æ¸…ç©ºã€‚æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿ</p>
          </div>
        </div>
      `;
      
      document.getElementById('analysis-content').innerHTML = `
        <div style="color: var(--text-secondary); text-align: center; padding: 60px 20px;">
          <div style="font-size: 48px; margin-bottom: 16px;">ğŸ¯</div>
          <p>é€‰æ‹©ä¸Šæ–¹åŠŸèƒ½å¡ç‰‡å¼€å§‹åˆ†æ</p>
          <p style="font-size: 13px; margin-top: 8px;">æˆ–åœ¨å·¦ä¾§å¯¹è¯æ¡†ä¸­æé—®</p>
        </div>
      `;
      
      // éšè—å¯¼å‡ºæŒ‰é’®
      document.getElementById('btn-export-report').style.display = 'none';
      
      showMessage('å¯¹è¯å·²æ¸…ç©º', 'success');
    }

    // ==================== é”®ç›˜å¿«æ·é”® ====================
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        const currentPage = document.querySelector('.page:not(.hidden)');
        if (currentPage.id === 'manage-211-page') {
          save211Data();
        }
      }
      
      if (e.ctrlKey && e.key === 'e') {
        e.preventDefault();
        const currentPage = document.querySelector('.page:not(.hidden)');
        if (currentPage.id === 'monthly-page') {
          exportToExcel();
        } else if (currentPage.id === 'quarterly-page') {
          exportQuarterlyToExcel();
        }
      }
    });

    // ==================== é¡µé¢åˆå§‹åŒ– ====================
    document.addEventListener('DOMContentLoaded', function() {
      console.log('%cä¸šåŠ¡å‘˜å¥–é‡‘è®¡ç®—ç³»ç»Ÿ v2.0 AIå¢å¼ºç‰ˆ', 'color: #667eea; font-size: 16px; font-weight: bold;');
      console.log('âœ¨ æ–°å¢AIæ™ºèƒ½åˆ†æåŠŸèƒ½');
      console.log('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
      console.log('å¿«æ·é”®æç¤º:');
      console.log('  Ctrl+S: ä¿å­˜211æ•°æ®');
      console.log('  Ctrl+E: å¯¼å‡ºExcel');
      console.log('  Enter: å‘é€AIæ¶ˆæ¯');
      
      // åˆå§‹åŒ–markedï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      if (typeof marked !== 'undefined') {
        marked.setOptions({
          breaks: true,
          gfm: true
        });
      }
    });
  </script>
</body>
</html>

