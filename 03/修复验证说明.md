# 带单费问题修复验证说明

## 修复内容

### 修改位置
- **文件**: 六合一提成计算.html
- **行号**: 897
- **函数**: calculateSpecial()

### 修改前
```javascript
const leadFee = normalizeNumber(r["带单费"]) || 0;
```

### 修改后
```javascript
// 支持两个字段名：带单费 和 支付带单提成点位
const leadFee = normalizeNumber(r["带单费"]) || normalizeNumber(r["支付带单提成点位"]) || 0;
```

---

## 验证步骤

### 1. 重新计算数据

1. 打开 `六合一提成计算.html` 工具
2. 点击"清空数据"按钮
3. 上传原始数据文件
4. 按顺序执行6个模块：
   - ① 特价机
   - ② 壁挂炉
   - ③ 销售政策
   - ④ 烟灶
   - ⑤ 国补提成
   - ⑥ 折扣机
5. 导出新的结果文件

### 2. 核对关键订单

使用搜索功能查找以下订单，对比修复前后的差异：

#### A20251029003723 - 佳尼特带单费
**修复前**:
- 特价机提成: 679元
- 说明: (回款2,300.00 - 带单费0.00) - 特价1,621.00 = 679.00

**修复后应该是**:
- 特价机提成: 279元
- 说明: (回款2,300.00 - 带单费400.00) - 特价1,621.00 = 279.00

**差额**: -400元 ✅

---

#### A20251026007091 - 带单费
**修复前**:
- 特价机提成: 629元
- 说明: (回款2,250.00 - 带单费0.00) - 特价1,621.00 = 629.00

**修复后应该是**:
- 特价机提成: 229元
- 说明: (回款2,250.00 - 带单费400.00) - 特价1,621.00 = 229.00

**差额**: -400元 ✅

---

#### A20251019000697 - 带单费
**修复前**:
- 特价机提成: 650元
- 说明: (回款2,200.00 - 带单费0.00) - 特价1,550.00 = 650.00

**修复后应该是**:
- 特价机提成: 150元
- 说明: (回款2,200.00 - 带单费500.00) - 特价1,550.00 = 150.00

**差额**: -500元 ✅

---

#### A20251021005203 - 带单费没剪掉（百分比方案）
**当前数据**:
- 回款: 5,850元
- 带单费: 900元
- 方案: 85%
- 特价机提成: 4,229元

**需要核对**:
- 百分比方案的计算公式
- 是否应该扣除带单费

**预期修复后**:
- 如果扣除: (5,850 - 900) × 85% - 750 = 4,207.5 - 750 = 3,457.5元
- 差额: -771.5元

---

### 3. 使用Python工具验证

运行数据核对工具查看修复后的结果：

```bash
cd /Users/gndys/Documents/编程开发/开发中ind/A.O\ 史密斯定制/提成计算工具发布/03
python3 数据核对工具.py > 修复后核对报告.txt
```

对比修复前后的报告，重点检查：
- 带单费是否正确扣除
- 提成金额是否正确
- 说明文字是否显示带单费金额

---

## 预期影响

### 受影响订单
至少6个订单的特价机提成会减少：

| 订单编号 | 修复前 | 修复后 | 差额 |
|---------|-------|-------|------|
| A20251029003723 | 679 | 279 | -400 |
| A20251026007091 | 629 | 229 | -400 |
| A20251019000697 | 650 | 150 | -500 |
| A20251021005203 | 4,229 | ~3,458 | ~-771 |
| 其他... | ... | ... | ... |

### 总体影响
- 特价机提成总额预计减少: **约2,000-3,000元**
- 最终总提成相应减少

---

## 检查清单

- [ ] 代码已修改（行897）
- [ ] 清空旧数据
- [ ] 重新上传数据文件
- [ ] 执行所有6个计算模块
- [ ] 导出新的结果文件
- [ ] 搜索并核对 A20251029003723
- [ ] 搜索并核对 A20251026007091
- [ ] 搜索并核对 A20251019000697
- [ ] 搜索并核对 A20251021005203
- [ ] 查看日志中的带单费信息
- [ ] 对比修复前后的汇总数据
- [ ] 运行Python工具生成新报告

---

## 注意事项

1. **保存修复前的文件**
   - 建议先备份当前的计算结果
   - 以便对比验证

2. **检查说明文字**
   - 特价机提成说明应该显示实际扣除的带单费金额
   - 例如: "带单费400.00" 而不是 "带单费0.00"

3. **百分比方案特别注意**
   - A20251021005203 使用的是百分比方案
   - 需要确认百分比方案是否也应该扣除带单费
   - 当前代码中百分比方案会扣除: `baseAmount = paymentAmount - leadFee`

4. **其他可能受影响的订单**
   - 除了列出的6个订单外
   - 可能还有其他有带单费但未在问题清单中的订单
   - 建议全面对比修复前后的特价机提成数据

---

## 如果发现问题

如果修复后发现新的问题，请检查：

1. **字段名是否正确**
   - 确认数据中使用的是 "支付带单提成点位" 还是 "带单费"
   - 可以在浏览器控制台查看数据

2. **带单费值是否正确**
   - 检查原始数据中的带单费金额
   - 确认是否有负数或异常值

3. **计算逻辑是否正确**
   - 超底价方案: (回款 - 带单费) - 特价
   - 百分比方案: (回款 - 带单费) × 比例 - 固定值
   - 元/台方案: 数量 × 单价（不涉及带单费）

---

## 完成后

修复验证完成后，请：

1. 保存新的计算结果文件
2. 更新汇总数据
3. 通知相关人员提成金额的变化
4. 归档修复前后的对比报告

---

**修复完成时间**: 2025-11-19  
**修复人**: AI Assistant  
**验证人**: ___________  
**验证日期**: ___________
