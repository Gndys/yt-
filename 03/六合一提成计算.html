<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <title>A.O.å²å¯†æ–¯ä¸šåŠ¡å·¥å…·å¹³å°</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  
  <!-- ç»Ÿä¸€æ ·å¼æ–‡ä»¶ -->
  <link rel="stylesheet" href="styles.css">
  
  <!-- ç¬¬ä¸‰æ–¹åº“ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <!-- é¡µé¢ç‰¹å®šæ ·å¼ -->
  <style>
    /* é¡µé¢é¡¶éƒ¨æ ‡é¢˜åŒº */
    .page-header { 
      max-width:1600px; 
      margin:0 auto var(--space-lg); 
      background:linear-gradient(135deg, var(--accent-blue), var(--accent-blue-hover));
      border-radius:var(--radius-xl);
      padding:var(--space-xl);
      color:var(--text-white);
    }
    .page-header h1 { margin:0 0 8px; font-size:1.75rem; font-weight:600; }
    .page-header .subtitle { opacity:0.95; margin-bottom:16px; font-size:0.875rem; line-height:1.6; }
    
    /* é¡¶éƒ¨æ“ä½œæ  */
    .top-actions { display:flex; flex-wrap:wrap; gap:10px; margin-bottom:var(--space-lg); align-items:flex-start; }
    .top-actions button {
      background:rgba(255,255,255,0.2);
      color:var(--text-white);
      border:1px solid rgba(255,255,255,0.3);
      padding:10px 18px;
      font-size:0.875rem;
      border-radius:var(--radius-full);
      cursor:pointer;
      backdrop-filter:blur(8px);
      transition:all var(--transition-normal) var(--transition);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .top-actions button:hover:not(:disabled) { background:rgba(255,255,255,0.3); transform:translateY(-2px); }
    .top-actions button:disabled { opacity:0.5; cursor:not-allowed; transform:none; }
    .recalc-note { font-size:0.75rem; color:rgba(255,255,255,0.9); line-height:1.6; max-width:560px; }
    
    /* Shellå®¹å™¨ */
    .shell {
      background:var(--bg-card);
      border-radius:var(--radius-xl);
      box-shadow:var(--shadow-lg);
      padding:var(--space-xl);
      max-width:1600px;
      margin:0 auto var(--space-2xl);
    }
    .section-title { margin:var(--space-xl) 0 var(--space-md); font-size:1.25rem; display:flex; align-items:center; gap:var(--space-sm); font-weight:600; color:var(--text-primary); }
    .flex { display:flex; gap:var(--space-lg); flex-wrap:wrap; }
    /* æ–‡ä»¶ä¸Šä¼ åŒº */
    .uploader {
      border:2px dashed var(--border-medium);
      padding:var(--space-xl);
      border-radius:var(--radius-lg);
      background:var(--bg-primary);
      flex:1 1 340px;
      min-width:300px;
      position:relative;
      transition:all var(--transition-normal) var(--transition);
    }
    .uploader.drag { border-color:var(--accent-gold); background:var(--accent-gold-light); }
    .uploader input { display:none; }
    .uploader button {
      background:var(--accent-gold);
      color:var(--text-primary);
      border:none;
      padding:10px 20px;
      font-size:0.875rem;
      border-radius:var(--radius-md);
      cursor:pointer;
      font-weight:500;
      transition:all var(--transition-normal) var(--transition);
    }
    .uploader button:hover { background:var(--accent-gold-hover); transform:translateY(-2px); }
    .badge {
      display:inline-block;
      padding:3px 10px;
      font-size:0.75rem;
      background:var(--accent-blue-light);
      border:1px solid var(--accent-blue);
      border-radius:var(--radius-full);
      margin-left:6px;
      color:var(--accent-blue);
      font-weight:500;
    }
    .module-buttons {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(170px,1fr));
      gap:14px;
      margin-top:10px;
    }
    .module-buttons button {
      position:relative;
      border:1px solid #cbd5e1;
      background:#ffffff;
      border-radius:12px;
      padding:14px 16px 16px;
      text-align:left;
      cursor:pointer;
      transition:.18s;
      font-size:14px;
      line-height:1.3;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height:108px;
    }
    .module-buttons button:disabled { cursor:not-allowed; opacity:.55; background:#f1f5f9; }
    .module-buttons button:hover:not(:disabled) {
      transform:translateY(-3px);
      box-shadow:0 6px 18px rgba(0,0,0,.12);
      border-color:var(--primary);
    }
    .module-buttons button.done { border-color:var(--ok); background:#f0fdf4; }
    .module-buttons button.done .status-dot { background:var(--ok); }
    .module-buttons button.running { border-color:var(--primary); background:#eff6ff; }
    .module-buttons button.running .status-dot {
      background:var(--primary);
      animation:pulse 1s linear infinite;
    }
    .status-dot {
      width:12px;
      height:12px;
      border-radius:50%;
      background:#94a3b8;
      box-shadow:0 0 0 2px #fff;
    }
    @keyframes pulse {
      0% { transform:scale(.85); opacity:.6; }
      50% { transform:scale(1); opacity:1; }
      100% { transform:scale(.85); opacity:.6; }
    }
    .module-head { display:flex; align-items:center; gap:10px; }
    .mod-name { font-weight:600; font-size:15px; }
    .mod-desc { font-size:11px; color:var(--muted); line-height:1.4; flex:1; }
    .mod-action { margin-top:auto; display:flex; gap:6px; align-items:center; font-size:12px; font-weight:500; color:var(--primary); }
    .log-panel {
      border:1px solid var(--border);
      background:#fff;
      border-radius:12px;
      padding:14px 18px 20px;
      max-height:300px;
      overflow:auto;
      font-size:12px;
      line-height:1.5;
      white-space:pre-wrap;
    }
    .log-panel b { color:#111827; }
    .log-entry { margin-bottom:4px; }
    .log-entry.warn { color:var(--warn); }
    .log-entry.error { color:var(--danger); }
    .log-entry.ok { color:var(--ok); }
    .table-wrap {
      margin-top:30px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
    }
    .table-head-tools {
      background:#f1f5f9;
      padding:10px 14px;
      display:flex;
      gap:14px;
      align-items:center;
      flex-wrap:wrap;
    }
    .table-head-tools select, .table-head-tools input {
      padding:6px 10px;
      border:1px solid #cbd5e1;
      border-radius:8px;
      font-size:12px;
    }
    .table-head-tools button.small {
      padding:6px 12px;
      font-size:12px;
      border-radius:8px;
      border:1px solid var(--primary);
      background:#fff;
      cursor:pointer;
      color:var(--primary);
    }
    .table-head-tools button.small:hover { background:var(--primary); color:#fff; }
    table {
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      font-size:12px;
    }
    thead { background:#1e293b; color:#fff; }
    th,td {
      padding:6px 8px;
      border-bottom:1px solid #e2e8f0;
      text-align:left;
      vertical-align:top;
    }
    th.sticky { position:sticky; top:0; z-index:2; }
    tbody tr:nth-child(even) { background:#f8fafc; }
    tbody tr.return-row { background:#fff1f2 !important; }
    tbody tr:hover { background:#eef2ff; }
    .cell-warn { background:#fef9c3; }
    .cell-high { background:#e0f2fe; }
    .footer-bar {
      margin-top:40px;
      display:flex;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:16px;
      align-items:center;
    }
    .export-btn {
      background:linear-gradient(90deg,#2563eb,#4f46e5);
      color:#fff;
      padding:12px 24px;
      border:none;
      border-radius:30px;
      font-size:14px;
      font-weight:500;
      cursor:pointer;
      box-shadow:0 6px 18px -4px rgba(79,70,229,.45);
    }
    .export-btn:disabled { opacity:.5; cursor:not-allowed; background:#94a3b8; box-shadow:none; }
    .export-btn:hover:not(:disabled) { transform:translateY(-2px); }
    .stats { font-size:12px; color:var(--muted); }
    .pill {
      display:inline-block;
      background:#eef2ff;
      padding:2px 8px;
      border-radius:14px;
      font-size:11px;
      margin-right:6px;
      margin-bottom:4px;
      color:#3949ab;
    }
    .grid-col-select { max-width:240px; }
    .hint { font-size:12px; color:var(--muted); margin-top:4px; }
    .lock-icon { font-size:18px; opacity:.5; }
    .preproc-detect { font-size:12px; margin-top:10px; line-height:1.5; }
    .preproc-detect.ok { color:var(--ok); }
    .preproc-detect.warn { color:var(--warn); }
    .flash-updated { animation:flashUpdated 1.2s ease-in-out 1; }
    @keyframes flashUpdated {
      0% { background:#fff3cd; }
      60% { background:#ffffff; }
      100% { background:inherit; }
    }
    @media (max-width:900px){
      .module-buttons { grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); }
      th,td { padding:5px 6px; }
      .shell { padding:20px 18px 34px; }
    }
  </style>
</head>
<body>
  <!-- é¡µé¢å¤´éƒ¨ -->
  <div class="page-header">
    <!-- è¿”å›å¯¼èˆª -->
    <a href="../index.html" class="back-nav">â† è¿”å›é¦–é¡µ</a>
    
    <h1>ç¬¬ä¸‰æ¨¡å—è®¡ç®—å·¥å…·</h1>
    <div class="subtitle">æ”¯æŒä¸Šä¼  / åˆ†æ­¥è®¡ç®— / activity_package è·³è¿‡ / å–å‡ºæŠ˜æ‰£é‡ç®— / é”€å”®æ”¿ç­–æ¡£ä½ç®€åŒ– / å›½è¡¥ææˆ(9.15-10.8)</div>
    
    <div class="top-actions">
      <button id="btnRecalcActual" disabled title="(å›æ¬¾æ”¶æ¬¾é‡‘é¢ - æ”¯ä»˜å¸¦å•ææˆç‚¹ä½) Ã· é”€å”®æ•°é‡ Ã· ç³»ç»Ÿå®šä»·">
        ğŸ”„ è®¡ç®—å–å‡ºçš„å®é™…æŠ˜æ‰£
      </button>
      <div class="recalc-note">
        é”€å”®æ”¿ç­–è§„åˆ™å·²ç²¾ç®€ï¼š70% / 75% æ¡£ä»…æ»¡æ¡£ç»™ 4.5% ææˆï¼›æœªè¾¾æ¡£ 0ã€‚<br/>
        å–å‡ºçš„å®é™…æŠ˜æ‰£è®¡ç®—å…¬å¼ï¼š (å›æ¬¾æ”¶æ¬¾é‡‘é¢ - æ”¯ä»˜å¸¦å•ææˆç‚¹ä½) / é”€å”®æ•°é‡ / ç³»ç»Ÿå®šä»· ï¼ˆä¿ç•™4ä½ï¼‰ã€‚<br/>
        å¦‚å·²è®¡ç®—ææˆå†é‡ç®—æŠ˜æ‰£ï¼Œä¸ä¼šå›æº¯ï¼Œè¯·è§†æƒ…å†µé‡ç½®ã€‚
      </div>
    </div>
  </div>

  <div class="shell">
    <div class="flex">
      <div class="uploader" id="uploader">
        <h3 style="margin:0 0 10px;font-size:16px;">æ•°æ®ä¸Šä¼ </h3>
        <p style="font-size:12px;line-height:1.5;color:var(--muted);">
          é€‰æ‹© Excel(.xlsx) æˆ– CSV æ–‡ä»¶ã€‚é»˜è®¤è¯»å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨ã€‚<br>
          ä¸Šä¼ åè‡ªåŠ¨è§£æå¹¶æ ‡å‡†åŒ–å­—æ®µï¼Œå¹¶æ£€æµ‹ activity_package é¢„å¤„ç†æ ‡è®°ã€‚
        </p>
        <div style="margin:12px 0 16px;">
          <button id="pickFileBtn">é€‰æ‹©æ–‡ä»¶</button>
          <input type="file" id="fileInput" accept=".xlsx,.xls,.csv"/>
          <span id="fileName" style="font-size:12px;margin-left:10px;color:var(--muted);"></span>
        </div>
        <div id="preprocessHint" class="preproc-detect"></div>
        <div style="font-size:11px;color:#475569;">
          å¦‚æ— ååº”ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°æ˜¯å¦æœ‰ XLSX åº“åŠ è½½å¤±è´¥ã€‚
        </div>
      </div>

      <div style="flex:2 1 460px;min-width:340px;">
        <h3 class="section-title">æ­¥éª¤æ§åˆ¶ <span class="badge">ç‚¹å‡»é¡ºåºæ‰§è¡Œ</span></h3>
        <div class="module-buttons">
          <button id="btnSpecial" data-module="special" disabled>
            <div class="module-head">
              <div class="status-dot" id="dot-special"></div>
              <div class="mod-name">â‘  ç‰¹ä»·æœº</div>
            </div>
            <div class="mod-desc">ç‰¹ä»·æœºå…ƒ/å° / % / è¶…åº•ä»·ï¼›æ”¯æŒ activity_package è·³è¿‡ã€‚</div>
            <div class="mod-action">æ‰§è¡Œè®¡ç®— â†’</div>
          </button>
          <button id="btnBoiler" data-module="boiler" disabled>
            <div class="module-head">
              <div class="status-dot" id="dot-boiler"></div>
              <div class="mod-name">â‘¡ å£æŒ‚ç‚‰</div>
            </div>
            <div class="mod-desc">æŒ‰ 80% / 78% é”€å”®æŠ˜æ‰£è§„åˆ™é˜¶æ¢¯ææˆã€‚</div>
            <div class="mod-action">æ‰§è¡Œè®¡ç®— â†’</div>
          </button>
          <button id="btnActivity" data-module="activity" disabled>
            <div class="module-head">
              <div class="status-dot" id="dot-activity"></div>
              <div class="mod-name">â‘¢ é”€å”®æ”¿ç­–</div>
            </div>
            <div class="mod-desc">ç²¾ç®€ï¼šæ¡£ä½=70%æˆ–75%ï¼Œå®é™…æŠ˜æ‰£è¾¾æ¡£â†’4.5%ï¼Œæœªè¾¾â†’0ã€‚</div>
            <div class="mod-action">æ‰§è¡Œè®¡ç®— â†’</div>
          </button>
          <button id="btnSmoke" data-module="smoke" disabled>
            <div class="module-head">
              <div class="status-dot" id="dot-smoke"></div>
              <div class="mod-name">â‘£ çƒŸç¶</div>
            </div>
            <div class="mod-desc">æŒ‰å¤§ç±»é˜ˆå€¼ç»™ 10% ææˆã€‚</div>
            <div class="mod-action">æ‰§è¡Œè®¡ç®— â†’</div>
          </button>
          <button id="btnNationalSubsidy" data-module="nationalSubsidy" disabled>
            <div class="module-head">
              <div class="status-dot" id="dot-nationalSubsidy"></div>
              <div class="mod-name">â‘¤ å›½è¡¥ææˆ</div>
            </div>
            <div class="mod-desc">9.15-10.8æœŸé—´ ä¸”å‰å››æ¨¡å—ä¸º0 ä¸”è®¢å•ç±»å‹=éå›½è¡¥ ä¸” 0.705<æŠ˜æ‰£<0.750ã€‚</div>
            <div class="mod-action">æ‰§è¡Œè®¡ç®— â†’</div>
          </button>
          <button id="btnDiscount" data-module="discount" disabled>
            <div class="module-head">
              <div class="status-dot" id="dot-discount"></div>
              <div class="mod-name">â‘¥ æŠ˜æ‰£æœº <span class="lock-icon">ğŸ”’</span></div>
            </div>
            <div class="mod-desc">å‰äº”æ¨¡å—å‡ä¸º0 ä¸” 0.755<æŠ˜æ‰£<0.80 æ—¶è®¡ç®—ã€‚</div>
            <div class="mod-action">æ‰§è¡Œè®¡ç®— â†’</div>
          </button>
        </div>
        <div class="hint" id="unlockHint">æŠ˜æ‰£æœºææˆå°šæœªè§£é”ï¼šè¯·å…ˆé¡ºåºå®Œæˆå‰äº”ä¸ªæ¨¡å—ã€‚</div>
      </div>
    </div>

    <h3 class="section-title">æ—¥å¿—è¾“å‡º / è¿›åº¦</h3>
    <div class="log-panel" id="logPanel" aria-live="polite"></div>

    <div class="table-wrap" id="tableWrap" style="display:none;">
      <div class="table-head-tools">
        <label style="font-size:12px;">
          æœç´¢ï¼š
          <input type="text" id="searchInput" placeholder="æŒ‰å•å· / å‹å· / åº—å" />
        </label>
        <label style="font-size:12px;">
          æ˜¾ç¤ºåˆ—ï¼š
          <select id="columnPreset" class="grid-col-select">
            <option value="basic">åŸºç¡€ + åˆ†ç±»</option>
            <option value="price">ä»·æ ¼æŠ˜æ‰£</option>
            <option value="commission">å…¨éƒ¨ææˆ</option>
            <option value="final">æœ€ç»ˆæ±‡æ€»</option>
            <option value="all">å…¨éƒ¨å­—æ®µ</option>
          </select>
        </label>
        <button class="small" id="refreshBtn">åˆ·æ–°æ˜¾ç¤º</button>
          <button class="small" id="resetBtn">æ¸…ç©ºæ•°æ®</button>
        <span style="font-size:11px;color:var(--muted);" id="rowCountLabel"></span>
      </div>
      <div style="width:100%;overflow:auto;max-height:520px;">
        <table id="dataTable">
          <thead id="tableHead"></thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

    <div class="footer-bar">
      <div>
        <div class="stats" id="statsInfo">å°šæœªä¸Šä¼ æ•°æ®ã€‚</div>
        <div id="pillArea" style="margin-top:6px;"></div>
      </div>
      <button class="export-btn" id="exportBtn" disabled>å¯¼å‡º Excel</button>
    </div>
  </div>

  <script>
    const state = {
      rawRows: [],
      rows: [],
      logs: [],
      mapping: {},
      modulesDone: {
        special:false,
        boiler:false,
        activity:false,
        smoke:false,
        nationalSubsidy:false,
        discount:false
      },
      running: null,
      // æ›´æ–°ç‰ˆæœ¬å·ï¼šæ·»åŠ å›½è¡¥ææˆæ¨¡å—
      ruleVersion: "2025.10.24.v6+national_subsidy",
      baseFields: {},
      lastRenderColumns: [],
      hasCalcStatusField:false,
      hasPriorityField:false
    };

    const FIELD_MAP = {
      "æ—¥æœŸ":"æ—¥æœŸ",
      "å•æ®ç¼–å·":"å•æ®ç¼–å·",
      "ç”¨æˆ·å§“å":"ç”¨æˆ·å§“å",
      "è§„æ ¼å‹å·":"è§„æ ¼å‹å·",
      "é”€å”®æ•°é‡":"é”€å”®æ•°é‡",
      "ä»·ç¨åˆè®¡":"ä»·ç¨åˆè®¡",
      "ç³»ç»Ÿå®šä»·":"ç³»ç»Ÿå®šä»·",
      "ç‰©æ–™åç§°":"ç‰©æ–™åç§°",
      "ç‰©æ–™ç±»åˆ«":"ç‰©æ–™ç±»åˆ«",
      "ä¿ƒé”€å‘˜":"ä¿ƒé”€å‘˜",
      "å®¢æˆ·åº—å":"å®¢æˆ·åº—å",
      "å•æ®ç±»å‹":"å•æ®ç±»å‹",
      "è®¢å•ç±»å‹":"è®¢å•ç±»å‹",
      "å›æ¬¾æ”¶æ¬¾é‡‘é¢":"å›æ¬¾æ”¶æ¬¾é‡‘é¢",
      "æ”¯ä»˜å¸¦å•ææˆç‚¹ä½":"æ”¯ä»˜å¸¦å•ææˆç‚¹ä½",
      "å–å‡ºçš„å®é™…æŠ˜æ‰£":"å–å‡ºçš„å®é™…æŠ˜æ‰£",
      "ä½³å°¼ç‰¹ç‰¹ä»·":"ä½³å°¼ç‰¹ç‰¹ä»·",
      "å£æŒ‚ç‚‰é”€å”®æŠ˜æ‰£":"å£æŒ‚ç‚‰é”€å”®æŠ˜æ‰£",
      "å£æŒ‚ç‚‰ææˆ":"å£æŒ‚ç‚‰ææˆåŸå§‹",
      "ç‰¹ä»·æœºææˆè®¡ç®—æ–¹æ¡ˆ":"ç‰¹ä»·æœºææˆè®¡ç®—æ–¹æ¡ˆ",
      "ç‰¹ä»·æœºå…¬å¸æœ€ä½æŠ˜æ‰£":"ç‰¹ä»·æœºå…¬å¸æœ€ä½æŠ˜æ‰£",
      "é”€å”®æ”¿ç­–æŠ˜æ‰£ç‡":"é”€å”®æ”¿ç­–æŠ˜æ‰£ç‡",
      "é”€å”®æ”¿ç­–ææˆåŸå§‹":"é”€å”®æ”¿ç­–ææˆåŸå§‹",
      "é”€å”®æ”¿ç­–ææˆ":"é”€å”®æ”¿ç­–ææˆ",
      "é”€å”®æ”¿ç­–åŠ æåŸå§‹":"é”€å”®æ”¿ç­–åŠ æåŸå§‹",
      "é”€å”®æ”¿ç­–åŠ æ":"é”€å”®æ”¿ç­–åŠ æ",
      "é”€å”®æ”¿ç­–è¦æ±‚":"é”€å”®æ”¿ç­–è¦æ±‚",
      // å‘åå…¼å®¹æ—§å­—æ®µå
      "ä¸ƒæœˆéƒ¨åˆ†æ´»åŠ¨æŠ˜æ‰£ç‡":"é”€å”®æ”¿ç­–æŠ˜æ‰£ç‡",
      "ä¸ƒæœˆéƒ¨åˆ†æ´»åŠ¨ææˆ":"é”€å”®æ”¿ç­–ææˆ",
      "ä¸ƒæœˆéƒ¨åˆ†æ´»åŠ¨åŠ æ":"é”€å”®æ”¿ç­–åŠ æåŸå§‹",
      "ä¸ƒæœˆéƒ¨åˆ†æ´»åŠ¨æ´»åŠ¨è¦æ±‚":"é”€å”®æ”¿ç­–è¦æ±‚",
      "å¤§ç±»å‹":"å¤§ç±»å‹",
      "æœºå‹":"æœºå‹",
      "ææˆè®¡ç®—çŠ¶æ€":"ææˆè®¡ç®—çŠ¶æ€",
      "è®¡ç®—ä¼˜å…ˆçº§":"è®¡ç®—ä¼˜å…ˆçº§"
    };

    const COLUMN_PRESETS = {
      basic: ["æ—¥æœŸ","å•æ®ç¼–å·","è§„æ ¼å‹å·","ä¿ƒé”€å‘˜","å®¢æˆ·åº—å","å¤§ç±»å‹","æœºå‹","é”€å”®æ•°é‡","è®¢å•ç±»å‹","ææˆè®¡ç®—çŠ¶æ€","è®¡ç®—ä¼˜å…ˆçº§"],
      price: ["æ—¥æœŸ","å•æ®ç¼–å·","è§„æ ¼å‹å·","ç³»ç»Ÿå®šä»·","ä»·ç¨åˆè®¡","æœ€ç»ˆæŠ˜æ‰£ç‡","å–å‡ºçš„å®é™…æŠ˜æ‰£"],
      commission: [
        "å•æ®ç¼–å·","è§„æ ¼å‹å·",
        "ç‰¹ä»·æœºææˆ","ç‰¹ä»·æœºææˆè¯´æ˜","ç‰¹ä»·æœºææˆè®¡ç®—æ–¹æ¡ˆ",
        "å£æŒ‚ç‚‰ææˆåŸå§‹","å£æŒ‚ç‚‰ææˆ","å£æŒ‚ç‚‰ææˆè¯´æ˜",
        "é”€å”®æ”¿ç­–ææˆåŸå§‹","é”€å”®æ”¿ç­–ææˆ","é”€å”®æ”¿ç­–ææˆè¯´æ˜",
        "é”€å”®æ”¿ç­–åŠ æ","é”€å”®æ”¿ç­–åŠ æè¯´æ˜",
        "çƒŸç¶ææˆ","çƒŸç¶ææˆè¯´æ˜",
        "å›½è¡¥ææˆ","å›½è¡¥ææˆè¯´æ˜",
        "æŠ˜æ‰£æœºææˆ","æŠ˜æ‰£æœºææˆè¯´æ˜",
        "æŠ˜æ‰£å‰å°è®¡","æŠ˜æ‰£å‰å°è®¡è¯´æ˜",
        "æœ€ç»ˆæ€»ææˆ","æœ€ç»ˆæ€»ææˆè¯´æ˜",
        "å¸¸è§„æœºè¯´æ˜",
        "ææˆè®¡ç®—çŠ¶æ€"
      ],
      final: ["æ—¥æœŸ","å•æ®ç¼–å·","è§„æ ¼å‹å·","å¤§ç±»å‹","é”€å”®æ•°é‡","æœ€ç»ˆæŠ˜æ‰£ç‡","æœ€ç»ˆæ€»ææˆ","å¸¸è§„æœºè¯´æ˜","ææˆè®¡ç®—çŠ¶æ€"],
      all: "ALL"
    };

    const COL_LABELS = {
      "æ—¥æœŸ":"æ—¥æœŸ",
      "å•æ®ç¼–å·":"å•æ®ç¼–å·",
      "ç”¨æˆ·å§“å":"ç”¨æˆ·å§“å",
      "è§„æ ¼å‹å·":"è§„æ ¼å‹å·",
      "ä¿ƒé”€å‘˜":"ä¿ƒé”€å‘˜",
      "å®¢æˆ·åº—å":"å®¢æˆ·åº—å",
      "å¤§ç±»å‹":"å¤§ç±»å‹",
      "æœºå‹":"æœºå‹",
      "é”€å”®æ•°é‡":"é”€å”®æ•°é‡",
      "ç³»ç»Ÿå®šä»·":"ç³»ç»Ÿå®šä»·",
      "ä»·ç¨åˆè®¡":"ä»·ç¨åˆè®¡",
      "å›æ¬¾æ”¶æ¬¾é‡‘é¢":"å›æ¬¾æ”¶æ¬¾é‡‘é¢",
      "å•æ®ç±»å‹":"å•æ®ç±»å‹",
      "è®¢å•ç±»å‹":"è®¢å•ç±»å‹",
      "ç‰©æ–™åç§°":"ç‰©æ–™åç§°",
      "ç‰©æ–™ç±»åˆ«":"ç‰©æ–™ç±»åˆ«",
      "æ”¯ä»˜å¸¦å•ææˆç‚¹ä½":"æ”¯ä»˜å¸¦å•ææˆç‚¹ä½",
      "æœ€ç»ˆæŠ˜æ‰£ç‡":"æœ€ç»ˆæŠ˜æ‰£ç‡",
      "å–å‡ºçš„å®é™…æŠ˜æ‰£":"å–å‡ºçš„å®é™…æŠ˜æ‰£",
      "ä½³å°¼ç‰¹ç‰¹ä»·":"ä½³å°¼ç‰¹ç‰¹ä»·",
      "ç‰¹ä»·æœºå…¬å¸æœ€ä½æŠ˜æ‰£":"ç‰¹ä»·æœºå…¬å¸æœ€ä½æŠ˜æ‰£",
      "å£æŒ‚ç‚‰é”€å”®æŠ˜æ‰£":"å£æŒ‚ç‚‰é”€å”®æŠ˜æ‰£",
      "å£æŒ‚ç‚‰ææˆåŸå§‹":"å£æŒ‚ç‚‰ææˆ(æ¥æº)",
      "å£æŒ‚ç‚‰ææˆ":"å£æŒ‚ç‚‰ææˆ(è®¡ç®—)",
      "å£æŒ‚ç‚‰ææˆè¯´æ˜":"å£æŒ‚ç‚‰ææˆè¯´æ˜",
      "ç‰¹ä»·æœºææˆè®¡ç®—æ–¹æ¡ˆ":"ç‰¹ä»·æœºææˆè®¡ç®—æ–¹æ¡ˆ(æ¥æº)",
      "ç‰¹ä»·æœºææˆè¯´æ˜":"ç‰¹ä»·æœºææˆè¯´æ˜",
      "ç‰¹ä»·æœºææˆ":"ç‰¹ä»·æœºææˆ",
      "é”€å”®æ”¿ç­–æŠ˜æ‰£ç‡":"é”€å”®æ”¿ç­–æŠ˜æ‰£ç‡",
      "é”€å”®æ”¿ç­–ææˆåŸå§‹":"é”€å”®æ”¿ç­–ææˆ(æ¥æº)",
      "é”€å”®æ”¿ç­–ææˆ":"é”€å”®æ”¿ç­–ææˆ",
      "é”€å”®æ”¿ç­–åŠ æåŸå§‹":"é”€å”®æ”¿ç­–åŠ æ(æ¥æº)",
      "é”€å”®æ”¿ç­–åŠ æ":"é”€å”®æ”¿ç­–åŠ æ",
      "é”€å”®æ”¿ç­–è¦æ±‚":"é”€å”®æ”¿ç­–è¦æ±‚",
      "é”€å”®æ”¿ç­–ææˆè¯´æ˜":"é”€å”®æ”¿ç­–ææˆè¯´æ˜",
      "é”€å”®æ”¿ç­–åŠ æè¯´æ˜":"é”€å”®æ”¿ç­–åŠ æè¯´æ˜",
      "çƒŸç¶ææˆ":"çƒŸç¶ææˆ",
      "çƒŸç¶ææˆè¯´æ˜":"çƒŸç¶ææˆè¯´æ˜",
      "å›½è¡¥ææˆ":"å›½è¡¥ææˆ",
      "å›½è¡¥ææˆè¯´æ˜":"å›½è¡¥ææˆè¯´æ˜",
      "æŠ˜æ‰£æœºææˆ":"æŠ˜æ‰£æœºææˆ",
      "æŠ˜æ‰£æœºææˆè¯´æ˜":"æŠ˜æ‰£æœºææˆè¯´æ˜",
      "æŠ˜æ‰£å‰å°è®¡":"æŠ˜æ‰£å‰å°è®¡",
      "æŠ˜æ‰£å‰å°è®¡è¯´æ˜":"æŠ˜æ‰£å‰å°è®¡è¯´æ˜",
      "æœ€ç»ˆæ€»ææˆ":"æœ€ç»ˆæ€»ææˆ",
      "æœ€ç»ˆæ€»ææˆè¯´æ˜":"æœ€ç»ˆæ€»ææˆè¯´æ˜",
      "å¸¸è§„æœºè¯´æ˜":"å¸¸è§„æœºè¯´æ˜",
      "æ˜¯å¦é€€è´§":"æ˜¯å¦é€€è´§",
      "ææˆè®¡ç®—çŠ¶æ€":"ææˆè®¡ç®—çŠ¶æ€",
      "è®¡ç®—ä¼˜å…ˆçº§":"è®¡ç®—ä¼˜å…ˆçº§"
    };
    function getColLabel(col){ return COL_LABELS[col] || col; }

    function log(msg, level="info"){
      const time = new Date().toLocaleTimeString();
      state.logs.push({time,msg,level});
      const panel = document.getElementById("logPanel");
      if(!panel) return;
      const div = document.createElement("div");
      div.className = `log-entry ${level === "warn" ? "warn": level === "error" ? "error" : level==="ok"?"ok":""}`;
      div.textContent = `[${time}] ${msg}`;
      panel.appendChild(div);
      panel.scrollTop = panel.scrollHeight;
    }
    function normalizeNumber(v){
      if (v===null || v===undefined || v==="") return null;
      if (typeof v === "number") return v;
      const x = parseFloat(String(v).replace(/,/g,"").trim());
      return isNaN(x)? null : x;
    }
    function normalizeString(v){
      if (v===null || v===undefined) return "";
      return String(v).trim();
    }
    function fmtCurrency(n){
      const v = normalizeNumber(n);
      if (v===null) return "ç©º";
      return v.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
    }
    function fmtPercent(r){
      const v = normalizeNumber(r);
      if (v===null) return "ç©º";
      return (v*100).toFixed(2) + "%";
    }
    function deriveFinalDiscount(row){
      const amt = normalizeNumber(row["ä»·ç¨åˆè®¡"]);
      const list = normalizeNumber(row["ç³»ç»Ÿå®šä»·"]);
      if (list && list>0 && amt!=null) {
        const r = amt/list;
        row["æœ€ç»ˆæŠ˜æ‰£ç‡"] = parseFloat(r.toFixed(4));
      } else {
        row["æœ€ç»ˆæŠ˜æ‰£ç‡"] = null;
      }
    }
    function parseOrderDate(row){
      const raw = normalizeString(row["æ—¥æœŸ"]);
      if (!raw) return null;
      const numericValue = Number(raw);
      if (!isNaN(numericValue) && raw === String(numericValue)){
        const excelDate = new Date(Math.round((numericValue - 25569) * 86400000));
        if (!isNaN(excelDate.getTime())) return excelDate;
      }
      const normalized = raw.replace(/[.]/g,"/").replace(/-/g,"/");
      const date = new Date(normalized);
      return isNaN(date.getTime()) ? null : date;
    }
    function determineRegion(row){
      let region = normalizeString(row["æ‰€å±åœ°åŒº"] || row["åœ°åŒº"]);
      if (region.includes("æ­å·")) region = "æ­å·";
      else if (region.includes("é‡‘å")) region = "é‡‘å";
      if (!region){
        const store = normalizeString(row["å®¢æˆ·åº—å"] || row["å®¢æˆ·"]);
        if (store.includes("æ­å·")) region = "æ­å·";
        else if (store.includes("é‡‘å")) region = "é‡‘å";
      }
      return region;
    }
    function getOilHoodThreshold(date){
      const result = { threshold: 0.7, note: "" };
      if (!date) return result;
      const year = date.getFullYear();
      const start = new Date(year, 9, 24);
      const end = new Date(year, 11, 31, 23, 59, 59, 999);
      if (date >= start && date <= end){
        return { threshold: 0.65, note: "ï¼ˆ10.24-12.31ç‰¹æƒ ï¼‰" };
      }
      return result;
    }
    function normalizeEnergyCode(label){
      let str = normalizeString(label);
      if (!str) return "";
      str = str.replace(/èƒ½æ•ˆ|çº§/g,"");
      const match = str.match(/\d+/);
      if (match) return match[0];
      const map = {"ä¸€":"1","äºŒ":"2","ä¸‰":"3","â… ":"1","â…¡":"2","â…¢":"3"};
      return map[str] || str;
    }
    function getDiscountRule(region, energyCode){
      if (region === "æ­å·"){
        if (energyCode === "1"){
          return {min:0.728, max:0.773, base:0.728, desc:"æ­å·Â·èƒ½æ•ˆæ ‡è¯†=1", label:"èƒ½æ•ˆæ ‡è¯†=1"};
        }
        if (energyCode === "2"){
          return {min:0.731, max:0.776, base:0.731, desc:"æ­å·Â·èƒ½æ•ˆæ ‡è¯†=2", label:"èƒ½æ•ˆæ ‡è¯†=2"};
        }
        return {min:0.755, max:0.80, base:0.755, desc:"æ­å·Â·å…¶ä»–èƒ½æ•ˆæ ‡è¯†", label:"å…¶ä»–èƒ½æ•ˆæ ‡è¯†"};
      }
      if (region === "é‡‘å"){
        return {min:0.72, max:0.765, base:0.72, desc:"é‡‘ååœ°åŒº", label:"é‡‘ååŒºåŸŸèŒƒå›´"};
      }
      return null;
    }
    function markReturn(row){
      const q = normalizeNumber(row["é”€å”®æ•°é‡"]);
      const t = normalizeString(row["å•æ®ç±»å‹"]);
      row["æ˜¯å¦é€€è´§"] = false;
      if (q < 0) row["æ˜¯å¦é€€è´§"] = true;
      else if (t.includes("é€€è´§")) row["æ˜¯å¦é€€è´§"] = true;
    }
    function ensureNumeric(val){
      if(val===null || val===undefined || val==="") return 0;
      return +val || 0;
    }

    function afterModuleCheckUnlock(){
      const primaryAll = state.modulesDone.special && state.modulesDone.boiler &&
                         state.modulesDone.activity && state.modulesDone.smoke &&
                         state.modulesDone.nationalSubsidy;
      const btnDiscount = document.getElementById("btnDiscount");
      if (primaryAll){
        btnDiscount.disabled = false;
          document.getElementById("unlockHint").textContent = "æŠ˜æ‰£æœºææˆå·²è§£é”ï¼šå¯æ‰§è¡Œæ­¥éª¤â‘¥ã€‚";
        document.querySelector("#btnDiscount .lock-icon")?.remove();
        log("æŠ˜æ‰£æœºææˆæ¨¡å—å·²è§£é”ã€‚","ok");
      }
    }
    function updateModuleButtonStyle(module, status){
      const btn = {
        special:document.getElementById("btnSpecial"),
        boiler:document.getElementById("btnBoiler"),
        activity:document.getElementById("btnActivity"),
        smoke:document.getElementById("btnSmoke"),
        nationalSubsidy:document.getElementById("btnNationalSubsidy"),
        discount:document.getElementById("btnDiscount"),
      }[module];
      const dot = document.getElementById(`dot-${module}`);
      if(!btn || !dot) return;
      btn.classList.remove("done","running");
      if (status==="running"){
        btn.classList.add("running");
        dot.style.background = "var(--primary)";
      } else if (status==="done"){
        btn.classList.add("done");
        dot.style.background = "var(--ok)";
      } else {
        dot.style.background = "#94a3b8";
      }
    }

    function refreshStats(){
      const statsInfo = document.getElementById("statsInfo");
      function flag(b){return b?"âœ”":"â€¦";}
      statsInfo.textContent = `å½“å‰æ•°æ®è¡Œï¼š${state.rows.length}ï¼›æ¨¡å—è¿›åº¦ï¼šç‰¹ä»·(${flag(state.modulesDone.special)}) å£æŒ‚ç‚‰(${flag(state.modulesDone.boiler)}) æ´»åŠ¨(${flag(state.modulesDone.activity)}) çƒŸç¶(${flag(state.modulesDone.smoke)}) å›½è¡¥(${flag(state.modulesDone.nationalSubsidy)}) æŠ˜æ‰£(${flag(state.modulesDone.discount)})`;
      renderPills();
    }
    function renderPills(){
      const area = document.getElementById("pillArea");
      area.innerHTML = "";
      Object.entries(state.modulesDone).forEach(([k,v])=>{
        const span = document.createElement("span");
        span.className="pill";
        span.textContent = `${k}:${v?"OK":"å¾…"}`;
        area.appendChild(span);
      });
    }
    function flattenAvailableColumns(){
      const set = new Set();
      state.rows.forEach(r=>{
        Object.keys(r).forEach(k=> set.add(k));
      });
      return Array.from(set);
    }
    function pickColumns(preset){
      if (preset==="ALL" || preset==="all") return flattenAvailableColumns();
      if (preset in COLUMN_PRESETS){
        const config = COLUMN_PRESETS[preset];
        if (config==="ALL") return flattenAvailableColumns();
        return config.filter(col => {
          return state.rows.some(r => r[col] !== undefined && r[col] !== null && r[col] !== "");
        });
      }
      return COLUMN_PRESETS.basic;
    }
    function filterRows(keyword){
      if (!keyword) return state.rows;
      keyword = keyword.toLowerCase();
      return state.rows.filter(r=>{
        return (r["å•æ®ç¼–å·"] && r["å•æ®ç¼–å·"].toLowerCase().includes(keyword)) ||
               (r["è§„æ ¼å‹å·"] && r["è§„æ ¼å‹å·"].toLowerCase().includes(keyword)) ||
               (r["å®¢æˆ·åº—å"] && r["å®¢æˆ·åº—å"].toLowerCase().includes(keyword));
      });
    }

    function renderTable(){
      if (!state.rows.length){
        document.getElementById("tableWrap").style.display="none";
        return;
      }
      document.getElementById("tableWrap").style.display="block";
      const preset = document.getElementById("columnPreset").value;
      let columns = pickColumns(preset);
      state.lastRenderColumns = columns;

      const thead = document.getElementById("tableHead");
      const tbody = document.getElementById("tableBody");
      thead.innerHTML="";
      tbody.innerHTML="";

      const trHead = document.createElement("tr");
      columns.forEach(col=>{
        const th = document.createElement("th");
        th.className="sticky";
        th.textContent = getColLabel(col);
        trHead.appendChild(th);
      });
      thead.appendChild(trHead);

      const keyword = document.getElementById("searchInput").value.trim();
      const displayRows = filterRows(keyword);

      displayRows.forEach(r=>{
        const tr = document.createElement("tr");
        if (r["æ˜¯å¦é€€è´§"]) tr.classList.add("return-row");
        columns.forEach(col=>{
          const td = document.createElement("td");
          let val = r[col];
          if (typeof val === "number"){
            if (Math.abs(val) > 1000000) {
              val = val.toExponential(2);
            } else {
              // é”€å”®æ”¿ç­–æŠ˜æ‰£ç‡ä¿ç•™å››ä½å°æ•°
              if (col === "é”€å”®æ”¿ç­–æŠ˜æ‰£ç‡") {
                val = (Math.round(val*10000)/10000).toString();
              } else {
                val = (Math.round(val*100)/100).toString();
              }
            }
          }
          if (val===null || val===undefined || val==="") val = "";
          td.textContent = val;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      document.getElementById("rowCountLabel").textContent = `æ˜¾ç¤º ${displayRows.length} / æ€»è®¡ ${state.rows.length} è¡Œ`;
    }

    function exportExcel(){
      if (!state.rows.length) return;
      const columns = flattenAvailableColumns();
      const data = [columns.map(getColLabel)];
      state.rows.forEach(r=>{
        const row = columns.map(c=> r[c]===undefined? "" : r[c]);
        data.push(row);
      });
      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "æ˜ç»†");

      const summary = buildSummary();
      const sumData = [["ä¿ƒé”€å‘˜","æ¡æ•°","æœ€ç»ˆæ€»ææˆ"]];
      summary.forEach(s=>{
        sumData.push([s.promoter,s.count,s.totalAfter]);
      });
      const ws2 = XLSX.utils.aoa_to_sheet(sumData);
      XLSX.utils.book_append_sheet(wb, ws2, "æ±‡æ€»");

      const ruleSheet = XLSX.utils.aoa_to_sheet([
        ["è§„åˆ™ç‰ˆæœ¬", state.ruleVersion],
        ["è®¡ç®—è§„åˆ™", "å…­åˆä¸€ææˆè®¡ç®—ï¼šç‰¹ä»·æœºã€å£æŒ‚ç‚‰ã€é”€å”®æ”¿ç­–ã€çƒŸç¶ã€å›½è¡¥ææˆã€æŠ˜æ‰£æœºã€‚é”€å”®æ”¿ç­–è§„åˆ™ç²¾ç®€ï¼š70%/75%æ¡£æ»¡æ¡£4.5%ï¼Œæœªè¾¾æ¡£0ã€‚å›½è¡¥ææˆï¼šä»…é™2025.9.15-10.8æœŸé—´ï¼Œå‰4ä¸ªæ¨¡å—ä¸º0ä¸”è®¢å•ç±»å‹=éå›½è¡¥ä¸”æŠ˜æ‰£åœ¨(70.5%,75%)åŒºé—´ã€‚"]
      ]);
      XLSX.utils.book_append_sheet(wb, ruleSheet, "è§„åˆ™ç‰ˆæœ¬");

      const logSheetData = [["æ—¶é—´","çº§åˆ«","æ¶ˆæ¯"]];
      state.logs.forEach(l=> logSheetData.push([l.time,l.level,l.msg]));
      const wsLog = XLSX.utils.aoa_to_sheet(logSheetData);
      XLSX.utils.book_append_sheet(wb, wsLog, "æ—¥å¿—");

      const fileName = `äº”åˆä¸€ææˆè®¡ç®—_${new Date().toISOString().slice(0,10)}.xlsx`;
      XLSX.writeFile(wb, fileName);
      log(`å¯¼å‡ºå®Œæˆï¼š${fileName}`,"ok");
    }

    function buildSummary(){
      const map = {};
      state.rows.forEach(r=>{
        const p = r["ä¿ƒé”€å‘˜"] || "æœªçŸ¥";
        if (!map[p]) map[p] = {promoter:p, count:0, totalAfter:0};
        map[p].count++;
        map[p].totalAfter += ensureNumeric(r["æœ€ç»ˆæ€»ææˆ"]);
      });
      return Object.values(map);
    }

    function isActivityPackageRow(row){
      return row["ææˆè®¡ç®—çŠ¶æ€"] === "activity_package";
    }

    function calculateSpecial(){
      log("å¼€å§‹æ‰§è¡Œæ¨¡å—ï¼šspecialï¼ˆå« activity_package è·³è¿‡ï¼‰");
      let count = 0;
      state.rows.forEach(r=>{
        if (isActivityPackageRow(r)){
          r["ç‰¹ä»·æœºææˆ"] = 0;
          r["ç‰¹ä»·æœºææˆè¯´æ˜"] = "å·²è®¡ç®—æ´»åŠ¨å¥—é¤ææˆï¼Œè·³è¿‡ç‰¹ä»·æœºè®¡ç®—";
          return;
        }
    const machineType = normalizeString(r["æœºå‹"]);
    const jntPrice = normalizeNumber(r["ä½³å°¼ç‰¹ç‰¹ä»·"]);
      const listPrice = normalizeNumber(r["ç³»ç»Ÿå®šä»·"]);
    const paymentAmount = normalizeNumber(r["å›æ¬¾æ”¶æ¬¾é‡‘é¢"]);
    const salesQty = normalizeNumber(r["é”€å”®æ•°é‡"]);
    const scheme = normalizeString(r["ç‰¹ä»·æœºææˆè®¡ç®—æ–¹æ¡ˆ"]);

    r["ç‰¹ä»·æœºææˆ"] = 0;
    r["ç‰¹ä»·æœºææˆè¯´æ˜"] = "";
    r["ç‰¹ä»·æœºå…¬å¸æœ€ä½æŠ˜æ‰£"] = null;

    const isSpecial = machineType.includes("ç‰¹ä»·") || (jntPrice!==null && jntPrice>0);
        const isReturn = !!r["æ˜¯å¦é€€è´§"];

        if (jntPrice && listPrice){
          const minDiscount = jntPrice / listPrice;
          r["ç‰¹ä»·æœºå…¬å¸æœ€ä½æŠ˜æ‰£"] = parseFloat(minDiscount.toFixed(4));
        }

        if (isSpecial){
          if (scheme && scheme.includes("å…ƒ/å°")){
            const match = scheme.match(/(\d+(?:\.\d+)?)å…ƒ\/å°/);
            if (match && salesQty){
              const unitCommission = parseFloat(match[1]);
              r["ç‰¹ä»·æœºææˆ"] = salesQty * unitCommission;
              r["ç‰¹ä»·æœºææˆè¯´æ˜"] = `æŒ‰å…ƒ/å°ï¼šé”€å”®æ•°é‡${salesQty} Ã— ${unitCommission}å…ƒ/å° â†’ ç‰¹ä»·æœºææˆ=${fmtCurrency(r["ç‰¹ä»·æœºææˆ"])}`;
            } else {
              r["ç‰¹ä»·æœºææˆè¯´æ˜"] = `æ–¹æ¡ˆä¸ºå…ƒ/å°ä½†æ— æ³•è§£æé‡‘é¢æˆ–ç¼ºå°‘é”€å”®æ•°é‡ï¼Œææˆ=0`;
            }
          } else if (scheme && scheme.includes("%")){
            const match = scheme.match(/(\d+(?:\.\d+)?)%/);
            if (match && paymentAmount){
              const rate = parseFloat(match[1]) / 100;
              r["ç‰¹ä»·æœºææˆ"] = paymentAmount * rate;
              r["ç‰¹ä»·æœºææˆè¯´æ˜"] = `æŒ‰ç™¾åˆ†æ¯”ï¼šå›æ¬¾${fmtCurrency(paymentAmount)} Ã— ${fmtPercent(rate)} â†’ ç‰¹ä»·æœºææˆ=${fmtCurrency(r["ç‰¹ä»·æœºææˆ"])}`;
            } else {
              r["ç‰¹ä»·æœºææˆè¯´æ˜"] = `æ–¹æ¡ˆä¸ºç™¾åˆ†æ¯”ä½†æ— æ³•è§£ææ¯”ä¾‹æˆ–ç¼ºå°‘å›æ¬¾é‡‘é¢ï¼Œææˆ=0`;
            }
          } else if (jntPrice && paymentAmount){
            if (paymentAmount >= jntPrice){
              const diff = paymentAmount - jntPrice;
              r["ç‰¹ä»·æœºææˆ"] = diff;
              r["ç‰¹ä»·æœºææˆè¯´æ˜"] = `æŒ‰è¶…åº•ä»·ï¼šå›æ¬¾${fmtCurrency(paymentAmount)} - ç‰¹ä»·${fmtCurrency(jntPrice)} = ${fmtCurrency(diff)} â†’ ç‰¹ä»·æœºææˆ=${fmtCurrency(r["ç‰¹ä»·æœºææˆ"])}`;
            } else {
              r["ç‰¹ä»·æœºææˆè¯´æ˜"] = `å›æ¬¾${fmtCurrency(paymentAmount)} < ç‰¹ä»·${fmtCurrency(jntPrice)}ï¼Œä½äºåº•ä»·ï¼Œææˆ=0`;
            }
          } else {
            r["ç‰¹ä»·æœºææˆè¯´æ˜"] = `è¯†åˆ«ä¸ºç‰¹ä»·æœºä½†ç¼ºå°‘æ–¹æ¡ˆ/åº•ä»·/å›æ¬¾ï¼Œææˆ=0`;
          }
      count++;
    } else {
      r["ç‰¹ä»·æœºææˆè¯´æ˜"] = `æœªå‘½ä¸­ç‰¹ä»·æœºï¼ˆæœºå‹ä¸å«"ç‰¹ä»·"ä¸”ä½³å°¼ç‰¹ç‰¹ä»·â‰¤0ï¼‰ï¼Œææˆ=0`;
    }
        if (isReturn){
          r["ç‰¹ä»·æœºææˆè¯´æ˜"] += "ã€‚è¯¥è¡Œä¸ºé€€è´§æ ‡è®°ï¼Œå½“å‰è§„åˆ™æœªé¢å¤–å†²å‡";
        }
      });
      log(`æ¨¡å— special è®¡ç®—å®Œæˆï¼ˆå«è·³è¿‡ï¼‰ï¼Œå¤„ç† ${count} æ¡é activity_package è®°å½•ã€‚`,"ok");
      state.modulesDone.special = true;
      updateModuleButtonStyle("special", "done");
      document.getElementById("btnBoiler").disabled = false;
      renderTable();
      refreshStats();
    }

    function calculateBoiler(){
      log("å¼€å§‹æ‰§è¡Œæ¨¡å—ï¼šboilerï¼ˆå« activity_package è·³è¿‡ï¼‰");
      let count = 0;
      state.rows.forEach(r=>{
        if (isActivityPackageRow(r)){
          r["å£æŒ‚ç‚‰ææˆ"] = 0;
          r["å£æŒ‚ç‚‰ææˆè¯´æ˜"] = "å·²è®¡ç®—æ´»åŠ¨å¥—é¤ææˆï¼Œè·³è¿‡å£æŒ‚ç‚‰è®¡ç®—";
          return;
        }
        const sourceCommission = normalizeNumber(r["å£æŒ‚ç‚‰ææˆåŸå§‹"]);
        r["å£æŒ‚ç‚‰ææˆ"] = 0;
        r["å£æŒ‚ç‚‰ææˆè¯´æ˜"] = "";
        const majorCat = normalizeString(r["å¤§ç±»å‹"]);
          const boilerDiscount = normalizeNumber(r["å£æŒ‚ç‚‰é”€å”®æŠ˜æ‰£"]);
        const actualDiscount = normalizeNumber(r["å–å‡ºçš„å®é™…æŠ˜æ‰£"]);
        const paymentAmount = normalizeNumber(r["å›æ¬¾æ”¶æ¬¾é‡‘é¢"]);

        if (majorCat === "å£æŒ‚ç‚‰"){
          if (boilerDiscount === 0.8 || boilerDiscount === 80){
            if (actualDiscount >= 0.8){
              const commissionRate = 0.05;
              r["å£æŒ‚ç‚‰ææˆ"] = paymentAmount * commissionRate;
              r["å£æŒ‚ç‚‰ææˆè¯´æ˜"] = `80%è§„åˆ™ï¼šå®é™…æŠ˜æ‰£â‰¥80% â†’ æ”¶æ¬¾Ã—5% = ${fmtCurrency(r["å£æŒ‚ç‚‰ææˆ"])}`;
            } else if (actualDiscount >= 0.75 && actualDiscount < 0.8){
              const commissionRate = (actualDiscount - 0.75) * 1;
              r["å£æŒ‚ç‚‰ææˆ"] = paymentAmount * commissionRate;
              r["å£æŒ‚ç‚‰ææˆè¯´æ˜"] = `80%è§„åˆ™ï¼š(${fmtPercent(actualDiscount)} - 75%)Ã—100ç‚¹ = ${fmtPercent(commissionRate)} â†’ æ”¶æ¬¾Ã—è¯¥æ¯”ä¾‹ = ${fmtCurrency(r["å£æŒ‚ç‚‰ææˆ"])}`;
            } else {
              r["å£æŒ‚ç‚‰ææˆè¯´æ˜"] = `80%è§„åˆ™ï¼šå®é™…æŠ˜æ‰£${fmtPercent(actualDiscount)} < 75%ï¼Œææˆ=0`;
            }
          } else if (boilerDiscount === 0.78 || boilerDiscount === 78){
            if (actualDiscount >= 0.78){
              const commissionRate = 0.11;
              r["å£æŒ‚ç‚‰ææˆ"] = paymentAmount * commissionRate;
              r["å£æŒ‚ç‚‰ææˆè¯´æ˜"] = `78%è§„åˆ™ï¼šå®é™…æŠ˜æ‰£â‰¥78% â†’ æ”¶æ¬¾Ã—11% = ${fmtCurrency(r["å£æŒ‚ç‚‰ææˆ"])}`;
            } else if (actualDiscount >= 0.67 && actualDiscount < 0.78){
              const commissionRate = (actualDiscount - 0.67) * 1;
              r["å£æŒ‚ç‚‰ææˆ"] = paymentAmount * commissionRate;
              r["å£æŒ‚ç‚‰ææˆè¯´æ˜"] = `78%è§„åˆ™ï¼š(${fmtPercent(actualDiscount)} - 67%)Ã—100ç‚¹ = ${fmtPercent(commissionRate)} â†’ æ”¶æ¬¾Ã—è¯¥æ¯”ä¾‹ = ${fmtCurrency(r["å£æŒ‚ç‚‰ææˆ"])}`;
            } else {
              r["å£æŒ‚ç‚‰ææˆè¯´æ˜"] = `78%è§„åˆ™ï¼šå®é™…æŠ˜æ‰£${fmtPercent(actualDiscount)} < 67%ï¼Œææˆ=0`;
            }
          } else {
            r["å£æŒ‚ç‚‰ææˆè¯´æ˜"] = `å£æŒ‚ç‚‰é”€å”®æŠ˜æ‰£${boilerDiscount} é 80%/78%ï¼Œææˆ=0`;
          }
          count++;
        } else {
          r["å£æŒ‚ç‚‰ææˆè¯´æ˜"] = "éå£æŒ‚ç‚‰å¤§ç±»ï¼Œè·³è¿‡ï¼Œææˆ=0";
        }
      });
      log(`æ¨¡å— boiler è®¡ç®—å®Œæˆï¼ˆå«è·³è¿‡ï¼‰ï¼Œå¤„ç† ${count} æ¡é activity_package è®°å½•ã€‚`,"ok");
      state.modulesDone.boiler = true;
      updateModuleButtonStyle("boiler","done");
      document.getElementById("btnActivity").disabled = false;
      renderTable();
      refreshStats();
    }

    // =======================
    // é”€å”®æ”¿ç­–æ¨¡å—ï¼ˆå·²ç²¾ç®€è§„åˆ™ï¼‰
    // =======================
    function calculateActivity(){
      log("å¼€å§‹æ‰§è¡Œæ¨¡å—ï¼šé”€å”®æ”¿ç­–ï¼ˆç²¾ç®€ï¼šæ»¡æ¡£ç›´æ¥4.5%ï¼Œæ”¯æŒæ•°å€¼ç±»å‹æŠ˜æ‰£ç‡ï¼‰");
      let count = 0;
      state.rows.forEach(r=>{
        if (isActivityPackageRow(r)){
          r["é”€å”®æ”¿ç­–ææˆ"] = 0;
          r["é”€å”®æ”¿ç­–ææˆè¯´æ˜"] = "å·²è®¡ç®—æ´»åŠ¨å¥—é¤ææˆï¼Œè·³è¿‡é”€å”®æ”¿ç­–è®¡ç®—";
          r["é”€å”®æ”¿ç­–åŠ æ"] = 0;
          r["é”€å”®æ”¿ç­–åŠ æè¯´æ˜"] = "å·²è®¡ç®—æ´»åŠ¨å¥—é¤ææˆï¼Œè·³è¿‡é”€å”®æ”¿ç­–åŠ æè®¡ç®—";
          return;
        }
        r["é”€å”®æ”¿ç­–ææˆ"] = 0;
        r["é”€å”®æ”¿ç­–åŠ æ"] = 0;
        r["é”€å”®æ”¿ç­–ææˆè¯´æ˜"] = "";
        r["é”€å”®æ”¿ç­–åŠ æè¯´æ˜"] = "";
        const policyDiscount = normalizeNumber(r["é”€å”®æ”¿ç­–æŠ˜æ‰£ç‡"]);
        const policyCommissionSource = normalizeNumber(r["é”€å”®æ”¿ç­–ææˆåŸå§‹"]);
        const policyExtraSource = normalizeNumber(r["é”€å”®æ”¿ç­–åŠ æåŸå§‹"]);
        const actualDiscount = normalizeNumber(r["å–å‡ºçš„å®é™…æŠ˜æ‰£"]);
        const paymentAmount = normalizeNumber(r["å›æ¬¾æ”¶æ¬¾é‡‘é¢"]);

        const hasActivityField = (policyDiscount>0) || (policyCommissionSource>0) || (policyExtraSource>0);

        if (hasActivityField){
          // å…ˆåˆ¤æ–­æ˜¯å¦ä¸ºæ•°å€¼ç±»å‹ï¼ˆ>1è¡¨ç¤ºæ˜¯é‡‘é¢æ•°å€¼ï¼Œå¦‚500ã€5999ç­‰ï¼‰
          if (policyDiscount > 1){
            if (paymentAmount > policyDiscount){
              r["é”€å”®æ”¿ç­–ææˆ"] = policyCommissionSource;
              r["é”€å”®æ”¿ç­–ææˆè¯´æ˜"] = `æ•°å€¼æ¡£ï¼šå›æ¬¾${fmtCurrency(paymentAmount)} > é˜ˆå€¼${fmtCurrency(policyDiscount)}ï¼Œé”€å”®æ”¿ç­–ææˆ = é”€å”®æ”¿ç­–ææˆ(æ¥æº) ${fmtCurrency(policyCommissionSource)}`;
            } else {
              r["é”€å”®æ”¿ç­–ææˆè¯´æ˜"] = `æ•°å€¼æ¡£ï¼šå›æ¬¾${fmtCurrency(paymentAmount)} â‰¤ é˜ˆå€¼${fmtCurrency(policyDiscount)}ï¼Œææˆ=0`;
            }
          } else if (policyDiscount === 0.7 || policyDiscount === 70){
            if (actualDiscount >= 0.70){
              const commissionRate = 0.045;
              r["é”€å”®æ”¿ç­–ææˆ"] = paymentAmount * commissionRate;
              r["é”€å”®æ”¿ç­–ææˆè¯´æ˜"] = `70%æ¡£ï¼šå®é™…æŠ˜æ‰£â‰¥70% â†’ æ”¶æ¬¾Ã—4.5% = ${fmtCurrency(r["é”€å”®æ”¿ç­–ææˆ"])}`;
            } else {
              r["é”€å”®æ”¿ç­–ææˆè¯´æ˜"] = `70%æ¡£ï¼šå®é™…æŠ˜æ‰£${fmtPercent(actualDiscount)} < 70%ï¼Œææˆ=0`;
            }
          } else if (policyDiscount === 0.75 || policyDiscount === 75){
            if (actualDiscount >= 0.75){
              const commissionRate = 0.045;
              r["é”€å”®æ”¿ç­–ææˆ"] = paymentAmount * commissionRate;
              r["é”€å”®æ”¿ç­–ææˆè¯´æ˜"] = `75%æ¡£ï¼šå®é™…æŠ˜æ‰£â‰¥75% â†’ æ”¶æ¬¾Ã—4.5% = ${fmtCurrency(r["é”€å”®æ”¿ç­–ææˆ"])}`;
            } else {
              r["é”€å”®æ”¿ç­–ææˆè¯´æ˜"] = `75%æ¡£ï¼šå®é™…æŠ˜æ‰£${fmtPercent(actualDiscount)} < 75%ï¼Œææˆ=0`;
            }
          } else {
            r["é”€å”®æ”¿ç­–ææˆè¯´æ˜"] = `é”€å”®æ”¿ç­–æŠ˜æ‰£ç‡${policyDiscount} é 70% / 75% æˆ–æ•°å€¼ç±»å‹ï¼Œææˆ=0`;
          }

          if (policyExtraSource > 0){
            r["é”€å”®æ”¿ç­–åŠ æ"] = policyExtraSource;
            r["é”€å”®æ”¿ç­–åŠ æè¯´æ˜"] = `æ¥æºå­—æ®µåŠ æ=${fmtCurrency(policyExtraSource)}`;
          } else {
            r["é”€å”®æ”¿ç­–åŠ æè¯´æ˜"] = "æ— åŠ ææ¥æºï¼ŒåŠ æ=0";
          }
          count++;
        } else {
          r["é”€å”®æ”¿ç­–ææˆè¯´æ˜"] = "æ— é”€å”®æ”¿ç­–ç›¸å…³å­—æ®µï¼Œè·³è¿‡ï¼Œææˆ=0";
          r["é”€å”®æ”¿ç­–åŠ æè¯´æ˜"] = "æ— é”€å”®æ”¿ç­–ç›¸å…³å­—æ®µï¼Œè·³è¿‡ï¼ŒåŠ æ=0";
        }
      });
      log(`æ¨¡å— é”€å”®æ”¿ç­– è®¡ç®—å®Œæˆï¼ˆç²¾ç®€è§„åˆ™+æ•°å€¼ç±»å‹æ”¯æŒï¼‰ï¼Œå¤„ç† ${count} æ¡é activity_package è®°å½•ã€‚`,"ok");
      state.modulesDone.activity = true;
      updateModuleButtonStyle("activity","done");
      document.getElementById("btnSmoke").disabled = false;
      renderTable();
      refreshStats();
    }

    function calculateSmoke(){
      log("å¼€å§‹æ‰§è¡Œæ¨¡å—ï¼šsmokeï¼ˆå« activity_package è·³è¿‡ï¼‰");
      let count = 0;
      state.rows.forEach(r=>{
        if (isActivityPackageRow(r)){
          r["çƒŸç¶ææˆ"] = 0;
          r["çƒŸç¶ææˆè¯´æ˜"] = "å·²è®¡ç®—æ´»åŠ¨å¥—é¤ææˆï¼Œè·³è¿‡çƒŸç¶è®¡ç®—";
          return;
        }
        r["çƒŸç¶ææˆ"] = 0;
        r["çƒŸç¶ææˆè¯´æ˜"] = "";
        const majorCat = normalizeString(r["å¤§ç±»å‹"]);
        const actualDiscount = normalizeNumber(r["å–å‡ºçš„å®é™…æŠ˜æ‰£"]);
        const paymentAmount = normalizeNumber(r["å›æ¬¾æ”¶æ¬¾é‡‘é¢"]);
        const orderDate = parseOrderDate(r);

        const isSmokeRelated = majorCat.includes("æ²¹çƒŸæœº") || majorCat.includes("å‡€çƒŸæœº") ||
                                majorCat.includes("è’¸çƒ¤") || majorCat.includes("æ´—ç¢—æœº");

        if (isSmokeRelated && actualDiscount !== null && paymentAmount !== null){
          let threshold = 0;
          let categoryName = "";
          let thresholdNote = "";
          if (majorCat.includes("æ²¹çƒŸæœº")){ threshold = 0.7; categoryName = "æ²¹çƒŸæœº"; }
          else if (majorCat.includes("å‡€çƒŸæœº")){ threshold = 0.65; categoryName = "å‡€çƒŸæœº"; }
          else if (majorCat.includes("è’¸çƒ¤")){ threshold = 0.65; categoryName = "è’¸çƒ¤"; }
          else if (majorCat.includes("æ´—ç¢—æœº")){ threshold = 0.65; categoryName = "æ´—ç¢—æœº"; }

          if (categoryName === "æ²¹çƒŸæœº"){
            const info = getOilHoodThreshold(orderDate);
            threshold = info.threshold;
            thresholdNote = info.note;
          }
          const thresholdDisplay = `${fmtPercent(threshold)}${thresholdNote}`;

          if (actualDiscount >= threshold){
            r["çƒŸç¶ææˆ"] = paymentAmount * 0.1;
            r["çƒŸç¶ææˆè¯´æ˜"] = `${categoryName}ï¼šå®é™…æŠ˜æ‰£${fmtPercent(actualDiscount)} â‰¥ ${thresholdDisplay} â†’ æ”¶æ¬¾Ã—10% = ${fmtCurrency(r["çƒŸç¶ææˆ"])}`;
          } else {
            r["çƒŸç¶ææˆè¯´æ˜"] = `${categoryName}ï¼šå®é™…æŠ˜æ‰£${fmtPercent(actualDiscount)} < ${thresholdDisplay}ï¼Œææˆ=0`;
          }
          count++;
        } else {
          const miss = [];
          if (!isSmokeRelated) miss.push("éçƒŸç¶ç›¸å…³å¤§ç±»å‹");
          if (actualDiscount === null) miss.push("å–å‡ºçš„å®é™…æŠ˜æ‰£ç¼ºå¤±");
          if (paymentAmount === null) miss.push("å›æ¬¾æ”¶æ¬¾é‡‘é¢ç¼ºå¤±");
          r["çƒŸç¶ææˆè¯´æ˜"] = `æœªå‘½ä¸­ï¼š${miss.join("ã€")}ï¼Œææˆ=0`;
        }
      });
      log(`æ¨¡å— smoke è®¡ç®—å®Œæˆï¼ˆå«è·³è¿‡ï¼‰ï¼Œå¤„ç† ${count} æ¡é activity_package è®°å½•ã€‚`,"ok");
      state.modulesDone.smoke = true;
      updateModuleButtonStyle("smoke","done");
      document.getElementById("btnNationalSubsidy").disabled = false;
      renderTable();
      refreshStats();
    }

    function calculateNationalSubsidy(){
      log("å¼€å§‹æ‰§è¡Œæ¨¡å—ï¼šnationalSubsidyï¼ˆå« activity_package è·³è¿‡ï¼‰");
      let count = 0;
      // å›½è¡¥ææˆæ—¶é—´æ®µï¼š2025å¹´9æœˆ15æ—¥è‡³10æœˆ8æ—¥
      const subsidyStartDate = new Date(2025, 8, 15); // æœˆä»½ä»0å¼€å§‹ï¼Œ8ä»£è¡¨9æœˆ
      const subsidyEndDate = new Date(2025, 9, 8, 23, 59, 59, 999); // 9ä»£è¡¨10æœˆ
      
      state.rows.forEach(r=>{
        if (isActivityPackageRow(r)){
          r["å›½è¡¥ææˆ"] = 0;
          r["å›½è¡¥ææˆè¯´æ˜"] = "å·²è®¡ç®—æ´»åŠ¨å¥—é¤ææˆï¼Œè·³è¿‡å›½è¡¥è®¡ç®—";
          return;
        }
        r["å›½è¡¥ææˆ"] = 0;
        r["å›½è¡¥ææˆè¯´æ˜"] = "";
        
        // æ£€æŸ¥è®¢å•æ—¥æœŸæ˜¯å¦åœ¨å›½è¡¥æ—¶é—´æ®µå†…
        const orderDate = parseOrderDate(r);
        const inSubsidyPeriod = orderDate && orderDate >= subsidyStartDate && orderDate <= subsidyEndDate;
        
        const c_special = ensureNumeric(r["ç‰¹ä»·æœºææˆ"]);
        const c_boiler = ensureNumeric(r["å£æŒ‚ç‚‰ææˆ"]);
        const c_policy = ensureNumeric(r["é”€å”®æ”¿ç­–ææˆ"]);
        const c_smoke = ensureNumeric(r["çƒŸç¶ææˆ"]);
        const allPrevZero = (c_special === 0 && c_boiler === 0 && c_policy === 0 && c_smoke === 0);
        
        const orderType = normalizeString(r["è®¢å•ç±»å‹"]);
        const finalDiscount = r["æœ€ç»ˆæŠ˜æ‰£ç‡"];
        const amountTax = normalizeNumber(r["ä»·ç¨åˆè®¡"]);
        
        // å¿…é¡»åœ¨å›½è¡¥æ—¶é—´æ®µå†…æ‰è®¡ç®—
        if (!inSubsidyPeriod){
          if (orderDate){
            r["å›½è¡¥ææˆè¯´æ˜"] = `è®¢å•æ—¥æœŸ${orderDate.toLocaleDateString('zh-CN')}ä¸åœ¨å›½è¡¥æ—¶é—´æ®µ(2025.9.15-10.8)å†…ï¼Œå›½è¡¥ææˆ=0`;
          } else {
            r["å›½è¡¥ææˆè¯´æ˜"] = "ç¼ºå°‘è®¢å•æ—¥æœŸï¼Œæ— æ³•åˆ¤æ–­æ˜¯å¦åœ¨å›½è¡¥æ—¶é—´æ®µå†…ï¼Œå›½è¡¥ææˆ=0";
          }
          return;
        }
        
        if (allPrevZero && orderType === "éå›½è¡¥"){
          if (finalDiscount !== null && finalDiscount > 0.705 && finalDiscount < 0.750){
            if (amountTax !== null){
              r["å›½è¡¥ææˆ"] = (finalDiscount - 0.705) * amountTax;
              r["å›½è¡¥ææˆè¯´æ˜"] = `éå›½è¡¥æœºï¼š(${fmtPercent(finalDiscount)} - 70.5%) Ã— ä»·ç¨åˆè®¡${fmtCurrency(amountTax)} = ${fmtCurrency(r["å›½è¡¥ææˆ"])}`;
              count++;
            } else {
              r["å›½è¡¥ææˆè¯´æ˜"] = "ç¬¦åˆå›½è¡¥æ¡ä»¶ä½†ç¼ºå°‘ä»·ç¨åˆè®¡ï¼Œå›½è¡¥ææˆ=0";
            }
          } else if (finalDiscount === null){
            r["å›½è¡¥ææˆè¯´æ˜"] = "ç¼ºå°‘æœ€ç»ˆæŠ˜æ‰£ç‡ï¼Œæ— æ³•åˆ¤æ–­å›½è¡¥ææˆ";
          } else {
            r["å›½è¡¥ææˆè¯´æ˜"] = `æœ€ç»ˆæŠ˜æ‰£ç‡${fmtPercent(finalDiscount)}ä¸åœ¨(70.5%,75.0%)å†…ï¼Œå›½è¡¥ææˆ=0`;
          }
        } else {
          const miss = [];
          if (!allPrevZero) miss.push("å‰4ä¸ªæ¨¡å—ææˆä¸å…¨ä¸º0");
          if (orderType !== "éå›½è¡¥") miss.push(`è®¢å•ç±»å‹="${orderType}"é"éå›½è¡¥"`);
          r["å›½è¡¥ææˆè¯´æ˜"] = `æœªå‘½ä¸­ï¼š${miss.join("ã€")}ï¼Œå›½è¡¥ææˆ=0`;
        }
      });
      log(`æ¨¡å— nationalSubsidy è®¡ç®—å®Œæˆï¼ˆå«è·³è¿‡ï¼‰ï¼Œå¤„ç† ${count} æ¡é activity_package è®°å½•ã€‚`,"ok");
      state.modulesDone.nationalSubsidy = true;
      updateModuleButtonStyle("nationalSubsidy","done");
      afterModuleCheckUnlock();
      renderTable();
      refreshStats();
    }

    function calculateDiscount(){
      log("å¼€å§‹æ‰§è¡Œæ¨¡å—ï¼šdiscountï¼ˆå« activity_package è·³è¿‡ï¼‰");
      let count = 0;
      state.rows.forEach(r=>{
        const c_special = ensureNumeric(r["ç‰¹ä»·æœºææˆ"]);
        const c_boiler = ensureNumeric(r["å£æŒ‚ç‚‰ææˆ"]);
        const c_policy = ensureNumeric(r["é”€å”®æ”¿ç­–ææˆ"]);
        const c_policy_extra = ensureNumeric(r["é”€å”®æ”¿ç­–åŠ æ"]);
        const c_smoke = ensureNumeric(r["çƒŸç¶ææˆ"]);
        const c_national = ensureNumeric(r["å›½è¡¥ææˆ"]);

        r["æŠ˜æ‰£å‰å°è®¡"] = c_special + c_boiler + c_policy + c_policy_extra + c_smoke;
        r["æŠ˜æ‰£å‰å°è®¡è¯´æ˜"] = `å°è®¡ = ç‰¹ä»·${fmtCurrency(c_special)} + å£æŒ‚ç‚‰${fmtCurrency(c_boiler)} + é”€å”®æ”¿ç­–${fmtCurrency(c_policy)} + é”€å”®æ”¿ç­–åŠ æ${fmtCurrency(c_policy_extra)} + çƒŸç¶${fmtCurrency(c_smoke)} â†’ ${fmtCurrency(r["æŠ˜æ‰£å‰å°è®¡"])}`;

        // æå‰è·å–æœ€ç»ˆæŠ˜æ‰£ç‡ï¼Œä¾›åç»­åˆ¤æ–­ä½¿ç”¨
        const finalDiscount = r["æœ€ç»ˆæŠ˜æ‰£ç‡"];

        if (isActivityPackageRow(r)){
          r["æŠ˜æ‰£æœºææˆ"] = 0;
          r["æŠ˜æ‰£æœºææˆè¯´æ˜"] = "å·²è®¡ç®—æ´»åŠ¨å¥—é¤ææˆï¼Œè·³è¿‡æŠ˜æ‰£æœºè®¡ç®—";
          
          // æ–°è§„åˆ™ï¼šæŠ˜æ‰£å‰å°è®¡=0ã€æŠ˜æ‰£æœºææˆ=0ä¸”æœ€ç»ˆæŠ˜æ‰£ç‡â‰¥0.755æ—¶ï¼Œæœ€ç»ˆæ€»ææˆç•™ç©º
          if (r["æŠ˜æ‰£å‰å°è®¡"] === 0 && finalDiscount !== null && finalDiscount >= 0.755){
            r["æœ€ç»ˆæ€»ææˆ"] = "";
            r["æœ€ç»ˆæ€»ææˆè¯´æ˜"] = `æŠ˜æ‰£å‰å°è®¡å’ŒæŠ˜æ‰£æœºææˆå‡ä¸º0ï¼Œä¸”æœ€ç»ˆæŠ˜æ‰£ç‡${fmtPercent(finalDiscount)}â‰¥75.5%ï¼Œæœ€ç»ˆæ€»ææˆç•™ç©ºå¾…äººå·¥å®¡æ ¸`;
          } else {
            r["æœ€ç»ˆæ€»ææˆ"] = r["æŠ˜æ‰£å‰å°è®¡"] + c_national;
            r["æœ€ç»ˆæ€»ææˆè¯´æ˜"] = `æœ€ç»ˆ = å°è®¡${fmtCurrency(r["æŠ˜æ‰£å‰å°è®¡"])} + å›½è¡¥${fmtCurrency(c_national)}ï¼ˆactivity_packageè·³è¿‡æŠ˜æ‰£ï¼‰`;
          }
          return;
        }

        r["æŠ˜æ‰£æœºææˆ"] = 0;
        r["æŠ˜æ‰£æœºææˆè¯´æ˜"] = "";
        const amountTax = normalizeNumber(r["ä»·ç¨åˆè®¡"]);
        const energyCode = normalizeEnergyCode(r["èƒ½æ•ˆæ ‡è¯†"]);
        const region = determineRegion(r);
        const allZero = (c_special === 0 && c_boiler === 0 && c_policy === 0 && c_policy_extra === 0 && c_smoke === 0 && c_national === 0);

        if (!allZero){
          r["æŠ˜æ‰£æœºææˆè¯´æ˜"] = "å‰äº”æ¨¡å—ææˆä¸å…¨ä¸º0ï¼Œä¸ç¬¦åˆæŠ˜æ‰£æœºæ¡ä»¶ï¼ŒæŠ˜æ‰£æœºææˆ=0";
        } else if (!region){
          r["æŠ˜æ‰£æœºææˆè¯´æ˜"] = "ç¼ºå°‘æ‰€å±åœ°åŒºï¼Œæ— æ³•åˆ¤æ–­æŠ˜æ‰£æœºè§„åˆ™ï¼ŒæŠ˜æ‰£æœºææˆ=0";
        } else if (region !== "æ­å·" && region !== "é‡‘å"){
          r["æŠ˜æ‰£æœºææˆè¯´æ˜"] = `æ‰€å±åœ°åŒº${region}ä¸åœ¨æ­å·/é‡‘åèŒƒå›´ï¼ŒæŠ˜æ‰£æœºææˆ=0`;
        } else if (region === "æ­å·" && !energyCode){
          r["æŠ˜æ‰£æœºææˆè¯´æ˜"] = "æ­å·åœ°åŒºéœ€æä¾›èƒ½æ•ˆæ ‡è¯†ï¼Œå½“å‰ä¸ºç©ºï¼ŒæŠ˜æ‰£æœºææˆ=0";
        } else if (finalDiscount === null){
          r["æŠ˜æ‰£æœºææˆè¯´æ˜"] = "ç¼ºå°‘ç³»ç»Ÿå®šä»·æˆ–ä»·ç¨åˆè®¡ï¼Œæ— æ³•è®¡ç®—æŠ˜æ‰£ç‡ï¼ŒæŠ˜æ‰£æœºææˆ=0";
        } else {
          const rule = getDiscountRule(region, energyCode);
          if (!rule){
            r["æŠ˜æ‰£æœºææˆè¯´æ˜"] = "æœªåŒ¹é…åˆ°åœ°åŒºå¯¹åº”çš„æŠ˜æ‰£æœºè§„åˆ™ï¼ŒæŠ˜æ‰£æœºææˆ=0";
          } else if (amountTax === null){
            r["æŠ˜æ‰£æœºææˆè¯´æ˜"] = `${rule.desc}ï¼šç¼ºå°‘ä»·ç¨åˆè®¡ï¼ŒæŠ˜æ‰£æœºææˆ=0`;
          } else if (finalDiscount < rule.min){
            // ä½äºåŒºé—´ä¸‹é™ï¼Œææˆä¸º0
            r["æŠ˜æ‰£æœºææˆè¯´æ˜"] = `${rule.desc}ï¼šæœ€ç»ˆæŠ˜æ‰£ç‡${fmtPercent(finalDiscount)}ä½äº${fmtPercent(rule.min)}ï¼ŒæŠ˜æ‰£æœºææˆ=0`;
          } else if (finalDiscount >= rule.min && finalDiscount <= rule.max){
            // åœ¨åŒºé—´å†…ï¼ŒæŒ‰å·®å€¼è®¡ç®—
            r["æŠ˜æ‰£æœºææˆ"] = (finalDiscount - rule.base) * amountTax;
            r["æŠ˜æ‰£æœºææˆè¯´æ˜"] = `${rule.desc}ï¼ˆ${rule.label}ï¼ŒåŒºé—´${fmtPercent(rule.min)}-${fmtPercent(rule.max)}ï¼‰ï¼š(${fmtPercent(finalDiscount)} - ${fmtPercent(rule.base)}) Ã— ä»·ç¨åˆè®¡${fmtCurrency(amountTax)} = ${fmtCurrency(r["æŠ˜æ‰£æœºææˆ"])}`;
          } else {
            // è¶…è¿‡åŒºé—´ä¸Šé™ï¼Œç»™å›ºå®š4.5%
            r["æŠ˜æ‰£æœºææˆ"] = 0.045 * amountTax;
            r["æŠ˜æ‰£æœºææˆè¯´æ˜"] = `${rule.desc}ï¼ˆ${rule.label}ï¼‰ï¼šæœ€ç»ˆæŠ˜æ‰£ç‡${fmtPercent(finalDiscount)}è¶…è¿‡${fmtPercent(rule.max)}ï¼Œç»™äºˆå›ºå®š4.5%ææˆ = 0.045 Ã— ä»·ç¨åˆè®¡${fmtCurrency(amountTax)} = ${fmtCurrency(r["æŠ˜æ‰£æœºææˆ"])}`;
          }
        }
        // æ–°è§„åˆ™ï¼šæŠ˜æ‰£å‰å°è®¡=0ã€æŠ˜æ‰£æœºææˆ=0ä¸”æœ€ç»ˆæŠ˜æ‰£ç‡â‰¥0.755æ—¶ï¼Œæœ€ç»ˆæ€»ææˆç•™ç©º
        if (r["æŠ˜æ‰£å‰å°è®¡"] === 0 && ensureNumeric(r["æŠ˜æ‰£æœºææˆ"]) === 0 && finalDiscount !== null && finalDiscount >= 0.755){
          r["æœ€ç»ˆæ€»ææˆ"] = "";
          r["æœ€ç»ˆæ€»ææˆè¯´æ˜"] = `æŠ˜æ‰£å‰å°è®¡å’ŒæŠ˜æ‰£æœºææˆå‡ä¸º0ï¼Œä¸”æœ€ç»ˆæŠ˜æ‰£ç‡${fmtPercent(finalDiscount)}â‰¥75.5%ï¼Œæœ€ç»ˆæ€»ææˆç•™ç©ºå¾…äººå·¥å®¡æ ¸`;
        } else {
          r["æœ€ç»ˆæ€»ææˆ"] = r["æŠ˜æ‰£å‰å°è®¡"] + c_national + ensureNumeric(r["æŠ˜æ‰£æœºææˆ"]);
          r["æœ€ç»ˆæ€»ææˆè¯´æ˜"] = `æœ€ç»ˆ = å°è®¡${fmtCurrency(r["æŠ˜æ‰£å‰å°è®¡"])} + å›½è¡¥${fmtCurrency(c_national)} + æŠ˜æ‰£æœº${fmtCurrency(r["æŠ˜æ‰£æœºææˆ"])} â†’ ${fmtCurrency(r["æœ€ç»ˆæ€»ææˆ"])}`;
        }
        count++;
      });
      
      // è®¡ç®—å¸¸è§„æœºè¯´æ˜
      state.rows.forEach(r=>{
        r["å¸¸è§„æœºè¯´æ˜"] = "";
        
        // è·³è¿‡activity_packageè¡Œ
        if (isActivityPackageRow(r)){
          return;
        }
        
        // æ£€æŸ¥5ä¸ªä¸»è¦æ”¿ç­–æ˜¯å¦éƒ½æœªå‘½ä¸­
        const specialNote = normalizeString(r["ç‰¹ä»·æœºææˆè¯´æ˜"]);
        const boilerNote = normalizeString(r["å£æŒ‚ç‚‰ææˆè¯´æ˜"]);
        const policyNote = normalizeString(r["é”€å”®æ”¿ç­–ææˆè¯´æ˜"]);
        const smokeNote = normalizeString(r["çƒŸç¶ææˆè¯´æ˜"]);
        
        const specialMiss = specialNote.includes("æœªå‘½ä¸­ç‰¹ä»·æœº");
        const boilerMiss = boilerNote.includes("éå£æŒ‚ç‚‰å¤§ç±»") || boilerNote.includes("è·³è¿‡");
        const policyMiss = policyNote.includes("æ— é”€å”®æ”¿ç­–ç›¸å…³å­—æ®µ") || policyNote.includes("è·³è¿‡");
        const smokeMiss = smokeNote.includes("æœªå‘½ä¸­");
        const discountMiss = ensureNumeric(r["æŠ˜æ‰£æœºææˆ"]) === 0;
        
        // æ‰€æœ‰æ”¿ç­–éƒ½æœªå‘½ä¸­æ‰æ˜¾ç¤ºå¸¸è§„æœº
        if (specialMiss && boilerMiss && policyMiss && smokeMiss && discountMiss){
          r["å¸¸è§„æœºè¯´æ˜"] = "å¸¸è§„æœº 4.5";
        }
      });
      
      log(`æ¨¡å— discount è®¡ç®—å®Œæˆï¼ˆå«è·³è¿‡ï¼‰ï¼Œå¤„ç† ${count} æ¡é activity_package è®°å½•ã€‚`,"ok");
      state.modulesDone.discount = true;
      updateModuleButtonStyle("discount","done");
      renderTable();
      refreshStats();
    }

    function recalcActualDiscount(){
      if(!state.rows.length){
        log("æš‚æ— æ•°æ®ï¼Œæ— æ³•è®¡ç®—å–å‡ºçš„å®é™…æŠ˜æ‰£","warn");
        return;
      }
      const modulesExecuted = Object.values(state.modulesDone).some(v=>v);
      if (modulesExecuted){
        log("è­¦å‘Šï¼šå·²æœ‰æ¨¡å—ç»“æœï¼Œé‡ç®—æŠ˜æ‰£ä¸ä¼šå›æº¯ï¼Œè¯·å¿…è¦æ—¶é‡ç½®åå†è®¡ç®—ã€‚","warn");
      }
      let updated = 0;
      let warnCount = 0;
      state.rows.forEach(r=>{
        const pay = normalizeNumber(r["å›æ¬¾æ”¶æ¬¾é‡‘é¢"]);
        const bring = normalizeNumber(r["æ”¯ä»˜å¸¦å•ææˆç‚¹ä½"]);
        const qty = normalizeNumber(r["é”€å”®æ•°é‡"]);
        const list = normalizeNumber(r["ç³»ç»Ÿå®šä»·"]);

        if (pay!=null && qty && qty!==0 && list && list!==0){
          const basePay = (bring!=null)? (pay - bring) : pay;
          const disc = basePay / qty / list;
          if (isFinite(disc) && !isNaN(disc)){
            r["å–å‡ºçš„å®é™…æŠ˜æ‰£"] = parseFloat(disc.toFixed(4));
            updated++;
            if (disc < 0 || disc > 2){
              warnCount++;
            }
          }
        }
      });
      log(`é‡æ–°è®¡ç®—å–å‡ºçš„å®é™…æŠ˜æ‰£å®Œæˆï¼Œæ›´æ–° ${updated} è¡Œ${warnCount>0?`ï¼ˆå¼‚å¸¸æŠ˜æ‰£å€¼ï¼š${warnCount}ï¼‰`:''}ã€‚`,"ok");
      if (warnCount>0){
        log("å‘ç°æŠ˜æ‰£ <0 æˆ– >200% çš„å¼‚å¸¸è¡Œï¼Œè¯·æ ¸å¯¹æ•°æ®ã€‚","warn");
      }
      renderTable();
    }

    document.addEventListener("DOMContentLoaded", function(){
      const fileInput = document.getElementById("fileInput");
      const pickFileBtn = document.getElementById("pickFileBtn");
      const uploader = document.getElementById("uploader");

      pickFileBtn.addEventListener("click", ()=> fileInput.click());
      fileInput.addEventListener("change", handleFileUpload);

      uploader.addEventListener("dragover", e=>{
        e.preventDefault();
        uploader.classList.add("drag");
      });
      uploader.addEventListener("dragleave", ()=>{
        uploader.classList.remove("drag");
      });
      uploader.addEventListener("drop", e=>{
        e.preventDefault();
        uploader.classList.remove("drag");
        if (e.dataTransfer.files.length>0){
          handleFileUpload({target:{files:e.dataTransfer.files}});
        }
      });

      document.getElementById("btnSpecial").addEventListener("click", ()=> runModule("special"));
      document.getElementById("btnBoiler").addEventListener("click", ()=> runModule("boiler"));
      document.getElementById("btnActivity").addEventListener("click", ()=> runModule("activity"));
      document.getElementById("btnSmoke").addEventListener("click", ()=> runModule("smoke"));
      document.getElementById("btnNationalSubsidy").addEventListener("click", ()=> runModule("nationalSubsidy"));
      document.getElementById("btnDiscount").addEventListener("click", ()=> runModule("discount"));

      document.getElementById("searchInput").addEventListener("input", renderTable);
      document.getElementById("columnPreset").addEventListener("change", renderTable);
      document.getElementById("refreshBtn").addEventListener("click", renderTable);
      document.getElementById("resetBtn").addEventListener("click", resetData);
      document.getElementById("exportBtn").addEventListener("click", exportExcel);

      document.getElementById("btnRecalcActual").addEventListener("click", recalcActualDiscount);

      log("ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆã€‚");
      log("å·²å¯ç”¨ï¼šå…­åˆä¸€ææˆè®¡ç®—ï¼ˆç‰¹ä»·æœºã€å£æŒ‚ç‚‰ã€é”€å”®æ”¿ç­–ã€çƒŸç¶ã€å›½è¡¥ææˆã€æŠ˜æ‰£æœºï¼‰","ok");
      log("é”€å”®æ”¿ç­–è§„åˆ™ç²¾ç®€ï¼š70/75%æ¡£æ»¡æ¡£=4.5%ï¼Œæœªè¾¾=0ï¼›å›½è¡¥ææˆï¼šä»…é™2025.9.15-10.8æœŸé—´ï¼Œå‰4ä¸ªæ¨¡å—ä¸º0ä¸”è®¢å•ç±»å‹=éå›½è¡¥ä¸”æŠ˜æ‰£åœ¨(70.5%,75%)","ok");
      refreshStats();
    });

    function handleFileUpload(event){
      const file = event.target.files[0];
      if (!file) return;
      if (typeof XLSX === "undefined"){
        log("XLSX åº“æœªåŠ è½½ã€‚","error");
        return;
      }
      document.getElementById("fileName").textContent = file.name;
      log(`å¼€å§‹è¯»å–æ–‡ä»¶ï¼š${file.name}`);
      const reader = new FileReader();
      reader.onload = function(e){
        try {
          let workbook;
          if (file.name.endsWith('.csv')){
            const text = e.target.result;
            workbook = XLSX.read(text, {type:'string'});
          } else {
            workbook = XLSX.read(e.target.result, {type:'array'});
          }
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(firstSheet);
          if (!jsonData.length){
            log("æ–‡ä»¶ä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯ã€‚","error");
            return;
          }
          state.rawRows = jsonData;
          log(`æ–‡ä»¶è¯»å–å®Œæˆï¼ŒåŸå§‹è¡Œæ•°ï¼š${jsonData.length}`,"ok");
          standardizeData();
          document.getElementById("btnSpecial").disabled = false;
          document.getElementById("exportBtn").disabled = false;
          document.getElementById("btnRecalcActual").disabled = false;
        } catch (err){
          log(`æ–‡ä»¶è§£æå¤±è´¥ï¼š${err.message}`,"error");
        }
      };
      if (file.name.endsWith('.csv')){
        reader.readAsText(file, 'UTF-8');
      } else {
        reader.readAsArrayBuffer(file);
      }
    }

    function detectPreprocessFields(){
      state.hasCalcStatusField = state.rows.some(r=> Object.prototype.hasOwnProperty.call(r,"ææˆè®¡ç®—çŠ¶æ€"));
      state.hasPriorityField = state.rows.some(r=> Object.prototype.hasOwnProperty.call(r,"è®¡ç®—ä¼˜å…ˆçº§"));
      const hintEl = document.getElementById("preprocessHint");
      if (state.hasCalcStatusField && state.hasPriorityField){
        hintEl.textContent = "æ£€æµ‹åˆ°æ´»åŠ¨å¥—é¤é¢„å¤„ç†æ•°æ®ï¼Œå°†è·³è¿‡ activity_package è¡Œã€‚";
        hintEl.className = "preproc-detect ok";
        log("æ£€æµ‹åˆ°é¢„å¤„ç†å­—æ®µï¼šææˆè®¡ç®—çŠ¶æ€ & è®¡ç®—ä¼˜å…ˆçº§ï¼Œå¯ç”¨è·³è¿‡é€»è¾‘ã€‚","ok");
      } else {
        hintEl.textContent = "æœªæ£€æµ‹åˆ°é¢„å¤„ç†æ ‡è®°ï¼Œå°†å¯¹æ‰€æœ‰è¡Œæ­£å¸¸è®¡ç®—ã€‚";
        hintEl.className = "preproc-detect warn";
        log("æœªæ£€æµ‹åˆ°é¢„å¤„ç†å­—æ®µï¼Œå°†å¯¹å…¨éƒ¨è¡Œè®¡ç®—ã€‚","warn");
      }
    }

    function standardizeData(){
      state.rows = state.rawRows.map(raw=>{
        const row = {};
        Object.entries(raw).forEach(([key, value])=>{
          const mappedKey = FIELD_MAP[key] || key;
          row[mappedKey] = value;
        });
        Object.keys(row).forEach(k=>{
          if (k.endsWith("_desc")) {
            row[k] = normalizeString(row[k]);
          } else {
            if (["ä»·ç¨åˆè®¡","ç³»ç»Ÿå®šä»·","é”€å”®æ•°é‡","ä½³å°¼ç‰¹ç‰¹ä»·","å£æŒ‚ç‚‰é”€å”®æŠ˜æ‰£","å£æŒ‚ç‚‰ææˆåŸå§‹","é”€å”®æ”¿ç­–æŠ˜æ‰£ç‡","é”€å”®æ”¿ç­–ææˆåŸå§‹","é”€å”®æ”¿ç­–ææˆ","é”€å”®æ”¿ç­–åŠ æåŸå§‹","é”€å”®æ”¿ç­–åŠ æ","å›æ¬¾æ”¶æ¬¾é‡‘é¢","å–å‡ºçš„å®é™…æŠ˜æ‰£","è®¡ç®—ä¼˜å…ˆçº§","æ”¯ä»˜å¸¦å•ææˆç‚¹ä½"].includes(k)){
              row[k] = normalizeNumber(row[k]);
            } else if (["è®¢å•ç±»å‹","å•æ®ç±»å‹","ä¿ƒé”€å‘˜","å®¢æˆ·åº—å","è§„æ ¼å‹å·","ç‰©æ–™åç§°","å¤§ç±»å‹","æœºå‹","ææˆè®¡ç®—çŠ¶æ€"].includes(k)){
              row[k] = normalizeString(row[k]);
            } else {
              row[k] = normalizeString(row[k]);
            }
          }
        });
        deriveFinalDiscount(row);
        markReturn(row);
        return row;
      });
      log("å­—æ®µæ˜ å°„ä¸åˆæ­¥æ ‡å‡†åŒ–å®Œæˆã€‚","ok");
      detectPreprocessFields();
      renderTable();
      refreshStats();
    }

    function runModule(moduleName){
      if (state.running) {
        log("å·²æœ‰æ¨¡å—åœ¨è¿è¡Œä¸­ï¼Œè¯·ç­‰å¾…å®Œæˆã€‚","warn");
        return;
      }
      state.running = moduleName;
      updateModuleButtonStyle(moduleName, "running");
      setTimeout(()=>{
        try {
          switch(moduleName){
            case "special": calculateSpecial(); break;
            case "boiler": calculateBoiler(); break;
            case "activity": calculateActivity(); break;
            case "smoke": calculateSmoke(); break;
            case "nationalSubsidy": calculateNationalSubsidy(); break;
            case "discount": calculateDiscount(); break;
          }
        } catch (err){
          log(`æ¨¡å— ${moduleName} æ‰§è¡Œå¤±è´¥ï¼š${err.message}`,"error");
          updateModuleButtonStyle(moduleName, "error");
        } finally {
          state.running = null;
        }
      }, 80);
    }

    function resetData(){
      if (confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å’Œè®¡ç®—ç»“æœå—ï¼Ÿ")){
        state.rawRows = [];
        state.rows = [];
        state.logs = [];
        Object.keys(state.modulesDone).forEach(k=> state.modulesDone[k] = false);
        state.hasCalcStatusField = false;
        state.hasPriorityField = false;
        ["special","boiler","activity","smoke","nationalSubsidy","discount"].forEach(m=>{
          updateModuleButtonStyle(m, "reset");
          const btnMap = {
            special: "btnSpecial",
            boiler: "btnBoiler",
            activity: "btnActivity",
            smoke: "btnSmoke",
            nationalSubsidy: "btnNationalSubsidy",
            discount: "btnDiscount"
          };
          const btn = document.getElementById(btnMap[m]);
          if (btn) btn.disabled = m !== "special";
        });
        document.getElementById("unlockHint").textContent = "æŠ˜æ‰£æœºææˆå°šæœªè§£é”ï¼šè¯·å…ˆé¡ºåºå®Œæˆå‰äº”ä¸ªæ¨¡å—ã€‚";
        document.getElementById("fileName").textContent = "";
        document.getElementById("fileInput").value = "";
        document.getElementById("exportBtn").disabled = true;
        document.getElementById("tableWrap").style.display = "none";
        document.getElementById("logPanel").innerHTML = "";
        document.getElementById("preprocessHint").textContent = "";
        document.getElementById("preprocessHint").className="preproc-detect";
        document.getElementById("btnSpecial").disabled = true;
        document.getElementById("btnRecalcActual").disabled = true;
        log("æ•°æ®å·²æ¸…ç©ºã€‚");
        refreshStats();
      }
    }
  </script>
</body>
</html>
