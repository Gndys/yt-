<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel æ•°æ®åŒ¹é…å·¥å…· - A.O.å²å¯†æ–¯ä¸šåŠ¡å·¥å…·å¹³å°</title>
    
    <!-- ç»Ÿä¸€æ ·å¼ -->
    <link rel="stylesheet" href="../../common-styles.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* ==================== å¸ƒå±€ç»“æ„ ==================== */
        .main-layout {
            display: flex;
            gap: 0;
            min-height: calc(100vh - 48px);
        }

        /* ä¾§è¾¹æ­¥éª¤å¯¼èˆª */
        .step-navigator {
            width: 200px;
            background: var(--bg-card);
            border-right: 1px solid var(--border-light);
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            padding: var(--space-lg);
            flex-shrink: 0;
        }
        
        /* å¯éšè—å¯¼èˆª */
        @media (max-width: 1200px) {
            .step-navigator {
                width: 60px;
            }
            .nav-title,
            .nav-step-content {
                display: none;
            }
            .nav-step {
                padding: var(--space-sm);
                justify-content: center;
            }
        }

        .nav-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--space-lg);
        }

        .nav-steps {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .nav-step {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-md);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-normal) var(--transition);
            text-decoration: none;
            color: var(--text-primary);
        }

        .nav-step:hover {
            background: var(--bg-hover);
        }

        .nav-step.active {
            background: var(--accent-gold-light);
            color: var(--accent-blue);
        }

        .nav-step.completed .nav-step-icon {
            background: var(--color-success);
            color: white;
        }

        .nav-step-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-secondary);
            color: var(--text-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
            transition: all var(--transition-normal) var(--transition);
        }

        .nav-step.active .nav-step-icon {
            background: var(--accent-gold);
            color: var(--accent-blue);
        }

        .nav-step-content {
            flex: 1;
        }

        .nav-step-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .nav-step-subtitle {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            flex: 1;
            padding: var(--space-lg) var(--space-xl);
            overflow-x: hidden;
        }

        /* æ­¥éª¤åŒºå— */
        .step-section {
            margin-bottom: var(--space-xl);
            scroll-margin-top: var(--space-lg);
        }

        .step-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-md);
            padding-bottom: var(--space-sm);
            border-bottom: 2px solid var(--border-light);
        }

        .step-header-left {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .step-icon-large {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-lg);
            background: var(--accent-gold);
            color: var(--accent-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 20px;
        }

        .step-title-group h2 {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .step-subtitle {
            font-size: 14px;
            color: var(--text-tertiary);
        }

        /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ */
        .upload-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space-lg);
            margin-top: var(--space-lg);
        }

        .upload-card {
            border: 2px dashed var(--border-medium);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            text-align: center;
            background: var(--bg-card);
            cursor: pointer;
            transition: all var(--transition-normal) var(--transition);
            position: relative;
        }

        .upload-card:hover {
            border-color: var(--accent-gold);
            background: var(--accent-gold-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .upload-card.dragover {
            border-color: var(--color-success);
            background: var(--color-success-light);
            border-style: solid;
        }

        .upload-card.has-file {
            border-color: var(--color-success);
            background: var(--color-success-light);
            border-style: solid;
        }

        .upload-card.has-file::after {
            content: 'âœ“';
            position: absolute;
            top: var(--space-md);
            right: var(--space-md);
            width: 24px;
            height: 24px;
            background: var(--color-success);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            animation: checkmark 0.5s ease-out;
        }

        @keyframes checkmark {
            0% { transform: scale(0) rotate(0deg); }
            50% { transform: scale(1.2) rotate(180deg); }
            100% { transform: scale(1) rotate(360deg); }
        }

        .upload-card.optional {
            border-style: solid;
            border-color: var(--border-light);
        }

        .upload-card-header {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-sm);
            font-size: 14px;
        }

        .upload-tag {
            display: inline-block;
            font-size: 11px;
            padding: 2px 8px;
            background: var(--bg-secondary);
            color: var(--text-tertiary);
            border-radius: var(--radius-full);
            margin-left: var(--space-sm);
            font-weight: 500;
        }

        .upload-icon {
            font-size: 32px;
            margin-bottom: var(--space-sm);
            opacity: 0.7;
        }

        .upload-button {
            margin-top: var(--space-sm);
        }

        .file-info-display {
            margin-top: var(--space-sm);
            color: var(--color-success);
            font-size: 12px;
            font-weight: 500;
            display: none;
        }

        .sheet-selector-wrapper {
            margin-top: var(--space-sm);
            display: none;
        }

        .sheet-selector-wrapper select {
            width: 100%;
            padding: 8px var(--space-md);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-md);
            font-size: 13px;
            background: var(--bg-card);
        }

        .file-input {
            display: none;
        }

        /* æŠ˜å é¢æ¿ */
        .accordion {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .accordion-item {
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            background: var(--bg-card);
            overflow: hidden;
            margin-bottom: var(--space-sm);
        }

        .accordion-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-md) var(--space-lg);
            cursor: pointer;
            background: var(--bg-card);
            user-select: none;
        }

        .accordion-header:hover {
            background: var(--bg-hover);
        }

        .accordion-header-left {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            flex: 1;
        }

        .accordion-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .accordion-status {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .mapping-progress {
            font-size: 13px;
            color: var(--text-tertiary);
            background: var(--bg-secondary);
            padding: 4px var(--space-md);
            border-radius: var(--radius-full);
        }

        .mapping-progress.complete {
            background: var(--color-success-light);
            color: var(--color-success);
        }

        .accordion-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .accordion-content {
            display: none;
        }

        .accordion-item.expanded .accordion-content {
            display: block;
        }

        .accordion-body {
            padding: 0 var(--space-lg) var(--space-lg) var(--space-lg);
        }

        /* å­—æ®µæ˜ å°„è¡Œ */
        .mapping-grid {
            display: grid;
            gap: var(--space-sm);
        }

        .mapping-row {
            display: grid;
            grid-template-columns: 200px 1fr auto;
            gap: var(--space-md);
            align-items: center;
            padding: var(--space-md);
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            transition: all var(--transition-fast) var(--transition);
        }

        .mapping-row:hover {
            background: var(--bg-hover);
        }

        .mapping-row.matched {
            border: 1px solid var(--color-success);
            background: var(--color-success-light);
        }

        .mapping-label {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 14px;
        }

        .mapping-row select {
            padding: 8px var(--space-md);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-md);
            font-size: 13px;
            background: var(--bg-card);
            transition: all var(--transition-fast) var(--transition);
        }

        .mapping-row select:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 3px var(--accent-gold-light);
        }

        .mapping-source-tag {
            font-size: 11px;
            color: var(--text-tertiary);
            padding: 4px var(--space-sm);
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            white-space: nowrap;
        }

        /* æ™ºèƒ½æ˜ å°„æŒ‰é’® */
        .smart-mapping-section {
            margin-top: var(--space-lg);
            padding: var(--space-lg);
            background: var(--accent-blue-light);
            border-radius: var(--radius-lg);
            border: 1px solid var(--accent-blue);
            border-style: dashed;
        }

        .smart-mapping-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-lg);
        }

        .smart-mapping-info {
            flex: 1;
        }

        .smart-mapping-title {
            font-weight: 600;
            color: var(--accent-blue);
            margin-bottom: 4px;
        }

        .smart-mapping-desc {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* ç»“æœç­›é€‰å™¨ */
        .result-filters {
            display: flex;
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
            padding: var(--space-lg);
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: var(--space-sm);
            display: block;
        }

        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 8px var(--space-md);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-md);
            font-size: 14px;
        }

        /* ç»Ÿè®¡å¡ç‰‡åˆ†ç»„ */
        .stats-section {
            margin-bottom: var(--space-xl);
        }

        .stats-section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--space-md);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
        }

        .stat-card {
            padding: var(--space-md);
            background: var(--bg-card);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-light);
        }

        .stat-header {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin-bottom: var(--space-sm);
        }

        .stat-icon {
            font-size: 20px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-tertiary);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .stat-percentage {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        /* è¡¨æ ¼åˆ†é¡µ */
        .pagination-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: var(--space-lg) 0;
            padding: var(--space-md);
            background: var(--bg-card);
            border-radius: var(--radius-md);
        }

        .pagination-info {
            font-size: 14px;
            color: var(--text-tertiary);
        }

        .pagination-buttons {
            display: flex;
            gap: var(--space-sm);
        }

        .page-size-selector {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .page-size-selector select {
            padding: 6px var(--space-md);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-md);
            font-size: 13px;
        }

        /* è¯Šæ–­ä¿¡æ¯æŠ˜å  */
        .diagnostics-summary {
            padding: var(--space-lg);
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
            margin-bottom: var(--space-lg);
            cursor: pointer;
            transition: all var(--transition-normal) var(--transition);
        }

        .diagnostics-summary:hover {
            box-shadow: var(--shadow-sm);
        }

        .diagnostics-summary-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .diagnostics-summary-title {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            font-weight: 600;
            color: var(--text-primary);
        }

        .diagnostics-badges {
            display: flex;
            gap: var(--space-sm);
        }

        .diagnostics-badge {
            padding: 4px var(--space-md);
            border-radius: var(--radius-full);
            font-size: 12px;
            font-weight: 600;
        }

        .diagnostics-badge.error {
            background: var(--color-danger-light);
            color: var(--color-danger);
        }

        .diagnostics-badge.warning {
            background: var(--color-warning-light);
            color: var(--color-warning);
        }

        .diagnostics-badge.success {
            background: var(--color-success-light);
            color: var(--color-success);
        }

        .diagnostics-details {
            margin-top: var(--space-lg);
            padding-top: var(--space-lg);
            border-top: 1px solid var(--border-light);
            display: none;
        }

        .diagnostics-summary.expanded .diagnostics-details {
            display: block;
        }

        /* è¡¨æ ¼ä¼˜åŒ– */
        .table-container {
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            overflow: hidden;
            background: var(--bg-card);
        }

        .table-wrapper {
            overflow-x: auto;
            max-height: 70vh;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-light);
            font-size: 13px;
        }

        th {
            background: var(--accent-blue);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 5;
        }

        tbody tr {
            transition: background-color var(--transition-fast);
        }

        tbody tr:nth-child(even) {
            background: var(--bg-primary);
        }

        tbody tr:hover {
            background: var(--bg-hover);
        }

        /* é«˜äº®é‡è¦åˆ— */
        td.highlight {
            background: var(--accent-gold-light);
            font-weight: 600;
        }

        /* å“åº”å¼ */
        @media (max-width: 1024px) {
            .main-layout {
                flex-direction: column;
            }

            .step-navigator {
                width: 100%;
                height: auto;
                position: static;
                border-right: none;
                border-bottom: 1px solid var(--border-light);
            }

            .nav-steps {
                flex-direction: row;
                overflow-x: auto;
            }

            .nav-step {
                flex-shrink: 0;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                padding: var(--space-lg);
            }

            .upload-grid {
                grid-template-columns: 1fr;
            }

            .result-filters {
                flex-direction: column;
            }

            .filter-group {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="tool-container">
        <div class="tool-header">
            <a href="../../index.html" class="back-nav">â† è¿”å›é¦–é¡µ</a>
            <h1>ğŸ“Š Excel æ•°æ®åŒ¹é…å·¥å…·</h1>
            <p class="tool-subtitle">æ™ºèƒ½åŒ¹é…é”€å”®è®¢å•ã€æ”¶æ¬¾ã€å¸¦å•è´¹åŠæ”¿ç­–æ•°æ®</p>
            <div class="tool-badge">
                <span class="badge-dot"></span>
                <span>03-1 æ”¿ç­–åŒ¹é…å·¥å…·</span>
            </div>
        </div>

        <div class="main-layout">
            <!-- ä¾§è¾¹æ­¥éª¤å¯¼èˆª -->
            <div class="step-navigator">
                <div class="nav-title">æ“ä½œæµç¨‹</div>
                <div class="nav-steps">
                    <a href="#step-upload" class="nav-step active" data-step="1">
                        <div class="nav-step-icon">1</div>
                        <div class="nav-step-content">
                            <div class="nav-step-title">ä¸Šä¼ æ–‡ä»¶</div>
                            <div class="nav-step-subtitle">Excelæ•°æ®æ–‡ä»¶</div>
                        </div>
                    </a>
                    <a href="#step-mapping" class="nav-step" data-step="2">
                        <div class="nav-step-icon">2</div>
                        <div class="nav-step-content">
                            <div class="nav-step-title">é…ç½®æ˜ å°„</div>
                            <div class="nav-step-subtitle">å­—æ®µå¯¹åº”å…³ç³»</div>
                        </div>
                    </a>
                    <a href="#step-match" class="nav-step" data-step="3">
                        <div class="nav-step-icon">3</div>
                        <div class="nav-step-content">
                            <div class="nav-step-title">æ‰§è¡ŒåŒ¹é…</div>
                            <div class="nav-step-subtitle">å¼€å§‹å¤„ç†æ•°æ®</div>
                        </div>
                    </a>
                    <a href="#step-result" class="nav-step" data-step="4">
                        <div class="nav-step-icon">4</div>
                        <div class="nav-step-content">
                            <div class="nav-step-title">æŸ¥çœ‹ç»“æœ</div>
                            <div class="nav-step-subtitle">å¯¼å‡ºå¤„ç†ç»“æœ</div>
                        </div>
                    </a>
                </div>
            </div>

            <!-- ä¸»å†…å®¹åŒºåŸŸ -->
            <div class="main-content">
                <!-- æ­¥éª¤1: ä¸Šä¼ æ–‡ä»¶ -->
                <section class="step-section" id="step-upload">
                    <div class="step-header">
                        <div class="step-header-left">
                            <div class="step-icon-large">1</div>
                            <div class="step-title-group">
                                <h2>ä¸Šä¼ Excelæ–‡ä»¶</h2>
                                <div class="step-subtitle">æ”¯æŒ .xlsx å’Œ .xls æ ¼å¼</div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <strong>ğŸ“Œ å¿…éœ€ï¼š</strong>é”€å”®è®¢å•è¡¨ï¼ˆå«ç´¯è®¡æ”¶æ¬¾é‡‘é¢å­—æ®µï¼‰<br>
                        <strong>ğŸ“ å¯é€‰ï¼š</strong>æ”¶æ¬¾å•ã€å¸¦å•è´¹ã€æ”¿ç­–è¡¨ï¼ˆä¼šè‡ªåŠ¨åŠ è½½æ‰€æœ‰å­è¡¨ï¼‰
                    </div>

                    <div class="upload-grid">
                        <div class="upload-card" id="salesOrderBox" data-type="salesOrder">
                            <div class="upload-card-header">
                                é”€å”®è®¢å•è¡¨ <span style="color:var(--color-danger);">*</span>
                            </div>
                            <div class="upload-icon">ğŸ“„</div>
                            <input type="file" id="salesOrderFile" class="file-input" accept=".xlsx,.xls" />
                            <button class="btn btn-secondary btn-sm upload-button" onclick="document.getElementById('salesOrderFile').click()">
                                é€‰æ‹©æ–‡ä»¶
                            </button>
                            <div class="file-info-display" id="salesOrderInfo"></div>
                            <div class="sheet-selector-wrapper" id="salesOrderSheetSelector">
                                <select id="salesOrderSheet"></select>
                            </div>
                        </div>

                        <div class="upload-card optional" id="paymentBox" data-type="payment">
                            <div class="upload-card-header">
                                æ”¶æ¬¾å•è¡¨ <span class="upload-tag">å¯é€‰</span>
                            </div>
                            <div class="upload-icon">ğŸ’°</div>
                            <input type="file" id="paymentFile" class="file-input" accept=".xlsx,.xls" />
                            <button class="btn btn-secondary btn-sm upload-button" onclick="document.getElementById('paymentFile').click()">
                                é€‰æ‹©æ–‡ä»¶
                            </button>
                            <div class="file-info-display" id="paymentInfo"></div>
                            <div class="sheet-selector-wrapper" id="paymentSheetSelector">
                                <select id="paymentSheet"></select>
                            </div>
                        </div>

                        <div class="upload-card optional" id="commissionBox" data-type="commission">
                            <div class="upload-card-header">
                                å¸¦å•è´¹è¡¨ <span class="upload-tag">å¯é€‰</span>
                            </div>
                            <div class="upload-icon">ğŸ’µ</div>
                            <input type="file" id="commissionFile" class="file-input" accept=".xlsx,.xls" />
                            <button class="btn btn-secondary btn-sm upload-button" onclick="document.getElementById('commissionFile').click()">
                                é€‰æ‹©æ–‡ä»¶
                            </button>
                            <div class="file-info-display" id="commissionInfo"></div>
                            <div class="sheet-selector-wrapper" id="commissionSheetSelector">
                                <select id="commissionSheet"></select>
                            </div>
                        </div>

                        <div class="upload-card optional" id="policyBox" data-type="policy">
                            <div class="upload-card-header">
                                æ”¿ç­–è¡¨ <span class="upload-tag">å¯é€‰</span>
                            </div>
                            <div class="upload-icon">ğŸ“‹</div>
                            <input type="file" id="policyFile" class="file-input" accept=".xlsx,.xls" />
                            <button class="btn btn-secondary btn-sm upload-button" onclick="document.getElementById('policyFile').click()">
                                é€‰æ‹©æ–‡ä»¶
                            </button>
                            <div class="file-info-display" id="policyInfo"></div>
                        </div>
                    </div>
                </section>

                <!-- æ­¥éª¤2: é…ç½®å­—æ®µæ˜ å°„ -->
                <section class="step-section" id="step-mapping">
                    <div class="step-header">
                        <div class="step-header-left">
                            <div class="step-icon-large">2</div>
                            <div class="step-title-group">
                                <h2>é…ç½®å­—æ®µæ˜ å°„</h2>
                                <div class="step-subtitle">å°†Excelåˆ—åæ˜ å°„åˆ°å¯¹åº”å­—æ®µ</div>
                            </div>
                        </div>
                        <button class="btn btn-primary btn-sm" id="smartMappingBtn" onclick="quickSmartMapping()" style="display: none;">
                            âœ¨ ä¸€é”®æ™ºèƒ½æ˜ å°„
                        </button>
                    </div>

                    <div class="alert alert-info">
                        ğŸ’¡ ç³»ç»Ÿå·²æ™ºèƒ½è¯†åˆ«å¹¶é¢„é€‰å­—æ®µï¼Œæ‚¨å¯ä»¥æ‰‹åŠ¨è°ƒæ•´ã€‚ä½¿ç”¨"ä¸€é”®æ™ºèƒ½æ˜ å°„"å¯è‡ªåŠ¨å®Œæˆæ‰€æœ‰é…ç½®ã€‚
                    </div>

                    <div id="mappingContainer" class="accordion"></div>
                </section>

                <!-- æ­¥éª¤3: æ‰§è¡ŒåŒ¹é… -->
                <section class="step-section" id="step-match">
                    <div class="step-header">
                        <div class="step-header-left">
                            <div class="step-icon-large">3</div>
                            <div class="step-title-group">
                                <h2>æ‰§è¡ŒåŒ¹é…</h2>
                                <div class="step-subtitle">å¼€å§‹å¤„ç†å’ŒåŒ¹é…æ•°æ®</div>
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-primary btn-lg" id="matchBtn" onclick="performMatch()" disabled>
                        ğŸš€ å¼€å§‹åŒ¹é…
                    </button>
                </section>

                <!-- æ­¥éª¤4: ç»“æœå±•ç¤º -->
                <section class="step-section hidden" id="step-result">
                    <div class="step-header">
                        <div class="step-header-left">
                            <div class="step-icon-large">âœ“</div>
                            <div class="step-title-group">
                                <h2>åŒ¹é…ç»“æœ</h2>
                                <div class="step-subtitle">æ•°æ®å¤„ç†å®Œæˆ</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: var(--space-sm);">
                            <button class="btn btn-success" onclick="exportResult()">
                                ğŸ“¥ å¯¼å‡ºç»“æœ
                            </button>
                            <button class="btn btn-outline btn-sm" onclick="exportUnmatchedData()">
                                ğŸ” å¯¼å‡ºè¯Šæ–­æ•°æ®
                            </button>
                        </div>
                    </div>

                    <!-- è¯Šæ–­ä¿¡æ¯æ‘˜è¦ -->
                    <div id="diagnosticsSummary"></div>

                    <!-- ç»Ÿè®¡æ•°æ® -->
                    <div id="statsContainer"></div>

                    <!-- ç­›é€‰å™¨ -->
                    <div class="result-filters">
                        <div class="filter-group">
                            <label class="filter-label">è®¢å•ç±»å‹</label>
                            <select id="filterOrderType" onchange="applyFilters()">
                                <option value="">å…¨éƒ¨</option>
                                <option value="é€€è´§">é€€è´§</option>
                                <option value="å›½è¡¥">å›½è¡¥</option>
                                <option value="éå›½è¡¥">éå›½è¡¥</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">é—¨åº—ç­›é€‰</label>
                            <select id="filterStore" onchange="applyFilters()">
                                <option value="">å…¨éƒ¨é—¨åº—</option>
                            </select>
                        </div>
                        <div class="filter-group" style="flex: 2;">
                            <label class="filter-label">æœç´¢</label>
                            <input type="text" id="filterSearch" placeholder="è®¢å•å·ã€ç”¨æˆ·å§“åã€å‹å·..." onkeyup="applyFilters()">
                        </div>
                    </div>

                    <!-- åˆ†é¡µæ§åˆ¶ -->
                    <div class="pagination-controls">
                        <div class="page-size-selector">
                            <span style="font-size: 13px; color: var(--text-tertiary);">æ¯é¡µæ˜¾ç¤º</span>
                            <select id="pageSize" onchange="changePageSize()">
                                <option value="50">50</option>
                                <option value="100" selected>100</option>
                                <option value="200">200</option>
                                <option value="500">500</option>
                            </select>
                        </div>
                        <div class="pagination-info" id="paginationInfo"></div>
                        <div class="pagination-buttons">
                            <button class="btn btn-sm btn-outline" id="prevPageBtn" onclick="prevPage()">
                                â† ä¸Šä¸€é¡µ
                            </button>
                            <button class="btn btn-sm btn-outline" id="nextPageBtn" onclick="nextPage()">
                                ä¸‹ä¸€é¡µ â†’
                            </button>
                        </div>
                    </div>

                    <!-- ç»“æœè¡¨æ ¼ -->
                    <div class="table-container">
                        <div class="table-wrapper">
                            <table id="resultTable">
                                <thead>
                                    <tr id="resultTableHeader"></tr>
                                </thead>
                                <tbody id="resultTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€æ•°æ®å­˜å‚¨
        const dataStore = {
            salesOrder: { data: null, headers: [], workbook: null },
            payment: { data: null, headers: [], workbook: null },
            commission: { data: null, headers: [], workbook: null },
            policy: { 
                workbook: null,
                sheets: {
                    specialMachine: { data: null, headers: [] },
                    chanet: { data: null, headers: [] },
                    boiler: { data: null, headers: [] },
                    activity: [], // æ”¹ä¸ºæ•°ç»„ï¼Œæ”¯æŒå¤šä¸ªæ—¶é—´æ®µçš„æ´»åŠ¨å­è¡¨
                    priceTable: { data: null, headers: [] }
                }
            }
        };

        let matchResult = [];
        let filteredMatchResult = []; // ç­›é€‰åçš„ç»“æœ
        let currentPage = 1;
        let pageSize = 100;
        
        let matchDiagnostics = {
            similarOrderNumbers: [],
            unmatchedOrders: [],
            unmatchedPayments: [],
            paymentMatches: []
        };

        // é—¨åº—ç™½åå•ï¼šåªä¿ç•™è¿™äº›é—¨åº—çš„æ•°æ®
        const storeWhitelist = [
            'ï¼ˆæ–°ï¼‰æ»¨æ±Ÿç¬¬å…­ç©ºé—´ä¸“å–åº—',
            'æ»¨æ±Ÿå…­ç©º8090åº—',
            'æ­å·æ’å¤§å»ºæè¶…çº§æ——èˆ°åº—',
            'æ­å·çº¢æ˜Ÿç¾å‡¯é¾™ä¸€å·åº—',
            'æ­å·ä¸´å¹³æ±Ÿå—å®¶å±…ä¸“å–åº—',
            'é‡‘åé¾™è…¾å»ºæå¸‚åœºä¸“å–åº—',
            'è§å±±ç¬¬å…­ç©ºé—´ä¸“å–åº—'
        ];

        // é—¨åº—è¿‡æ»¤ç»Ÿè®¡
        let filterStats = {
            originalCount: 0,
            filteredCount: 0,
            removedCount: 0
        };

        // ==================== åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', function() {
            initNavigation();
            initDragAndDrop();
        });

        // ==================== ä¾§è¾¹å¯¼èˆª ====================
        function initNavigation() {
            const navSteps = document.querySelectorAll('.nav-step');
            navSteps.forEach(step => {
                step.addEventListener('click', function(e) {
                    e.preventDefault();
                    const target = this.getAttribute('href');
                    const targetElement = document.querySelector(target);
                    if (targetElement) {
                        targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        updateActiveNav(this.dataset.step);
                    }
                });
            });

            // ç›‘å¬æ»šåŠ¨æ›´æ–°æ¿€æ´»çŠ¶æ€ï¼ˆä¼˜åŒ–æ€§èƒ½ï¼‰
            let scrollTimeout;
            window.addEventListener('scroll', function() {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    const sections = document.querySelectorAll('.step-section');
                    const stepMap = {
                        'step-upload': '1',
                        'step-mapping': '2',
                        'step-match': '3',
                        'step-result': '4'
                    };
                    
                    for (let section of sections) {
                        const rect = section.getBoundingClientRect();
                        if (rect.top <= 100 && rect.bottom >= 100) {
                            const stepNum = stepMap[section.id];
                            if (stepNum) {
                                updateActiveNav(stepNum);
                                break;
                            }
                        }
                    }
                }, 100);
            }, { passive: true });
        }

        function updateActiveNav(stepNumber) {
            const navSteps = document.querySelectorAll('.nav-step');
            navSteps.forEach(step => {
                if (step.dataset.step === stepNumber) {
                    step.classList.add('active');
                } else {
                    step.classList.remove('active');
                }
            });
        }

        function markStepCompleted(stepNumber) {
            const navStep = document.querySelector(`.nav-step[data-step="${stepNumber}"]`);
            if (navStep) {
                navStep.classList.add('completed');
            }
        }

        // ==================== æ‹–æ‹½ä¸Šä¼  ====================
        function initDragAndDrop() {
            const uploadCards = document.querySelectorAll('.upload-card');
            uploadCards.forEach(card => {
                const fileType = card.dataset.type;
                const fileInput = document.getElementById(fileType + 'File');

                card.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    this.classList.add('dragover');
                });

                card.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    this.classList.remove('dragover');
                });

                card.addEventListener('drop', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    this.classList.remove('dragover');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        const file = files[0];
                        if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                            // åˆ›å»ºä¸€ä¸ªæ–°çš„ FileList å¯¹è±¡å¹¶è§¦å‘ change äº‹ä»¶
                            const dataTransfer = new DataTransfer();
                            dataTransfer.items.add(file);
                            fileInput.files = dataTransfer.files;
                            fileInput.dispatchEvent(new Event('change', { bubbles: true }));
                        } else {
                            alert('è¯·ä¸Šä¼  Excel æ–‡ä»¶ï¼ˆ.xlsx æˆ– .xlsï¼‰');
                        }
                    }
                });
            });
        }

        // è®¢å•ç¼–å·è§„èŒƒåŒ–å‡½æ•°ï¼šå¤„ç†ç©ºç™½å­—ç¬¦å’Œéšè—å­—ç¬¦
        function normalizeOrderNumber(value) {
            if (value === null || value === undefined || value === '') {
                return '';
            }
            
            // è½¬æ¢ä¸ºå­—ç¬¦ä¸²
            let str = value.toString();
            
            // ç§»é™¤æ‰€æœ‰ç±»å‹çš„ç©ºç™½å­—ç¬¦ï¼ˆåŒ…æ‹¬æ™®é€šç©ºæ ¼ã€åˆ¶è¡¨ç¬¦ã€æ¢è¡Œç¬¦ã€é›¶å®½ç©ºæ ¼ç­‰ï¼‰
            str = str.replace(/[\s\u200B-\u200D\uFEFF]/g, '');
            
            // ç§»é™¤å…¶ä»–æ§åˆ¶å­—ç¬¦
            str = str.replace(/[\x00-\x1F\x7F]/g, '');
            
            return str;
        }

        // æ£€æµ‹ç›¸ä¼¼è®¢å•ç¼–å·ï¼šæ‰¾å‡ºåªç›¸å·®åç¼€çš„è®¢å•å·
        function detectSimilarOrderNumbers(orderNumbers) {
            const similar = [];
            const sortedNumbers = [...orderNumbers].sort();
            
            for (let i = 0; i < sortedNumbers.length; i++) {
                for (let j = i + 1; j < sortedNumbers.length; j++) {
                    const num1 = sortedNumbers[i];
                    const num2 = sortedNumbers[j];
                    
                    // æ£€æŸ¥æ˜¯å¦ä¸€ä¸ªæ˜¯å¦ä¸€ä¸ªçš„å‰ç¼€
                    if (num2.startsWith(num1) && num2.length > num1.length) {
                        const suffix = num2.substring(num1.length);
                        // å¦‚æœåç¼€æ˜¯ "-æ•°å­—" æ ¼å¼ï¼Œåˆ™è®¤ä¸ºç›¸ä¼¼
                        if (/^-\d+$/.test(suffix)) {
                            similar.push({ base: num1, extended: num2, suffix: suffix });
                        }
                    }
                }
            }
            
            return similar;
        }

        // æ•°å€¼è§„èŒƒåŒ–å‡½æ•°ï¼šå¤„ç†æŠ˜æ‰£ç‡ç­‰ç™¾åˆ†æ¯”å­—æ®µçš„æµ®ç‚¹ç²¾åº¦é—®é¢˜
        function normalizePercentage(value) {
            if (value === null || value === undefined || value === '') {
                return value;
            }
            
            const num = parseFloat(value);
            if (isNaN(num)) {
                return value;
            }
            
            // ç»Ÿä¸€ä¿ç•™ä¸¤ä½å°æ•°ï¼ˆå››èˆäº”å…¥ï¼‰
            return parseFloat(num.toFixed(2));
        }

        // æ—¥æœŸè§£æå‡½æ•°ï¼šæ”¯æŒå¤šç§æ—¥æœŸæ ¼å¼
        function parseDate(value) {
            if (!value) return null;
            
            let str = value.toString().trim();
            
            // å°è¯•å°† "2025.9.15" æ ¼å¼è½¬æ¢ä¸ºæ ‡å‡†æ ¼å¼
            str = str.replace(/\./g, '/');
            
            // å°è¯•è§£ææ—¥æœŸ
            const date = new Date(str);
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆæ—¥æœŸ
            if (isNaN(date.getTime())) {
                return null;
            }
            
            return date;
        }

        // æ ¹æ®è®¢å•æ—¥æœŸæŸ¥æ‰¾åŒ¹é…çš„é”€å”®æ”¿ç­–å­è¡¨
        function findMatchingActivitySheet(orderDate) {
            if (!orderDate) return null;
            
            const orderTimestamp = parseDate(orderDate);
            if (!orderTimestamp) return null;
            
            const activitySheets = dataStore.policy.sheets.activity;
            
            for (let sheet of activitySheets) {
                const startTimestamp = parseDate(sheet.startDate);
                const endTimestamp = parseDate(sheet.endDate);
                
                if (startTimestamp && endTimestamp) {
                    if (orderTimestamp >= startTimestamp && orderTimestamp <= endTimestamp) {
                        return sheet;
                    }
                }
            }
            
            return null; // æœªæ‰¾åˆ°åŒ¹é…çš„æ”¿ç­–æ—¶é—´æ®µ
        }

        // å­—æ®µé…ç½®
        const fieldConfigs = {
            salesOrder: {
                title: 'é”€å”®è®¢å•',
                fields: [
                    { key: 'date', label: 'æ—¥æœŸ', matchKey: 'æ—¥æœŸ' },
                    { key: 'docNumber', label: 'å•æ®ç¼–å·', matchKey: 'å•æ®ç¼–å·' },
                    { key: 'userName', label: 'ç”¨æˆ·å§“å', matchKey: 'ç”¨æˆ·å§“å' },
                    { key: 'model', label: 'è§„æ ¼å‹å·', matchKey: 'è§„æ ¼å‹å·' },
                    { key: 'quantity', label: 'é”€å”®æ•°é‡', matchKey: 'é”€å”®æ•°é‡' },
                    { key: 'totalAmount', label: 'ä»·ç¨åˆè®¡', matchKey: 'ä»·ç¨åˆè®¡' },
                    { key: 'systemPrice', label: 'ç³»ç»Ÿå®šä»·', matchKey: 'ç³»ç»Ÿå®šä»·' },
                    { key: 'materialName', label: 'ç‰©æ–™åç§°', matchKey: 'ç‰©æ–™åç§°' },
                    { key: 'materialCategory', label: 'ç‰©æ–™ç±»åˆ«', matchKey: 'ç‰©æ–™ç±»åˆ«' },
                    { key: 'promoter', label: 'ä¿ƒé”€å‘˜', matchKey: 'ä¿ƒé”€å‘˜' },
                    { key: 'storeName', label: 'å®¢æˆ·åº—å', matchKey: 'å®¢æˆ·' },
                    { key: 'docType', label: 'å•æ®ç±»å‹', matchKey: 'å•æ®ç±»å‹' },
                    { key: 'paymentAmount', label: 'å›æ¬¾æ”¶æ¬¾é‡‘é¢', matchKey: 'ç´¯è®¡æ”¶æ¬¾é‡‘é¢' }
                ]
            },
            payment: {
                title: 'æ”¶æ¬¾å•',
                fields: [
                    { key: 'docNumber', label: 'å•æ®ç¼–å·', matchKey: 'é”€å”®è®¢å•å·' },
                    { key: 'amount', label: 'å›æ¬¾æ”¶æ¬¾é‡‘é¢', matchKey: 'æ”¶æ¬¾é‡‘é¢' }
                ],
                matchBy: 'docNumber'
            },
            commission: {
                title: 'å¸¦å•è´¹',
                fields: [
                    { key: 'docNumber', label: 'å•å·', matchKey: 'å•å·' },
                    { key: 'commissionRate', label: 'æ”¯ä»˜å¸¦å•ææˆç‚¹ä½', matchKey: 'æ”¯ä»˜å¸¦å•ææˆç‚¹ä½' },
                    { key: 'actualDiscount', label: 'å–å‡ºçš„å®é™…æŠ˜æ‰£', matchKey: 'æŠ˜æ‰£' }
                ],
                matchBy: 'docNumber'
            },
            policySpecialMachine: {
                title: 'æ”¿ç­–è¡¨ - ç‰¹ä»·æœºæ•´ç†',
                sheetName: 'ç‰¹ä»·æœºæ•´ç†',
                fields: [
                    { key: 'machineModel', label: 'æœºå‹', matchKey: 'æœºå‹' },
                    { key: 'largeType', label: 'å¤§ç±»å‹', matchKey: 'å¤§ç±»å‹' },
                    { key: 'commissionPlan', label: 'ç‰¹ä»·æœºææˆè®¡ç®—æ–¹æ¡ˆ', matchKey: 'ææˆè®¡ç®—' },
                    { key: 'minDiscount', label: 'ç‰¹ä»·æœºå…¬å¸æœ€ä½æŠ˜æ‰£', matchKey: 'å…¬å¸æœ€ä½æŠ˜æ‰£' }
                ],
                matchBy: 'model',
                matchKey: 'å‹å·'
            },
            policyChanet: {
                title: 'æ”¿ç­–è¡¨ - ä½³å°¼ç‰¹',
                sheetName: 'ä½³å°¼ç‰¹',
                fields: [
                    { key: 'chanetSpecial', label: 'ä½³å°¼ç‰¹ç‰¹ä»·', matchKey: 'ç‰¹ä»·' }
                ],
                matchBy: 'model',
                matchKey: 'å‹å·'
            },
            policyBoiler: {
                title: 'æ”¿ç­–è¡¨ - å£æŒ‚ç‚‰',
                sheetName: 'å£æŒ‚ç‚‰',
                fields: [
                    { key: 'boilerDiscount', label: 'å£æŒ‚ç‚‰é”€å”®æŠ˜æ‰£', matchKey: 'é”€å”®æŠ˜æ‰£' },
                    { key: 'boilerCommission', label: 'å£æŒ‚ç‚‰ææˆåŸå§‹', matchKey: 'ææˆ' }
                ],
                matchBy: 'model',
                matchKey: 'å‹å·'
            },
            policyActivity: {
                title: 'æ”¿ç­–è¡¨ - é”€å”®æ”¿ç­–',
                sheetName: 'æ´»åŠ¨',
                fields: [
                    { key: 'activityDiscount', label: 'é”€å”®æ”¿ç­–æŠ˜æ‰£ç‡', matchKey: 'æŠ˜æ‰£ç‡' },
                    { key: 'activityCommission', label: 'é”€å”®æ”¿ç­–ææˆåŸå§‹', matchKey: 'ææˆ' },
                    { key: 'activityExtra', label: 'é”€å”®æ”¿ç­–åŠ æåŸå§‹', matchKey: 'åŠ æ' },
                    { key: 'activityRequire', label: 'é”€å”®æ”¿ç­–è¦æ±‚', matchKey: 'åŠ æè¦æ±‚' }
                ],
                matchBy: 'model',
                matchKey: 'å‹å·'
            },
            policyPriceTable: {
                title: 'æ”¿ç­–è¡¨ - æ ‡ä»·',
                sheetName: 'æ ‡ä»·',
                fields: [
                    { key: 'largeType', label: 'å¤§ç±»å‹', matchKey: 'å¤§ç±»å‹' }
                ],
                matchBy: 'model',
                matchKey: 'å‹å·'
            }
        };

        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        document.getElementById('salesOrderFile').addEventListener('change', function(e) {
            handleFileUpload(e, 'salesOrder');
        });

        document.getElementById('paymentFile').addEventListener('change', function(e) {
            handleFileUpload(e, 'payment');
        });

        document.getElementById('commissionFile').addEventListener('change', function(e) {
            handleFileUpload(e, 'commission');
        });

        document.getElementById('policyFile').addEventListener('change', function(e) {
            handleFileUpload(e, 'policy');
        });

        function handleFileUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                const boxId = type + 'Box';
                const infoId = type + 'Info';
                
                document.getElementById(boxId).classList.add('has-file');
                document.getElementById(infoId).style.display = 'block';
                document.getElementById(infoId).textContent = `âœ“ ${file.name}`;
                
                // æ ‡è®°æ­¥éª¤1å®Œæˆ
                markStepCompleted('1');
                
                if (type === 'policy') {
                    // æ”¿ç­–è¡¨ç‰¹æ®Šå¤„ç†ï¼šåŠ è½½æ‰€æœ‰å­è¡¨
                    dataStore.policy.workbook = workbook;
                    loadPolicySheets(workbook);
                } else {
                    // æ˜¾ç¤ºå­è¡¨é€‰æ‹©å™¨
                    const selectorId = type + 'SheetSelector';
                    const selectId = type + 'Sheet';
                    
                    const sheetSelector = document.getElementById(selectorId);
                    sheetSelector.style.display = 'block';
                    
                    const select = document.getElementById(selectId);
                    select.innerHTML = '';
                    workbook.SheetNames.forEach((sheetName, index) => {
                        const option = document.createElement('option');
                        option.value = index;
                        option.textContent = sheetName;
                        select.appendChild(option);
                    });

                    // é»˜è®¤åŠ è½½ç¬¬ä¸€ä¸ªå­è¡¨
                    select.onchange = function() {
                        loadSheet(workbook, select.value, type);
                    };
                    
                    loadSheet(workbook, 0, type);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function loadSheet(workbook, sheetIndex, type) {
            const sheetName = workbook.SheetNames[sheetIndex];
            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            if (jsonData.length === 0) return;

            // è·³è¿‡å‰é¢çš„ç©ºç™½è¡Œï¼Œæ‰¾åˆ°å®é™…è¡¨å¤´
            let headerRowIndex = 0;
            for (let i = 0; i < Math.min(jsonData.length, 5); i++) {
                const row = jsonData[i];
                // æ£€æŸ¥è¿™ä¸€è¡Œæ˜¯å¦æœ‰æœ‰æ•ˆå†…å®¹ï¼ˆéç©ºä¸”éå…¨ç©ºï¼‰
                const hasContent = row.some(cell => cell !== null && cell !== undefined && cell !== '' && cell !== 0);
                if (hasContent) {
                    // æ£€æŸ¥æ˜¯å¦åƒè¡¨å¤´ï¼ˆå­—ç¬¦ä¸²å†…å®¹è¾ƒå¤šï¼‰
                    const stringCells = row.filter(cell => typeof cell === 'string' && cell.trim() !== '');
                    if (stringCells.length >= 2) {
                        headerRowIndex = i;
                        break;
                    }
                }
            }

            // ç¬¬ä¸€è¡Œä½œä¸ºè¡¨å¤´
            const headers = jsonData[headerRowIndex];
            const rows = jsonData.slice(headerRowIndex + 1).filter(row => row.some(cell => cell !== null && cell !== undefined && cell !== ''));

            dataStore[type].headers = headers;
            dataStore[type].data = rows;
            dataStore[type].workbook = workbook;

            console.log(`${type} è¯»å–æˆåŠŸ: è¡¨å¤´è¡Œ=${headerRowIndex}, æ•°æ®è¡Œæ•°=${rows.length}`);
            console.log(`${type} è¡¨å¤´:`, headers);

            updateMappingUI();
            checkReadyToMatch();
        }

        function loadPolicySheets(workbook) {
            // éæ´»åŠ¨ç±»å­è¡¨æ˜ å°„ï¼ˆä¿æŒåŸé€»è¾‘ï¼‰
            const sheetMappings = [
                { configKey: 'policySpecialMachine', storeKey: 'specialMachine', name: 'ç‰¹ä»·æœºæ•´ç†' },
                { configKey: 'policyChanet', storeKey: 'chanet', name: 'ä½³å°¼ç‰¹' },
                { configKey: 'policyBoiler', storeKey: 'boiler', name: 'å£æŒ‚ç‚‰' },
                { configKey: 'policyPriceTable', storeKey: 'priceTable', name: 'æ ‡ä»·' }
            ];

            // åŠ è½½éæ´»åŠ¨ç±»å­è¡¨
            sheetMappings.forEach(mapping => {
                const sheetIndex = workbook.SheetNames.indexOf(mapping.name);
                if (sheetIndex !== -1) {
                    const worksheet = workbook.Sheets[mapping.name];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (jsonData.length > 0) {
                        // è·³è¿‡å‰é¢çš„ç©ºç™½è¡Œï¼Œæ‰¾åˆ°å®é™…è¡¨å¤´
                        let headerRowIndex = 0;
                        for (let i = 0; i < Math.min(jsonData.length, 5); i++) {
                            const row = jsonData[i];
                            const hasContent = row.some(cell => cell !== null && cell !== undefined && cell !== '' && cell !== 0);
                            if (hasContent) {
                                const stringCells = row.filter(cell => typeof cell === 'string' && cell.trim() !== '');
                                if (stringCells.length >= 2) {
                                    headerRowIndex = i;
                                    break;
                                }
                            }
                        }
                        
                        const headers = jsonData[headerRowIndex];
                        const rows = jsonData.slice(headerRowIndex + 1).filter(row => row.some(cell => cell !== null && cell !== undefined && cell !== ''));
                        
                        dataStore.policy.sheets[mapping.storeKey].headers = headers;
                        dataStore.policy.sheets[mapping.storeKey].data = rows;
                        
                        console.log(`æ”¿ç­–è¡¨-${mapping.name} è¯»å–æˆåŠŸ: è¡¨å¤´è¡Œ=${headerRowIndex}, æ•°æ®è¡Œæ•°=${rows.length}`);
                    }
                }
            });

            // åŠ è½½æ‰€æœ‰ä»¥"æ´»åŠ¨"å¼€å¤´çš„å­è¡¨ï¼ˆæ”¯æŒå¤šä¸ªæ—¶é—´æ®µï¼‰
            dataStore.policy.sheets.activity = []; // æ¸…ç©ºæ´»åŠ¨æ•°ç»„
            
            workbook.SheetNames.forEach(sheetName => {
                // è¯†åˆ«æ‰€æœ‰ä»¥"æ´»åŠ¨"å¼€å¤´çš„å­è¡¨
                if (sheetName.startsWith('æ´»åŠ¨')) {
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (jsonData.length > 0) {
                        // è·³è¿‡å‰é¢çš„ç©ºç™½è¡Œï¼Œæ‰¾åˆ°å®é™…è¡¨å¤´
                        let headerRowIndex = 0;
                        for (let i = 0; i < Math.min(jsonData.length, 5); i++) {
                            const row = jsonData[i];
                            const hasContent = row.some(cell => cell !== null && cell !== undefined && cell !== '' && cell !== 0);
                            if (hasContent) {
                                const stringCells = row.filter(cell => typeof cell === 'string' && cell.trim() !== '');
                                if (stringCells.length >= 2) {
                                    headerRowIndex = i;
                                    break;
                                }
                            }
                        }
                        
                        const headers = jsonData[headerRowIndex];
                        const rows = jsonData.slice(headerRowIndex + 1).filter(row => row.some(cell => cell !== null && cell !== undefined && cell !== ''));
                        
                        // ä»ç¬¬ä¸€è¡Œæ•°æ®ä¸­æå–å¼€å§‹å’Œç»“æŸæ—¶é—´ï¼ˆMåˆ—å’ŒNåˆ—ï¼Œç´¢å¼•12å’Œ13ï¼‰
                        let startDate = null;
                        let endDate = null;
                        
                        if (rows.length > 0) {
                            const firstRow = rows[0];
                            // Måˆ—ï¼šæ”¿ç­–å¼€å§‹æ—¶é—´ï¼ˆç´¢å¼•12ï¼‰
                            if (firstRow[12]) {
                                startDate = firstRow[12];
                            }
                            // Nåˆ—ï¼šæ”¿ç­–ç»“æŸæ—¶é—´ï¼ˆç´¢å¼•13ï¼‰
                            if (firstRow[13]) {
                                endDate = firstRow[13];
                            }
                        }
                        
                        // æ·»åŠ åˆ°æ´»åŠ¨æ•°ç»„
                        dataStore.policy.sheets.activity.push({
                            sheetName: sheetName,
                            startDate: startDate,
                            endDate: endDate,
                            headers: headers,
                            data: rows
                        });
                        
                        console.log(`æ”¿ç­–è¡¨-${sheetName} è¯»å–æˆåŠŸ: è¡¨å¤´è¡Œ=${headerRowIndex}, æ•°æ®è¡Œæ•°=${rows.length}, æ—¶é—´æ®µ=${startDate} è‡³ ${endDate}`);
                    }
                }
            });

            console.log(`å…±åŠ è½½ ${dataStore.policy.sheets.activity.length} ä¸ªæ´»åŠ¨å­è¡¨`);

            // åœ¨ç•Œé¢ä¸Šæ˜¾ç¤ºå·²åŠ è½½çš„æ´»åŠ¨å­è¡¨æ—¶é—´æ®µä¿¡æ¯
            displayActivitySheetsInfo();

            updateMappingUI();
            checkReadyToMatch();
        }

        // æ˜¾ç¤ºå·²åŠ è½½çš„æ´»åŠ¨å­è¡¨æ—¶é—´æ®µä¿¡æ¯
        function displayActivitySheetsInfo() {
            const infoElement = document.getElementById('policyInfo');
            if (!infoElement) return;
            
            const activitySheets = dataStore.policy.sheets.activity;
            if (activitySheets.length === 0) {
                infoElement.innerHTML = 'âœ“ æ”¿ç­–è¡¨å·²åŠ è½½ï¼ˆæœªæ‰¾åˆ°æ´»åŠ¨å­è¡¨ï¼‰';
                return;
            }
            
            let infoHtml = `âœ“ æ”¿ç­–è¡¨å·²åŠ è½½<br><small style="color: #4299e1; margin-top: 4px; display: block;">`;
            infoHtml += `ğŸ“… é”€å”®æ”¿ç­–æ—¶é—´æ®µï¼ˆ${activitySheets.length}ä¸ªï¼‰ï¼š<br>`;
            
            let hasWarning = false;
            activitySheets.forEach((sheet, index) => {
                if (sheet.startDate && sheet.endDate) {
                    infoHtml += `  ${index + 1}. ${sheet.sheetName}: ${sheet.startDate} ~ ${sheet.endDate}<br>`;
                } else {
                    infoHtml += `  ${index + 1}. ${sheet.sheetName}: <span style="color: #ed8936;">æœªè®¾ç½®æ—¶é—´æ®µï¼ˆå°†åŒ¹é…æ‰€æœ‰è®¢å•ï¼‰</span><br>`;
                    hasWarning = true;
                }
            });
            
            if (hasWarning) {
                infoHtml += `<br><span style="color: #ed8936;">âš ï¸ æç¤ºï¼šæœªè®¾ç½®æ—¶é—´æ®µçš„å­è¡¨å°†å¯¹æ‰€æœ‰è®¢å•ç”Ÿæ•ˆï¼Œä¸ä¼šæ ¹æ®æ—¥æœŸç­›é€‰ã€‚</span><br>`;
                infoHtml += `<span style="color: #718096;">å»ºè®®åœ¨Måˆ—å’ŒNåˆ—è®¾ç½®æ—¶é—´æ®µä»¥å¯ç”¨æ—¥æœŸåŒ¹é…åŠŸèƒ½ã€‚</span>`;
            }
            
            infoHtml += `</small>`;
            infoElement.innerHTML = infoHtml;
        }

        function updateMappingUI() {
            const container = document.getElementById('mappingContainer');
            container.innerHTML = '';

            // æ˜¾ç¤ºæ™ºèƒ½æ˜ å°„æŒ‰é’®
            document.getElementById('smartMappingBtn').style.display = 'inline-flex';

            // é”€å”®è®¢å•æ˜ å°„ï¼ˆé»˜è®¤æŠ˜å ï¼Œå¿…éœ€ï¼‰
            if (dataStore.salesOrder.data) {
                createMappingAccordion('salesOrder', fieldConfigs.salesOrder, dataStore.salesOrder.headers, container, true, false);
            }

            // æ”¶æ¬¾å•æ˜ å°„ï¼ˆå¯é€‰ï¼Œé»˜è®¤æŠ˜å ï¼‰
            if (dataStore.payment.data) {
                createMappingAccordion('payment', fieldConfigs.payment, dataStore.payment.headers, container, false, false);
            }

            // å¸¦å•è´¹æ˜ å°„ï¼ˆå¯é€‰ï¼Œé»˜è®¤æŠ˜å ï¼‰
            if (dataStore.commission.data) {
                createMappingAccordion('commission', fieldConfigs.commission, dataStore.commission.headers, container, false, false);
            }

            // æ”¿ç­–è¡¨å„å­è¡¨æ˜ å°„
            if (dataStore.policy.workbook) {
                const policyConfigs = [
                    { key: 'policySpecialMachine', storeKey: 'specialMachine', title: 'ç‰¹ä»·æœºæ•´ç†' },
                    { key: 'policyChanet', storeKey: 'chanet', title: 'ä½³å°¼ç‰¹' },
                    { key: 'policyBoiler', storeKey: 'boiler', title: 'å£æŒ‚ç‚‰' },
                    { key: 'policyPriceTable', storeKey: 'priceTable', title: 'æ ‡ä»·' }
                ];

                policyConfigs.forEach(cfg => {
                    const sheetData = dataStore.policy.sheets[cfg.storeKey];
                    if (sheetData.data && sheetData.data.length > 0) {
                        createMappingAccordion(cfg.key, fieldConfigs[cfg.key], sheetData.headers, container, false, false);
                    }
                });

                // åˆå¹¶æ‰€æœ‰æ´»åŠ¨å­è¡¨æ˜ å°„ï¼ˆç»Ÿä¸€é…ç½®ï¼‰
                if (dataStore.policy.sheets.activity.length > 0) {
                    const firstActivitySheet = dataStore.policy.sheets.activity[0];
                    const mergedConfig = {
                        ...fieldConfigs.policyActivity,
                        title: `æ”¿ç­–è¡¨ - é”€å”®æ”¿ç­– (${dataStore.policy.sheets.activity.length}ä¸ªæ—¶é—´æ®µ)`
                    };
                    createMappingAccordion('policyActivity_0', mergedConfig, firstActivitySheet.headers, container, false, false, true);
                }
            }

            // æ ‡è®°æ­¥éª¤2å®Œæˆ
            markStepCompleted('2');
        }

        function createMappingAccordion(configKey, config, headers, container, isRequired = false, defaultExpanded = false, isMerged = false) {
            const item = document.createElement('div');
            item.className = 'accordion-item';
            if (defaultExpanded) item.classList.add('expanded');

            // å¤´éƒ¨
            const header = document.createElement('div');
            header.className = 'accordion-header';
            header.onclick = function() {
                item.classList.toggle('expanded');
                icon.textContent = item.classList.contains('expanded') ? 'â–²' : 'â–¼';
            };

            const headerLeft = document.createElement('div');
            headerLeft.className = 'accordion-header-left';

            const title = document.createElement('div');
            title.className = 'accordion-title';
            title.textContent = config.title + (isRequired ? ' *' : '');
            if (isMerged) {
                title.innerHTML += ' <small style="color: var(--text-tertiary);">(ç»Ÿä¸€é…ç½®æ‰€æœ‰æ—¶é—´æ®µ)</small>';
            }
            headerLeft.appendChild(title);

            const status = document.createElement('div');
            status.className = 'accordion-status';
            
            const progress = document.createElement('span');
            progress.className = 'mapping-progress';
            progress.id = `${configKey}_progress`;
            status.appendChild(progress);

            const icon = document.createElement('div');
            icon.className = 'accordion-icon';
            icon.textContent = 'â–¼';
            
            header.appendChild(headerLeft);
            header.appendChild(status);
            header.appendChild(icon);

            // å†…å®¹åŒº
            const content = document.createElement('div');
            content.className = 'accordion-content';

            const body = document.createElement('div');
            body.className = 'accordion-body';

            const grid = document.createElement('div');
            grid.className = 'mapping-grid';

            config.fields.forEach(field => {
                const row = document.createElement('div');
                row.className = 'mapping-row';

                const label = document.createElement('div');
                label.className = 'mapping-label';
                label.textContent = field.label;
                row.appendChild(label);

                const select = document.createElement('select');
                select.id = `${configKey}_${field.key}`;
                
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '-- è¯·é€‰æ‹©åˆ— --';
                select.appendChild(defaultOption);

                // æ™ºèƒ½åŒ¹é…
                let matchedIndex = -1;
                headers.forEach((header, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = header || `åˆ—${index + 1}`;
                    
                    // æ™ºèƒ½åŒ¹é…
                    if (matchedIndex === -1 && header && field.matchKey) {
                        const headerStr = header.toString().trim();
                        if (headerStr === field.matchKey || 
                            headerStr.includes(field.matchKey)) {
                            matchedIndex = index;
                            option.selected = true;
                            row.classList.add('matched');
                        }
                    }
                    
                    select.appendChild(option);
                });

                select.addEventListener('change', function() {
                    if (this.value) {
                        row.classList.add('matched');
                    } else {
                        row.classList.remove('matched');
                    }
                    updateMappingProgress(configKey, config.fields.length);
                    checkReadyToMatch();
                });
                row.appendChild(select);

                const source = document.createElement('div');
                source.className = 'mapping-source-tag';
                source.textContent = config.title.split(' - ')[0];
                row.appendChild(source);

                grid.appendChild(row);
            });

            body.appendChild(grid);
            content.appendChild(body);

            item.appendChild(header);
            item.appendChild(content);
            container.appendChild(item);

            // åˆå§‹åŒ–è¿›åº¦
            updateMappingProgress(configKey, config.fields.length);
        }

        function updateMappingProgress(configKey, totalFields) {
            const progressEl = document.getElementById(`${configKey}_progress`);
            if (!progressEl) return;

            let mappedCount = 0;
            for (let i = 0; i < totalFields; i++) {
                const select = document.querySelector(`select[id^="${configKey}_"]`);
                if (select && select.value !== '') {
                    mappedCount++;
                }
            }

            // é‡æ–°è®¡ç®—
            const selects = document.querySelectorAll(`select[id^="${configKey}_"]`);
            mappedCount = Array.from(selects).filter(s => s.value !== '').length;

            progressEl.textContent = `${mappedCount}/${totalFields} å·²æ˜ å°„`;
            if (mappedCount === totalFields) {
                progressEl.classList.add('complete');
            } else {
                progressEl.classList.remove('complete');
            }
        }

        // ä¸€é”®æ™ºèƒ½æ˜ å°„
        function quickSmartMapping() {
            const accordions = document.querySelectorAll('.accordion-item');
            accordions.forEach(accordion => {
                const selects = accordion.querySelectorAll('select');
                selects.forEach(select => {
                    // è§¦å‘æ¯ä¸ªå·²ç»è‡ªåŠ¨åŒ¹é…çš„é€‰æ‹©æ¡†
                    if (select.value !== '') {
                        const row = select.closest('.mapping-row');
                        if (row) row.classList.add('matched');
                    }
                });
                
                // å±•å¼€æ‰€æœ‰é¢æ¿
                accordion.classList.add('expanded');
            });

            // æ›´æ–°æ‰€æœ‰è¿›åº¦
            Object.keys(fieldConfigs).forEach(configKey => {
                if (configKey === 'policyActivity') {
                    // å¤„ç†æ´»åŠ¨é…ç½®
                    if (dataStore.policy.sheets.activity.length > 0) {
                        updateMappingProgress('policyActivity_0', fieldConfigs.policyActivity.fields.length);
                    }
                } else {
                    const config = fieldConfigs[configKey];
                    if (config && config.fields) {
                        updateMappingProgress(configKey, config.fields.length);
                    }
                }
            });

            checkReadyToMatch();
            
            // æ˜¾ç¤ºæç¤º
            alert('âœ¨ æ™ºèƒ½æ˜ å°„å®Œæˆï¼å·²è‡ªåŠ¨åŒ¹é…æ‰€æœ‰å¯è¯†åˆ«çš„å­—æ®µã€‚');
        }

        function checkReadyToMatch() {
            const ready = dataStore.salesOrder.data !== null &&
                         document.getElementById('salesOrder_docNumber')?.value !== '';
            
            document.getElementById('matchBtn').disabled = !ready;
        }

        function performMatch() {
            const btn = document.getElementById('matchBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>åŒ¹é…ä¸­...';

            setTimeout(() => {
                try {
                    // è·å–æ‰€æœ‰å­—æ®µæ˜ å°„
                    const mappings = extractMappings();
                    
                    // æ„å»ºç´¢å¼•
                    const indexes = buildIndexes(mappings);
                    
                    // æ‰§è¡ŒåŒ¹é…
                    matchResult = [];
                    const stats = { 
                        payment: 0, 
                        commission: 0, 
                        specialMachine: 0,
                        chanet: 0,
                        boiler: 0,
                        activity: 0,
                        priceTable: 0
                    };

                    // æ£€æµ‹é”€å”®è®¢å•ä¸­çš„ç›¸ä¼¼è®¢å•å·
                    const allSalesOrderNumbers = dataStore.salesOrder.data
                        .map(row => {
                            const colIndex = mappings.salesOrder.docNumber;
                            if (colIndex !== undefined && row[colIndex]) {
                                return normalizeOrderNumber(row[colIndex]);
                            }
                            return '';
                        })
                        .filter(num => num !== '');
                    
                    const similarSales = detectSimilarOrderNumbers([...new Set(allSalesOrderNumbers)]);
                    if (similarSales.length > 0) {
                        console.warn('é”€å”®è®¢å•ä¸­å‘ç°ç›¸ä¼¼è®¢å•å·:', similarSales);
                        matchDiagnostics.similarOrderNumbers.push(...similarSales.map(s => ({
                            source: 'é”€å”®è®¢å•',
                            ...s
                        })));
                    }
                    
                    // é—¨åº—è¿‡æ»¤ï¼šåªä¿ç•™ç™½åå•ä¸­çš„é—¨åº—æ•°æ®
                    filterStats.originalCount = dataStore.salesOrder.data.length;
                    const storeNameColIndex = mappings.salesOrder.storeName;
                    const filteredSalesData = dataStore.salesOrder.data.filter(row => {
                        if (storeNameColIndex === undefined) {
                            return true; // å¦‚æœæ²¡æœ‰æ˜ å°„å®¢æˆ·åº—åå­—æ®µï¼Œä¿ç•™æ‰€æœ‰æ•°æ®
                        }
                        const storeName = row[storeNameColIndex];
                        if (!storeName) {
                            return false; // ç©ºåº—åä¸ä¿ç•™
                        }
                        const storeNameStr = storeName.toString().trim();
                        // æ£€æŸ¥æ˜¯å¦åœ¨ç™½åå•ä¸­
                        return storeWhitelist.some(whiteStore => {
                            // ç²¾ç¡®åŒ¹é…æˆ–åŒ…å«åŒ¹é…
                            return storeNameStr === whiteStore || 
                                   storeNameStr.includes(whiteStore) || 
                                   whiteStore.includes(storeNameStr);
                        });
                    });
                    filterStats.filteredCount = filteredSalesData.length;
                    filterStats.removedCount = filterStats.originalCount - filterStats.filteredCount;
                    
                    console.log(`é—¨åº—è¿‡æ»¤ï¼šåŸå§‹ ${filterStats.originalCount} æ¡ï¼Œä¿ç•™ ${filterStats.filteredCount} æ¡ï¼Œè¿‡æ»¤ ${filterStats.removedCount} æ¡`);
                    
                    filteredSalesData.forEach(row => {
                        const record = {};
                        
                        // æå–é”€å”®è®¢å•å­—æ®µ
                        fieldConfigs.salesOrder.fields.forEach(field => {
                            const colIndex = mappings.salesOrder[field.key];
                            record[field.label] = colIndex !== undefined ? (row[colIndex] || '') : '';
                        });

                        // è·å–åŒ¹é…é”®ï¼ˆä½¿ç”¨è§„èŒƒåŒ–ï¼‰
                        const docNumberRaw = record['å•æ®ç¼–å·'];
                        const docNumber = normalizeOrderNumber(docNumberRaw);
                        const model = record['è§„æ ¼å‹å·'] ? record['è§„æ ¼å‹å·'].toString().trim() : '';

                        // åŒ¹é…æ”¶æ¬¾é‡‘é¢ - æ–°é€»è¾‘ï¼š
                        // 1. å…ˆæ ¹æ®æ”¶æ¬¾å•åŒ¹é…"è¡¨å¤´-å®æ”¶é‡‘é¢"
                        // 2. å¦‚æœé”€å”®æ•°é‡<0ï¼ˆé€€æ¬¾è®¢å•ï¼‰ï¼Œå›æ¬¾æ”¶æ¬¾é‡‘é¢=ä»·ç¨åˆè®¡
                        // 3. å‰©ä½™æ²¡æœ‰åŒ¹é…åˆ°çš„ï¼Œå›æ¬¾æ”¶æ¬¾é‡‘é¢å¡«0
                        const quantity = parseFloat(record['é”€å”®æ•°é‡']) || 0;
                        let finalPayment = '';
                        let matchedFromPayment = false;
                        
                        // è§„åˆ™1: å…ˆå°è¯•åŒ¹é…æ”¶æ¬¾å•ï¼ˆä½¿ç”¨è§„èŒƒåŒ–åçš„è®¢å•å·è¿›è¡Œç²¾ç¡®åŒ¹é…ï¼‰
                        if (indexes.payment && docNumber && indexes.payment[docNumber] !== undefined) {
                            finalPayment = indexes.payment[docNumber];
                            matchedFromPayment = true;
                            stats.payment++;
                            
                            // è®°å½•åŒ¹é…ä¿¡æ¯
                            matchDiagnostics.paymentMatches.push({
                                orderNumber: docNumber,
                                orderNumberRaw: docNumberRaw,
                                paymentAmount: finalPayment,
                                matchType: 'æ”¶æ¬¾å•åŒ¹é…'
                            });
                        }
                        
                        // è§„åˆ™2: é€€æ¬¾è®¢å•ï¼ˆé”€å”®æ•°é‡<0ï¼‰ä½¿ç”¨ä»·ç¨åˆè®¡
                        if (quantity < 0) {
                            finalPayment = record['ä»·ç¨åˆè®¡'] || 0;
                            if (!matchedFromPayment) {
                                matchDiagnostics.paymentMatches.push({
                                    orderNumber: docNumber,
                                    orderNumberRaw: docNumberRaw,
                                    paymentAmount: finalPayment,
                                    matchType: 'é€€æ¬¾è®¢å•ï¼ˆä½¿ç”¨ä»·ç¨åˆè®¡ï¼‰'
                                });
                            }
                        }
                        
                        // è§„åˆ™3: å‰©ä½™æœªåŒ¹é…çš„å¡«0
                        if (!finalPayment && finalPayment !== 0) {
                            finalPayment = 0;
                            if (!matchedFromPayment && quantity >= 0 && docNumber) {
                                // è®°å½•æœªåŒ¹é…çš„è®¢å•
                                matchDiagnostics.unmatchedOrders.push({
                                    orderNumber: docNumber,
                                    orderNumberRaw: docNumberRaw,
                                    userName: record['ç”¨æˆ·å§“å'],
                                    model: model,
                                    totalAmount: record['ä»·ç¨åˆè®¡']
                                });
                            }
                        }
                        
                        record['å›æ¬¾æ”¶æ¬¾é‡‘é¢'] = finalPayment;

                        // åŒ¹é…å¸¦å•è´¹ï¼ˆæŒ‰å•æ®ç¼–å·ï¼‰
                        if (mappings.commission && indexes.commission && indexes.commission[docNumber]) {
                            const commData = indexes.commission[docNumber];
                            fieldConfigs.commission.fields.forEach(field => {
                                // è·³è¿‡å•å·å­—æ®µï¼Œå› ä¸ºå·²ç»æœ‰å•æ®ç¼–å·äº†
                                if (field.key !== 'docNumber') {
                                    record[field.label] = commData[field.key] || '';
                                }
                            });
                            stats.commission++;
                        } else if (mappings.commission) {
                            fieldConfigs.commission.fields.forEach(field => {
                                if (field.key !== 'docNumber') {
                                    record[field.label] = '';
                                }
                            });
                        }

                        // åŒ¹é…æ”¿ç­–è¡¨ - ç‰¹ä»·æœºæ•´ç†ï¼ˆæŒ‰è§„æ ¼å‹å·ï¼‰
                        if (mappings.policySpecialMachine && indexes.policySpecialMachine[model]) {
                            const policyData = indexes.policySpecialMachine[model];
                            fieldConfigs.policySpecialMachine.fields.forEach(field => {
                                record[field.label] = policyData[field.key] || '';
                            });
                            stats.specialMachine++;
                        } else if (mappings.policySpecialMachine) {
                            fieldConfigs.policySpecialMachine.fields.forEach(field => {
                                record[field.label] = '';
                            });
                        }

                        // åŒ¹é…æ”¿ç­–è¡¨ - ä½³å°¼ç‰¹ï¼ˆæŒ‰è§„æ ¼å‹å·ï¼‰
                        if (mappings.policyChanet && indexes.policyChanet[model]) {
                            const policyData = indexes.policyChanet[model];
                            fieldConfigs.policyChanet.fields.forEach(field => {
                                record[field.label] = policyData[field.key] || '';
                            });
                            stats.chanet++;
                        } else if (mappings.policyChanet) {
                            fieldConfigs.policyChanet.fields.forEach(field => {
                                record[field.label] = '';
                            });
                        }

                        // åŒ¹é…æ”¿ç­–è¡¨ - å£æŒ‚ç‚‰ï¼ˆæŒ‰è§„æ ¼å‹å·ï¼‰
                        if (mappings.policyBoiler && indexes.policyBoiler[model]) {
                            const policyData = indexes.policyBoiler[model];
                            fieldConfigs.policyBoiler.fields.forEach(field => {
                                record[field.label] = policyData[field.key] || '';
                            });
                            stats.boiler++;
                        } else if (mappings.policyBoiler) {
                            fieldConfigs.policyBoiler.fields.forEach(field => {
                                record[field.label] = '';
                            });
                        }

                        // åŒ¹é…æ”¿ç­–è¡¨ - é”€å”®æ”¿ç­–ï¼ˆæ ¹æ®è®¢å•æ—¥æœŸåŒ¹é…å¯¹åº”æ—¶é—´æ®µçš„æ”¿ç­–ï¼‰
                        if (mappings.policyActivity && Array.isArray(indexes.policyActivity)) {
                            const orderDate = record['æ—¥æœŸ'];
                            let policyData = null;
                            let matchedSheet = null;
                            let matchType = '';
                            let dateMatchedSheet = null; // è®°å½•æ—¥æœŸåŒ¹é…åˆ°çš„å­è¡¨ï¼ˆå³ä½¿å‹å·ä¸å­˜åœ¨ï¼‰
                            
                            // éå†æ‰€æœ‰æ´»åŠ¨å­è¡¨ï¼Œæ‰¾åˆ°æ—¥æœŸåŒ¹é…çš„é‚£ä¸ª
                            for (let activitySheet of indexes.policyActivity) {
                                if (!activitySheet) continue;
                                
                                const orderTimestamp = parseDate(orderDate);
                                const startTimestamp = parseDate(activitySheet.startDate);
                                const endTimestamp = parseDate(activitySheet.endDate);
                                
                                // å¦‚æœæœ‰æ—¶é—´æ®µï¼Œåˆ™è¿›è¡Œæ—¥æœŸåŒ¹é…
                                if (orderTimestamp && startTimestamp && endTimestamp) {
                                    if (orderTimestamp >= startTimestamp && orderTimestamp <= endTimestamp) {
                                        // æ‰¾åˆ°æ—¥æœŸåŒ¹é…çš„å­è¡¨
                                        dateMatchedSheet = activitySheet;
                                        
                                        // ä»è¯¥å­è¡¨çš„ç´¢å¼•ä¸­æŸ¥æ‰¾å‹å·
                                        if (activitySheet.index[model]) {
                                            policyData = activitySheet.index[model];
                                            matchedSheet = activitySheet;
                                            matchType = 'date';
                                            break;
                                        }
                                        // æ‰¾åˆ°äº†æ—¥æœŸåŒ¹é…çš„è¡¨ï¼Œä½†æ²¡æœ‰è¿™ä¸ªå‹å·ï¼Œç»§ç»­çœ‹æ˜¯å¦æœ‰å…¶ä»–æ—¶é—´æ®µ
                                    }
                                } 
                                // å¦‚æœæ²¡æœ‰æ—¶é—´æ®µè®¾ç½®ï¼Œç›´æ¥åŒ¹é…å‹å·ï¼ˆå‘åå…¼å®¹ï¼‰
                                else if (!startTimestamp || !endTimestamp) {
                                    if (activitySheet.index[model]) {
                                        policyData = activitySheet.index[model];
                                        matchedSheet = activitySheet;
                                        matchType = 'direct';
                                        break;
                                    }
                                }
                            }
                            
                            if (policyData) {
                                fieldConfigs.policyActivity.fields.forEach(field => {
                                    record[field.label] = policyData[field.key] || '';
                                });
                                
                                // æ·»åŠ åŒ¹é…è¯´æ˜
                                if (matchType === 'date') {
                                    record['é”€å”®æ”¿ç­–åŒ¹é…è¯´æ˜'] = `åŒ¹é…æˆåŠŸï¼š${matchedSheet.sheetName}ï¼ˆ${matchedSheet.startDate} ~ ${matchedSheet.endDate}ï¼‰`;
                                } else if (matchType === 'direct') {
                                    record['é”€å”®æ”¿ç­–åŒ¹é…è¯´æ˜'] = `åŒ¹é…æˆåŠŸï¼š${matchedSheet.sheetName}ï¼ˆæœªè®¾ç½®æ—¶é—´æ®µï¼‰`;
                                }
                                
                                stats.activity++;
                            } else {
                                fieldConfigs.policyActivity.fields.forEach(field => {
                                    record[field.label] = '';
                                });
                                
                                // æœªåŒ¹é…æ—¶çš„ç²¾ç¡®è¯´æ˜
                                if (dateMatchedSheet) {
                                    // æƒ…å†µ1ï¼šæ‰¾åˆ°äº†æ—¥æœŸåŒ¹é…çš„æ”¿ç­–è¡¨ï¼Œä½†å‹å·ä¸åœ¨è¡¨ä¸­
                                    record['é”€å”®æ”¿ç­–åŒ¹é…è¯´æ˜'] = `æœªåŒ¹é…ï¼šå‹å·"${model}"ä¸åœ¨æ”¿ç­–è¡¨"${dateMatchedSheet.sheetName}"ï¼ˆ${dateMatchedSheet.startDate} ~ ${dateMatchedSheet.endDate}ï¼‰ä¸­`;
                                } else if (indexes.policyActivity.length > 0) {
                                    // æƒ…å†µ2ï¼šæœ‰æ”¿ç­–è¡¨ï¼Œä½†è®¢å•æ—¥æœŸä¸åœ¨ä»»ä½•æ—¶é—´æ®µå†…
                                    const hasTimeRange = indexes.policyActivity.some(s => s && s.startDate && s.endDate);
                                    if (hasTimeRange) {
                                        // åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„æ—¶é—´æ®µ
                                        const periods = indexes.policyActivity
                                            .filter(s => s && s.startDate && s.endDate)
                                            .map(s => `${s.startDate}~${s.endDate}`)
                                            .join('ã€');
                                        record['é”€å”®æ”¿ç­–åŒ¹é…è¯´æ˜'] = `æœªåŒ¹é…ï¼šè®¢å•æ—¥æœŸ"${orderDate || 'ç¼ºå¤±'}"ä¸åœ¨ä»»ä½•æ”¿ç­–æ—¶é—´æ®µå†…ï¼ˆå¯ç”¨æ—¶é—´æ®µï¼š${periods}ï¼‰`;
                                    } else {
                                        // æ²¡æœ‰è®¾ç½®æ—¶é—´æ®µï¼Œå‹å·ä¹Ÿä¸åœ¨è¡¨ä¸­
                                        record['é”€å”®æ”¿ç­–åŒ¹é…è¯´æ˜'] = `æœªåŒ¹é…ï¼šå‹å·"${model}"ä¸åœ¨æ”¿ç­–è¡¨ä¸­`;
                                    }
                                } else {
                                    record['é”€å”®æ”¿ç­–åŒ¹é…è¯´æ˜'] = 'æœªåŒ¹é…ï¼šæœªä¸Šä¼ é”€å”®æ”¿ç­–è¡¨';
                                }
                            }
                        } else if (mappings.policyActivity) {
                            fieldConfigs.policyActivity.fields.forEach(field => {
                                record[field.label] = '';
                            });
                            record['é”€å”®æ”¿ç­–åŒ¹é…è¯´æ˜'] = 'æœªåŒ¹é…ï¼šé”€å”®æ”¿ç­–å­—æ®µæ˜ å°„æœªé…ç½®';
                        } else {
                            record['é”€å”®æ”¿ç­–åŒ¹é…è¯´æ˜'] = 'æœªåŒ¹é…ï¼šæœªä¸Šä¼ é”€å”®æ”¿ç­–è¡¨';
                        }

                        // åŒ¹é…æ”¿ç­–è¡¨ - æ ‡ä»·ï¼ˆæŒ‰è§„æ ¼å‹å·ï¼‰
                        if (mappings.policyPriceTable && indexes.policyPriceTable[model]) {
                            const policyData = indexes.policyPriceTable[model];
                            fieldConfigs.policyPriceTable.fields.forEach(field => {
                                record[field.label] = policyData[field.key] || '';
                            });
                            stats.priceTable++;
                        } else if (mappings.policyPriceTable) {
                            fieldConfigs.policyPriceTable.fields.forEach(field => {
                                record[field.label] = '';
                            });
                        }

                        matchResult.push(record);
                    });

                    // æŸ¥æ‰¾æ”¶æ¬¾å•ä¸­æœªåŒ¹é…çš„è®°å½•
                    if (indexes.payment) {
                        const matchedPaymentOrderNumbers = new Set(
                            matchDiagnostics.paymentMatches
                                .filter(m => m.matchType === 'æ”¶æ¬¾å•åŒ¹é…')
                                .map(m => m.orderNumber)
                        );
                        
                        Object.keys(indexes.payment).forEach(paymentOrderNumber => {
                            if (!matchedPaymentOrderNumbers.has(paymentOrderNumber)) {
                                matchDiagnostics.unmatchedPayments.push({
                                    orderNumber: paymentOrderNumber,
                                    paymentAmount: indexes.payment[paymentOrderNumber]
                                });
                            }
                        });
                    }

                    // è¯†åˆ«é€€è´§å’Œå›½è¡¥è®¢å•
                    const guobuStats = identifyGuoBu(matchResult);
                    stats.return = guobuStats.returnCount;
                    stats.guobu = guobuStats.guobuCount;
                    stats.nonGuobu = guobuStats.nonGuobuCount;

                    // æ˜¾ç¤ºç»“æœ
                    displayResult(stats);
                    
                    // æ˜¾ç¤ºç»“æœåŒºåŸŸ
                    document.getElementById('step-result').classList.remove('hidden');
                    
                    // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
                    setTimeout(() => {
                        document.querySelector('#step-result').scrollIntoView({ behavior: 'smooth' });
                    }, 100);
                    
                    // æ ‡è®°æ­¥éª¤3å®Œæˆ
                    markStepCompleted('3');
                    markStepCompleted('4');
                    
                    btn.innerHTML = 'ğŸš€ å¼€å§‹åŒ¹é…';
                    btn.disabled = false;
                } catch (error) {
                    alert('åŒ¹é…è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: ' + error.message);
                    console.error(error);
                    btn.innerHTML = 'å¼€å§‹åŒ¹é…';
                    btn.disabled = false;
                }
            }, 500);
        }

        function extractMappings() {
            const mappings = {};
            
            // æå–æ‰€æœ‰é…ç½®çš„å­—æ®µæ˜ å°„ï¼ˆé™¤äº†æ´»åŠ¨ï¼‰
            Object.keys(fieldConfigs).forEach(configKey => {
                if (configKey === 'policyActivity') return; // æ´»åŠ¨å•ç‹¬å¤„ç†
                
                const config = fieldConfigs[configKey];
                const mapping = {};
                let hasMapping = false;
                
                config.fields.forEach(field => {
                    const select = document.getElementById(`${configKey}_${field.key}`);
                    if (select && select.value !== '') {
                        mapping[field.key] = parseInt(select.value);
                        hasMapping = true;
                    }
                });
                
                if (hasMapping) {
                    mappings[configKey] = mapping;
                }
            });
            
            // æå–æ‰€æœ‰æ´»åŠ¨å­è¡¨çš„æ˜ å°„
            if (dataStore.policy.sheets.activity.length > 0) {
                mappings.policyActivity = []; // æ”¹ä¸ºæ•°ç»„
                dataStore.policy.sheets.activity.forEach((activitySheet, index) => {
                    const mapping = {};
                    let hasMapping = false;
                    
                    fieldConfigs.policyActivity.fields.forEach(field => {
                        const select = document.getElementById(`policyActivity_${index}_${field.key}`);
                        if (select && select.value !== '') {
                            mapping[field.key] = parseInt(select.value);
                            hasMapping = true;
                        }
                    });
                    
                    if (hasMapping) {
                        mappings.policyActivity.push(mapping);
                    } else {
                        mappings.policyActivity.push(null);
                    }
                });
            }
            
            return mappings;
        }

        function buildIndexes(mappings) {
            const indexes = {};
            
            // é‡ç½®è¯Šæ–­ä¿¡æ¯
            matchDiagnostics = {
                similarOrderNumbers: [],
                unmatchedOrders: [],
                unmatchedPayments: [],
                paymentMatches: []
            };
            
            // æ”¶æ¬¾å•ç´¢å¼•ï¼ˆæŒ‰å•æ®ç¼–å·æ±‚å’Œï¼‰
            if (mappings.payment && dataStore.payment.data) {
                indexes.payment = {};
                const paymentOrderNumbers = [];
                
                dataStore.payment.data.forEach(row => {
                    const docNumber = row[mappings.payment.docNumber];
                    const amount = parseFloat(row[mappings.payment.amount]) || 0;
                    
                    if (docNumber) {
                        const key = normalizeOrderNumber(docNumber);
                        if (key) {
                            paymentOrderNumbers.push(key);
                            if (!indexes.payment[key]) {
                                indexes.payment[key] = 0;
                            }
                            indexes.payment[key] += amount;
                        }
                    }
                });
                
                // æ£€æµ‹æ”¶æ¬¾å•ä¸­çš„ç›¸ä¼¼è®¢å•å·
                const similarPayments = detectSimilarOrderNumbers([...new Set(paymentOrderNumbers)]);
                if (similarPayments.length > 0) {
                    console.warn('æ”¶æ¬¾å•ä¸­å‘ç°ç›¸ä¼¼è®¢å•å·:', similarPayments);
                    matchDiagnostics.similarOrderNumbers.push(...similarPayments.map(s => ({
                        source: 'æ”¶æ¬¾å•',
                        ...s
                    })));
                }
            }
            
            // å¸¦å•è´¹ç´¢å¼•ï¼ˆæŒ‰å•æ®ç¼–å·ï¼‰
            if (mappings.commission && dataStore.commission.data) {
                indexes.commission = {};
                const docNumberColIndex = mappings.commission.docNumber;
                if (docNumberColIndex !== undefined) {
                    dataStore.commission.data.forEach(row => {
                        const docNumber = row[docNumberColIndex];
                        if (docNumber) {
                            const key = normalizeOrderNumber(docNumber);
                            if (key) {
                                indexes.commission[key] = {};
                                fieldConfigs.commission.fields.forEach(field => {
                                    const colIndex = mappings.commission[field.key];
                                    if (colIndex !== undefined) {
                                        let value = row[colIndex];
                                        // å¯¹æŠ˜æ‰£å­—æ®µè¿›è¡Œè§„èŒƒåŒ–å¤„ç†
                                        if (field.key === 'actualDiscount') {
                                            value = normalizePercentage(value);
                                        }
                                        indexes.commission[key][field.key] = value;
                                    }
                                });
                            }
                        }
                    });
                }
            }
            
            // æ”¿ç­–è¡¨ç´¢å¼•ï¼ˆæ´»åŠ¨é™¤å¤–ï¼Œæ´»åŠ¨éœ€è¦æ ¹æ®æ—¥æœŸåŠ¨æ€åŒ¹é…ï¼‰
            buildPolicyIndex('policySpecialMachine', 'specialMachine', mappings, indexes);
            buildPolicyIndex('policyChanet', 'chanet', mappings, indexes);
            buildPolicyIndex('policyBoiler', 'boiler', mappings, indexes);
            buildPolicyIndex('policyPriceTable', 'priceTable', mappings, indexes);
            
            // æ´»åŠ¨å­è¡¨çš„ç´¢å¼•æ„å»ºï¼ˆæ”¯æŒå¤šä¸ªæ—¶é—´æ®µï¼‰
            if (mappings.policyActivity && Array.isArray(mappings.policyActivity)) {
                indexes.policyActivity = [];
                
                dataStore.policy.sheets.activity.forEach((activitySheet, index) => {
                    const mapping = mappings.policyActivity[index];
                    if (mapping) {
                        const activityIndex = {};
                        const config = fieldConfigs.policyActivity;
                        const data = activitySheet.data;
                        const headers = activitySheet.headers;
                        
                        // éœ€è¦è§„èŒƒåŒ–çš„æŠ˜æ‰£ç‡å­—æ®µ
                        const percentageFields = ['activityDiscount', 'boilerDiscount', 'minDiscount'];
                        
                        // æ‰¾åˆ°åŒ¹é…é”®åˆ—ï¼ˆæœºå‹åˆ—ï¼‰
                        const matchColIndex = headers.indexOf(config.matchKey);
                        
                        if (matchColIndex !== -1) {
                            data.forEach(row => {
                                const matchValue = row[matchColIndex];
                                if (matchValue) {
                                    const key = matchValue.toString().trim();
                                    activityIndex[key] = {};
                                    config.fields.forEach(field => {
                                        const colIndex = mapping[field.key];
                                        if (colIndex !== undefined) {
                                            let value = row[colIndex];
                                            // å¯¹æŠ˜æ‰£ç‡å­—æ®µè¿›è¡Œè§„èŒƒåŒ–å¤„ç†
                                            if (percentageFields.includes(field.key)) {
                                                value = normalizePercentage(value);
                                            }
                                            activityIndex[key][field.key] = value;
                                        }
                                    });
                                }
                            });
                        }
                        
                        indexes.policyActivity.push({
                            index: activityIndex,
                            startDate: activitySheet.startDate,
                            endDate: activitySheet.endDate,
                            sheetName: activitySheet.sheetName
                        });
                    } else {
                        indexes.policyActivity.push(null);
                    }
                });
            }
            
            return indexes;
        }

        function buildPolicyIndex(configKey, storeKey, mappings, indexes) {
            if (mappings[configKey] && dataStore.policy.sheets[storeKey].data) {
                indexes[configKey] = {};
                const config = fieldConfigs[configKey];
                const data = dataStore.policy.sheets[storeKey].data;
                const headers = dataStore.policy.sheets[storeKey].headers;
                
                // éœ€è¦è§„èŒƒåŒ–çš„æŠ˜æ‰£ç‡å­—æ®µ
                const percentageFields = ['activityDiscount', 'boilerDiscount', 'minDiscount'];
                
                // æ‰¾åˆ°åŒ¹é…é”®åˆ—ï¼ˆæœºå‹åˆ—ï¼‰
                const matchColIndex = headers.indexOf(config.matchKey);
                
                if (matchColIndex !== -1) {
                    data.forEach(row => {
                        const matchValue = row[matchColIndex];
                        if (matchValue) {
                            const key = matchValue.toString().trim();
                            indexes[configKey][key] = {};
                            config.fields.forEach(field => {
                                const colIndex = mappings[configKey][field.key];
                                if (colIndex !== undefined) {
                                    let value = row[colIndex];
                                    // å¯¹æŠ˜æ‰£ç‡å­—æ®µè¿›è¡Œè§„èŒƒåŒ–å¤„ç†
                                    if (percentageFields.includes(field.key)) {
                                        value = normalizePercentage(value);
                                    }
                                    indexes[configKey][key][field.key] = value;
                                }
                            });
                        }
                    });
                }
            }
        }

        function findModelColumn(headers) {
            const modelKeywords = ['è§„æ ¼å‹å·', 'æœºå‹', 'å‹å·', 'è§„æ ¼'];
            for (let i = 0; i < headers.length; i++) {
                const header = headers[i] ? headers[i].toString().trim() : '';
                if (modelKeywords.some(keyword => header.includes(keyword))) {
                    return i;
                }
            }
            return -1;
        }

        function identifyGuoBu(matchResult) {
            // ç¬¬ä¸€æ­¥ï¼šè¯†åˆ«é€€è´§è®¢å•ï¼ˆä¼˜å…ˆçº§é«˜ï¼‰
            // æŒ‰ (ç”¨æˆ·å§“å + è§„æ ¼å‹å·) åˆ†ç»„
            const returnGroupMap = {};
            
            matchResult.forEach((record, index) => {
                const userName = record['ç”¨æˆ·å§“å'] || '';
                const model = record['è§„æ ¼å‹å·'] || '';
                const key = `${userName}|${model}`;
                
                if (!returnGroupMap[key]) {
                    returnGroupMap[key] = [];
                }
                returnGroupMap[key].push(index);
            });
            
            // æ ‡è®°é€€è´§ï¼šä¸€æ­£ä¸€è´Ÿé…å¯¹æ ‡è®°ä¸ºé€€è´§
            const returnIndexes = new Set();
            Object.values(returnGroupMap).forEach(indexes => {
                // åˆ†ç¦»æ­£æ•°å’Œè´Ÿæ•°è®¢å•
                const positiveIndexes = [];
                const negativeIndexes = [];
                
                indexes.forEach(idx => {
                    const quantity = parseFloat(matchResult[idx]['é”€å”®æ•°é‡']) || 0;
                    if (quantity > 0) {
                        positiveIndexes.push(idx);
                    } else if (quantity < 0) {
                        negativeIndexes.push(idx);
                    }
                });
                
                // ä¸€æ­£ä¸€è´Ÿé…å¯¹æ ‡è®°ä¸ºé€€è´§
                const pairCount = Math.min(positiveIndexes.length, negativeIndexes.length);
                for (let i = 0; i < pairCount; i++) {
                    matchResult[positiveIndexes[i]]['è®¢å•ç±»å‹'] = 'é€€è´§';
                    matchResult[negativeIndexes[i]]['è®¢å•ç±»å‹'] = 'é€€è´§';
                    returnIndexes.add(positiveIndexes[i]);
                    returnIndexes.add(negativeIndexes[i]);
                }
            });
            
            // ç¬¬äºŒæ­¥ï¼šåœ¨éé€€è´§è®¢å•ä¸­è¯†åˆ«å›½è¡¥
            // æŒ‰ (æ—¥æœŸ + ç”¨æˆ·å§“å) åˆ†ç»„ç»Ÿè®¡
            const groupMap = {};
            
            matchResult.forEach((record, index) => {
                // è·³è¿‡å·²æ ‡è®°ä¸ºé€€è´§çš„è®¢å•
                if (returnIndexes.has(index)) return;
                
                const date = record['æ—¥æœŸ'] || '';
                const userName = record['ç”¨æˆ·å§“å'] || '';
                const key = `${date}|${userName}`;
                
                if (!groupMap[key]) {
                    groupMap[key] = [];
                }
                groupMap[key].push(index);
            });
            
            // æ ‡è®°å›½è¡¥ï¼šåŒä¸€å¤©å†…åŒä¸€ä¸ªäººæ°å¥½æœ‰2ç¬”è®¢å•åˆ™æ ‡è®°ä¸ºå›½è¡¥
            Object.values(groupMap).forEach(indexes => {
                if (indexes.length === 2) {
                    indexes.forEach(idx => {
                        matchResult[idx]['è®¢å•ç±»å‹'] = 'å›½è¡¥';
                    });
                } else {
                    indexes.forEach(idx => {
                        matchResult[idx]['è®¢å•ç±»å‹'] = 'éå›½è¡¥';
                    });
                }
            });
            
            // ç»Ÿè®¡
            const returnCount = matchResult.filter(r => r['è®¢å•ç±»å‹'] === 'é€€è´§').length;
            const guobuCount = matchResult.filter(r => r['è®¢å•ç±»å‹'] === 'å›½è¡¥').length;
            const nonGuobuCount = matchResult.filter(r => r['è®¢å•ç±»å‹'] === 'éå›½è¡¥').length;
            
            return { returnCount, guobuCount, nonGuobuCount };
        }

        function displayResult(stats) {
            const total = matchResult.length;
            
            // åˆå§‹åŒ–ç­›é€‰ç»“æœ
            filteredMatchResult = [...matchResult];
            
            // æ˜¾ç¤ºè¯Šæ–­ä¿¡æ¯æ‘˜è¦
            displayDiagnosticsSummary();
            
            // æ„å»ºç»Ÿè®¡å¡ç‰‡
            buildStatsCards(stats, total);
            
            // å¡«å……é—¨åº—ç­›é€‰ä¸‹æ‹‰æ¡†
            populateStoreFilter();
            
            // åˆå§‹åŒ–åˆ†é¡µå¹¶æ˜¾ç¤ºç»“æœ
            currentPage = 1;
            displayPaginatedResults();
        }

        function buildStatsCards(stats, total) {
            const container = document.getElementById('statsContainer');
            container.innerHTML = '';

            // åŸºç¡€ç»Ÿè®¡
            const basicSection = document.createElement('div');
            basicSection.className = 'stats-section';
            basicSection.innerHTML = `
                <div class="stats-section-title">ğŸ“Š åŸºç¡€ç»Ÿè®¡</div>
                <div class="stats-grid"></div>
            `;
            
            const basicGrid = basicSection.querySelector('.stats-grid');
            const basicStats = [
                { icon: 'ğŸ“¦', label: 'æ€»è®°å½•æ•°', value: total, percentage: '' },
                { icon: 'â†©ï¸', label: 'é€€è´§è®¢å•', value: stats.return || 0, percentage: total > 0 ? `${((stats.return || 0) / total * 100).toFixed(1)}%` : '' },
                { icon: 'ğŸ·ï¸', label: 'å›½è¡¥è®¢å•', value: stats.guobu || 0, percentage: total > 0 ? `${((stats.guobu || 0) / total * 100).toFixed(1)}%` : '' },
                { icon: 'ğŸ“', label: 'éå›½è¡¥è®¢å•', value: stats.nonGuobu || 0, percentage: total > 0 ? `${((stats.nonGuobu || 0) / total * 100).toFixed(1)}%` : '' }
            ];

            if (filterStats.originalCount > 0 && filterStats.removedCount > 0) {
                basicSection.insertAdjacentHTML('afterbegin', `
                    <div class="alert alert-info" style="margin-bottom: var(--space-md);">
                        <strong>ğŸª é—¨åº—ç­›é€‰ï¼š</strong>
                        åŸå§‹ ${filterStats.originalCount} æ¡ â†’ ä¿ç•™ ${filterStats.filteredCount} æ¡
                        ï¼ˆè¿‡æ»¤æ‰ ${filterStats.removedCount} æ¡ï¼‰
                    </div>
                `);
            }

            basicStats.forEach(item => {
                const card = document.createElement('div');
                card.className = 'stat-card';
                card.innerHTML = `
                    <div class="stat-header">
                        <span class="stat-icon">${item.icon}</span>
                        <span class="stat-label">${item.label}</span>
                    </div>
                    <div class="stat-value">${item.value}</div>
                    ${item.percentage ? `<div class="stat-percentage">${item.percentage}</div>` : ''}
                `;
                basicGrid.appendChild(card);
            });

            container.appendChild(basicSection);

            // åŒ¹é…ç»Ÿè®¡
            const matchSection = document.createElement('div');
            matchSection.className = 'stats-section';
            matchSection.innerHTML = `
                <div class="stats-section-title">ğŸ”— åŒ¹é…ç»Ÿè®¡</div>
                <div class="stats-grid"></div>
            `;
            
            const matchGrid = matchSection.querySelector('.stats-grid');
            const matchStats = [
                { icon: 'ğŸ’°', label: 'æ”¶æ¬¾åŒ¹é…', value: stats.payment, total: total, color: 'var(--color-success)' },
                { icon: 'ğŸ’µ', label: 'å¸¦å•è´¹åŒ¹é…', value: stats.commission, total: total, color: 'var(--color-info)' },
                { icon: 'ğŸ·ï¸', label: 'ç‰¹ä»·æœºåŒ¹é…', value: stats.specialMachine, total: total, color: 'var(--color-warning)' },
                { icon: 'ğŸ’§', label: 'ä½³å°¼ç‰¹åŒ¹é…', value: stats.chanet, total: total, color: 'var(--accent-blue)' },
                { icon: 'ğŸ”¥', label: 'å£æŒ‚ç‚‰åŒ¹é…', value: stats.boiler, total: total, color: 'var(--color-danger)' },
                { icon: 'ğŸ“‹', label: 'é”€å”®æ”¿ç­–åŒ¹é…', value: stats.activity, total: total, color: 'var(--color-success)' }
            ];

            matchStats.forEach(item => {
                const percentage = item.total > 0 ? ((item.value / item.total) * 100).toFixed(1) : '0.0';
                const card = document.createElement('div');
                card.className = 'stat-card';
                card.innerHTML = `
                    <div class="stat-header">
                        <span class="stat-icon">${item.icon}</span>
                        <span class="stat-label">${item.label}</span>
                    </div>
                    <div class="stat-value" style="color: ${item.color}">${item.value}</div>
                    <div class="stat-percentage">åŒ¹é…ç‡ ${percentage}%</div>
                `;
                matchGrid.appendChild(card);
            });

            container.appendChild(matchSection);
        }

        function populateStoreFilter() {
            const filterStore = document.getElementById('filterStore');
            const stores = new Set();
            matchResult.forEach(record => {
                const storeName = record['å®¢æˆ·åº—å'];
                if (storeName) stores.add(storeName);
            });

            filterStore.innerHTML = '<option value="">å…¨éƒ¨é—¨åº—</option>';
            Array.from(stores).sort().forEach(store => {
                const option = document.createElement('option');
                option.value = store;
                option.textContent = store;
                filterStore.appendChild(option);
            });
        }

        // é˜²æŠ–å‡½æ•°
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        const applyFilters = debounce(function() {
            const orderType = document.getElementById('filterOrderType').value;
            const store = document.getElementById('filterStore').value;
            const search = document.getElementById('filterSearch').value.toLowerCase();

            filteredMatchResult = matchResult.filter(record => {
                // è®¢å•ç±»å‹ç­›é€‰
                if (orderType && record['è®¢å•ç±»å‹'] !== orderType) return false;

                // é—¨åº—ç­›é€‰
                if (store && record['å®¢æˆ·åº—å'] !== store) return false;

                // æœç´¢
                if (search) {
                    const searchableFields = [
                        record['å•æ®ç¼–å·'],
                        record['ç”¨æˆ·å§“å'],
                        record['è§„æ ¼å‹å·']
                    ];
                    const matchesSearch = searchableFields.some(field => 
                        field && field.toString().toLowerCase().includes(search)
                    );
                    if (!matchesSearch) return false;
                }

                return true;
            });

            currentPage = 1;
            displayPaginatedResults();
        }, 300);

        function displayPaginatedResults() {
            const totalRecords = filteredMatchResult.length;
            const totalPages = Math.ceil(totalRecords / pageSize);
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, totalRecords);
            const pageData = filteredMatchResult.slice(startIndex, endIndex);

            // æ›´æ–°åˆ†é¡µä¿¡æ¯
            document.getElementById('paginationInfo').textContent = 
                `æ˜¾ç¤º ${startIndex + 1}-${endIndex} æ¡ï¼Œå…± ${totalRecords} æ¡`;

            // æ›´æ–°åˆ†é¡µæŒ‰é’®çŠ¶æ€
            document.getElementById('prevPageBtn').disabled = currentPage === 1;
            document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;

            // æ„å»ºè¡¨æ ¼ - ä½¿ç”¨ DocumentFragment æå‡æ€§èƒ½
            const thead = document.getElementById('resultTableHeader');
            const tbody = document.getElementById('resultTableBody');
            
            thead.innerHTML = '';
            tbody.innerHTML = '';

            if (pageData.length > 0) {
                const headers = Object.keys(pageData[0]);
                
                // è¡¨å¤´ - ä½¿ç”¨ DocumentFragment
                const headerFragment = document.createDocumentFragment();
                const headerRow = document.createElement('tr');
                headers.forEach(key => {
                    const th = document.createElement('th');
                    th.textContent = key;
                    headerRow.appendChild(th);
                });
                headerFragment.appendChild(headerRow);
                thead.appendChild(headerFragment);

                // æ•°æ®è¡Œ - æ‰¹é‡æ’å…¥
                const bodyFragment = document.createDocumentFragment();
                pageData.forEach(record => {
                    const tr = document.createElement('tr');
                    headers.forEach(key => {
                        const td = document.createElement('td');
                        const value = record[key];
                        td.textContent = value !== undefined && value !== null ? value : '';
                        
                        // é«˜äº®é‡è¦åˆ—
                        if (key === 'å›æ¬¾æ”¶æ¬¾é‡‘é¢' || key === 'è®¢å•ç±»å‹') {
                            td.classList.add('highlight');
                        }
                        
                        tr.appendChild(td);
                    });
                    bodyFragment.appendChild(tr);
                });
                tbody.appendChild(bodyFragment);
            } else {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = 100;
                td.style.textAlign = 'center';
                td.style.padding = 'var(--space-xl)';
                td.style.color = 'var(--text-tertiary)';
                td.textContent = 'æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ•°æ®';
                tr.appendChild(td);
                tbody.appendChild(tr);
            }
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                displayPaginatedResults();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(filteredMatchResult.length / pageSize);
            if (currentPage < totalPages) {
                currentPage++;
                displayPaginatedResults();
            }
        }

        function changePageSize() {
            pageSize = parseInt(document.getElementById('pageSize').value);
            currentPage = 1;
            displayPaginatedResults();
        }

        function displayDiagnosticsSummary() {
            const container = document.getElementById('diagnosticsSummary');
            container.innerHTML = '';

            const hasIssues = matchDiagnostics.similarOrderNumbers.length > 0 ||
                             matchDiagnostics.unmatchedOrders.length > 0 ||
                             matchDiagnostics.unmatchedPayments.length > 0;

            if (!hasIssues) {
                container.innerHTML = `
                    <div class="alert alert-success">
                        <strong>âœ… æ•°æ®è´¨é‡è‰¯å¥½</strong><br>
                        æœªå‘ç°è®¢å•å·å†²çªæˆ–æœªåŒ¹é…çš„è®°å½•ã€‚
                    </div>
                `;
                return;
            }

            // åˆ›å»ºæŠ˜å å¼è¯Šæ–­æ‘˜è¦
            const summary = document.createElement('div');
            summary.className = 'diagnostics-summary';
            
            const header = document.createElement('div');
            header.className = 'diagnostics-summary-header';
            
            const title = document.createElement('div');
            title.className = 'diagnostics-summary-title';
            title.innerHTML = 'âš ï¸ æ•°æ®è´¨é‡è¯Šæ–­';
            
            const badges = document.createElement('div');
            badges.className = 'diagnostics-badges';
            
            if (matchDiagnostics.similarOrderNumbers.length > 0) {
                badges.innerHTML += `<span class="diagnostics-badge warning">${matchDiagnostics.similarOrderNumbers.length} ä¸ªç›¸ä¼¼è®¢å•å·</span>`;
            }
            if (matchDiagnostics.unmatchedOrders.length > 0) {
                badges.innerHTML += `<span class="diagnostics-badge error">${matchDiagnostics.unmatchedOrders.length} ä¸ªæœªåŒ¹é…è®¢å•</span>`;
            }
            if (matchDiagnostics.unmatchedPayments.length > 0) {
                badges.innerHTML += `<span class="diagnostics-badge error">${matchDiagnostics.unmatchedPayments.length} ä¸ªæœªåŒ¹é…æ”¶æ¬¾</span>`;
            }
            
            const expandIcon = document.createElement('span');
            expandIcon.textContent = 'â–¼';
            expandIcon.style.fontSize = '14px';
            expandIcon.style.color = 'var(--text-tertiary)';
            
            header.appendChild(title);
            header.appendChild(badges);
            header.appendChild(expandIcon);
            
            // è¯¦ç»†å†…å®¹
            const details = document.createElement('div');
            details.className = 'diagnostics-details';
            
            // ç›¸ä¼¼è®¢å•å·
            if (matchDiagnostics.similarOrderNumbers.length > 0) {
                let html = '<div class="alert alert-warning"><strong>âš ï¸ è­¦å‘Šï¼šå‘ç°ç›¸ä¼¼è®¢å•å·</strong><br>';
                html += 'ä»¥ä¸‹è®¢å•å·éå¸¸ç›¸ä¼¼ï¼Œå¯èƒ½å¯¼è‡´åŒ¹é…æ··æ·†ï¼š<br><br>';
                
                const groupedBySimilarity = {};
                matchDiagnostics.similarOrderNumbers.forEach(item => {
                    const key = `${item.base}-${item.extended}`;
                    if (!groupedBySimilarity[key]) groupedBySimilarity[key] = [];
                    groupedBySimilarity[key].push(item.source);
                });
                
                Object.keys(groupedBySimilarity).forEach(key => {
                    const [base, extended] = key.split('-').slice(0, 2);
                    const sources = [...new Set(groupedBySimilarity[key])];
                    html += `ğŸ“‹ <code>${base}</code> å’Œ <code>${extended}</code> ï¼ˆæ¥æºï¼š${sources.join('ã€')}ï¼‰<br>`;
                });
                html += '</div>';
                details.innerHTML += html;
            }
            
            // æœªåŒ¹é…è®¢å•
            if (matchDiagnostics.unmatchedOrders.length > 0) {
                let html = '<div class="alert alert-danger">';
                html += `<strong>âŒ æœªæ‰¾åˆ°å›æ¬¾çš„è®¢å•ï¼š${matchDiagnostics.unmatchedOrders.length} æ¡</strong><br>`;
                html += 'ä»¥ä¸‹è®¢å•åœ¨æ”¶æ¬¾å•ä¸­æœªæ‰¾åˆ°åŒ¹é…ï¼ˆå›æ¬¾é‡‘é¢å·²è®¾ä¸º0ï¼‰ï¼š<br><br>';
                
                const displayLimit = Math.min(matchDiagnostics.unmatchedOrders.length, 10);
                for (let i = 0; i < displayLimit; i++) {
                    const order = matchDiagnostics.unmatchedOrders[i];
                    html += `ğŸ“„ è®¢å•å·ï¼š<code>${order.orderNumberRaw || order.orderNumber}</code>`;
                    if (order.userName) html += ` | å®¢æˆ·ï¼š${order.userName}`;
                    if (order.model) html += ` | å‹å·ï¼š${order.model}`;
                    if (order.totalAmount) html += ` | é‡‘é¢ï¼šÂ¥${order.totalAmount}`;
                    html += '<br>';
                }
                
                if (matchDiagnostics.unmatchedOrders.length > displayLimit) {
                    html += `<i>... è¿˜æœ‰ ${matchDiagnostics.unmatchedOrders.length - displayLimit} æ¡æœªæ˜¾ç¤º</i><br>`;
                }
                html += '</div>';
                details.innerHTML += html;
            }
            
            // æœªåŒ¹é…æ”¶æ¬¾
            if (matchDiagnostics.unmatchedPayments.length > 0) {
                let html = '<div class="alert alert-danger">';
                html += `<strong>âŒ æœªæ‰¾åˆ°è®¢å•çš„æ”¶æ¬¾ï¼š${matchDiagnostics.unmatchedPayments.length} æ¡</strong><br>`;
                html += 'ä»¥ä¸‹æ”¶æ¬¾è®°å½•åœ¨é”€å”®è®¢å•ä¸­æœªæ‰¾åˆ°åŒ¹é…ï¼š<br><br>';
                
                const displayLimit = Math.min(matchDiagnostics.unmatchedPayments.length, 10);
                for (let i = 0; i < displayLimit; i++) {
                    const payment = matchDiagnostics.unmatchedPayments[i];
                    html += `ğŸ’° è®¢å•å·ï¼š<code>${payment.orderNumber}</code> | é‡‘é¢ï¼šÂ¥${payment.paymentAmount}<br>`;
                }
                
                if (matchDiagnostics.unmatchedPayments.length > displayLimit) {
                    html += `<i>... è¿˜æœ‰ ${matchDiagnostics.unmatchedPayments.length - displayLimit} æ¡æœªæ˜¾ç¤º</i><br>`;
                }
                html += '</div>';
                details.innerHTML += html;
            }
            
            summary.appendChild(header);
            summary.appendChild(details);
            
            // ç‚¹å‡»åˆ‡æ¢å±•å¼€/æŠ˜å 
            header.addEventListener('click', function() {
                summary.classList.toggle('expanded');
                expandIcon.textContent = summary.classList.contains('expanded') ? 'â–²' : 'â–¼';
            });
            
            container.appendChild(summary);
        }

        function exportUnmatchedData() {
            if (matchDiagnostics.unmatchedOrders.length === 0 && 
                matchDiagnostics.unmatchedPayments.length === 0) {
                alert('æ²¡æœ‰æœªåŒ¹é…çš„æ•°æ®éœ€è¦å¯¼å‡ºï¼');
                return;
            }

            const wb = XLSX.utils.book_new();

            // å¯¼å‡ºæœªåŒ¹é…è®¢å•
            if (matchDiagnostics.unmatchedOrders.length > 0) {
                const ws1 = XLSX.utils.json_to_sheet(matchDiagnostics.unmatchedOrders.map(order => ({
                    'è®¢å•å·ï¼ˆåŸå§‹ï¼‰': order.orderNumberRaw,
                    'è®¢å•å·ï¼ˆè§„èŒƒåŒ–ï¼‰': order.orderNumber,
                    'ç”¨æˆ·å§“å': order.userName,
                    'è§„æ ¼å‹å·': order.model,
                    'ä»·ç¨åˆè®¡': order.totalAmount
                })));
                XLSX.utils.book_append_sheet(wb, ws1, 'æœªåŒ¹é…è®¢å•');
            }

            // å¯¼å‡ºæœªåŒ¹é…æ”¶æ¬¾
            if (matchDiagnostics.unmatchedPayments.length > 0) {
                const ws2 = XLSX.utils.json_to_sheet(matchDiagnostics.unmatchedPayments.map(payment => ({
                    'è®¢å•å·': payment.orderNumber,
                    'æ”¶æ¬¾é‡‘é¢': payment.paymentAmount
                })));
                XLSX.utils.book_append_sheet(wb, ws2, 'æœªåŒ¹é…æ”¶æ¬¾');
            }

            // å¯¼å‡ºç›¸ä¼¼è®¢å•å·
            if (matchDiagnostics.similarOrderNumbers.length > 0) {
                const ws3 = XLSX.utils.json_to_sheet(matchDiagnostics.similarOrderNumbers.map(item => ({
                    'æ¥æº': item.source,
                    'åŸºç¡€è®¢å•å·': item.base,
                    'æ‰©å±•è®¢å•å·': item.extended,
                    'åç¼€': item.suffix
                })));
                XLSX.utils.book_append_sheet(wb, ws3, 'ç›¸ä¼¼è®¢å•å·');
            }

            // ç”Ÿæˆæ–‡ä»¶å
            const date = new Date();
            const filename = `æœªåŒ¹é…æ•°æ®è¯Šæ–­_${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2,'0')}${date.getDate().toString().padStart(2,'0')}_${date.getHours().toString().padStart(2,'0')}${date.getMinutes().toString().padStart(2,'0')}.xlsx`;

            // ä¸‹è½½
            XLSX.writeFile(wb, filename);
        }

        function exportResult() {
            if (matchResult.length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®ï¼');
                return;
            }

            // å¯¼å‡ºå‰å¯¹æ‰€æœ‰æŠ˜æ‰£ç‡å­—æ®µè¿›è¡ŒäºŒæ¬¡è§„èŒƒåŒ–
            const discountFields = ['é”€å”®æ”¿ç­–æŠ˜æ‰£ç‡', 'å£æŒ‚ç‚‰é”€å”®æŠ˜æ‰£', 'ç‰¹ä»·æœºå…¬å¸æœ€ä½æŠ˜æ‰£', 'å–å‡ºçš„å®é™…æŠ˜æ‰£'];
            const normalizedResult = matchResult.map(record => {
                const newRecord = { ...record };
                discountFields.forEach(field => {
                    if (field in newRecord) {
                        newRecord[field] = normalizePercentage(newRecord[field]);
                    }
                });
                return newRecord;
            });

            // è½¬æ¢ä¸ºå·¥ä½œè¡¨
            const ws = XLSX.utils.json_to_sheet(normalizedResult);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'åŒ¹é…ç»“æœ');

            // ç”Ÿæˆæ–‡ä»¶å
            const date = new Date();
            const filename = `åŒ¹é…ç»“æœ_${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2,'0')}${date.getDate().toString().padStart(2,'0')}_${date.getHours().toString().padStart(2,'0')}${date.getMinutes().toString().padStart(2,'0')}.xlsx`;

            // ä¸‹è½½
            XLSX.writeFile(wb, filename);
        }
    </script>
</body>
</html>

