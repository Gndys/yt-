# 地区+时间双维度政策配置说明

## 功能概述

系统现已支持同时根据**订单日期**和**订单所属地区**匹配政策，实现同一时间段不同地区执行不同政策的需求。

### 术语说明

- **所属地区**：订单所属的地区（根据客户店名自动识别）
- **适用地区**：政策适用于哪些地区（在政策Excel的O列配置）

## 配置方法

### 1. 政策Excel表格配置

在政策Excel文件的**"活动"子表**（以"活动"开头的Sheet）中，需要配置以下列：

| 列 | 索引 | 字段名 | 说明 | 必填 |
|---|------|--------|------|------|
| M列 | 12 | 政策开始时间 | 格式：2024-10-01 | 推荐 |
| N列 | 13 | 政策结束时间 | 格式：2024-10-31 | 推荐 |
| **O列** | **14** | **适用地区** | **填写"杭州"、"金华"等，留空表示所有地区** | **可选** |

> **重要提示**：时间和地区信息从**第一行数据**中读取（不是表头行），整个Sheet应用该时间段和地区。

### 2. 配置示例

#### 示例1：10月份复杂场景配置

根据需求：
- 10.1-10.8: 所有地区执行9月份政策
- 杭州地区: 10.9-10.23 双11促销，10.24-12.31 杭州特批
- 金华地区: 10.9-10.29 双11促销，10.30-12.31 金华特批

**创建以下Sheet（每个Sheet是独立的政策子表）：**

| Sheet名称 | M列(开始时间) | N列(结束时间) | O列(地区) | 说明 |
|-----------|---------------|---------------|-----------|------|
| 活动9月 | 2024-09-01 | 2024-09-30 | (留空) | 9月全国政策 |
| 活动10月初 | 2024-10-01 | 2024-10-08 | (留空) | 9月政策延续，所有地区 |
| 活动双11杭州 | 2024-10-09 | 2024-10-23 | 杭州 | 双11购物节促销方案（仅杭州） |
| 活动杭州特批 | 2024-10-24 | 2024-12-31 | 杭州 | 杭州特批邮件政策 |
| 活动双11金华 | 2024-10-09 | 2024-10-29 | 金华 | 双11购物节促销方案（仅金华） |
| 活动金华特批 | 2024-10-30 | 2024-12-31 | 金华 | 金华特批邮件政策 |

**配置步骤：**

1. 打开政策Excel文件
2. 创建名为"活动双11杭州"的新Sheet
3. 在该Sheet的**第一行数据**（不是表头）中：
   - M列填写：2024-10-09
   - N列填写：2024-10-23
   - O列填写：杭州
4. 在该Sheet中配置该时间段杭州地区的所有机型政策数据
5. 重复以上步骤创建其他5个Sheet

#### 示例2：全国统一政策（向后兼容）

如果某个政策适用于所有地区，只需将O列**留空**即可：

| Sheet名称 | M列 | N列 | O列 | 说明 |
|-----------|-----|-----|-----|------|
| 活动11月 | 2024-11-01 | 2024-11-30 | (留空) | 全国统一政策 |

## 匹配规则

### 时间+地区双维度匹配

系统按以下优先级匹配政策：

1. **时间匹配**：订单日期在政策时间段内
2. **地区匹配**：
   - 如果政策**未指定地区**（O列为空）→ 适用所有地区 ✅
   - 如果政策**指定了地区** → 必须订单地区与之匹配 ✅
   - 如果订单**地区为空** → 只匹配未指定地区的政策 ❌

### 地区识别规则

系统自动根据"客户店名"识别订单所属地区：

| 客户店名 | 订单所属地区 |
|---------|------------|
| 杭州红星美凯龙一号店 | 杭州 |
| 萧山第六空间专卖店 | 杭州 |
| （新）滨江第六空间专卖店 | 杭州 |
| 滨江六空8090店 | 杭州 |
| 杭州恒大建材超级旗舰店 | 杭州 |
| 杭州临平江南家居专卖店 | 杭州 |
| 金华龙腾建材市场专卖店 | 金华 |

> 支持精确匹配和模糊匹配（如店名包含"杭州"则识别为杭州地区）

## 匹配说明示例

系统会在"销售政策匹配说明"列中提供详细的匹配结果：

### 成功匹配
```
匹配成功：活动双11杭州（2024-10-09 ~ 2024-10-23）【适用地区：杭州】
```

### 时间和地区都匹配，但型号不在表中
```
未匹配：型号"JSQ31-VJSAI"不在政策表"活动双11杭州"（2024-10-09 ~ 2024-10-23）【适用地区：杭州】中
```

### 时间匹配但地区不匹配
```
未匹配：订单所属地区"金华"与时间段内政策的适用地区不符（时间段内的政策：活动双11杭州（适用杭州））
```

### 订单地区未识别
```
未匹配：订单所属地区未识别，无法匹配需要指定适用地区的政策（时间段内的政策：活动双11杭州（适用杭州））
```

### 时间不匹配
```
未匹配：订单日期"2024-11-15"不在任何政策时间段内（可用政策：2024-10-09~2024-10-23【适用杭州】、2024-10-09~2024-10-29【适用金华】）
```

## 使用流程

### 第一步：准备政策Excel
1. 打开现有政策Excel文件
2. 为每个时间+地区组合创建独立的"活动"子表
3. 在每个子表的第一行数据中填写M列（开始时间）、N列（结束时间）、O列（地区）
4. 在子表中配置该时间段该地区的所有机型政策数据

### 第二步：上传到匹配工具
1. 打开"匹配工具.html"
2. 在"上传文件"步骤中，上传配置好的政策Excel
3. 系统会自动识别所有"活动"子表，并显示时间段和适用地区信息：
   ```
   📅 销售政策时间段（6个）：
     1. 活动9月: 2024-09-01 ~ 2024-09-30 【适用地区：所有地区】
     2. 活动10月初: 2024-10-01 ~ 2024-10-08 【适用地区：所有地区】
     3. 活动双11杭州: 2024-10-09 ~ 2024-10-23 【适用地区：杭州】
     4. 活动杭州特批: 2024-10-24 ~ 2024-12-31 【适用地区：杭州】
     5. 活动双11金华: 2024-10-09 ~ 2024-10-29 【适用地区：金华】
     6. 活动金华特批: 2024-10-30 ~ 2024-12-31 【适用地区：金华】
   ```

### 第三步：配置字段映射
- 系统会自动智能映射字段
- 可点击"一键智能映射"快速完成

### 第四步：执行匹配
- 点击"开始匹配"
- 系统会根据订单日期和地区自动匹配正确的政策
- 查看"销售政策匹配说明"列了解匹配结果

## 测试场景

### 场景1：杭州地区订单

| 订单日期 | 客户店名 | 所属地区 | 匹配结果 |
|---------|---------|---------|---------|
| 2024-10-05 | 杭州红星美凯龙一号店 | 杭州 | 活动10月初（适用所有地区） |
| 2024-10-15 | 杭州红星美凯龙一号店 | 杭州 | 活动双11杭州（适用杭州） |
| 2024-10-25 | 杭州红星美凯龙一号店 | 杭州 | 活动杭州特批（适用杭州） |

### 场景2：金华地区订单

| 订单日期 | 客户店名 | 所属地区 | 匹配结果 |
|---------|---------|---------|---------|
| 2024-10-05 | 金华龙腾建材市场专卖店 | 金华 | 活动10月初（适用所有地区） |
| 2024-10-15 | 金华龙腾建材市场专卖店 | 金华 | 活动双11金华（适用金华） |
| 2024-11-05 | 金华龙腾建材市场专卖店 | 金华 | 活动金华特批（适用金华） |

### 场景3：跨地区错配

| 订单日期 | 客户店名 | 所属地区 | 匹配结果 |
|---------|---------|---------|---------|
| 2024-10-15 | 金华龙腾建材市场专卖店 | 金华 | ❌ 不会匹配杭州政策 |
| 2024-10-15 | 杭州红星美凯龙一号店 | 杭州 | ❌ 不会匹配金华政策 |

### 场景4：未识别地区的订单

| 订单日期 | 客户店名 | 所属地区 | 匹配结果 |
|---------|---------|---------|---------|
| 2024-10-15 | 其他门店 | (空) | 活动10月初（仅匹配未指定适用地区的政策） |

## 注意事项

1. **Sheet命名**：必须以"活动"开头，如"活动10月"、"活动双11杭州"
2. **时间格式**：建议使用 YYYY-MM-DD 格式，如 2024-10-09
3. **地区名称**：要与门店映射表中的地区名称一致（如"杭州"、"金华"）
4. **数据位置**：M、N、O列的值从**第一行数据**读取（不是表头行）
5. **优先级**：时间段重叠时，按Sheet顺序优先匹配第一个符合条件的政策
6. **向后兼容**：O列留空的政策表将适用于所有地区，与旧版本兼容

## 常见问题

### Q1: 同一时间段可以有多个地区政策吗？
**A**: 可以。创建多个Sheet，每个Sheet设置不同的地区即可。

### Q2: 如果订单所属地区无法识别会怎样？
**A**: 只会匹配O列为空（即未指定适用地区）的政策，不会匹配指定了适用地区的政策。

### Q3: 可以同时计算上个月和这个月的吗？
**A**: 可以。只要在政策Excel中配置好所有月份的政策子表，系统会自动根据订单日期匹配对应的政策。

### Q4: 时间段可以重叠吗？
**A**: 可以，但系统会按Sheet顺序匹配第一个符合时间和地区条件的政策。建议合理规划避免冲突。

### Q5: 旧的政策Excel还能用吗？
**A**: 可以。如果没有设置O列（地区），系统会认为该政策适用于所有地区，与旧版本行为一致。

## 技术支持

如有问题，请检查：
1. 政策Excel中M、N、O列的值是否正确填写在**第一行数据**中
2. 地区名称是否与系统识别的地区名称一致
3. 订单的"客户店名"是否能正确识别为对应地区
4. 查看"销售政策匹配说明"列的详细信息定位问题

