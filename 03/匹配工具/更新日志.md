# 匹配工具更新日志

## 版本 2.1 - 2025-10-28

### 新增功能

#### 📋 销售政策匹配说明

- **新增字段**：自动添加"销售政策匹配说明"列
- **显示内容**：
  - 匹配成功时：显示匹配的子表名称和时间段
  - 匹配失败时：**精确区分**失败原因
    - 日期在范围内但型号不存在
    - 订单日期不在任何政策时间段内
    - 列出所有可用时间段供参考
- **使用价值**：便于核对和排查匹配问题，快速定位是日期问题还是型号问题

## 版本 2.0 - 2025-10-28

### 新增功能

#### 🎯 销售政策时间段匹配

- **功能描述**：支持根据销售订单日期自动匹配对应时间段的销售政策
- **使用场景**：不同时间段有不同的促销政策（如9月促销、10月促销等）

#### 主要特性

1. **多时间段支持**
   - 支持在政策表中创建多个活动子表，每个对应一个时间段
   - 自动识别所有以"活动"开头的子表
   - 每个时间段的政策独立管理

2. **智能日期匹配**
   - 根据销售订单的日期字段，自动选择对应时间段的政策
   - 支持多种日期格式：`2025.9.15`、`2025/9/15`、`2025-09-15`
   - 订单日期不在任何时间段内时，销售政策字段留空

3. **界面增强**
   - 政策表上传后显示所有活动子表及其时间段
   - 为每个活动子表创建独立的字段映射区域
   - 清晰展示时间段范围

### 技术改进

#### 数据结构优化
- 将 `dataStore.policy.sheets.activity` 从对象改为数组
- 支持存储多个活动子表及其元数据（时间段、数据、表头）

#### 新增函数
- `parseDate(value)`: 解析多种日期格式
- `findMatchingActivitySheet(orderDate)`: 根据日期查找匹配的政策子表
- `displayActivitySheetsInfo()`: 显示活动子表加载信息

#### 修改函数
- `loadPolicySheets()`: 支持加载多个活动子表
- `updateMappingUI()`: 为每个活动子表创建映射区域
- `extractMappings()`: 提取所有活动子表的字段映射
- `buildIndexes()`: 为每个活动子表构建独立索引
- 匹配逻辑：根据订单日期动态选择政策子表

### 配置要求

#### 政策表格式
- **子表命名**：以"活动"开头（如`活动_2025.9.15-2025.10.8`）
- **时间字段**：
  - M列（索引12）：政策开始时间
  - N列（索引13）：政策结束时间
- **其他列**：保持原有格式不变

### 兼容性

- ✅ **向后兼容**：如果只有一个"活动"子表，工具仍能正常工作
- ✅ **可选功能**：如果活动子表未设置时间段，仅该功能不可用
- ✅ **不影响其他功能**：收款单、带单费、其他政策表匹配均不受影响

### 文档

新增以下文档：
- `销售政策时间段匹配说明.md` - 详细使用说明
- `测试指南_时间段匹配.md` - 测试步骤和检查清单
- `更新日志.md` - 本文档

### 使用示例

**政策表结构：**
```
子表1: 活动_金秋促销 (2025.9.15 ~ 2025.10.8)
子表2: 活动_国庆特惠 (2025.10.9 ~ 2025.10.20)
```

**匹配结果：**
- 日期为 2025.9.20 的订单 → 使用"金秋促销"政策
- 日期为 2025.10.15 的订单 → 使用"国庆特惠"政策
- 日期为 2025.10.25 的订单 → 销售政策字段为空

### 升级指导

#### 对于新用户
直接按照 `销售政策时间段匹配说明.md` 配置政策表即可。

#### 对于现有用户
1. **无需修改**：如果现有政策表只有一个"活动"子表，无需任何修改
2. **可选升级**：如需使用时间段功能：
   - 在每个活动子表的M、N列添加时间段
   - 或创建新的活动子表，使用新的命名规范

### 已知限制

1. **时间字段固定位置**：M列和N列（索引12和13）
2. **优先级规则**：如果时间段重叠，使用第一个匹配的子表
3. **时间段来源**：从第一行数据的M、N列读取

### 下个版本计划

- [ ] 支持自定义时间字段列位置
- [ ] 时间段重叠检测和警告
- [ ] 批量时间段验证工具
- [ ] 时间段可视化日历

---

## 版本 1.0 - 之前

### 基础功能
- 销售订单、收款单、带单费、政策表匹配
- 门店筛选
- 退货识别
- 国补识别
- 数据诊断
- Excel导出

---

**维护者**：AI Assistant  
**更新日期**：2025-10-28

