# 匹配工具修复验证

## 已修复的问题

### 1. ✅ 自动跳过Excel前面的空白行
- **问题**：收款单、政策表前面有2行空白，导致把空白行当成表头
- **修复**：添加智能检测，自动找到实际表头行（前5行内）
- **验证**：查看浏览器控制台，应显示"表头行=2"等信息

### 2. ✅ 从销售订单直接读取收款金额
- **问题**：外部收款单是按客户汇总的，无法按订单号匹配
- **修复**：添加"累计收款金额"字段映射，直接从销售订单读取
- **验证**：匹配后，收款金额应从销售订单的"累计收款金额"列获取

### 3. ✅ 优化收款匹配逻辑
- **策略**：
  1. 优先使用销售订单内的"累计收款金额"
  2. 如果订单内没有，再从外部收款单匹配
  3. 如果外部收款单金额更大，使用外部的
- **验证**：检查导出结果中的"收款金额"列

## 使用说明

### 必需文件
1. **销售订单表** - 必须包含以下字段：
   - 单据编号
   - 规格型号
   - 累计收款金额（重要！）
   - 系统定价
   - 价税合计
   - 促销员
   - 等其他业务字段

### 可选文件
2. **带单费表** - 可选，包含：
   - 单号（对应销售订单的单据编号）
   - 支付带单提成点位
   - 折扣（卖出的实际折扣）

3. **政策表** - 可选，自动加载所有子表：
   - 特价机整理
   - 佳尼特
   - 壁挂炉
   - 活动

4. **收款单** - 通常不需要，除非销售订单内没有收款数据

## 测试步骤

1. 打开 `匹配工具.html`
2. 上传 `中冠9月销售订单_20251009.xlsx`
3. 上传 `政策表.xlsx`
4. （可选）上传 `2025年带单费(1).xls`
5. 检查字段映射是否正确
6. 点击"开始匹配"
7. 查看结果统计
8. 导出结果文件

## 预期结果

### 控制台日志示例
```
salesOrder 读取成功: 表头行=0, 数据行数=1292
政策表-特价机整理 读取成功: 表头行=0, 数据行数=XXX
```

### 匹配统计（预期）
- 总记录数：1292
- 收款匹配：365+ (来自订单内的累计收款金额)
- 带单费匹配：如果单号对应则匹配（注意：测试数据中带单费是1月的，订单是9月的，可能不匹配）
- 特价机匹配：根据规格型号匹配
- 佳尼特匹配：根据规格型号匹配
- 壁挂炉匹配：根据规格型号匹配
- 活动匹配：根据规格型号匹配

## 可能的问题

### 问题1：带单费匹配数为0
- **原因**：带单费表的单号是1月份的（A202501...），销售订单是9月份的（A202509...）
- **解决**：使用对应月份的带单费表

### 问题2：政策表匹配数少
- **原因**：销售订单的"规格型号"与政策表的"型号"不完全一致
- **解决**：检查字段内容，可能需要数据清洗或模糊匹配

### 问题3：收款金额仍为空
- **原因**：销售订单表中"累计收款金额"字段也为空
- **解决**：检查源数据，或提供按单号的收款单

## 下一步

完成匹配后，将导出的结果文件导入到 `03 五合一提成计算.html` 进行提成计算。

