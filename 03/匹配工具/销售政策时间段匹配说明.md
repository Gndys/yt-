# 销售政策时间段匹配功能说明

## 功能概述

匹配工具现已支持根据销售订单的日期，自动匹配对应时间段的销售政策。这意味着您可以在政策表中维护多个时间段的销售政策，工具会自动选择正确的政策进行匹配。

## 政策表格式要求

### 1. 活动子表命名

在政策表Excel文件中，所有以 **"活动"** 开头的子表都会被识别为销售政策表。建议命名格式：

- `活动` （单一政策，向后兼容）
- `活动_2025.9.15-2025.10.8`
- `活动_2025.10.9-2025.11.15`
- `活动_金秋促销`
- 等等...

### 2. 时间段字段位置

每个活动子表中，需要在以下列位置添加时间段信息：

- **M列（第13列）**：政策开始时间
- **N列（第14列）**：政策结束时间

**重要说明：**
- 时间字段应填写在每一行数据中（工具会从第一行数据读取时间段）
- 支持的日期格式：`2025.9.15`、`2025/9/15`、`2025-09-15` 等
- 如果某个活动子表缺少时间段，该子表仍会加载但不会参与日期匹配

### 3. 示例表格结构

```
| 型号        | 折扣率 | 提成 | 加提 | 加提要求 | ... | 政策开始时间 | 政策结束时间 |
|------------|--------|------|------|----------|-----|-------------|-------------|
| CXW-200-S2 | 60%    | 10%  |      | JZT-V2B2S| ... | 2025.9.15   | 2025.10.8   |
| CXW-200-S3 | 60%    | 10%  |      | JZT-V2B2S| ... | 2025.9.15   | 2025.10.8   |
```

## 使用流程

### 步骤1：准备政策表

1. 为每个时间段的销售政策创建独立的子表
2. 子表名称以"活动"开头
3. 在每行数据的M列和N列填写政策开始和结束时间

### 步骤2：上传文件

在匹配工具中上传政策表Excel文件，工具会：
- 自动识别所有以"活动"开头的子表
- 读取每个子表的时间段信息
- 在文件信息区域显示已加载的活动子表及其时间段

### 步骤3：配置字段映射

工具会为每个活动子表创建独立的字段映射区域，标题格式如：
```
政策表 - 活动_2025.9.15-2025.10.8 (2025.9.15 ~ 2025.10.8)
```

您需要为每个活动子表配置字段映射（通常系统会自动识别）。

### 步骤4：执行匹配

点击"开始匹配"按钮，工具会：
1. 读取每个销售订单的日期
2. 遍历所有活动子表，找到订单日期在时间范围内的子表
3. 从匹配的子表中查找该订单的型号，提取销售政策字段
4. 如果订单日期不在任何政策时间段内，销售政策字段留空

## 匹配逻辑

### 日期匹配规则

对于每个销售订单：
1. 提取订单的"日期"字段
2. 遍历所有活动子表
3. 如果 `订单日期 >= 政策开始时间` 且 `订单日期 <= 政策结束时间`，则使用该子表
4. 在匹配的子表中查找订单的"规格型号"
5. 提取对应的销售政策字段（折扣率、提成、加提等）
6. **自动添加"销售政策匹配说明"字段**，记录匹配来源和时间段

### 匹配说明字段

工具会自动为每条记录添加**"销售政策匹配说明"**列，显示匹配详情：

**成功匹配时：**
- 有时间段：`匹配成功：活动_2025.9.15-2025.10.8（2025.9.15 ~ 2025.10.8）`
- 无时间段：`匹配成功：活动（未设置时间段）`

**未匹配时（精确说明）：**
- 日期匹配但型号不存在：`未匹配：型号"CXW-300-X1"不在政策表"活动_2025.9.15-2025.10.8"（2025.9.15 ~ 2025.10.8）中`
- 订单日期不在任何时间段：`未匹配：订单日期"2025.8.20"不在任何政策时间段内（可用时间段：2025.9.15~2025.10.8、2025.10.9~2025.10.20）`
- 型号不存在（无时间段模式）：`未匹配：型号"CXW-300-X1"不在政策表中`
- 未上传：`未匹配：未上传销售政策表`

### 优先级

- 如果一个订单日期同时匹配多个活动子表（时间段重叠），使用**第一个**匹配的子表
- 建议避免时间段重叠，确保每个日期只对应一个政策

## 界面提示

### 文件上传后

政策表上传成功后，文件信息区域会显示：
```
✓ 政策表已加载
📅 销售政策时间段（2个）：
  1. 活动_2025.9.15-2025.10.8: 2025.9.15 ~ 2025.10.8
  2. 活动_2025.10.9-2025.11.15: 2025.10.9 ~ 2025.11.15
```

### 匹配结果

匹配完成后，统计信息中会显示销售政策的匹配数量。

## 兼容性说明

### 向后兼容

如果政策表中只有一个名为"活动"的子表（无时间段），工具仍能正常工作：
- 该子表会被加载
- 如果未设置M、N列的时间段，则提示"未设置时间段"
- 所有订单的销售政策字段会留空（因为没有时间段信息）

### 建议

为了充分利用新功能，建议：
1. 在每个活动子表的M、N列设置时间段
2. 确保时间段不重叠
3. 保留历史政策子表，便于查询和审计

## 故障排查

### 问题1：销售政策字段全部为空

**可能原因：**
- 活动子表未设置M、N列的时间段
- 订单日期不在任何政策时间段内
- 订单日期格式无法解析

**解决方法：**
1. 检查活动子表的M、N列是否填写了时间段
2. 检查销售订单的日期是否在政策时间范围内
3. 检查日期格式是否正确

### 问题2：未识别活动子表

**可能原因：**
- 子表名称未以"活动"开头

**解决方法：**
- 确保子表名称以"活动"开头（区分大小写）

### 问题3：时间段显示"未设置时间段"

**可能原因：**
- M列或N列为空
- 第一行数据为空

**解决方法：**
- 在每行数据的M、N列填写时间段（工具会读取第一行数据）

## 注意事项

1. **时间格式**：支持 `2025.9.15`、`2025/9/15`、`2025-09-15` 等格式
2. **列位置**：M列=开始时间，N列=结束时间（固定，索引12和13）
3. **时间段重叠**：避免多个活动子表的时间段重叠
4. **数据完整性**：确保每个活动子表的第一行数据包含时间段信息

## 示例场景

### 场景：9月和10月的不同促销政策

**政策表结构：**
- 子表1：`活动_金秋促销` (2025.9.15 ~ 2025.10.8)
- 子表2：`活动_国庆特惠` (2025.10.9 ~ 2025.10.20)

**销售订单：**
- 订单A：日期 2025.9.20 → 匹配子表1的政策
- 订单B：日期 2025.10.15 → 匹配子表2的政策
- 订单C：日期 2025.10.25 → 不匹配任何政策，销售政策字段为空

## 技术支持

如有问题，请查看控制台日志（F12打开浏览器开发者工具），其中包含详细的加载和匹配信息。

