# 套餐1匹配问题排查指南

## 问题描述
以下两条记录应该匹配到**套餐1**,但实际未匹配成功:

| 字段 | 记录1 | 记录2 |
|------|-------|-------|
| 日期 | 2025/10/14 | 2025/10/14 |
| 单据编号 | A20251014000644 | A20251014000643 |
| 用户姓名 | 钟正祥 | 钟正祥 |
| 规格型号 | JZT-V2B2S | CXW-350-Q2CWi |
| 销售数量 | 1 | 1 |
| 价税合计 | 3098 | 5100 |
| 客户店名 | 杭州临平江南家居专卖店 | 杭州临平江南家居专卖店 |

## 套餐1定义
- **产品组合**: `CXW-350-Q2CWI` + `JZT-V2B2S`
- **套餐价**: 5098元
- **提成**: 300元

## 排查步骤

### 1. 准备测试数据
创建一个Excel文件,包含以下列(最少需要这些):
- 单据编号
- 客户店名 (或用户姓名)
- 规格型号
- 促销员
- 销售数量

示例数据:
```
单据编号          客户店名                    规格型号          促销员    销售数量
A20251014000643   杭州临平江南家居专卖店      CXW-350-Q2CWi     余亚炜    1
A20251014000644   杭州临平江南家居专卖店      JZT-V2B2S         余亚炜    1
```

### 2. 导入数据到工具
1. 打开 `活动套餐前置.html`
2. 上传准备好的Excel文件
3. 完成字段映射(确保所有必需字段都正确映射)
4. 点击"解析数据"按钮

### 3. 运行套餐计算
1. 点击"计算旧套餐"按钮
2. 打开浏览器控制台(F12 → Console)
3. 查看调试日志

### 4. 查看调试日志
控制台应该输出类似以下内容:

```
=== 客户: 杭州临平江南家居专卖店 ===
产品池: CXW-350-Q2CWI(1台), JZT-V2B2S(1台)
原始产品: CXW-350-Q2CWi(标准化:CXW-350-Q2CWI, 订单:A20251014000643), JZT-V2B2S(标准化:JZT-V2B2S, 订单:A20251014000644)
套餐匹配顺序: 套餐1(2件) → 套餐2(2件) → ...

尝试匹配套餐1，需要产品: CXW-350-Q2CWI(标准化:CXW-350-Q2CWI), JZT-V2B2S(标准化:JZT-V2B2S)
  套餐1: ✓ 找到产品 CXW-350-Q2CWI → CXW-350-Q2CWi (订单:A20251014000643)
  套餐1: ✓ 找到产品 JZT-V2B2S → JZT-V2B2S (订单:A20251014000644)
  ✅ 套餐1 匹配成功: CXW-350-Q2CWI + JZT-V2B2S → 提成¥300
```

## 可能的问题原因

### 原因1: 客户名称不匹配
**症状**: 控制台没有任何调试输出

**解决方案**: 
- 检查Excel中的"客户店名"字段是否完全一致
- 注意空格、标点符号等细节
- 当前调试会匹配包含"钟正祥"或"杭州临平江南家居"的客户

### 原因2: 型号标准化问题
**症状**: 控制台显示"❌ 缺少产品"

**解决方案**:
- 检查型号是否包含特殊字符
- `normalizeModel` 函数会:
  - 转换为大写
  - 去除空格
  - 只保留字母、数字、连字符

### 原因3: 数据未正确导入
**症状**: 控制台完全没有输出,或显示"产品池为空"

**解决方案**:
- 确认字段映射正确
- 检查"销售数量"是否为有效数字
- 确保必需字段(单据编号、客户、型号、促销员)都有值

### 原因4: 产品被其他套餐消耗
**症状**: 控制台显示"❌ 产品已被使用完"

**解决方案**:
- 检查是否有其他套餐优先匹配了这些产品
- 套餐按产品数量从少到多排序,2件套应该优先于3件套
- 检查套餐规则定义是否正确

## 已优化的调试功能

已增强调试日志,现在会自动输出包含以下关键词的客户的详细匹配过程:
- "钟正祥"
- "杭州临平江南家居"

如需调试其他客户,修改第1580行:
```javascript
const debugThis = customer.includes('钟正祥') || customer.includes('杭州临平江南家居');
```

添加更多匹配条件即可。

## 验证成功标志

如果套餐1匹配成功,应该看到:
1. ✅ 控制台有完整的匹配日志
2. ✅ 页面"旧套餐计算结果"表格中显示套餐1
3. ✅ 提成金额为300元
4. ✅ 产品详情显示两个型号

## 下一步

如果按照以上步骤仍然无法匹配,请:
1. 截图控制台的完整输出
2. 导出Excel数据的前几行
3. 提供详细的错误信息

这样可以进一步定位问题。
