<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>å¥—é¤1åŒ¹é…æµ‹è¯•</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 1000px; margin: 0 auto; }
    h1 { color: #2c3e50; }
    .test-section { background: #f8f9fa; padding: 15px; margin: 15px 0; border-radius: 5px; }
    .result { margin: 10px 0; padding: 10px; border-left: 4px solid #3b82f6; background: white; }
    .success { border-left-color: #10b981; }
    .error { border-left-color: #ef4444; }
    button { background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
    button:hover { background: #2563eb; }
    pre { background: #1e293b; color: #e2e8f0; padding: 15px; border-radius: 5px; overflow-x: auto; }
    .info { background: #eff6ff; padding: 10px; border-radius: 5px; margin: 10px 0; }
  </style>
</head>
<body>
  <h1>å¥—é¤1åŒ¹é…é€»è¾‘æµ‹è¯•</h1>
  
  <div class="info">
    <strong>æµ‹è¯•ç›®çš„:</strong> éªŒè¯ CXW-350-Q2CWi + JZT-V2B2S æ˜¯å¦èƒ½åŒ¹é…å¥—é¤1
  </div>

  <div class="test-section">
    <h2>æµ‹è¯•1: å‹å·æ ‡å‡†åŒ–</h2>
    <button onclick="testNormalization()">è¿è¡Œæµ‹è¯•</button>
    <div id="normResult"></div>
  </div>

  <div class="test-section">
    <h2>æµ‹è¯•2: å¥—é¤åŒ¹é…é€»è¾‘</h2>
    <button onclick="testPackageMatch()">è¿è¡Œæµ‹è¯•</button>
    <div id="matchResult"></div>
  </div>

  <div class="test-section">
    <h2>æµ‹è¯•3: å®Œæ•´æµç¨‹æ¨¡æ‹Ÿ</h2>
    <button onclick="testFullProcess()">è¿è¡Œæµ‹è¯•</button>
    <div id="fullResult"></div>
  </div>

  <script>
    // å¤åˆ¶è‡ªæ´»åŠ¨å¥—é¤å‰ç½®.htmlçš„å‡½æ•°
    function safeStr(v){ return v===undefined || v===null ? '' : String(v).trim(); }
    function normalizeModel(m){ return safeStr(m).toUpperCase().replace(/\s+/g,'').replace(/[^A-Z0-9-]/g,''); }

    // å¥—é¤è§„åˆ™
    const oldPackageRules = [
      { id: 1, products: ['CXW-350-Q2CWI', 'JZT-V2B2S'], commission: 300 },
      { id: 2, products: ['CXW-400-Z3AWi', 'JZT-V2B2S'], commission: 400 },
      { id: 3, products: ['CXW-350-Q2CWI', 'JZT-V2B2S', 'DWQ10-SR3HWI'], commission: 500 },
      { id: 4, products: ['CXW-350-Q2CWi', 'JZT-V2B2S', 'KZQ45-M1wi'], commission: 500 }
    ];

    function testNormalization() {
      const testCases = [
        { input: 'CXW-350-Q2CWi', expected: 'CXW-350-Q2CWI' },
        { input: 'CXW-350-Q2CWI', expected: 'CXW-350-Q2CWI' },
        { input: 'JZT-V2B2S', expected: 'JZT-V2B2S' },
        { input: 'jzt-v2b2s', expected: 'JZT-V2B2S' }
      ];

      let html = '<h3>å‹å·æ ‡å‡†åŒ–æµ‹è¯•ç»“æœ:</h3>';
      let allPass = true;

      testCases.forEach(tc => {
        const result = normalizeModel(tc.input);
        const pass = result === tc.expected;
        allPass = allPass && pass;
        
        html += `<div class="result ${pass ? 'success' : 'error'}">
          è¾“å…¥: <code>${tc.input}</code> â†’ 
          è¾“å‡º: <code>${result}</code> 
          ${pass ? 'âœ…' : 'âŒ æœŸæœ›: ' + tc.expected}
        </div>`;
      });

      html += `<div class="result ${allPass ? 'success' : 'error'}">
        <strong>æ€»ä½“ç»“æœ: ${allPass ? 'âœ… å…¨éƒ¨é€šè¿‡' : 'âŒ å­˜åœ¨å¤±è´¥'}</strong>
      </div>`;

      document.getElementById('normResult').innerHTML = html;
    }

    function testPackageMatch() {
      // æ¨¡æ‹Ÿç”¨æˆ·æ•°æ®
      const userProducts = [
        { model: 'CXW-350-Q2CWi', modelNorm: normalizeModel('CXW-350-Q2CWi'), orderNo: 'A20251014000643' },
        { model: 'JZT-V2B2S', modelNorm: normalizeModel('JZT-V2B2S'), orderNo: 'A20251014000644' }
      ];

      let html = '<h3>å¥—é¤åŒ¹é…æµ‹è¯•:</h3>';
      html += '<div class="info">ç”¨æˆ·äº§å“: ' + userProducts.map(p => `${p.model} (æ ‡å‡†åŒ–: ${p.modelNorm})`).join(', ') + '</div>';

      // æ„å»ºäº§å“æ± 
      const modelPool = {};
      userProducts.forEach(rec => {
        const nm = rec.modelNorm;
        if(!modelPool[nm]) modelPool[nm] = [];
        modelPool[nm].push({ record: rec, used: false });
      });

      html += '<div class="info">äº§å“æ± : ' + Object.keys(modelPool).map(k => `${k}(${modelPool[k].length}å°)`).join(', ') + '</div>';

      // æŒ‰äº§å“æ•°é‡æ’åº
      const sortedRules = oldPackageRules.slice().sort((a, b) => {
        if (a.products.length !== b.products.length) {
          return a.products.length - b.products.length;
        }
        return a.id - b.id;
      });

      html += '<div class="info">åŒ¹é…é¡ºåº: ' + sortedRules.map(r => `å¥—é¤${r.id}(${r.products.length}ä»¶)`).join(' â†’ ') + '</div>';

      // å°è¯•åŒ¹é…æ¯ä¸ªå¥—é¤
      sortedRules.forEach(rule => {
        html += `<div class="result">`;
        html += `<strong>å¥—é¤${rule.id}</strong>: éœ€è¦ ${rule.products.map(p => `${p}(æ ‡å‡†åŒ–:${normalizeModel(p)})`).join(' + ')}<br>`;
        
        let canMatch = true;
        const tempPick = [];
        const logs = [];

        rule.products.forEach(req => {
          const reqNorm = normalizeModel(req);
          const poolArr = modelPool[reqNorm];
          
          if(!poolArr) {
            logs.push(`âŒ ç¼ºå°‘äº§å“ ${req} (æ ‡å‡†åŒ–: ${reqNorm})`);
            canMatch = false;
            return;
          }
          
          const pick = poolArr.find(p => !p.used);
          if(!pick) {
            logs.push(`âŒ äº§å“ ${req} å·²è¢«ä½¿ç”¨å®Œ`);
            canMatch = false;
            return;
          }
          
          logs.push(`âœ“ æ‰¾åˆ°äº§å“ ${req} â†’ ${pick.record.model} (è®¢å•:${pick.record.orderNo})`);
          tempPick.push({ required: req, norm: reqNorm, pick });
        });

        html += logs.join('<br>') + '<br>';

        if(canMatch) {
          tempPick.forEach(p => { p.pick.used = true; });
          html += `<strong style="color: #10b981;">âœ… åŒ¹é…æˆåŠŸ! ææˆ: Â¥${rule.commission}</strong>`;
        } else {
          html += `<strong style="color: #ef4444;">âŒ åŒ¹é…å¤±è´¥</strong>`;
        }

        html += `</div>`;
      });

      document.getElementById('matchResult').innerHTML = html;
    }

    function testFullProcess() {
      let html = '<h3>å®Œæ•´æµç¨‹æµ‹è¯•:</h3>';
      let logs = [];

      // æ­¥éª¤1: æ•°æ®å‡†å¤‡
      logs.push('ğŸ“‹ æ­¥éª¤1: å‡†å¤‡æµ‹è¯•æ•°æ®');
      const testData = [
        { orderNo: 'A20251014000643', customer: 'æ­å·ä¸´å¹³æ±Ÿå—å®¶å±…ä¸“å–åº—', model: 'CXW-350-Q2CWi', salesman: 'ä½™äºšç‚œ', quantity: 1 },
        { orderNo: 'A20251014000644', customer: 'æ­å·ä¸´å¹³æ±Ÿå—å®¶å±…ä¸“å–åº—', model: 'JZT-V2B2S', salesman: 'ä½™äºšç‚œ', quantity: 1 }
      ];
      logs.push(`  âœ“ å‡†å¤‡äº† ${testData.length} æ¡è®°å½•`);

      // æ­¥éª¤2: æ ‡å‡†åŒ–
      logs.push('ğŸ”„ æ­¥éª¤2: å‹å·æ ‡å‡†åŒ–');
      const baseRecords = testData.map(d => ({
        ...d,
        modelNorm: normalizeModel(d.model)
      }));
      baseRecords.forEach(r => {
        logs.push(`  ${r.model} â†’ ${r.modelNorm}`);
      });

      // æ­¥éª¤3: åˆ†ç»„
      logs.push('ğŸ‘¥ æ­¥éª¤3: æŒ‰å®¢æˆ·åˆ†ç»„');
      const grouped = {};
      baseRecords.forEach(r => {
        const key = r.customer;
        if(!grouped[key]) {
          grouped[key] = { salesman: r.salesman, items: [] };
        }
        grouped[key].items.push(r);
      });
      logs.push(`  âœ“ åˆ†ç»„å®Œæˆï¼Œå…± ${Object.keys(grouped).length} ä¸ªå®¢æˆ·`);

      // æ­¥éª¤4: å¥—é¤åŒ¹é…
      logs.push('ğŸ¯ æ­¥éª¤4: å¥—é¤åŒ¹é…');
      const results = [];
      
      Object.entries(grouped).forEach(([customer, info]) => {
        logs.push(`  å®¢æˆ·: ${customer}`);
        
        const modelPool = {};
        info.items.forEach(rec => {
          const nm = rec.modelNorm;
          if(!modelPool[nm]) modelPool[nm] = [];
          modelPool[nm].push({ record: rec, used: false });
        });
        
        logs.push(`    äº§å“æ± : ${Object.keys(modelPool).join(', ')}`);

        const sortedRules = oldPackageRules.slice().sort((a, b) => {
          if (a.products.length !== b.products.length) {
            return a.products.length - b.products.length;
          }
          return a.id - b.id;
        });

        sortedRules.forEach(rule => {
          let canMatch = true;
          const tempPick = [];

          rule.products.forEach(req => {
            const reqNorm = normalizeModel(req);
            const poolArr = modelPool[reqNorm];
            if(!poolArr || !poolArr.find(p => !p.used)) {
              canMatch = false;
              return;
            }
            const pick = poolArr.find(p => !p.used);
            tempPick.push({ pick });
          });

          if(canMatch) {
            tempPick.forEach(p => { p.pick.used = true; });
            results.push({
              customer,
              packageId: rule.id,
              commission: rule.commission
            });
            logs.push(`    âœ… åŒ¹é…å¥—é¤${rule.id}ï¼ŒææˆÂ¥${rule.commission}`);
          }
        });
      });

      // æ­¥éª¤5: ç»“æœæ±‡æ€»
      logs.push('ğŸ“Š æ­¥éª¤5: ç»“æœæ±‡æ€»');
      logs.push(`  âœ“ å…±åŒ¹é… ${results.length} ä¸ªå¥—é¤`);
      logs.push(`  âœ“ æ€»ææˆ: Â¥${results.reduce((s, r) => s + r.commission, 0)}`);

      if(results.length > 0 && results[0].packageId === 1) {
        logs.push('');
        logs.push('ğŸ‰ <strong style="color: #10b981;">æµ‹è¯•æˆåŠŸ! å¥—é¤1åŒ¹é…æ­£å¸¸!</strong>');
      } else {
        logs.push('');
        logs.push('âš ï¸ <strong style="color: #ef4444;">æµ‹è¯•å¤±è´¥! å¥—é¤1æœªåŒ¹é…</strong>');
      }

      html += '<pre>' + logs.join('\n') + '</pre>';
      document.getElementById('fullResult').innerHTML = html;
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œæ‰€æœ‰æµ‹è¯•
    window.onload = function() {
      console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¯ä»¥è¿è¡Œæµ‹è¯•');
    };
  </script>
</body>
</html>
