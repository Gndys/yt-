# 政策配置功能更新日志

## 版本：v2.0 - 可维护配置版
**更新日期：** 2025-11-05

---

## ✨ 新增功能

### 1. 政策配置文件上传功能

现在支持通过上传Excel文件来动态配置所有政策规则，无需修改HTML代码。

**影响范围：**
- ✅ 旧套餐规则（7种固定组合）
- ✅ 组合套餐政策（九件套、五件套等）
- ✅ 活动机型政策（15种机型）

### 2. Excel模板生成功能

提供两种方式获取配置模板：

#### 方式1：通过主工具页面下载
在 `活动套餐前置.html` 页面顶部"政策配置"区域，点击链接即可下载模板。

#### 方式2：使用独立生成器
打开 `生成政策模板.html` 文件，点击按钮下载模板。

---

## 📋 配置模板说明

### Sheet 1: 旧套餐规则
配置固定产品组合的套餐规则

**字段说明：**
- **套餐编号**：唯一标识符
- **产品1-4**：套餐包含的产品型号（最多4个）
- **价格1-4**：对应产品的价格
- **套餐价**：套餐总价
- **提成金额**：该套餐的提成金额

**示例数据：**
```
套餐编号 | 产品1           | 价格1 | 产品2      | 价格2 | 套餐价 | 提成金额
1       | CXW-350-Q2CWI  | 5678  | JZT-V2B2S | 3098  | 5098   | 300
```

### Sheet 2: 组合套餐政策
配置基于品类的组合套餐政策

**字段说明：**
- **套餐名称**：套餐政策的名称
- **优先级**：数字越小优先级越高（1最高）
- **单套激励**：每套的激励金额
- **必需品类1-7**：必需的品类或分组标识
- **特殊说明**：用于配置分组或指定型号

**特殊说明格式：**
- 分组定义：`groupA:[烟机,蒸烤,洗碗机] groupB:[净水,热水器]`
- 指定型号：`specificModels:[ER1600BWi,KZQ45-M1Wi]`

**示例数据：**
```
套餐名称    | 优先级 | 单套激励 | 必需品类1 | 必需品类2 | 特殊说明
九件套      | 1     | 1000    | 烟机      | 蒸烤      |
组合套餐1   | 3     | 300     | GROUP_A   | 净水      | groupA:[烟机,蒸烤,洗碗机]
```

### Sheet 3: 活动机型政策
配置特定机型的专项激励

**字段说明：**
- **机型型号**：参与活动的机型型号
- **类型**：产品类型（燃热、净水、其他）
- **激励模式**：
  - `flat`：直接加提，每台固定金额
  - `threshold`：阶梯制，达到阈值后全量计提
- **单台激励**：每台的激励金额
- **阈值**：仅threshold模式需填写
- **说明备注**：备注信息

**示例数据：**
```
机型型号      | 类型 | 激励模式   | 单台激励 | 阈值 | 说明备注
JSQ31-VJSAI  | 燃热 | flat      | 100     |     | 活动期加提100元/台
R1700FWI     | 净水 | threshold | 50      | 5   | ≥5台 全量50元/台
```

---

## 🔄 使用流程

### 标准使用流程

1. **【可选】上传政策配置**
   - 打开 `活动套餐前置.html`
   - 在页面顶部"政策配置文件"区域上传自定义配置
   - 如不上传，系统使用默认内置配置

2. **上传数据文件**
   - 点击"数据上传"区域上传销售数据Excel

3. **字段映射**
   - 系统自动识别字段，可手动调整
   - 完成映射后点击"重新解析数据"

4. **计算提成**
   - 点击对应按钮计算：
     - 🧮 计算旧套餐提成
     - 🧩 计算套餐政策
     - 🔥 计算活动机型政策

5. **导出结果**
   - 可分别导出各项结果
   - 或使用"导出全部数据"一键导出

### 修改政策后重新计算

如果已经上传了数据文件，只需要：
1. 上传新的政策配置文件
2. 重新点击计算按钮
3. 系统会使用新配置重新计算

---

## 📁 文件清单

### 主要文件

| 文件名 | 说明 |
|--------|------|
| `活动套餐前置.html` | 主工具文件，包含政策配置功能 |
| `生成政策模板.html` | 独立的模板生成器 |
| `政策配置使用说明.md` | 详细的使用指南 |
| `政策配置功能更新日志.md` | 本文件，记录更新内容 |

### 生成的文件

| 文件名 | 说明 | 生成方式 |
|--------|------|----------|
| `活动套餐政策配置模板.xlsx` | Excel配置模板 | 点击页面内下载链接 |

---

## 🎯 核心优势

### 1. 无需编程知识
用户可以通过熟悉的Excel界面修改政策，无需了解HTML或JavaScript代码。

### 2. 灵活性
- 可随时调整政策规则
- 支持添加新的套餐和机型
- 可修改提成金额和优先级

### 3. 可追溯性
- 政策配置独立于代码
- Excel文件可版本管理
- 方便审计和回溯

### 4. 兼容性
- 不影响原有功能
- 不上传配置文件时使用默认规则
- 配置格式清晰易懂

---

## ⚠️ 注意事项

### 1. 配置文件要求
- **Sheet名称** 必须准确：`旧套餐规则`、`组合套餐政策`、`活动机型政策`
- **列名** 必须与模板一致
- **数值型字段** 必须填写数字，不能包含文字

### 2. 配置生效范围
- 配置仅在当前页面会话中生效
- 刷新页面后会恢复默认配置
- 如需长期使用，每次打开页面时都需要重新上传

### 3. 完整性要求
- 上传配置文件会**完全替换**所有政策规则
- 建议在模板基础上修改，确保配置完整
- 测试验证后再正式使用

### 4. 型号匹配
- 系统会自动进行标准化处理（转大写、去空格）
- 但建议型号与实际数据保持一致
- 特别注意字母的大小写（如 `Wi` vs `wi`）

---

## 🔧 技术实现

### 核心功能模块

1. **政策文件解析**
   - 使用 SheetJS (XLSX) 库解析Excel文件
   - 自动提取3个Sheet的数据
   - 转换为内部数据结构

2. **动态配置替换**
   ```javascript
   // 旧套餐规则
   oldPackageRules.length = 0;  // 清空现有规则
   // 从Excel解析并添加新规则
   
   // 组合套餐政策
   comboPolicyDefs.length = 0;
   // 从Excel解析并添加新规则
   
   // 活动机型政策
   Object.keys(activityModels).forEach(k=>delete activityModels[k]);
   // 从Excel解析并添加新规则
   ```

3. **模板生成**
   - 内置默认配置数据
   - 动态生成Excel工作簿
   - 自动设置列宽和格式

### 数据流程

```
Excel模板 → 用户编辑 → 上传 → JavaScript解析 → 
更新内存中的规则 → 计算使用新规则 → 导出结果
```

---

## 📚 相关文档

1. **详细使用指南**：`政策配置使用说明.md`
2. **原工具说明**：`README.md`
3. **样式说明**：`样式优化说明.md`

---

## 🚀 未来规划

### 待开发功能
- [ ] 配置文件验证和错误提示增强
- [ ] 支持从导出的历史配置文件快速恢复
- [ ] 配置文件格式检查工具
- [ ] 可视化配置编辑器
- [ ] 配置版本管理

### 优化方向
- [ ] 支持浏览器本地存储配置
- [ ] 批量导入多个配置文件对比
- [ ] 配置变更影响分析

---

## 📞 技术支持

如遇到问题或有改进建议，请联系开发团队。

**常见问题排查：**
1. 上传失败 → 检查文件格式是否为 .xlsx 或 .xls
2. 解析错误 → 检查Sheet名称和列名是否与模板一致
3. 计算结果异常 → 检查数值字段是否填写正确
4. 型号不匹配 → 检查型号大小写和空格

---

**版本历史：**
- v2.0 (2025-11-05): 新增政策配置文件上传功能
- v1.0: 初始版本，内置固定政策规则

