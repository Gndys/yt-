<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>æ´»åŠ¨å¥—é¤ææˆè®¡ç®—å·¥å…· - A.O.å²å¯†æ–¯ä¸šåŠ¡å·¥å…·å¹³å°</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  
  <!-- ç»Ÿä¸€æ ·å¼æ–‡ä»¶ -->
  <link rel="stylesheet" href="styles.css">
  
  <!-- ç¬¬ä¸‰æ–¹åº“ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <!-- é¡µé¢ç‰¹å®šæ ·å¼ -->
  <style>
    /* ä¼˜å…ˆçº§æç¤ºæ¡† - ç»Ÿä¸€ä¸ºåŠé€æ˜å¡ç‰‡ */
    .priority-notice{
      background:rgba(255,255,255,.95);
      border:2px solid var(--accent-gold);
      border-radius:16px;
      padding:20px 24px;
      margin:24px 0;
      box-shadow:var(--shadow-md);
      font-size:.9em;
      line-height:1.7;
    }
    .priority-notice h3{
      margin:0 0 12px;
      font-size:1.1em;
      color:var(--accent-gold);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .priority-notice div{margin:6px 0;color:var(--text-secondary);}
    
    /* å­—æ®µæ˜ å°„ */
    .field-mapping{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-top:16px;}
    .field-group{display:flex;flex-direction:column;}
    .field-group label{
      font-size:.85em;
      font-weight:600;
      color:var(--text-secondary);
      margin-bottom:8px;
    }
    .field-group select{
      padding:11px 14px;
      border:2px solid var(--border-light);
      background:var(--bg-card);
      border-radius:10px;
      font-size:.875em;
      transition:all .25s ease;
      cursor:pointer;
    }
    .field-group select:focus{
      outline:none;
      border-color:var(--accent-blue);
      box-shadow:0 0 0 4px var(--accent-blue-light);
    }
    
    /* æŒ‰é’®ç»„ - ç»Ÿä¸€æ ·å¼ */
    .calc-buttons{margin-top:24px;display:flex;flex-wrap:wrap;gap:12px;}
    .btn-green{background:var(--color-success);color:var(--text-white);}
    .btn-green:hover{background:#059669;transform:translateY(-2px);}
    .btn-blue{background:var(--accent-blue);color:var(--text-white);}
    .btn-blue:hover{background:var(--accent-blue-hover);transform:translateY(-2px);}
    .btn-orange{background:var(--color-warning);color:var(--text-white);}
    .btn-orange:hover{background:#ea580c;transform:translateY(-2px);}
    .btn-gray{background:#64748b;color:var(--text-white);}
    .btn-gray:hover{background:#475569;transform:translateY(-2px);}
    .btn-export{background:var(--accent-gold);color:var(--text-white);}
    .btn-export:hover{background:#d97706;transform:translateY(-2px);}
    .btn-purple{background:#8b5cf6;color:var(--text-white);}
    .btn-purple:hover{background:#7c3aed;transform:translateY(-2px);}
    
    /* æ¶ˆæ¯æ¡† - ä¼˜åŒ–è§†è§‰æ•ˆæœ */
    .error,.success{
      display:none;
      margin:16px 0;
      padding:16px 20px;
      border-radius:12px;
      font-size:.875em;
      font-weight:600;
      border-left:4px solid;
    }
    .error{
      background:var(--color-danger-light);
      border-color:var(--color-danger);
      color:#991B1B;
    }
    .success{
      background:var(--color-success-light);
      border-color:var(--color-success);
      color:#065F46;
    }
    
    /* ç»“æœåŒºå— */
    .results-block{
      margin-top:24px;
      background:var(--bg-card);
      border:2px solid var(--border-light);
      border-radius:16px;
      padding:24px;
      box-shadow:var(--shadow-lg);
    }
    .results-header{
      display:flex;
      flex-wrap:wrap;
      gap:16px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:20px;
      padding-bottom:16px;
      border-bottom:2px solid var(--border-light);
    }
    .results-header h3{
      margin:0;
      font-size:1.25rem;
      color:var(--text-primary);
      display:flex;
      align-items:center;
      gap:10px;
    }
    .results-header h3 span{
      background:var(--accent-blue);
      padding:4px 12px;
      font-size:.7em;
      color:var(--text-white);
      font-weight:700;
      border-radius:20px;
    }
    .export-buttons{display:flex;flex-wrap:wrap;gap:10px;}
    
    /* è¡¨æ ¼ - ç°ä»£åŒ–è®¾è®¡ */
    table{width:100%;border-collapse:separate;border-spacing:0;font-size:.875rem;}
    th,td{border:1px solid var(--border-light);padding:12px 14px;vertical-align:top;}
    th{
      background:linear-gradient(180deg,var(--accent-blue),var(--accent-blue-hover));
      color:var(--text-white);
      position:sticky;
      top:0;
      z-index:3;
      text-align:center;
      font-weight:600;
      font-size:.85em;
      text-transform:uppercase;
      letter-spacing:.5px;
    }
    th:first-child{border-top-left-radius:10px;}
    th:last-child{border-top-right-radius:10px;}
    tbody tr{transition:all .2s ease;}
    tbody tr:nth-child(even){background:rgba(0,0,0,.02);}
    tbody tr:hover{background:var(--accent-blue-light);transform:scale(1.01);box-shadow:var(--shadow-sm);}
    
    /* å¥—é¤ç»„ - ç²¾è‡´å¡ç‰‡è®¾è®¡ */
    .package-group{
      border:2px solid var(--border-light);
      border-radius:12px;
      background:var(--bg-card);
      margin-bottom:10px;
      overflow:hidden;
      transition:all .3s ease;
    }
    .package-group:hover{border-color:var(--accent-blue);box-shadow:var(--shadow-md);}
    .package-header{
      background:linear-gradient(135deg,var(--accent-blue-light),#e0f2fe);
      padding:10px 16px;
      font-size:.875em;
      color:var(--accent-blue);
      font-weight:700;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .product-row{
      display:flex;
      justify-content:space-between;
      gap:16px;
      padding:10px 16px;
      border-top:1px solid var(--border-light);
      font-size:.875em;
    }
    .product-row:nth-child(even){background:rgba(0,0,0,.02);}
    .commission-highlight{
      background:var(--color-success);
      color:var(--text-white);
      padding:4px 12px;
      border-radius:20px;
      font-weight:700;
      font-size:.75em;
    }
    
    /* æç¤ºæ¡† - ç»Ÿä¸€è®¾è®¡è¯­è¨€ */
    .warn-box{
      background:rgba(251,191,36,.1);
      border-left:4px solid var(--color-warning);
      border-radius:12px;
      padding:16px 20px;
      font-size:.875em;
      line-height:1.7;
      color:#78350f;
      margin-top:16px;
    }
    .notice-box{
      background:rgba(59,130,246,.1);
      border-left:4px solid var(--accent-blue);
      border-radius:12px;
      padding:16px 20px;
      font-size:.875em;
      line-height:1.7;
      color:#1e3a8a;
      margin-top:16px;
    }
    .step-notice{
      background:rgba(251,191,36,.1);
      border-left:4px solid var(--color-warning);
      border-radius:12px;
      padding:16px 20px;
      margin-top:16px;
      font-size:.875em;
      line-height:1.7;
      color:#78350f;
    }
    .step-notice h4{margin:0 0 10px;color:var(--color-warning);font-size:1em;font-weight:700;}
    
    /* å…¨å±€å¯¼å‡º - ç»Ÿä¸€ä¸»é¢˜è‰² */
    .global-export{
      background:linear-gradient(135deg,rgba(251,191,36,.15),rgba(251,191,36,.05));
      border:2px solid var(--accent-gold);
      border-radius:16px;
      padding:28px 32px;
      margin-top:32px;
      text-align:center;
    }
    .global-export h3{margin:0 0 12px;color:var(--accent-gold);font-size:1.4em;font-weight:700;}
    .global-export p{margin:0 0 20px;color:var(--text-secondary);font-size:.9em;}
    
    /* ä¿®å¤æ ‡è®° */
    .fix-badge{
      display:inline-block;
      background:var(--color-warning);
      color:var(--text-white);
      padding:4px 12px;
      border-radius:20px;
      font-size:.7em;
      font-weight:700;
      margin-left:10px;
    }
    
    /* æ”¿ç­–è¯´æ˜ - ç»Ÿä¸€å¡ç‰‡è®¾è®¡ */
    .policy-explain{
      background:var(--bg-card);
      border:2px solid var(--border-light);
      border-radius:16px;
      padding:24px 28px;
      margin-top:24px;
      box-shadow:var(--shadow-md);
    }
    .policy-explain h3{
      margin:0 0 20px;
      color:var(--accent-blue);
      font-size:1.2em;
      display:flex;
      align-items:center;
      gap:10px;
      padding-bottom:12px;
      border-bottom:2px solid var(--border-light);
    }
    .policy-section{margin-bottom:28px;}
    .policy-section:last-child{margin-bottom:0;}
    .policy-section h4{
      margin:0 0 16px;
      color:var(--text-primary);
      font-size:1em;
      padding-bottom:8px;
      border-bottom:2px solid var(--accent-blue-light);
      font-weight:700;
    }
    .policy-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
      gap:14px;
      margin-top:14px;
    }
    .policy-card{
      background:var(--bg-card);
      border:2px solid var(--border-light);
      border-radius:12px;
      padding:16px 18px;
      transition:all .3s ease;
    }
    .policy-card:hover{
      border-color:var(--accent-blue);
      box-shadow:var(--shadow-md);
      transform:translateY(-2px);
    }
    .policy-card .title{
      font-weight:700;
      color:var(--accent-blue);
      font-size:.9em;
      margin-bottom:8px;
      display:flex;
      align-items:center;
    }
    .policy-card .priority{
      background:var(--accent-blue);
      color:var(--text-white);
      padding:3px 10px;
      border-radius:12px;
      font-size:.75em;
      margin-left:auto;
    }
    .policy-card .condition{
      color:var(--text-secondary);
      font-size:.85em;
      line-height:1.6;
      margin:8px 0;
    }
    .policy-card .reward{
      background:var(--color-success);
      color:var(--text-white);
      padding:6px 12px;
      border-radius:8px;
      font-size:.85em;
      font-weight:700;
      display:inline-block;
      margin-top:6px;
    }
    .policy-card .note{
      color:var(--color-warning);
      font-size:.75em;
      margin-top:6px;
      font-style:italic;
    }
    
    /* å¥—é¤åˆ—è¡¨ */
    .old-package-list,.activity-model-list{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(340px,1fr));
      gap:12px;
      margin-top:14px;
    }
    .old-package-item,.activity-model-item{
      background:var(--bg-card);
      border-left:4px solid var(--accent-blue);
      border-radius:8px;
      padding:14px 16px;
      font-size:.875em;
      line-height:1.7;
      transition:all .3s ease;
      border:2px solid var(--border-light);
    }
    .old-package-item:hover,.activity-model-item:hover{
      border-left-color:var(--accent-gold);
      box-shadow:var(--shadow-sm);
      transform:translateX(4px);
    }
    .old-package-item strong,.activity-model-item strong{
      color:var(--accent-blue);
      display:block;
      margin-bottom:6px;
      font-size:1.05em;
    }
    .activity-model-item.threshold-model{
      border-left-color:var(--color-success);
    }
    .activity-model-item.threshold-model:hover{
      border-left-color:var(--accent-gold);
    }
    .activity-model-item small{
      color:var(--text-tertiary);
      font-size:.85em;
    }
    .activity-model-item .threshold-note{
      color:var(--color-success);
      font-weight:600;
    }
    .activity-model-explain{
      background:rgba(251,191,36,.1);
      border-left:4px solid var(--color-warning);
      border-radius:8px;
      padding:12px 16px;
      font-size:.85em;
      margin:12px 0;
    }
    .activity-model-explain strong{
      color:var(--color-warning);
      display:block;
      margin-bottom:6px;
    }
    
    /* æŠ˜å æŒ‰é’® */
    .toggle-btn{
      background:var(--accent-blue);
      color:var(--text-white);
      border:none;
      padding:10px 20px;
      border-radius:10px;
      font-size:.875em;
      cursor:pointer;
      margin-top:12px;
      transition:all .3s ease;
      font-weight:600;
    }
    .toggle-btn:hover{
      background:var(--accent-blue-hover);
      transform:translateY(-2px);
      box-shadow:var(--shadow-md);
    }
    .collapsible-content{
      max-height:0;
      overflow:hidden;
      transition:max-height .4s ease;
    }
    .collapsible-content.expanded{max-height:3000px;}
    
    .inline-note{font-size:.8em;color:var(--text-tertiary);margin-left:8px;font-style:italic;}
    .mini-desc{font-size:.9em;color:var(--text-secondary);margin-bottom:14px;line-height:1.6;}
    .file-input{display:none;}
    
    /* ä¸Šä¼ åŒºåŸŸç¾åŒ– */
    .upload-icon{font-size:3.2em;margin-bottom:8px;}
    .upload-text{font-weight:600;letter-spacing:1px;margin:8px 0;color:var(--text-primary);}
    .upload-hint{color:var(--text-tertiary);font-size:.75em;margin-top:12px;}
    .loading-text{font-size:.75em;color:var(--text-tertiary);margin-top:8px;}
    
    /* è¡¨æ ¼å®¹å™¨ */
    .table-container{
      max-height:520px;
      overflow:auto;
      border:2px solid var(--border-light);
      border-radius:14px;
      box-shadow:var(--shadow-sm);
    }
    
    @media (max-width:880px){
      .field-mapping{grid-template-columns:1fr;}
      .results-header{flex-direction:column;align-items:flex-start;}
      .export-buttons{justify-content:flex-start;width:100%;}
      .policy-grid{grid-template-columns:1fr;}
      .old-package-list,.activity-model-list{grid-template-columns:1fr;}
    }
  </style>
</head>
<body>
<div class="tool-container">
  <div class="tool-header">
    <!-- è¿”å›å¯¼èˆª -->
    <a href="../index.html" class="back-nav">â† è¿”å›é¦–é¡µ</a>
    
    <h1>ğŸ¯ æ´»åŠ¨å¥—é¤ææˆè®¡ç®—å·¥å…· <span class="fix-badge">æ—§å¥—é¤é€»è¾‘å·²ä¿®å¤</span></h1>
    <p class="tool-subtitle">ä¸“é—¨å¤„ç†æ´»åŠ¨å¥—é¤ææˆï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰ã€‚æœ¬ç‰ˆæœ¬ä¿®å¤"æ—§å¥—é¤æ‹†æ•£/é”™æ ‡"é—®é¢˜ï¼šç¡®ä¿åŒä¸€å¥—é¤å†…æ‰€æœ‰äº§å“ç»Ÿä¸€å½’å±ã€‚</p>
    
    <div class="tool-badge">
      <span class="badge-dot"></span>
      <span>03-2 æ´»åŠ¨å¥—é¤å‰ç½®å·¥å…· / ä¿®å¤ç‰ˆ</span>
    </div>
    <div class="priority-notice">
      <h3>âš ï¸ é‡è¦è¯´æ˜</h3>
      <div>â€¢ è¿™æ˜¯ç¬¬ä¸€æ­¥æ´»åŠ¨å¥—é¤è®¡ç®—ï¼Œç»“æœéœ€å¯¼å…¥ä¸»å·¥å…·ç»§ç»­å¤„ç†</div>
      <div>â€¢ å·²å¯¹ã€æ—§å¥—é¤åŒ¹é…ã€‘ç®—æ³•è¿›è¡Œ"æŒ‰å®¢æˆ·+å¥—é¤æ•´ä½“å ç”¨"ä¿®å¤ï¼Œé¿å…åŒä¸€äº§å“è¢«æ‹†åˆ°ä¸åŒå¥—é¤</div>
      <div>â€¢ åŒä¸€æ¡æ˜ç»†ï¼ˆè¡Œï¼‰åªä¼šè¢«ä¸€ä¸ªæ—§å¥—é¤å ç”¨</div>
    </div>
    <div class="nav-tabs">
      <button class="active" onclick="scrollToAnchor('uploadSection', this)">æ•°æ®ä¸Šä¼ </button>
      <button onclick="scrollToAnchor('mappingSection', this)">å­—æ®µæ˜ å°„</button>
      <button onclick="scrollToAnchor('oldResultsSection', this)">æ—§å¥—é¤</button>
      <button onclick="scrollToAnchor('comboResultsSection', this)">å¥—é¤æ”¿ç­–</button>
      <button onclick="scrollToAnchor('activityResultsSection', this)">æ´»åŠ¨æœºå‹</button>
      <button onclick="scrollToAnchor('globalExportSection', this)">å…¨éƒ¨å¯¼å‡º</button>
    </div>
  </div>
  <div class="tool-content">
    <!-- ä¸Šä¼  -->
    <div class="section" id="uploadSection">
      <h2>ğŸ“ ä¸Šä¼ æ•°æ®æ–‡ä»¶ <span class="inline-note">æ”¯æŒ .xlsx / .xls</span></h2>
      <div class="mini-desc">æ¨èå­—æ®µï¼šå•æ®ç¼–å· / å®¢æˆ· / è§„æ ¼å‹å· / ä¿ƒé”€å‘˜ / æ•°é‡ / å¤§ç±»å‹ï¼ˆå“ç±»ï¼‰</div>
      <div class="upload-area" onclick="document.getElementById('fileInput').click()" id="uploadArea">
        <div class="upload-icon">ğŸ“„</div>
          <p class="upload-text">ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½ Excel åˆ°æ­¤å¤„</p>
          <p class="upload-hint">è‡ªåŠ¨è¯†åˆ«è¡¨å¤´ï¼Œå¯æ‰‹åŠ¨ä¿®æ­£</p>
      </div>
      <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls">
      <div class="error" id="errorMsg"></div>
      <div class="success" id="successMsg"></div>
      <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">æ­£åœ¨è¯»å–æ•°æ®...</div>
      </div>
    </div>

    <!-- æ˜ å°„ -->
    <div class="section" id="mappingSection" style="display:none;">
      <h2>ğŸ”— å­—æ®µæ˜ å°„è®¾ç½®</h2>
      <div class="mini-desc">å…¨éƒ¨å­—æ®µè¯·å®Œæˆæ˜ å°„ã€‚è‹¥æ²¡æœ‰"å¤§ç±»å‹"åˆ™æ— æ³•è®¡ç®—"å¥—é¤æ”¿ç­– & æ´»åŠ¨æœºå‹"ã€‚</div>
      <div class="field-mapping">
        <div class="field-group">
          <label>å•æ®ç¼–å·</label>
          <select id="orderField"><option value="">è¯·é€‰æ‹©...</option></select>
        </div>
        <div class="field-group">
          <label>å®¢æˆ·</label>
          <select id="customerField"><option value="">è¯·é€‰æ‹©...</option></select>
        </div>
        <div class="field-group">
          <label>è§„æ ¼å‹å·</label>
          <select id="modelField"><option value="">è¯·é€‰æ‹©...</option></select>
        </div>
        <div class="field-group">
          <label>ä¿ƒé”€å‘˜</label>
          <select id="salesmanField"><option value="">è¯·é€‰æ‹©...</option></select>
        </div>
        <div class="field-group">
          <label>é”€å”®æ•°é‡</label>
          <select id="quantityField"><option value="">è¯·é€‰æ‹©...</option></select>
        </div>
        <div class="field-group">
          <label>å¤§ç±»å‹ï¼ˆå“ç±»ï¼‰</label>
          <select id="categoryField"><option value="">è¯·é€‰æ‹©...</option></select>
        </div>
      </div>
      <div class="calc-buttons">
        <button class="btn btn-blue" onclick="runOldPackageCalc()">ğŸ§® è®¡ç®—æ—§å¥—é¤ææˆ</button>
        <button class="btn btn-green" onclick="runComboPolicyCalc()">ğŸ§© è®¡ç®—å¥—é¤æ”¿ç­–</button>
        <button class="btn btn-orange" onclick="runActivityPolicyCalc()">ğŸ”¥ è®¡ç®—æ´»åŠ¨æœºå‹æ”¿ç­–</button>
        <button class="btn btn-gray" onclick="rebuildBaseData()">â™»ï¸ é‡æ–°è§£ææ•°æ®</button>
      </div>
      <div class="warn-box">
        è¯´æ˜ï¼š<br>
        1ï¼‰ä¸‰ä¸ªæŒ‰é’®äº’ä¸å½±å“ï¼Œå¯åˆ†åˆ«å¤šæ¬¡è®¡ç®—ä¸å¯¼å‡ºã€‚<br>
        2ï¼‰å¥—é¤æ”¿ç­– & æ´»åŠ¨æœºå‹æ”¿ç­–ä¾èµ–"å¤§ç±»å‹"å­—æ®µã€‚<br>
        3ï¼‰ç»„åˆå¥—é¤ä¼˜å…ˆçº§ï¼šä¹ä»¶å¥— > äº”ä»¶å¥— > ç»„åˆå¥—é¤1ï¼ˆé˜²æ­¢é‡å¤è®¡å¥—ï¼‰ã€‚<br>
        4ï¼‰æ´»åŠ¨æœºå‹é˜¶æ¢¯ï¼šè¾¾é˜ˆå€¼åå…¨é‡è®¡æï¼ˆéå¢é‡ï¼‰ã€‚<br>
        5ï¼‰æ—§å¥—é¤ä¿®å¤ï¼šåŒä¸€å¥—é¤å†…æ‰€æœ‰äº§å“ç»Ÿä¸€æ ‡è®°ï¼Œä¸å†å‡ºç°"ä¸€åŠå±äºå¥—é¤1 ä¸€åŠå±äºå¥—é¤2"çš„é”™é…ã€‚<br>
      </div>

      <!-- æ”¿ç­–è¯¦ç»†è¯´æ˜ -->
      <div class="policy-explain">
        <h3>ğŸ“‹ å¥—é¤æ”¿ç­–è¯¦ç»†è¯´æ˜ <span class="inline-note">ï¼ˆç‚¹å‡»æŒ‰é’®å±•å¼€æŸ¥çœ‹è¯¦æƒ…ï¼‰</span></h3>
        
        <!-- ç»„åˆå¥—é¤æ”¿ç­– -->
        <div class="policy-section">
          <h4>ğŸ§© ç»„åˆå¥—é¤æ”¿ç­–ï¼ˆæŒ‰ä¼˜å…ˆçº§ä»é«˜åˆ°ä½åŒ¹é…ï¼‰</h4>
          <div class="policy-grid">
            <div class="policy-card">
              <div class="title">
                <span>ä¹ä»¶å¥—</span>
                <span class="priority">ä¼˜å…ˆçº§ 1</span>
              </div>
              <div class="condition">
                <strong>åŒ¹é…æ¡ä»¶ï¼š</strong>çƒŸæœº + è’¸çƒ¤ + æ´—ç¢—æœº + çƒ­æ°´å™¨ + å‡€æ°´ + å†°ç®± + æ´—æŠ¤<br>
                <small>ï¼ˆéœ€è¦7ä¸ªå“ç±»å…¨éƒ¨é½å…¨ï¼‰</small>
              </div>
              <div class="reward">ğŸ’° æ¿€åŠ±ï¼š1000å…ƒ/å¥—</div>
            </div>

            <div class="policy-card">
              <div class="title">
                <span>äº”ä»¶å¥—</span>
                <span class="priority">ä¼˜å…ˆçº§ 2</span>
              </div>
              <div class="condition">
                <strong>åŒ¹é…æ¡ä»¶ï¼š</strong>çƒ­æ°´å™¨ + å‡€æ°´ + å†°ç®± + æ´—æŠ¤<br>
                <small>ï¼ˆéœ€è¦4ä¸ªå“ç±»å…¨éƒ¨é½å…¨ï¼‰</small>
              </div>
              <div class="reward">ğŸ’° æ¿€åŠ±ï¼š500å…ƒ/å¥—</div>
            </div>

            <div class="policy-card">
              <div class="title">
                <span>ç»„åˆå¥—é¤1</span>
                <span class="priority">ä¼˜å…ˆçº§ 3</span>
              </div>
              <div class="condition">
                <strong>åŒ¹é…æ¡ä»¶ï¼š</strong><br>
                â€¢ çƒŸæœº/è’¸çƒ¤/æ´—ç¢—æœºï¼ˆä¸‰é€‰ä¸€ï¼‰<br>
                â€¢ + å‡€æ°´ï¼ˆå¿…é¡»ï¼‰<br>
                â€¢ + çƒ­æ°´å™¨ï¼ˆå¿…é¡»ï¼‰
              </div>
              <div class="reward">ğŸ’° æ¿€åŠ±ï¼š300å…ƒ/å¥—</div>
            </div>

            <div class="policy-card">
              <div class="title">
                <span>åµŒè’¸å¥—è£…</span>
                <span class="priority">ä¼˜å…ˆçº§ 4</span>
              </div>
              <div class="condition">
                <strong>åŒ¹é…æ¡ä»¶ï¼š</strong><br>
                â€¢ åŸºç¡€ï¼šER1600BWi + KZQ45-M1Wi<br>
                â€¢ æ›¿ä»£ï¼šER1600BWi + KZQ45-M5Wiï¼ˆè¡¥å·®900å…ƒï¼‰
              </div>
              <div class="reward">ğŸ’° æ¿€åŠ±ï¼š500å…ƒ/å¥—</div>
            </div>

            <div class="policy-card">
              <div class="title">
                <span>A+å‡€çƒ­ç»„åˆ</span>
                <span class="priority">ä¼˜å…ˆçº§ 5</span>
              </div>
              <div class="condition">
                <strong>åŒ¹é…æ¡ä»¶ï¼š</strong><br>
                â€¢ çƒŸæœº/è’¸çƒ¤/æ´—ç¢—æœºï¼ˆä¸‰é€‰ä¸€ï¼‰<br>
                â€¢ + å‡€æ°´/çƒ­æ°´å™¨ï¼ˆäºŒé€‰ä¸€ï¼‰
              </div>
              <div class="reward">ğŸ’° æ¿€åŠ±ï¼š200å…ƒ/å¥—</div>
              <div class="note">âš ï¸ çˆ†æ¬¾ã€ç‰¹ä»·é™¤å¤–</div>
            </div>
          </div>
          <button class="toggle-btn" onclick="toggleSection('comboPolicyDetail')">ğŸ‘† ç‚¹å‡»æŸ¥çœ‹ä¼˜å…ˆçº§è¯´æ˜</button>
          <div id="comboPolicyDetail" class="collapsible-content">
            <div class="notice-box">
              <strong>ä¼˜å…ˆçº§è¯´æ˜ï¼š</strong><br>
              â€¢ ç³»ç»ŸæŒ‰ä¼˜å…ˆçº§ä»1åˆ°5ä¾æ¬¡åŒ¹é…ï¼Œä¼˜å…ˆçº§é«˜çš„å…ˆæ¶ˆè€—èµ„æº<br>
              â€¢ åŒä¸€äº§å“åªä¼šè¢«è®¡å…¥ä¸€ä¸ªå¥—é¤ï¼Œä¸ä¼šé‡å¤è®¡ç®—<br>
              â€¢ ä¾‹å¦‚ï¼šå¦‚æœæ»¡è¶³"ä¹ä»¶å¥—"ï¼Œåˆ™ä¸ä¼šå†è®¡ç®—"äº”ä»¶å¥—"æˆ–"ç»„åˆå¥—é¤1"
            </div>
          </div>
        </div>

        <!-- æ—§å¥—é¤è§„åˆ™ -->
        <div class="policy-section">
          <h4>ğŸ“¦ æ—§å¥—é¤åŒ¹é…è§„åˆ™ï¼ˆ7ç§å›ºå®šç»„åˆï¼‰</h4>
          <button class="toggle-btn" onclick="toggleSection('oldPackageDetail')">ğŸ‘† ç‚¹å‡»å±•å¼€æŸ¥çœ‹æ‰€æœ‰æ—§å¥—é¤</button>
          <div id="oldPackageDetail" class="collapsible-content">
            <div class="old-package-list">
              <div class="old-package-item">
                <strong>å¥—é¤1ï¼š300å…ƒ</strong>
                CXW-350-Q2CWIï¼ˆçƒŸæœºï¼‰+ JZT-V2B2Sï¼ˆç¶å…·ï¼‰<br>
                å¥—é¤ä»·ï¼š5098å…ƒ
              </div>
              <div class="old-package-item">
                <strong>å¥—é¤2ï¼š400å…ƒ</strong>
                CXW-400-Z3AWiï¼ˆçƒŸæœºï¼‰+ JZT-V2B2Sï¼ˆç¶å…·ï¼‰<br>
                å¥—é¤ä»·ï¼š6788å…ƒ
              </div>
              <div class="old-package-item">
                <strong>å¥—é¤3ï¼š500å…ƒ</strong>
                CXW-350-Q2CWIï¼ˆçƒŸæœºï¼‰+ JZT-V2B2Sï¼ˆç¶å…·ï¼‰+ DWQ10-SR3HWIï¼ˆæ´—ç¢—æœºï¼‰<br>
                å¥—é¤ä»·ï¼š8598å…ƒ
              </div>
              <div class="old-package-item">
                <strong>å¥—é¤4ï¼š500å…ƒ</strong>
                CXW-350-Q2CWiï¼ˆçƒŸæœºï¼‰+ JZT-V2B2Sï¼ˆç¶å…·ï¼‰+ KZQ45-M1wiï¼ˆè’¸çƒ¤ï¼‰<br>
                å¥—é¤ä»·ï¼š8798å…ƒ
              </div>
              <div class="old-package-item">
                <strong>å¥—é¤5ï¼š800å…ƒ</strong>
                CXW-350-Q2CWIï¼ˆçƒŸæœºï¼‰+ JZT-V2B2Sï¼ˆç¶å…·ï¼‰+ KZQ45-M1Wiï¼ˆè’¸çƒ¤ï¼‰+ DWQ10-SR3HWIï¼ˆæ´—ç¢—æœºï¼‰<br>
                å¥—é¤ä»·ï¼š12898å…ƒ
              </div>
              <div class="old-package-item">
                <strong>å¥—é¤6ï¼š500å…ƒ</strong>
                KZQ45-M5wiï¼ˆè’¸çƒ¤ï¼‰+ R1600DWWiï¼ˆå‡€æ°´ï¼‰<br>
                å¥—é¤ä»·ï¼š8299å…ƒ
              </div>
              <div class="old-package-item">
                <strong>å¥—é¤7ï¼š600å…ƒ</strong>
                DWQ15-R3wiï¼ˆæ´—ç¢—æœºï¼‰+ DR1600HF2ï¼ˆå‡€æ°´ï¼‰<br>
                å¥—é¤ä»·ï¼š10598å…ƒ
              </div>
            </div>
            <div class="notice-box">
              <strong>æ—§å¥—é¤åŒ¹é…é€»è¾‘ï¼š</strong><br>
              â€¢ æŒ‰å®¢æˆ·å’Œå‹å·ç²¾ç¡®åŒ¹é…ï¼ŒåŒä¸€ä¸ªäº§å“åªèƒ½è¿›å…¥ä¸€ä¸ªæ—§å¥—é¤<br>
              â€¢ å¥—é¤å†…æ‰€æœ‰äº§å“ç»Ÿä¸€æ ‡è®°ï¼Œé¿å…æ‹†æ•£é—®é¢˜<br>
              â€¢ å¦‚æœåŒæ—¶æ»¡è¶³å¤šä¸ªæ—§å¥—é¤ï¼ŒæŒ‰åˆ—è¡¨é¡ºåºä¼˜å…ˆåŒ¹é…ç¬¬ä¸€ä¸ª
            </div>
          </div>
        </div>

        <!-- æ´»åŠ¨æœºå‹æ”¿ç­– -->
        <div class="policy-section">
          <h4>ğŸ”¥ æ´»åŠ¨æœºå‹ä¸“é¡¹æ¿€åŠ±ï¼ˆ15ç§æœºå‹ï¼‰</h4>
          <button class="toggle-btn" onclick="toggleSection('activityModelDetail')">ğŸ‘† ç‚¹å‡»å±•å¼€æŸ¥çœ‹æ‰€æœ‰æ´»åŠ¨æœºå‹</button>
          <div id="activityModelDetail" class="collapsible-content">
            <div class="activity-model-explain">
              <strong>æ¿€åŠ±æ¨¡å¼è¯´æ˜ï¼š</strong><br>
              â€¢ <strong>ç›´æ¥åŠ æï¼ˆflatï¼‰ï¼š</strong>æ¯å°å›ºå®šé‡‘é¢ï¼Œä¸è®¾é—¨æ§›<br>
              â€¢ <strong>é˜¶æ¢¯åˆ¶ï¼ˆthresholdï¼‰ï¼š</strong>è¾¾åˆ°æ•°é‡é˜ˆå€¼åï¼Œå…¨é‡è®¡æï¼ˆéå¢é‡ï¼‰
            </div>
            <div class="activity-model-list">
              <div class="activity-model-item">
                <strong>JSQ31-VJSAIï¼ˆç‡ƒçƒ­ï¼‰</strong>
                åŠ æ100å…ƒ/å°<br>
                <small>æ´»åŠ¨æœŸåŠ æ</small>
              </div>
              <div class="activity-model-item">
                <strong>JSQ31-QJSï¼ˆç‡ƒçƒ­ï¼‰</strong>
                åŠ æ100å…ƒ/å° + èµ å“<br>
                <small>ç›´æ¥åŠ æ</small>
              </div>
              <div class="activity-model-item">
                <strong>JSQ31-QJSAIï¼ˆç‡ƒçƒ­ï¼‰</strong>
                åŠ æ100å…ƒ/å° + èµ å“<br>
                <small>ç›´æ¥åŠ æ</small>
              </div>
              <div class="activity-model-item">
                <strong>JSQ33-MJSXï¼ˆç‡ƒçƒ­ï¼‰</strong>
                åŠ æ100å…ƒ/å° + èµ å“<br>
                <small>ç›´æ¥åŠ æ</small>
              </div>
              <div class="activity-model-item">
                <strong>JSQ40-SJSXï¼ˆç‡ƒçƒ­ï¼‰</strong>
                åŠ æ300å…ƒ/å° + èµ å“<br>
                <small>ç›´æ¥åŠ æ</small>
              </div>
              <div class="activity-model-item threshold-model">
                <strong>R1700FWIï¼ˆå‡€æ°´ï¼‰</strong>
                â‰¥5å°æ—¶ï¼Œå…¨é‡50å…ƒ/å°<br>
                <small class="threshold-note">é˜¶æ¢¯åˆ¶ï¼šæœªè¾¾é˜ˆå€¼=0å…ƒ</small>
              </div>
              <div class="activity-model-item threshold-model">
                <strong>DR1600HF2ï¼ˆå‡€æ°´ï¼‰</strong>
                â‰¥3å°æ—¶ï¼Œå…¨é‡100å…ƒ/å°<br>
                <small class="threshold-note">é˜¶æ¢¯åˆ¶ï¼šæœªè¾¾é˜ˆå€¼=0å…ƒ</small>
              </div>
              <div class="activity-model-item threshold-model">
                <strong>DR1800HF1ï¼ˆå‡€æ°´ï¼‰</strong>
                â‰¥3å°æ—¶ï¼Œå…¨é‡100å…ƒ/å°<br>
                <small class="threshold-note">é˜¶æ¢¯åˆ¶ï¼šæœªè¾¾é˜ˆå€¼=0å…ƒ</small>
              </div>
              <div class="activity-model-item threshold-model">
                <strong>DR1800HF2ï¼ˆå‡€æ°´ï¼‰</strong>
                â‰¥3å°æ—¶ï¼Œå…¨é‡100å…ƒ/å°<br>
                <small class="threshold-note">é˜¶æ¢¯åˆ¶ï¼šæœªè¾¾é˜ˆå€¼=0å…ƒ</small>
              </div>
              <div class="activity-model-item threshold-model">
                <strong>DR2000HF1ï¼ˆå‡€æ°´ï¼‰</strong>
                â‰¥3å°æ—¶ï¼Œå…¨é‡100å…ƒ/å°<br>
                <small class="threshold-note">é˜¶æ¢¯åˆ¶ï¼šæœªè¾¾é˜ˆå€¼=0å…ƒ</small>
              </div>
              <div class="activity-model-item threshold-model">
                <strong>DR2000HF2ï¼ˆå‡€æ°´ï¼‰</strong>
                â‰¥3å°æ—¶ï¼Œå…¨é‡100å…ƒ/å°<br>
                <small class="threshold-note">é˜¶æ¢¯åˆ¶ï¼šæœªè¾¾é˜ˆå€¼=0å…ƒ</small>
              </div>
              <div class="activity-model-item">
                <strong>R1800RC9ï¼ˆå‡€æ°´ï¼‰</strong>
                åŠ æ100å…ƒ/å°<br>
                <small>ç›´æ¥åŠ æ</small>
              </div>
              <div class="activity-model-item">
                <strong>R2300RC9ï¼ˆå‡€æ°´ï¼‰</strong>
                åŠ æ100å…ƒ/å°<br>
                <small>ç›´æ¥åŠ æ</small>
              </div>
              <div class="activity-model-item">
                <strong>R2500AB1AIï¼ˆå‡€æ°´ï¼‰</strong>
                åŠ æ100å…ƒ/å°<br>
                <small>ç›´æ¥åŠ æ</small>
              </div>
              <div class="activity-model-item">
                <strong>R2500RC3ï¼ˆå‡€æ°´ï¼‰</strong>
                åŠ æ100å…ƒ/å°<br>
                <small>ç›´æ¥åŠ æ</small>
              </div>
              <div class="activity-model-item">
                <strong>CEWH-60GAï¼ˆå…¶ä»–ï¼‰</strong>
                åŠ æ100å…ƒ/å°ï¼ˆåŒ…é”€ï¼‰<br>
                <small>ç›´æ¥åŠ æ</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- æ—§å¥—é¤ç»“æœ -->
    <div class="section" id="oldResultsSection" style="display:none;">
      <div class="results-block">
        <div class="results-header">
          <h3>ğŸ“¦ æ—§å¥—é¤åŒ¹é…ç»“æœ <span id="oldCountTag">0</span></h3>
          <div class="export-buttons">
            <button class="btn btn-export" onclick="exportOld()">å¯¼å‡ºæ—§å¥—é¤ç»“æœ</button>
          </div>
        </div>
        <div class="stats" id="oldStats"></div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th style="width:110px;">ä¿ƒé”€å‘˜</th>
                <th style="width:150px;">å®¢æˆ·</th>
                <th style="width:90px;">å¥—é¤å·</th>
                <th style="width:100px;">ææˆ</th>
                <th>äº§å“ç»„æˆ</th>
              </tr>
            </thead>
            <tbody id="oldResultsBody"></tbody>
          </table>
        </div>
        <div class="notice-box">
          ä¿®å¤è¦ç‚¹ï¼š<br>
          â€¢ é‡‡ç”¨"èµ„æºå ç”¨"æ–¹å¼ï¼ŒåŒä¸€ä¸ªæ˜ç»†è¡Œåªä¼šè¿›å…¥ä¸€ä¸ªæ—§å¥—é¤ã€‚<br>
          â€¢ å¥—é¤åˆ¤æ–­æŒ‰"å®¢æˆ·+æ‰€éœ€ SKU å…¨éƒ¨å­˜åœ¨"ä¸€æ¬¡æ€§ç¡®ç«‹ï¼Œé¿å…æ‹†æ•£ã€‚<br>
          â€¢ è‹¥åŒä¸€ä¸ªç»„åˆèƒ½åŒ¹é…å¤šç§æ—§å¥—é¤è§„åˆ™ï¼ŒæŒ‰è§„åˆ™åˆ—è¡¨é¡ºåºä¼˜å…ˆåŒ¹é…ç¬¬ä¸€ä¸ªå¹¶å ç”¨ã€‚<br>
        </div>
        <div class="step-notice">
          <h4>ğŸ“‹ ä¸‹ä¸€æ­¥æ“ä½œ</h4>
          å¯¼å‡ºåå¯¼å…¥ä¸»ææˆè®¡ç®—å·¥å…·ç»§ç»­åç»­è®¡ç®—ï¼Œæ–‡ä»¶å·²åŒ…å«å ç”¨æ ‡è®°ï¼Œé¿å…é‡å¤è®¡ç®—ã€‚
        </div>
      </div>
    </div>

    <!-- å¥—é¤æ”¿ç­–ç»“æœ -->
    <div class="section" id="comboResultsSection" style="display:none;">
      <div class="results-block">
        <div class="results-header">
          <h3>ğŸ§© ç»„åˆå¥—é¤æ”¿ç­–ç»“æœ <span id="comboCountTag">0</span></h3>
          <div class="export-buttons">
            <button class="btn btn-export" onclick="exportCombo()">å¯¼å‡ºå¥—é¤æ”¿ç­–ç»“æœ</button>
          </div>
        </div>
        <div class="stats" id="comboStats"></div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th style="width:110px;">ä¿ƒé”€å‘˜</th>
                <th style="width:150px;">å®¢æˆ·</th>
                <th style="width:110px;">å¥—é¤ç±»å‹</th>
                <th style="width:90px;">å¥—æ•°</th>
                <th style="width:100px;">å•å¥—æ¿€åŠ±</th>
                <th style="width:110px;">æ€»æ¿€åŠ±</th>
                <th>åˆ†ç±»æ˜ç»†</th>
              </tr>
            </thead>
            <tbody id="comboResultsBody"></tbody>
          </table>
        </div>
        <div class="notice-box">
          ä¼˜å…ˆçº§ï¼šä¹ä»¶å¥— > äº”ä»¶å¥— > ç»„åˆå¥—é¤1 > åµŒè’¸å¥—è£…ï¼›èµ„æºæŒ‰ä¼˜å…ˆçº§é€å±‚æ¶ˆè€—ã€‚
        </div>
        <div class="step-notice">
          <h4>ğŸ“‹ ä¸‹ä¸€æ­¥æ“ä½œ</h4>
          å¯¼å‡ºæ–‡ä»¶åå¯¼å…¥ä¸»å·¥å…·ç»§ç»­å¤„ç†ã€‚
        </div>
      </div>
    </div>

    <!-- æ´»åŠ¨æœºå‹ç»“æœ -->
    <div class="section" id="activityResultsSection" style="display:none;">
      <div class="results-block">
        <div class="results-header">
          <h3>ğŸ”¥ æ´»åŠ¨æœºå‹æ”¿ç­–ç»“æœ <span id="activityCountTag">0</span></h3>
          <div class="export-buttons">
            <button class="btn btn-export" onclick="exportActivity()">å¯¼å‡ºæ´»åŠ¨æœºå‹ç»“æœ</button>
          </div>
        </div>
        <div class="stats" id="activityStats"></div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th style="width:110px;">ä¿ƒé”€å‘˜</th>
                <th style="width:150px;">å®¢æˆ·</th>
                <th style="width:170px;">æœºå‹</th>
                <th style="width:70px;">æ•°é‡</th>
                <th style="width:120px;">å•å°æ¿€åŠ±</th>
                <th style="width:120px;">åˆè®¡æ¿€åŠ±</th>
                <th style="width:200px;">æ¡ä»¶è¯´æ˜</th>
              </tr>
            </thead>
            <tbody id="activityResultsBody"></tbody>
          </table>
        </div>
        <div class="notice-box">
          é˜¶æ¢¯ï¼šè¾¾é˜ˆå€¼å…¨é‡è®¡ï¼›æœªè¾¾=0ã€‚ä»…ç»Ÿè®¡ç°é‡‘ç±»æ¿€åŠ±ã€‚
        </div>
        <div class="step-notice">
          <h4>ğŸ“‹ ä¸‹ä¸€æ­¥æ“ä½œ</h4>
          å¯¼å‡ºç»“æœå¯¼å…¥ä¸»å·¥å…·ã€‚
        </div>
      </div>
    </div>

    <!-- å…¨éƒ¨å¯¼å‡ºåŒºåŸŸ -->
    <div class="section" id="globalExportSection">
        <div class="global-export">
        <h3>ğŸ“Š ä¸€é”®å¯¼å‡ºå…¨éƒ¨è®¡ç®—ç»“æœ</h3>
        <p>å°†æ—§å¥—é¤ã€å¥—é¤æ”¿ç­–ã€æ´»åŠ¨æœºå‹ä¸‰ç§è®¡ç®—ç»“æœåˆå¹¶åˆ°ä¸€ä¸ªExcelæ–‡ä»¶ä¸­ï¼Œé¿å…æ‰‹åŠ¨åˆå¹¶çš„éº»çƒ¦ã€‚</p>
        <button class="btn btn-purple" id="exportAllBtn" onclick="exportAllResults()" disabled>
          ğŸ“‹ å¯¼å‡ºå…¨éƒ¨æ•°æ®
        </button>
        <div class="notice-box">
          <strong>è¯´æ˜ï¼š</strong><br>
          â€¢ åŒä¸€è¡Œæ•°æ®å¦‚è¢«å¤šç§è§„åˆ™åŒ¹é…ï¼Œä¼šåœ¨ä¸åŒåˆ—ä¸­æ˜¾ç¤ºå¯¹åº”çš„ææˆä¿¡æ¯<br>
          â€¢ æœªè¢«ä»»ä½•è§„åˆ™åŒ¹é…çš„åŸå§‹æ•°æ®ä¹Ÿä¼šåŒ…å«åœ¨å†…<br>
          â€¢ åªæœ‰å½“è‡³å°‘æœ‰ä¸€ç§è®¡ç®—ç»“æœå­˜åœ¨æ—¶ï¼Œè¯¥æŒ‰é’®æ‰å¯ç‚¹å‡»
        </div>
      </div>
    </div>

  </div>
</div>

<script>
  /***************** åŸºç¡€æ•°æ®ç»“æ„ä¸å…¨å±€å˜é‡ *****************/
  let excelData = [];
  let baseRecords = [];
  let fieldMapping = {};

  // è®¡ç®—ç»“æœç¼“å­˜
  let oldPackageResults = [];
  let comboPolicyResults = [];
  let activityPolicyResults = [];

  /***************** æ—§å¥—é¤ SKU è§„åˆ™ï¼ˆä¿æŒåŸåˆ—è¡¨é¡ºåº = ä¼˜å…ˆçº§ï¼‰ *****************/
  const oldPackageRules = [
    { id: 1, products: ['CXW-350-Q2CWI', 'JZT-V2B2S'], prices: {'CXW-350-Q2CWI': 5678, 'JZT-V2B2S': 3098}, packagePrice: 5098, commission: 300 },
    { id: 2, products: ['CXW-400-Z3AWi', 'JZT-V2B2S'], prices: {'CXW-400-Z3AWi': 8288, 'JZT-V2B2S': 3098}, packagePrice: 6788, commission: 400 },
    { id: 3, products: ['CXW-350-Q2CWI', 'JZT-V2B2S', 'DWQ10-SR3HWI'], prices: {'CXW-350-Q2CWI': 5678, 'JZT-V2B2S': 3098, 'DWQ10-SR3HWI': 6698}, packagePrice: 8598, commission: 500 },
    { id: 4, products: ['CXW-350-Q2CWi', 'JZT-V2B2S', 'KZQ45-M1wi'], prices: {'CXW-350-Q2CWi': 5678, 'JZT-V2B2S': 3098, 'KZQ45-M1wi': 7308}, packagePrice: 8798, commission: 500 },
    { id: 5, products: ['CXW-350-Q2CWI', 'JZT-V2B2S', 'KZQ45-M1Wi', 'DWQ10-SR3HWI'], prices: {'CXW-350-Q2CWI': 5398, 'JZT-V2B2S': 3098, 'KZQ45-M1Wi': 7308, 'DWQ10-SR3HWI': 6698}, packagePrice: 12898, commission: 800 },
    { id: 6, products: ['KZQ45-M5wi', 'R1600DWWi'], prices: {'KZQ45-M5wi': 9098, 'R1600DWWi': 5988}, packagePrice: 8299, commission: 500 },
    { id: 7, products: ['DWQ15-R3wi', 'DR1600HF2'], prices: {'DWQ15-R3wi': 9388, 'DR1600HF2': 7988}, packagePrice: 10598, commission: 600 }
  ];

  /***************** ç»„åˆå¥—é¤æ”¿ç­–åˆ†ç±» *****************/
  const categoryAliases = {
    'çƒŸæœº': ['çƒŸæœº','æ²¹çƒŸæœº'],
    'è’¸çƒ¤': ['è’¸ç®±','è’¸çƒ¤','è’¸çƒ¤ç®±','è’¸çƒ¤ä¸€ä½“æœº'],
    'æ´—ç¢—æœº': ['æ´—ç¢—æœº','æ´—ç¢—'],
    'çƒ­æ°´å™¨': ['çƒ­æ°´å™¨','ç‡ƒçƒ­','ç‡ƒæ°”çƒ­æ°´å™¨'],
    'å‡€æ°´': ['å‡€æ°´','å‡€æ°´æœº','å‡€æ°´å™¨','é¥®æ°´'],
    'å†°ç®±': ['å†°ç®±','æ¾ä¸‹å†°ç®±'],
    'æ´—æŠ¤': ['æ´—æŠ¤','æ´—è¡£æœº','æ´—çƒ˜å¥—è£…','æ´—çƒ˜','æ¾ä¸‹æ´—æŠ¤']
  };

  const comboPolicyDefs = [
    { id: 'ä¹ä»¶å¥—', priority: 1, commissionPerSet: 1000, categoriesRequired: ['çƒŸæœº','è’¸çƒ¤','æ´—ç¢—æœº','çƒ­æ°´å™¨','å‡€æ°´','å†°ç®±','æ´—æŠ¤'] },
    { id: 'äº”ä»¶å¥—', priority: 2, commissionPerSet: 500, categoriesRequired: ['çƒ­æ°´å™¨','å‡€æ°´','å†°ç®±','æ´—æŠ¤'] },
    { id: 'ç»„åˆå¥—é¤1', priority: 3, commissionPerSet: 300, categoriesRequired: ['GROUP_A','å‡€æ°´','çƒ­æ°´å™¨'], groupA: ['çƒŸæœº','è’¸çƒ¤','æ´—ç¢—æœº'] },
    { id: 'åµŒè’¸å¥—è£…', priority: 4, commissionPerSet: 500, specificModels: ['ER1600BWi','KZQ45-M1Wi'], alternative: { replace: 'KZQ45-M1Wi', with: 'KZQ45-M5Wi', extraDiff: 900 } },
    { id: 'A+å‡€çƒ­ç»„åˆ', priority: 5, commissionPerSet: 200, categoriesRequired: ['GROUP_A','GROUP_B'], groupA: ['çƒŸæœº','è’¸çƒ¤','æ´—ç¢—æœº'], groupB: ['å‡€æ°´','çƒ­æ°´å™¨'] }
  ];

  /***************** æ´»åŠ¨æœºå‹æ”¿ç­– *****************/
  const activityModels = {
      'JSQ31-VJSAI': { type:'ç‡ƒçƒ­', mode:'flat', perUnit:100, note:'æ´»åŠ¨æœŸåŠ æ100å…ƒ/å°' },
      'JSQ31-QJS': { type:'ç‡ƒçƒ­', mode:'flat', perUnit:100, note:'åŠ æ100å…ƒ/å°+èµ å“' },
      'JSQ31-QJSAI': { type:'ç‡ƒçƒ­', mode:'flat', perUnit:100, note:'åŠ æ100å…ƒ/å°+èµ å“' },
      'JSQ33-MJSX': { type:'ç‡ƒçƒ­', mode:'flat', perUnit:100, note:'åŠ æ100å…ƒ/å°+èµ å“' },
      'JSQ40-SJSX': { type:'ç‡ƒçƒ­', mode:'flat', perUnit:300, note:'åŠ æ300å…ƒ/å°+èµ å“' },
      'R1700FWI': { type:'å‡€æ°´', mode:'threshold', threshold:5, perUnit:50, note:'â‰¥5å° å…¨é‡50å…ƒ/å°' },
      'DR1600HF2': { type:'å‡€æ°´', mode:'threshold', threshold:3, perUnit:100, note:'â‰¥3å° å…¨é‡100å…ƒ/å°' },
      'DR1800HF1': { type:'å‡€æ°´', mode:'threshold', threshold:3, perUnit:100, note:'â‰¥3å° å…¨é‡100å…ƒ/å°' },
      'DR1800HF2': { type:'å‡€æ°´', mode:'threshold', threshold:3, perUnit:100, note:'â‰¥3å° å…¨é‡100å…ƒ/å°' },
      'DR2000HF1': { type:'å‡€æ°´', mode:'threshold', threshold:3, perUnit:100, note:'â‰¥3å° å…¨é‡100å…ƒ/å°' },
      'DR2000HF2': { type:'å‡€æ°´', mode:'threshold', threshold:3, perUnit:100, note:'â‰¥3å° å…¨é‡100å…ƒ/å°' },
      'R1800RC9': { type:'å‡€æ°´', mode:'flat', perUnit:100, note:'åŠ æ100å…ƒ/å°' },
      'R2300RC9': { type:'å‡€æ°´', mode:'flat', perUnit:100, note:'åŠ æ100å…ƒ/å°' },
      'R2500AB1AI': { type:'å‡€æ°´', mode:'flat', perUnit:100, note:'åŠ æ100å…ƒ/å°' },
      'R2500RC3': { type:'å‡€æ°´', mode:'flat', perUnit:100, note:'åŠ æ100å…ƒ/å°' },
      'CEWH-60GA': { type:'å…¶ä»–', mode:'flat', perUnit:100, note:'åŠ æ100å…ƒ/å°ï¼ˆåŒ…é”€ï¼‰' }
    };

    /***************** åˆå§‹åŒ– *****************/
    document.addEventListener('DOMContentLoaded', () => {
      setupFileUpload();
      updateExportAllButton();
    });

    function setupFileUpload(){
      const fileInput = document.getElementById('fileInput');
      const uploadArea = document.getElementById('uploadArea');
      fileInput.addEventListener('change', handleFileSelect);
      ['dragenter','dragover'].forEach(evt=>{
        uploadArea.addEventListener(evt,e=>{
          e.preventDefault();e.stopPropagation();
          uploadArea.classList.add('dragover');
        });
      });
      ['dragleave','drop'].forEach(evt=>{
        uploadArea.addEventListener(evt,e=>{
          e.preventDefault();e.stopPropagation();
          if(evt==='drop'){
            const files = e.dataTransfer.files;
            if(files.length>0){ fileInput.files = files; handleFileSelect({target:{files}}); }
          }
          uploadArea.classList.remove('dragover');
        });
      });
    }

    function handleFileSelect(e){
      const file = e.target.files[0];
      if(!file) return;
      showLoading(true);
      hideMessages();
      const reader = new FileReader();
      reader.onload = ev=>{
        try{
          const data = new Uint8Array(ev.target.result);
          const wb = XLSX.read(data,{type:'array'});
          const ws = wb.Sheets[wb.SheetNames[0]];
          excelData = XLSX.utils.sheet_to_json(ws,{header:1});
          if(excelData.length <2) throw new Error('æ•°æ®ä¸è¶³ï¼šéœ€è‡³å°‘1è¡Œè¡¨å¤´+1è¡Œæ•°æ®');
          setupFieldMapping();
          showSuccess('æ–‡ä»¶è¯»å–æˆåŠŸï¼Œè¯·å®Œæˆå­—æ®µæ˜ å°„ã€‚');
        }catch(err){
          showError('è¯»å–å¤±è´¥ï¼š'+err.message);
        }finally{
          showLoading(false);
        }
      };
      reader.readAsArrayBuffer(file);
    }

    /***************** å­—æ®µæ˜ å°„ *****************/
    function setupFieldMapping(){
      const headers = excelData[0];
      const fields = ['orderField','customerField','modelField','salesmanField','quantityField','categoryField'];
      fields.forEach(fid=>{
        const sel = document.getElementById(fid);
        sel.innerHTML = '<option value="">è¯·é€‰æ‹©...</option>';
        headers.forEach((h,i)=>{
          const op = document.createElement('option');
            op.value = i;
            op.textContent = h;
            sel.appendChild(op);
        });
      });
      autoMatch(headers);
      document.getElementById('mappingSection').style.display='block';
      scrollToAnchor('mappingSection');
    }

    function autoMatch(headers){
      const mapKeys = {
        orderField:['å•æ®ç¼–å·','å•æ®å·','å•æ®','è®¢å•ç¼–å·','è®¢å•'],
        customerField:['å®¢æˆ·åº—å','å®¢æˆ·åç§°','å®¢æˆ·'],
        modelField:['è§„æ ¼å‹å·','è§„æ ¼','å‹å·','æœºå‹'],
        salesmanField:['ä¿ƒé”€å‘˜','é”€å”®å‘˜','å¯¼è´­'],
        quantityField:['é”€å”®æ•°é‡','æ•°é‡'],
        categoryField:['å¤§ç±»å‹','å“ç±»']
      };
      
      Object.entries(mapKeys).forEach(([fid,keys])=>{
        const sel = document.getElementById(fid);
        let matched = false;
        
        // Pass 1: Exact match
        for(let i=0;i<headers.length;i++){
          const h = String(headers[i]).trim();
          if(keys.includes(h)){ sel.value = i; matched=true; break; }
        }
        if(matched) return;
        
        // Pass 2: Contains match (more restrictive)
        for(let i=0;i<headers.length;i++){
          const h = String(headers[i]).toLowerCase();
          if(keys.some(k=>h.includes(k.toLowerCase()))){ sel.value = i; break; }
        }
      });
    }

    function collectMapping(){
      fieldMapping = {
        order: valNum('orderField'),
        customer: valNum('customerField'),
        model: valNum('modelField'),
        salesman: valNum('salesmanField'),
        quantity: valNum('quantityField'),
        category: valNum('categoryField')
      };
    }
    function valNum(id){
      const v = document.getElementById(id).value;
      return v===''?NaN:parseInt(v);
    }

    /***************** åŸºç¡€æ•°æ®è§£æ *****************/
    function rebuildBaseData(){
      collectMapping();
      if(Object.values(fieldMapping).slice(0,5).some(v=>isNaN(v))){
        showError('è¯·å…ˆå®Œæˆé™¤"å¤§ç±»å‹"å¤–æ‰€æœ‰å­—æ®µæ˜ å°„ã€‚');
        return;
      }
      baseRecords = [];
      for(let i=1;i<excelData.length;i++){
        const row = excelData[i];
        if(!row) continue;
        const orderNo = safeStr(row[fieldMapping.order]);
        const customer = safeStr(row[fieldMapping.customer]);
        const model = safeStr(row[fieldMapping.model]);
        const salesman = safeStr(row[fieldMapping.salesman]);
        let qty = parseFloat(row[fieldMapping.quantity]);
        if(isNaN(qty) || qty<=0) qty = 1;
        if(!customer || !model || !salesman) continue;
        const categoryRaw = !isNaN(fieldMapping.category) ? safeStr(row[fieldMapping.category]) : '';
        const normModel = normalizeModel(model);
        const normCategory = normalizeCategory(categoryRaw);
        baseRecords.push({
          orderNo,
          customer,
          model,
          modelNorm: normModel,
          salesman,
          quantity: qty,
          categoryRaw,
          category: normCategory,
          originalRow: row,
          rowIndex: i
        });
      }
      showSuccess('åŸºç¡€æ•°æ®è§£æå®Œæˆï¼Œå…± '+baseRecords.length+' æ¡æœ‰æ•ˆè®°å½•ã€‚');
    }

    function safeStr(v){ return v===undefined || v===null ? '' : String(v).trim(); }
    function normalizeModel(m){ return safeStr(m).toUpperCase().replace(/\s+/g,'').replace(/[^A-Z0-9-]/g,''); }
    function normalizeCategory(cat){
      const c = safeStr(cat).toLowerCase();
      if(!c) return '';
      for(const std in categoryAliases){
        if(categoryAliases[std].some(a=>c.includes(a.toLowerCase()))) return std;
      }
      return cat;
    }

    /***************** æ—§å¥—é¤è®¡ç®—ï¼ˆä¿®å¤ç‰ˆï¼‰ *****************/
    function runOldPackageCalc(){
      if(!ensureBaseReady()) return;
      oldPackageResults = calculateOldPackages();
      renderOldPackageResults(oldPackageResults);
      document.getElementById('oldResultsSection').style.display='block';
      scrollToAnchor('oldResultsSection');
      updateExportAllButton();
    }

    function calculateOldPackages(){
      const grouped = groupByCustomer();
      const results = [];

      Object.entries(grouped).forEach(([customer, info])=>{
        const modelPool = {};
        info.items.forEach(rec=>{
          const nm = rec.modelNorm;
          if(!modelPool[nm]) modelPool[nm] = [];
          modelPool[nm].push({ record: rec, used:false });
        });

        oldPackageRules.forEach(rule=>{
          const needModels = [];
          let canMatch = true;
          const tempPick = [];

            rule.products.forEach(req=>{
              const reqNorm = normalizeModel(req);
              const poolArr = modelPool[reqNorm];
              if(!poolArr) { canMatch = false; return; }
              const pick = poolArr.find(p=>!p.used);
              if(!pick){ canMatch = false; return; }
              tempPick.push({ required:req, norm:reqNorm, pick });
            });
          if(!canMatch) return;

          tempPick.forEach(p=>{ p.pick.used = true; });

          const productDetails = tempPick.map((p,i)=>{
            return {
              required: p.required,
              model: p.pick.record.model,
              orderNo: p.pick.record.orderNo,
              showCommission: i===0
            };
          });

          const relatedRecords = tempPick.map(p=>p.pick.record);

          results.push({
            salesman: info.salesman,
            customer,
            packageId: rule.id,
            commission: rule.commission,
            productDetails,
            relatedRecords,
            calculationType: 'old_package'
          });
        });

      });
      return results;
    }

    function renderOldPackageResults(list){
      const tbody = document.getElementById('oldResultsBody');
      tbody.innerHTML = '';
      if(list.length===0){
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#607d8b;padding:28px 10px;">æš‚æ— åŒ¹é…ç»“æœ</td></tr>';
      } else {
        list.forEach(r=>{
          const productsHtml = `
            <div class="package-group">
              <div class="package-header">
                <span>å¥—é¤${r.packageId}</span>
                <span style="color:#2e7d32;font-weight:600;">Â¥${r.commission}</span>
              </div>
              ${r.productDetails.map(p=>`
                <div class="product-row">
                  <div style="flex:1;">
                    <div style="font-weight:600;color:#2c3e50;">${p.model}</div>
                    <div style="color:#607d8b;font-size:.62em;">å•æ®ï¼š${p.orderNo||'æ— '}</div>
                  </div>
                  <div>
                    ${p.showCommission?`<span class="commission-highlight">Â¥${r.commission}</span>`:''}
                  </div>
                </div>
              `).join('')}
            </div>
          `;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td style="font-weight:600;">${r.salesman}</td>
            <td>${r.customer}</td>
            <td style="text-align:center;">${r.packageId}</td>
            <td style="text-align:right;font-weight:600;color:#2e7d32;">Â¥${r.commission}</td>
            <td>${productsHtml}</td>
          `;
          tbody.appendChild(tr);
        });
      }
      document.getElementById('oldCountTag').textContent = list.length;
      renderStats(list, 'oldStats', {
        totalCommission: list.reduce((s,r)=>s+r.commission,0),
        uniqueCustomers: new Set(list.map(r=>r.customer)).size,
        uniqueSalesmen: new Set(list.map(r=>r.salesman)).size
      });
    }

    /***************** ç»„åˆå¥—é¤æ”¿ç­– *****************/
    function runComboPolicyCalc(){
      if(!ensureBaseReady()) return;
      if(isNaN(fieldMapping.category)){
        showError('å¥—é¤æ”¿ç­–è®¡ç®—éœ€è¦"å¤§ç±»å‹"å­—æ®µã€‚');
        return;
      }
      comboPolicyResults = calculateComboPolicies();
      renderComboResults(comboPolicyResults);
      document.getElementById('comboResultsSection').style.display='block';
      scrollToAnchor('comboResultsSection');
      updateExportAllButton();
    }

    function calculateComboPolicies(){
      const grouped = groupByCustomer(true);
      const results = [];
      let globalGroupCounter = 0;
      Object.entries(grouped).forEach(([customer, info])=>{
        const categoryCount = {};
        const categoryRecords = {};
        info.items.forEach(it=>{
          if(!it.category) return;
          categoryCount[it.category] = (categoryCount[it.category]||0) + it.quantity;
          if(!categoryRecords[it.category]) categoryRecords[it.category] = [];
          categoryRecords[it.category].push(it);
        });
        const modelCount = {};
        const modelRecords = {};
        info.items.forEach(it=>{
          modelCount[it.modelNorm] = (modelCount[it.modelNorm]||0) + it.quantity;
          if(!modelRecords[it.modelNorm]) modelRecords[it.modelNorm] = [];
          modelRecords[it.modelNorm].push(it);
        });

        let availableCat = JSON.parse(JSON.stringify(categoryCount));
        let availableModel = JSON.parse(JSON.stringify(modelCount));
        const customerPackages = [];

        comboPolicyDefs.slice().sort((a,b)=>a.priority - b.priority).forEach(def=>{
          if(def.specificModels){
            const baseModelA = normalizeModel(def.specificModels[0]);
            const baseModelB = normalizeModel(def.specificModels[1]);
            let countA = availableModel[baseModelA]||0;
            let countB = availableModel[baseModelB]||0;
            let setCount = Math.min(countA, countB);
            if(setCount>0){
              const relatedRecords = [
                ...(modelRecords[baseModelA]||[]).slice(0, setCount),
                ...(modelRecords[baseModelB]||[]).slice(0, setCount)
              ];
              customerPackages.push({
                type: def.id,
                sets: setCount,
                perCommission: def.commissionPerSet,
                total: setCount * def.commissionPerSet,
                detail: `ER1600BWi:${countA}å° / KZQ45-M1Wi:${countB}å°`,
                relatedRecords
              });
              availableModel[baseModelA]-=setCount;
              availableModel[baseModelB]-=setCount;
            }else{
              if(def.alternative){
                const altModel = normalizeModel(def.alternative.with);
                let altCount = availableModel[altModel]||0;
                let minAltSet = Math.min(countA, altCount);
                if(minAltSet>0){
                  const relatedRecords = [
                    ...(modelRecords[baseModelA]||[]).slice(0, minAltSet),
                    ...(modelRecords[altModel]||[]).slice(0, minAltSet)
                  ];
                  customerPackages.push({
                    type: def.id,
                    sets: minAltSet,
                    perCommission: def.commissionPerSet,
                    total: minAltSet * def.commissionPerSet,
                    detail: `ä½¿ç”¨æ›¿æ¢ï¼šER1600BWi + KZQ45-M5Wiï¼ˆè¡¥å·®${def.alternative.extraDiff}å…ƒ/å¥—ï¼‰ï¼Œå¥—æ•°${minAltSet}`,
                    relatedRecords
                  });
                  availableModel[baseModelA]-=minAltSet;
                  availableModel[altModel]-=minAltSet;
                }
              }
            }
            return;
          }

          let canSets = Infinity;
            if(def.categoriesRequired.includes('GROUP_A')){
              const groupACount = (def.groupA||[]).reduce((sum,cat)=> sum + (availableCat[cat]||0), 0);
              canSets = Math.min(canSets, groupACount);
            }
            if(def.categoriesRequired.includes('GROUP_B')){
              const groupBCount = (def.groupB||[]).reduce((sum,cat)=> sum + (availableCat[cat]||0), 0);
              canSets = Math.min(canSets, groupBCount);
            }
          def.categoriesRequired.forEach(cat=>{
            if(cat==='GROUP_A' || cat==='GROUP_B') return;
            canSets = Math.min(canSets, availableCat[cat]||0);
          });
          if(canSets === Infinity || canSets<=0) return;

          let setsFormed = 0;
          const usedRecords = [];
          while(setsFormed < canSets){
            let ok = true;
            if(def.categoriesRequired.includes('GROUP_A')){
              let remain = 1;
              for(const g of def.groupA){
                const usable = availableCat[g]||0;
                const use = Math.min(usable, remain);
                remain -= use;
              }
              if(remain>0) ok=false;
            }
            if(def.categoriesRequired.includes('GROUP_B')){
              let remain = 1;
              for(const g of def.groupB){
                const usable = availableCat[g]||0;
                const use = Math.min(usable, remain);
                remain -= use;
              }
              if(remain>0) ok=false;
            }
            def.categoriesRequired.forEach(cat=>{
              if(cat==='GROUP_A' || cat==='GROUP_B') return;
              if((availableCat[cat]||0) <1) ok=false;
            });
            if(!ok) break;

            if(def.categoriesRequired.includes('GROUP_A')){
              let need = 1;
              for(const g of def.groupA){
                const usable = availableCat[g]||0;
                if(usable>0 && need>0){
                  availableCat[g] = usable -1;
                  if(categoryRecords[g] && categoryRecords[g].length>0){
                    usedRecords.push(categoryRecords[g].shift());
                  }
                  need--;
                }
              }
            }
            if(def.categoriesRequired.includes('GROUP_B')){
              let need = 1;
              for(const g of def.groupB){
                const usable = availableCat[g]||0;
                if(usable>0 && need>0){
                  availableCat[g] = usable -1;
                  if(categoryRecords[g] && categoryRecords[g].length>0){
                    usedRecords.push(categoryRecords[g].shift());
                  }
                  need--;
                }
              }
            }
            def.categoriesRequired.forEach(cat=>{
              if(cat==='GROUP_A' || cat==='GROUP_B') return;
              availableCat[cat] -=1;
              if(categoryRecords[cat] && categoryRecords[cat].length>0){
                usedRecords.push(categoryRecords[cat].shift());
              }
            });
            setsFormed++;
          }
          if(setsFormed>0){
            customerPackages.push({
              type: def.id,
              sets: setsFormed,
              perCommission: def.commissionPerSet,
              total: setsFormed * def.commissionPerSet,
              detail: buildCategoryDetail(def, categoryCount),
              relatedRecords: usedRecords
            });
          }
        });

        customerPackages.forEach(p=>{
          globalGroupCounter++;
          const groupId = `${p.type}-${String(globalGroupCounter).padStart(3, '0')}`;
          
          // æ„å»ºç»„åˆæ˜ç»†ï¼šå“ç±»:å‹å·
          const productDetails = (p.relatedRecords||[]).map(rec => {
            return `${rec.category || 'æœªçŸ¥'}:${rec.model}`;
          }).join(' | ');
          
          results.push({
            salesman: info.salesman,
            customer,
            packageType: p.type,
            setCount: p.sets,
            commissionPer: p.perCommission,
            commissionTotal: p.total,
            categoryDetail: p.detail,
            relatedRecords: p.relatedRecords||[],
            calculationType: 'combo_package',
            groupId: groupId,
            productDetails: productDetails
          });
        });
      });
      return results;
    }

    function buildCategoryDetail(def, catCount){
      if(def.specificModels) return 'å‹å·é…å¯¹å¥—è£…';
      let parts = def.categoriesRequired.map(c=>{
        if(c==='GROUP_A') return 'Aç»„(çƒŸ/è’¸/æ´—)';
        if(c==='GROUP_B') return 'Bç»„(å‡€æ°´/çƒ­æ°´å™¨)';
        return c+':' + (catCount[c]||0);
      });
      if(def.id === 'A+å‡€çƒ­ç»„åˆ'){
        parts.push('(çˆ†æ¬¾ã€ç‰¹ä»·é™¤å¤–)');
      }
      return parts.join(' | ');
    }

    function renderComboResults(list){
      const tbody = document.getElementById('comboResultsBody');
      tbody.innerHTML = '';
      if(list.length===0){
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#607d8b;padding:28px 10px;">æš‚æ— åŒ¹é…ç»„åˆå¥—é¤</td></tr>';
      } else {
        list.forEach(r=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${r.salesman}</td>
            <td>${r.customer}</td>
            <td style="font-weight:600;">${r.packageType}</td>
            <td style="text-align:center;">${r.setCount}</td>
            <td style="text-align:right;">Â¥${r.commissionPer}</td>
            <td style="text-align:right;font-weight:600;color:#2e7d32;">Â¥${r.commissionTotal}</td>
            <td>${r.categoryDetail}</td>
          `;
          tbody.appendChild(tr);
        });
      }
      document.getElementById('comboCountTag').textContent = list.length;
      renderStats(list, 'comboStats', {
        totalCommission: list.reduce((s,r)=>s+r.commissionTotal,0),
        uniqueCustomers: new Set(list.map(r=>r.customer)).size,
        uniqueSalesmen: new Set(list.map(r=>r.salesman)).size
      });
    }

    /***************** æ´»åŠ¨æœºå‹æ”¿ç­–è®¡ç®— *****************/
    function runActivityPolicyCalc(){
      if(!ensureBaseReady()) return;
      if(isNaN(fieldMapping.category)){
        showError('æ´»åŠ¨æœºå‹æ”¿ç­–è®¡ç®—éœ€è¦"å¤§ç±»å‹"å­—æ®µã€‚');
        return;
      }
      activityPolicyResults = calculateActivityPolicies();
      renderActivityResults(activityPolicyResults);
      document.getElementById('activityResultsSection').style.display='block';
      scrollToAnchor('activityResultsSection');
      updateExportAllButton();
    }

    function calculateActivityPolicies(){
      const group = {};
      baseRecords.forEach(r=>{
        const key = r.salesman + '||' + r.customer + '||' + r.modelNorm;
        if(!group[key]){
          group[key] = { salesman: r.salesman, customer: r.customer, model: r.model, modelNorm: r.modelNorm, quantity:0, records: [] };
        }
        group[key].quantity += r.quantity;
        group[key].records.push(r);
      });
      const results = [];
      Object.values(group).forEach(g=>{
        const rule = activityModels[g.modelNorm];
        if(!rule) return;
        let perUnit = 0;
        let total = 0;
        let note = rule.note;
        if(rule.mode === 'flat'){
          perUnit = rule.perUnit;
          total = perUnit * g.quantity;
        } else if(rule.mode === 'threshold'){
          if(g.quantity >= rule.threshold){
            perUnit = rule.perUnit;
            total = perUnit * g.quantity;
          } else {
            perUnit = 0;
            total = 0;
            note += `ï¼ˆæœªè¾¾é˜ˆå€¼${rule.threshold}å°ï¼‰`;
          }
        }
        results.push({
          salesman: g.salesman,
          customer: g.customer,
          model: g.model,
          quantity: g.quantity,
          perUnit,
          totalCommission: total,
          note,
          relatedRecords: g.records,
          calculationType: 'activity_package'
        });
      });
      return results;
    }

    function renderActivityResults(list){
      const tbody = document.getElementById('activityResultsBody');
      tbody.innerHTML = '';
      if(list.length===0){
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#607d8b;padding:28px 10px;">æš‚æ— ç¬¦åˆæ´»åŠ¨æœºå‹</td></tr>';
      } else {
        list.forEach(r=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${r.salesman}</td>
            <td>${r.customer}</td>
            <td>${r.model}</td>
            <td style="text-align:center;">${r.quantity}</td>
            <td style="text-align:right;">${r.perUnit?('Â¥'+r.perUnit):'-'}</td>
            <td style="text-align:right;font-weight:600;color:${r.totalCommission>0?'#2e7d32':'#888'};">${r.totalCommission>0?('Â¥'+r.totalCommission):'-'}</td>
            <td>${r.note}</td>
          `;
          tbody.appendChild(tr);
        });
      }
      document.getElementById('activityCountTag').textContent = list.length;
      renderStats(list, 'activityStats', {
        totalCommission: list.reduce((s,r)=>s+r.totalCommission,0),
        uniqueCustomers: new Set(list.map(r=>r.customer)).size,
        uniqueSalesmen: new Set(list.map(r=>r.salesman)).size
      });
    }

    /***************** å…¨éƒ¨å¯¼å‡ºåŠŸèƒ½ *****************/
    function updateExportAllButton(){
      const btn = document.getElementById('exportAllBtn');
      const hasResults = oldPackageResults.length > 0 || comboPolicyResults.length > 0 || activityPolicyResults.length > 0;
      btn.disabled = !hasResults;
    }

    function exportAllResults(){
      if(oldPackageResults.length === 0 && comboPolicyResults.length === 0 && activityPolicyResults.length === 0){
        showError('æ— ä»»ä½•è®¡ç®—ç»“æœå¯å¯¼å‡º');
        return;
      }

      try {
        const exportData = [];
        
        // æ„å»ºè¡¨å¤´
        const baseHeaders = [...excelData[0]];
        const newHeaders = [
          ...baseHeaders,
          'ææˆè®¡ç®—çŠ¶æ€',
          'è®¡ç®—ä¼˜å…ˆçº§',
          'æ—§å¥—é¤ææˆé‡‘é¢',
          'æ—§å¥—é¤ç±»å‹',
          'æ—§å¥—é¤ç¼–å·',
          'å¥—é¤æ”¿ç­–ææˆé‡‘é¢',
          'å¥—é¤æ”¿ç­–ç±»å‹',
          'å¥—é¤æ”¿ç­–å¥—æ•°',
          'å¥—é¤æ”¿ç­–ç»„å·',
          'å¥—é¤æ”¿ç­–ç»„åˆæ˜ç»†',
          'æ´»åŠ¨æœºå‹ææˆé‡‘é¢',
          'æ´»åŠ¨æœºå‹ç±»å‹',
          'æ´»åŠ¨æœºå‹å•å°æ¿€åŠ±',
          'æ´»åŠ¨æœºå‹è¯´æ˜'
        ];
        exportData.push(newHeaders);

        // åˆ›å»ºè¡Œç´¢å¼•åˆ°è®¡ç®—ç»“æœçš„æ˜ å°„
        const rowCalculations = {};

        // å¤„ç†æ—§å¥—é¤ç»“æœ
        oldPackageResults.forEach(pkg => {
          pkg.relatedRecords.forEach(record => {
            if (!rowCalculations[record.rowIndex]) {
              rowCalculations[record.rowIndex] = {
                record: record,
                oldPackage: null,
                comboPackage: null,
                activityPackage: null
              };
            }
            rowCalculations[record.rowIndex].oldPackage = {
              commission: pkg.commission,
              type: 'æ—§å¥—é¤',
              packageId: 'å¥—é¤' + pkg.packageId
            };
          });
        });

        // å¤„ç†å¥—é¤æ”¿ç­–ç»“æœ
        comboPolicyResults.forEach(combo => {
          (combo.relatedRecords || []).forEach(record => {
            if (!rowCalculations[record.rowIndex]) {
              rowCalculations[record.rowIndex] = {
                record: record,
                oldPackage: null,
                comboPackage: null,
                activityPackage: null
              };
            }
            rowCalculations[record.rowIndex].comboPackage = {
              commission: combo.commissionTotal,
              type: combo.packageType,
              setCount: combo.setCount,
              groupId: combo.groupId || '',
              productDetails: combo.productDetails || ''
            };
          });
        });

        // å¤„ç†æ´»åŠ¨æœºå‹ç»“æœ
        activityPolicyResults.forEach(activity => {
          (activity.relatedRecords || []).forEach(record => {
            if (!rowCalculations[record.rowIndex]) {
              rowCalculations[record.rowIndex] = {
                record: record,
                oldPackage: null,
                comboPackage: null,
                activityPackage: null
              };
            }
            rowCalculations[record.rowIndex].activityPackage = {
              commission: activity.totalCommission,
              type: activity.model,
              perUnit: activity.perUnit,
              note: activity.note
            };
          });
        });

        // ç”Ÿæˆå¯¼å‡ºæ•°æ®
        for (let i = 1; i < excelData.length; i++) {
          const row = excelData[i];
          if (!row) continue;

          const newRow = [...row];
          const calc = rowCalculations[i];

          if (calc) {
            // æœ‰è®¡ç®—ç»“æœçš„è¡Œ
            newRow.push('activity_package'); // ææˆè®¡ç®—çŠ¶æ€
            newRow.push('1'); // è®¡ç®—ä¼˜å…ˆçº§

            // æ—§å¥—é¤ä¿¡æ¯
            if (calc.oldPackage) {
              newRow.push(calc.oldPackage.commission);
              newRow.push(calc.oldPackage.type);
              newRow.push(calc.oldPackage.packageId);
            } else {
              newRow.push('', '', '');
            }

            // å¥—é¤æ”¿ç­–ä¿¡æ¯
            if (calc.comboPackage) {
              newRow.push(calc.comboPackage.commission);
              newRow.push(calc.comboPackage.type);
              newRow.push(calc.comboPackage.setCount);
              newRow.push(calc.comboPackage.groupId);
              newRow.push(calc.comboPackage.productDetails);
            } else {
              newRow.push('', '', '', '', '');
            }

                        // æ´»åŠ¨æœºå‹ä¿¡æ¯
                        if (calc.activityPackage) {
              newRow.push(calc.activityPackage.commission);
              newRow.push(calc.activityPackage.type);
              newRow.push(calc.activityPackage.perUnit);
              newRow.push(calc.activityPackage.note);
            } else {
              newRow.push('', '', '', '');
            }
          } else {
            // æœªè¢«ä»»ä½•è§„åˆ™åŒ¹é…çš„åŸå§‹æ•°æ®
            newRow.push('', '', '', '', '', '', '', '', '', '', '', '', '', '');
          }

          exportData.push(newRow);
        }

        // å¯¼å‡ºæ–‡ä»¶
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(exportData);
        
        // è®¾ç½®åˆ—å®½
        ws['!cols'] = exportData[0].map(h => ({
          wch: Math.min(String(h).length * 2 + 6, 36)
        }));

        XLSX.utils.book_append_sheet(wb, ws, 'å…¨éƒ¨è®¡ç®—ç»“æœ');
        
        const now = new Date();
        const stamp = now.getFullYear() + 
                     String(now.getMonth() + 1).padStart(2, '0') + 
                     String(now.getDate()).padStart(2, '0') + '_' + 
                     String(now.getHours()).padStart(2, '0') + 
                     String(now.getMinutes()).padStart(2, '0');
        
        const filename = `æ´»åŠ¨å¥—é¤ææˆ_å…¨éƒ¨ç»“æœ_${stamp}.xlsx`;
        XLSX.writeFile(wb, filename);
        
        showSuccess(`å¯¼å‡ºæˆåŠŸï¼š${filename}`);
        showSuccess('æ–‡ä»¶åŒ…å«æ‰€æœ‰ä¸‰ç§è®¡ç®—ç»“æœï¼Œå¯ç›´æ¥å¯¼å…¥ä¸»ææˆè®¡ç®—å·¥å…·ã€‚');
        
      } catch (e) {
        showError('å¯¼å‡ºå¤±è´¥ï¼š' + e.message);
      }
    }

    /***************** é€šç”¨ç»Ÿè®¡æ¸²æŸ“ *****************/
    function renderStats(resultList, containerId, override){
      const el = document.getElementById(containerId);
      el.innerHTML = '';
      if(!resultList || resultList.length===0){
        el.innerHTML = '<div style="grid-column:1/-1;font-size:.65em;color:#607d8b;text-align:center;padding:10px 0;">æš‚æ— æ•°æ®</div>';
        return;
      }
      const stats = override || {
        totalCommission: resultList.reduce((s,r)=> s + (r.commission || 0),0),
        uniqueCustomers: new Set(resultList.map(r=>r.customer)).size,
        uniqueSalesmen: new Set(resultList.map(r=>r.salesman)).size
      };
      const block = [
        { label:'è®°å½•æ•°', value: resultList.length },
        { label:'æ€»æ¿€åŠ±', value: 'Â¥'+ stats.totalCommission },
        { label:'ä¿ƒé”€å‘˜', value: stats.uniqueSalesmen },
        { label:'å®¢æˆ·æ•°', value: stats.uniqueCustomers }
      ];
      block.forEach(b=>{
        const div = document.createElement('div');
        div.className='stat-card';
        div.innerHTML = `<div class="stat-number">${b.value}</div><div class="stat-label">${b.label}</div>`;
        el.appendChild(div);
      });
    }

    /***************** å¯¼å‡ºåŠŸèƒ½ï¼ˆæ—§å¥—é¤å¯¼å‡ºä¿®å¤ï¼‰ *****************/
    function exportOld(){
      if(oldPackageResults.length===0){ showError('æ— æ—§å¥—é¤æ•°æ®å¯å¯¼å‡º'); return; }
      const exportData = [];
      const headers = [...excelData[0], 'ææˆè®¡ç®—çŠ¶æ€', 'è®¡ç®—ä¼˜å…ˆçº§', 'æ´»åŠ¨å¥—é¤ææˆé‡‘é¢', 'å¥—é¤ç±»å‹', 'å¥—é¤ç¼–å·'];
      exportData.push(headers);

      const processedRecords = new Set();

      // ä¿®å¤ï¼šæŒ‰å¥—é¤ result.relatedRecords ç»Ÿä¸€å†™å…¥
      oldPackageResults.forEach(pkg=>{
        pkg.relatedRecords.forEach(record=>{
          if(processedRecords.has(record.rowIndex)) return;
          processedRecords.add(record.rowIndex);
          const newRow = [...record.originalRow];
          newRow.push('activity_package'); // çŠ¶æ€
          newRow.push('1');                // ä¼˜å…ˆçº§
          newRow.push(pkg.commission);     // é‡‘é¢ï¼ˆæ•´å¥—ä¸€è‡´ï¼‰
          newRow.push('æ—§å¥—é¤');           // ç±»å‹
          newRow.push('å¥—é¤'+pkg.packageId); // å¥—é¤ç¼–å·ï¼ˆè§„åˆ™IDï¼‰
          exportData.push(newRow);
        });
      });

      // æœªå ç”¨æ•°æ®åŸæ ·é™„åŠ 
      for(let i=1;i<excelData.length;i++){
        if(!processedRecords.has(i)){
          const newRow = [...excelData[i]];
          newRow.push('');newRow.push('');newRow.push('');newRow.push('');newRow.push('');
          exportData.push(newRow);
        }
      }
      exportSheet(exportData,'æ´»åŠ¨å¥—é¤ææˆ_æ—§å¥—é¤');
    }

    function exportCombo(){
      if(comboPolicyResults.length===0){ showError('æ— å¥—é¤æ”¿ç­–ç»“æœå¯å¯¼å‡º'); return; }
      const exportData = [];
      const headers = [...excelData[0], 'ææˆè®¡ç®—çŠ¶æ€', 'è®¡ç®—ä¼˜å…ˆçº§', 'æ´»åŠ¨å¥—é¤ææˆé‡‘é¢', 'å¥—é¤ç±»å‹', 'å¥—æ•°', 'å¥—é¤ç»„å·', 'ç»„åˆæ˜ç»†'];
      exportData.push(headers);
      const processed = new Set();
      comboPolicyResults.forEach(p=>{
        (p.relatedRecords||[]).forEach(r=>{
          if(processed.has(r.rowIndex)) return;
          processed.add(r.rowIndex);
          const newRow = [...r.originalRow];
          newRow.push('activity_package');
          newRow.push('1');
          newRow.push(p.commissionTotal);
          newRow.push(p.packageType);
          newRow.push(p.setCount);
          newRow.push(p.groupId || '');
          newRow.push(p.productDetails || '');
          exportData.push(newRow);
        });
      });
      for(let i=1;i<excelData.length;i++){
        if(!processed.has(i)){
          const newRow = [...excelData[i]];
          newRow.push('');newRow.push('');newRow.push('');newRow.push('');newRow.push('');newRow.push('');newRow.push('');
          exportData.push(newRow);
        }
      }
      exportSheet(exportData,'æ´»åŠ¨å¥—é¤ææˆ_å¥—é¤æ”¿ç­–');
    }

    function exportActivity(){
      if(activityPolicyResults.length===0){ showError('æ— æ´»åŠ¨æœºå‹ç»“æœå¯å¯¼å‡º'); return; }
      const exportData = [];
      const headers = [...excelData[0], 'ææˆè®¡ç®—çŠ¶æ€', 'è®¡ç®—ä¼˜å…ˆçº§', 'æ´»åŠ¨å¥—é¤ææˆé‡‘é¢', 'æœºå‹', 'å•å°æ¿€åŠ±', 'è¯´æ˜'];
      exportData.push(headers);
      const processed = new Set();
      activityPolicyResults.forEach(a=>{
        (a.relatedRecords||[]).forEach(r=>{
          if(processed.has(r.rowIndex)) return;
          processed.add(r.rowIndex);
          const newRow = [...r.originalRow];
          newRow.push('activity_package');
          newRow.push('1');
          newRow.push(a.totalCommission);
          newRow.push(a.model);
          newRow.push(a.perUnit);
          newRow.push(a.note);
          exportData.push(newRow);
        });
      });
      for(let i=1;i<excelData.length;i++){
        if(!processed.has(i)){
          const newRow = [...excelData[i]];
          newRow.push('');newRow.push('');newRow.push('');newRow.push('');newRow.push('');newRow.push('');
          exportData.push(newRow);
        }
      }
      exportSheet(exportData,'æ´»åŠ¨å¥—é¤ææˆ_æ´»åŠ¨æœºå‹');
    }

    function exportSheet(data, sheetName){
      try{
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(data);
        ws['!cols'] = data[0].map(h=>({wch: Math.min(String(h).length*2 + 6, 36)}));
        XLSX.utils.book_append_sheet(wb, ws, sheetName);
        const now = new Date();
        const stamp = now.getFullYear()+String(now.getMonth()+1).padStart(2,'0')+String(now.getDate()).padStart(2,'0')+'_'+String(now.getHours()).padStart(2,'0')+String(now.getMinutes()).padStart(2,'0');
        XLSX.writeFile(wb, sheetName+'_'+stamp+'.xlsx');
        showSuccess('å¯¼å‡ºæˆåŠŸï¼š'+sheetName+'_'+stamp+'.xlsx');
        showSuccess('è¯·å¯¼å…¥ä¸»ææˆè®¡ç®—å·¥å…·ç»§ç»­å¤„ç†ã€‚');
      }catch(e){
        showError('å¯¼å‡ºå¤±è´¥ï¼š'+e.message);
      }
    }

    /***************** è¾…åŠ© *****************/
    function ensureBaseReady(){
      if(excelData.length===0){
        showError('è¯·å…ˆä¸Šä¼ æ–‡ä»¶');
        return false;
      }
      collectMapping();
      if(Object.values(fieldMapping).slice(0,5).some(v=>isNaN(v))){
        showError('è¯·å®ŒæˆåŸºæœ¬å­—æ®µæ˜ å°„ï¼ˆé™¤å¤§ç±»å‹å¤–ï¼‰å¹¶ç‚¹å‡»"é‡æ–°è§£ææ•°æ®"');
        return false;
      }
      if(baseRecords.length===0){
        rebuildBaseData();
      }
      if(baseRecords.length===0){
        showError('æ— æœ‰æ•ˆè®°å½•å¯è®¡ç®—ã€‚');
        return false;
      }
      return true;
    }

    function groupByCustomer(){
      const map = {};
      baseRecords.forEach(r=>{
        const key = r.customer;
        if(!map[key]){
          map[key] = { salesman: r.salesman, items: [] };
        }
        map[key].items.push(r);
      });
      return map;
    }

    function scrollToAnchor(id, btn){
      const el = document.getElementById(id);
      if(el){
        window.scrollTo({ top: el.getBoundingClientRect().top + window.scrollY - 12, behavior: 'smooth' });
      }
      document.querySelectorAll('.nav-tabs button').forEach(b=>b.classList.remove('active'));
      if(btn) btn.classList.add('active');
    }

    function showLoading(show){
      document.getElementById('loading').style.display = show? 'block':'none';
    }
    function hideMessages(){
      document.getElementById('errorMsg').style.display='none';
      document.getElementById('successMsg').style.display='none';
    }
    function showError(msg){
      const el = document.getElementById('errorMsg');
      el.textContent = msg;
      el.style.display='block';
      setTimeout(()=>{ el.style.display='none'; },6000);
    }
    function showSuccess(msg){
      const el = document.getElementById('successMsg');
      el.textContent = msg;
      el.style.display='block';
      setTimeout(()=>{ el.style.display='none'; },6000);
    }

    /***************** æŠ˜å å±•å¼€åŠŸèƒ½ *****************/
    function toggleSection(sectionId){
      const section = document.getElementById(sectionId);
      if(!section) return;
      if(section.classList.contains('expanded')){
        section.classList.remove('expanded');
      } else {
        section.classList.add('expanded');
      }
    }
  </script>
  </body>
  </html>

