# 提成计算问题分析总结
**分析日期**: 2025-11-19  
**数据来源**: 五合一提成计算_2025-11-18.xlsx

---

## 核心发现

### 🔴 关键问题1: 带单费未正确扣除

**影响订单数**: 至少6个订单

#### 典型案例

| 订单编号 | 支付带单提成点位 | 回款金额 | 应扣除后 | 实际计算 | 问题 |
|---------|----------------|---------|---------|---------|------|
| A20251029003723 | 400 | 2,300 | 1,900 | 2,300 | ❌ 未扣除 |
| A20251026007091 | 400 | 2,250 | 1,850 | 2,250 | ❌ 未扣除 |
| A20251021005203 | 900 | 5,850 | 4,950 | 5,850 | ❌ 未扣除 |
| A20251019000697 | 500 | 2,200 | 1,700 | 2,200 | ❌ 未扣除 |

**问题原因**:
```javascript
// 当前代码 (行896)
const leadFee = normalizeNumber(r["带单费"]) || 0;

// 问题: 数据中使用的是"支付带单提成点位"字段，而不是"带单费"
// 导致 leadFee 始终为 0
```

**详细分析 - A20251029003723**:
- 规格型号: CTE-80E1 (佳尼特特价机)
- 回款金额: 2,300元
- 支付带单提成点位: 400元
- 佳尼特特价: 1,621元
- **当前计算**: (2,300 - 0) - 1,621 = 679元 ❌
- **正确计算**: (2,300 - 400) - 1,621 = 279元 ✅
- **多算了**: 400元

**修复方案**:
```javascript
// 修改行896
const leadFee = normalizeNumber(r["带单费"]) || normalizeNumber(r["支付带单提成点位"]) || 0;
```

---

### 🔴 关键问题2: 卖出的实际折扣计算错误

**影响**: 所有特价机订单的折扣计算

#### 典型案例 - A20251029003723

**当前数据**:
- 系统定价: 2,599元
- 价税合计: 2,300元
- 回款收款金额: 2,300元
- 支付带单提成点位: 400元
- **最终折扣率**: 2,300 / 2,599 = 88.50% ✅ (正确)
- **卖出的实际折扣**: 73.11% ❓ (有问题)

**问题分析**:
```javascript
// 卖出的实际折扣计算公式 (应该是):
// (回款收款金额 - 支付带单提成点位) / 销售数量 / 系统定价

// 正确计算:
(2,300 - 400) / 1 / 2,599 = 1,900 / 2,599 = 73.11% ✅

// 但是这个折扣用于特价机判断时有问题
// 因为特价机应该用回款金额减去带单费后，再与特价比较
```

**关键发现**: 
- "卖出的实际折扣"是扣除带单费后的折扣 (73.11%)
- "最终折扣率"是未扣除带单费的折扣 (88.50%)
- 特价机计算应该使用扣除带单费后的金额，但当前未扣除

---

### 🟡 问题3: 政策机型未匹配

**影响订单**: A20251031002265, A20251030000497

#### 案例 - A20251030000497
- 规格型号: JSQ31-VJSAi
- 折扣: 73.12%
- **当前**: 走了折扣机提成 (1.25元)
- **问题**: 可能应该走销售政策提成

**原因**: 匹配工具未将此型号匹配到销售政策表

---

### 🟡 问题4: 数值精度问题

**影响**: 所有提成计算

#### 发现
查看数据发现，当前计算结果已经是整数或两位小数，但可能存在中间计算精度问题。

**建议**: 在所有提成计算最后添加精度处理：
```javascript
r["特价机提成"] = Math.round(计算结果 * 100) / 100;
```

---

### 🟢 问题5: 金华地区特殊规则

**相关订单**: A20251022004134

**规则说明**: "金华的能效不走特价机，参与过特价机佳尼特的不参加能效，特价机了什么活动都不参与"

**当前状态**: 代码中未实现此规则

**建议实现**:
```javascript
// 在折扣机计算开始时
if (region === "金华" && c_special > 0){
  r["折扣机提成说明"] = "金华地区规则：已参与特价机活动，不参加能效活动，折扣机提成=0";
  // 跳过折扣机计算
}
```

---

## 数据统计

### 总体情况
- **总订单数**: 360笔
- **问题订单**: 23笔
- **找到**: 22笔
- **未找到**: 1笔 (A20250930000811)

### 各类提成统计
| 提成类型 | 笔数 | 合计金额 |
|---------|------|---------|
| 特价机提成 | 37 | 11,360.00 |
| 壁挂炉提成 | 0 | 0.00 |
| 销售政策提成 | 29 | 6,205.64 |
| 销售政策加提 | 21 | 1,550.00 |
| 烟灶提成 | 4 | 1,257.90 |
| 国补提成 | 0 | 0.00 |
| 折扣机提成 | 150 | 21,959.70 |

---

## 具体订单问题详情

### 1. A20251029003723 - 佳尼特带单费 ⭐⭐⭐
**问题**: 带单费400元未扣除
- 当前提成: 679元
- 正确提成: 279元
- **差额**: +400元

### 2. A20251026007091 - 带单费 ⭐⭐⭐
**问题**: 带单费400元未扣除
- 当前提成: 629元
- 正确提成: 229元
- **差额**: +400元

### 3. A20251021005203 - 带单费没剪掉 ⭐⭐⭐
**问题**: 带单费900元未扣除
- 规格型号: JSQ31-QJSAi
- 回款: 5,850元
- 特价: 950元
- 当前提成: 4,229元 (按百分比85% × 5,850 - 750)
- **需要核对**: 是否应该扣除900元带单费

**特殊情况**: 这个订单使用的是百分比方案 (85%)
```
当前计算: (5,850 - 0) × 85% - 750 = 4,972.5 - 750 = 4,222.5
实际结果: 4,229 (可能有其他调整)
```

### 4. A20251019000697 - 带单费 ⭐⭐⭐
**问题**: 带单费500元未扣除
- 当前提成: 650元
- 正确提成: 150元
- **差额**: +500元

### 5. A20251025005260 - 政策（还有100 带单费）269.46 ⭐⭐
**当前状态**: 
- 销售政策提成: 269.46元
- 销售政策加提: 100元
- 合计: 369.46元

**问题描述不清**: "还有100 带单费" 的含义需要确认
- 可能是: 应该再加100元带单费提成？
- 或者是: 带单费100元未扣除？

### 6. A20251030000497 - 应该是政策机型 ⭐⭐
**问题**: 未匹配到销售政策
- 当前: 折扣机提成 1.25元
- 可能应该: 销售政策提成 (73.12% 接近 70% 或 75% 档位)

### 7. A20251031002265, A20251031003624 - 未明确说明 ⭐
**当前状态**: 正常计算了折扣机提成
- A20251031002265: 15.44元
- A20251031003624: 9.41元

需要确认是否有问题。

### 8. A20251028004580 - 标注紫色 ⭐
**当前状态**: 
- 特价机提成: 100元
- 说明: 按元/台：销售数量1 × 100元/台

需要确认"标注紫色"的含义。

### 9. A20251027004349 - 保留小数 ⭐
**当前状态**: 
- 特价机提成: 150元 (整数)

可能需要确认是否应该有小数部分。

### 10. A20251026001230 - R1700wi 为什么给钱 ⭐⭐
**当前状态**:
- 规格型号: R1700wi
- 折扣机提成: 197.95元
- 能效标识: 1
- 所属地区: 杭州

**问题**: 可能这个型号不应该参与能效活动？

### 11. A20251022004134 - 金华特殊规则 ⭐⭐⭐
**规则**: 金华地区，参与过特价机的不参加能效
**当前状态**: 
- 特价机提成: 100元
- 折扣机提成: 0元 (前五模块不全为0)

**结论**: 这个订单当前计算正确，但需要在代码中明确实现金华规则。

### 12. A20251023001265 - 收款问题查一下 ⭐
**当前状态**:
- 价税合计: 6,981元
- 回款收款金额: 6,981元
- 销售政策提成: 314.14元

需要核对收款金额是否正确。

### 13. A20251020003601 - 回款对不上，查一下 ⭐
**当前状态**:
- 价税合计: 7,181元
- 回款收款金额: 7,181元
- 折扣机提成: 197.95元

需要核对回款金额是否正确。

### 14. A20251021002402 - 特价机优先 ⭐⭐
**当前状态**:
- 特价机提成: 0元 (未命中特价机)
- 销售政策提成: 314.14元

**问题**: 如果应该是特价机，为什么没有命中？
- 机型字段: nan (不包含"特价")
- 佳尼特特价: nan (≤0)

### 15. A20251020000295, A20250819001432C - 套餐问题 ⭐
**当前状态**: 
- 提成计算状态: (空)
- 计算优先级: (空)

**问题**: 应该是套餐订单，但未被标记为 activity_package

### 16. A20251019003525 - 特价 ⭐
**当前状态**:
- 机型: nan (不包含"特价")
- 销售政策提成: 314.14元

**问题**: 如果应该是特价机，为什么没有命中？

### 17. A20251012001647 - 没有这单 ⭐
**实际情况**: 找到了这个订单
- 销售政策提成: 292.59元
- 正常计算

**结论**: 订单存在，可能是误报。

### 18. A20251014000643 - 厨电两件套 ⭐
**当前状态**:
- 烟灶提成: 510元
- 正常计算

需要确认"厨电两件套"的特殊处理规则。

### 19. A20250930000811 - 300没有 ⭐
**状态**: ❌ 未找到此订单

---

## 修复优先级

### 🔴 高优先级（立即修复）

#### 1. 带单费字段映射
**影响**: 至少6个订单，总计多算约 2,000+ 元
```javascript
// 修改行896
const leadFee = normalizeNumber(r["带单费"]) || normalizeNumber(r["支付带单提成点位"]) || 0;
```

#### 2. 带单费扣除日志
在计算说明中明确显示带单费扣除情况

### 🟡 中优先级（近期修复）

#### 3. 金华地区特殊规则
实现特价机排除能效规则

#### 4. 数值精度统一
所有提成计算添加精度处理

### 🟢 低优先级（后续优化）

#### 5. 政策机型匹配
优化匹配工具的政策识别逻辑

#### 6. 套餐识别
完善套餐订单的识别和标记

---

## 建议的修复代码

### 修复1: 带单费字段映射
```javascript
// 文件: 六合一提成计算.html
// 行号: 896

// 修改前:
const leadFee = normalizeNumber(r["带单费"]) || 0;

// 修改后:
const leadFee = normalizeNumber(r["带单费"]) || normalizeNumber(r["支付带单提成点位"]) || 0;
```

### 修复2: 增强日志输出
```javascript
// 在特价机提成说明中添加带单费信息
r["特价机提成说明"] = `按超底价：(回款${fmtCurrency(paymentAmount)} - 带单费${fmtCurrency(leadFee)}) - 特价${fmtCurrency(jntPrice)} = ${fmtCurrency(baseAmount)} - ${fmtCurrency(jntPrice)} = ${fmtCurrency(diff)} → 特价机提成=${fmtCurrency(r["特价机提成"])}`;
```

### 修复3: 金华特殊规则
```javascript
// 在折扣机计算开始时 (行1376附近)
if (region === "金华" && c_special > 0){
  r["折扣机提成说明"] = "金华地区规则：已参与特价机活动，不参加能效活动，折扣机提成=0";
  // 跳过后续折扣机计算
}
```

---

## 需要用户确认的问题

1. **A20251025005260**: "还有100 带单费" 的具体含义？
2. **A20251021002402**: 是否应该是特价机？为什么机型字段为空？
3. **A20251030000497**: 是否应该匹配到销售政策？
4. **A20251026001230**: R1700wi 是否应该参与能效活动？
5. **A20251020000295, A20250819001432C**: 是否应该是套餐订单？
6. **A20251014000643**: 厨电两件套是否有特殊处理规则？
7. **A20250930000811**: 这个订单是否应该存在？

---

## 总结

**核心问题**: 带单费未正确扣除，导致特价机提成多算。

**影响范围**: 至少6个订单，估计多算 2,000+ 元。

**修复难度**: 低，只需修改一行代码。

**建议**: 立即修复带单费问题，然后重新计算所有数据。
