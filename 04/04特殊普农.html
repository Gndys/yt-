<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>提成数据处理工具</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 2.2em; margin-bottom: 8px; }
        .header p { opacity: 0.9; }
        .section { padding: 24px 30px; border-bottom: 1px solid #eee; }
        .section h2 { font-size: 1.3em; margin-bottom: 10px; }
        .upload-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
            margin-top: 10px;
        }
        .group-title {
            font-weight: 600;
            color: #444;
            margin-top: 8px;
        }
        .upload-item {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 16px;
            text-align: left;
            transition: all 0.3s ease;
            background: #fafafa;
        }
        .upload-item:hover { border-color: #667eea; background: #f0f4ff; }
        .upload-item.uploaded { border-color: #4CAF50; background: #f0fff0; }
        .upload-item h3 { color: #333; margin-bottom: 8px; font-size: 1em; }
        .upload-item input[type="file"] {
            margin: 8px 0;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
            background: white;
        }
        .status { font-size: 0.88em; margin-top: 6px; padding: 5px 10px; border-radius: 4px; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .controls { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; padding: 12px 20px; border-radius: 8px;
            font-size: 1em; cursor: pointer; transition: all 0.2s ease;
        }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(102,126,234,0.35); }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-toggle {
            background: #28a745; color: white; border: none; padding: 10px 14px; border-radius: 6px; cursor: pointer;
        }
        .btn-toggle.disabled { background: #9fc9ae; cursor: not-allowed; }
        .loading { display: none; text-align: center; padding: 16px; color: #666; }
        .loading.show { display: block; }
        .results { padding: 24px 30px; }
        .table-container { overflow-x: auto; margin-top: 16px; border: 1px solid #ddd; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; min-width: 1400px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; font-size: 0.9em; vertical-align: top; }
        th { background: #f8f9fa; font-weight: 600; color: #333; position: sticky; top: 0; z-index: 10; }
        tr:hover { background: #f7f7f7; }
        .explanation-column { background: #fff7da; font-size: 0.82em; max-width: 260px; word-wrap: break-word; }
        .error-cell { background: #f8d7da; color: #721c24; }
        .success-cell { background: #d4edda; color: #155724; }
        .export { padding: 18px 30px; background: #f8f9fa; text-align: center; }
        .export-btn { background: #28a745; color: white; border: none; padding: 12px 18px; border-radius: 6px; cursor: pointer; }
        .export-btn:hover { background: #218838; }
        .summary { background: #e7f3ff; padding: 12px 14px; border-radius: 6px; margin-bottom: 16px; border-left: 4px solid #007bff; }
        .summary h3 { color: #0056b3; margin-bottom: 6px; font-size: 1.05em;}
        .debug-info { background: #f8f9fa; padding: 12px 14px; border-radius: 6px; margin-bottom: 16px; border-left: 4px solid #6c757d; font-size: 0.9em; }
        .hint { color: #666; font-size: 0.88em; margin-top: 6px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🧮 提成数据处理工具</h1>
            <p>上传Excel文件，自动提取型号并计算提成，支持详细说明的显示与导出</p>
        </div>

        <div class="section">
            <h2>📂 文件上传</h2>
            <div class="group-title">基础表（3个文件）</div>
            <div class="upload-grid">
                <div class="upload-item" id="upload_policy">
                    <h3>渠道政策表.xlsx</h3>
                    <input type="file" id="file_policy" accept=".xlsx,.xls" />
                    <div class="status" id="status_policy"></div>
                </div>
                <div class="upload-item" id="upload_janit">
                    <h3>各店佳尼特标准.xlsx</h3>
                    <input type="file" id="file_janit" accept=".xlsx,.xls" />
                    <div class="status" id="status_janit"></div>
                </div>
                <div class="upload-item" id="upload_roster">
                    <h3>渠道名单.xlsx</h3>
                    <input type="file" id="file_roster" accept=".xlsx,.xls" />
                    <div class="status" id="status_roster"></div>
                </div>
            </div>

            <div class="group-title" style="margin-top:12px;">各门店明细表（2个文件）</div>
            <div class="upload-grid">
                <div class="upload-item" id="upload_main">
                    <h3>普农明细.xlsx</h3>
                    <input type="file" id="file_main" accept=".xlsx,.xls" />
                    <div class="status" id="status_main"></div>
                    <div class="hint">将作为主表进行扩展与计算</div>
                </div>
                <div class="upload-item" id="upload_bonus">
                    <h3>普农加提邮件审批.xls</h3>
                    <input type="file" id="file_bonus" accept=".xlsx,.xls" />
                    <div class="status" id="status_bonus"></div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>⚙️ 数据处理</h2>
            <div class="controls">
                <button class="btn-primary" id="processBtn" onclick="processData()" disabled>开始处理数据</button>
                <button class="btn-toggle" id="toggleBtn" onclick="toggleExplanations()" disabled>显示/隐藏说明列</button>
            </div>
            <div class="loading" id="loading"><p>🔄 正在处理数据，请稍候...</p></div>
        </div>

        <div class="results" id="resultsSection" style="display:none;">
            <h2>📊 处理结果</h2>
            <div class="debug-info" id="debugInfo"></div>
            <div class="summary" id="summary"></div>
            <div class="table-container">
                <table id="resultsTable">
                    <thead id="tableHeader"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="export" id="exportSection" style="display:none;">
            <button class="export-btn" onclick="exportToExcel()">📥 导出Excel文件</button>
        </div>
    </div>

    <script>
        // 全局数据
        let uploadedFiles = {};
        let processedData = null;
        let showExplanations = true;
        let debugMaps = {};
        let headerCache = {}; // 各表头缓存

        // 事件绑定
        document.getElementById('file_policy').addEventListener('change', (e) => handleFileUpload(e, '政策', 'policy'));
        document.getElementById('file_janit').addEventListener('change', (e) => handleFileUpload(e, '佳尼特标准', 'janit'));
        document.getElementById('file_roster').addEventListener('change', (e) => handleFileUpload(e, '渠道名单', 'roster'));
        document.getElementById('file_main').addEventListener('change', (e) => handleFileUpload(e, '普农明细', 'main'));
        document.getElementById('file_bonus').addEventListener('change', (e) => handleFileUpload(e, '普农加提', 'bonus'));

        function handleFileUpload(event, label, key) {
            const file = event.target.files[0];
            const statusElement = document.getElementById('status_' + key);
            const uploadElement = document.getElementById('upload_' + key);

            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const workbook = XLSX.read(e.target.result, {type: 'binary'});
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const data = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                        uploadedFiles[key] = {
                            data: data,
                            headers: data[0] || [],
                            rows: data.slice(1)
                        };
                        headerCache[key] = data[0] || [];
                        statusElement.textContent = `✅ 已上传 (${Math.max(0, data.length - 1)} 行)`;
                        statusElement.className = 'status success';
                        uploadElement.classList.add('uploaded');
                        console.log(label + ' 表头:', data[0]);
                        checkAllFilesUploaded();
                    } catch (error) {
                        statusElement.textContent = `❌ 文件读取失败: ${error.message}`;
                        statusElement.className = 'status error';
                    }
                };
                reader.readAsBinaryString(file);
            }
        }

        function checkAllFilesUploaded() {
            const required = ['policy','janit','roster','main','bonus'];
            const uploadedCount = required.filter(k => uploadedFiles[k]).length;
            const allReady = uploadedCount === required.length;
            document.getElementById('processBtn').disabled = !allReady;
            document.getElementById('toggleBtn').disabled = !allReady;
            if (allReady) {
                document.getElementById('toggleBtn').classList.remove('disabled');
            }
        }

        // 型号提取：支持单段与多段（含连字符）的型号，保留原大小写
        function extractModel(productName) {
            if (!productName) return '';
            const str = String(productName).trim();

            // 去除尾部说明性文字（如：注意.../中间.../备注.../说明...）
            const cleaned = str
                .replace(/\s+(?:注意|备注|说明).*$/i, '')
                .replace(/\s+中间.*$/i, '')
                .trim();

            // 1) 优先匹配位于末尾的型号：字母数字与连字符组合，且至少包含一个字母
            const endMatch = cleaned.match(/(?=[A-Za-z0-9-]*[A-Za-z])[A-Za-z0-9]+(?:-[A-Za-z0-9]+)*\s*$/);
            if (endMatch) {
                return endMatch[0].trim();
            }

            // 2) 回退：查找所有符合的片段，取最后一个
            const allMatches = cleaned.match(/(?=[A-Za-z0-9-]*[A-Za-z])[A-Za-z0-9]+(?:-[A-Za-z0-9]+)*/g);
            if (allMatches && allMatches.length) {
                return allMatches[allMatches.length - 1];
            }

            // 3) 最后兜底：取最后一个短横线后的段
            const parts = cleaned.split('-');
            return parts.length ? parts[parts.length - 1].trim() : cleaned;
        }

        // 型号键统一：大小写脱敏（全部转大写做key），比较时忽略大小写
        function keyOf(model) {
            return (model || '').toString().trim().toUpperCase();
        }

        // 构建映射：渠道政策（型号 -> 提成 或 “以渠道备案提成为准”）
        // 约定列：型号列名含“型号”，提成列名含“提成”
        function buildPolicyMap(policyData) {
            const map = new Map();
            const headers = policyData.headers || [];
            // 动态识别列
            const idxModel = headers.findIndex(h => (h||'').toString().includes('型号'));
            const idxCommission = headers.findIndex(h => (h||'').toString().includes('提成'));
            policyData.rows.forEach((row, i) => {
                const model = row[idxModel];
                const commissionRaw = row[idxCommission];
                if (!model) return;
                const key = keyOf(model);
                const isText = typeof commissionRaw === 'string';
                const isJanit = isText && commissionRaw.includes('以渠道备案提成为准');
                const commissionValue = isJanit ? commissionRaw : parseFloat(commissionRaw) || 0;
                map.set(key, {
                    commission: commissionValue,
                    isJanit: !!isJanit,
                    sourceRow: i + 2
                });
            });
            return { map, idxModel, idxCommission };
        }

        // 构建映射：普农加提（型号 -> 导购加提）
        // 约定列：型号列名含“型号”，导购加提列名含“导购加提”
        function buildBonusMap(bonusData) {
            const map = new Map();
            const headers = bonusData.headers || [];
            const idxModel = headers.findIndex(h => (h||'').toString().includes('型号'));
            let idxBonus = headers.findIndex(h => (h||'').toString().includes('导购加提'));
            // 兼容：若没找到，尝试“加提”
            if (idxBonus < 0) idxBonus = headers.findIndex(h => (h||'').toString().includes('加提'));
            bonusData.rows.forEach((row, i) => {
                const model = row[idxModel];
                const bonus = idxBonus >= 0 ? row[idxBonus] : undefined;
                if (!model || bonus === undefined) return;
                map.set(keyOf(model), {
                    value: parseFloat(bonus) || 0,
                    sourceRow: i + 2,
                    sourceColumn: idxBonus + 1
                });
            });
            return { map, idxModel, idxBonus };
        }

        // 构建映射：佳尼特标准（店铺=普农，型号 -> 导购提成）
        // 约定列：店铺列名含“店铺”或“门店”，型号列名含“型号”，导购提成列名含“提成”
        function buildJanitMap(janitData) {
            const map = new Map();
            const headers = janitData.headers || [];
            const idxShop = headers.findIndex(h => (h||'').toString().match(/店铺|门店/));
            const idxModel = headers.findIndex(h => (h||'').toString().includes('型号'));
            const idxCommission = headers.findIndex(h => (h||'').toString().includes('提成'));
            janitData.rows.forEach((row, i) => {
                const shop = row[idxShop];
                const model = row[idxModel];
                const commission = row[idxCommission];
                if ((shop === '普农') && model && commission !== undefined) {
                    map.set(keyOf(model), {
                        value: parseFloat(commission) || 0,
                        sourceRow: i + 2
                    });
                }
            });
            return { map, idxShop, idxModel, idxCommission };
        }

        // 构建映射：渠道名单（部门 -> 门店/导购人员1/导购人员2）
        // 约定列：部门列名含“部门”，门店列名含“门店”，导购人员列名含“导购人员”
        function buildRosterMap(rosterData) {
            const map = new Map();
            const headers = rosterData.headers || [];
            const idxDept = headers.findIndex(h => (h||'').toString().includes('部门'));
            const idxStore = headers.findIndex(h => (h||'').toString().includes('门店'));
            const idxGuide1 = headers.findIndex(h => (h||'').toString().includes('导购人员') && (h||'').toString().includes('1'));
            const idxGuide2 = headers.findIndex(h => (h||'').toString().includes('导购人员') && (h||'').toString().includes('2'));
            rosterData.rows.forEach((row, i) => {
                const dept = (row[idxDept] || '').toString().trim();
                if (!dept) return;
                map.set(dept, {
                    store: row[idxStore] || '',
                    guide1: row[idxGuide1] || '',
                    guide2: row[idxGuide2] || '',
                    sourceRow: i + 2
                });
            });
            return { map, idxDept, idxStore, idxGuide1, idxGuide2 };
        }

        function processData() {
            document.getElementById('loading').classList.add('show');
            document.getElementById('processBtn').disabled = true;

            setTimeout(() => {
                try {
                    const mainData = uploadedFiles['main'];
                    const policyData = uploadedFiles['policy'];
                    const bonusData = uploadedFiles['bonus'];
                    const janitData = uploadedFiles['janit'];
                    const rosterData = uploadedFiles['roster'];

                    // 构建映射
                    const policy = buildPolicyMap(policyData);
                    const bonus = buildBonusMap(bonusData);
                    const janit = buildJanitMap(janitData);
                    const roster = buildRosterMap(rosterData);
                    debugMaps = { policy, bonus, janit, roster };

                    // 处理主数据
                    const results = processMainData(mainData, policy, bonus, janit, roster);

                    processedData = results;
                    displayResults(results);
                    showDebugInfo();

                    document.getElementById('loading').classList.remove('show');
                    document.getElementById('resultsSection').style.display = 'block';
                    document.getElementById('exportSection').style.display = 'block';
                    document.getElementById('toggleBtn').disabled = false;
                } catch (error) {
                    alert('处理数据时出错: ' + error.message);
                    document.getElementById('loading').classList.remove('show');
                    document.getElementById('processBtn').disabled = false;
                }
            }, 100);
        }

        // 主处理逻辑
        function processMainData(mainData, policy, bonus, janit, roster) {
            const headers = mainData.headers || [];
            const rows = mainData.rows || [];

            // 动态识别主表列
            const idxQty = headers.findIndex(h => (h||'').toString().match(/数量|销售数量/));
            const idxProduct = headers.findIndex(h => (h||'').toString().match(/物料名称|商品名称/));
            const idxModelOriginal = headers.findIndex(h => (h||'').toString().match(/型号/));
            const idxDept = headers.findIndex(h => (h||'').toString().match(/部门/));
            const idxOrigCommission = headers.findIndex(h => (h||'').toString().match(/单台提成|单体提成/));
            const idxOrigBonus = headers.findIndex(h => (h||'').toString().match(/加提/));
            const idxOrigTotal = headers.findIndex(h => (h||'').toString().match(/小计|合计|提成小计/));

            const results = [];
            rows.forEach((row, index) => {
                if (!row || row.length === 0) return;

                // 过滤掉部门="江山厨卫柜组1"的数据
                const dept = (row[idxDept] || '').toString().trim();
                if (dept === '江山厨卫柜组1') return;

                const productName = row[idxProduct] || '';
                const originalModel = row[idxModelOriginal] || '';
                const extractedModel = originalModel ? String(originalModel) : extractModel(productName);
                const modelKey = keyOf(extractedModel);

                const quantity = parseFloat(row[idxQty]) || 0;

                // 特殊型号规则检查
                let newCommission = 0;
                let commissionExplanation = '';
                let matchSource = '';
                let newBonus = 0;
                let bonusExplanation = '';

                if (modelKey === 'PF25C1') {
                    // 特殊规则：PF25C1 固定提成30，加提0
                    newCommission = 30;
                    newBonus = 0;
                    commissionExplanation = `型号"${extractedModel}"采用特殊规则，固定单台提成=30`;
                    bonusExplanation = `型号"${extractedModel}"采用特殊规则，固定加提=0`;
                    matchSource = '特殊规则';
                } else {
                    // 渠道政策匹配
                    const pol = policy.map.get(modelKey);
                    if (pol) {
                        if (pol.isJanit) {
                            // 佳尼特标准（店铺=普农）
                            const jm = janit.map.get(modelKey);
                            if (jm) {
                                newCommission = jm.value;
                                commissionExplanation = `渠道政策第${pol.sourceRow}行提示"以渠道备案提成为准"；转至佳尼特标准（普农）第${jm.sourceRow}行匹配型号"${extractedModel}"，导购提成=${jm.value}`;
                                matchSource = '佳尼特标准';
                            } else {
                                commissionExplanation = `渠道政策第${pol.sourceRow}行提示"以渠道备案提成为准"，但佳尼特标准中未找到店铺"普农"的型号"${extractedModel}"`;
                                matchSource = '未匹配';
                            }
                        } else {
                            newCommission = parseFloat(pol.commission) || 0;
                            commissionExplanation = `渠道政策第${pol.sourceRow}行匹配型号"${extractedModel}"，单台提成=${newCommission}`;
                            matchSource = '渠道政策';
                        }
                    } else {
                        commissionExplanation = `渠道政策表中未找到型号"${extractedModel}"的记录`;
                        matchSource = '未匹配';
                    }

                    // 加提匹配
                    const bm = bonus.map.get(modelKey);
                    if (bm) {
                        newBonus = bm.value;
                        bonusExplanation = `普农加提邮件审批第${bm.sourceRow}行第${bm.sourceColumn}列匹配型号"${extractedModel}"，导购加提=${newBonus}`;
                    } else {
                        bonusExplanation = `普农加提邮件审批中未找到型号"${extractedModel}"的导购加提记录`;
                    }
                }

                // 渠道名单匹配（部门 -> 门店/导购1/导购2）
                let store = '', guide1 = '', guide2 = '';
                let rosterExplanation = '';
                if (dept) {
                    const rm = roster.map.get(dept);
                    if (rm) {
                        store = rm.store || '';
                        guide1 = rm.guide1 || '';
                        guide2 = rm.guide2 || '';
                        rosterExplanation = `渠道名单第${rm.sourceRow}行按部门“${dept}”匹配：门店="${store}"，导购人员1="${guide1}"，导购人员2="${guide2}"`;
                    } else {
                        rosterExplanation = `渠道名单中未找到部门“${dept}”的匹配记录`;
                    }
                } else {
                    rosterExplanation = `主表部门为空，无法在渠道名单中匹配门店与导购人员`;
                }

                // 特殊情况：导购1和2都为空 => 不计算提成，相关字段保持空
                let newTotal = null;
                let totalExplanation = '';
                let commissionFinal = null;
                let bonusFinal = null;
                let skipByNoGuides = (!guide1 && !guide2);
                if (skipByNoGuides) {
                    commissionFinal = '';
                    bonusFinal = '';
                    newTotal = '';
                    totalExplanation = '导购人员1与2均为空，本行不计算提成，相关字段留空';
                } else {
                    commissionFinal = newCommission;
                    bonusFinal = newBonus;
                    newTotal = quantity * newCommission + newBonus * quantity;
                    totalExplanation = `复核提成 = 销售数量(${quantity}) × 单台提成(${newCommission}) + 加提(${newBonus}) × 销售数量(${quantity}) = ${newTotal}`;
                }

                // 原始列（若存在）仅用于对比显示
                const originalCommission = (idxOrigCommission >= 0) ? (parseFloat(row[idxOrigCommission]) || 0) : null;
                const originalBonus = (idxOrigBonus >= 0) ? (parseFloat(row[idxOrigBonus]) || 0) : null;
                const originalTotal = (idxOrigTotal >= 0) ? (parseFloat(row[idxOrigTotal]) || 0) : null;

                // 说明：型号提取
                const modelExplanation = originalModel
                    ? `使用主表原型号“${originalModel}”`
                    : `从“${productName}”中提取型号“${extractedModel}”`;

                // 前后对比：原单体/单台提成 vs 核对单台提成（不一致时说明）
                let diffExplanation = '';
                if (commissionFinal !== '' && originalCommission != null) {
                    const newC = parseFloat(commissionFinal);
                    const oldC = parseFloat(originalCommission);
                    if (newC !== oldC) {
                        diffExplanation = `原单体提成=${oldC}，核对单台提成=${newC}，不一致`;
                    }
                }

                results.push({
                    rowIndex: index + 1,
                    originalData: row.slice(),
                    extractedModel,
                    newCommission: commissionFinal,
                    newBonus: bonusFinal,
                    newTotal,
                    commissionExplanation,
                    bonusExplanation,
                    totalExplanation,
                    rosterExplanation,
                    modelExplanation,
                    matchSource,
                    quantity,
                    originalCommission,
                    originalBonus,
                    originalTotal,
                    store,
                    guide1,
                    guide2,
                    diffExplanation
                });
            });

            return results;
        }

        function showDebugInfo() {
            const debugInfo = document.getElementById('debugInfo');

            const pH = headerCache['policy'] || [];
            const bH = headerCache['bonus'] || [];
            const jH = headerCache['janit'] || [];
            const rH = headerCache['roster'] || [];
            const mH = headerCache['main'] || [];

            const info = `
                <h4>🔎 数据表结构分析</h4>
                <p><strong>普农明细:</strong> 自动识别列 → 数量/销售数量, 物料名称/商品名称, 型号, 部门, 单台提成, 加提, 提成小计</p>
                <p><strong>渠道政策表:</strong> 识别“型号”列与“提成”列；若提成=“以渠道备案提成为准”，转查佳尼特（普农）</p>
                <p><strong>普农加提邮件审批:</strong> 识别“型号”列与“导购加提”列</p>
                <p><strong>各店佳尼特标准:</strong> 店铺=“普农”，识别“型号”与“提成”</p>
                <p><strong>渠道名单:</strong> 识别“部门”→“门店/导购人员1/导购人员2”</p>
                <p><strong>表头示例:</strong></p>
                <ul>
                    <li>普农明细: ${JSON.stringify(mH)}</li>
                    <li>渠道政策: ${JSON.stringify(pH)}</li>
                    <li>普农加提: ${JSON.stringify(bH)}</li>
                    <li>佳尼特标准: ${JSON.stringify(jH)}</li>
                    <li>渠道名单: ${JSON.stringify(rH)}</li>
                </ul>
                <p><strong>映射规模:</strong>
                  渠道政策 ${debugMaps.policy.map.size} 条；
                  加提 ${debugMaps.bonus.map.size} 条；
                  佳尼特（普农）${debugMaps.janit.map.size} 条；
                  渠道名单 ${debugMaps.roster.map.size} 条
                </p>
            `;
            debugInfo.innerHTML = info;
        }

        function displayResults(results) {
            const headers = uploadedFiles['main'].headers;
            const tableHeader = document.getElementById('tableHeader');
            const tableBody = document.getElementById('tableBody');

            // 新增字段列
            const addedHeaders = [
                '型号', '单台提成(核对)', '加提(核对)', '提成(核对)', '门店', '导购人员 1', '导购人员 2',
                '型号说明', '提成说明', '加提说明', '门店/导购说明', '计算说明', '前后对比'
            ];

            let headerHTML = '<tr>';
            headers.forEach(h => { headerHTML += `<th>${h}</th>`; });
            addedHeaders.forEach(h => {
                const isExplain = ['型号说明','提成说明','加提说明','门店/导购说明','计算说明','前后对比'].includes(h);
                headerHTML += `<th class="${isExplain ? 'explanation-column' : ''}">${h}</th>`;
            });
            headerHTML += '</tr>';
            tableHeader.innerHTML = headerHTML;

            let bodyHTML = '';
            let totalRows = results.length;
            let matchedRows = 0;
            let totalDifference = 0;

            results.forEach(r => {
                bodyHTML += '<tr>';

                // 对齐原始列长度
                for (let i = 0; i < headers.length; i++) {
                    bodyHTML += `<td>${r.originalData[i] ?? ''}</td>`;
                }

                // 新增列：型号
                bodyHTML += `<td>${r.extractedModel || ''}</td>`;

                // 新增列：单台提成(核对)
                let commissionClass = '';
                if (r.newCommission === '') {
                    commissionClass = ''; // 跳过计算的情况
                } else if (r.originalCommission != null) {
                    commissionClass = (parseFloat(r.newCommission) === parseFloat(r.originalCommission)) ? 'success-cell' : 'error-cell';
                }
                bodyHTML += `<td class="${commissionClass}">${r.newCommission === '' ? '' : r.newCommission}</td>`;

                // 新增列：加提(核对)
                let bonusClass = '';
                if (r.newBonus === '') {
                    bonusClass = '';
                } else if (r.originalBonus != null) {
                    bonusClass = (parseFloat(r.newBonus) === parseFloat(r.originalBonus)) ? 'success-cell' : 'error-cell';
                }
                bodyHTML += `<td class="${bonusClass}">${r.newBonus === '' ? '' : r.newBonus}</td>`;

                // 新增列：提成(核对)
                let totalClass = '';
                if (r.newTotal === '') {
                    totalClass = '';
                    bodyHTML += `<td class="">${''}</td>`;
                } else {
                    const newTotalFixed = (parseFloat(r.newTotal || 0)).toFixed(2);
                    if (r.originalTotal != null) {
                        totalClass = (Math.abs(parseFloat(newTotalFixed) - parseFloat(r.originalTotal || 0)) <= 0.01) ? 'success-cell' : 'error-cell';
                        totalDifference += Math.abs(parseFloat(newTotalFixed) - parseFloat(r.originalTotal || 0));
                    }
                    bodyHTML += `<td class="${totalClass}">${newTotalFixed}</td>`;
                }

                // 门店/导购列
                bodyHTML += `<td>${r.store || ''}</td>`;
                bodyHTML += `<td>${r.guide1 || ''}</td>`;
                bodyHTML += `<td>${r.guide2 || ''}</td>`;

                // 说明列
                bodyHTML += `<td class="explanation-column">${r.modelExplanation}</td>`;
                bodyHTML += `<td class="explanation-column">${r.commissionExplanation}</td>`;
                bodyHTML += `<td class="explanation-column">${r.bonusExplanation}</td>`;
                bodyHTML += `<td class="explanation-column">${r.rosterExplanation}</td>`;
                bodyHTML += `<td class="explanation-column">${r.totalExplanation}</td>`;
                bodyHTML += `<td class="explanation-column">${r.diffExplanation || ''}</td>`;

                bodyHTML += '</tr>';

                if (r.matchSource && r.matchSource !== '未匹配') matchedRows++;
            });

            tableBody.innerHTML = bodyHTML;

            // 汇总
            const summary = document.getElementById('summary');
            const matchedRate = totalRows ? (matchedRows/totalRows*100).toFixed(1) : '0.0';
            summary.innerHTML = `
                <h3>📈 处理汇总</h3>
                <p><strong>总行数:</strong> ${totalRows}</p>
                <p><strong>成功匹配(政策/佳尼特):</strong> ${matchedRows} 行 (${matchedRate}%)</p>
                <p><strong>提成差异总额(与原小计对比):</strong> ${totalDifference.toFixed(2)} 元</p>
                <p class="hint">提示：如主表没有“原单台提成/原加提/提成小计”列，则不显示对比着色。</p>
            `;
        }

        function toggleExplanations() {
            showExplanations = !showExplanations;
            const explanationColumns = document.querySelectorAll('.explanation-column');
            explanationColumns.forEach(col => {
                col.style.display = showExplanations ? 'table-cell' : 'none';
            });
        }

        function exportToExcel() {
            if (!processedData) return;

            const headers = uploadedFiles['main'].headers.concat([
                '型号', '单台提成(核对)', '加提(核对)', '提成(核对)', '门店', '导购人员 1', '导购人员 2',
                '型号说明', '提成说明', '加提说明', '门店/导购说明', '计算说明', '前后对比'
            ]);

            const exportData = [headers];

            processedData.forEach(r => {
                const originalDataAligned = [];
                for (let i = 0; i < uploadedFiles['main'].headers.length; i++) {
                    originalDataAligned.push(r.originalData[i] || '');
                }
                const row = originalDataAligned.concat([
                    r.extractedModel || '',
                    r.newCommission === '' ? '' : r.newCommission,
                    r.newBonus === '' ? '' : r.newBonus,
                    r.newTotal === '' ? '' : r.newTotal,
                    r.store || '',
                    r.guide1 || '',
                    r.guide2 || '',
                    r.modelExplanation || '',
                    r.commissionExplanation || '',
                    r.bonusExplanation || '',
                    r.rosterExplanation || '',
                    r.totalExplanation || '',
                    r.diffExplanation || ''
                ]);
                exportData.push(row);
            });

            const ws = XLSX.utils.aoa_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "处理结果");

            const fileName = `提成数据处理结果_${new Date().toISOString().slice(0,10)}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }
    </script>
</body>
</html>