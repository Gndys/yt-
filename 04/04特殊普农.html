<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™®å†œææˆæ•°æ®å¤„ç†å·¥å…· - A.O.å²å¯†æ–¯ä¸šåŠ¡å·¥å…·å¹³å°</title>
    
    <!-- ç»Ÿä¸€æ ·å¼æ–‡ä»¶ -->
    <link rel="stylesheet" href="../common-styles.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* å·¥å…·ç‰¹å®šæ ·å¼ - æ™®å†œä¸“ç”¨ */
        .upload-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--space-md);
            margin-top: var(--space-md);
        }
        .group-title {
            font-weight: 600;
            color: var(--text-secondary);
            margin-top: var(--space-md);
            margin-bottom: var(--space-sm);
        }
        .upload-item {
            border: 2px dashed var(--border-medium);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            text-align: left;
            transition: all var(--transition-normal) var(--transition);
            background: var(--bg-primary);
        }
        .upload-item:hover { 
            border-color: var(--accent-gold); 
            background: var(--accent-gold-light); 
        }
        .upload-item.uploaded { 
            border-color: var(--color-success); 
            background: var(--color-success-light); 
        }
        .upload-item h3 { 
            color: var(--text-primary); 
            margin-bottom: var(--space-sm); 
            font-size: 1em; 
        }
        .upload-item input[type="file"] {
            margin: var(--space-sm) 0;
            padding: var(--space-sm);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-sm);
            width: 100%;
            background: var(--bg-card);
        }
        .status { 
            font-size: 0.875rem; 
            margin-top: var(--space-sm); 
            padding: var(--space-xs) var(--space-md); 
            border-radius: var(--radius-sm); 
        }
        .status.success { 
            background: var(--color-success-light); 
            color: #065F46; 
            border: 1px solid var(--color-success); 
        }
        .status.error { 
            background: var(--color-danger-light); 
            color: #991B1B; 
            border: 1px solid var(--color-danger); 
        }
        .controls { 
            display: flex; 
            flex-wrap: wrap; 
            gap: var(--space-md); 
            align-items: center; 
        }
        .btn-toggle {
            background: var(--color-success); 
            color: white; 
            border: none; 
            padding: var(--space-md) var(--space-lg); 
            border-radius: var(--radius-md); 
            cursor: pointer;
            transition: all var(--transition-normal) var(--transition);
        }
        .btn-toggle:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        .btn-toggle.disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            transform: none;
            box-shadow: none;
        }
        .explanation-column { 
            background: #fff7da; 
            font-size: 0.875rem; 
            max-width: 260px; 
            word-wrap: break-word; 
        }
        .error-cell { 
            background: var(--color-danger-light); 
            color: #991B1B; 
        }
        .success-cell { 
            background: var(--color-success-light); 
            color: #065F46; 
        }
        .hint { 
            color: var(--text-tertiary); 
            font-size: 0.875rem; 
            margin-top: var(--space-sm); 
        }
        
        /* æ¨¡æ€å¯¹è¯æ¡†æ ·å¼ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.show { display: flex; }
        .modal-content {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
        }
        .modal-content.large {
            max-width: 1200px;
        }
        .modal-header {
            font-size: 1.4em;
            font-weight: 600;
            margin-bottom: var(--space-md);
            color: var(--text-primary);
        }
        .modal-body {
            margin-bottom: var(--space-lg);
        }
        .sheet-list {
            list-style: none;
            padding: 0;
        }
        .sheet-item {
            padding: var(--space-md);
            margin: var(--space-sm) 0;
            border: 2px solid var(--border-medium);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-normal) var(--transition);
        }
        .sheet-item:hover {
            border-color: var(--accent-gold);
            background: var(--accent-gold-light);
        }
        .sheet-item.selected {
            border-color: var(--accent-blue);
            background: var(--accent-blue-light);
        }
        .sheet-item input[type="radio"] {
            margin-right: var(--space-sm);
        }
        .field-mapping-table {
            width: 100%;
            border-collapse: collapse;
            margin: var(--space-md) 0;
        }
        .field-mapping-table th,
        .field-mapping-table td {
            padding: var(--space-md);
            text-align: left;
            border-bottom: 1px solid var(--border-light);
        }
        .field-mapping-table th {
            background: var(--bg-primary);
            font-weight: 600;
        }
        .field-mapping-table select {
            width: 100%;
            padding: var(--space-sm);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-sm);
            background: var(--bg-card);
            font-size: 0.95em;
        }
        .field-mapping-table .required {
            color: var(--color-danger);
            font-weight: bold;
        }
        .header-row-selector {
            background: var(--accent-gold-light);
            padding: var(--space-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-md);
            border-left: 4px solid var(--accent-gold);
        }
        .header-row-selector label {
            display: inline-block;
            margin-right: var(--space-lg);
            cursor: pointer;
            font-weight: 500;
        }
        .header-row-selector input[type="radio"] {
            margin-right: var(--space-xs);
        }
        .data-preview {
            background: var(--bg-primary);
            padding: var(--space-md);
            border-radius: var(--radius-md);
            margin: var(--space-md) 0;
            max-height: 200px;
            overflow: auto;
        }
        .data-preview h4 {
            margin-bottom: var(--space-sm);
            color: var(--text-tertiary);
            font-size: 0.95em;
        }
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }
        .preview-table th,
        .preview-table td {
            padding: 6px 8px;
            border: 1px solid var(--border-light);
            background: var(--bg-card);
        }
        .preview-table th {
            background: var(--accent-blue-light);
            font-weight: 600;
        }
        .modal-footer {
            display: flex;
            gap: var(--space-md);
            justify-content: flex-end;
        }
        .modal-btn {
            padding: var(--space-md) var(--space-lg);
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.95em;
            transition: all var(--transition-normal) var(--transition);
        }
        .modal-btn-primary {
            background: var(--accent-gold);
            color: var(--text-primary);
        }
        .modal-btn-primary:hover {
            background: var(--accent-gold-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        .modal-btn-secondary {
            background: var(--text-tertiary);
            color: white;
        }
        .modal-btn-secondary:hover {
            background: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="tool-container">
        <!-- å¤´éƒ¨ -->
        <header class="tool-header">
            <a href="../index.html" class="back-nav">â† è¿”å›é¦–é¡µ</a>
            <h1>ğŸ§® æ™®å†œææˆæ•°æ®å¤„ç†å·¥å…·</h1>
            <p class="tool-subtitle">ä¸Šä¼ Excelæ–‡ä»¶ï¼Œè‡ªåŠ¨æå–å‹å·å¹¶è®¡ç®—ææˆï¼Œæ”¯æŒè¯¦ç»†è¯´æ˜çš„æ˜¾ç¤ºä¸å¯¼å‡º</p>
            <div class="tool-badge">
                <span class="badge-dot"></span>
                <span>04 - ç‰¹æ®Šæ¸ é“å·¥å…·</span>
            </div>
        </header>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="tool-content">
        <section class="section">
            <h2>ğŸ“‚ æ–‡ä»¶ä¸Šä¼ </h2>
            <div class="group-title">åŸºç¡€è¡¨ï¼ˆ3ä¸ªæ–‡ä»¶ï¼‰</div>
            <div class="upload-grid">
                <div class="upload-item" id="upload_policy">
                    <h3>æ¸ é“æ”¿ç­–è¡¨.xlsx</h3>
                    <input type="file" id="file_policy" accept=".xlsx,.xls" />
                    <div class="status" id="status_policy"></div>
                </div>
                <div class="upload-item" id="upload_janit">
                    <h3>å„åº—ä½³å°¼ç‰¹æ ‡å‡†.xlsx</h3>
                    <input type="file" id="file_janit" accept=".xlsx,.xls" />
                    <div class="status" id="status_janit"></div>
                </div>
                <div class="upload-item" id="upload_roster">
                    <h3>æ¸ é“åå•.xlsx</h3>
                    <input type="file" id="file_roster" accept=".xlsx,.xls" />
                    <div class="status" id="status_roster"></div>
                </div>
            </div>

            <div class="group-title" style="margin-top:12px;">å„é—¨åº—æ˜ç»†è¡¨ï¼ˆ2ä¸ªæ–‡ä»¶ï¼‰</div>
            <div class="upload-grid">
                <div class="upload-item" id="upload_main">
                    <h3>æ™®å†œæ˜ç»†.xlsx</h3>
                    <input type="file" id="file_main" accept=".xlsx,.xls" />
                    <div class="status" id="status_main"></div>
                    <div class="hint">å°†ä½œä¸ºä¸»è¡¨è¿›è¡Œæ‰©å±•ä¸è®¡ç®—</div>
                </div>
                <div class="upload-item" id="upload_bonus">
                    <h3>æ™®å†œåŠ æé‚®ä»¶å®¡æ‰¹.xls</h3>
                    <input type="file" id="file_bonus" accept=".xlsx,.xls" />
                    <div class="status" id="status_bonus"></div>
                </div>
            </div>
        </section>

        <!-- æ•°æ®å¤„ç†åŒºå— -->
        <section class="section">
            <div class="section-header">
                <span class="section-icon">âš™ï¸</span>
                <h2 class="section-title">æ•°æ®å¤„ç†</h2>
            </div>
            <div class="controls">
                <button class="btn btn-primary btn-lg" id="processBtn" onclick="processData()" disabled>å¼€å§‹å¤„ç†æ•°æ®</button>
                <button class="btn-toggle btn-lg" id="toggleBtn" onclick="toggleExplanations()" disabled>æ˜¾ç¤º/éšè—è¯´æ˜åˆ—</button>
            </div>
            <div class="loading-section hidden" id="loading">
                <div class="loading-spinner"></div>
                <p class="loading-text">æ­£åœ¨å¤„ç†æ•°æ®ï¼Œè¯·ç¨å€™...</p>
            </div>
        </section>

        <!-- ç»“æœæ˜¾ç¤ºåŒºå— -->
        <section class="section hidden" id="resultsSection">
            <div class="section-header">
                <span class="section-icon">ğŸ“Š</span>
                <h2 class="section-title">å¤„ç†ç»“æœ</h2>
            </div>
            <div class="alert alert-info" id="debugInfo"></div>
            <div id="summary"></div>
            <div class="table-container">
                <div class="table-wrapper">
                    <table class="data-table" id="resultsTable">
                        <thead id="tableHeader"></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="text-center mt-xl" id="exportSection">
                <button class="btn btn-success btn-lg" onclick="exportToExcel()">ğŸ“¥ å¯¼å‡ºExcelæ–‡ä»¶</button>
            </div>
        </section>
        </main>

        <!-- é¡µè„š -->
        <footer class="tool-footer">
            <p class="footer-text">æ™®å†œææˆæ•°æ®å¤„ç†å·¥å…· | æ›´æ–°æ—¥æœŸ: 2025-11-04</p>
            <div class="footer-links">
                <a href="../index.html" class="footer-link">è¿”å›é¦–é¡µ</a>
                <a href="https://iiuzjzy3ccx.feishu.cn/wiki/PbWjwvsXmiJK38kcVdFcsnVNndd" class="footer-link">ä½¿ç”¨æ–‡æ¡£</a>
            </div>
        </footer>
    </div>

    <!-- Sheeté€‰æ‹©æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="sheetSelectorModal">
        <div class="modal-content">
            <div class="modal-header">é€‰æ‹©å·¥ä½œè¡¨</div>
            <div class="modal-body">
                <p style="color: #666; margin-bottom: 12px;">æ£€æµ‹åˆ°æ–‡ä»¶åŒ…å«å¤šä¸ªå·¥ä½œè¡¨ï¼Œè¯·é€‰æ‹©è¦å¤„ç†çš„æ•°æ®è¡¨ï¼š</p>
                <ul class="sheet-list" id="sheetList"></ul>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="cancelSheetSelection()">å–æ¶ˆ</button>
                <button class="modal-btn modal-btn-primary" onclick="confirmSheetSelection()">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <!-- å­—æ®µæ˜ å°„æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="fieldMappingModal">
        <div class="modal-content large">
            <div class="modal-header">å­—æ®µæ˜ å°„é…ç½®</div>
            <div class="modal-body">
                <!-- è¡¨å¤´è¡Œé€‰æ‹© -->
                <div class="header-row-selector">
                    <strong>ğŸ” è¡¨å¤´ä½ç½®ï¼š</strong>
                    <label>
                        <input type="radio" name="headerRow" value="0" checked onchange="updateHeaderRow()">
                        ç¬¬1è¡Œæ˜¯è¡¨å¤´
                    </label>
                    <label>
                        <input type="radio" name="headerRow" value="1" onchange="updateHeaderRow()">
                        ç¬¬2è¡Œæ˜¯è¡¨å¤´ï¼ˆç¬¬1è¡Œæ˜¯åˆå¹¶å•å…ƒæ ¼ï¼‰
                    </label>
                </div>
                
                <!-- æ•°æ®é¢„è§ˆ -->
                <div class="data-preview">
                    <h4>ğŸ“‹ æ•°æ®é¢„è§ˆï¼ˆå‰3è¡Œï¼‰ï¼š</h4>
                    <div id="dataPreviewContent"></div>
                </div>
                
                <p style="color: #666; margin-bottom: 12px;">è¯·å°†Excelåˆ—æ˜ å°„åˆ°å¯¹åº”å­—æ®µï¼ˆ<span class="required">*</span>ä¸ºå¿…éœ€å­—æ®µï¼‰ï¼š</p>
                <table class="field-mapping-table">
                    <thead>
                        <tr>
                            <th style="width: 35%;">å­—æ®µåç§°</th>
                            <th style="width: 65%;">Excelåˆ—</th>
                        </tr>
                    </thead>
                    <tbody id="fieldMappingBody">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="cancelFieldMapping()">å–æ¶ˆ</button>
                <button class="modal-btn modal-btn-primary" onclick="confirmFieldMapping()">ç¡®è®¤é…ç½®</button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€æ•°æ®
        let uploadedFiles = {};
        let processedData = null;
        let showExplanations = true;
        let debugMaps = {};
        let headerCache = {}; // å„è¡¨å¤´ç¼“å­˜
        let currentWorkbook = null; // å½“å‰å¤„ç†çš„workbookï¼ˆç”¨äºsheeté€‰æ‹©ï¼‰
        let currentFileKey = null; // å½“å‰å¤„ç†çš„æ–‡ä»¶key
        let selectedSheetName = null; // é€‰ä¸­çš„sheetåç§°
        let rawSheetData = null; // åŸå§‹sheetæ•°æ®ï¼ˆåŒ…å«æ‰€æœ‰è¡Œï¼Œç”¨äºè¡¨å¤´è¡Œé€‰æ‹©ï¼‰
        let currentHeaderRowIndex = 0; // å½“å‰é€‰æ‹©çš„è¡¨å¤´è¡Œç´¢å¼•ï¼ˆ0æˆ–1ï¼‰

        // äº‹ä»¶ç»‘å®š
        document.getElementById('file_policy').addEventListener('change', (e) => handleFileUpload(e, 'æ”¿ç­–', 'policy'));
        document.getElementById('file_janit').addEventListener('change', (e) => handleFileUpload(e, 'ä½³å°¼ç‰¹æ ‡å‡†', 'janit'));
        document.getElementById('file_roster').addEventListener('change', (e) => handleFileUpload(e, 'æ¸ é“åå•', 'roster'));
        document.getElementById('file_main').addEventListener('change', (e) => handleFileUpload(e, 'æ™®å†œæ˜ç»†', 'main'));
        document.getElementById('file_bonus').addEventListener('change', (e) => handleFileUpload(e, 'æ™®å†œåŠ æ', 'bonus'));

        // Sheeté€‰æ‹©ç›¸å…³å‡½æ•°
        function showSheetSelector(workbook, fileKey) {
            currentWorkbook = workbook;
            currentFileKey = fileKey;
            const sheetNames = workbook.SheetNames;
            const sheetList = document.getElementById('sheetList');
            sheetList.innerHTML = '';
            
            sheetNames.forEach((name, index) => {
                const li = document.createElement('li');
                li.className = 'sheet-item';
                if (index === 0) {
                    li.classList.add('selected');
                    selectedSheetName = name;
                }
                li.innerHTML = `
                    <label style="cursor: pointer; display: block;">
                        <input type="radio" name="sheet" value="${name}" ${index === 0 ? 'checked' : ''}>
                        ${name}
                    </label>
                `;
                li.onclick = function() {
                    document.querySelectorAll('.sheet-item').forEach(item => item.classList.remove('selected'));
                    this.classList.add('selected');
                    this.querySelector('input[type="radio"]').checked = true;
                    selectedSheetName = name;
                };
                sheetList.appendChild(li);
            });
            
            document.getElementById('sheetSelectorModal').classList.add('show');
        }

        function cancelSheetSelection() {
            document.getElementById('sheetSelectorModal').classList.remove('show');
            currentWorkbook = null;
            currentFileKey = null;
            selectedSheetName = null;
            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
            if (currentFileKey) {
                document.getElementById('file_' + currentFileKey).value = '';
            }
        }

        function confirmSheetSelection() {
            if (!selectedSheetName || !currentWorkbook || !currentFileKey) return;
            
            document.getElementById('sheetSelectorModal').classList.remove('show');
            
            // è¯»å–é€‰ä¸­çš„sheetæ•°æ®
            const worksheet = currentWorkbook.Sheets[selectedSheetName];
            const data = XLSX.utils.sheet_to_json(worksheet, {header: 1});
            
            // è¿›å…¥å­—æ®µæ˜ å°„æµç¨‹
            showFieldMapping(data, currentFileKey);
        }

        // å­—æ®µæ˜ å°„ç›¸å…³å‡½æ•°
        function showFieldMapping(data, fileKey) {
            // ä¿å­˜åŸå§‹æ•°æ®
            rawSheetData = data;
            currentFileKey = fileKey;
            currentHeaderRowIndex = 0; // é»˜è®¤ç¬¬1è¡Œæ˜¯è¡¨å¤´
            
            // é‡ç½®è¡¨å¤´è¡Œé€‰æ‹©
            document.querySelector('input[name="headerRow"][value="0"]').checked = true;
            
            // æ¸²æŸ“ç•Œé¢
            renderFieldMapping();
            
            document.getElementById('fieldMappingModal').classList.add('show');
        }
        
        // æ›´æ–°è¡¨å¤´è¡Œé€‰æ‹©
        function updateHeaderRow() {
            const selected = document.querySelector('input[name="headerRow"]:checked');
            currentHeaderRowIndex = parseInt(selected.value);
            renderFieldMapping();
        }
        
        // æ¸²æŸ“å­—æ®µæ˜ å°„ç•Œé¢
        function renderFieldMapping() {
            if (!rawSheetData) return;
            
            // æ ¹æ®é€‰æ‹©çš„è¡¨å¤´è¡Œæå–headerså’Œæ•°æ®
            const headers = rawSheetData[currentHeaderRowIndex] || [];
            const dataRows = rawSheetData.slice(currentHeaderRowIndex + 1);
            
            // æ¸²æŸ“æ•°æ®é¢„è§ˆ
            renderDataPreview(rawSheetData, currentHeaderRowIndex);
            
            // æ¸²æŸ“å­—æ®µæ˜ å°„è¡¨
            const fieldMappingBody = document.getElementById('fieldMappingBody');
            fieldMappingBody.innerHTML = '';
            
            // æ ¹æ®æ–‡ä»¶ç±»å‹å®šä¹‰å­—æ®µé…ç½®
            let fields = [];
            if (currentFileKey === 'main') {
                fields = [
                    { key: 'quantity', label: 'æ•°é‡', required: true, keywords: ['æ•°é‡', 'é”€å”®æ•°é‡'] },
                    { key: 'productName', label: 'ç‰©æ–™åç§°/å•†å“åç§°', required: true, keywords: ['ç‰©æ–™åç§°', 'å•†å“åç§°'] },
                    { key: 'model', label: 'å‹å·', required: false, keywords: ['å‹å·'] },
                    { key: 'department', label: 'éƒ¨é—¨', required: true, keywords: ['éƒ¨é—¨'] },
                    { key: 'originalCommission', label: 'å•å°ææˆï¼ˆåŸå§‹ï¼‰', required: false, keywords: ['å•å°ææˆ', 'å•ä½“ææˆ'] },
                    { key: 'originalBonus', label: 'åŠ æï¼ˆåŸå§‹ï¼‰', required: false, keywords: ['åŠ æ'] },
                    { key: 'originalTotal', label: 'ææˆå°è®¡ï¼ˆåŸå§‹ï¼‰', required: false, keywords: ['å°è®¡', 'åˆè®¡', 'ææˆå°è®¡'] }
                ];
            } else if (currentFileKey === 'bonus') {
                fields = [
                    { key: 'model', label: 'å‹å·', required: true, keywords: ['å‹å·'] },
                    { key: 'bonusAmount', label: 'å¯¼è´­åŠ æ', required: true, keywords: ['å¯¼è´­åŠ æ', 'åŠ æ'] }
                ];
            }
            
            fields.forEach(field => {
                const tr = document.createElement('tr');
                
                // æ™ºèƒ½åŒ¹é…ï¼šæ‰¾åˆ°åŒ…å«å…³é”®å­—çš„åˆ—
                let matchedIndex = -1;
                for (let i = 0; i < headers.length; i++) {
                    const header = (headers[i] || '').toString();
                    for (const keyword of field.keywords) {
                        if (header.includes(keyword)) {
                            matchedIndex = i;
                            break;
                        }
                    }
                    if (matchedIndex >= 0) break;
                }
                
                const labelHTML = field.required ? `${field.label} <span class="required">*</span>` : field.label;
                
                const selectHTML = `
                    <select id="field_${field.key}" data-required="${field.required}">
                        <option value="">-- è¯·é€‰æ‹© --</option>
                        ${headers.map((h, i) => `<option value="${i}" ${i === matchedIndex ? 'selected' : ''}>${h || '(ç©ºåˆ—)'}</option>`).join('')}
                    </select>
                `;
                
                tr.innerHTML = `<td>${labelHTML}</td><td>${selectHTML}</td>`;
                fieldMappingBody.appendChild(tr);
            });
        }
        
        // æ¸²æŸ“æ•°æ®é¢„è§ˆ
        function renderDataPreview(data, headerRowIndex) {
            const previewContent = document.getElementById('dataPreviewContent');
            
            // æ˜¾ç¤ºå‰3è¡Œï¼ˆåŒ…æ‹¬è¡¨å¤´ï¼‰
            const previewRows = data.slice(0, Math.min(headerRowIndex + 4, data.length));
            
            let html = '<table class="preview-table"><thead><tr>';
            
            // ç¬¬ä¸€è¡Œï¼ˆå¯èƒ½æ˜¯åˆå¹¶å•å…ƒæ ¼æˆ–è¡¨å¤´ï¼‰
            const maxCols = Math.max(...previewRows.map(row => row.length));
            for (let i = 0; i < maxCols; i++) {
                html += `<th>åˆ—${i + 1}</th>`;
            }
            html += '</tr></thead><tbody>';
            
            // æ•°æ®è¡Œ
            previewRows.forEach((row, rowIdx) => {
                const isHeaderRow = rowIdx === headerRowIndex;
                html += '<tr>';
                for (let i = 0; i < maxCols; i++) {
                    const cellValue = row[i] !== undefined ? row[i] : '';
                    const style = isHeaderRow ? 'background: #fff3cd; font-weight: bold;' : '';
                    html += `<td style="${style}">${cellValue}</td>`;
                }
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            previewContent.innerHTML = html;
        }

        function cancelFieldMapping() {
            document.getElementById('fieldMappingModal').classList.remove('show');
            rawSheetData = null;
            const key = currentFileKey;
            currentFileKey = null;
            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
            if (key) {
                document.getElementById('file_' + key).value = '';
            }
        }

        function confirmFieldMapping() {
            if (!rawSheetData || !currentFileKey) return;
            
            const fileKey = currentFileKey;
            
            // æ ¹æ®é€‰æ‹©çš„è¡¨å¤´è¡Œé‡æ–°ç»„ç»‡æ•°æ®
            const headers = rawSheetData[currentHeaderRowIndex] || [];
            const rows = rawSheetData.slice(currentHeaderRowIndex + 1);
            
            // æ ¹æ®æ–‡ä»¶ç±»å‹æ”¶é›†å­—æ®µæ˜ å°„
            const mapping = {};
            let fieldKeys = [];
            
            if (fileKey === 'main') {
                fieldKeys = ['quantity', 'productName', 'model', 'department', 'originalCommission', 'originalBonus', 'originalTotal'];
            } else if (fileKey === 'bonus') {
                fieldKeys = ['model', 'bonusAmount'];
            }
            
            let hasError = false;
            fieldKeys.forEach(field => {
                const select = document.getElementById('field_' + field);
                if (!select) return; // å­—æ®µä¸å­˜åœ¨ï¼Œè·³è¿‡
                
                const value = select.value;
                const isRequired = select.getAttribute('data-required') === 'true';
                
                if (isRequired && value === '') {
                    alert(`è¯·é€‰æ‹©å¿…éœ€å­—æ®µï¼š${select.closest('tr').querySelector('td').textContent}`);
                    hasError = true;
                    return;
                }
                
                mapping[field] = value === '' ? -1 : parseInt(value);
            });
            
            if (hasError) return;
            
            // ä¿å­˜æ•°æ®å’Œæ˜ å°„ï¼ˆä½¿ç”¨æ­£ç¡®çš„è¡¨å¤´è¡Œï¼‰
            const finalData = [headers].concat(rows);
            uploadedFiles[fileKey] = {
                data: finalData,
                headers: headers,
                rows: rows,
                fieldMapping: mapping,
                configured: true
            };
            headerCache[fileKey] = headers;
            
            const statusElement = document.getElementById('status_' + fileKey);
            const uploadElement = document.getElementById('upload_' + fileKey);
            statusElement.textContent = `âœ… å·²é…ç½® (${rows.length} è¡Œæ•°æ®)`;
            statusElement.className = 'status success';
            uploadElement.classList.add('uploaded');
            
            document.getElementById('fieldMappingModal').classList.remove('show');
            rawSheetData = null;
            currentFileKey = null;
            
            checkAllFilesUploaded();
        }

        function handleFileUpload(event, label, key) {
            const file = event.target.files[0];
            const statusElement = document.getElementById('status_' + key);
            const uploadElement = document.getElementById('upload_' + key);

            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const workbook = XLSX.read(e.target.result, {type: 'binary'});
                        
                        // å¯¹äºæ™®å†œæ˜ç»†è¡¨å’Œæ™®å†œåŠ æè¡¨ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†ï¼šsheeté€‰æ‹© + å­—æ®µæ˜ å°„
                        if (key === 'main' || key === 'bonus') {
                            const sheetNames = workbook.SheetNames;
                            if (sheetNames.length > 1) {
                                // å¤šä¸ªsheetï¼Œæ˜¾ç¤ºé€‰æ‹©ç•Œé¢
                                showSheetSelector(workbook, key);
                            } else {
                                // åªæœ‰ä¸€ä¸ªsheetï¼Œç›´æ¥è¿›å…¥å­—æ®µæ˜ å°„
                                const worksheet = workbook.Sheets[sheetNames[0]];
                                const data = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                                showFieldMapping(data, key);
                            }
                        } else {
                            // å…¶ä»–æ–‡ä»¶ä¿æŒåŸæœ‰é€»è¾‘
                            const firstSheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[firstSheetName];
                            const data = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                            uploadedFiles[key] = {
                                data: data,
                                headers: data[0] || [],
                                rows: data.slice(1)
                            };
                            headerCache[key] = data[0] || [];
                            statusElement.textContent = `âœ… å·²ä¸Šä¼  (${Math.max(0, data.length - 1)} è¡Œ)`;
                            statusElement.className = 'status success';
                            uploadElement.classList.add('uploaded');
                            console.log(label + ' è¡¨å¤´:', data[0]);
                            checkAllFilesUploaded();
                        }
                    } catch (error) {
                        statusElement.textContent = `âŒ æ–‡ä»¶è¯»å–å¤±è´¥: ${error.message}`;
                        statusElement.className = 'status error';
                    }
                };
                reader.readAsBinaryString(file);
            }
        }

        function checkAllFilesUploaded() {
            const required = ['policy','janit','roster','main','bonus'];
            const uploadedCount = required.filter(k => uploadedFiles[k]).length;
            
            // ç‰¹åˆ«æ£€æŸ¥ï¼šmainå’Œbonusæ–‡ä»¶å¿…é¡»å®Œæˆå­—æ®µæ˜ å°„é…ç½®
            const mainConfigured = uploadedFiles['main'] && uploadedFiles['main'].configured === true;
            const bonusConfigured = uploadedFiles['bonus'] && uploadedFiles['bonus'].configured === true;
            const allReady = uploadedCount === required.length && mainConfigured && bonusConfigured;
            
            document.getElementById('processBtn').disabled = !allReady;
            document.getElementById('toggleBtn').disabled = !allReady;
            if (allReady) {
                document.getElementById('toggleBtn').classList.remove('disabled');
            }
        }

        // å‹å·æå–ï¼šæ”¯æŒå•æ®µä¸å¤šæ®µï¼ˆå«è¿å­—ç¬¦ï¼‰çš„å‹å·ï¼Œä¿ç•™åŸå¤§å°å†™
        function extractModel(productName) {
            if (!productName) return '';
            const str = String(productName).trim();

            // å»é™¤å°¾éƒ¨è¯´æ˜æ€§æ–‡å­—ï¼ˆå¦‚ï¼šæ³¨æ„.../ä¸­é—´.../å¤‡æ³¨.../è¯´æ˜...ï¼‰
            // ä¸è¦æ±‚å‰é¢å¿…é¡»æœ‰ç©ºç™½ç¬¦ï¼Œä»¥å¤„ç†"WIæ³¨æ„"è¿™ç§ç´§è¿çš„æƒ…å†µ
            const cleaned = str
                .replace(/(?:æ³¨æ„|å¤‡æ³¨|è¯´æ˜|ä¸­é—´).*$/i, '')
                .trim();

            // æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„å‹å·ç‰‡æ®µï¼ˆå­—æ¯æ•°å­—ä¸è¿å­—ç¬¦çš„ç»„åˆï¼‰
            const allMatches = cleaned.match(/[A-Za-z0-9]+(?:-[A-Za-z0-9]+)*/g);
            
            if (allMatches && allMatches.length) {
                // 1) ä¼˜å…ˆé€‰æ‹©åŒæ—¶åŒ…å«å­—æ¯å’Œæ•°å­—çš„ç‰‡æ®µï¼ˆçœŸæ­£çš„å‹å·é€šå¸¸éƒ½æœ‰å­—æ¯+æ•°å­—ï¼‰
                const withDigits = allMatches.filter(m => /[A-Za-z]/.test(m) && /[0-9]/.test(m));
                if (withDigits.length) {
                    return withDigits[withDigits.length - 1]; // è¿”å›æœ€åä¸€ä¸ª
                }
                
                // 2) å¦‚æœæ²¡æœ‰åŒæ—¶åŒ…å«å­—æ¯å’Œæ•°å­—çš„ï¼Œè¿”å›æœ€åä¸€ä¸ªåŒ…å«å­—æ¯çš„
                const withLetters = allMatches.filter(m => /[A-Za-z]/.test(m));
                if (withLetters.length) {
                    return withLetters[withLetters.length - 1];
                }
                
                // 3) è¿”å›æœ€åä¸€ä¸ªåŒ¹é…
                return allMatches[allMatches.length - 1];
            }

            // æœ€åå…œåº•ï¼šå–æœ€åä¸€ä¸ªçŸ­æ¨ªçº¿åçš„æ®µ
            const parts = cleaned.split('-');
            return parts.length ? parts[parts.length - 1].trim() : cleaned;
        }

        // å‹å·é”®ç»Ÿä¸€ï¼šå¤§å°å†™è„±æ•ï¼ˆå…¨éƒ¨è½¬å¤§å†™åškeyï¼‰ï¼Œæ¯”è¾ƒæ—¶å¿½ç•¥å¤§å°å†™
        function keyOf(model) {
            return (model || '').toString().trim().toUpperCase();
        }

        // æ„å»ºæ˜ å°„ï¼šæ¸ é“æ”¿ç­–ï¼ˆå‹å· -> ææˆ æˆ– â€œä»¥æ¸ é“å¤‡æ¡ˆææˆä¸ºå‡†â€ï¼‰
        // çº¦å®šåˆ—ï¼šå‹å·åˆ—åå«â€œå‹å·â€ï¼Œææˆåˆ—åå«â€œææˆâ€
        function buildPolicyMap(policyData) {
            const map = new Map();
            const headers = policyData.headers || [];
            // åŠ¨æ€è¯†åˆ«åˆ—
            const idxModel = headers.findIndex(h => (h||'').toString().includes('å‹å·'));
            const idxCommission = headers.findIndex(h => (h||'').toString().includes('ææˆ'));
            policyData.rows.forEach((row, i) => {
                const model = row[idxModel];
                const commissionRaw = row[idxCommission];
                if (!model) return;
                const key = keyOf(model);
                const isText = typeof commissionRaw === 'string';
                const isJanit = isText && commissionRaw.includes('ä»¥æ¸ é“å¤‡æ¡ˆææˆä¸ºå‡†');
                const commissionValue = isJanit ? commissionRaw : parseFloat(commissionRaw) || 0;
                map.set(key, {
                    commission: commissionValue,
                    isJanit: !!isJanit,
                    sourceRow: i + 2
                });
            });
            return { map, idxModel, idxCommission };
        }

        // æ„å»ºæ˜ å°„ï¼šæ™®å†œåŠ æï¼ˆå‹å· -> å¯¼è´­åŠ æï¼‰
        // æ”¯æŒå­—æ®µæ˜ å°„é…ç½®æˆ–è‡ªåŠ¨è¯†åˆ«
        function buildBonusMap(bonusData) {
            const map = new Map();
            const headers = bonusData.headers || [];
            
            let idxModel, idxBonus;
            
            // ä¼˜å…ˆä½¿ç”¨å­—æ®µæ˜ å°„é…ç½®
            if (bonusData.fieldMapping && bonusData.configured) {
                idxModel = bonusData.fieldMapping.model;
                idxBonus = bonusData.fieldMapping.bonusAmount;
            } else {
                // å…¼å®¹æ—§ç‰ˆï¼šè‡ªåŠ¨è¯†åˆ«
                idxModel = headers.findIndex(h => (h||'').toString().includes('å‹å·'));
                idxBonus = headers.findIndex(h => (h||'').toString().includes('å¯¼è´­åŠ æ'));
                // å…¼å®¹ï¼šè‹¥æ²¡æ‰¾åˆ°ï¼Œå°è¯•"åŠ æ"
                if (idxBonus < 0) idxBonus = headers.findIndex(h => (h||'').toString().includes('åŠ æ'));
            }
            
            bonusData.rows.forEach((row, i) => {
                const model = row[idxModel];
                const bonus = idxBonus >= 0 ? row[idxBonus] : undefined;
                if (!model || bonus === undefined || bonus === '') return;
                map.set(keyOf(model), {
                    value: parseFloat(bonus) || 0,
                    sourceRow: i + 2,
                    sourceColumn: idxBonus + 1
                });
            });
            return { map, idxModel, idxBonus };
        }

        // æ„å»ºæ˜ å°„ï¼šä½³å°¼ç‰¹æ ‡å‡†ï¼ˆåº—é“º=æ™®å†œï¼Œå‹å· -> å¯¼è´­ææˆï¼‰
        // çº¦å®šåˆ—ï¼šåº—é“ºåˆ—åå«â€œåº—é“ºâ€æˆ–â€œé—¨åº—â€ï¼Œå‹å·åˆ—åå«â€œå‹å·â€ï¼Œå¯¼è´­ææˆåˆ—åå«â€œææˆâ€
        function buildJanitMap(janitData) {
            const map = new Map();
            const headers = janitData.headers || [];
            const idxShop = headers.findIndex(h => (h||'').toString().match(/åº—é“º|é—¨åº—/));
            const idxModel = headers.findIndex(h => (h||'').toString().includes('å‹å·'));
            const idxCommission = headers.findIndex(h => (h||'').toString().includes('ææˆ'));
            janitData.rows.forEach((row, i) => {
                const shop = row[idxShop];
                const model = row[idxModel];
                const commission = row[idxCommission];
                if ((shop === 'æ™®å†œ') && model && commission !== undefined) {
                    map.set(keyOf(model), {
                        value: parseFloat(commission) || 0,
                        sourceRow: i + 2
                    });
                }
            });
            return { map, idxShop, idxModel, idxCommission };
        }

        // æ„å»ºæ˜ å°„ï¼šæ¸ é“åå•ï¼ˆéƒ¨é—¨ -> é—¨åº—/å¯¼è´­äººå‘˜1/å¯¼è´­äººå‘˜2ï¼‰
        // çº¦å®šåˆ—ï¼šéƒ¨é—¨åˆ—åå«â€œéƒ¨é—¨â€ï¼Œé—¨åº—åˆ—åå«â€œé—¨åº—â€ï¼Œå¯¼è´­äººå‘˜åˆ—åå«â€œå¯¼è´­äººå‘˜â€
        function buildRosterMap(rosterData) {
            const map = new Map();
            const headers = rosterData.headers || [];
            const idxDept = headers.findIndex(h => (h||'').toString().includes('éƒ¨é—¨'));
            const idxStore = headers.findIndex(h => (h||'').toString().includes('é—¨åº—'));
            const idxGuide1 = headers.findIndex(h => (h||'').toString().includes('å¯¼è´­äººå‘˜') && (h||'').toString().includes('1'));
            const idxGuide2 = headers.findIndex(h => (h||'').toString().includes('å¯¼è´­äººå‘˜') && (h||'').toString().includes('2'));
            rosterData.rows.forEach((row, i) => {
                const dept = (row[idxDept] || '').toString().trim();
                if (!dept) return;
                map.set(dept, {
                    store: row[idxStore] || '',
                    guide1: row[idxGuide1] || '',
                    guide2: row[idxGuide2] || '',
                    sourceRow: i + 2
                });
            });
            return { map, idxDept, idxStore, idxGuide1, idxGuide2 };
        }

        function processData() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('processBtn').disabled = true;

            setTimeout(() => {
                try {
                    const mainData = uploadedFiles['main'];
                    const policyData = uploadedFiles['policy'];
                    const bonusData = uploadedFiles['bonus'];
                    const janitData = uploadedFiles['janit'];
                    const rosterData = uploadedFiles['roster'];

                    // æ„å»ºæ˜ å°„
                    const policy = buildPolicyMap(policyData);
                    const bonus = buildBonusMap(bonusData);
                    const janit = buildJanitMap(janitData);
                    const roster = buildRosterMap(rosterData);
                    debugMaps = { policy, bonus, janit, roster };

                    // å¤„ç†ä¸»æ•°æ®
                    const results = processMainData(mainData, policy, bonus, janit, roster);

                    processedData = results;
                    displayResults(results);
                    showDebugInfo();

                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('resultsSection').classList.remove('hidden');
                    document.getElementById('toggleBtn').disabled = false;
                } catch (error) {
                    alert('å¤„ç†æ•°æ®æ—¶å‡ºé”™: ' + error.message);
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('processBtn').disabled = false;
                }
            }, 100);
        }

        // ä¸»å¤„ç†é€»è¾‘
        function processMainData(mainData, policy, bonus, janit, roster) {
            const headers = mainData.headers || [];
            const rows = mainData.rows || [];

            // ä½¿ç”¨ç”¨æˆ·é…ç½®çš„å­—æ®µæ˜ å°„ï¼ˆä¼˜å…ˆï¼‰æˆ–è‡ªåŠ¨è¯†åˆ«ï¼ˆå…¼å®¹æ—§é€»è¾‘ï¼‰
            const mapping = mainData.fieldMapping || {};
            
            let idxQty, idxProduct, idxModelOriginal, idxDept, idxOrigCommission, idxOrigBonus, idxOrigTotal;
            
            if (mapping && Object.keys(mapping).length > 0) {
                // ä½¿ç”¨ç”¨æˆ·é…ç½®çš„æ˜ å°„
                idxQty = mapping.quantity;
                idxProduct = mapping.productName;
                idxModelOriginal = mapping.model;
                idxDept = mapping.department;
                idxOrigCommission = mapping.originalCommission;
                idxOrigBonus = mapping.originalBonus;
                idxOrigTotal = mapping.originalTotal;
            } else {
                // å…¼å®¹æ—§ç‰ˆæœ¬ï¼šè‡ªåŠ¨è¯†åˆ«ï¼ˆä½†ç°åœ¨mainæ–‡ä»¶å¿…é¡»é…ç½®ï¼Œè¿™æ®µä»£ç ä½œä¸ºåå¤‡ï¼‰
                idxQty = headers.findIndex(h => (h||'').toString().match(/æ•°é‡|é”€å”®æ•°é‡/));
                idxProduct = headers.findIndex(h => (h||'').toString().match(/ç‰©æ–™åç§°|å•†å“åç§°/));
                idxModelOriginal = headers.findIndex(h => (h||'').toString().match(/å‹å·/));
                idxDept = headers.findIndex(h => (h||'').toString().match(/éƒ¨é—¨/));
                idxOrigCommission = headers.findIndex(h => (h||'').toString().match(/å•å°ææˆ|å•ä½“ææˆ/));
                idxOrigBonus = headers.findIndex(h => (h||'').toString().match(/åŠ æ/));
                idxOrigTotal = headers.findIndex(h => (h||'').toString().match(/å°è®¡|åˆè®¡|ææˆå°è®¡/));
            }

            const results = [];
            rows.forEach((row, index) => {
                if (!row || row.length === 0) return;

                const dept = (row[idxDept] || '').toString().trim();

                const productName = row[idxProduct] || '';
                const originalModel = row[idxModelOriginal] || '';
                const extractedModel = originalModel ? String(originalModel) : extractModel(productName);
                const modelKey = keyOf(extractedModel);

                const quantity = parseFloat(row[idxQty]) || 0;

                // ç‰¹æ®Šå‹å·è§„åˆ™æ£€æŸ¥
                let newCommission = 0;
                let commissionExplanation = '';
                let matchSource = '';
                let newBonus = 0;
                let bonusExplanation = '';

                if (modelKey === 'PF25C1') {
                    // ç‰¹æ®Šè§„åˆ™ï¼šPF25C1 å›ºå®šææˆ30ï¼ŒåŠ æ0
                    newCommission = 30;
                    newBonus = 0;
                    commissionExplanation = `å‹å·"${extractedModel}"é‡‡ç”¨ç‰¹æ®Šè§„åˆ™ï¼Œå›ºå®šå•å°ææˆ=30`;
                    bonusExplanation = `å‹å·"${extractedModel}"é‡‡ç”¨ç‰¹æ®Šè§„åˆ™ï¼Œå›ºå®šåŠ æ=0`;
                    matchSource = 'ç‰¹æ®Šè§„åˆ™';
                } else {
                    // æ¸ é“æ”¿ç­–åŒ¹é…
                    const pol = policy.map.get(modelKey);
                    if (pol) {
                        if (pol.isJanit) {
                            // ä½³å°¼ç‰¹æ ‡å‡†ï¼ˆåº—é“º=æ™®å†œï¼‰
                            const jm = janit.map.get(modelKey);
                            if (jm) {
                                newCommission = jm.value;
                                commissionExplanation = `æ¸ é“æ”¿ç­–ç¬¬${pol.sourceRow}è¡Œæç¤º"ä»¥æ¸ é“å¤‡æ¡ˆææˆä¸ºå‡†"ï¼›è½¬è‡³ä½³å°¼ç‰¹æ ‡å‡†ï¼ˆæ™®å†œï¼‰ç¬¬${jm.sourceRow}è¡ŒåŒ¹é…å‹å·"${extractedModel}"ï¼Œå¯¼è´­ææˆ=${jm.value}`;
                                matchSource = 'ä½³å°¼ç‰¹æ ‡å‡†';
                            } else {
                                commissionExplanation = `æ¸ é“æ”¿ç­–ç¬¬${pol.sourceRow}è¡Œæç¤º"ä»¥æ¸ é“å¤‡æ¡ˆææˆä¸ºå‡†"ï¼Œä½†ä½³å°¼ç‰¹æ ‡å‡†ä¸­æœªæ‰¾åˆ°åº—é“º"æ™®å†œ"çš„å‹å·"${extractedModel}"`;
                                matchSource = 'æœªåŒ¹é…';
                            }
                        } else {
                            newCommission = parseFloat(pol.commission) || 0;
                            commissionExplanation = `æ¸ é“æ”¿ç­–ç¬¬${pol.sourceRow}è¡ŒåŒ¹é…å‹å·"${extractedModel}"ï¼Œå•å°ææˆ=${newCommission}`;
                            matchSource = 'æ¸ é“æ”¿ç­–';
                        }
                    } else {
                        commissionExplanation = `æ¸ é“æ”¿ç­–è¡¨ä¸­æœªæ‰¾åˆ°å‹å·"${extractedModel}"çš„è®°å½•`;
                        matchSource = 'æœªåŒ¹é…';
                    }

                    // åŠ æåŒ¹é…
                    const bm = bonus.map.get(modelKey);
                    if (bm) {
                        newBonus = bm.value;
                        bonusExplanation = `æ™®å†œåŠ æé‚®ä»¶å®¡æ‰¹ç¬¬${bm.sourceRow}è¡Œç¬¬${bm.sourceColumn}åˆ—åŒ¹é…å‹å·"${extractedModel}"ï¼Œå¯¼è´­åŠ æ=${newBonus}`;
                    } else {
                        bonusExplanation = `æ™®å†œåŠ æé‚®ä»¶å®¡æ‰¹ä¸­æœªæ‰¾åˆ°å‹å·"${extractedModel}"çš„å¯¼è´­åŠ æè®°å½•`;
                    }
                }

                // æ¸ é“åå•åŒ¹é…ï¼ˆéƒ¨é—¨ -> é—¨åº—/å¯¼è´­1/å¯¼è´­2ï¼‰
                let store = '', guide1 = '', guide2 = '';
                let rosterExplanation = '';
                if (dept) {
                    const rm = roster.map.get(dept);
                    if (rm) {
                        store = rm.store || '';
                        guide1 = rm.guide1 || '';
                        guide2 = rm.guide2 || '';
                        rosterExplanation = `æ¸ é“åå•ç¬¬${rm.sourceRow}è¡ŒæŒ‰éƒ¨é—¨â€œ${dept}â€åŒ¹é…ï¼šé—¨åº—="${store}"ï¼Œå¯¼è´­äººå‘˜1="${guide1}"ï¼Œå¯¼è´­äººå‘˜2="${guide2}"`;
                    } else {
                        rosterExplanation = `æ¸ é“åå•ä¸­æœªæ‰¾åˆ°éƒ¨é—¨â€œ${dept}â€çš„åŒ¹é…è®°å½•`;
                    }
                } else {
                    rosterExplanation = `ä¸»è¡¨éƒ¨é—¨ä¸ºç©ºï¼Œæ— æ³•åœ¨æ¸ é“åå•ä¸­åŒ¹é…é—¨åº—ä¸å¯¼è´­äººå‘˜`;
                }

                // ç‰¹æ®Šæƒ…å†µï¼šå¯¼è´­1å’Œ2éƒ½ä¸ºç©º => ä¸è®¡ç®—ææˆï¼Œç›¸å…³å­—æ®µä¿æŒç©º
                let newTotal = null;
                let totalExplanation = '';
                let commissionFinal = null;
                let bonusFinal = null;
                let skipByNoGuides = (!guide1 && !guide2);
                if (skipByNoGuides) {
                    commissionFinal = '';
                    bonusFinal = '';
                    newTotal = '';
                    totalExplanation = 'å¯¼è´­äººå‘˜1ä¸2å‡ä¸ºç©ºï¼Œæœ¬è¡Œä¸è®¡ç®—ææˆï¼Œç›¸å…³å­—æ®µç•™ç©º';
                } else {
                    commissionFinal = newCommission;
                    bonusFinal = newBonus;
                    newTotal = quantity * newCommission + newBonus * quantity;
                    totalExplanation = `å¤æ ¸ææˆ = é”€å”®æ•°é‡(${quantity}) Ã— å•å°ææˆ(${newCommission}) + åŠ æ(${newBonus}) Ã— é”€å”®æ•°é‡(${quantity}) = ${newTotal}`;
                }

                // åŸå§‹åˆ—ï¼ˆè‹¥å­˜åœ¨ï¼‰ä»…ç”¨äºå¯¹æ¯”æ˜¾ç¤º
                const originalCommission = (idxOrigCommission >= 0) ? (parseFloat(row[idxOrigCommission]) || 0) : null;
                const originalBonus = (idxOrigBonus >= 0) ? (parseFloat(row[idxOrigBonus]) || 0) : null;
                const originalTotal = (idxOrigTotal >= 0) ? (parseFloat(row[idxOrigTotal]) || 0) : null;

                // è¯´æ˜ï¼šå‹å·æå–
                const modelExplanation = originalModel
                    ? `ä½¿ç”¨ä¸»è¡¨åŸå‹å·â€œ${originalModel}â€`
                    : `ä»â€œ${productName}â€ä¸­æå–å‹å·â€œ${extractedModel}â€`;

                // å‰åå¯¹æ¯”ï¼šåŸå•ä½“/å•å°ææˆ vs æ ¸å¯¹å•å°ææˆï¼ˆä¸ä¸€è‡´æ—¶è¯´æ˜ï¼‰
                let diffExplanation = '';
                if (commissionFinal !== '' && originalCommission != null) {
                    const newC = parseFloat(commissionFinal);
                    const oldC = parseFloat(originalCommission);
                    if (newC !== oldC) {
                        diffExplanation = `åŸå•ä½“ææˆ=${oldC}ï¼Œæ ¸å¯¹å•å°ææˆ=${newC}ï¼Œä¸ä¸€è‡´`;
                    }
                }

                results.push({
                    rowIndex: index + 1,
                    originalData: row.slice(),
                    extractedModel,
                    newCommission: commissionFinal,
                    newBonus: bonusFinal,
                    newTotal,
                    commissionExplanation,
                    bonusExplanation,
                    totalExplanation,
                    rosterExplanation,
                    modelExplanation,
                    matchSource,
                    quantity,
                    originalCommission,
                    originalBonus,
                    originalTotal,
                    store,
                    guide1,
                    guide2,
                    diffExplanation,
                    department: dept  // ä¿å­˜éƒ¨é—¨ä¿¡æ¯ç”¨äºç­›é€‰
                });
            });

            return results;
        }

        function showDebugInfo() {
            const debugInfo = document.getElementById('debugInfo');

            const pH = headerCache['policy'] || [];
            const bH = headerCache['bonus'] || [];
            const jH = headerCache['janit'] || [];
            const rH = headerCache['roster'] || [];
            const mH = headerCache['main'] || [];

            const info = `
                <h4>ğŸ” æ•°æ®è¡¨ç»“æ„åˆ†æ</h4>
                <p><strong>æ™®å†œæ˜ç»†:</strong> è‡ªåŠ¨è¯†åˆ«åˆ— â†’ æ•°é‡/é”€å”®æ•°é‡, ç‰©æ–™åç§°/å•†å“åç§°, å‹å·, éƒ¨é—¨, å•å°ææˆ, åŠ æ, ææˆå°è®¡</p>
                <p><strong>æ¸ é“æ”¿ç­–è¡¨:</strong> è¯†åˆ«â€œå‹å·â€åˆ—ä¸â€œææˆâ€åˆ—ï¼›è‹¥ææˆ=â€œä»¥æ¸ é“å¤‡æ¡ˆææˆä¸ºå‡†â€ï¼Œè½¬æŸ¥ä½³å°¼ç‰¹ï¼ˆæ™®å†œï¼‰</p>
                <p><strong>æ™®å†œåŠ æé‚®ä»¶å®¡æ‰¹:</strong> è¯†åˆ«â€œå‹å·â€åˆ—ä¸â€œå¯¼è´­åŠ æâ€åˆ—</p>
                <p><strong>å„åº—ä½³å°¼ç‰¹æ ‡å‡†:</strong> åº—é“º=â€œæ™®å†œâ€ï¼Œè¯†åˆ«â€œå‹å·â€ä¸â€œææˆâ€</p>
                <p><strong>æ¸ é“åå•:</strong> è¯†åˆ«â€œéƒ¨é—¨â€â†’â€œé—¨åº—/å¯¼è´­äººå‘˜1/å¯¼è´­äººå‘˜2â€</p>
                <p><strong>è¡¨å¤´ç¤ºä¾‹:</strong></p>
                <ul>
                    <li>æ™®å†œæ˜ç»†: ${JSON.stringify(mH)}</li>
                    <li>æ¸ é“æ”¿ç­–: ${JSON.stringify(pH)}</li>
                    <li>æ™®å†œåŠ æ: ${JSON.stringify(bH)}</li>
                    <li>ä½³å°¼ç‰¹æ ‡å‡†: ${JSON.stringify(jH)}</li>
                    <li>æ¸ é“åå•: ${JSON.stringify(rH)}</li>
                </ul>
                <p><strong>æ˜ å°„è§„æ¨¡:</strong>
                  æ¸ é“æ”¿ç­– ${debugMaps.policy.map.size} æ¡ï¼›
                  åŠ æ ${debugMaps.bonus.map.size} æ¡ï¼›
                  ä½³å°¼ç‰¹ï¼ˆæ™®å†œï¼‰${debugMaps.janit.map.size} æ¡ï¼›
                  æ¸ é“åå• ${debugMaps.roster.map.size} æ¡
                </p>
            `;
            debugInfo.innerHTML = info;
        }

        function displayResults(results) {
            const headers = uploadedFiles['main'].headers;
            const tableHeader = document.getElementById('tableHeader');
            const tableBody = document.getElementById('tableBody');

            // éƒ¨é—¨ç­›é€‰ï¼šåªä¿ç•™æŒ‡å®šéƒ¨é—¨çš„è®°å½•
            const allowedDepartments = ['å¹¿åœºå¨å«æŸœç»„', 'æ±Ÿå±±å¨å«æŸœç»„1'];
            const filteredResults = results.filter(r => allowedDepartments.includes(r.department));

            // æ–°å¢å­—æ®µåˆ—
            const addedHeaders = [
                'å‹å·', 'å•å°ææˆ(æ ¸å¯¹)', 'åŠ æ(æ ¸å¯¹)', 'ææˆ(æ ¸å¯¹)', 'é—¨åº—', 'å¯¼è´­äººå‘˜ 1', 'å¯¼è´­äººå‘˜ 2',
                'å‹å·è¯´æ˜', 'ææˆè¯´æ˜', 'åŠ æè¯´æ˜', 'é—¨åº—/å¯¼è´­è¯´æ˜', 'è®¡ç®—è¯´æ˜', 'å‰åå¯¹æ¯”'
            ];

            let headerHTML = '<tr>';
            headers.forEach(h => { headerHTML += `<th>${h}</th>`; });
            addedHeaders.forEach(h => {
                const isExplain = ['å‹å·è¯´æ˜','ææˆè¯´æ˜','åŠ æè¯´æ˜','é—¨åº—/å¯¼è´­è¯´æ˜','è®¡ç®—è¯´æ˜','å‰åå¯¹æ¯”'].includes(h);
                headerHTML += `<th class="${isExplain ? 'explanation-column' : ''}">${h}</th>`;
            });
            headerHTML += '</tr>';
            tableHeader.innerHTML = headerHTML;

            let bodyHTML = '';
            let totalRows = filteredResults.length;
            let matchedRows = 0;
            let totalDifference = 0;

            filteredResults.forEach(r => {
                bodyHTML += '<tr>';

                // å¯¹é½åŸå§‹åˆ—é•¿åº¦
                for (let i = 0; i < headers.length; i++) {
                    bodyHTML += `<td>${r.originalData[i] ?? ''}</td>`;
                }

                // æ–°å¢åˆ—ï¼šå‹å·
                bodyHTML += `<td>${r.extractedModel || ''}</td>`;

                // æ–°å¢åˆ—ï¼šå•å°ææˆ(æ ¸å¯¹)
                let commissionClass = '';
                if (r.newCommission === '') {
                    commissionClass = ''; // è·³è¿‡è®¡ç®—çš„æƒ…å†µ
                } else if (r.originalCommission != null) {
                    commissionClass = (parseFloat(r.newCommission) === parseFloat(r.originalCommission)) ? 'success-cell' : 'error-cell';
                }
                bodyHTML += `<td class="${commissionClass}">${r.newCommission === '' ? '' : r.newCommission}</td>`;

                // æ–°å¢åˆ—ï¼šåŠ æ(æ ¸å¯¹)
                let bonusClass = '';
                if (r.newBonus === '') {
                    bonusClass = '';
                } else if (r.originalBonus != null) {
                    bonusClass = (parseFloat(r.newBonus) === parseFloat(r.originalBonus)) ? 'success-cell' : 'error-cell';
                }
                bodyHTML += `<td class="${bonusClass}">${r.newBonus === '' ? '' : r.newBonus}</td>`;

                // æ–°å¢åˆ—ï¼šææˆ(æ ¸å¯¹)
                let totalClass = '';
                if (r.newTotal === '') {
                    totalClass = '';
                    bodyHTML += `<td class="">${''}</td>`;
                } else {
                    const newTotalFixed = (parseFloat(r.newTotal || 0)).toFixed(2);
                    if (r.originalTotal != null) {
                        totalClass = (Math.abs(parseFloat(newTotalFixed) - parseFloat(r.originalTotal || 0)) <= 0.01) ? 'success-cell' : 'error-cell';
                        totalDifference += Math.abs(parseFloat(newTotalFixed) - parseFloat(r.originalTotal || 0));
                    }
                    bodyHTML += `<td class="${totalClass}">${newTotalFixed}</td>`;
                }

                // é—¨åº—/å¯¼è´­åˆ—
                bodyHTML += `<td>${r.store || ''}</td>`;
                bodyHTML += `<td>${r.guide1 || ''}</td>`;
                bodyHTML += `<td>${r.guide2 || ''}</td>`;

                // è¯´æ˜åˆ—
                bodyHTML += `<td class="explanation-column">${r.modelExplanation}</td>`;
                bodyHTML += `<td class="explanation-column">${r.commissionExplanation}</td>`;
                bodyHTML += `<td class="explanation-column">${r.bonusExplanation}</td>`;
                bodyHTML += `<td class="explanation-column">${r.rosterExplanation}</td>`;
                bodyHTML += `<td class="explanation-column">${r.totalExplanation}</td>`;
                bodyHTML += `<td class="explanation-column">${r.diffExplanation || ''}</td>`;

                bodyHTML += '</tr>';

                if (r.matchSource && r.matchSource !== 'æœªåŒ¹é…') matchedRows++;
            });

            tableBody.innerHTML = bodyHTML;

            // æ±‡æ€»
            const summary = document.getElementById('summary');
            const matchedRate = totalRows ? (matchedRows/totalRows*100).toFixed(1) : '0.0';
            summary.innerHTML = `
                <h3>ğŸ“ˆ å¤„ç†æ±‡æ€»</h3>
                <p><strong>åŸå§‹æ€»è¡Œæ•°:</strong> ${results.length}</p>
                <p><strong>ç­›é€‰åè¡Œæ•°:</strong> ${totalRows} (ä»…æ˜¾ç¤ºéƒ¨é—¨ä¸º"å¹¿åœºå¨å«æŸœç»„"æˆ–"æ±Ÿå±±å¨å«æŸœç»„1"çš„è®°å½•)</p>
                <p><strong>æˆåŠŸåŒ¹é…(æ”¿ç­–/ä½³å°¼ç‰¹):</strong> ${matchedRows} è¡Œ (${matchedRate}%)</p>
                <p><strong>ææˆå·®å¼‚æ€»é¢(ä¸åŸå°è®¡å¯¹æ¯”):</strong> ${totalDifference.toFixed(2)} å…ƒ</p>
                <p class="hint">æç¤ºï¼šå¦‚ä¸»è¡¨æ²¡æœ‰"åŸå•å°ææˆ/åŸåŠ æ/ææˆå°è®¡"åˆ—ï¼Œåˆ™ä¸æ˜¾ç¤ºå¯¹æ¯”ç€è‰²ã€‚</p>
            `;
        }

        function toggleExplanations() {
            showExplanations = !showExplanations;
            const explanationColumns = document.querySelectorAll('.explanation-column');
            explanationColumns.forEach(col => {
                col.style.display = showExplanations ? 'table-cell' : 'none';
            });
        }

        function exportToExcel() {
            if (!processedData) return;

            // éƒ¨é—¨ç­›é€‰ï¼šåªå¯¼å‡ºæŒ‡å®šéƒ¨é—¨çš„è®°å½•
            const allowedDepartments = ['å¹¿åœºå¨å«æŸœç»„', 'æ±Ÿå±±å¨å«æŸœç»„1'];
            const filteredData = processedData.filter(r => allowedDepartments.includes(r.department));

            const headers = uploadedFiles['main'].headers.concat([
                'å‹å·', 'å•å°ææˆ(æ ¸å¯¹)', 'åŠ æ(æ ¸å¯¹)', 'ææˆ(æ ¸å¯¹)', 'é—¨åº—', 'å¯¼è´­äººå‘˜ 1', 'å¯¼è´­äººå‘˜ 2',
                'å‹å·è¯´æ˜', 'ææˆè¯´æ˜', 'åŠ æè¯´æ˜', 'é—¨åº—/å¯¼è´­è¯´æ˜', 'è®¡ç®—è¯´æ˜', 'å‰åå¯¹æ¯”'
            ]);

            const exportData = [headers];

            filteredData.forEach(r => {
                const originalDataAligned = [];
                for (let i = 0; i < uploadedFiles['main'].headers.length; i++) {
                    originalDataAligned.push(r.originalData[i] || '');
                }
                const row = originalDataAligned.concat([
                    r.extractedModel || '',
                    r.newCommission === '' ? '' : r.newCommission,
                    r.newBonus === '' ? '' : r.newBonus,
                    r.newTotal === '' ? '' : r.newTotal,
                    r.store || '',
                    r.guide1 || '',
                    r.guide2 || '',
                    r.modelExplanation || '',
                    r.commissionExplanation || '',
                    r.bonusExplanation || '',
                    r.rosterExplanation || '',
                    r.totalExplanation || '',
                    r.diffExplanation || ''
                ]);
                exportData.push(row);
            });

            const ws = XLSX.utils.aoa_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "å¤„ç†ç»“æœ");

            const fileName = `ææˆæ•°æ®å¤„ç†ç»“æœ_${new Date().toISOString().slice(0,10)}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }
    </script>
</body>
</html>