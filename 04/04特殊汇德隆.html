<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±‡å¾·éš†ææˆè®¡ç®—å·¥å…· - A.O.å²å¯†æ–¯ä¸šåŠ¡å·¥å…·å¹³å°</title>
    
    <!-- ç»Ÿä¸€æ ·å¼æ–‡ä»¶ -->
    <link rel="stylesheet" href="../common-styles.css">
    
    <style>
        /* å·¥å…·ç‰¹å®šæ ·å¼ - æ±‡å¾·éš†ä¸“ç”¨ */
        .model-column {
            background: #e3f2fd;
        }

        .commission-column {
            background: #f3e5f5;
        }

        .explanation-column {
            background: #fff3e0;
            max-width: 200px;
            white-space: normal;
            word-wrap: break-word;
        }

        .kitchen-appliance {
            background: #ffebee;
        }

        .upload-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--space-lg);
            margin-bottom: var(--space-lg);
        }

        .upload-item {
            background: var(--bg-card);
            padding: var(--space-lg);
            border-radius: var(--radius-md);
            border: 2px dashed var(--border-medium);
            text-align: center;
            transition: all var(--transition-normal) var(--transition);
        }

        .upload-item:hover {
            border-color: var(--accent-gold);
            background: var(--accent-gold-light);
        }

        .upload-item input[type="file"] {
            display: none;
        }

        .upload-label {
            display: block;
            cursor: pointer;
            padding: var(--space-md);
            color: var(--text-secondary);
            font-weight: 500;
        }

        .upload-label:hover {
            color: var(--accent-blue);
        }

        .file-info {
            margin-top: var(--space-md);
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        .toggle-group {
            display: flex;
            gap: var(--space-md);
            align-items: center;
        }

        .toggle {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: var(--bg-card);
            margin: 5% auto;
            padding: var(--space-xl);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
            padding-bottom: var(--space-md);
            border-bottom: 2px solid var(--accent-blue);
        }

        .modal-header h2 {
            color: var(--accent-blue);
            margin: 0;
        }

        .close {
            color: var(--text-tertiary);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color var(--transition-normal);
        }

        .close:hover {
            color: var(--text-primary);
        }

        .mapping-section {
            margin-bottom: var(--space-lg);
        }

        .mapping-section h3 {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-bottom: var(--space-md);
        }

        .mapping-item {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: var(--space-md);
            align-items: center;
            margin-bottom: var(--space-md);
            padding: var(--space-md);
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
        }

        .mapping-item label {
            font-weight: 600;
            color: var(--text-secondary);
        }

        .mapping-item select {
            padding: var(--space-sm);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-sm);
            background: var(--bg-card);
            cursor: pointer;
        }

        .sheet-selector {
            margin-bottom: var(--space-lg);
        }

        .sheet-selector select {
            width: 100%;
            padding: var(--space-md);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
        }

        .header-row-selector {
            margin-bottom: var(--space-lg);
        }

        .header-row-selector label {
            display: block;
            margin-bottom: var(--space-sm);
            font-weight: 600;
        }

        .header-row-selector input {
            width: 100%;
            padding: var(--space-sm);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-sm);
        }

        .preview-section {
            margin-top: var(--space-lg);
            margin-bottom: var(--space-lg);
        }

        .preview-section h3 {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-bottom: var(--space-md);
        }

        .preview-table-container {
            max-height: 300px;
            overflow: auto;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            background: var(--bg-card);
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
        }

        .preview-table th,
        .preview-table td {
            padding: 6px 8px;
            border: 1px solid var(--border-light);
            white-space: nowrap;
            text-align: left;
        }

        .preview-table th {
            background: var(--bg-primary);
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .preview-table tr:hover {
            background: var(--bg-primary);
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .loading-content {
            background: var(--bg-card);
            padding: var(--space-2xl);
            border-radius: var(--radius-lg);
            text-align: center;
            box-shadow: var(--shadow-xl);
        }

        .preview-info {
            padding: var(--space-md);
            background: var(--color-info-light);
            border-left: 4px solid var(--color-info);
            margin-bottom: var(--space-md);
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="tool-container">
        <!-- å¤´éƒ¨ -->
        <header class="tool-header">
            <a href="../index.html" class="back-nav">â† è¿”å›é¦–é¡µ</a>
            <h1>ğŸª æ±‡å¾·éš†ææˆè®¡ç®—å·¥å…·</h1>
            <p class="tool-subtitle">è‡ªåŠ¨åŒ¹é…å‹å·ã€è®¡ç®—ææˆã€åŒ¹é…å¯¼è´­äººå‘˜ï¼Œæ”¯æŒä½³å°¼ç‰¹ç‰¹æ®Šè§„åˆ™å’Œå¨ç”µé‚®ä»¶å®¡æ‰¹</p>
            <div class="tool-badge">
                <span class="badge-dot"></span>
                <span>04 - ç‰¹æ®Šæ¸ é“å·¥å…·</span>
            </div>
        </header>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="tool-content">
            <!-- æ–‡ä»¶ä¸Šä¼ åŒºå— -->
            <section class="section">
            <div class="upload-group">
                <div class="upload-item">
                    <label for="detailFile" class="upload-label">
                        <strong>ğŸ“Š æ±‡å¾·éš†é”€å”®ä¸šç»©æ˜ç»†è¡¨</strong><br>
                        ç‚¹å‡»é€‰æ‹©Excelæ–‡ä»¶
                    </label>
                    <input type="file" id="detailFile" accept=".xlsx,.xls,.csv">
                    <div class="file-info" id="detailFileInfo">æœªé€‰æ‹©æ–‡ä»¶</div>
                </div>

                <div class="upload-item">
                    <label for="policyFile" class="upload-label">
                        <strong>ğŸ“‹ æ¸ é“æ”¿ç­–è¡¨</strong><br>
                        ç‚¹å‡»é€‰æ‹©Excelæ–‡ä»¶
                    </label>
                    <input type="file" id="policyFile" accept=".xlsx,.xls,.csv">
                    <div class="file-info" id="policyFileInfo">æœªé€‰æ‹©æ–‡ä»¶</div>
                </div>

                <div class="upload-item">
                    <label for="janitFile" class="upload-label">
                        <strong>ğŸª å„åº—ä½³å°¼ç‰¹æ ‡å‡†è¡¨</strong><br>
                        ç‚¹å‡»é€‰æ‹©Excelæ–‡ä»¶
                    </label>
                    <input type="file" id="janitFile" accept=".xlsx,.xls,.csv">
                    <div class="file-info" id="janitFileInfo">æœªé€‰æ‹©æ–‡ä»¶</div>
                </div>

                <div class="upload-item">
                    <label for="staffFile" class="upload-label">
                        <strong>ğŸ‘¥ é—¨åº—å¯¼è´­äººå‘˜è¡¨</strong><br>
                        ç‚¹å‡»é€‰æ‹©Excelæ–‡ä»¶
                    </label>
                    <input type="file" id="staffFile" accept=".xlsx,.xls,.csv">
                    <div class="file-info" id="staffFileInfo">æœªé€‰æ‹©æ–‡ä»¶</div>
                </div>
            </div>

            <div class="flex flex-wrap gap-md items-center mt-lg">
                <button class="btn btn-primary btn-lg" onclick="processData()">ğŸ”„ å¼€å§‹å¤„ç†</button>
                <button class="btn btn-success btn-lg" onclick="exportResults()" id="exportBtn" disabled>ğŸ“¥ å¯¼å‡ºç»“æœ</button>
                
                <div class="toggle-group">
                    <div class="toggle">
                        <input type="checkbox" id="showExplanation" checked onchange="toggleColumns()">
                        <label for="showExplanation">æ˜¾ç¤ºè¯´æ˜åˆ—</label>
                    </div>
                    <div class="toggle">
                        <input type="checkbox" id="showOriginal" onchange="toggleColumns()">
                        <label for="showOriginal">æ˜¾ç¤ºåŸå§‹ææˆ</label>
                    </div>
                </div>
            </div>
            </section>

            <!-- çŠ¶æ€å’Œç»“æœåŒºå— -->
            <div id="statusInfo"></div>
            <div id="summary" class="stats-grid hidden"></div>
            
            <div class="table-container">
                <div class="table-wrapper">
                    <table class="data-table" id="resultsTable">
                        <thead id="tableHeader"></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </main>

        <!-- é¡µè„š -->
        <footer class="tool-footer">
            <p class="footer-text">æ±‡å¾·éš†ææˆè®¡ç®—å·¥å…· | æ›´æ–°æ—¥æœŸ: 2025-11-04</p>
            <div class="footer-links">
                <a href="../index.html" class="footer-link">è¿”å›é¦–é¡µ</a>
                <a href="https://iiuzjzy3ccx.feishu.cn/wiki/PbWjwvsXmiJK38kcVdFcsnVNndd" class="footer-link">ä½¿ç”¨æ–‡æ¡£</a>
            </div>
        </footer>
    </div>

    <!-- å­—æ®µæ˜ å°„æ¨¡æ€æ¡† -->
    <div id="mappingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“‹ é”€å”®æ˜ç»†å­—æ®µæ˜ å°„</h2>
                <span class="close" onclick="closeMappingModal()">&times;</span>
            </div>

            <div class="sheet-selector">
                <label for="sheetSelect"><strong>é€‰æ‹©å·¥ä½œè¡¨ï¼š</strong></label>
                <select id="sheetSelect" onchange="updateSheetPreview()">
                    <option value="">-- è¯·é€‰æ‹©å·¥ä½œè¡¨ --</option>
                </select>
            </div>

            <div class="header-row-selector">
                <label for="headerRowInput"><strong>å­—æ®µæ‰€åœ¨è¡Œå·ï¼ˆå¦‚æœç¬¬ä¸€è¡Œæ˜¯æ ‡é¢˜ï¼Œå­—æ®µåœ¨ç¬¬äºŒè¡Œï¼Œè¯·è¾“å…¥2ï¼‰ï¼š</strong></label>
                <input type="number" id="headerRowInput" value="1" min="1" max="10">
                <button class="btn btn-secondary" onclick="updateHeaderRow()" style="margin-top: 10px;">åˆ·æ–°å­—æ®µ</button>
            </div>

            <div class="mapping-section">
                <h3>è¯·æ˜ å°„ä»¥ä¸‹å¿…éœ€å­—æ®µï¼š</h3>
                <div id="mappingFields"></div>
            </div>

            <div class="preview-section">
                <h3>æ•°æ®é¢„è§ˆï¼ˆå‰10è¡Œï¼‰ï¼š</h3>
                <div class="preview-info" id="previewInfo">
                    æ­£åœ¨åŠ è½½é¢„è§ˆ...
                </div>
                <div class="preview-table-container">
                    <table class="preview-table" id="previewTable">
                        <thead id="previewHeader"></thead>
                        <tbody id="previewBody"></tbody>
                    </table>
                </div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-success" onclick="confirmMapping()">âœ“ ç¡®è®¤æ˜ å°„</button>
                <button class="btn btn-secondary" onclick="closeMappingModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- åŠ è½½è¦†ç›–å±‚ -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div id="loadingText">æ­£åœ¨å¤„ç†æ•°æ®ï¼Œè¯·ç¨å€™...</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let detailData = [];
        let policyData = [];
        let janitData = [];
        let staffData = [];
        let processedData = [];
        
        // ä¸´æ—¶å­˜å‚¨å·¥ä½œç°¿å’Œæ˜ å°„é…ç½®
        let tempWorkbook = null;
        let currentFileType = null;
        let fieldMapping = {};
        
        // å¿…éœ€å­—æ®µå®šä¹‰
        const requiredFields = {
            'detail': [
                { key: 'å•†å“åç§°', label: 'å•†å“åç§°', description: 'ç”¨äºæå–å‹å·ï¼Œå•†å“åç§°ä¸ºç©ºçš„è®°å½•å°†è¢«è¿‡æ»¤' },
                { key: 'é”€å”®æ•°é‡', label: 'é”€å”®æ•°é‡', description: 'ç”¨äºè®¡ç®—æ€»ææˆ' },
                { key: 'éƒ¨é—¨', label: 'éƒ¨é—¨/é—¨åº—åç§°', description: 'ç”¨äºåŒ¹é…å¯¼è´­äººå‘˜ï¼ˆå¯é€‰ï¼‰', optional: true }
            ]
        };

        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        document.getElementById('detailFile').addEventListener('change', (e) => handleFileUpload(e, 'detail'));
        document.getElementById('policyFile').addEventListener('change', (e) => handleFileUpload(e, 'policy'));
        document.getElementById('janitFile').addEventListener('change', (e) => handleFileUpload(e, 'janit'));
        document.getElementById('staffFile').addEventListener('change', (e) => handleFileUpload(e, 'staff'));

        function handleFileUpload(event, type) {
            const file = event.target.files[0];
            const infoElement = document.getElementById(type + 'FileInfo');
            
            if (file) {
                infoElement.textContent = `å·²é€‰æ‹©: ${file.name} (${(file.size/1024).toFixed(1)}KB)`;
                
                // å¯¹äºé”€å”®æ˜ç»†æ–‡ä»¶ï¼Œæ˜¾ç¤ºæ˜ å°„æ¨¡æ€æ¡†
                if (type === 'detail') {
                    currentFileType = type;
                    readExcelFileForMapping(file);
                } else {
                    readExcelFile(file, type);
                }
            } else {
                infoElement.textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
            }
        }

        // è¯»å–Excelæ–‡ä»¶ç”¨äºå­—æ®µæ˜ å°„
        function readExcelFileForMapping(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    tempWorkbook = XLSX.read(data, {type: 'array'});
                    
                    // å¡«å……å·¥ä½œè¡¨é€‰æ‹©å™¨
                    const sheetSelect = document.getElementById('sheetSelect');
                    sheetSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©å·¥ä½œè¡¨ --</option>';
                    tempWorkbook.SheetNames.forEach((name, index) => {
                        const option = document.createElement('option');
                        option.value = index;
                        option.textContent = name;
                        sheetSelect.appendChild(option);
                    });
                    
                    // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
                    if (tempWorkbook.SheetNames.length > 0) {
                        sheetSelect.value = 0;
                        updateSheetPreview();
                    }
                    
                    // æ˜¾ç¤ºæ˜ å°„æ¨¡æ€æ¡†
                    document.getElementById('mappingModal').style.display = 'block';
                } catch (error) {
                    showStatus(`æ–‡ä»¶è¯»å–å¤±è´¥: ${error.message}`, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // æ›´æ–°å·¥ä½œè¡¨é¢„è§ˆå’Œå­—æ®µ
        function updateSheetPreview() {
            updateHeaderRow();
        }

        // æ›´æ–°å­—æ®µè¡Œ
        function updateHeaderRow() {
            const sheetIndex = parseInt(document.getElementById('sheetSelect').value);
            const headerRowNum = parseInt(document.getElementById('headerRowInput').value) || 1;
            
            if (isNaN(sheetIndex) || !tempWorkbook) return;
            
            const worksheet = tempWorkbook.Sheets[tempWorkbook.SheetNames[sheetIndex]];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1, defval: ''});
            
            // è·å–å­—æ®µè¡Œï¼ˆç´¢å¼•ä»0å¼€å§‹ï¼Œæ‰€ä»¥è¦å‡1ï¼‰
            const headerRow = jsonData[headerRowNum - 1] || [];
            const availableFields = headerRow.filter(h => h && h.toString().trim() !== '');
            
            // ç”Ÿæˆæ˜ å°„å­—æ®µUI
            const mappingFieldsDiv = document.getElementById('mappingFields');
            const fields = requiredFields[currentFileType] || [];
            
            let html = '';
            fields.forEach(field => {
                html += `
                    <div class="mapping-item">
                        <label>${field.label}${field.optional ? 'ï¼ˆå¯é€‰ï¼‰' : ''}:</label>
                        <span>â†’</span>
                        <select id="mapping_${field.key}" data-field="${field.key}">
                            <option value="">-- ä¸æ˜ å°„ --</option>
                            ${availableFields.map(f => {
                                const selected = (f === field.key || f.includes(field.label.split('/')[0])) ? 'selected' : '';
                                return `<option value="${f}" ${selected}>${f}</option>`;
                            }).join('')}
                        </select>
                    </div>
                    ${field.description ? `<div style="font-size: 12px; color: #6c757d; margin-top: -8px; margin-bottom: 10px; padding-left: 10px;">è¯´æ˜ï¼š${field.description}</div>` : ''}
                `;
            });
            
            mappingFieldsDiv.innerHTML = html;
            
            // æ›´æ–°é¢„è§ˆ
            updatePreview(jsonData, headerRow, headerRowNum);
        }

        // æ›´æ–°æ•°æ®é¢„è§ˆ
        function updatePreview(jsonData, headerRow, headerRowNum) {
            const previewHeader = document.getElementById('previewHeader');
            const previewBody = document.getElementById('previewBody');
            const previewInfo = document.getElementById('previewInfo');
            
            // è¿‡æ»¤å‡ºæœ‰æ•ˆæ•°æ®è¡Œï¼ˆè‡³å°‘æœ‰ä¸€ä¸ªéç©ºå•å…ƒæ ¼ï¼‰
            const dataRows = jsonData.slice(headerRowNum).filter(row => 
                row && row.some(cell => cell !== undefined && cell !== null && cell !== '' && cell.toString().trim() !== '')
            );
            
            const totalRows = dataRows.length;
            const previewRows = dataRows.slice(0, 10); // åªæ˜¾ç¤ºå‰10è¡Œ
            
            // æ›´æ–°ä¿¡æ¯
            previewInfo.innerHTML = `
                ğŸ“Š æ€»æ•°æ®è¡Œæ•°ï¼š<strong>${totalRows}</strong> è¡Œï¼ˆå·²è‡ªåŠ¨è¿‡æ»¤ç©ºç™½è¡Œï¼‰<br>
                ğŸ‘€ å½“å‰æ˜¾ç¤ºå‰ <strong>${Math.min(10, totalRows)}</strong> è¡Œé¢„è§ˆ
            `;
            
            // ç”Ÿæˆè¡¨å¤´
            let headerHTML = '<tr>';
            headerRow.forEach(header => {
                if (header && header.toString().trim() !== '') {
                    headerHTML += `<th>${header}</th>`;
                }
            });
            headerHTML += '</tr>';
            previewHeader.innerHTML = headerHTML;
            
            // ç”Ÿæˆé¢„è§ˆæ•°æ®
            let bodyHTML = '';
            previewRows.forEach(row => {
                bodyHTML += '<tr>';
                headerRow.forEach((header, index) => {
                    if (header && header.toString().trim() !== '') {
                        const cellValue = row[index] !== undefined && row[index] !== null ? row[index] : '';
                        bodyHTML += `<td>${cellValue}</td>`;
                    }
                });
                bodyHTML += '</tr>';
            });
            previewBody.innerHTML = bodyHTML;
        }

        // ç¡®è®¤æ˜ å°„
        function confirmMapping() {
            const sheetIndex = parseInt(document.getElementById('sheetSelect').value);
            const headerRowNum = parseInt(document.getElementById('headerRowInput').value) || 1;
            
            if (isNaN(sheetIndex)) {
                showStatus('è¯·é€‰æ‹©å·¥ä½œè¡¨', 'error');
                return;
            }
            
            // è·å–æ˜ å°„é…ç½®
            fieldMapping = {};
            const fields = requiredFields[currentFileType] || [];
            let hasRequiredFields = true;
            
            fields.forEach(field => {
                const select = document.getElementById(`mapping_${field.key}`);
                if (select && select.value) {
                    fieldMapping[field.key] = select.value;
                } else if (!field.optional) {
                    hasRequiredFields = false;
                }
            });
            
            if (!hasRequiredFields) {
                showStatus('è¯·æ˜ å°„æ‰€æœ‰å¿…éœ€å­—æ®µ', 'error');
                return;
            }
            
            showLoading('æ­£åœ¨åŠ è½½æ•°æ®...');
            
            // ä½¿ç”¨setTimeoutè®©åŠ è½½åŠ¨ç”»æœ‰æ—¶é—´æ˜¾ç¤º
            setTimeout(() => {
                try {
                    // è¯»å–æ•°æ®
                    const worksheet = tempWorkbook.Sheets[tempWorkbook.SheetNames[sheetIndex]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1, defval: ''});
                    
                    // è·å–å­—æ®µè¡Œå’Œæ•°æ®è¡Œï¼Œä¸¥æ ¼è¿‡æ»¤ç©ºç™½è¡Œ
                    const sourceHeaders = jsonData[headerRowNum - 1] || [];
                    const dataRows = jsonData.slice(headerRowNum).filter(row => {
                        // ç¡®ä¿è¡Œå­˜åœ¨ä¸”è‡³å°‘æœ‰ä¸€ä¸ªæœ‰æ•ˆå•å…ƒæ ¼
                        if (!row || !Array.isArray(row)) return false;
                        return row.some(cell => {
                            if (cell === undefined || cell === null || cell === '') return false;
                            const cellStr = cell.toString().trim();
                            return cellStr !== '';
                        });
                    });
                    
                    console.log(`åŸå§‹æ•°æ®è¡Œæ•°: ${jsonData.length - headerRowNum}, è¿‡æ»¤å: ${dataRows.length}`);
                    
                    // è½¬æ¢ä¸ºæ˜ å°„åçš„å¯¹è±¡æ•°ç»„
                    const objectData = dataRows.map(row => {
                        const obj = {};
                        
                        // åº”ç”¨å­—æ®µæ˜ å°„
                        Object.keys(fieldMapping).forEach(targetField => {
                            const sourceField = fieldMapping[targetField];
                            const sourceIndex = sourceHeaders.indexOf(sourceField);
                            if (sourceIndex >= 0) {
                                const value = row[sourceIndex];
                                obj[targetField] = (value !== undefined && value !== null) ? value : '';
                            }
                        });
                        
                        // ä¿ç•™æ‰€æœ‰åŸå§‹å­—æ®µ
                        sourceHeaders.forEach((header, index) => {
                            if (header && header.toString().trim() !== '') {
                                const value = row[index];
                                obj[header] = (value !== undefined && value !== null) ? value : '';
                            }
                        });
                        
                        return obj;
                    });
                    
                    // è¿‡æ»¤æ‰å•†å“åç§°ä¸ºç©ºçš„è®°å½•ï¼ˆåªæ£€æŸ¥"å•†å“åç§°"å­—æ®µï¼‰
                    const beforeFilter = objectData.length;
                    const filteredData = objectData.filter(row => {
                        const productName = String(row['å•†å“åç§°'] || '').trim();
                        return productName !== '';
                    });
                    const filteredOutCount = beforeFilter - filteredData.length;
                    
                    console.log(`åŠ è½½æ—¶è¿‡æ»¤: åŸå§‹${beforeFilter}æ¡, è¿‡æ»¤å${filteredData.length}æ¡, å·²è¿‡æ»¤å•†å“åç§°ä¸ºç©ºçš„${filteredOutCount}æ¡`);
                    
                    // å­˜å‚¨æ•°æ®
                    detailData = filteredData;
                    
                    // å…³é—­æ¨¡æ€æ¡†
                    closeMappingModal();
                    hideLoading();
                    
                    let statusMsg = `é”€å”®æ˜ç»†è¡¨åŠ è½½æˆåŠŸï¼Œå…±${filteredData.length}æ¡æœ‰æ•ˆè®°å½•`;
                    if (filteredOutCount > 0) {
                        statusMsg += `ï¼ˆå·²è‡ªåŠ¨è¿‡æ»¤${filteredOutCount}æ¡å•†å“åç§°ä¸ºç©ºçš„è®°å½•ï¼‰`;
                    }
                    showStatus(statusMsg, 'success');
                } catch (error) {
                    hideLoading();
                    showStatus(`æ•°æ®åŠ è½½å¤±è´¥: ${error.message}`, 'error');
                    console.error('æ•°æ®åŠ è½½é”™è¯¯:', error);
                }
            }, 100);
        }

        // å…³é—­æ˜ å°„æ¨¡æ€æ¡†
        function closeMappingModal() {
            document.getElementById('mappingModal').style.display = 'none';
            tempWorkbook = null;
        }

        function readExcelFile(file, type) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1, defval: ''});
                    
                    // è½¬æ¢ä¸ºå¯¹è±¡æ•°ç»„ï¼Œä¸¥æ ¼è¿‡æ»¤ç©ºç™½è¡Œ
                    const headers = jsonData[0];
                    const rows = jsonData.slice(1).filter(row => {
                        // ç¡®ä¿è¡Œå­˜åœ¨ä¸”è‡³å°‘æœ‰ä¸€ä¸ªæœ‰æ•ˆå•å…ƒæ ¼
                        if (!row || !Array.isArray(row)) return false;
                        return row.some(cell => {
                            if (cell === undefined || cell === null || cell === '') return false;
                            const cellStr = cell.toString().trim();
                            return cellStr !== '';
                        });
                    });
                    
                    const objectData = rows.map(row => {
                        const obj = {};
                        headers.forEach((header, index) => {
                            if (header && header.toString().trim() !== '') {
                                const value = row[index];
                                obj[header] = (value !== undefined && value !== null) ? value : '';
                            }
                        });
                        return obj;
                    });

                    switch(type) {
                        case 'detail':
                            detailData = objectData;
                            break;
                        case 'policy':
                            policyData = objectData;
                            break;
                        case 'janit':
                            janitData = objectData;
                            break;
                        case 'staff':
                            staffData = objectData;
                            break;
                    }

                    const typeName = type === 'detail' ? 'é”€å”®æ˜ç»†' : 
                                    type === 'policy' ? 'æ¸ é“æ”¿ç­–' : 
                                    type === 'janit' ? 'ä½³å°¼ç‰¹æ ‡å‡†' : 
                                    type === 'staff' ? 'é—¨åº—å¯¼è´­äººå‘˜' : 'æœªçŸ¥';
                    showStatus(`${typeName}è¡¨åŠ è½½æˆåŠŸï¼Œå…±${objectData.length}æ¡æœ‰æ•ˆè®°å½•`, 'success');
                } catch (error) {
                    showStatus(`æ–‡ä»¶è¯»å–å¤±è´¥: ${error.message}`, 'error');
                    console.error(`${type} æ–‡ä»¶è¯»å–é”™è¯¯:`, error);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // æå–å‹å·çš„å‡½æ•°
        function extractModel(productName) {
            if (!productName) return '';

            // ç»Ÿä¸€æ¸…æ´—ï¼šå»æ‰å“ç‰Œ/å“ç±»ç­‰ä¸­æ–‡è¯æ±‡ï¼Œä¿ç•™å­—æ¯/æ•°å­—/è¿æ¥ç¬¦
            let cleaned = String(productName)
                // å“ç‰Œ
                .replace(/A\.?\s*O\.?\s*å²å¯†æ–¯|A\.Oå²å¯†æ–¯|å²å¯†æ–¯/gi, ' ')
                // å¸¸è§å“ç±»è¯
                .replace(/å‡€æ°´æœº|ç”µçƒ­æ°´å™¨|ç”µçƒ­|ç‡ƒçƒ­|æ²¹çƒŸæœº|ç‡ƒæ°”ç¶|ç¶å…·|æ´—ç¢—æœº|è’¸çƒ¤ä¸€ä½“æœº|ç©ºæ°”èƒ½çƒ­æ°´å™¨|ç©ºå‡€|å¤©ç„¶æ°”å¼ºæ’çƒ­æ°´å™¨|ä½³å°¼ç‰¹ç”µçƒ­æ°´å™¨/gi, ' ')
                // æ‹¬å·ã€ä¸­æ–‡æ ‡ç‚¹ç­‰
                .replace(/[ï¼ˆï¼‰()\[\]ã€ã€‘ã€ï¼Œï¼›ï¼š]/g, ' ');

            // éæ³•å­—ç¬¦æ›¿æ¢ä¸ºç©ºæ ¼ï¼Œä»…ä¿ç•™å­—æ¯æ•°å­—ä¸ - _ . ä¸‰ç§è¿æ¥ç¬¦
            cleaned = cleaned.replace(/[^A-Za-z0-9\-_.]/g, ' ');

            // æå–æ‰€æœ‰å€™é€‰ï¼šè‡³å°‘1ä¸ªå­—æ¯å¼€å¤´ï¼ŒåŒ…å«å­—æ¯æ•°å­—ï¼Œå…è®¸é€šè¿‡ - _ . è¿æ¥
            const candidates = cleaned.match(/[A-Za-z][A-Za-z0-9]*(?:[\-_.][A-Za-z0-9]+)*/g);
            if (!candidates) return '';

            // ä¼˜å…ˆåŒ…å«æ•°å­—çš„ï¼Œå¹¶é€‰æ‹©å»é™¤è¿æ¥ç¬¦åçš„æœ€é•¿è€…ï¼ˆé¿å…åªå–åˆ° J1ã€HC1 è¿™ç±»åç¼€ï¼‰
            let filtered = candidates.filter(s => /\d/.test(s));
            if (filtered.length === 0) filtered = candidates;

            const best = filtered.reduce((prev, curr) => {
                const p = prev.replace(/[\-_.]/g, '');
                const c = curr.replace(/[\-_.]/g, '');
                return c.length > p.length ? curr : prev;
            });

            // ä¿ç•™åŸå§‹å¤§å°å†™ï¼Œç»Ÿä¸€ä¸‹åˆ’çº¿ä¸ºè¿å­—ç¬¦
            return best.replace(/_/g, '-');
        }

        // åˆ¤æ–­æ˜¯å¦ä¸ºå¨ç”µ
        function isKitchenAppliance(productName) {
            if (!productName) return false;
            // ç¡®ä¿è½¬æ¢ä¸ºå­—ç¬¦ä¸²
            const productStr = String(productName);
            const kitchenKeywords = ['æ²¹çƒŸæœº', 'ç¶å…·', 'æ´—ç¢—æœº', 'è’¸çƒ¤ä¸€ä½“æœº', 'ç‡ƒæ°”ç¶', 'CXW', 'JZT', 'DWQ', 'KZQ'];
            return kitchenKeywords.some(keyword => productStr.includes(keyword));
        }

        // æ¨¡ç³ŠåŒ¹é…å‹å·ï¼ˆå¤§å°å†™ä¸æ•æ„Ÿï¼‰
        function findModelMatch(targetModel, dataArray, modelField) {
            if (!targetModel) return null;
            
            const targetStr = String(targetModel).trim();
            if (!targetStr) return null;
            
            // ç²¾ç¡®åŒ¹é…
            let match = dataArray.find(item => {
                if (!item[modelField]) return false;
                const itemModel = String(item[modelField]).trim();
                return itemModel.toUpperCase() === targetStr.toUpperCase();
            });
            
            if (match) return match;
            
            // æ¨¡ç³ŠåŒ¹é…ï¼ˆå»é™¤ç‰¹æ®Šå­—ç¬¦ï¼‰
            const cleanTarget = targetStr.replace(/[-_]/g, '').toUpperCase();
            match = dataArray.find(item => {
                if (!item[modelField]) return false;
                const itemModel = String(item[modelField]).trim();
                const cleanModel = itemModel.replace(/[-_]/g, '').toUpperCase();
                return cleanModel === cleanTarget;
            });
            
            return match;
        }

        // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
        function showLoading(message = 'æ­£åœ¨å¤„ç†æ•°æ®ï¼Œè¯·ç¨å€™...') {
            const overlay = document.getElementById('loadingOverlay');
            const text = document.getElementById('loadingText');
            text.textContent = message;
            overlay.style.display = 'flex';
        }

        // éšè—åŠ è½½åŠ¨ç”»
        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = 'none';
        }

        // å¤„ç†æ•°æ®çš„ä¸»å‡½æ•°
        function processData() {
            if (!detailData.length || !policyData.length) {
                showStatus('è¯·å…ˆä¸Šä¼ é”€å”®æ˜ç»†è¡¨å’Œæ¸ é“æ”¿ç­–è¡¨', 'error');
                return;
            }

            showLoading(`æ­£åœ¨å¤„ç† ${detailData.length} æ¡æ•°æ®ï¼Œè¯·ç¨å€™...`);
            
            // ä½¿ç”¨setTimeoutè®©UIæœ‰æ—¶é—´æ›´æ–°
            setTimeout(() => {
                try {
                    processedData = detailData.map((row, index) => {
                const result = {...row};
                
                // åŒ¹é…å¯¼è´­äººå‘˜ï¼ˆå¦‚æœæœ‰é—¨åº—å¯¼è´­äººå‘˜è¡¨ï¼‰
                const storeName = String(row['éƒ¨é—¨'] || row['é—¨åº—'] || row['é—¨åº—åç§°'] || row['åº—é“º'] || row['é”€å”®è®¢å•ä¸­é—¨åº—åç§°'] || '').trim();
                if (staffData.length > 0 && storeName) {
                    const staffMatch = staffData.find(item => {
                        // å°è¯•å¤šä¸ªå­—æ®µè¿›è¡ŒåŒ¹é…
                        const dept = String(item['éƒ¨é—¨'] || '').trim();
                        const store = String(item['é—¨åº—'] || item['é—¨åº—åç§°'] || item['åº—é“º'] || '').trim();
                        const orderStore = String(item['é”€å”®è®¢å•ä¸­é—¨åº—åç§°'] || '').trim();
                        
                        return dept === storeName || store === storeName || orderStore === storeName;
                    });
                    
                    if (staffMatch) {
                        // æ”¯æŒå¸¦ç©ºæ ¼å’Œä¸å¸¦ç©ºæ ¼çš„åˆ—å
                        result['å¯¼è´­äººå‘˜1'] = staffMatch['å¯¼è´­äººå‘˜ 1'] || staffMatch['å¯¼è´­äººå‘˜1'] || staffMatch['å¯¼è´­1'] || '';
                        result['å¯¼è´­äººå‘˜2'] = staffMatch['å¯¼è´­äººå‘˜ 2'] || staffMatch['å¯¼è´­äººå‘˜2'] || staffMatch['å¯¼è´­2'] || '';
                    } else {
                        result['å¯¼è´­äººå‘˜1'] = '';
                        result['å¯¼è´­äººå‘˜2'] = '';
                    }
                } else {
                    result['å¯¼è´­äººå‘˜1'] = '';
                    result['å¯¼è´­äººå‘˜2'] = '';
                }
                
                // æå–å‹å·ï¼ˆåªä»"å•†å“åç§°"å­—æ®µè·å–ï¼‰
                const productName = row['å•†å“åç§°'] || '';
                const productStr = String(productName);
                result['å‹å·'] = extractModel(productStr);
                result['å‹å·æå–è¯´æ˜'] = `ä»"${productStr}"ä¸­æå–å‹å·${result['å‹å·']}`;
                
                // åˆ¤æ–­æ˜¯å¦ä¸ºå¨ç”µ
                const isKitchen = isKitchenAppliance(productStr);
                result['æ˜¯å¦å¨ç”µ'] = isKitchen ? 'æ˜¯' : 'å¦';
                
                if (isKitchen) {
                    result['å•å°ææˆï¼ˆæ ¸å¯¹ï¼‰'] = 'éœ€é‚®ä»¶å®¡æ‰¹';
                    result['ææˆï¼ˆæ ¸å¯¹ï¼‰'] = 'éœ€é‚®ä»¶å®¡æ‰¹';
                    result['åŒ¹é…è¯´æ˜'] = 'æ±‡å¾·éš†å¨ç”µéœ€é‚®ä»¶å®¡æ‰¹';
                    return result;
                }
                
                // åœ¨æ”¿ç­–è¡¨ä¸­æŸ¥æ‰¾åŒ¹é…
                const policyMatch = findModelMatch(result['å‹å·'], policyData, 'å‹å·');
                
                if (policyMatch) {
                    const commission = policyMatch['ææˆ'];
                    
                    if (commission === 'ä»¥æ¸ é“å¤‡æ¡ˆææˆä¸ºå‡†') {
                        // æŸ¥æ‰¾ä½³å°¼ç‰¹æ ‡å‡†
                        if (janitData.length > 0) {
                            const resultModel = String(result['å‹å·'] || '').trim().toUpperCase();
                            const janitMatch = janitData.find(item => {
                                const shop = String(item['åº—é“º'] || '').trim();
                                const model = String(item['å‹å·'] || '').trim().toUpperCase();
                                return shop === 'æ±‡å¾·éš†' && model && model === resultModel;
                            });
                            
                            if (janitMatch) {
                                result['å•å°ææˆï¼ˆæ ¸å¯¹ï¼‰'] = parseFloat(janitMatch['å¯¼è´­ææˆ']) || 0;
                                result['åŒ¹é…è¯´æ˜'] = `ä½³å°¼ç‰¹ç‰¹æ®Šè§„åˆ™ï¼Œä»ä½³å°¼ç‰¹æ ‡å‡†è¡¨åŒ¹é…åˆ°ææˆ${janitMatch['å¯¼è´­ææˆ']}`;
                            } else {
                                result['å•å°ææˆï¼ˆæ ¸å¯¹ï¼‰'] = 0;
                                result['åŒ¹é…è¯´æ˜'] = 'ä½³å°¼ç‰¹ç‰¹æ®Šè§„åˆ™ï¼Œä½†åœ¨ä½³å°¼ç‰¹æ ‡å‡†è¡¨ä¸­æœªæ‰¾åˆ°åŒ¹é…';
                            }
                        } else {
                            result['å•å°ææˆï¼ˆæ ¸å¯¹ï¼‰'] = 0;
                            result['åŒ¹é…è¯´æ˜'] = 'ä½³å°¼ç‰¹ç‰¹æ®Šè§„åˆ™ï¼Œä½†æœªä¸Šä¼ ä½³å°¼ç‰¹æ ‡å‡†è¡¨';
                        }
                    } else {
                        result['å•å°ææˆï¼ˆæ ¸å¯¹ï¼‰'] = parseFloat(commission) || 0;
                        result['åŒ¹é…è¯´æ˜'] = `ä»æ¸ é“æ”¿ç­–è¡¨åŒ¹é…åˆ°ææˆ${commission}`;
                    }
                } else {
                    result['å•å°ææˆï¼ˆæ ¸å¯¹ï¼‰'] = 0;
                    result['åŒ¹é…è¯´æ˜'] = `å‹å·"${result['å‹å·']}"åœ¨æ¸ é“æ”¿ç­–è¡¨ä¸­æœªæ‰¾åˆ°åŒ¹é…`;
                }
                
                // è®¡ç®—æ€»ææˆ
                const quantityValue = row['é”€å”®æ•°é‡'];
                const quantity = parseFloat(quantityValue) || 0;
                const unitCommission = parseFloat(result['å•å°ææˆï¼ˆæ ¸å¯¹ï¼‰']) || 0;
                
                // å¦‚æœå•å°ææˆæ˜¯å­—ç¬¦ä¸²"éœ€é‚®ä»¶å®¡æ‰¹"ï¼Œæ€»ææˆä¹Ÿæ˜¯
                if (result['å•å°ææˆï¼ˆæ ¸å¯¹ï¼‰'] === 'éœ€é‚®ä»¶å®¡æ‰¹') {
                    result['ææˆï¼ˆæ ¸å¯¹ï¼‰'] = 'éœ€é‚®ä»¶å®¡æ‰¹';
                } else {
                    result['ææˆï¼ˆæ ¸å¯¹ï¼‰'] = (quantity * unitCommission).toFixed(2);
                }
                
                return result;
                    });

                    // äºŒæ¬¡è¿‡æ»¤ï¼šç¡®ä¿æ²¡æœ‰å•†å“åç§°ä¸ºç©ºçš„è®°å½•ï¼ˆåŒé‡ä¿é™©ï¼Œåªæ£€æŸ¥"å•†å“åç§°"å­—æ®µï¼‰
                    const beforeFilterCount = processedData.length;
                    processedData = processedData.filter(row => {
                        const productName = String(row['å•†å“åç§°'] || '').trim();
                        return productName !== '';
                    });
                    const afterFilterCount = processedData.length;
                    const filteredCount = beforeFilterCount - afterFilterCount;

                    if (filteredCount > 0) {
                        console.warn(`å¤„ç†æ—¶åˆè¿‡æ»¤äº†${filteredCount}æ¡å•†å“åç§°ä¸ºç©ºçš„è®°å½•ï¼ˆè¿™äº›è®°å½•åº”è¯¥åœ¨åŠ è½½æ—¶å·²è¢«è¿‡æ»¤ï¼‰`);
                    }
                    console.log(`æœ€ç»ˆæœ‰æ•ˆè®°å½•æ•°: ${afterFilterCount}`);

                    displayResults();
                    showSummary();
                    document.getElementById('exportBtn').disabled = false;
                    hideLoading();
                    showStatus('æ•°æ®å¤„ç†å®Œæˆï¼', 'success');
                } catch (error) {
                    hideLoading();
                    showStatus(`æ•°æ®å¤„ç†å¤±è´¥: ${error.message}`, 'error');
                    console.error('å¤„ç†é”™è¯¯:', error);
                }
            }, 100);
        }

        // æ˜¾ç¤ºç»“æœè¡¨æ ¼
        function displayResults() {
            const table = document.getElementById('resultsTable');
            const header = document.getElementById('tableHeader');
            const body = document.getElementById('tableBody');
            
            if (processedData.length === 0) return;
            
            // æ„å»ºè¡¨å¤´
            const originalColumns = Object.keys(processedData[0]).filter(key => 
                !['å¯¼è´­äººå‘˜1', 'å¯¼è´­äººå‘˜2', 'å‹å·', 'å•å°ææˆï¼ˆæ ¸å¯¹ï¼‰', 'ææˆï¼ˆæ ¸å¯¹ï¼‰', 'å‹å·æå–è¯´æ˜', 'åŒ¹é…è¯´æ˜', 'æ˜¯å¦å¨ç”µ'].includes(key)
            );
            
            const staffColumns = ['å¯¼è´­äººå‘˜1', 'å¯¼è´­äººå‘˜2'];
            const newColumns = ['å‹å·', 'å•å°ææˆï¼ˆæ ¸å¯¹ï¼‰', 'ææˆï¼ˆæ ¸å¯¹ï¼‰'];
            const explanationColumns = ['å‹å·æå–è¯´æ˜', 'åŒ¹é…è¯´æ˜'];
            
            let headerHTML = '<tr>';
            
            // åŸå§‹åˆ—
            originalColumns.forEach(col => {
                headerHTML += `<th class="${document.getElementById('showOriginal').checked ? '' : 'hidden'}">${col}</th>`;
            });
            
            // å¯¼è´­äººå‘˜åˆ—
            staffColumns.forEach(col => {
                headerHTML += `<th style="background: #e8f5e9;">${col}</th>`;
            });
            
            // æ–°å¢åˆ—
            newColumns.forEach(col => {
                const className = col.includes('å‹å·') ? 'model-column' : 'commission-column';
                headerHTML += `<th class="${className}">${col}</th>`;
            });
            
            // è¯´æ˜åˆ—
            explanationColumns.forEach(col => {
                headerHTML += `<th class="explanation-column ${document.getElementById('showExplanation').checked ? '' : 'hidden'}">${col}</th>`;
            });
            
            headerHTML += '<th>æ˜¯å¦å¨ç”µ</th></tr>';
            header.innerHTML = headerHTML;
            
            // æ„å»ºè¡¨ä½“
            let bodyHTML = '';
            processedData.forEach(row => {
                const isKitchen = row['æ˜¯å¦å¨ç”µ'] === 'æ˜¯';
                bodyHTML += `<tr class="${isKitchen ? 'kitchen-appliance' : ''}">`;
                
                // åŸå§‹åˆ—
                originalColumns.forEach(col => {
                    bodyHTML += `<td class="${document.getElementById('showOriginal').checked ? '' : 'hidden'}">${row[col] || ''}</td>`;
                });
                
                // å¯¼è´­äººå‘˜åˆ—
                staffColumns.forEach(col => {
                    bodyHTML += `<td style="background: #e8f5e9;">${row[col] || ''}</td>`;
                });
                
                // æ–°å¢åˆ—
                newColumns.forEach(col => {
                    const className = col.includes('å‹å·') ? 'model-column' : 'commission-column';
                    bodyHTML += `<td class="${className}">${row[col] || ''}</td>`;
                });
                
                // è¯´æ˜åˆ—
                explanationColumns.forEach(col => {
                    bodyHTML += `<td class="explanation-column ${document.getElementById('showExplanation').checked ? '' : 'hidden'}">${row[col] || ''}</td>`;
                });
                
                bodyHTML += `<td>${row['æ˜¯å¦å¨ç”µ']}</td></tr>`;
            });
            
            body.innerHTML = bodyHTML;
        }

        // æ˜¾ç¤ºæ±‡æ€»ä¿¡æ¯
        function showSummary() {
            const summaryDiv = document.getElementById('summary');
            const totalRows = processedData.length;
            const matchedRows = processedData.filter(row => 
                parseFloat(row['å•å°ææˆï¼ˆæ ¸å¯¹ï¼‰']) > 0 || row['å•å°ææˆï¼ˆæ ¸å¯¹ï¼‰'] === 'éœ€é‚®ä»¶å®¡æ‰¹'
            ).length;
            const kitchenRows = processedData.filter(row => row['æ˜¯å¦å¨ç”µ'] === 'æ˜¯').length;
            const totalCommission = processedData.reduce((sum, row) => {
                const commission = parseFloat(row['ææˆï¼ˆæ ¸å¯¹ï¼‰']);
                return sum + (isNaN(commission) ? 0 : commission);
            }, 0);
            
            summaryDiv.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${totalRows}</div>
                    <div class="stat-label">æ€»è®°å½•æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${matchedRows}</div>
                    <div class="stat-label">åŒ¹é…æˆåŠŸ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${kitchenRows}</div>
                    <div class="stat-label">å¨ç”µäº§å“</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${totalCommission.toFixed(2)}</div>
                    <div class="stat-label">æ€»ææˆé‡‘é¢</div>
                </div>
            `;
            summaryDiv.classList.remove('hidden');
        }

        // åˆ‡æ¢åˆ—æ˜¾ç¤º
        function toggleColumns() {
            displayResults();
        }

        // å¯¼å‡ºç»“æœ
        function exportResults() {
            if (processedData.length === 0) {
                showStatus('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º', 'error');
                return;
            }
            
            const ws = XLSX.utils.json_to_sheet(processedData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ææˆè®¡ç®—ç»“æœ');
            
            const fileName = `æ±‡å¾·éš†ææˆè®¡ç®—ç»“æœ_${new Date().toISOString().slice(0,10)}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showStatus('å¯¼å‡ºæˆåŠŸï¼', 'success');
        }

        // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusInfo');
            statusDiv.className = `alert alert-${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                    statusDiv.textContent = '';
                    statusDiv.className = '';
                }, 3000);
            }
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('mappingModal');
            if (event.target === modal) {
                closeMappingModal();
            }
        }
    </script>
</body>
</html>