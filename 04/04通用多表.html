<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>批量提成计算工具 v2.7 - A.O.史密斯业务工具平台</title>
  
  <!-- 统一样式文件 -->
  <link rel="stylesheet" href="../common-styles.css">
  
  <style>
      /* 工具特定样式 - 通用多表专用 */
      
      .tool-content {
          padding: 30px;
      }
      
      .section {
          margin-bottom: 30px;
          padding: 25px;
          border: 2px solid var(--border-light);
          border-radius: 10px;
          background: var(--bg-light);
      }
      
      .section h2 {
          color: var(--text-dark);
          margin-bottom: 20px;
          font-size: 1.3em;
          border-bottom: 3px solid var(--accent-gold);
          padding-bottom: 10px;
          display: flex;
          align-items: center;
          gap: 8px;
      }
      
      .upload-area {
          border: 3px dashed var(--primary-blue);
          border-radius: 10px;
          padding: 30px;
          text-align: center;
          background: white;
          transition: all 0.3s ease;
          margin-bottom: 15px;
      }
      
      .upload-area:hover {
          border-color: var(--accent-gold);
          background: #f8f9fa;
      }
      
      .upload-area.dragover {
          border-color: var(--color-success);
          background: #e8f5e9;
      }
      
      input[type="file"] {
          display: none;
      }
      
      .upload-btn {
          background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
          color: white;
          padding: 12px 25px;
          border: none;
          border-radius: 25px;
          cursor: pointer;
          font-size: 16px;
          transition: all 0.3s ease;
          margin: 10px;
          font-weight: 500;
      }
      
      .upload-btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(0, 31, 92, 0.3);
      }

      .upload-btn.secondary {
          background: linear-gradient(135deg, #64748b, #475569);
      }
      
      .file-list {
          margin-top: 20px;
          max-height: none;
          overflow-y: visible;
      }
      
      /* 当文件较多时启用滚动 */
      @media (min-height: 900px) {
          .file-list {
              max-height: calc(100vh - 400px);
              overflow-y: auto;
          }
      }
      
      /* 优化滚动条样式 */
      .file-list::-webkit-scrollbar {
          width: 8px;
      }
      
      .file-list::-webkit-scrollbar-track {
          background: #f1f1f1;
          border-radius: 10px;
      }
      
      .file-list::-webkit-scrollbar-thumb {
          background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
          border-radius: 10px;
      }
      
      .file-list::-webkit-scrollbar-thumb:hover {
          background: linear-gradient(135deg, var(--secondary-blue), var(--primary-blue));
      }
      
      .file-item {
          display: flex;
          flex-direction: column;
          padding: 16px;
          margin-bottom: 15px;
          background: white;
          border-radius: 12px;
          box-shadow: 0 3px 10px rgba(0,0,0,0.08);
          border-left: 4px solid var(--border-light);
          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          scroll-margin-top: 20px;
      }
      
      .file-item:hover {
          box-shadow: 0 5px 20px rgba(0,0,0,0.12);
          transform: translateY(-2px);
          border-left-color: var(--accent-gold);
      }
      
      .file-item.processing {
          background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
          border-left-color: var(--primary-blue);
          box-shadow: 0 3px 15px rgba(0, 31, 92, 0.2);
      }
      
      .file-item.completed {
          background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
          border-left-color: var(--color-success);
          box-shadow: 0 3px 15px rgba(76, 175, 80, 0.3);
      }
      
      .file-item.error {
          background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
          border-left-color: var(--color-error);
          box-shadow: 0 3px 15px rgba(244, 67, 54, 0.3);
      }
      
      .file-item-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          margin-bottom: 10px;
      }
      
      .file-info {
          flex: 1;
          display: flex;
          align-items: center;
      }
      
      .file-name {
          font-weight: 600;
          margin-right: 15px;
          color: #2c3e50;
          font-size: 15px;
          transition: color 0.3s ease;
      }
      
      .file-name:hover {
          color: #667eea;
      }
      
      .file-status {
          font-size: 12px;
          padding: 5px 12px;
          border-radius: 15px;
          color: white;
          margin-left: 10px;
          font-weight: 600;
          display: inline-flex;
          align-items: center;
          gap: 5px;
      }
      
      .status-waiting {
          background: linear-gradient(135deg, #9e9e9e 0%, #757575 100%);
          box-shadow: 0 2px 8px rgba(158, 158, 158, 0.3);
      }
      
      .status-waiting::before {
          content: '⏱️';
      }
      
      .status-processing {
          background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
          box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
          animation: pulse 2s ease-in-out infinite;
      }
      
      .status-processing::before {
          content: '⚙️';
      }
      
      @keyframes pulse {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.7; }
      }
      
      .status-completed {
          background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
          box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
      }
      
      .status-completed::before {
          content: '✅';
      }
      
      .status-error {
          background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
          box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3);
      }
      
      .status-error::before {
          content: '❌';
      }
      
      .file-actions {
          display: flex;
          gap: 10px;
      }
      
      .file-toolbar {
          display: flex;
          justify-content: flex-end;
          gap: 8px;
          margin: 8px 0 0 0;
      }
      
      .mini-btn {
          background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
          color: #fff;
          border: none;
          padding: 8px 14px;
          border-radius: 18px;
          cursor: pointer;
          font-size: 12px;
          font-weight: 600;
          transition: all 0.3s ease;
          box-shadow: 0 2px 8px rgba(0, 31, 92, 0.2);
      }
      
      .mini-btn:hover {
          transform: translateY(-1px);
          box-shadow: 0 4px 12px rgba(0, 31, 92, 0.3);
          background: linear-gradient(135deg, var(--secondary-blue), var(--primary-blue));
      }
      
      .mini-btn:active {
          transform: translateY(0);
      }
      
      .file-toggle-btn {
          background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
          color: #fff;
          border: none;
          padding: 8px 16px;
          border-radius: 20px;
          cursor: pointer;
          font-size: 13px;
          font-weight: 500;
          transition: all 0.3s ease;
          box-shadow: 0 2px 8px rgba(0, 31, 92, 0.2);
      }
      
      .file-toggle-btn:hover {
          transform: translateY(-1px);
          box-shadow: 0 4px 12px rgba(0, 31, 92, 0.3);
          background: linear-gradient(135deg, var(--secondary-blue), var(--primary-blue));
      }

      .import-preview {
          margin-top: 14px;
          background: rgba(255, 255, 255, 0.9);
          border: 1px solid var(--border-light);
          border-radius: 10px;
          padding: 12px;
      }

      .import-preview-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          gap: 10px;
          margin-bottom: 10px;
          flex-wrap: wrap;
      }

      .import-preview-meta {
          font-size: 12px;
          color: #374151;
          display: flex;
          align-items: center;
          gap: 10px;
          flex-wrap: wrap;
      }

      .chip {
          display: inline-flex;
          align-items: center;
          gap: 6px;
          padding: 4px 10px;
          border-radius: 999px;
          font-size: 12px;
          font-weight: 600;
          border: 1px solid rgba(0,0,0,0.06);
          background: #f8fafc;
          color: #334155;
      }

      .chip.ok {
          background: #ecfdf3;
          color: #137333;
          border-color: rgba(19,115,51,0.18);
      }

      .chip.warn {
          background: #fff7ed;
          color: #9a3412;
          border-color: rgba(154,52,18,0.18);
      }

      .chip.err {
          background: #fef2f2;
          color: #b91c1c;
          border-color: rgba(185,28,28,0.18);
      }

      .header-row-selector {
          display: inline-flex;
          align-items: center;
          gap: 8px;
      }

      .header-row-selector select {
          padding: 6px 10px;
          border-radius: 8px;
          border: 1px solid var(--border-light);
          background: white;
          font-size: 12px;
      }

      .preview-table-wrap {
          overflow: auto;
          border-radius: 10px;
          border: 1px solid rgba(0,0,0,0.06);
          background: white;
      }

      .preview-table {
          width: 100%;
          border-collapse: collapse;
          font-size: 12px;
      }

      .preview-table th,
      .preview-table td {
          border-bottom: 1px solid rgba(0,0,0,0.06);
          padding: 8px 10px;
          text-align: left;
          white-space: nowrap;
          max-width: 260px;
          overflow: hidden;
          text-overflow: ellipsis;
      }

      .preview-table th {
          position: sticky;
          top: 0;
          z-index: 1;
          background: #f8fafc;
          color: #0f172a;
          font-weight: 700;
      }

      .preview-table th.matched {
          background: #ecfdf3;
          color: #137333;
      }

      .preview-hint {
          font-size: 12px;
          color: #64748b;
          margin-top: 8px;
          display: flex;
          gap: 10px;
          flex-wrap: wrap;
      }

      .workflow-bar {
          position: sticky;
          top: 0;
          z-index: 50;
          margin: -30px -30px 18px;
          padding: 14px 18px;
          background: rgba(255, 255, 255, 0.92);
          backdrop-filter: blur(10px);
          border-bottom: 1px solid rgba(0,0,0,0.06);
          display: flex;
          align-items: center;
          justify-content: space-between;
          gap: 14px;
          flex-wrap: wrap;
      }

      .workflow-steps {
          display: flex;
          align-items: center;
          gap: 10px;
          flex-wrap: wrap;
      }

      .step-pill {
          display: inline-flex;
          align-items: center;
          gap: 8px;
          padding: 8px 12px;
          border-radius: 999px;
          border: 1px solid rgba(0,0,0,0.08);
          background: #f8fafc;
          color: #0f172a;
          font-size: 13px;
          font-weight: 700;
          cursor: pointer;
          transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
          user-select: none;
      }

      .step-pill:hover {
          transform: translateY(-1px);
          box-shadow: 0 6px 16px rgba(0,0,0,0.08);
          background: white;
      }

      .step-pill .dot {
          width: 10px;
          height: 10px;
          border-radius: 50%;
          background: #94a3b8;
          box-shadow: 0 0 0 3px rgba(148,163,184,0.25);
      }

      .step-pill.done .dot {
          background: #22c55e;
          box-shadow: 0 0 0 3px rgba(34,197,94,0.20);
      }

      .step-pill.warn .dot {
          background: #f59e0b;
          box-shadow: 0 0 0 3px rgba(245,158,11,0.22);
      }

      .step-meta {
          display: flex;
          align-items: center;
          gap: 10px;
          flex-wrap: wrap;
          font-size: 12px;
          color: #475569;
      }

      .meta-kv {
          display: inline-flex;
          align-items: center;
          gap: 6px;
          padding: 6px 10px;
          border-radius: 999px;
          background: #f1f5f9;
          border: 1px solid rgba(0,0,0,0.06);
          font-weight: 700;
      }

      .meta-kv strong {
          color: #0f172a;
      }

      .action-bar {
          position: sticky;
          bottom: 14px;
          z-index: 40;
          display: flex;
          align-items: center;
          justify-content: space-between;
          gap: 14px;
          padding: 14px 16px;
          border-radius: 14px;
          background: rgba(0, 31, 92, 0.92);
          backdrop-filter: blur(10px);
          box-shadow: 0 16px 40px rgba(0,0,0,0.25);
          border: 1px solid rgba(255,255,255,0.12);
      }

      .action-left {
          display: flex;
          align-items: center;
          gap: 10px;
          flex-wrap: wrap;
          color: rgba(255,255,255,0.88);
          font-size: 12px;
          font-weight: 600;
      }

      .action-left .badge {
          display: inline-flex;
          align-items: center;
          gap: 6px;
          padding: 6px 10px;
          border-radius: 999px;
          background: rgba(255,255,255,0.12);
          border: 1px solid rgba(255,255,255,0.18);
      }

      .action-right {
          display: flex;
          align-items: center;
          gap: 10px;
          flex-wrap: wrap;
      }

      .action-bar .btn {
          margin: 0;
          min-width: 160px;
          border-radius: 999px;
          box-shadow: none;
      }

      .action-bar .btn.btn-secondary {
          background: rgba(255,255,255,0.14);
          color: white;
          border: 1px solid rgba(255,255,255,0.22);
      }

      .action-bar .btn.btn-secondary:hover {
          background: rgba(255,255,255,0.20);
      }

      .action-bar .btn:disabled {
          opacity: 0.65;
          cursor: not-allowed;
          transform: none;
      }

      .file-list-empty {
          padding: 18px;
          border-radius: 12px;
          background: linear-gradient(135deg, rgba(0,31,92,0.04), rgba(255,193,7,0.06));
          border: 1px dashed rgba(0,0,0,0.12);
          color: #334155;
          font-size: 13px;
          display: flex;
          align-items: center;
          justify-content: space-between;
          gap: 10px;
          flex-wrap: wrap;
      }

      .file-list-empty strong {
          color: #0f172a;
      }

      .section h2 .subhint {
          font-size: 12px;
          font-weight: 600;
          color: #64748b;
          margin-left: 10px;
      }

      .compact-summary {
          margin-top: 10px;
          padding: 12px 14px;
          border-radius: 12px;
          background: linear-gradient(135deg, rgba(0,31,92,0.03), rgba(15,23,42,0.02));
          border: 1px solid rgba(0,0,0,0.06);
          display: flex;
          align-items: center;
          justify-content: space-between;
          gap: 10px;
          flex-wrap: wrap;
      }

      .compact-summary .summary-text {
          color: #0f172a;
          font-size: 13px;
          font-weight: 700;
          display: flex;
          align-items: center;
          gap: 10px;
          flex-wrap: wrap;
      }

      .compact-summary .summary-text span {
          color: #475569;
          font-weight: 600;
      }

      .compact-summary .summary-actions {
          display: flex;
          align-items: center;
          gap: 8px;
          flex-wrap: wrap;
      }
      
      .mapping-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
          gap: 16px;
      }
      
      .file-name {
          cursor: pointer;
      }
      
      .remove-btn {
          background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
          color: white;
          border: none;
          padding: 8px 14px;
          border-radius: 20px;
          cursor: pointer;
          font-size: 12px;
          font-weight: 600;
          transition: all 0.3s ease;
          box-shadow: 0 2px 8px rgba(235, 51, 73, 0.3);
      }
      
      .remove-btn:hover {
          transform: translateY(-1px);
          box-shadow: 0 4px 12px rgba(235, 51, 73, 0.4);
      }
      
      .remove-btn:active {
          transform: translateY(0);
      }
      
      .export-single-btn {
          background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
          color: white;
          border: none;
          padding: 8px 14px;
          border-radius: 20px;
          cursor: pointer;
          font-size: 12px;
          font-weight: 600;
          transition: all 0.3s ease;
          display: none;
          box-shadow: 0 2px 8px rgba(56, 239, 125, 0.3);
      }
      
      .export-single-btn:hover {
          transform: translateY(-1px);
          box-shadow: 0 4px 12px rgba(56, 239, 125, 0.4);
      }
      
      .export-single-btn:active {
          transform: translateY(0);
      }
      
      .sheet-selector {
          margin: 15px 0;
          display: none;
          padding: 12px 15px;
          background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
          border-radius: 10px;
          border: 2px solid #e1e8ed;
          box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      }
      
      .sheet-selector label {
          font-weight: 600;
          color: #2c3e50;
          margin-right: 10px;
          font-size: 14px;
      }
      
      .sheet-selector select {
          padding: 10px 12px;
          border: 2px solid #e1e8ed;
          border-radius: 8px;
          font-size: 14px;
          min-width: 200px;
          background: white;
          cursor: pointer;
          transition: all 0.3s ease;
      }
      
      .sheet-selector select:hover {
          border-color: #667eea;
      }
      
      .sheet-selector select:focus {
          outline: none;
          border-color: #667eea;
          box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }
      
      .mapping-container {
          display: none;
          margin-top: 20px;
          background: linear-gradient(135deg, #f8fafc 0%, #e8eef5 100%);
          padding: 20px;
          border-radius: 12px;
          box-shadow: 0 4px 15px rgba(0,0,0,0.08);
          animation: slideDown 0.4s cubic-bezier(0.4, 0, 0.2, 1);
          overflow: hidden;
          border: 1px solid var(--border-light);
      }
      
      @keyframes slideDown {
          from {
              opacity: 0;
              transform: translateY(-15px);
              max-height: 0;
          }
          to {
              opacity: 1;
              transform: translateY(0);
              max-height: 2000px;
          }
      }
      
      .mapping-row {
          display: flex;
          flex-direction: column;
          margin-bottom: 12px;
          padding: 16px;
          background: white;
          border-radius: 10px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.06);
          transition: all 0.3s ease;
          border-left: 4px solid transparent;
      }
      
      .mapping-row:hover {
          box-shadow: 0 4px 12px rgba(0,0,0,0.1);
          border-left-color: var(--accent-gold);
          transform: translateX(2px);
      }
      
      .mapping-row label {
          font-weight: 600;
          color: var(--text-dark);
          margin-bottom: 8px;
          font-size: 14px;
          display: flex;
          align-items: center;
          gap: 6px;
      }
      
      .mapping-row label::before {
          content: '📋';
          font-size: 16px;
      }
      
      .mapping-row select {
          width: 100%;
          padding: 10px 12px;
          border: 2px solid var(--border-light);
          border-radius: 8px;
          font-size: 14px;
          background: white;
          transition: all 0.3s ease;
          cursor: pointer;
      }
      
      .mapping-row select:focus {
          outline: none;
          border-color: var(--primary-blue);
          box-shadow: 0 0 0 3px rgba(0, 31, 92, 0.1);
      }
      
      .mapping-row select:hover {
          border-color: var(--accent-gold);
      }
      
      .mapping-row select option {
          padding: 10px;
      }
      
      .mapping-row select option:checked {
          background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
          color: white;
      }
      
      .auto-match-btn {
          background: linear-gradient(135deg, var(--accent-gold), #d4a700);
          color: var(--text-dark);
          padding: 10px 20px;
          border: none;
          border-radius: 25px;
          cursor: pointer;
          font-size: 14px;
          font-weight: 600;
          margin-left: 12px;
          transition: all 0.3s ease;
          box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
      }
      
      .auto-match-btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 20px rgba(255, 193, 7, 0.4);
          background: linear-gradient(135deg, #d4a700, var(--accent-gold));
      }
      
      .auto-match-btn:active {
          transform: translateY(0);
      }
      
      .match-confidence {
          margin-top: 6px;
          font-size: 12px;
          padding: 4px 10px;
          border-radius: 12px;
          color: white;
          display: inline-flex;
          align-items: center;
          gap: 4px;
          font-weight: 500;
      }
      
      .match-confidence::before {
          content: '●';
          font-size: 10px;
      }
      
      .confidence-high {
          background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
          box-shadow: 0 2px 8px rgba(56, 239, 125, 0.3);
      }
      
      .confidence-medium {
          background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%);
          box-shadow: 0 2px 8px rgba(243, 156, 18, 0.3);
      }
      
      .confidence-low {
          background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
          box-shadow: 0 2px 8px rgba(235, 51, 73, 0.3);
      }
      
      .btn {
          background: linear-gradient(135deg, var(--color-success), #2ecc71);
          color: white;
          padding: 14px 32px;
          border: none;
          border-radius: 25px;
          cursor: pointer;
          font-size: 16px;
          font-weight: 600;
          transition: all 0.3s ease;
          margin: 10px 5px;
          box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
      }
      
      .btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
      }
      
      .btn:disabled {
          background: #95a5a6;
          cursor: not-allowed;
          transform: none;
          box-shadow: none;
          opacity: 0.6;
      }
      
      .btn-secondary {
          background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
          box-shadow: 0 4px 15px rgba(0, 31, 92, 0.3);
      }
      
      .btn-secondary:hover {
          box-shadow: 0 6px 20px rgba(0, 31, 92, 0.4);
      }
      
      .progress-container {
          margin-top: 20px;
          display: none;
      }
      
      .progress-bar {
          width: 100%;
          height: 30px;
          background: #ecf0f1;
          border-radius: 15px;
          overflow: hidden;
          position: relative;
      }
      
      .progress-fill {
          height: 100%;
          background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
          width: 0%;
          transition: width 0.3s ease;
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-weight: bold;
      }
      
      .progress-info {
          margin-top: 10px;
          text-align: center;
          color: var(--text-secondary);
      }
      
      .results {
          margin-top: 30px;
          display: none;
      }
      
      .results-tabs {
          display: flex;
          border-bottom: 2px solid var(--border-light);
          margin-bottom: 20px;
          flex-wrap: wrap;
          gap: 5px;
      }
      
      .tab {
          padding: 12px 24px;
          cursor: pointer;
          background: #f8f9fa;
          border: none;
          margin-right: 5px;
          border-radius: 10px 10px 0 0;
          transition: all 0.3s ease;
          font-weight: 500;
          color: var(--text-secondary);
      }
      
      .tab.active {
          background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
          color: white;
          box-shadow: 0 2px 8px rgba(0, 31, 92, 0.2);
      }
      
      .tab:hover:not(.active) {
          background: #e9ecef;
          color: var(--text-dark);
      }
      
      .tab-content {
          display: none;
      }
      
      .tab-content.active {
          display: block;
      }
      
      .results table {
          width: 100%;
          border-collapse: collapse;
          background: white;
          border-radius: 10px;
          overflow: hidden;
          box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      }
      
      .results th, .results td {
          padding: 12px;
          text-align: left;
          border-bottom: 1px solid #ecf0f1;
      }
      
      .results th {
          background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
          color: white;
          font-weight: 600;
      }
      
      .results tr:hover {
          background: #f8f9fa;
      }
      
      .summary {
          background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
          color: white;
          padding: 24px;
          border-radius: 12px;
          margin-bottom: 20px;
          text-align: center;
          box-shadow: 0 4px 15px rgba(0, 31, 92, 0.2);
      }
      
      .summary h3 {
          font-size: 1.5em;
          margin-bottom: 12px;
          font-weight: 600;
      }
      
      .summary p {
          font-size: 1.1em;
          margin: 8px 0;
      }
      
      .error {
          background: var(--color-error);
          color: white;
          padding: 16px 20px;
          border-radius: 8px;
          margin: 10px 0;
          display: none;
          box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3);
      }
      
      .success {
          background: var(--color-success);
          color: white;
          padding: 16px 20px;
          border-radius: 8px;
          margin: 10px 0;
          display: none;
          box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
      }
      
      .loading-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.5);
          display: none;
          justify-content: center;
          align-items: center;
          z-index: 9999;
      }
      
      .loading-content {
          background: white;
          padding: 30px;
          border-radius: 10px;
          text-align: center;
          max-width: 400px;
      }
      
      .spinner {
          border: 4px solid #f3f3f3;
          border-top: 4px solid #3498db;
          border-radius: 50%;
          width: 40px;
          height: 40px;
          animation: spin 1s linear infinite;
          margin: 0 auto 20px;
      }
      
      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }
      
      .field-count {
          color: var(--primary-blue);
          font-size: 12px;
          font-weight: 600;
          margin-left: 10px;
          padding: 4px 10px;
          background: rgba(0, 31, 92, 0.1);
          border-radius: 12px;
          display: inline-block;
      }
      
      /* 新增：调试信息样式 */
      .debug-info {
          background: #f8f9fa;
          border: 1px solid #dee2e6;
          border-radius: 8px;
          padding: 15px;
          margin: 15px 0;
          font-family: 'Courier New', monospace;
          font-size: 12px;
      }
      
      .debug-info h4 {
          color: #495057;
          margin-bottom: 10px;
          font-family: 'Microsoft YaHei', Arial, sans-serif;
      }
      
      .match-stats {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 10px;
          margin: 10px 0;
      }
      
      .stat-item {
          background: white;
          padding: 10px;
          border-radius: 5px;
          border-left: 4px solid #007bff;
      }
      
      .stat-item.success {
          border-left-color: #28a745;
      }
      
      .stat-item.warning {
          border-left-color: #ffc107;
      }
      
      .stat-item.error {
          border-left-color: #dc3545;
      }
      
      .unmatched-models {
          max-height: 200px;
          overflow-y: auto;
          background: white;
          padding: 10px;
          border-radius: 5px;
          margin-top: 10px;
      }
      
      .model-comparison {
          display: flex;
          justify-content: space-between;
          padding: 5px 0;
          border-bottom: 1px solid #eee;
      }
      
      .model-comparison:last-child {
          border-bottom: none;
      }
      
      .model-original {
          color: #6c757d;
      }
      
      .model-normalized {
          color: #007bff;
          font-weight: bold;
      }
      
      /* 布局优化：销售数据表配置字段（展开区域） */
      .mapping-grid {
          gap: 16px;
      }
      @media (min-width: 1280px) {
          .mapping-grid {
              grid-template-columns: repeat(3, minmax(280px, 1fr));
          }
      }
      @media (min-width: 768px) and (max-width: 1279px) {
          .mapping-grid {
              grid-template-columns: repeat(2, minmax(320px, 1fr));
          }
      }
      @media (max-width: 767px) {
          .mapping-grid {
              grid-template-columns: 1fr;
          }
      }
      .mapping-subtitle {
          grid-column: 1 / -1;
          margin: 16px 0 12px;
          padding: 10px 15px;
          background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
          color: white;
          font-weight: 700;
          font-size: 14px;
          letter-spacing: 0.8px;
          border-radius: 8px;
          box-shadow: 0 3px 10px rgba(0, 31, 92, 0.3);
          display: flex;
          align-items: center;
          gap: 8px;
      }
      
      .mapping-subtitle::before {
          content: '⚡';
          font-size: 18px;
      }
      
      .mapping-subtitle.optional {
          background: linear-gradient(135deg, #a8b8d8 0%, #8e9eae 100%);
          box-shadow: 0 3px 10px rgba(168, 184, 216, 0.3);
          margin-top: 16px;
      }
      
      .mapping-subtitle.optional::before {
          content: '📝';
      }
      
      .mapping-container > h3 {
          color: var(--text-dark);
          font-size: 18px;
          margin-bottom: 20px;
          padding-bottom: 12px;
          border-bottom: 3px solid var(--accent-gold);
          display: flex;
          align-items: center;
          justify-content: space-between;
          flex-wrap: wrap;
          gap: 12px;
      }
      
      .mapping-container > h3::before {
          content: '🔧 ';
          font-size: 20px;
      }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-content">
          <div class="spinner"></div>
          <p id="loadingText">正在处理数据...</p>
          <div class="progress-info" id="progressInfo"></div>
      </div>
  </div>
  
  <div class="tool-container">
      <!-- 头部 -->
      <header class="tool-header">
          <a href="../index.html" class="back-nav">← 返回首页</a>
          <h1>🤖 批量提成计算工具 v2.7</h1>
          <p class="tool-subtitle">支持多文件批量处理 + 智能字段匹配 + 员工汇总表（按门店分配） + 型号智能提取（支持从物料名称提取） + 灵活字段映射（二选一逻辑） + 兴达表特殊处理（归巩建勋） + 圣都表特殊处理（归曾兴容） + 湖州天猫店特殊处理（归陈春艳）</p>
          <div class="tool-badge">
              <span class="badge-dot"></span>
              <span>04 - 特殊渠道工具</span>
          </div>
      </header>
      
      <!-- 主内容区 -->
      <main class="tool-content">
          <div class="workflow-bar" id="workflowBar">
              <div class="workflow-steps">
                  <div class="step-pill" id="stepSales" onclick="scrollToSection('salesUpload')">
                      <span class="dot"></span><span>1 销售数据</span>
                  </div>
                  <div class="step-pill" id="stepPolicy" onclick="scrollToSection('policyUpload')">
                      <span class="dot"></span><span>2 政策表</span>
                  </div>
                  <div class="step-pill" id="stepStoreList" onclick="scrollToSection('storeListUpload')">
                      <span class="dot"></span><span>3 渠道名单</span>
                  </div>
                  <div class="step-pill" id="stepCalc" onclick="scrollToSection('calculateBtn')">
                      <span class="dot"></span><span>4 计算导出</span>
                  </div>
              </div>
              <div class="step-meta" id="workflowMeta">
                  <span class="meta-kv">文件 <strong id="metaSalesCount">0</strong></span>
                  <span class="meta-kv">政策 <strong id="metaPolicy">未就绪</strong></span>
                  <span class="meta-kv">名单 <strong id="metaStoreList">未就绪</strong></span>
                  <span class="meta-kv">状态 <strong id="metaReady">未满足计算条件</strong></span>
              </div>
          </div>

          <!-- 上传销售数据 -->
          <section class="section">
              <h2>📊 上传销售数据表（支持多个文件）<span class="subhint">上传后可逐个配置字段映射并预览</span></h2>
              <div class="upload-area" id="salesUpload">
                  <p>📁 拖拽多个Excel文件到此处或点击上传</p>
                  <button class="upload-btn" onclick="document.getElementById('salesFiles').click()">选择多个文件</button>
                  <button class="upload-btn secondary" onclick="document.getElementById('salesFileSingle').click()">追加一个文件</button>
                  <input type="file" id="salesFiles" accept=".xlsx,.xls" multiple />
                  <input type="file" id="salesFileSingle" accept=".xlsx,.xls" />
              </div>
              <div class="file-list" id="fileList"></div>
              <div class="file-toolbar">
                  <button class="mini-btn" onclick="configureAllFilesSequentially()" id="configureAllBtn" style="display:none;">📋 依次配置全部</button>
                  <button class="mini-btn" onclick="collapseAllMappings()">一键收起全部</button>
              </div>
              <div class="progress-container" id="progressContainer">
                  <div class="progress-bar">
                      <div class="progress-fill" id="progressFill">0%</div>
                  </div>
                  <div class="progress-info" id="overallProgress"></div>
              </div>
          </section>
          
          <!-- 上传政策表 -->
          <section class="section">
              <h2>📋 政策表<span class="subhint">已上传会自动保留，下次可直接用</span></h2>
              <div class="compact-summary" id="policySummary" style="display:none;">
                  <div class="summary-text" id="policySummaryText">未上传</div>
                  <div class="summary-actions">
                      <button class="mini-btn" id="policyToggleBtn" onclick="togglePolicyDetails()">展开</button>
                      <button class="mini-btn" onclick="document.getElementById('policyFile').click()">更换文件</button>
                  </div>
              </div>
              <div id="policyDetails">
                  <div class="upload-area" id="policyUpload">
                      <p>📁 拖拽Excel文件到此处或点击上传</p>
                      <button class="upload-btn" onclick="document.getElementById('policyFile').click()">选择文件</button>
                      <input type="file" id="policyFile" accept=".xlsx,.xls" />
                  </div>
                  <div class="sheet-selector" id="policySheetSelector">
                      <label>选择工作表：</label>
                      <select id="policySheetSelect"></select>
                      <span class="field-count" id="policyFieldCount"></span>
                  </div>
                  <div class="mapping-container" id="policyMapping">
                  <h3>
                      字段映射 - 政策表
                      <button class="auto-match-btn" onclick="autoMatchFields('policy')">🎯 智能匹配</button>
                  </h3>
                  <div class="mapping-grid">
                      <div class="mapping-row">
                          <label>规格型号</label>
                          <select id="policyModelField"></select>
                          <span class="match-confidence" id="policyModelField_confidence"></span>
                      </div>
                      <div class="mapping-row">
                          <label>单台提成</label>
                          <select id="commissionField"></select>
                          <span class="match-confidence" id="commissionField_confidence"></span>
                      </div>
                  </div>
              </div>
              </div>
          </section>
          
          <!-- 上传渠道名单 -->
          <section class="section">
              <h2>👥 渠道名单<span class="subhint">用于门店/员工匹配（可选但推荐）</span></h2>
              <div class="compact-summary" id="storeListSummary" style="display:none;">
                  <div class="summary-text" id="storeListSummaryText">未上传</div>
                  <div class="summary-actions">
                      <button class="mini-btn" id="storeListToggleBtn" onclick="toggleStoreListDetails()">展开</button>
                      <button class="mini-btn" onclick="document.getElementById('storeListFile').click()">更换文件</button>
                  </div>
              </div>
              <div id="storeListDetails">
                  <div class="upload-area" id="storeListUpload">
                      <p>📁 拖拽Excel文件到此处或点击上传</p>
                      <button class="upload-btn" onclick="document.getElementById('storeListFile').click()">选择文件</button>
                      <input type="file" id="storeListFile" accept=".xlsx,.xls" />
                  </div>
                  <div class="sheet-selector" id="storeListSheetSelector">
                      <label>选择工作表：</label>
                      <select id="storeListSheetSelect"></select>
                      <span class="field-count" id="storeListFieldCount"></span>
                  </div>
                  <div class="mapping-container" id="storeListMapping">
                  <h3>
                      字段映射 - 渠道名单
                      <button class="auto-match-btn" onclick="autoMatchFields('storeList')">🎯 智能匹配</button>
                  </h3>
                  <div class="mapping-grid">
                      <div class="mapping-row">
                          <label>部门</label>
                          <select id="departmentField"></select>
                          <span class="match-confidence" id="departmentField_confidence"></span>
                      </div>
                      <div class="mapping-row">
                          <label>门店</label>
                          <select id="storeNameField"></select>
                          <span class="match-confidence" id="storeNameField_confidence"></span>
                      </div>
                      <div class="mapping-row">
                          <label>导购人员 1</label>
                          <select id="employeeNameField"></select>
                          <span class="match-confidence" id="employeeNameField_confidence"></span>
                      </div>
                  <div class="mapping-row">
                      <label>导购人员 2</label>
                      <select id="employeeName2Field"></select>
                      <span class="match-confidence" id="employeeName2Field_confidence"></span>
                  </div>
                  <div class="mapping-row">
                      <label>导购人员 1 入职日期</label>
                      <select id="employeeName1JoinDateField"></select>
                      <span class="match-confidence" id="employeeName1JoinDateField_confidence"></span>
                  </div>
                  <div class="mapping-row">
                      <label>导购人员 2 入职日期</label>
                      <select id="employeeName2JoinDateField"></select>
                      <span class="match-confidence" id="employeeName2JoinDateField_confidence"></span>
                  </div>
                  <div class="mapping-row">
                      <label>导购人员 1 离职日期</label>
                      <select id="employeeName1LeaveDateField"></select>
                      <span class="match-confidence" id="employeeName1LeaveDateField_confidence"></span>
                  </div>
                  <div class="mapping-row">
                      <label>导购人员 2 离职日期</label>
                      <select id="employeeName2LeaveDateField"></select>
                      <span class="match-confidence" id="employeeName2LeaveDateField_confidence"></span>
                  </div>
              </div>
          </div>
          </div>
          </section>
          
          <!-- 字段映射模板 -->
          <section class="section" id="fieldMappingSection" style="display: none;">
              <h2>🔧 字段映射设置（将应用于所有文件）</h2>
              <div class="mapping-container" style="display: block;">
                  <h3>销售数据字段映射 
                      <button class="auto-match-btn" onclick="autoMatchFieldsFromFirstFile()">🎯 从第一个文件智能匹配</button>
                  </h3>
                  <div class="mapping-row">
                      <label>日期：</label>
                      <select id="dateField"></select>
                      <span class="match-confidence" id="dateField_confidence"></span>
                  </div>
                  <div class="mapping-row">
                      <label>单据编号：</label>
                      <select id="orderNoField"></select>
                      <span class="match-confidence" id="orderNoField_confidence"></span>
                  </div>
                  <div class="mapping-row">
                      <label>用户姓名：</label>
                      <select id="userNameField"></select>
                      <span class="match-confidence" id="userNameField_confidence"></span>
                  </div>
                  <div class="mapping-row">
                      <label>门店：</label>
                      <select id="storeField"></select>
                      <span class="match-confidence" id="storeField_confidence"></span>
                  </div>
                  <div class="mapping-row">
                      <label>促销员：</label>
                      <select id="salesPersonField"></select>
                      <span class="match-confidence" id="salesPersonField_confidence"></span>
                  </div>
                  <div class="mapping-row">
                      <label>物料名称：</label>
                      <select id="materialNameField"></select>
                      <span class="match-confidence" id="materialNameField_confidence"></span>
                  </div>
                  <div class="mapping-row">
                      <label>规格型号：</label>
                      <select id="modelField"></select>
                      <span class="match-confidence" id="modelField_confidence"></span>
                  </div>
                  <div class="mapping-row">
                      <label>销售数量：</label>
                      <select id="quantityField"></select>
                      <span class="match-confidence" id="quantityField_confidence"></span>
                  </div>
              </div>
          </section>
          
          <!-- 计算按钮 -->
          <section class="section">
              <div class="action-bar" id="actionBar">
                  <div class="action-left">
                      <span class="badge" id="actionHint">请先上传并完成字段映射</span>
                      <span class="badge">建议：先配好政策表与渠道名单再批量算</span>
                  </div>
                  <div class="action-right">
                      <button class="btn" id="calculateBtn" onclick="calculateAllCommissions()" disabled>🧮 批量计算提成</button>
                      <button class="btn btn-secondary" onclick="exportAllResults()" id="exportAllBtn" style="display:none;">📤 导出全部</button>
                      <button class="btn btn-secondary" onclick="exportSeparateResults()" id="exportSeparateBtn" style="display:none;">📦 分别导出</button>
                  </div>
              </div>
          </section>
          
          <div class="error" id="errorMsg"></div>
          <div class="success" id="successMsg"></div>
          
          <!-- 结果显示 -->
          <div class="results" id="results">
              <h2>💰 计算结果</h2>
              <div class="results-tabs" id="resultsTabs"></div>
              <div id="resultsContent"></div>
          </div>
      </main>
      
      <!-- 页脚 -->
      <footer class="tool-footer">
          <p>批量提成计算工具 v2.7 | 更新日期: 2025-11-04</p>
          <div class="footer-links">
              <a href="../index.html">返回首页</a>
              <a href="https://iiuzjzy3ccx.feishu.cn/wiki/PbWjwvsXmiJK38kcVdFcsnVNndd" target="_blank">使用文档</a>
          </div>
      </footer>
  </div>
  
  <script>
      // 全局变量
      let salesFiles = [];
      let policyData = null;
      let policyWorkbook = null;
      let storeListData = null; // 渠道名单数据
      let storeListWorkbook = null;
      let fieldMapping = null;
      let allResults = {};
      let matchingDebugInfo = {}; // 新增：匹配调试信息
      let isConfiguringFile = false; // 新增：防止并发配置文件
      let isBatchConfiguring = false; // 新增：标记是否正在批量配置
      
      // 新增：字段定义（必填/可选 + 关键词）
      const fieldDefinitions = {
          sales: {
              required: {
                  // 促销员和门店二选一
                  salesPersonField: { label: '促销员', keywords: ['促销员', '销售员', '业务员', '销售人员', '下单人', '采购员', 'sales', 'salesperson', '业 务 员'], allowEmpty: true },
                  storeField: { label: '门店', keywords: ['门店', '店铺', '门店名称', '店铺名称', 'store', '客户'], allowEmpty: true },
                  // 销售数量必填
                  quantityField: { label: '销售数量', keywords: ['销售数量', '数量', '销量', '自定义规格值', 'quantity', 'qty', '件数', '销售商品数量'] },
                  // 规格型号和物料名称二选一，优先规格型号
                  modelField: { label: '规格型号', keywords: ['规格型号', '型号', '规格', '款式', 'model', 'spec', '具体型号', '存货编码', '存货编号', '存货代码'], allowEmpty: true },
                  materialNameField: { label: '物料名称', keywords: ['物料名称', '商品名称', '产品名称', '物料', '商品', '产品', 'material', 'product', '存货名称'], allowEmpty: true }
              },
          optional: {
              dateField: { label: '日期', keywords: ['日期', 'date', '时间', '开单日期', '销售日期', '单据日期'] },
              orderNoField: { label: '单据编号', keywords: ['单据编号', '订单号', '单号', '编号', '单据号', 'order', 'orderNo'] },
              userNameField: { label: '用户姓名', keywords: ['用户姓名', '用户', '姓名', '客户姓名', 'user', 'userName'] },
              regionField: { label: '地区', keywords: ['地区', '区域', 'region', '所属地区'] },
              settlementField: { label: '是否结算', keywords: ['是否结算', '结算', 'settlement', '结算状态'] }
          }
          },
          policy: {
              required: {
                  policyModelField: { label: '规格型号', keywords: ['规格型号', '型号', '规格', '款式', 'model', 'spec'] },
                  commissionField: { label: '单台提成', keywords: ['单台提成', '提成', '佣金', '奖励', 'commission', '提成金额'] }
              }
          }
      };
      
      // 字段匹配规则
      const fieldMatchRules = {
          sales: {
              salesPersonField: ['促销员', '销售员', '业务员', '销售人员', '下单人', '采购员', 'sales', 'salesperson', '业 务 员'],
              quantityField: ['销售数量', '数量', '销量', '自定义规格值', 'quantity', 'qty', '件数', '销售商品数量', '实发数量'],
              modelField: ['规格型号', '型号', '规格', '款式', 'model', 'spec', '具体型号', '存货编码', '存货编号'],
              materialNameField: ['物料名称', '商品名称', '产品名称', '物料', '商品', '产品', 'material', 'product', '存货名称'],
              storeField: ['门店', '店铺', '门店名称', '店铺名称', 'store', '客户'],
              dateField: ['日期', 'date', '时间', '开单日期', '销售日期', '单据日期'],
              orderNoField: ['单据编号', '订单号', '单号', '编号', '单据号', 'order', 'orderNo'],
              userNameField: ['用户姓名', '用户', '姓名', '客户姓名', 'user', 'userName'],
              regionField: ['地区', '区域', 'region', '所属地区'],
              settlementField: ['是否结算', '结算', 'settlement', '结算状态']
          },
          policy: {
              policyModelField: ['规格型号', '型号', '规格', '款式', 'model', 'spec'],
              commissionField: ['单台提成', '提成', '佣金', '奖励', 'commission', '提成金额']
          },
      storeList: {
          departmentField: ['部门', '公司', '部门名称', 'department'],
          storeNameField: ['门店', '店铺', '门店名称', 'store'],
          employeeNameField: ['员工姓名', '姓名', '促销员', '导购员', '导购人员 1', '导购人员1', 'name', 'employee'],
          employeeName2Field: ['导购人员 2', '导购人员2', '员工姓名2', '促销员2', '导购员2'],
          employeeName1JoinDateField: ['入职日期', '导购人员 1 入职日期', '导购人员1入职日期', '员工入职日期', 'joinDate'],
          employeeName2JoinDateField: ['导购人员 2入职日期', '导购人员2入职日期', 'joinDate2'],
          employeeName1LeaveDateField: ['导购人员 1 离职日期', '导购人员1离职日期', '离职日期', 'leaveDate', '导购人员1 离职日期'],
          employeeName2LeaveDateField: ['导购人员 2 离职日期', '导购人员2离职日期', 'leaveDate2', '导购人员2 离职日期']
      }
      };
      
      // 文件类型检测配置（按优先级排序）
      const fileTypeConfig = {
          patterns: [
              { keyword: '杭州外围', type: 'hangzhouOuter' },
              { keyword: '浙北', type: 'zheibei' },
              { keyword: '金华五星', type: 'jinhua' },
              { keyword: '圣都', type: 'shengdu' },
              { keyword: '兴达', type: 'xingda' },
              { keyword: '湖州天猫', type: 'huzhou' }
          ],
          // 每种文件类型允许匹配的字段
          allowedFields: {
              hangzhouOuter: {
                  salesPersonField: true,
                  materialNameField: true,
                  quantityField: true,
                  // 以下字段不自动匹配（避免误把客户简称当门店）
                  storeField: false,
                  modelField: false,
                  // 可选字段
                  dateField: true,
                  orderNoField: true,
                  userNameField: true
              },
              xingda: {
                  salesPersonField: true,    // 匹配促销员
                  modelField: true,           // 匹配规格型号
                  quantityField: true,        // 数量必须匹配
                  // 以下字段不自动匹配
                  storeField: false,
                  materialNameField: false,
                  // 可选字段仍然允许匹配
                  dateField: true,
                  orderNoField: true,
                  userNameField: true
              },
              shengdu: {
                  salesPersonField: true,     // 匹配促销员
                  materialNameField: true,    // 匹配物料名称
                  quantityField: true,
                  // 以下字段不自动匹配
                  storeField: false,
                  modelField: false,
                  // 可选字段
                  dateField: true,
                  orderNoField: true,
                  userNameField: true
              },
              zheibei: {
                  // 全部匹配
                  salesPersonField: true,
                  storeField: true,
                  modelField: true,
                  materialNameField: true,
                  quantityField: true,
                  dateField: true,
                  orderNoField: true,
                  userNameField: true
              },
              jinhua: {
                  storeField: true,           // 匹配门店
                  materialNameField: true,    // 匹配物料名称
                  quantityField: true,
                  // 以下字段不自动匹配
                  salesPersonField: false,
                  modelField: false,
                  // 可选字段
                  dateField: true,
                  orderNoField: true,
                  userNameField: true
              },
          huzhou: {
              storeField: true,           // 门店名称
              materialNameField: true,    // 商品名称 -> 物料名称
              modelField: true,           // 具体型号 -> 规格型号
              quantityField: true,        // 实发数量 -> 销售数量
              // 以下字段不自动匹配
              salesPersonField: false,
              // 可选字段
              dateField: true,
              orderNoField: true,
              userNameField: true,
              regionField: true,          // 地区字段
              settlementField: true       // 是否结算字段
          }
          }
      };
      
      // 检测文件类型的函数
      function detectFileType(fileName) {
          for (const pattern of fileTypeConfig.patterns) {
              if (fileName.includes(pattern.keyword)) {
                  return pattern.type;
              }
          }
          return 'zheibei'; // 默认使用浙北规则（全匹配）
      }
      
      // 新增：标准化型号字符串的函数
      function normalizeModel(model) {
          if (!model) return '';
          return model.toString().trim().toUpperCase();
      }
      
      // 新增：从物料名称中提取规格型号
      function extractModelFromMaterialName(materialName) {
          if (!materialName) return '';
          
          // 策略1: 匹配 "型号：XXX" 格式（最高优先级）
          const pattern1 = /型号[：:]\s*([^\s,，]+)/;
          const match1 = materialName.match(pattern1);
          if (match1 && match1[1]) {
              return match1[1].trim().toUpperCase();
          }
          
          // 策略2: 全面的型号提取（支持各种复杂格式）
          // 先转换成大写用于匹配
          let upperName = materialName.toUpperCase();
          
          // 先把中文括号统一转为英文括号，方便处理
          upperName = upperName.replace(/（/g, '(').replace(/）/g, ')');
          
          // 定义需要排除的品牌关键词
          const brandKeywords = [
              'SMITH', 'A.O.SMITH', 'A.O', 'AO', 'AOSMITH',
              '史密斯', '电热水器', '燃气热水器', '热水器', '净水机', '净水器', '反渗透净水机',
              '油烟机', '灶具', '空气能热水器', '管线机'
          ];
          
          // 匹配型号模式：支持多种复杂格式
          // 1. 字母开头（1个或多个）
          // 2. 后面可以跟：数字、字母、连字符、小数点、括号、井号等
          // 3. 必须包含数字
          // 例如: CXW-400-S5CHWi, HPA-50D1.0Q, R3000AB1(WI), APM-HC1, JZT-V2B1S
          const pattern2 = /([A-Z]+[\-]?[A-Z0-9][\-A-Z0-9#.()\[\]]*[A-Z0-9])/g;
          const matches = upperName.match(pattern2);
          
          if (matches && matches.length > 0) {
              // 过滤掉品牌名和无效匹配
              const filtered = matches.filter(m => {
                  // 去除首尾空格
                  m = m.trim();
                  
                  // 长度检查：型号通常至少3个字符
                  if (m.length < 3) return false;
                  
                  // 必须包含数字
                  if (!/\d/.test(m)) return false;
                  
                  // 排除品牌关键词
                  for (const keyword of brandKeywords) {
                      const upperKeyword = keyword.toUpperCase().replace(/[.\-\s]/g, '');
                      const testMatch = m.replace(/[.\-\s]/g, '');
                      if (testMatch === upperKeyword || testMatch.includes(upperKeyword)) {
                          return false;
                      }
                  }
                  
                  // 排除单个字母+1-2位数字的简单组合（如 A1, O2, A12）
                  // 但允许更复杂的组合（如 R1700FWI, HC1）
                  if (/^[A-Z]\d{1,2}$/.test(m)) return false;
                  
                  // 型号长度合理性检查（通常3-25个字符）
                  if (m.length > 25) return false;
                  
                  return true;
              });
              
              if (filtered.length > 0) {
                  // 返回最长的匹配项（型号通常比较长且完整）
                  const longest = filtered.reduce((a, b) => a.length >= b.length ? a : b);
                  
                  // 清理提取的型号：处理括号
                  let cleaned = longest.trim();
                  
                  // 如果型号包含括号，保留括号内容
                  // 例如：R3000AB1(WI) 保持不变
                  
                  return cleaned;
              }
          }
          
          // 策略3: 专门匹配带连字符的简单型号（如 APM-HC1）
          // 匹配：字母 + 连字符 + 字母数字组合
          const pattern3 = /([A-Z]{2,}\-[A-Z0-9]+)/gi;
          const matches3 = upperName.match(pattern3);
          
          if (matches3 && matches3.length > 0) {
              const filtered3 = matches3.filter(m => {
                  m = m.trim();
                  if (m.length < 3) return false;
                  if (m.length > 25) return false;
                  
                  // 必须包含数字
                  if (!/\d/.test(m)) return false;
                  
                  // 排除品牌关键词
                  for (const keyword of brandKeywords) {
                      const upperKeyword = keyword.toUpperCase().replace(/[.\-\s]/g, '');
                      const testMatch = m.replace(/[.\-\s]/g, '');
                      if (testMatch === upperKeyword || testMatch.includes(upperKeyword)) {
                          return false;
                      }
                  }
                  return true;
              });
              
              if (filtered3.length > 0) {
                  // 返回最后一个匹配（通常型号在产品名称末尾）
                  return filtered3[filtered3.length - 1].trim();
              }
          }
          
          // 策略4: 如果还是没匹配到，返回空字符串（不返回原物料名称，避免污染）
          return '';
      }
      
      // 日期解析函数（兼容多种日期格式）
      function parseDate(dateValue) {
          if (!dateValue) return null;
          
          // 处理Excel序列号
          if (typeof dateValue === 'number') {
              const excelEpoch = new Date(1900, 0, 1);
              const date = new Date(excelEpoch.getTime() + (dateValue - 2) * 86400000);
              return date;
          }
          
          // 处理字符串日期
          const str = String(dateValue).trim();
          if (!str) return null;
          
          // 格式1: 2025/8/6 或 2025-09-01
          let match = str.match(/(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})/);
          if (match) {
              return new Date(parseInt(match[1]), parseInt(match[2]) - 1, parseInt(match[3]));
          }
          
          // 格式2: 2025年8月6日
          match = str.match(/(\d{4})年(\d{1,2})月(\d{1,2})日/);
          if (match) {
              return new Date(parseInt(match[1]), parseInt(match[2]) - 1, parseInt(match[3]));
          }
          
          // 尝试直接解析
          const date = new Date(dateValue);
          return isNaN(date.getTime()) ? null : date;
      }
      
      // 日期比较函数（只比较年月日，忽略时分秒）
      function compareDates(date1, date2) {
          if (!date1 || !date2) return null;
          const d1 = new Date(date1.getTime());
          const d2 = new Date(date2.getTime());
          d1.setHours(0, 0, 0, 0);
          d2.setHours(0, 0, 0, 0);
          return d1.getTime() - d2.getTime();
      }
      
      // 日期格式化函数（用于备注显示）
      function formatDate(date) {
          if (!date) return '';
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          return `${year}-${month}-${day}`;
      }
      
      // 显示加载状态
      function showLoading(text = '正在处理数据...', progressInfo = '') {
          document.getElementById('loadingText').textContent = text;
          document.getElementById('progressInfo').textContent = progressInfo;
          document.getElementById('loadingOverlay').style.display = 'flex';
      }
      
      function hideLoading() {
          document.getElementById('loadingOverlay').style.display = 'none';
      }
      
      // 更新进度条
      function updateProgress(current, total) {
          const percentage = Math.round((current / total) * 100);
          const progressFill = document.getElementById('progressFill');
          progressFill.style.width = percentage + '%';
          progressFill.textContent = percentage + '%';
          document.getElementById('overallProgress').textContent = `处理进度：${current}/${total} 个文件`;
      }
      
      // 文件上传处理
      function setupFileUpload() {
          const salesFilesInput = document.getElementById('salesFiles');
          const salesFileSingleInput = document.getElementById('salesFileSingle');
          const policyFile = document.getElementById('policyFile');
          const storeListFile = document.getElementById('storeListFile');
          const salesUpload = document.getElementById('salesUpload');
          const policyUpload = document.getElementById('policyUpload');
          const storeListUpload = document.getElementById('storeListUpload');
          
          // 销售数据文件上传（多文件）
          salesFilesInput.addEventListener('change', function(e) {
              handleMultipleFiles(Array.from(e.target.files));
              // 允许再次选择相同文件触发 change
              e.target.value = '';
          });

          // 销售数据文件上传（单文件追加）
          if (salesFileSingleInput) {
              salesFileSingleInput.addEventListener('change', function(e) {
                  if (e.target.files && e.target.files[0]) {
                      handleMultipleFiles([e.target.files[0]]);
                  }
                  e.target.value = '';
              });
          }
          
          // 政策表文件上传
          policyFile.addEventListener('change', function(e) {
              handlePolicyFile(e.target.files[0]);
          });
          
          // 渠道名单文件上传
          storeListFile.addEventListener('change', function(e) {
              handleStoreListFile(e.target.files[0]);
          });
          
          // 拖拽上传 - 销售数据
          salesUpload.addEventListener('dragover', function(e) {
              e.preventDefault();
              salesUpload.classList.add('dragover');
          });
          
          salesUpload.addEventListener('dragleave', function(e) {
              e.preventDefault();
              salesUpload.classList.remove('dragover');
          });
          
          salesUpload.addEventListener('drop', function(e) {
              e.preventDefault();
              salesUpload.classList.remove('dragover');
              const files = Array.from(e.dataTransfer.files);
              handleMultipleFiles(files);
          });
          
          // 拖拽上传 - 政策表
          policyUpload.addEventListener('dragover', function(e) {
              e.preventDefault();
              policyUpload.classList.add('dragover');
          });
          
          policyUpload.addEventListener('dragleave', function(e) {
              e.preventDefault();
              policyUpload.classList.remove('dragover');
          });
          
          policyUpload.addEventListener('drop', function(e) {
              e.preventDefault();
              policyUpload.classList.remove('dragover');
              const files = e.dataTransfer.files;
              if (files.length > 0) {
                  handlePolicyFile(files[0]);
              }
          });
          
          // 拖拽上传 - 渠道名单
          storeListUpload.addEventListener('dragover', function(e) {
              e.preventDefault();
              storeListUpload.classList.add('dragover');
          });
          
          storeListUpload.addEventListener('dragleave', function(e) {
              e.preventDefault();
              storeListUpload.classList.remove('dragover');
          });
          
          storeListUpload.addEventListener('drop', function(e) {
              e.preventDefault();
              storeListUpload.classList.remove('dragover');
              const files = e.dataTransfer.files;
              if (files.length > 0) {
                  handleStoreListFile(files[0]);
              }
          });
      }
      
      // 处理多个销售文件
      function handleMultipleFiles(files) {
          const startIndex = salesFiles.length;
          const existingKeys = new Set(salesFiles.map(f => getFileUniqueKey(f.file)));
          let skipped = 0;
          let rejected = 0;
          
          files.forEach(file => {
              const lowerName = (file.name || '').toLowerCase();
              if (lowerName.endsWith('.xlsx') || lowerName.endsWith('.xls')) {
                  const key = getFileUniqueKey(file);
                  if (existingKeys.has(key)) {
                      skipped++;
                      return;
                  }
                  existingKeys.add(key);
                  const fileObj = {
                      file: file,
                      name: file.name,
                      status: 'waiting',
                      workbook: null,
                      sheetName: null,
                      headers: null,
                      headerRowIndex: null,
                      preview: null,
                      data: null,
                      results: null,
                      // 新增：每文件字段映射与状态
                      fieldMapping: null,
                      mappingStatus: { complete: false, missingFields: [] },
                      isMappingOpen: false
                  };
                  salesFiles.push(fileObj);
              } else {
                  rejected++;
              }
          });
          
        updateFileList();
        
        // 显示"依次配置全部"按钮
        if (salesFiles.length > 1) {
            document.getElementById('configureAllBtn').style.display = 'inline-block';
        }
        
        // 只自动展开第一个新上传的文件，避免多文件并发导致DOM混乱
        // 其他文件需要用户手动点击展开配置
        const newFilesCount = salesFiles.length - startIndex;
        
        if (salesFiles.length === 1) {
            // 如果是第一个文件，自动展开
            setTimeout(() => {
                configureFileMapping(0);
            }, 100);
        } else if (startIndex < salesFiles.length) {
            // 如果是批量上传，只展开第一个新文件
            setTimeout(() => {
                configureFileMapping(startIndex);
            }, 100);
            
            // 如果上传了多个文件，给出提示
            if (newFilesCount > 1) {
                showSuccess(`已上传 ${newFilesCount} 个文件。正在自动配置第一个文件，其他文件请点击"依次配置全部"按钮或手动展开配置。`);
            }
        }

        if (skipped > 0) {
            showError(`已跳过 ${skipped} 个重复文件（同名/大小/修改时间一致）`);
        }

        if (rejected > 0) {
            showError(`有 ${rejected} 个文件格式不支持（仅支持 .xls / .xlsx）`);
        }
         
        checkCalculateReady();
      }
      
      // 更新文件列表显示
      function updateFileList() {
          const fileList = document.getElementById('fileList');
          fileList.innerHTML = '';

          if (salesFiles.length === 0) {
              fileList.innerHTML = `
                  <div class="file-list-empty">
                      <div>
                          <strong>还没有上传销售文件</strong>：支持一次性选择多个文件，或逐个追加。
                      </div>
                      <div style="display:flex;gap:10px;flex-wrap:wrap;">
                          <button class="mini-btn" onclick="document.getElementById('salesFiles').click()">选择多个文件</button>
                          <button class="mini-btn" onclick="document.getElementById('salesFileSingle').click()">追加一个文件</button>
                      </div>
                  </div>
              `;
              updateWorkflowStatus();
              return;
          }
          
          salesFiles.forEach((fileObj, index) => {
              const fileItem = document.createElement('div');
              fileItem.className = `file-item ${fileObj.status}`;
              
              // 计算映射状态文本
              const mappingStatus = (function() {
                  const required = fieldDefinitions.sales.required;
                  if (!fileObj.fieldMapping) {
                      return { text: '未配置字段映射', tooltip: '需要配置字段映射才能进行计算' };
                  }
                  
                  // 检查必填字段（支持二选一逻辑）
                  let missingFields = [];
                  
                  // 规格型号和物料名称二选一
                  const hasModel = fileObj.fieldMapping.modelField !== undefined && fileObj.fieldMapping.modelField !== '';
                  const hasMaterial = fileObj.fieldMapping.materialNameField !== undefined && fileObj.fieldMapping.materialNameField !== '';
                  if (!hasModel && !hasMaterial) {
                      missingFields.push('规格型号/物料名称');
                  }
                  
                  // 促销员和门店二选一
                  const hasSalesPerson = fileObj.fieldMapping.salesPersonField !== undefined && fileObj.fieldMapping.salesPersonField !== '';
                  const hasStore = fileObj.fieldMapping.storeField !== undefined && fileObj.fieldMapping.storeField !== '';
                  if (!hasSalesPerson && !hasStore) {
                      missingFields.push('促销员/门店');
                  }
                  
                  // 销售数量必填
                  if (fileObj.fieldMapping.quantityField === undefined || fileObj.fieldMapping.quantityField === '') {
                      missingFields.push('销售数量');
                  }
                  
                  if (missingFields.length === 0) {
                      return { text: '字段映射完整 ✓', tooltip: '所有必填字段已配置' };
                  } else {
                      return { text: `缺少字段: ${missingFields.join(', ')}`, tooltip: '部分必填字段未配置' };
                  }
              })();
              
              const fileType = detectFileType(fileObj.name);
              const typeLabels = {
                  xingda: '兴达',
                  shengdu: '圣都', 
                  zheibei: '浙北',
                  jinhua: '金华五星',
                  huzhou: '湖州天猫',
                  hangzhouOuter: '杭州外围'
              };
              const typeLabel = typeLabels[fileType] || '';
              
              fileItem.innerHTML = `
                  <div class="file-item-header">
                      <div class="file-info">
                          <span class="file-name" onclick="toggleMapping(${index})" title="点击展开/收起配置">📄 ${fileObj.name} ${typeLabel ? `<span style="font-size: 11px; color: #667eea; margin-left: 8px;">[${typeLabel}]</span>` : ''}</span>
                          <span class="file-status status-${fileObj.status}">
                              ${getStatusText(fileObj.status)}
                          </span>
                      </div>
                      <div class="file-actions">
                          <button class="file-toggle-btn" onclick="toggleMapping(${index})">${fileObj.isMappingOpen ? '⬆️ 收起' : '⬇️ 展开配置'}</button>
                          <button class="export-single-btn" id="export-${index}" 
                                  onclick="exportSingleResult(${index})"
                                  style="${fileObj.status === 'completed' ? 'display: inline-block;' : 'display: none;'}">
                              📥 导出
                          </button>
                          <button class="remove-btn" onclick="removeFile(${index})">🗑️ 移除</button>
                      </div>
                  </div>
                  <div class="sheet-selector" id="sheetSelector-${index}" style="${fileObj.isMappingOpen ? 'display: block; margin-top:8px;' : 'display: none; margin-top:8px;'}">
                      <label>选择工作表：</label>
                      <select id="sheetSelect-${index}"></select>
                      <span class="field-count" id="fieldCount-${index}"></span>
                  </div>
                  <div class="mapping-container" id="mappingContainer-${index}" style="${fileObj.isMappingOpen ? 'display:block;' : 'display:none;'}">
                      <h3>
                          字段映射 - ${fileObj.name}
                          <button class="auto-match-btn" onclick="autoMatchFileFields(${index})">🎯 智能匹配</button>
                      </h3>
                      <div class="import-preview" id="importPreview-${index}">
                          <div class="import-preview-header">
                              <div class="import-preview-meta" id="importMeta-${index}">
                                  <span class="chip warn">未解析</span>
                                  <span style="color:#64748b;">请先选择工作表</span>
                              </div>
                              <div class="header-row-selector">
                                  <span style="font-size:12px;color:#64748b;">表头行</span>
                                  <select id="headerRowSelect-${index}" onchange="changeHeaderRow(${index}, this.value)">
                                      <option value="auto">自动</option>
                                      ${Array.from({length: 20}, (_, i) => `<option value="${i}">第 ${i+1} 行</option>`).join('')}
                                  </select>
                              </div>
                          </div>
                          <div class="preview-table-wrap" id="previewWrap-${index}" style="display:none;">
                              <table class="preview-table" id="previewTable-${index}"></table>
                          </div>
                          <div class="preview-hint" id="previewHint-${index}">
                              <span>绿色表头 = 已被字段映射选中</span>
                              <span>建议检查：表头是否正确、必填字段是否都能匹配</span>
                          </div>
                      </div>
                      <div class="mapping-grid">
                          <div class="mapping-subtitle">必填字段（至少选择一个）</div>
                          <div class="mapping-row">
                              <label>促销员 <span style="color: #999; font-size: 12px;">（与门店二选一）</span></label>
                              <select id="salesPersonField-${index}">
                                  <option value="">请选择字段（可选）</option>
                              </select>
                              <span class="match-confidence" id="salesPersonField-${index}_confidence"></span>
                          </div>
                          <div class="mapping-row">
                              <label>门店 <span style="color: #999; font-size: 12px;">（与促销员二选一）</span></label>
                              <select id="storeField-${index}">
                                  <option value="">请选择字段（可选）</option>
                              </select>
                              <span class="match-confidence" id="storeField-${index}_confidence"></span>
                          </div>
                          <div style="grid-column: 1 / -1; padding: 10px; background: #fff3e0; border-radius: 6px; font-size: 12px; color: #e65100; margin-bottom: 8px;">
                              💡 <strong>提示：</strong>促销员和门店至少选择一个。有门店就根据门店匹配促销员，有促销员就根据促销员匹配门店。
                          </div>
                          <div class="mapping-row">
                              <label>销售数量 <span style="color: #f44336; font-size: 12px;">（必填）</span></label>
                              <select id="quantityField-${index}">
                                  <option value="">请选择字段</option>
                              </select>
                              <span class="match-confidence" id="quantityField-${index}_confidence"></span>
                          </div>
                          <div class="mapping-row">
                              <label>规格型号 <span style="color: #999; font-size: 12px;">（优先，与物料名称二选一）</span></label>
                              <select id="modelField-${index}">
                                  <option value="">请选择字段（可选）</option>
                              </select>
                              <span class="match-confidence" id="modelField-${index}_confidence"></span>
                          </div>
                          <div class="mapping-row">
                              <label>物料名称 <span style="color: #999; font-size: 12px;">（备用，自动提取型号）</span></label>
                              <select id="materialNameField-${index}">
                                  <option value="">请选择字段（可选）</option>
                              </select>
                              <span class="match-confidence" id="materialNameField-${index}_confidence"></span>
                          </div>
                          <div style="grid-column: 1 / -1; padding: 10px; background: #e3f2fd; border-radius: 6px; font-size: 12px; color: #1565c0; margin-bottom: 8px;">
                              💡 <strong>提示：</strong>规格型号和物料名称至少选择一个。优先使用规格型号；如果没有规格型号，系统会从物料名称中自动提取型号信息。
                          </div>
                          <div class="mapping-subtitle optional">可选字段</div>
                          ${Object.entries(fieldDefinitions.sales.optional).map(([fieldId, fieldDef]) => `
                              <div class="mapping-row">
                                  <label>${fieldDef.label}</label>
                                  <select id="${fieldId}-${index}">
                                      <option value="">请选择字段（可选）</option>
                                  </select>
                                  <span class="match-confidence" id="${fieldId}-${index}_confidence"></span>
                              </div>
                          `).join('')}
                          <div style="grid-column: 1 / -1; margin-top: 12px; padding: 12px; background: white; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                              <span id="mappingStatus-${index}" title="${mappingStatus.tooltip}" style="font-size: 14px; font-weight: 600; color: #2c3e50;">
                                  ${mappingStatus.text}
                              </span>
                              <button class="file-toggle-btn" onclick="completeAndCollapse(${index})">✓ 完成并收起</button>
                          </div>
                      </div>
                  </div>
              `;
              fileList.appendChild(fileItem);

              // 重要：updateFileList 会重建 DOM，需恢复已打开文件的工作表/字段选择器交互
              hydrateFileMappingUI(index);
          });

          updateWorkflowStatus();
        }

        function hydrateFileMappingUI(index) {
            const fileObj = salesFiles[index];
            if (!fileObj || !fileObj.isMappingOpen) return;

            const sheetSelect = document.getElementById(`sheetSelect-${index}`);
            if (sheetSelect) {
                if (fileObj.workbook && Array.isArray(fileObj.workbook.SheetNames)) {
                    sheetSelect.innerHTML = '<option value="">请选择工作表</option>';
                    fileObj.workbook.SheetNames.forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        sheetSelect.appendChild(option);
                    });
                    const selected = (fileObj.sheetName && fileObj.workbook.SheetNames.includes(fileObj.sheetName))
                        ? fileObj.sheetName
                        : (fileObj.workbook.SheetNames[0] || '');
                    if (selected) sheetSelect.value = selected;
                    sheetSelect.onchange = async function() {
                        if (this.value) {
                            await loadFileSheetHeaders(index, this.value);
                        }
                    };
                } else {
                    sheetSelect.innerHTML = '<option value="">请先读取文件</option>';
                }
            }

            const headerRowSelect = document.getElementById(`headerRowSelect-${index}`);
            if (headerRowSelect) {
                headerRowSelect.value = (fileObj.headerRowIndex === null || fileObj.headerRowIndex === undefined)
                    ? 'auto'
                    : String(fileObj.headerRowIndex);
            }

            if (fileObj.headers && Array.isArray(fileObj.headers) && fileObj.headers.length > 0) {
                const count = document.getElementById(`fieldCount-${index}`);
                if (count) count.textContent = `(${fileObj.headers.length} 个字段)`;
                populateFileFieldMapping(index, fileObj.headers);
            }

            renderFilePreview(index);
        }

        function scrollToSection(id) {
            const el = document.getElementById(id);
            if (!el) return;
            el.scrollIntoView({ behavior: 'smooth', block: 'start', inline: 'nearest' });
        }

        function setPolicyDetailsOpen(open) {
            uiSectionState.policyOpen = !!open;
            const details = document.getElementById('policyDetails');
            const summary = document.getElementById('policySummary');
            const toggleBtn = document.getElementById('policyToggleBtn');
            if (details) details.style.display = uiSectionState.policyOpen ? 'block' : 'none';
            if (summary) summary.style.display = 'flex';
            if (toggleBtn) toggleBtn.textContent = uiSectionState.policyOpen ? '收起' : '展开';
        }

        function setStoreListDetailsOpen(open) {
            uiSectionState.storeListOpen = !!open;
            const details = document.getElementById('storeListDetails');
            const summary = document.getElementById('storeListSummary');
            const toggleBtn = document.getElementById('storeListToggleBtn');
            if (details) details.style.display = uiSectionState.storeListOpen ? 'block' : 'none';
            if (summary) summary.style.display = 'flex';
            if (toggleBtn) toggleBtn.textContent = uiSectionState.storeListOpen ? '收起' : '展开';
        }

        function togglePolicyDetails() {
            uiSectionState.userToggledPolicy = true;
            setPolicyDetailsOpen(!uiSectionState.policyOpen);
        }

        function toggleStoreListDetails() {
            uiSectionState.userToggledStoreList = true;
            setStoreListDetailsOpen(!uiSectionState.storeListOpen);
        }

        function setPillState(el, state) {
            if (!el) return;
            el.classList.remove('done', 'warn');
            if (state === 'done') el.classList.add('done');
            if (state === 'warn') el.classList.add('warn');
        }

        function updateWorkflowStatus() {
            const salesCountEl = document.getElementById('metaSalesCount');
            const policyEl = document.getElementById('metaPolicy');
            const storeListEl = document.getElementById('metaStoreList');
            const readyEl = document.getElementById('metaReady');
            const actionHint = document.getElementById('actionHint');

            const salesCount = salesFiles.length;
            const salesReady = salesFiles.length > 0 && salesFiles.every(f => f.fieldMapping && f.mappingStatus && f.mappingStatus.complete);
            const policyReady = !!(policyData && document.getElementById('policyModelField')?.value !== '' && document.getElementById('commissionField')?.value !== '');
            const storeListReady = !!(storeListData && storeListData.headers && storeListData.headers.length > 0);
            const calcReady = salesReady && policyReady;

            if (salesCountEl) salesCountEl.textContent = String(salesCount);
            if (policyEl) policyEl.textContent = policyReady ? '已就绪' : '未就绪';
            if (storeListEl) storeListEl.textContent = storeListReady ? '已就绪' : '未就绪';
            if (readyEl) readyEl.textContent = calcReady ? '可开始计算' : '未满足计算条件';

            setPillState(document.getElementById('stepSales'), salesCount > 0 ? (salesReady ? 'done' : 'warn') : '');
            setPillState(document.getElementById('stepPolicy'), policyReady ? 'done' : 'warn');
            setPillState(document.getElementById('stepStoreList'), storeListReady ? 'done' : '');
            setPillState(document.getElementById('stepCalc'), calcReady ? 'done' : 'warn');

            if (actionHint) {
                if (calcReady) {
                    actionHint.textContent = '已满足计算条件，可以开始计算';
                } else if (!policyReady) {
                    actionHint.textContent = '请先配置政策表字段映射（规格型号/单台提成）';
                } else if (!salesReady) {
                    actionHint.textContent = '请完成所有销售文件的必填字段映射';
                } else {
                    actionHint.textContent = '请先上传并完成字段映射';
                }
            }

            const policySummaryText = document.getElementById('policySummaryText');
            const hasPolicyWorkbook = !!policyWorkbook;
            const policySheet = policyData?.sheetName || persistedPolicyState?.sheetName || '';
            if (policySummaryText) {
                if (hasPolicyWorkbook) {
                    const name = persistedPolicyState?.name ? `📄 ${persistedPolicyState.name}` : '📄 已加载政策表';
                    const readyText = policyReady ? '✅ 已就绪' : '⚠️ 未完成字段映射';
                    policySummaryText.innerHTML = `${name} <span>工作表：${policySheet || '未选择'} · ${readyText}</span>`;
                } else {
                    policySummaryText.textContent = '未上传政策表';
                }
            }
            if (hasPolicyWorkbook && !uiSectionState.userToggledPolicy && uiSectionState.policyOpen) {
                setPolicyDetailsOpen(false);
            }
            if (!hasPolicyWorkbook && !uiSectionState.userToggledPolicy) {
                setPolicyDetailsOpen(true);
            }

            const storeListSummaryText = document.getElementById('storeListSummaryText');
            const hasStoreListWorkbook = !!storeListWorkbook;
            const storeListSheet = storeListData?.sheetName || persistedStoreListState?.sheetName || '';
            if (storeListSummaryText) {
                if (hasStoreListWorkbook) {
                    const name = persistedStoreListState?.name ? `📄 ${persistedStoreListState.name}` : '📄 已加载渠道名单';
                    const readyText = storeListReady ? '✅ 已就绪' : '⚠️ 未选择工作表';
                    storeListSummaryText.innerHTML = `${name} <span>工作表：${storeListSheet || '未选择'} · ${readyText}</span>`;
                } else {
                    storeListSummaryText.textContent = '未上传渠道名单（可选）';
                }
            }
            if (hasStoreListWorkbook && !uiSectionState.userToggledStoreList && uiSectionState.storeListOpen) {
                setStoreListDetailsOpen(false);
            }
        }
        
        // 获取状态文本
        function getStatusText(status) {
            const statusMap = {
                'waiting': '等待处理',
                'processing': '处理中',
                'completed': '已完成',
                'error': '处理失败'
            };
            return statusMap[status] || status;
        }
        
        // 移除文件
        function removeFile(index) {
            salesFiles.splice(index, 1);
            updateFileList();
            checkCalculateReady();
            
            // 更新"依次配置全部"按钮显示
            if (salesFiles.length <= 1) {
                document.getElementById('configureAllBtn').style.display = 'none';
            }
            
            if (salesFiles.length === 0) {
                document.getElementById('fieldMappingSection').style.display = 'none';
                document.getElementById('results').style.display = 'none';
            }
        }
        
        // 切换展开/收起映射配置
        function toggleMapping(index) {
            const fileObj = salesFiles[index];
            if (!fileObj) return;
            
            // 如果正在批量配置，阻止手动操作
            if (isBatchConfiguring) {
                showError('正在批量配置中，请稍候...');
                return;
            }
            
            if (fileObj.isMappingOpen) {
                fileObj.isMappingOpen = false;
                updateFileList();
            } else {
                configureFileMapping(index);
                // 展开后滚动到可见区域，确保配置面板完整显示
                setTimeout(() => {
                    const fileItem = document.querySelector(`.file-item:nth-child(${index + 1})`);
                    if (fileItem) {
                        fileItem.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start',
                            inline: 'nearest'
                        });
                    }
                }, 450); // 等待动画完成
            }
        }
        
        // 完成并收起
        function completeAndCollapse(index) {
            updateFileFieldMapping(index);
            const fileObj = salesFiles[index];
            if (fileObj) {
                fileObj.isMappingOpen = false;
            }
            updateFileList();
            checkCalculateReady();
        }
        
        // 一键收起全部映射配置
        function collapseAllMappings() {
            salesFiles.forEach(f => f.isMappingOpen = false);
            updateFileList();
        }
        
        // 依次配置全部文件（避免并发冲突）
        async function configureAllFilesSequentially() {
            // 如果已经在批量配置中，直接返回
            if (isBatchConfiguring) {
                showError('正在批量配置中，请勿重复操作');
                return;
            }
            
            // 等待当前配置完成
            while (isConfiguringFile) {
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            // 设置批量配置标志
            isBatchConfiguring = true;
            
            try {
                showLoading('正在依次配置所有文件，请稍候...');
                
                for (let i = 0; i < salesFiles.length; i++) {
                    const fileObj = salesFiles[i];
                    // 如果文件尚未配置完成，则配置它
                    if (!fileObj.fieldMapping || !fileObj.mappingStatus || !fileObj.mappingStatus.complete) {
                        showLoading(`正在配置文件 ${i + 1}/${salesFiles.length}: ${fileObj.name}...`);
                        
                        // 等待配置完成（会自动设置和释放 isConfiguringFile）
                        await configureFileMapping(i);
                        
                        // 等待配置锁释放
                        while (isConfiguringFile) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                        }
                        
                        // 额外等待一段时间确保DOM更新完成
                        await new Promise(resolve => setTimeout(resolve, 200));
                    }
                }
                
                hideLoading();
                showSuccess('所有文件配置完成！');
                updateFileList();
                checkCalculateReady();
            } finally {
                // 确保无论如何都释放批量配置标志
                isBatchConfiguring = false;
            }
        }
        
        // 新增：打开并配置某文件的字段映射
        async function configureFileMapping(index) {
            const fileObj = salesFiles[index];
            if (!fileObj) return;
            
            // 防止并发配置：如果正在配置其他文件，则等待
            if (isConfiguringFile) {
                console.log(`文件 ${fileObj.name} 等待配置，当前有其他文件正在配置中...`);
                // 只展开面板，不立即加载
                fileObj.isMappingOpen = true;
                updateFileList();
                return;
            }
            
            // 设置配置中标志
            isConfiguringFile = true;
            
            // 保持面板展开状态
            fileObj.isMappingOpen = true;
            updateFileList();
            
            if (!fileObj.workbook) {
                showLoading(`正在读取文件 ${fileObj.name}...`);
                try {
                    const workbook = await readFileAsWorkbook(fileObj.file);
                    fileObj.workbook = workbook;
                    hideLoading();
                } catch (error) {
                    hideLoading();
                    showError(`文件读取失败：${error.message}`);
                    isConfiguringFile = false; // 释放锁
                    return;
                }
            }
            
            const sheetSelector = document.getElementById(`sheetSelector-${index}`);
            const sheetSelect = document.getElementById(`sheetSelect-${index}`);
            sheetSelect.innerHTML = '<option value="">请选择工作表</option>';
            fileObj.workbook.SheetNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                sheetSelect.appendChild(option);
            });
            
            // 优先使用之前选择的工作表
            if (fileObj.workbook.SheetNames.length > 0) {
                const defaultSheet = (fileObj.sheetName && fileObj.workbook.SheetNames.includes(fileObj.sheetName))
                  ? fileObj.sheetName
                  : fileObj.workbook.SheetNames[0];
                sheetSelect.value = defaultSheet;
                await loadFileSheetHeaders(index, defaultSheet);
            }
            
            sheetSelector.style.display = 'block';
            sheetSelect.onchange = async function() {
                if (this.value) {
                    await loadFileSheetHeaders(index, this.value);
                }
            };
            
            document.getElementById(`mappingContainer-${index}`).style.display = 'block';
            
            // 注意：isConfiguringFile 标志在 loadFileSheetHeaders 完成后释放
        }
        
        function readFileAsWorkbook(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const workbook = XLSX.read(e.target.result, {type: 'binary'});
                        resolve(workbook);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = function() { reject(new Error('文件读取失败')); };
                reader.readAsBinaryString(file);
            });
        }

        function getFileUniqueKey(file) {
            if (!file) return '';
            return `${file.name}__${file.size}__${file.lastModified || ''}`;
        }

        function escapeHtml(value) {
            return (value ?? '').toString()
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function clampNumber(value, min, max) {
            const n = Number(value);
            if (!Number.isFinite(n)) return min;
            return Math.min(max, Math.max(min, n));
        }

        function getWorksheetDimensions(worksheet) {
            if (!worksheet || !worksheet['!ref']) return { rows: 0, cols: 0, range: null };
            const range = XLSX.utils.decode_range(worksheet['!ref']);
            return { rows: range.e.r - range.s.r + 1, cols: range.e.c - range.s.c + 1, range };
        }

        function getEffectiveRangeFromCells(worksheet) {
            if (!worksheet) return { s: { r: 0, c: 0 }, e: { r: 0, c: 0 } };
            const base = worksheet['!ref']
                ? XLSX.utils.decode_range(worksheet['!ref'])
                : { s: { r: 0, c: 0 }, e: { r: 0, c: 0 } };
            let maxR = -1;
            let maxC = -1;
            for (const addr in worksheet) {
                if (!Object.prototype.hasOwnProperty.call(worksheet, addr)) continue;
                if (addr[0] === '!') continue;
                if (!/^[A-Z]+[0-9]+$/.test(addr)) continue;
                const cell = XLSX.utils.decode_cell(addr);
                if (cell.r > maxR) maxR = cell.r;
                if (cell.c > maxC) maxC = cell.c;
            }
            if (maxR < 0 || maxC < 0) return base;
            return { s: base.s, e: { r: maxR, c: maxC } };
        }

        function readWorksheetAOA(worksheet, maxRows = 60) {
            if (!worksheet || !worksheet['!ref']) return [];
            const range = getEffectiveRangeFromCells(worksheet);
            const limited = {
                s: range.s,
                e: { r: Math.min(range.s.r + maxRows - 1, range.e.r), c: range.e.c }
            };
            return XLSX.utils.sheet_to_json(worksheet, { header: 1, range: limited, defval: '', blankrows: false });
        }

        const persistedKeys = {
            policy: 'multiTable.persisted.policy.v1',
            storeList: 'multiTable.persisted.storeList.v1'
        };
        let persistedPolicyState = null;
        let persistedStoreListState = null;
        const uiSectionState = {
            policyOpen: true,
            storeListOpen: true,
            userToggledPolicy: false,
            userToggledStoreList: false
        };

        function arrayBufferToBase64(buffer) {
            const bytes = new Uint8Array(buffer);
            let binary = '';
            const chunkSize = 0x8000;
            for (let i = 0; i < bytes.length; i += chunkSize) {
                binary += String.fromCharCode.apply(null, bytes.subarray(i, i + chunkSize));
            }
            return btoa(binary);
        }

        function safeLocalStorageSet(key, value) {
            try {
                localStorage.setItem(key, value);
                return true;
            } catch (error) {
                console.warn('localStorage 写入失败:', key, error);
                return false;
            }
        }

        function safeLocalStorageGet(key) {
            try {
                return localStorage.getItem(key);
            } catch (error) {
                console.warn('localStorage 读取失败:', key, error);
                return null;
            }
        }

        function persistPolicyWorkbook(file, base64) {
            const payload = {
                name: file?.name || '',
                lastModified: file?.lastModified || 0,
                size: file?.size || 0,
                base64,
                sheetName: policyData?.sheetName || '',
                mapping: {
                    policyModelField: document.getElementById('policyModelField')?.value ?? '',
                    commissionField: document.getElementById('commissionField')?.value ?? ''
                }
            };
            persistedPolicyState = payload;
            safeLocalStorageSet(persistedKeys.policy, JSON.stringify(payload));
        }

        function persistPolicySheetAndMapping() {
            const raw = safeLocalStorageGet(persistedKeys.policy);
            if (!raw) return;
            try {
                const payload = JSON.parse(raw);
                payload.sheetName = policyData?.sheetName || payload.sheetName || '';
                payload.mapping = {
                    policyModelField: document.getElementById('policyModelField')?.value ?? '',
                    commissionField: document.getElementById('commissionField')?.value ?? ''
                };
                persistedPolicyState = payload;
                safeLocalStorageSet(persistedKeys.policy, JSON.stringify(payload));
            } catch (_) {}
        }

        function applyPersistedPolicyMapping() {
            const payload = persistedPolicyState;
            if (!payload || !payload.mapping) return;
            const m = payload.mapping;
            const a = document.getElementById('policyModelField');
            const b = document.getElementById('commissionField');
            if (a && m.policyModelField !== '') a.value = m.policyModelField;
            if (b && m.commissionField !== '') b.value = m.commissionField;
        }

        function persistStoreListWorkbook(file, base64) {
            const payload = {
                name: file?.name || '',
                lastModified: file?.lastModified || 0,
                size: file?.size || 0,
                base64,
                sheetName: storeListData?.sheetName || '',
                mapping: {}
            };
            const storeListFields = ['departmentField', 'storeNameField', 'employeeNameField', 'employeeName2Field', 'employeeName1JoinDateField', 'employeeName2JoinDateField', 'employeeName1LeaveDateField', 'employeeName2LeaveDateField'];
            storeListFields.forEach(id => payload.mapping[id] = document.getElementById(id)?.value ?? '');
            persistedStoreListState = payload;
            safeLocalStorageSet(persistedKeys.storeList, JSON.stringify(payload));
        }

        function persistStoreListSheetAndMapping() {
            const raw = safeLocalStorageGet(persistedKeys.storeList);
            if (!raw) return;
            try {
                const payload = JSON.parse(raw);
                payload.sheetName = storeListData?.sheetName || payload.sheetName || '';
                const storeListFields = ['departmentField', 'storeNameField', 'employeeNameField', 'employeeName2Field', 'employeeName1JoinDateField', 'employeeName2JoinDateField', 'employeeName1LeaveDateField', 'employeeName2LeaveDateField'];
                payload.mapping = payload.mapping || {};
                storeListFields.forEach(id => payload.mapping[id] = document.getElementById(id)?.value ?? '');
                persistedStoreListState = payload;
                safeLocalStorageSet(persistedKeys.storeList, JSON.stringify(payload));
            } catch (_) {}
        }

        function applyPersistedStoreListMapping() {
            const payload = persistedStoreListState;
            if (!payload || !payload.mapping) return;
            Object.entries(payload.mapping).forEach(([id, value]) => {
                const el = document.getElementById(id);
                if (el && value !== '') el.value = value;
            });
        }

        function restorePersistedWorkbook(type) {
            const key = type === 'policy' ? persistedKeys.policy : persistedKeys.storeList;
            const raw = safeLocalStorageGet(key);
            if (!raw) return;
            try {
                const payload = JSON.parse(raw);
                if (!payload || !payload.base64) return;
                const workbook = XLSX.read(payload.base64, { type: 'base64' });
                if (type === 'policy') {
                    persistedPolicyState = payload;
                    policyWorkbook = workbook;
                    populateSheetSelector('policySheetSelect', workbook, 'policy');
                    document.getElementById('policySheetSelector').style.display = 'block';
                    const select = document.getElementById('policySheetSelect');
                    const sheet = payload.sheetName && workbook.SheetNames.includes(payload.sheetName) ? payload.sheetName : workbook.SheetNames[0];
                    if (select && sheet) select.value = sheet;
                    if (sheet) loadPolicySheetHeaders(workbook, sheet);
                    updateWorkflowStatus();
                    if (!uiSectionState.userToggledPolicy) setPolicyDetailsOpen(false);
                } else {
                    persistedStoreListState = payload;
                    storeListWorkbook = workbook;
                    populateSheetSelector('storeListSheetSelect', workbook, 'storeList');
                    document.getElementById('storeListSheetSelector').style.display = 'block';
                    const select = document.getElementById('storeListSheetSelect');
                    const sheet = payload.sheetName && workbook.SheetNames.includes(payload.sheetName) ? payload.sheetName : workbook.SheetNames[0];
                    if (select && sheet) select.value = sheet;
                    if (sheet) loadStoreListSheetHeaders(workbook, sheet);
                    updateWorkflowStatus();
                    if (!uiSectionState.userToggledStoreList) setStoreListDetailsOpen(false);
                }
            } catch (error) {
                console.warn('恢复缓存失败:', type, error);
            }
        }

        function bindPersistMappingListeners() {
            const policyFields = ['policyModelField', 'commissionField'];
            policyFields.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('change', persistPolicySheetAndMapping);
            });

            const storeListFields = ['departmentField', 'storeNameField', 'employeeNameField', 'employeeName2Field', 'employeeName1JoinDateField', 'employeeName2JoinDateField', 'employeeName1LeaveDateField', 'employeeName2LeaveDateField'];
            storeListFields.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('change', persistStoreListSheetAndMapping);
            });

            const policySheetSelect = document.getElementById('policySheetSelect');
            if (policySheetSelect) policySheetSelect.addEventListener('change', persistPolicySheetAndMapping);
            const storeListSheetSelect = document.getElementById('storeListSheetSelect');
            if (storeListSheetSelect) storeListSheetSelect.addEventListener('change', persistStoreListSheetAndMapping);
        }

        function detectHeaderRowIndex(aoa, maxScanRows = 20) {
            const scan = aoa.slice(0, maxScanRows);
            let bestRow = 0;
            let bestScore = -1;
            scan.forEach((row, idx) => {
                if (!Array.isArray(row)) return;
                let nonEmpty = 0;
                let stringish = 0;
                row.forEach(cell => {
                    const v = (cell ?? '').toString().trim();
                    if (v !== '') {
                        nonEmpty++;
                        if (/[A-Z\u4e00-\u9fa5]/i.test(v)) stringish++;
                    }
                });
                const score = nonEmpty * 2 + stringish - idx * 0.05;
                if (score > bestScore) {
                    bestScore = score;
                    bestRow = idx;
                }
            });
            return bestRow;
        }

        function buildPreviewInfo(worksheet, headerRowIndexOverride) {
            const effectiveRange = getEffectiveRangeFromCells(worksheet);
            const totalRows = effectiveRange.e.r - effectiveRange.s.r + 1;
            const totalCols = effectiveRange.e.c - effectiveRange.s.c + 1;
            const aoa = readWorksheetAOA(worksheet, 80);
            const detectedHeaderRow = detectHeaderRowIndex(aoa, 20);
            const headerRowIndex = headerRowIndexOverride === null || headerRowIndexOverride === undefined
                ? detectedHeaderRow
                : clampNumber(headerRowIndexOverride, 0, Math.max(0, aoa.length - 1));
            const headers = (aoa[headerRowIndex] || []).map(h => (h ?? '').toString().trim());
            const sampleRows = aoa.slice(headerRowIndex + 1, headerRowIndex + 6);
            return { totalRows, totalCols, headerRowIndex, detectedHeaderRow, headers, sampleRows };
        }

        function getMatchedColumnIndexes(fileObj) {
            const matched = new Set();
            if (!fileObj || !fileObj.fieldMapping) return matched;
            Object.values(fileObj.fieldMapping).forEach(v => {
                const n = Number(v);
                if (Number.isFinite(n) && n >= 0) matched.add(n);
            });
            return matched;
        }

        function renderFilePreview(index) {
            const fileObj = salesFiles[index];
            if (!fileObj) return;
            const metaEl = document.getElementById(`importMeta-${index}`);
            const tableEl = document.getElementById(`previewTable-${index}`);
            const wrapEl = document.getElementById(`previewWrap-${index}`);
            if (!metaEl || !tableEl || !wrapEl) return;

            const preview = fileObj.preview;
            if (!preview || !fileObj.workbook || !fileObj.sheetName) {
                metaEl.innerHTML = `<span class="chip warn">未解析</span><span style="color:#64748b;">请先选择工作表</span>`;
                wrapEl.style.display = 'none';
                tableEl.innerHTML = '';
                return;
            }

            const requiredMissing = (fileObj.mappingStatus && fileObj.mappingStatus.missingFields) ? fileObj.mappingStatus.missingFields : [];
            const isMappingOk = !!(fileObj.mappingStatus && fileObj.mappingStatus.complete);
            const headers = preview.headers || [];
            const hasHeaders = headers.some(h => (h ?? '').toString().trim() !== '');
            const chipClass = !hasHeaders ? 'err' : (isMappingOk ? 'ok' : (requiredMissing.length > 0 ? 'err' : 'warn'));
            const chipText = !hasHeaders ? '未检测到表头' : (isMappingOk ? '字段匹配完成' : (requiredMissing.length > 0 ? '字段缺失' : '待确认'));

            const headerRowHuman = (preview.headerRowIndex ?? 0) + 1;
            const detectedHint = (preview.detectedHeaderRow !== preview.headerRowIndex)
                ? `（自动建议第 ${preview.detectedHeaderRow + 1} 行）`
                : '';

            metaEl.innerHTML = `
                <span class="chip ${chipClass}">${chipText}</span>
                <span class="chip">工作表：${escapeHtml(fileObj.sheetName)}</span>
                <span class="chip">行数：${preview.totalRows}</span>
                <span class="chip">列数：${preview.totalCols}</span>
                <span class="chip">表头行：第 ${headerRowHuman} 行${escapeHtml(detectedHint)}</span>
                ${requiredMissing.length ? `<span class="chip err" title="缺失字段">${escapeHtml(requiredMissing.join('、'))}</span>` : ''}
            `;

            const matchedCols = getMatchedColumnIndexes(fileObj);
            const rows = preview.sampleRows || [];

            if (!hasHeaders) {
                wrapEl.style.display = 'none';
                tableEl.innerHTML = '';
                return;
            }

            const ths = headers.map((h, idx) => `<th class="${matchedCols.has(idx) ? 'matched' : ''}" title="${escapeHtml(h || `列${idx + 1}`)}">${escapeHtml(h || `列${idx + 1}`)}</th>`).join('');
            const body = rows.map(r => {
                const row = Array.isArray(r) ? r : [];
                const tds = headers.map((_, idx) => `<td title="${escapeHtml(row[idx])}">${escapeHtml(row[idx])}</td>`).join('');
                return `<tr>${tds}</tr>`;
            }).join('');

            tableEl.innerHTML = `<thead><tr>${ths}</tr></thead><tbody>${body || `<tr><td colspan="${Math.max(1, headers.length)}" style="color:#64748b;">（表头下没有可预览的数据行）</td></tr>`}</tbody>`;
            wrapEl.style.display = 'block';
        }

        async function refreshFilePreviewFromWorksheet(index) {
            const fileObj = salesFiles[index];
            if (!fileObj || !fileObj.workbook || !fileObj.sheetName) return;
            const worksheet = fileObj.workbook.Sheets[fileObj.sheetName];
            if (!worksheet) return;
            fileObj.preview = buildPreviewInfo(worksheet, fileObj.headerRowIndex);
            fileObj.headers = fileObj.preview.headers;
            renderFilePreview(index);
        }

        async function changeHeaderRow(index, value) {
            const fileObj = salesFiles[index];
            if (!fileObj) return;
            if (value === 'auto') {
                fileObj.headerRowIndex = null;
            } else {
                fileObj.headerRowIndex = clampNumber(value, 0, 9999);
            }
            await refreshFilePreviewFromWorksheet(index);
            if (fileObj.headers) {
                populateFileFieldMapping(index, fileObj.headers);
                autoMatchFileFields(index, true);
                updateFileFieldMapping(index);
            }
        }
        
      async function loadFileSheetHeaders(index, sheetName) {
          const fileObj = salesFiles[index];
          if (!fileObj || !fileObj.workbook) return;
          
          showLoading(`正在解析工作表 ${sheetName}...`);
          setTimeout(() => {
              try {
                  const worksheet = fileObj.workbook.Sheets[sheetName];
                  const preview = buildPreviewInfo(worksheet, fileObj.headerRowIndex);
                  const headers = preview.headers;
                  fileObj.sheetName = sheetName;
                  fileObj.headers = headers;
                  fileObj.preview = preview;
                  const count = document.getElementById(`fieldCount-${index}`);
                  if (count) count.textContent = `(${headers.length} 个字段)`;
                  populateFileFieldMapping(index, headers);
                  hideLoading();
                  
                  // 自动执行字段匹配
                  autoMatchFileFields(index, true);

                  const headerRowSelect = document.getElementById(`headerRowSelect-${index}`);
                  if (headerRowSelect) {
                      headerRowSelect.value = (fileObj.headerRowIndex === null || fileObj.headerRowIndex === undefined)
                          ? 'auto'
                          : String(fileObj.headerRowIndex);
                  }
                  renderFilePreview(index);
                  
                  // 释放配置锁
                  isConfiguringFile = false;
                  
                  showSuccess(`已加载工作表 ${sheetName} 的表头并完成自动匹配`);
              } catch (error) {
                  showError('工作表数据加载失败：' + error.message);
                  hideLoading();
                  // 释放配置锁
                  isConfiguringFile = false;
              }
          }, 100);
      }
        
        function populateFileFieldMapping(index, headers) {
            const allFields = { ...fieldDefinitions.sales.required, ...fieldDefinitions.sales.optional };
            Object.keys(allFields).forEach(fieldId => {
                const select = document.getElementById(`${fieldId}-${index}`);
                if (select) {
                    select.innerHTML = '<option value="">请选择字段</option>';
                    headers.forEach((header, headerIndex) => {
                        const option = document.createElement('option');
                        option.value = headerIndex;
                        option.textContent = header || `列${headerIndex + 1}`;
                        select.appendChild(option);
                    });
                    // 还原之前的映射选择
                    const existingMapping = salesFiles[index] && salesFiles[index].fieldMapping
                      ? salesFiles[index].fieldMapping[fieldId]
                      : undefined;
                    if (existingMapping !== undefined) {
                        select.value = existingMapping;
                    }
                    select.addEventListener('change', () => {
                        updateFileFieldMapping(index);
                        checkCalculateReady();
                    });
                }
            });
        }
        
        function updateFileFieldMapping(index) {
            const fileObj = salesFiles[index];
            if (!fileObj) return;
            
            const requiredFields = fieldDefinitions.sales.required;
            const optionalFields = fieldDefinitions.sales.optional;
            fileObj.fieldMapping = {};
            let missingFields = [];
            
            // 读取所有字段的值
            Object.keys(requiredFields).forEach(fieldId => {
                const select = document.getElementById(`${fieldId}-${index}`);
                if (select && select.value !== '') {
                    fileObj.fieldMapping[fieldId] = parseInt(select.value);
                }
            });
            
            Object.keys(optionalFields).forEach(fieldId => {
                const select = document.getElementById(`${fieldId}-${index}`);
                if (select && select.value !== '') {
                    fileObj.fieldMapping[fieldId] = parseInt(select.value);
                }
            });
            
            // 验证必填字段（支持二选一逻辑）
            
            // 规格型号和物料名称二选一
            const hasModel = fileObj.fieldMapping.modelField !== undefined && fileObj.fieldMapping.modelField !== '';
            const hasMaterial = fileObj.fieldMapping.materialNameField !== undefined && fileObj.fieldMapping.materialNameField !== '';
            if (!hasModel && !hasMaterial) {
                missingFields.push('规格型号/物料名称');
            }
            
            // 促销员和门店二选一
            const hasSalesPerson = fileObj.fieldMapping.salesPersonField !== undefined && fileObj.fieldMapping.salesPersonField !== '';
            const hasStore = fileObj.fieldMapping.storeField !== undefined && fileObj.fieldMapping.storeField !== '';
            if (!hasSalesPerson && !hasStore) {
                missingFields.push('促销员/门店');
            }
            
            // 销售数量必填
            if (!fileObj.fieldMapping.quantityField && fileObj.fieldMapping.quantityField !== 0) {
                missingFields.push('销售数量');
            }
            
            fileObj.mappingStatus = { complete: missingFields.length === 0, missingFields: missingFields };
            
            // 就地更新状态提示，避免重绘列表导致面板关闭
            const statusSpan = document.getElementById(`mappingStatus-${index}`);
            if (statusSpan) {
                if (missingFields.length === 0) {
                    statusSpan.textContent = '字段映射完整 ✓';
                    statusSpan.title = '所有必填字段已配置';
                } else {
                    statusSpan.textContent = `缺少字段: ${missingFields.join(', ')}`;
                    statusSpan.title = '部分必填字段未配置';
                }
            }

            // 同步导入预览区域（表头高亮 + 缺失字段提示）
            renderFilePreview(index);
        }
        
      function autoMatchFileFields(index, silent = false) {
          const fileObj = salesFiles[index];
          if (!fileObj || !fileObj.headers || fileObj.headers.length === 0) {
              if (!silent) showError('请先选择工作表并确保工作表有表头数据');
              return;
          }
          
          // 检测文件类型
          const fileType = detectFileType(fileObj.name);
          const allowedFields = fileTypeConfig.allowedFields[fileType];
          
          if (!silent) showLoading('正在进行智能字段匹配...');
          
          setTimeout(() => {
              const allFields = { ...fieldDefinitions.sales.required, ...fieldDefinitions.sales.optional };
              let matchCount = 0;
              const usedColumns = new Set(); // 记录已使用的列，避免重复匹配
              
              // 按字段重要性排序（必填字段优先）
              const sortedFields = Object.entries(allFields).sort((a, b) => {
                  const aRequired = fieldDefinitions.sales.required[a[0]] !== undefined;
                  const bRequired = fieldDefinitions.sales.required[b[0]] !== undefined;
                  if (aRequired && !bRequired) return -1;
                  if (!aRequired && bRequired) return 1;
                  return 0;
              });
              
              sortedFields.forEach(([fieldId, fieldDef]) => {
                  // 检查该字段是否允许自动匹配
                  if (allowedFields && allowedFields[fieldId] === false) {
                      // 跳过不允许匹配的字段
                      const confidenceSpan = document.getElementById(`${fieldId}-${index}_confidence`);
                      if (confidenceSpan) {
                          confidenceSpan.style.display = 'none';
                      }
                      return; // 跳过此字段
                  }
                  
                  const keywords = fieldDef.keywords;
                  let bestMatch = -1;
                  let bestScore = 0;
                  
                  fileObj.headers.forEach((header, headerIndex) => {
                      if (!header) return;
                      // 如果这一列已经被匹配过，跳过（除非是二选一字段）
                      if (usedColumns.has(headerIndex)) return;
                      
                      keywords.forEach(keyword => {
                          const score = calculateSimilarity(header, keyword);
                          // 提高阈值从0.3到0.5，减少误匹配
                          if (score > bestScore && score > 0.5) {
                              bestScore = score;
                              bestMatch = headerIndex;
                          }
                      });
                  });
                  
                  const select = document.getElementById(`${fieldId}-${index}`);
                  const confidenceSpan = document.getElementById(`${fieldId}-${index}_confidence`);
                  
                  if (bestMatch !== -1 && select) {
                      select.value = bestMatch;
                      usedColumns.add(bestMatch); // 标记这一列已被使用
                      matchCount++;
                      
                      if (confidenceSpan) {
                          let cls = 'confidence-low';
                          let txt = '低';
                          if (bestScore > 0.8) { cls = 'confidence-high'; txt = '高'; }
                          else if (bestScore > 0.6) { cls = 'confidence-medium'; txt = '中'; }
                          confidenceSpan.className = `match-confidence ${cls}`;
                          confidenceSpan.textContent = `${txt} (${Math.round(bestScore * 100)}%)`;
                          confidenceSpan.style.display = 'inline-block';
                      }
                  } else if (confidenceSpan) {
                      confidenceSpan.style.display = 'none';
                  }
              });
              
              updateFileFieldMapping(index);
              checkCalculateReady();
              
              if (!silent) {
                  hideLoading();
                  if (matchCount > 0) {
                      showSuccess(`智能匹配完成！成功匹配 ${matchCount} 个字段`);
                  } else {
                      showError('未能自动匹配到任何字段，请手动配置字段映射');
                  }
              }
          }, silent ? 50 : 500);
      }
      
      // 加载第一个文件的表头用于字段映射
      async function loadFirstFileHeaders() {
          if (salesFiles.length === 0) return;
          
          showLoading('正在读取第一个文件的表头...');
          
          const firstFile = salesFiles[0];
          const reader = new FileReader();
          
          reader.onload = function(e) {
              try {
                  const workbook = XLSX.read(e.target.result, {type: 'binary'});
                  firstFile.workbook = workbook;
                  
                  // 默认使用第一个工作表
                  const sheetName = workbook.SheetNames[0];
                  firstFile.sheetName = sheetName;
                  
                  const worksheet = workbook.Sheets[sheetName];
                  const headers = getWorksheetHeaders(worksheet);
                  firstFile.headers = headers;
                  
                  // 填充字段映射选择器
                  populateSalesFieldMapping(headers);
                  
                  hideLoading();
                  showSuccess('已加载第一个文件的表头用于字段映射');
                  
              } catch (error) {
                  showError('文件读取失败：' + error.message);
                  hideLoading();
              }
          };
          
          reader.readAsBinaryString(firstFile.file);
      }
      
      // 获取工作表表头
      function getWorksheetHeaders(worksheet) {
          if (!worksheet['!ref']) return [];
          
          const range = XLSX.utils.decode_range(worksheet['!ref']);
          const headerRange = {
              s: range.s,
              e: { r: range.s.r, c: range.e.c }
            };
            
            const headerData = XLSX.utils.sheet_to_json(worksheet, {
                header: 1,
                range: headerRange
            });
            
            return headerData[0] || [];
        }
        
        // 填充销售数据字段映射
        function populateSalesFieldMapping(headers) {
            const fields = ['dateField', 'orderNoField', 'userNameField', 'customerField', 
                          'salesPersonField', 'materialNameField', 'modelField', 'quantityField'];
            
            fields.forEach(fieldId => {
                const select = document.getElementById(fieldId);
                if (select) {
                    select.innerHTML = '<option value="">请选择字段</option>';
                    headers.forEach((header, index) => {
                        const option = document.createElement('option');
                        option.value = index;
                        option.textContent = header || `列${index + 1}`;
                        select.appendChild(option);
                    });
                    
                    select.addEventListener('change', checkCalculateReady);
                }
            });
        }
        
      // 处理政策文件
      function handlePolicyFile(file) {
          if (!file) return;
          
          showLoading('正在读取政策文件...');
          
          const reader = new FileReader();
          reader.onload = function(e) {
              try {
                    const base64 = arrayBufferToBase64(e.target.result);
                    const workbook = XLSX.read(base64, { type: 'base64' });
                    policyWorkbook = workbook;
                    
                    populateSheetSelector('policySheetSelect', workbook, 'policy');
                    document.getElementById('policySheetSelector').style.display = 'block';
                    persistPolicyWorkbook(file, base64);
                    updateWorkflowStatus();
                    
                    showSuccess('政策表上传成功！');
                    hideLoading();
                    
                } catch (error) {
                    showError('文件读取失败：' + error.message);
                    hideLoading();
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
      // 填充工作表选择器
      function populateSheetSelector(selectId, workbook, type) {
          const select = document.getElementById(selectId);
          select.innerHTML = '<option value="">请选择工作表</option>';
          
          workbook.SheetNames.forEach(name => {
              const option = document.createElement('option');
              option.value = name;
              option.textContent = name;
              select.appendChild(option);
          });
          
          // 避免重复绑定 change 事件（多次上传/恢复会导致回调叠加）
          select.onchange = function() {
              if (this.value) {
                  if (type === 'policy') {
                      loadPolicySheetHeaders(workbook, this.value);
                  } else if (type === 'storeList') {
                      loadStoreListSheetHeaders(workbook, this.value);
                  }
              }
          };
      }
        
      // 加载政策表表头
      function loadPolicySheetHeaders(workbook, sheetName) {
          showLoading('正在解析政策表表头...');
          
          setTimeout(() => {
              try {
                  const worksheet = workbook.Sheets[sheetName];
                  const headers = getWorksheetHeaders(worksheet);
                  
                  policyData = {
                      headers: headers,
                      worksheet: worksheet,
                      sheetName: sheetName
                  };
                  
                  // 填充政策表字段映射
                  const policyFields = ['policyModelField', 'commissionField'];
                  
                  policyFields.forEach(fieldId => {
                      const select = document.getElementById(fieldId);
                      if (select) {
                          select.innerHTML = '<option value="">请选择字段</option>';
                          headers.forEach((header, index) => {
                              const option = document.createElement('option');
                              option.value = index;
                              option.textContent = header || `列${index + 1}`;
                              select.appendChild(option);
                          });
                          
                          select.addEventListener('change', checkCalculateReady);
                      }
                  });
                  
                  document.getElementById('policyMapping').style.display = 'block';
                  document.getElementById('policyFieldCount').textContent = `(${headers.length} 个字段)`;
                  
                  hideLoading();
                  
                  // 自动执行字段匹配
                  autoMatchFields('policy', true);

                  // 恢复上次字段映射（如果存在）
                  applyPersistedPolicyMapping();
                  persistPolicySheetAndMapping();
                  
                  showSuccess('已加载政策表表头并完成自动匹配');
                  checkCalculateReady();
                  updateWorkflowStatus();
                  
              } catch (error) {
                  showError('工作表数据加载失败：' + error.message);
                  hideLoading();
              }
          }, 100);
      }
        
      // 字符串相似度计算（改进版：提高精准度）
      function calculateSimilarity(str1, str2) {
          if (!str1 || !str2) return 0;
          
          // 清洗字符串：去除空格、连字符、下划线、括号等特殊字符
          const clean = (s) => s.replace(/[\s\-_()（）]/g, '').toLowerCase().trim();
          const cleaned1 = clean(str1);
          const cleaned2 = clean(str2);
          
          // 完全匹配（最高优先级）
          if (cleaned1 === cleaned2) return 1.0;
          
          // 精确包含检测（高优先级）
          if (cleaned1.includes(cleaned2) || cleaned2.includes(cleaned1)) {
              const longer = cleaned1.length > cleaned2.length ? cleaned1 : cleaned2;
              const shorter = cleaned1.length > cleaned2.length ? cleaned2 : cleaned1;
              // 如果短词占长词的比例很高，得分也高
              return 0.85 + (shorter.length / longer.length) * 0.1;
          }
          
          // 原有的编辑距离算法（作为兜底）
          const longer = cleaned1.length > cleaned2.length ? cleaned1 : cleaned2;
          const shorter = cleaned1.length > cleaned2.length ? cleaned2 : cleaned1;
          
          if (longer.length === 0) return 1.0;
          
          const editDistance = levenshteinDistance(longer, shorter);
          return (longer.length - editDistance) / longer.length;
      }
        
        function levenshteinDistance(str1, str2) {
            const matrix = [];
            
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[str2.length][str1.length];
        }
        
        // 从第一个文件智能匹配字段
        function autoMatchFieldsFromFirstFile() {
            if (salesFiles.length === 0 || !salesFiles[0].headers) {
                showError('请先上传销售数据文件');
                return;
            }
            
            const rules = fieldMatchRules.sales;
            const headers = salesFiles[0].headers;
            
            showLoading('正在进行智能字段匹配...');
            
            setTimeout(() => {
                let matchCount = 0;
                
                Object.keys(rules).forEach(fieldId => {
                    const keywords = rules[fieldId];
                    let bestMatch = -1;
                    let bestScore = 0;
                    
                    headers.forEach((header, index) => {
                        if (!header) return;
                        
                        keywords.forEach(keyword => {
                            const score = calculateSimilarity(header, keyword);
                            if (score > bestScore && score > 0.3) {
                                bestScore = score;
                                bestMatch = index;
                            }
                        });
                    });
                    
                    const select = document.getElementById(fieldId);
                    const confidenceSpan = document.getElementById(fieldId + '_confidence');
                    
                    if (bestMatch !== -1 && select) {
                        select.value = bestMatch;
                        matchCount++;
                        
                        if (confidenceSpan) {
                            let confidenceClass = 'confidence-low';
                            let confidenceText = '低';
                            
                            if (bestScore > 0.8) {
                                confidenceClass = 'confidence-high';
                                confidenceText = '高';
                            } else if (bestScore > 0.6) {
                                confidenceClass = 'confidence-medium';
                                confidenceText = '中';
                            }
                            
                            confidenceSpan.className = `match-confidence ${confidenceClass}`;
                            confidenceSpan.textContent = `${confidenceText} (${Math.round(bestScore * 100)}%)`;
                            confidenceSpan.style.display = 'inline-block';
                        }
                    } else if (confidenceSpan) {
                        confidenceSpan.style.display = 'none';
                    }
                });
                
                checkCalculateReady();
                hideLoading();
                showSuccess(`智能匹配完成！成功匹配 ${matchCount} 个字段`);
            }, 500);
        }
        
      // 处理渠道名单文件
      function handleStoreListFile(file) {
          if (!file) return;
          
          showLoading('正在读取渠道名单文件...');
          
          const reader = new FileReader();
          reader.onload = function(e) {
              try {
                  const base64 = arrayBufferToBase64(e.target.result);
                  const workbook = XLSX.read(base64, { type: 'base64' });
                  storeListWorkbook = workbook;
                  
                  populateSheetSelector('storeListSheetSelect', workbook, 'storeList');
                  document.getElementById('storeListSheetSelector').style.display = 'block';
                  persistStoreListWorkbook(file, base64);
                  updateWorkflowStatus();
                  
                  showSuccess('渠道名单上传成功！');
                  hideLoading();
                  
              } catch (error) {
                  showError('文件读取失败：' + error.message);
                  hideLoading();
              }
          };
          reader.readAsArrayBuffer(file);
      }
      
      // 加载渠道名单表头
      function loadStoreListSheetHeaders(workbook, sheetName) {
          showLoading('正在解析渠道名单表头...');
          
          setTimeout(() => {
              try {
                  const worksheet = workbook.Sheets[sheetName];
                  const headers = getWorksheetHeaders(worksheet);
                  
                  storeListData = {
                      headers: headers,
                      worksheet: worksheet,
                      sheetName: sheetName
                  };
                  
              // 填充渠道名单字段映射
              const storeListFields = ['departmentField', 'storeNameField', 'employeeNameField', 'employeeName2Field', 'employeeName1JoinDateField', 'employeeName2JoinDateField', 'employeeName1LeaveDateField', 'employeeName2LeaveDateField'];
              
              storeListFields.forEach(fieldId => {
                      const select = document.getElementById(fieldId);
                      if (select) {
                          select.innerHTML = '<option value="">请选择字段</option>';
                          headers.forEach((header, index) => {
                              const option = document.createElement('option');
                              option.value = index;
                              option.textContent = header || `列${index + 1}`;
                              select.appendChild(option);
                          });
                          
                          select.addEventListener('change', checkCalculateReady);
                      }
                  });
                  
                  document.getElementById('storeListMapping').style.display = 'block';
                  document.getElementById('storeListFieldCount').textContent = `(${headers.length} 个字段)`;
                  
                  hideLoading();
                  
                  // 自动执行字段匹配
                  autoMatchFields('storeList', true);

                  // 恢复上次字段映射（如果存在）
                  applyPersistedStoreListMapping();
                  persistStoreListSheetAndMapping();
                  
                  showSuccess('已加载渠道名单表头并完成自动匹配');
                  checkCalculateReady();
                  updateWorkflowStatus();
                  
              } catch (error) {
                  showError('工作表数据加载失败：' + error.message);
                  hideLoading();
              }
          }, 100);
      }
      
      // 智能匹配政策表字段
      function autoMatchFields(type, silent = false) {
          if (type === 'policy') {
              if (!policyData || !policyData.headers) {
                  if (!silent) showError('请先选择政策表工作表');
                  return;
              }
              const rules = fieldMatchRules.policy;
              const headers = policyData.headers;
            
            if (!silent) showLoading('正在进行智能字段匹配...');
            
            setTimeout(() => {
                let matchCount = 0;
                const usedColumns = new Set();
                
                Object.keys(rules).forEach(fieldId => {
                    const keywords = rules[fieldId];
                    let bestMatch = -1;
                    let bestScore = 0;
                    
                    headers.forEach((header, index) => {
                        if (!header) return;
                        if (usedColumns.has(index)) return;
                        
                        keywords.forEach(keyword => {
                            const score = calculateSimilarity(header, keyword);
                            // 提高阈值从0.3到0.5
                            if (score > bestScore && score > 0.5) {
                                bestScore = score;
                                bestMatch = index;
                            }
                        });
                    });
                    
                    const select = document.getElementById(fieldId);
                    const confidenceSpan = document.getElementById(fieldId + '_confidence');
                    
                    if (bestMatch !== -1 && select) {
                        select.value = bestMatch;
                        usedColumns.add(bestMatch);
                        matchCount++;
                        
                        if (confidenceSpan) {
                            let confidenceClass = 'confidence-low';
                            let confidenceText = '低';
                            
                            if (bestScore > 0.8) {
                                confidenceClass = 'confidence-high';
                                confidenceText = '高';
                            } else if (bestScore > 0.6) {
                                confidenceClass = 'confidence-medium';
                                confidenceText = '中';
                            }
                            
                            confidenceSpan.className = `match-confidence ${confidenceClass}`;
                            confidenceSpan.textContent = `${confidenceText} (${Math.round(bestScore * 100)}%)`;
                            confidenceSpan.style.display = 'inline-block';
                        }
                    } else if (confidenceSpan) {
                        confidenceSpan.style.display = 'none';
                    }
                });
                
                checkCalculateReady();
                
                if (!silent) {
                    hideLoading();
                    if (matchCount > 0) {
                        showSuccess(`智能匹配完成！成功匹配 ${matchCount} 个字段`);
                    }
                }
            }, silent ? 50 : 500);
          } else if (type === 'storeList') {
              if (!storeListData || !storeListData.headers) {
                  if (!silent) showError('请先选择渠道名单工作表');
                  return;
              }
              const rules = fieldMatchRules.storeList;
              const headers = storeListData.headers;
              
              if (!silent) showLoading('正在进行智能字段匹配...');
              
              setTimeout(() => {
                  let matchCount = 0;
                  const usedColumns = new Set();
                  
                  Object.keys(rules).forEach(fieldId => {
                      const keywords = rules[fieldId];
                      let bestMatch = -1;
                      let bestScore = 0;
                      
                      headers.forEach((header, index) => {
                          if (!header) return;
                          if (usedColumns.has(index)) return;
                          
                          keywords.forEach(keyword => {
                              const score = calculateSimilarity(header, keyword);
                              // 提高阈值从0.3到0.5
                              if (score > bestScore && score > 0.5) {
                                  bestScore = score;
                                  bestMatch = index;
                              }
                          });
                      });
                      
                      const select = document.getElementById(fieldId);
                      const confidenceSpan = document.getElementById(fieldId + '_confidence');
                      
                      if (bestMatch !== -1 && select) {
                          select.value = bestMatch;
                          usedColumns.add(bestMatch);
                          matchCount++;
                          
                          if (confidenceSpan) {
                              let confidenceClass = 'confidence-low';
                              let confidenceText = '低';
                              
                              if (bestScore > 0.8) {
                                  confidenceClass = 'confidence-high';
                                  confidenceText = '高';
                              } else if (bestScore > 0.6) {
                                  confidenceClass = 'confidence-medium';
                                  confidenceText = '中';
                              }
                              
                              confidenceSpan.className = `match-confidence ${confidenceClass}`;
                              confidenceSpan.textContent = `${confidenceText} (${Math.round(bestScore * 100)}%)`;
                              confidenceSpan.style.display = 'inline-block';
                          }
                      } else if (confidenceSpan) {
                          confidenceSpan.style.display = 'none';
                      }
                  });
                  
                  checkCalculateReady();
                  
                  if (!silent) {
                      hideLoading();
                      if (matchCount > 0) {
                          showSuccess(`智能匹配完成！成功匹配 ${matchCount} 个字段`);
                      }
                  }
              }, silent ? 50 : 500);
          }
        }
        
      // 检查是否可以开始计算
      function checkCalculateReady() {
          const salesReady = salesFiles.length > 0 && salesFiles.every(f => f.fieldMapping && f.mappingStatus && f.mappingStatus.complete);
          const policyReady = policyData && 
              document.getElementById('policyModelField').value !== '' && 
              document.getElementById('commissionField').value !== '';
          document.getElementById('calculateBtn').disabled = !(salesReady && policyReady);
          updateWorkflowStatus();
      }
        
        // 批量计算所有文件的提成
        async function calculateAllCommissions() {
            const calculateBtn = document.getElementById('calculateBtn');
            try {
                if (salesFiles.length === 0) {
                    showError('请上传销售数据文件');
                    return;
                }

                if (calculateBtn) calculateBtn.disabled = true;
                
                // 仅保存政策表字段映射
                fieldMapping = {
                    policy: {
                        model: parseInt(document.getElementById('policyModelField').value),
                        commission: parseInt(document.getElementById('commissionField').value)
                    }
                };
                
                document.getElementById('progressContainer').style.display = 'block';
                showLoading('正在读取政策数据...');
                const policyMap = await readPolicyData();
                
                for (let i = 0; i < salesFiles.length; i++) {
                    const fileObj = salesFiles[i];
                    fileObj.status = 'processing';
                    updateFileList();
                    updateProgress(i, salesFiles.length);
                    try {
                        await processFile(fileObj, policyMap, i);
                        fileObj.status = 'completed';
                    } catch (error) {
                        fileObj.status = 'error';
                        console.error(`处理文件 ${fileObj.name} 时出错:`, error);
                    }
                    updateFileList();
                    // 让 UI 有机会刷新，避免长任务“像卡死”
                    await new Promise(r => setTimeout(r, 0));
                }
                
                updateProgress(salesFiles.length, salesFiles.length);
                showSuccess('所有文件处理完成！');
                displayAllResults();
            } catch (error) {
                console.error('批量计算发生未捕获错误:', error);
                showError(`计算失败：${error && error.message ? error.message : error}`);
            } finally {
                hideLoading();
                checkCalculateReady();
                updateWorkflowStatus();
            }
        }
        
        // 修改：读取政策数据，使用大小写不敏感匹配
        async function readPolicyData() {
            return new Promise((resolve) => {
                const worksheet = policyData.worksheet;
                const effectiveRange = getEffectiveRangeFromCells(worksheet);
                const data = XLSX.utils.sheet_to_json(worksheet, { header: 1, range: effectiveRange, blankrows: false, defval: '' });
                
                const policyMap = new Map();
                const modelCol = fieldMapping.policy.model;
                const commissionCol = fieldMapping.policy.commission;
                
                // 新增：调试信息收集
                const debugInfo = {
                    totalPolicyRecords: data.length - 1,
                    validPolicyRecords: 0,
                    policyModels: []
                };
                
                for (let i = 1; i < data.length; i++) {
                    const row = data[i];
                    const originalModel = row[modelCol];
                    const commission = parseFloat(row[commissionCol]) || 0;
                    
                    if (originalModel) {
                        const normalizedModel = normalizeModel(originalModel);
                        policyMap.set(normalizedModel, commission);
                        
                        debugInfo.validPolicyRecords++;
                        debugInfo.policyModels.push({
                            original: originalModel,
                            normalized: normalizedModel,
                            commission: commission
                        });
                    }
                }
                
                // 保存调试信息
                matchingDebugInfo.policy = debugInfo;
                
                console.log('政策数据读取完成:', debugInfo);
                resolve(policyMap);
            });
        }
        
                // 修改：处理单个文件，使用大小写不敏感匹配
        async function processFile(fileObj, policyMap, fileIndex) {
            return new Promise((resolve, reject) => {
                showLoading(`正在处理文件 ${fileObj.name}...`, `第 ${fileIndex + 1}/${salesFiles.length} 个文件`);
                
                // 检测文件类型
                const fileType = detectFileType(fileObj.name);
                const isXingdaFile = fileType === 'xingda';
                const isShengduFile = fileType === 'shengdu';
                const isHuzhouFile = fileType === 'huzhou';
                
                // 门店名称标准化映射（将不同名称的同一家店统一）
                const storeNameNormalizationMap = {
                    '京东电器城市旗舰店金华商城店': '京东电器城市旗舰店金华商城店',
                    '金华五星江南店': '京东电器城市旗舰店金华商城店'
                };
                
                // 标准化门店名称
                function normalizeStoreName(storeName) {
                    return storeNameNormalizationMap[storeName] || storeName;
                }
                
            // 建立门店和部门到员工的映射（用于通过门店/部门查找促销员）
            const storeToEmployeesMap = {};  // 门店 -> [员工列表]
            const departmentToEmployeesMap = {};  // 部门 -> [员工列表]
            const employeeToStoreMap = {};  // 员工 -> 门店（用于通过员工查找门店）
            const employeeJoinDateMap = {};  // 员工 -> 入职日期
            const employeeLeaveDateMap = {}; // 员工 -> 离职日期
            
            if (storeListData && storeListData.worksheet) {
                const departmentCol = parseInt(document.getElementById('departmentField').value);
                const storeNameCol = parseInt(document.getElementById('storeNameField').value);
                const employeeNameCol = parseInt(document.getElementById('employeeNameField').value);
                const employeeName2Col = parseInt(document.getElementById('employeeName2Field').value);
                const employeeName1JoinDateCol = parseInt(document.getElementById('employeeName1JoinDateField').value);
                const employeeName2JoinDateCol = parseInt(document.getElementById('employeeName2JoinDateField').value);
                const employeeName1LeaveDateCol = parseInt(document.getElementById('employeeName1LeaveDateField').value);
                const employeeName2LeaveDateCol = parseInt(document.getElementById('employeeName2LeaveDateField').value);
                    
                    const effectiveRange = getEffectiveRangeFromCells(storeListData.worksheet);
                    const storeData = XLSX.utils.sheet_to_json(storeListData.worksheet, { header: 1, range: effectiveRange, blankrows: false, defval: '' });
                    for (let i = 1; i < storeData.length; i++) {
                        const storeRow = storeData[i];
                        const storeName = storeRow[storeNameCol];
                        const department = storeRow[departmentCol];
                        
                    // 处理导购人员 1
                    const employeeName = storeRow[employeeNameCol];
                    if (employeeName && storeName) {
                        if (!storeToEmployeesMap[storeName]) {
                            storeToEmployeesMap[storeName] = [];
                        }
                        storeToEmployeesMap[storeName].push(employeeName);
                        // 建立员工到门店的映射
                        employeeToStoreMap[employeeName] = normalizeStoreName(storeName);
                    }
                    if (employeeName && department) {
                        if (!departmentToEmployeesMap[department]) {
                            departmentToEmployeesMap[department] = [];
                        }
                        departmentToEmployeesMap[department].push(employeeName);
                    }
                    // 读取导购人员1的入职日期
                    if (employeeName && !isNaN(employeeName1JoinDateCol)) {
                        const joinDateValue = storeRow[employeeName1JoinDateCol];
                        if (joinDateValue) {
                            employeeJoinDateMap[employeeName] = parseDate(joinDateValue);
                        }
                    }
                    // 读取导购人员1的离职日期
                    if (employeeName && !isNaN(employeeName1LeaveDateCol)) {
                        const leaveDateValue = storeRow[employeeName1LeaveDateCol];
                        if (leaveDateValue) {
                            employeeLeaveDateMap[employeeName] = parseDate(leaveDateValue);
                        }
                    }
                    
                    // 处理导购人员 2
                    const employeeName2 = storeRow[employeeName2Col];
                    if (employeeName2 && storeName) {
                        if (!storeToEmployeesMap[storeName]) {
                            storeToEmployeesMap[storeName] = [];
                        }
                        storeToEmployeesMap[storeName].push(employeeName2);
                        // 建立员工到门店的映射
                        employeeToStoreMap[employeeName2] = normalizeStoreName(storeName);
                    }
                    if (employeeName2 && department) {
                        if (!departmentToEmployeesMap[department]) {
                            departmentToEmployeesMap[department] = [];
                        }
                        departmentToEmployeesMap[department].push(employeeName2);
                    }
                    // 读取导购人员2的入职日期
                    if (employeeName2 && !isNaN(employeeName2JoinDateCol)) {
                        const joinDateValue = storeRow[employeeName2JoinDateCol];
                        if (joinDateValue) {
                            employeeJoinDateMap[employeeName2] = parseDate(joinDateValue);
                        }
                    }
                    // 读取导购人员2的离职日期
                    if (employeeName2 && !isNaN(employeeName2LeaveDateCol)) {
                        const leaveDateValue = storeRow[employeeName2LeaveDateCol];
                        if (leaveDateValue) {
                            employeeLeaveDateMap[employeeName2] = parseDate(leaveDateValue);
                        }
                    }
                    }
                }
                
                if (!fileObj.workbook) {
                    // 需要先读取文件
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const workbook = XLSX.read(e.target.result, {type: 'binary'});
                            fileObj.workbook = workbook;
                            fileObj.sheetName = workbook.SheetNames[0];
                            processWorkbook();
                        } catch (error) {
                            reject(error);
                        }
                    };
                    reader.readAsBinaryString(fileObj.file);
                } else {
                    processWorkbook();
                }
                
                function processWorkbook() {
                    const worksheet = fileObj.workbook.Sheets[fileObj.sheetName];
                    const effectiveRange = getEffectiveRangeFromCells(worksheet);
                    const data = XLSX.utils.sheet_to_json(worksheet, { header: 1, range: effectiveRange, blankrows: false, defval: '' });
                    
                    const results = [];
                    let totalCommission = 0;
                    
                    const fileDebugInfo = {
                        fileName: fileObj.name,
                        totalRecords: data.length - 1,
                        processedRecords: 0,
                        matchedRecords: 0,
                        unmatchedRecords: 0,
                        unmatchedModels: new Set(),
                        matchDetails: [],
                        storeMatchedCount: 0,  // 通过门店匹配到促销员的数量
                        departmentMatchedCount: 0  // 通过部门匹配到促销员的数量
                    };
                    
                    const salesMap = fileObj.fieldMapping || {};
                    const modelCol = salesMap.modelField;
                    const materialCol = salesMap.materialNameField;
                    const quantityCol = salesMap.quantityField;
                    
                    for (let i = 1; i < data.length; i++) {
                        const row = data[i];
                        const quantity = parseFloat(row[quantityCol]) || 0;
                        
                        fileDebugInfo.processedRecords++;
                        
                        // 获取促销员和门店信息
                        let salesPerson = salesMap.salesPersonField !== undefined ? (row[salesMap.salesPersonField] || '') : '';
                        let store = salesMap.storeField !== undefined ? (row[salesMap.storeField] || '') : '';
                        let matchSource = ''; // 记录促销员来源
                        
                        // ===== 特殊处理：兴达文件直接设置为杭州临平兴达门店的巩建勋 =====
                        if (isXingdaFile) {
                            store = '杭州临平兴达';
                            salesPerson = '巩建勋';
                            matchSource = 'xingda_special';
                    } else if (isShengduFile) {
                        // ===== 特殊处理：圣都文件直接设置为杭州圣都门店的曾兴容 =====
                        store = '杭州圣都';
                        salesPerson = '曾兴容';
                        matchSource = 'shengdu_special';
                    } else if (isHuzhouFile) {
                        // ===== 特殊处理：湖州天猫店文件直接设置为湖州天猫店的陈春艳 =====
                        // 兼容不同版本表结构：若用户有映射到筛选字段且字段有值，则按条件过滤；否则默认不过滤
                        const rawStore = salesMap.storeField !== undefined ? (row[salesMap.storeField] || '') : '';
                        const rawRegion = salesMap.regionField !== undefined ? (row[salesMap.regionField] || '') : '';
                        const rawSettlement = salesMap.settlementField !== undefined ? (row[salesMap.settlementField] || '') : '';
                        const shouldApplyFilter = !!(rawStore || rawRegion || rawSettlement);
                        
                        if (shouldApplyFilter) {
                            const allowedStores = [
                                '湖州天猫优品优悠家生活馆',
                                '湖州天猫优品优悠家城市旗舰店',
                                '湖州天猫优品优悠家超级旗舰店',
                                '湖州金蝶零售'
                            ];
                            if ((rawStore && !allowedStores.includes(rawStore)) || (rawRegion && rawRegion !== '湖州') || (rawSettlement && rawSettlement !== '是')) {
                                fileDebugInfo.processedRecords--;
                                continue;
                            }
                        }

                        store = '湖州天猫店';
                        salesPerson = '陈春艳';
                        matchSource = 'huzhou_special';
                    } else {
                        // ===== 原有逻辑：过滤掉促销员和门店都为空的记录，以及促销员为"制表：胡利民"的记录 =====
                        if ((!salesPerson && !store) || salesPerson === '制表：胡利民') {
                            // 跳过这条记录，不参与计算
                            fileDebugInfo.processedRecords--; // 减少计数
                            continue;
                        }
                    }
                        
                        // 标准化门店名称（将不同名称的同一家店合并）
                        if (store) {
                            store = normalizeStoreName(store);
                        }
                        
                        // ===== 新增：有促销员但门店为空时，匹配门店 =====
                        if (salesPerson && !store) {
                            // 从映射中查找该促销员对应的门店
                            if (employeeToStoreMap[salesPerson]) {
                                store = employeeToStoreMap[salesPerson];
                                matchSource = 'employee_to_store';
                            }
                        }
                        
                        // ===== 原有逻辑：如果有门店但没有促销员，尝试通过门店或部门匹配促销员 =====
                        if (store && !salesPerson) {
                            // 特殊处理：京东电器城市旗舰店金华商城店 -> 叶黄鹤
                            if (store === '京东电器城市旗舰店金华商城店') {
                                salesPerson = '叶黄鹤';
                                matchSource = 'special';
                                fileDebugInfo.storeMatchedCount++;
                            }
                            // 第一步：先通过门店匹配
                            else if (storeToEmployeesMap[store] && storeToEmployeesMap[store].length > 0) {
                                // 如果该门店有多个员工，取第一个（或者可以改成取全部）
                                salesPerson = storeToEmployeesMap[store][0];
                                matchSource = 'store';
                                fileDebugInfo.storeMatchedCount++;
                            } else {
                                // 第二步：如果门店没匹配上，尝试通过部门匹配
                                // 需要先找出这个门店对应的部门（从员工表中查找）
                                // 这里简化处理：直接尝试用门店名作为部门名去匹配
                                if (departmentToEmployeesMap[store] && departmentToEmployeesMap[store].length > 0) {
                                    salesPerson = departmentToEmployeesMap[store][0];
                                    matchSource = 'department';
                                    fileDebugInfo.departmentMatchedCount++;
                                }
                            }
                        }
                        
                    // 过滤掉无效记录：销售数量=0
                    if (quantity === 0) {
                        fileDebugInfo.processedRecords--; // 减少计数
                        continue;
                    }

                    // 优先使用规格型号，如果没有则从物料名称中提取
                    let originalModel = '';
                    let extractedFrom = '';
                    
                    if (modelCol !== undefined && row[modelCol]) {
                        originalModel = row[modelCol];
                        extractedFrom = 'model';
                    } else if (materialCol !== undefined && row[materialCol]) {
                        originalModel = extractModelFromMaterialName(row[materialCol]);
                        extractedFrom = 'material';
                    }
                    
                    const normalizedModel = normalizeModel(originalModel);
                    const unitCommission = policyMap.get(normalizedModel) || 0;
                    const totalItemCommission = unitCommission * quantity;
                    totalCommission += totalItemCommission;
                    
                    const isMatched = unitCommission > 0;
                    if (isMatched) {
                        fileDebugInfo.matchedRecords++;
                    } else {
                        fileDebugInfo.unmatchedRecords++;
                        if (originalModel) fileDebugInfo.unmatchedModels.add(originalModel);
                    }
                    
                    // 检查在职期间过滤
                    let remark = ''; // 备注字段
                    let effectiveCommission = totalItemCommission; // 有效提成
                    
                    if (salesPerson && (employeeJoinDateMap[salesPerson] || employeeLeaveDateMap[salesPerson])) {
                        const orderDate = salesMap.dateField !== undefined ? parseDate(row[salesMap.dateField]) : null;
                        
                        if (!orderDate) {
                            remark = '缺少日期信息';
                        } else {
                            const joinDate = employeeJoinDateMap[salesPerson];
                            const leaveDate = employeeLeaveDateMap[salesPerson];
                            
                            // 判断是否在职期间
                            let isBeforeJoin = false;
                            let isAfterLeave = false;
                            
                            if (joinDate) {
                                const comparisonJoin = compareDates(orderDate, joinDate);
                                if (comparisonJoin !== null && comparisonJoin < 0) {
                                    isBeforeJoin = true;
                                }
                            }
                            
                            if (leaveDate) {
                                const comparisonLeave = compareDates(orderDate, leaveDate);
                                if (comparisonLeave !== null && comparisonLeave > 0) {
                                    isAfterLeave = true;
                                }
                            }
                            
                            // 设置备注和有效提成
                            if (isBeforeJoin && isAfterLeave) {
                                effectiveCommission = 0;
                                remark = '非在职期订单（入职前且离职后）';
                            } else if (isBeforeJoin) {
                                effectiveCommission = 0;
                                remark = '入职前订单';
                            } else if (isAfterLeave) {
                                effectiveCommission = 0;
                                remark = '离职后订单';
                            } else if (joinDate && leaveDate) {
                                // 在职期间
                                remark = `在职期订单（${formatDate(joinDate)}-${formatDate(leaveDate)}）`;
                            } else if (joinDate) {
                                remark = `入职后订单（${formatDate(joinDate)}起）`;
                            } else if (leaveDate) {
                                remark = `离职前订单（${formatDate(leaveDate)}止）`;
                            }
                        }
                    }
                    
                    results.push({
                        date: salesMap.dateField !== undefined ? (row[salesMap.dateField] || '') : '',
                        orderNo: salesMap.orderNoField !== undefined ? (row[salesMap.orderNoField] || '') : '',
                        userName: salesMap.userNameField !== undefined ? (row[salesMap.userNameField] || '') : '',
                        store: store,
                        salesPerson: salesPerson,
                        salesPersonSource: matchSource || (salesPerson ? 'direct' : ''), // 记录促销员来源
                        materialName: salesMap.materialNameField !== undefined ? (row[salesMap.materialNameField] || '') : '',
                        model: originalModel || '',
                        modelSource: extractedFrom, // 记录型号来源
                        quantity: quantity,
                        unitCommission: unitCommission,
                        totalCommission: totalItemCommission,
                        effectiveCommission: effectiveCommission, // 有效提成（考虑入职日期）
                        isMatched: isMatched,
                        normalizedModel: normalizedModel,
                        remark: remark // 备注（入职前订单/缺少日期信息）
                    });
                    }
                    
                    fileObj.results = {
                        data: results,
                        totalCommission: totalCommission,
                        recordCount: results.length,
                        debugInfo: fileDebugInfo
                    };
                    
                    allResults[fileObj.name] = fileObj.results;
                    matchingDebugInfo[fileObj.name] = fileDebugInfo;
                    
                    console.log(`文件 ${fileObj.name} 处理完成:`, fileDebugInfo);
                    resolve();
                }
            });
        }
        
        // 修改：显示所有结果，包含调试信息
        function displayAllResults() {
            const resultsDiv = document.getElementById('results');
            const tabsDiv = document.getElementById('resultsTabs');
            const contentDiv = document.getElementById('resultsContent');
            
            // 清空现有内容
            tabsDiv.innerHTML = '';
            contentDiv.innerHTML = '';
            
            // 创建汇总标签
            const summaryTab = document.createElement('button');
            summaryTab.className = 'tab active';
            summaryTab.textContent = '汇总';
            summaryTab.onclick = () => showTab('summary');
            tabsDiv.appendChild(summaryTab);
            
            // 创建员工汇总标签
            const employeeSummaryTab = document.createElement('button');
            employeeSummaryTab.className = 'tab';
            employeeSummaryTab.textContent = '员工汇总表';
            employeeSummaryTab.onclick = () => showTab('employee-summary');
            tabsDiv.appendChild(employeeSummaryTab);
            
            // 创建调试信息标签
            const debugTab = document.createElement('button');
            debugTab.className = 'tab';
            debugTab.textContent = '匹配分析';
            debugTab.onclick = () => showTab('debug');
            tabsDiv.appendChild(debugTab);
            
            // 创建汇总内容
            const summaryContent = document.createElement('div');
            summaryContent.id = 'tab-summary';
            summaryContent.className = 'tab-content active';
            
            let totalRecords = 0;
            let grandTotalCommission = 0;
            let totalMatched = 0;
            let totalUnmatched = 0;
            
            Object.values(allResults).forEach(result => {
                totalRecords += result.recordCount;
                grandTotalCommission += result.totalCommission;
                if (result.debugInfo) {
                    totalMatched += result.debugInfo.matchedRecords;
                    totalUnmatched += result.debugInfo.unmatchedRecords;
                }
            });
            
            const matchRate = totalRecords > 0 ? ((totalMatched / totalRecords) * 100).toFixed(1) : '0.0';
            
            summaryContent.innerHTML = `
                <div class="summary">
                    <h3>📊 总体汇总</h3>
                    <p>处理文件数：${salesFiles.length} 个</p>
                    <p>总记录数：${totalRecords} 条</p>
                    <p>匹配成功：${totalMatched} 条 (${matchRate}%)</p>
                    <p>未匹配：${totalUnmatched} 条</p>
                    <p>总提成金额：¥${grandTotalCommission.toFixed(2)}</p>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>文件名</th>
                            <th>记录数</th>
                            <th>匹配成功</th>
                            <th>匹配率</th>
                            <th>总提成</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.entries(allResults).map(([fileName, result]) => {
                            const fileMatchRate = result.debugInfo ? 
                                (result.debugInfo.processedRecords > 0 ? ((result.debugInfo.matchedRecords / result.debugInfo.processedRecords) * 100).toFixed(1) : '0.0') : '0.0';
                            return `
                                <tr>
                                    <td>${fileName}</td>
                                    <td>${result.recordCount}</td>
                                    <td>${result.debugInfo ? result.debugInfo.matchedRecords : 0}</td>
                                    <td>${fileMatchRate}%</td>
                                    <td>¥${result.totalCommission.toFixed(2)}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            contentDiv.appendChild(summaryContent);
            
            // 创建员工汇总内容
            const employeeSummaryContent = document.createElement('div');
            employeeSummaryContent.id = 'tab-employee-summary';
            employeeSummaryContent.className = 'tab-content';
            employeeSummaryContent.innerHTML = generateEmployeeSummaryHTML();
            contentDiv.appendChild(employeeSummaryContent);
            
            // 创建调试信息内容
            const debugContent = document.createElement('div');
            debugContent.id = 'tab-debug';
            debugContent.className = 'tab-content';
            debugContent.innerHTML = generateDebugInfoHTML();
            contentDiv.appendChild(debugContent);
            
            // 为每个文件创建标签和内容
            salesFiles.forEach((fileObj, index) => {
                if (fileObj.results) {
                    // 创建标签
                    const tab = document.createElement('button');
                    tab.className = 'tab';
                    tab.textContent = fileObj.name;
                    tab.onclick = () => showTab(`file-${index}`);
                    tabsDiv.appendChild(tab);
                    
                    // 创建内容
                    const tabContent = document.createElement('div');
                    tabContent.id = `tab-file-${index}`;
                    tabContent.className = 'tab-content';
                    
                    const fileMatchRate = fileObj.results.debugInfo ? 
                        ((fileObj.results.debugInfo.matchedRecords / fileObj.results.debugInfo.processedRecords) * 100).toFixed(1) : 0;
                    
                    tabContent.innerHTML = `
                        <div class="summary">
                            <h3>�� ${fileObj.name}</h3>
                            <p>记录数：${fileObj.results.recordCount} 条</p>
                            <p>匹配成功：${fileObj.results.debugInfo ? fileObj.results.debugInfo.matchedRecords : 0} 条 (${fileMatchRate}%)</p>
                            ${fileObj.results.debugInfo && (fileObj.results.debugInfo.storeMatchedCount > 0 || fileObj.results.debugInfo.departmentMatchedCount > 0) ? `
                            <p style="color: #667eea; font-size: 14px;">
                                🔍 智能匹配：通过门店 ${fileObj.results.debugInfo.storeMatchedCount} 条，通过部门 ${fileObj.results.debugInfo.departmentMatchedCount} 条
                            </p>
                            ` : ''}
                            <p>总提成：¥${fileObj.results.totalCommission.toFixed(2)}</p>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>日期</th>
                                    <th>单据编号</th>
                                    <th>用户姓名</th>
                                    <th>门店</th>
                                    <th>促销员</th>
                                    <th>促销员来源</th>
                                    <th>物料名称</th>
                                    <th>规格型号</th>
                                    <th>型号来源</th>
                                    <th>销售数量</th>
                                    <th>单台提成</th>
                                    <th>原始提成</th>
                                    <th>有效提成</th>
                                    <th>备注</th>
                                    <th>匹配状态</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${fileObj.results.data.slice(0, 100).map(row => `
                                    <tr style="${!row.isMatched ? 'background-color: #fff3cd;' : ''}">
                                        <td>${row.date}</td>
                                        <td>${row.orderNo}</td>
                                        <td>${row.userName}</td>
                                        <td>${row.store}</td>
                                        <td>${row.salesPerson}</td>
                                        <td>
                                            ${row.salesPersonSource ? `
                                            <span style="font-size: 11px; padding: 2px 6px; border-radius: 4px; ${
                                                row.salesPersonSource === 'direct' ? 'background: #e3f2fd; color: #1976d2;' :
                                                row.salesPersonSource === 'store' ? 'background: #e8f5e9; color: #2e7d32;' :
                                                row.salesPersonSource === 'department' ? 'background: #fff3e0; color: #e65100;' : 
                                                row.salesPersonSource === 'special' ? 'background: #f3e5f5; color: #7b1fa2;' :
                                                row.salesPersonSource === 'employee_to_store' ? 'background: #e1f5fe; color: #0277bd;' :
                                                row.salesPersonSource === 'xingda_special' ? 'background: #fff9c4; color: #f57f17;' :
                                                row.salesPersonSource === 'shengdu_special' ? 'background: #fce4ec; color: #c2185b;' :
                                                row.salesPersonSource === 'huzhou_special' ? 'background: #e1f5fe; color: #01579b;' : ''
                                            }">
                                                ${row.salesPersonSource === 'direct' ? '直接' : 
                                                  row.salesPersonSource === 'store' ? '门店匹配促销员' : 
                                                  row.salesPersonSource === 'department' ? '部门匹配' : 
                                                  row.salesPersonSource === 'special' ? '特殊规则' :
                                                  row.salesPersonSource === 'employee_to_store' ? '促销员匹配门店' :
                                                  row.salesPersonSource === 'xingda_special' ? '兴达特殊处理' :
                                                  row.salesPersonSource === 'shengdu_special' ? '圣都特殊处理' :
                                                  row.salesPersonSource === 'huzhou_special' ? '湖州天猫特殊处理' : ''}
                                            </span>
                                            ` : '-'}
                                        </td>
                                        <td>${row.materialName}</td>
                                        <td title="标准化: ${row.normalizedModel}">${row.model}</td>
                                        <td>
                                            <span style="font-size: 11px; padding: 2px 6px; border-radius: 4px; ${row.modelSource === 'model' ? 'background: #e8f5e9; color: #2e7d32;' : 'background: #fff3e0; color: #e65100;'}">
                                                ${row.modelSource === 'model' ? '规格型号' : row.modelSource === 'material' ? '物料提取' : '未知'}
                                            </span>
                                        </td>
                                        <td>${row.quantity}</td>
                                        <td>¥${row.unitCommission.toFixed(2)}</td>
                                        <td>¥${row.totalCommission.toFixed(2)}</td>
                                        <td style="${row.effectiveCommission === 0 && row.totalCommission > 0 ? 'color: #dc3545; font-weight: bold;' : ''}">¥${row.effectiveCommission.toFixed(2)}</td>
                                        <td style="${row.remark ? 'color: #e65100; font-weight: 600;' : ''}">${row.remark || '-'}</td>
                                        <td>
                                            <span style="color: ${row.isMatched ? '#28a745' : '#dc3545'};">
                                                ${row.isMatched ? '✓ 已匹配' : '✗ 未匹配'}
                                            </span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        ${fileObj.results.data.length > 100 ? '<p style="text-align: center; color: #666; margin-top: 10px;">仅显示前100条记录，完整数据请导出查看</p>' : ''}
                    `;
                    contentDiv.appendChild(tabContent);
                }
              });
            
            resultsDiv.style.display = 'block';
            document.getElementById('exportAllBtn').style.display = 'inline-block';
            document.getElementById('exportSeparateBtn').style.display = 'inline-block';
        }
        
        // 新增：生成员工汇总表HTML
        function generateEmployeeSummaryHTML() {
            // 门店名称标准化映射（将不同名称的同一家店统一）
            const storeNameNormalizationMap = {
                '京东电器城市旗舰店金华商城店': '京东电器城市旗舰店金华商城店',
                '金华五星江南店': '京东电器城市旗舰店金华商城店'
            };
            
            // 标准化门店名称
            function normalizeStoreName(storeName) {
                return storeNameNormalizationMap[storeName] || storeName;
            }
            
            // 获取门店提成系数
            function getStoreCommissionRate(storeName) {
                // 判断是否是杭州临平兴达店（可能的名称变体）
                const specialStores = ['杭州临平兴达', '杭州临平兴达店', '临平兴达', '临平兴达店', '兴达店'];
                for (const special of specialStores) {
                    if (storeName.includes(special)) {
                        return 1.1;
                    }
                }
                return 1;
            }
            
            // 读取渠道名单数据，建立员工姓名 -> {门店, 部门} 的映射
            const employeeStoreMap = {};
            // 建立门店 -> 导购员1 的映射（用于处理未知门店的情况）
            const storeToEmployee1Map = {};
            // 新增：建立门店配置映射 门店 -> {employee1, employee2, department, employeeCount}
            const storeConfigMap = {};
            
            // 特殊门店-员工映射规则（处理特殊情况）
            // 备注：京东电器城市旗舰店金华商城店（原江南店/金华店，2025年9月更名）
            // 叶黄鹤于2025年3月调整到该店，如果该店促销员为空，归到叶黄鹤名下
            const specialStoreEmployeeMap = {
                '京东电器城市旗舰店金华商城店': '叶黄鹤',
                '江南店': '叶黄鹤',
                '金华店': '叶黄鹤'
            };
            
            if (storeListData && storeListData.worksheet) {
                const departmentCol = parseInt(document.getElementById('departmentField').value);
                const storeNameCol = parseInt(document.getElementById('storeNameField').value);
                const employeeNameCol = parseInt(document.getElementById('employeeNameField').value);
                const employeeName2Col = parseInt(document.getElementById('employeeName2Field').value);
                
                const data = XLSX.utils.sheet_to_json(storeListData.worksheet, { header: 1 });
                for (let i = 1; i < data.length; i++) {
                    const row = data[i];
                    const originalStoreName = row[storeNameCol];
                    const storeName = normalizeStoreName(originalStoreName || '未知门店'); // 标准化门店名称
                    const department = row[departmentCol];
                    
                    // 处理导购人员 1
                    const employeeName = row[employeeNameCol];
                    if (employeeName) {
                        employeeStoreMap[employeeName] = {
                            storeName: storeName,
                            department: department || '未知部门'
                        };
                    }
                    
                    // 建立门店到导购员1的映射（用于未知门店的提成归属）
                    // 需要建立原始门店名和标准化门店名的双重映射
                    if (originalStoreName && employeeName) {
                        if (!storeToEmployee1Map[originalStoreName]) {
                            storeToEmployee1Map[originalStoreName] = {
                                employeeName: employeeName,
                                department: department || '未知部门'
                            };
                        }
                        if (!storeToEmployee1Map[storeName]) {
                            storeToEmployee1Map[storeName] = {
                                employeeName: employeeName,
                                department: department || '未知部门'
                            };
                        }
                    }
                    
                    // 处理导购人员 2
                    const employeeName2 = row[employeeName2Col];
                    if (employeeName2) {
                        employeeStoreMap[employeeName2] = {
                            storeName: storeName,
                            department: department || '未知部门'
                        };
                    }
                    
                    // 新增：建立门店配置映射（使用标准化后的门店名）
                    if (storeName && employeeName) {
                        if (!storeConfigMap[storeName]) {
                            storeConfigMap[storeName] = {
                                employee1: employeeName,
                                employee2: employeeName2 || null,
                                department: department || '未知部门',
                                employeeCount: employeeName2 ? 2 : 1
                            };
                        } else if (employeeName2 && !storeConfigMap[storeName].employee2) {
                            // 如果已存在配置但没有employee2，则补充
                            storeConfigMap[storeName].employee2 = employeeName2;
                            storeConfigMap[storeName].employeeCount = 2;
                        }
                    }
                }
            }
            
            // 第一步：按文件和门店汇总所有提成和销售数量
            const fileStoreCommissionMap = {}; // 文件名 -> 门店 -> {totalCommission, totalQuantity}
            const unknownRecords = []; // 收集所有未知门店的详细记录
            
            salesFiles.forEach(fileObj => {
                if (!fileObj.results || !fileObj.results.data) return;
                
                const fileName = fileObj.name || '未知文件';
                if (!fileStoreCommissionMap[fileName]) {
                    fileStoreCommissionMap[fileName] = {};
                }
                
                fileObj.results.data.forEach(row => {
                    let storeName = '未知门店';
                    let department = '未知部门';
                    let isUnknown = false;
                    
                    // 确定门店归属（优先从销售数据的门店字段，再从促销员反查）
                    if (row.store && storeToEmployee1Map[row.store]) {
                        storeName = normalizeStoreName(row.store); // 标准化门店名称
                        department = storeToEmployee1Map[row.store].department;
                        
                        // 特殊处理：如果促销员为空且门店在特殊映射中，记录特殊标记
                        if ((!row.salesPerson || row.salesPerson === '未知') && specialStoreEmployeeMap[row.store]) {
                            // 这条记录会归到特殊映射的员工名下
                            row._specialEmployee = specialStoreEmployeeMap[row.store];
                        }
                    } else if (row.salesPerson && employeeStoreMap[row.salesPerson]) {
                        storeName = employeeStoreMap[row.salesPerson].storeName;
                        department = employeeStoreMap[row.salesPerson].department;
                    } else {
                        // 既没有找到门店，也没有找到促销员，标记为未知
                        isUnknown = true;
                    }
                    
                    // 如果是未知门店，收集详细记录
                    if (isUnknown || storeName === '未知门店') {
                        unknownRecords.push({
                            sourceFile: fileName,
                            storeName: row.store || '未知门店',
                            department: department,
                            salesPerson: row.salesPerson || '未知',
                            materialName: row.materialName || '',
                            model: row.model || '',
                            quantity: row.quantity || 0,
                            unitCommission: row.unitCommission || 0,
                            effectiveCommission: row.effectiveCommission || 0
                        });
                    }
                    
                // 汇总到文件+门店（使用有效提成）
                if (!fileStoreCommissionMap[fileName][storeName]) {
                    fileStoreCommissionMap[fileName][storeName] = {
                        department: department,
                        totalCommission: 0,
                        totalQuantity: 0
                    };
                }
                fileStoreCommissionMap[fileName][storeName].totalCommission += row.effectiveCommission || 0;
                fileStoreCommissionMap[fileName][storeName].totalQuantity += row.quantity || 0;
                });
            });
            
            // 第二步：根据渠道名单配置，为每个文件+门店的导购员生成记录
            const employeeSummary = [];
            
            // 遍历每个文件
            Object.keys(fileStoreCommissionMap).forEach(fileName => {
                const fileStores = fileStoreCommissionMap[fileName];
                
                // 遍历该文件中的每个门店
                Object.keys(fileStores).forEach(storeName => {
                    const storeData = fileStores[storeName];
                    const config = storeConfigMap[storeName];
                    
                    // 如果门店在配置中存在
                    if (config) {
                        const employeeCount = config.employeeCount;
                        const avgCommission = storeData.totalCommission / employeeCount; // 平均分配
                        
                        // 导购员1
                        employeeSummary.push({
                            fileName: fileName,
                            storeName: storeName,
                            department: config.department,
                            employeeName: config.employee1,
                            totalQuantity: storeData.totalQuantity, // 该文件中门店的销售数量
                            totalCommission: avgCommission, // 平分后的提成
                            employeeCount: employeeCount,
                            storeTotalCommission: storeData.totalCommission
                        });
                        
                        // 导购员2（如果有）
                        if (config.employee2) {
                            employeeSummary.push({
                                fileName: fileName,
                                storeName: storeName,
                                department: config.department,
                                employeeName: config.employee2,
                                totalQuantity: storeData.totalQuantity, // 该文件中门店的销售数量
                                totalCommission: avgCommission, // 平分后的提成
                                employeeCount: employeeCount,
                                storeTotalCommission: storeData.totalCommission
                            });
                        }
                    }
                });
            });
            
            // 第三步：排序（按文件名、门店、员工姓名排序）
            employeeSummary.sort((a, b) => {
                if (a.fileName !== b.fileName) {
                    return a.fileName.localeCompare(b.fileName, 'zh-CN');
                }
                if (a.storeName !== b.storeName) {
                    return a.storeName.localeCompare(b.storeName, 'zh-CN');
                }
                return a.employeeName.localeCompare(b.employeeName, 'zh-CN');
            });
            
            // 计算总计
            let grandTotalQuantity = 0;
            let grandTotalCommission = 0;
            let grandTotalFinal = 0;
            
            // 生成表格HTML
            let html = `
                <div style="margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px;">
                    <h3>📋 计算说明与数据来源</h3>
                    
                    <h4 style="color: #1976d2; margin-top: 15px; margin-bottom: 10px;">💾 数据来源</h4>
                    <ul style="margin: 5px 0; line-height: 1.8;">
                        <li><strong>销售数据表</strong>：包含销售记录、促销员、门店、规格型号、销售数量等信息</li>
                        <li><strong>政策表</strong>：包含规格型号与单台提成的对应关系</li>
                        <li><strong>渠道名单表</strong>：包含部门、门店、导购人员1、导购人员2的配置信息</li>
                    </ul>
                    
                    <h4 style="color: #1976d2; margin-top: 15px; margin-bottom: 10px;">🔄 提成计算流程</h4>
                    <ol style="margin: 5px 0; line-height: 1.8;">
                        <li><strong>读取销售数据</strong>：逐条读取销售记录
                            <ul style="margin-top: 5px; margin-left: 20px;">
                                <li>如果有"规格型号"字段，直接使用</li>
                                <li>如果无"规格型号"，则从"物料名称"字段自动提取型号</li>
                            </ul>
                        </li>
                        <li><strong>匹配单台提成</strong>：在政策表中查找对应型号的单台提成（大小写不敏感）</li>
                        <li><strong>计算单条记录提成</strong>：单台提成 × 销售数量 = 该条记录的提成</li>
                        <li><strong>确定门店归属</strong>：根据销售数据的门店字段或促销员字段，确定该条记录属于哪个门店</li>
                        <li><strong>按门店汇总提成</strong>：将所有销售记录按门店汇总，得到每个门店的总提成和总销售数量</li>
                        <li><strong>平均分配</strong>：门店总提成 ÷ 门店导购员数 = 每人分得的提成（从渠道名单读取导购员数）</li>
                        <li><strong>生成员工记录</strong>：根据渠道名单中配置的导购员，为每个导购员生成一条记录，显示其分得的提成</li>
                        <li><strong>应用系数</strong>：分得的提成 × 门店系数 = 最终提成</li>
                    </ol>
                    
                    <h4 style="color: #1976d2; margin-top: 15px; margin-bottom: 10px;">👥 门店归属逻辑（核心）</h4>
                    <ul style="margin: 5px 0; line-height: 1.8; background: #fff8e1; padding: 15px; border-radius: 8px;">
                        <li><strong>确定门店的优先级</strong>：
                            <ol style="margin-top: 5px; margin-left: 20px;">
                                <li><strong>优先级1</strong>：如果销售数据有"门店"字段且在渠道名单中能找到 → 直接使用</li>
                                <li><strong>优先级2</strong>：如果没有门店但有"促销员"字段 → 在渠道名单中查找该促销员所属的门店</li>
                                <li><strong>未匹配</strong>：如果都找不到 → 归到"未知门店"</li>
                            </ol>
                        </li>
                        <li style="margin-top: 10px;"><strong>关键特点</strong>：
                            <ul style="margin-top: 5px; margin-left: 20px;">
                                <li>✅ 不关心销售记录里的促销员是谁</li>
                                <li>✅ 只关心这条销售记录属于哪个门店</li>
                                <li>✅ 所有属于同一门店的销售记录，提成都汇总到该门店</li>
                                <li>✅ 然后由渠道名单中配置的导购员平分</li>
                            </ul>
                        </li>
                    </ul>
                    
                    <h4 style="color: #1976d2; margin-top: 15px; margin-bottom: 10px;">👨‍👩‍👧‍👦 门店员工数确定规则</h4>
                    <ul style="margin: 5px 0; line-height: 1.8; background: #e8f5e9; padding: 10px; border-radius: 5px;">
                        <li><strong>数据来源</strong>：从渠道名单配置读取，不是从销售数据统计</li>
                        <li><strong>规则</strong>：
                            <ul style="margin-top: 5px; margin-left: 20px;">
                                <li>如果渠道名单中该门店配置了"导购人员1"和"导购人员2"（非空） → 员工数 = 2</li>
                                <li>如果只配置了"导购人员1" → 员工数 = 1</li>
                            </ul>
                        </li>
                        <li><strong>重要</strong>：即使导购人员2没有销售记录，也会在汇总表中显示（提成为0），并参与平分</li>
                    </ul>
                    
                    <h4 style="color: #1976d2; margin-top: 15px; margin-bottom: 10px;">📊 汇总表字段说明</h4>
                    <ul style="margin: 5px 0; line-height: 1.8;">
                        <li><strong>来源表</strong>：数据来源的销售文件名（每个员工在每个文件中都会有单独的一行）</li>
                        <li><strong>部门</strong>：从渠道名单读取该门店的部门信息</li>
                        <li><strong>门店</strong>：从渠道名单读取（或从销售数据确定）</li>
                        <li><strong>员工姓名</strong>：从渠道名单的导购人员字段读取（导购人员1或导购人员2）</li>
                        <li><strong>销售数量</strong>：<span style="color: #e65100;">该文件中该门店的总销售数量</span>（同一文件同一门店的所有导购员显示相同数量）</li>
                        <li><strong>个人提成</strong>：<span style="color: #e65100;">已经平分后的提成</span> = 该文件中门店总提成 ÷ 门店员工数</li>
                        <li><strong>门店员工数</strong>：从渠道名单配置读取（导购人员1和2的数量）</li>
                        <li><strong>门店总提成</strong>：该文件中该门店所有销售记录的提成总和</li>
                        <li><strong>平均分配提成</strong>：与"个人提成"相同，都是平分后的金额</li>
                        <li><strong>门店提成系数</strong>：杭州临平兴达店 = 1.1，其他门店 = 1.0</li>
                        <li><strong>合计</strong>：平均分配提成 × 门店提成系数</li>
                        <li><strong>总计</strong>：合计 + 其他（如有）</li>
                    </ul>
                    
                    <h4 style="color: #1976d2; margin-top: 15px; margin-bottom: 10px;">⚠️ 重要说明</h4>
                    <ul style="margin: 5px 0; line-height: 1.8; background: #ffebee; padding: 10px; border-radius: 5px;">
                        <li><strong>分文件显示</strong>：<span style="color: #d32f2f;">表格按来源文件分开显示</span>，如果同一员工出现在多个文件中，会显示多行（每个文件一行）</li>
                        <li><strong>门店优先原则</strong>：先按文件和门店汇总所有提成，再根据渠道名单配置的导购员平分</li>
                        <li><strong>平分规则</strong>：同一文件同一门店的所有导购员平分该门店的总提成，<span style="color: #d32f2f;">与谁做的销售无关</span></li>
                        <li><strong>销售数量显示</strong>：同一文件同一门店的所有导购员显示相同的销售数量（该文件中门店总数量）</li>
                        <li><strong>零销售也平分</strong>：即使导购员2没有任何销售记录，也会显示在表中并平分提成</li>
                        <li><strong>导购员数量</strong>：从渠道名单配置读取，不是从销售数据统计</li>
                        <li><strong>门店判断</strong>：判断是否同一家门店看"门店"字段，不是看"部门"或"促销员"字段</li>
                    </ul>
                    
                    <h4 style="color: #1976d2; margin-top: 15px; margin-bottom: 10px;">👤 员工在职期间判断</h4>
                    <ul style="margin: 5px 0; line-height: 1.8; background: #e8f5e9; padding: 15px; border-radius: 8px;">
                        <li><strong>数据来源</strong>：系统会根据渠道名单中配置的"导购人员1入职日期"、"导购人员2入职日期"、"导购人员1离职日期"、"导购人员2离职日期"字段判断订单是否在员工在职期间</li>
                        <li style="margin-top: 8px;"><strong>判断规则</strong>：
                            <ul style="margin-top: 5px; margin-left: 20px;">
                                <li>如果订单日期早于入职日期 → 标注"入职前订单"，有效提成=0</li>
                                <li>如果订单日期晚于离职日期 → 标注"离职后订单"，有效提成=0</li>
                                <li>如果订单日期在入职-离职期间 → 正常计算提成，标注在职期间范围</li>
                                <li>非在职期订单仍会显示在明细表中，但有效提成为0</li>
                            </ul>
                        </li>
                        <li style="margin-top: 8px;"><strong>备注说明</strong>：
                            <ul style="margin-top: 5px; margin-left: 20px;">
                                <li>"入职前订单"：订单日期在员工入职日期之前</li>
                                <li>"离职后订单"：订单日期在员工离职日期之后</li>
                                <li>"在职期订单（日期-日期）"：订单日期在员工在职期间，显示具体在职日期范围</li>
                                <li>"入职后订单（日期起）"：员工有入职日期但无离职日期</li>
                                <li>"离职前订单（日期止）"：员工有离职日期但无入职日期（少见情况）</li>
                            </ul>
                        </li>
                        <li style="margin-top: 8px;"><strong>重要</strong>：如果渠道名单中没有配置入职/离职日期，系统不会对该员工的订单进行日期限制</li>
                    </ul>
                    
                    <h4 style="color: #e65100; margin-top: 15px; margin-bottom: 10px;">📝 特殊情况备注</h4>
                    <ul style="margin: 5px 0; line-height: 1.8; background: #fff3e0; padding: 10px; border-radius: 5px;">
                        <li><strong>兴达表特殊处理</strong>
                            <ul style="margin-top: 5px; margin-left: 20px;">
                                <li>所有文件名包含"兴达"关键词的销售表，其所有订单提成都归到<strong>巩建勋</strong>名下</li>
                                <li>自动设置门店为"<strong>杭州临平兴达</strong>"，员工为"<strong>巩建勋</strong>"</li>
                                <li>该门店提成系数为<strong>1.1</strong>（自动应用）</li>
                                <li>需要在渠道名单中配置：部门、门店=杭州临平兴达、导购人员=巩建勋</li>
                            </ul>
                        </li>
                        <li style="margin-top: 10px;"><strong>圣都表特殊处理</strong>
                            <ul style="margin-top: 5px; margin-left: 20px;">
                                <li>所有文件名包含"圣都"关键词的销售表（如"圣都采购单明细导出导出数据-XXXXXX"），其所有订单提成都归到<strong>曾兴容</strong>名下</li>
                                <li>自动设置门店为"<strong>杭州圣都</strong>"，员工为"<strong>曾兴容</strong>"</li>
                                <li>该门店提成系数为<strong>1.0</strong>（普通系数）</li>
                                <li>需要在渠道名单中配置：部门、门店=杭州圣都、导购人员=曾兴容</li>
                            </ul>
                        </li>
                        <li style="margin-top: 10px;"><strong>湖州天猫店特殊处理</strong>
                            <ul style="margin-top: 5px; margin-left: 20px;">
                                <li>所有文件名包含"湖州天猫"关键词的销售表，其所有订单提成都归到<strong>陈春艳</strong>名下</li>
                                <li>自动设置门店为"<strong>湖州天猫店</strong>"，员工为"<strong>陈春艳</strong>"</li>
                                <li>该门店提成系数为<strong>1.0</strong>（普通系数）</li>
                                <li>需要在渠道名单中配置：部门、门店=湖州天猫店、导购人员=陈春艳</li>
                            </ul>
                        </li>
                        <li style="margin-top: 10px;"><strong>京东电器城市旗舰店金华商城店</strong>（原江南店/金华店，2025年9月更名）
                            <ul style="margin-top: 5px; margin-left: 20px;">
                                <li>叶黄鹤于2025年3月调整到该店</li>
                                <li>如该店销售记录促销员为空，自动填入"叶黄鹤"</li>
                                <li>请确保渠道名单中该门店配置了正确的导购员信息</li>
                            </ul>
                        </li>
                        <li style="margin-top: 10px;"><strong>门店名称合并</strong>
                            <ul style="margin-top: 5px; margin-left: 20px;">
                                <li>"京东电器城市旗舰店金华商城店"和"金华五星江南店"在统计时会被视为同一家店</li>
                                <li>两个门店的销售数据会合并汇总到"京东电器城市旗舰店金华商城店"名下</li>
                                <li>提成会按照渠道名单中"京东电器城市旗舰店金华商城店"配置的导购员进行分配</li>
                            </ul>
                        </li>
                    </ul>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>序号</th>
                            <th>来源表</th>
                            <th>部门</th>
                            <th>门店</th>
                            <th>员工姓名</th>
                            <th>销售数量（台）</th>
                            <th>个人提成（元）</th>
                            <th>门店员工数</th>
                            <th>门店总提成（元）</th>
                            <th>平均分配提成（元）</th>
                            <th>门店提成系数</th>
                            <th>合计（元）</th>
                            <th>其他</th>
                            <th>总计（元）</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            employeeSummary.forEach((item, index) => {
                const employeeCount = item.employeeCount;
                const storeTotalCommission = item.storeTotalCommission;
                const averageCommission = item.totalCommission; // 已经是平分后的提成
                const rate = getStoreCommissionRate(item.storeName);
                const total = averageCommission * rate;
                const other = 0; // 暂时为0
                const finalTotal = total + other;
                
                grandTotalQuantity += item.totalQuantity;
                grandTotalCommission += averageCommission;
                grandTotalFinal += finalTotal;
                
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.fileName}</td>
                        <td>${item.department}</td>
                        <td>${item.storeName}</td>
                        <td>${item.employeeName}</td>
                        <td>${item.totalQuantity.toFixed(0)}</td>
                        <td>¥${item.totalCommission.toFixed(2)}</td>
                        <td>${employeeCount}</td>
                        <td>¥${storeTotalCommission.toFixed(2)}</td>
                        <td>¥${averageCommission.toFixed(2)}</td>
                        <td>${rate}</td>
                        <td>¥${total.toFixed(2)}</td>
                        <td>${other > 0 ? '¥' + other.toFixed(2) : ''}</td>
                        <td>¥${finalTotal.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            // 添加合计行
            html += `
                    <tr style="background: #f0f0f0; font-weight: bold;">
                        <td colspan="5">合计</td>
                        <td>${grandTotalQuantity.toFixed(0)}</td>
                        <td>¥${grandTotalCommission.toFixed(2)}</td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        <td>¥${grandTotalFinal.toFixed(2)}</td>
                    </tr>
                </tbody>
            </table>
            `;
            
            // 添加未知数据汇总区域
            if (unknownRecords.length > 0) {
                html += `
                    <div style="margin-top: 40px; padding: 20px; background: #fff3e0; border-radius: 8px; border: 2px solid #ff9800;">
                        <h3 style="color: #e65100; margin-top: 0;">⚠️ 未知数据明细</h3>
                        <p style="color: #666; margin-bottom: 20px;">
                            以下记录无法匹配到渠道名单中的门店或员工，请检查数据或更新渠道名单配置。
                            共 <strong style="color: #e65100;">${unknownRecords.length}</strong> 条记录。
                        </p>
                        
                        <table>
                            <thead>
                                <tr style="background: #ff9800; color: white;">
                                    <th>序号</th>
                                    <th>来源表</th>
                                    <th>门店</th>
                                    <th>部门</th>
                                    <th>促销员</th>
                                    <th>物料名称</th>
                                    <th>规格型号</th>
                                    <th>销售数量</th>
                                    <th>单台提成（元）</th>
                                    <th>总提成（元）</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                let unknownTotalQuantity = 0;
                let unknownTotalCommission = 0;
                
                unknownRecords.forEach((record, index) => {
                    unknownTotalQuantity += record.quantity;
                    unknownTotalCommission += record.effectiveCommission;
                    
                    html += `
                        <tr style="background: ${index % 2 === 0 ? '#fff' : '#fef5e7'};">
                            <td>${index + 1}</td>
                            <td style="color: #1976d2; font-weight: 500;">${record.sourceFile}</td>
                            <td>${record.storeName}</td>
                            <td>${record.department}</td>
                            <td>${record.salesPerson}</td>
                            <td style="font-size: 12px;">${record.materialName}</td>
                            <td>${record.model}</td>
                            <td>${record.quantity.toFixed(0)}</td>
                            <td>¥${record.unitCommission.toFixed(2)}</td>
                            <td>¥${record.effectiveCommission.toFixed(2)}</td>
                        </tr>
                    `;
                });
                
                // 添加合计行
                html += `
                        <tr style="background: #ffcc80; font-weight: bold;">
                            <td colspan="7">未知数据合计</td>
                            <td>${unknownTotalQuantity.toFixed(0)}</td>
                            <td>-</td>
                            <td>¥${unknownTotalCommission.toFixed(2)}</td>
                        </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            return html;
        }
        
        // 新增：生成调试信息HTML
        function generateDebugInfoHTML() {
            let html = '<div class="debug-info">';
            html += '<h4>🔍 匹配分析报告</h4>';
            
            // 政策数据统计
            if (matchingDebugInfo.policy) {
                const policyInfo = matchingDebugInfo.policy;
                html += `
                    <div class="match-stats">
                        <div class="stat-item success">
                            <strong>政策表记录</strong><br>
                            总数: ${policyInfo.totalPolicyRecords}<br>
                            有效: ${policyInfo.validPolicyRecords}
                        </div>
                    </div>
                `;
            }
            
            // 各文件匹配统计
            html += '<h4>📁 各文件匹配详情</h4>';
            html += '<div class="match-stats">';
            
            Object.values(matchingDebugInfo).forEach(debugInfo => {
                if (debugInfo.fileName) {
                    const matchRate = ((debugInfo.matchedRecords / debugInfo.processedRecords) * 100).toFixed(1);
                    html += `
                        <div class="stat-item ${matchRate > 80 ? 'success' : matchRate > 50 ? 'warning' : 'error'}">
                            <strong>${debugInfo.fileName}</strong><br>
                            处理: ${debugInfo.processedRecords} 条<br>
                            匹配: ${debugInfo.matchedRecords} 条<br>
                            未匹配: ${debugInfo.unmatchedRecords} 条<br>
                            匹配率: ${matchRate}%
                        </div>
                    `;
                }
            });
            
            html += '</div>';
            
            // 未匹配型号汇总
            const allUnmatchedModels = new Set();
            Object.values(matchingDebugInfo).forEach(debugInfo => {
                if (debugInfo.unmatchedModels) {
                    debugInfo.unmatchedModels.forEach(model => allUnmatchedModels.add(model));
                }
            });
            
            if (allUnmatchedModels.size > 0) {
                html += '<h4>⚠️ 未匹配型号列表</h4>';
                html += '<div class="unmatched-models">';
                html += '<p>以下型号在政策表中未找到匹配项：</p>';
                
                Array.from(allUnmatchedModels).sort().forEach(model => {
                    const normalized = normalizeModel(model);
                    html += `
                        <div class="model-comparison">
                            <span class="model-original">原始: ${model}</span>
                            <span class="model-normalized">标准化: ${normalized}</span>
                        </div>
                    `;
                });
                
                html += '</div>';
            }
            
            // 政策表型号预览
            if (matchingDebugInfo.policy && matchingDebugInfo.policy.policyModels.length > 0) {
                html += '<h4>�� 政策表型号预览 (前20个)</h4>';
                html += '<div class="unmatched-models">';
                
                matchingDebugInfo.policy.policyModels.slice(0, 20).forEach(item => {
                    html += `
                        <div class="model-comparison">
                            <span class="model-original">原始: ${item.original}</span>
                            <span class="model-normalized">标准化: ${item.normalized}</span>
                            <span style="color: #28a745;">提成: ¥${item.commission}</span>
                        </div>
                    `;
                });
                
                if (matchingDebugInfo.policy.policyModels.length > 20) {
                    html += `<p style="text-align: center; color: #666;">还有 ${matchingDebugInfo.policy.policyModels.length - 20} 个型号...</p>`;
                }
                
                html += '</div>';
            }
            
            html += '</div>';
            return html;
        }
        
        // 显示指定标签
        function showTab(tabId) {
            // 更新标签状态
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach((tab, index) => {
                if ((tabId === 'summary' && index === 0) || 
                    (tabId === 'employee-summary' && index === 1) ||
                    (tabId === 'debug' && index === 2) ||
                    (tabId === `file-${index - 3}`)) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            // 更新内容显示
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => {
                if (content.id === `tab-${tabId}`) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
        }
        
    // 导出单个文件结果
    function exportSingleResult(index) {
        const fileObj = salesFiles[index];
        if (!fileObj.results) {
            showError('该文件还未计算完成');
            return;
        }
        
        const exportData = fileObj.results.data.map(row => ({
            '日期': row.date,
            '单据编号': row.orderNo,
            '用户姓名': row.userName,
            '门店': row.store,
            '促销员': row.salesPerson,
            '促销员来源': row.salesPersonSource === 'direct' ? '直接' : 
                        row.salesPersonSource === 'store' ? '门店匹配促销员' : 
                        row.salesPersonSource === 'department' ? '部门匹配' : 
                        row.salesPersonSource === 'special' ? '特殊规则' :
                        row.salesPersonSource === 'employee_to_store' ? '促销员匹配门店' :
                        row.salesPersonSource === 'xingda_special' ? '兴达特殊处理' :
                        row.salesPersonSource === 'shengdu_special' ? '圣都特殊处理' :
                        row.salesPersonSource === 'huzhou_special' ? '湖州天猫特殊处理' : '',
            '物料名称': row.materialName,
            '规格型号': row.model,
            '型号来源': row.modelSource === 'model' ? '规格型号' : row.modelSource === 'material' ? '物料提取' : '未知',
            '标准化型号': row.normalizedModel,
            '销售数量': row.quantity,
            '单台提成': row.unitCommission,
            '原始提成': row.totalCommission,
            '有效提成': row.effectiveCommission,
            '备注': row.remark || '',
            '匹配状态': row.isMatched ? '已匹配' : '未匹配'
        }));
            
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '提成计算结果');
            
            // 添加匹配统计工作表
            if (fileObj.results.debugInfo) {
                const debugInfo = fileObj.results.debugInfo;
                const statsData = [
                    { '统计项': '总记录数', '数值': debugInfo.processedRecords },
                    { '统计项': '匹配成功', '数值': debugInfo.matchedRecords },
                    { '统计项': '未匹配', '数值': debugInfo.unmatchedRecords },
                    { '统计项': '匹配率', '数值': `${((debugInfo.matchedRecords / debugInfo.processedRecords) * 100).toFixed(1)}%` },
                    { '统计项': '总提成金额', '数值': `¥${fileObj.results.totalCommission.toFixed(2)}` },
                    { '统计项': '', '数值': '' },
                    { '统计项': '通过门店匹配促销员', '数值': debugInfo.storeMatchedCount || 0 },
                    { '统计项': '通过部门匹配促销员', '数值': debugInfo.departmentMatchedCount || 0 }
                ];
                
                const statsWs = XLSX.utils.json_to_sheet(statsData);
                XLSX.utils.book_append_sheet(wb, statsWs, '匹配统计');
                
                // 添加未匹配型号列表
                if (debugInfo.unmatchedModels.size > 0) {
                    const unmatchedData = Array.from(debugInfo.unmatchedModels).map(model => ({
                        '原始型号': model,
                        '标准化型号': normalizeModel(model)
                    }));
                    
                    const unmatchedWs = XLSX.utils.json_to_sheet(unmatchedData);
                    XLSX.utils.book_append_sheet(wb, unmatchedWs, '未匹配型号');
                }
            }
            
            const fileName = `提成计算_${fileObj.name.replace(/\.[^/.]+$/, '')}_${new Date().toLocaleDateString().replace(/\//g, '-')}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showSuccess(`已导出文件：${fileName}`);
        }
        
        // 导出所有结果到一个文件
        function exportAllResults() {
            const wb = XLSX.utils.book_new();
            
            // 门店名称标准化映射（将不同名称的同一家店统一）
            const storeNameNormalizationMap = {
                '京东电器城市旗舰店金华商城店': '京东电器城市旗舰店金华商城店',
                '金华五星江南店': '京东电器城市旗舰店金华商城店'
            };
            
            // 标准化门店名称
            function normalizeStoreName(storeName) {
                return storeNameNormalizationMap[storeName] || storeName;
            }
            
            // 创建员工汇总表
            function getStoreCommissionRate(storeName) {
                const specialStores = ['杭州临平兴达', '杭州临平兴达店', '临平兴达', '临平兴达店', '兴达店'];
                for (const special of specialStores) {
                    if (storeName.includes(special)) {
                        return 1.1;
                    }
                }
                return 1;
            }
            
            // 读取渠道名单数据，建立员工姓名 -> {门店, 部门} 的映射
            const employeeStoreMap = {};
            // 建立门店 -> 导购员1 的映射（用于处理未知门店的情况）
            const storeToEmployee1Map = {};
            // 新增：建立门店配置映射 门店 -> {employee1, employee2, department, employeeCount}
            const storeConfigMap = {};
            
            // 特殊门店-员工映射规则（处理特殊情况）
            // 备注：京东电器城市旗舰店金华商城店（原江南店/金华店，2025年9月更名）
            // 叶黄鹤于2025年3月调整到该店，如果该店促销员为空，归到叶黄鹤名下
            const specialStoreEmployeeMap = {
                '京东电器城市旗舰店金华商城店': '叶黄鹤',
                '江南店': '叶黄鹤',
                '金华店': '叶黄鹤'
            };
            
            if (storeListData && storeListData.worksheet) {
                const departmentCol = parseInt(document.getElementById('departmentField').value);
                const storeNameCol = parseInt(document.getElementById('storeNameField').value);
                const employeeNameCol = parseInt(document.getElementById('employeeNameField').value);
                const employeeName2Col = parseInt(document.getElementById('employeeName2Field').value);
                
                const data = XLSX.utils.sheet_to_json(storeListData.worksheet, { header: 1 });
                for (let i = 1; i < data.length; i++) {
                    const row = data[i];
                    const originalStoreName = row[storeNameCol];
                    const storeName = normalizeStoreName(originalStoreName || '未知门店'); // 标准化门店名称
                    const department = row[departmentCol];
                    
                    // 处理导购人员 1
                    const employeeName = row[employeeNameCol];
                    if (employeeName) {
                        employeeStoreMap[employeeName] = {
                            storeName: storeName,
                            department: department || '未知部门'
                        };
                    }
                    
                    // 建立门店到导购员1的映射（用于未知门店的提成归属）
                    // 需要建立原始门店名和标准化门店名的双重映射
                    if (originalStoreName && employeeName) {
                        if (!storeToEmployee1Map[originalStoreName]) {
                            storeToEmployee1Map[originalStoreName] = {
                                employeeName: employeeName,
                                department: department || '未知部门'
                            };
                        }
                        if (!storeToEmployee1Map[storeName]) {
                            storeToEmployee1Map[storeName] = {
                                employeeName: employeeName,
                                department: department || '未知部门'
                            };
                        }
                    }
                    
                    // 处理导购人员 2
                    const employeeName2 = row[employeeName2Col];
                    if (employeeName2) {
                        employeeStoreMap[employeeName2] = {
                            storeName: storeName,
                            department: department || '未知部门'
                        };
                    }
                    
                    // 新增：建立门店配置映射（使用标准化后的门店名）
                    if (storeName && employeeName) {
                        if (!storeConfigMap[storeName]) {
                            storeConfigMap[storeName] = {
                                employee1: employeeName,
                                employee2: employeeName2 || null,
                                department: department || '未知部门',
                                employeeCount: employeeName2 ? 2 : 1
                            };
                        } else if (employeeName2 && !storeConfigMap[storeName].employee2) {
                            // 如果已存在配置但没有employee2，则补充
                            storeConfigMap[storeName].employee2 = employeeName2;
                            storeConfigMap[storeName].employeeCount = 2;
                        }
                    }
                }
            }
            
            // 第一步：按文件和门店汇总所有提成和销售数量
            const exportFileStoreCommissionMap = {}; // 文件名 -> 门店 -> {totalCommission, totalQuantity}
            const exportUnknownRecords = []; // 收集所有未知门店的详细记录（用于Excel导出）
            
            salesFiles.forEach(fileObj => {
                if (!fileObj.results || !fileObj.results.data) return;
                
                const fileName = fileObj.name || '未知文件';
                if (!exportFileStoreCommissionMap[fileName]) {
                    exportFileStoreCommissionMap[fileName] = {};
                }
                
                fileObj.results.data.forEach(row => {
                    let storeName = '未知门店';
                    let department = '未知部门';
                    let isUnknown = false;
                    
                    // 确定门店归属（优先从销售数据的门店字段，再从促销员反查）
                    if (row.store && storeToEmployee1Map[row.store]) {
                        storeName = normalizeStoreName(row.store); // 标准化门店名称
                        department = storeToEmployee1Map[row.store].department;
                        
                        // 特殊处理：如果促销员为空且门店在特殊映射中，记录特殊标记
                        if ((!row.salesPerson || row.salesPerson === '未知') && specialStoreEmployeeMap[row.store]) {
                            // 这条记录会归到特殊映射的员工名下
                            row._specialEmployee = specialStoreEmployeeMap[row.store];
                        }
                    } else if (row.salesPerson && employeeStoreMap[row.salesPerson]) {
                        storeName = employeeStoreMap[row.salesPerson].storeName;
                        department = employeeStoreMap[row.salesPerson].department;
                    } else {
                        // 既没有找到门店，也没有找到促销员，标记为未知
                        isUnknown = true;
                    }
                    
                    // 如果是未知门店，收集详细记录
                    if (isUnknown || storeName === '未知门店') {
                        exportUnknownRecords.push({
                            来源表: fileName,
                            门店: row.store || '未知门店',
                            部门: department,
                            促销员: row.salesPerson || '未知',
                            物料名称: row.materialName || '',
                            规格型号: row.model || '',
                            销售数量: row.quantity || 0,
                            单台提成: row.unitCommission || 0,
                            总提成: row.effectiveCommission || 0
                        });
                    }
                    
                    // 汇总到文件+门店（使用有效提成）
                    if (!exportFileStoreCommissionMap[fileName][storeName]) {
                        exportFileStoreCommissionMap[fileName][storeName] = {
                            department: department,
                            totalCommission: 0,
                            totalQuantity: 0
                        };
                    }
                    exportFileStoreCommissionMap[fileName][storeName].totalCommission += row.effectiveCommission || 0;
                    exportFileStoreCommissionMap[fileName][storeName].totalQuantity += row.quantity || 0;
                });
            });
            
            // 第二步：根据渠道名单配置，为每个文件+门店的导购员生成记录
            const employeeSummaryArray = [];
            
            // 遍历每个文件
            Object.keys(exportFileStoreCommissionMap).forEach(fileName => {
                const fileStores = exportFileStoreCommissionMap[fileName];
                
                // 遍历该文件中的每个门店
                Object.keys(fileStores).forEach(storeName => {
                    const storeData = fileStores[storeName];
                    const config = storeConfigMap[storeName];
                    
                    // 如果门店在配置中存在
                    if (config) {
                        const employeeCount = config.employeeCount;
                        const avgCommission = storeData.totalCommission / employeeCount; // 平均分配
                        
                        // 导购员1
                        employeeSummaryArray.push({
                            来源表: fileName,
                            部门: config.department,
                            门店: storeName,
                            员工姓名: config.employee1,
                            销售数量: storeData.totalQuantity, // 该文件中门店的销售数量
                            总提成: avgCommission, // 平分后的提成
                            门店员工数: employeeCount,
                            门店总提成: storeData.totalCommission
                        });
                        
                        // 导购员2（如果有）
                        if (config.employee2) {
                            employeeSummaryArray.push({
                                来源表: fileName,
                                部门: config.department,
                                门店: storeName,
                                员工姓名: config.employee2,
                                销售数量: storeData.totalQuantity, // 该文件中门店的销售数量
                                总提成: avgCommission, // 平分后的提成
                                门店员工数: employeeCount,
                                门店总提成: storeData.totalCommission
                            });
                        }
                    }
                });
            });
            
            // 第三步：排序（按文件名、门店、员工姓名排序）
            employeeSummaryArray.sort((a, b) => {
                if (a.来源表 !== b.来源表) {
                    return a.来源表.localeCompare(b.来源表, 'zh-CN');
                }
                if (a.门店 !== b.门店) {
                    return a.门店.localeCompare(b.门店, 'zh-CN');
                }
                return a.员工姓名.localeCompare(b.员工姓名, 'zh-CN');
            });
            
            const employeeExportData = employeeSummaryArray.map((item, index) => {
                const employeeCount = item.门店员工数;
                const storeTotalCommission = item.门店总提成;
                const averageCommission = item.总提成; // 已经是平分后的提成
                const rate = getStoreCommissionRate(item.门店);
                const total = averageCommission * rate;
                const other = 0;
                const finalTotal = total + other;
                return {
                    '序号': index + 1,
                    '来源表': item.来源表,
                    '部门': item.部门,
                    '门店': item.门店,
                    '员工姓名': item.员工姓名,
                    '销售数量（台）': item.销售数量,
                    '个人提成（元）': item.总提成,
                    '门店员工数': employeeCount,
                    '门店总提成（元）': storeTotalCommission,
                    '平均分配提成（元）': averageCommission,
                    '门店提成系数': rate,
                    '合计（元）': total,
                    '其他': other > 0 ? other : '',
                    '总计（元）': finalTotal
                };
            });
            
            const employeeWs = XLSX.utils.json_to_sheet(employeeExportData);
            XLSX.utils.book_append_sheet(wb, employeeWs, '员工汇总表');
            
            // 添加未知数据明细工作表
            if (exportUnknownRecords.length > 0) {
                const unknownExportData = exportUnknownRecords.map((record, index) => ({
                    '序号': index + 1,
                    '来源表': record.来源表,
                    '门店': record.门店,
                    '部门': record.部门,
                    '促销员': record.促销员,
                    '物料名称': record.物料名称,
                    '规格型号': record.规格型号,
                    '销售数量': record.销售数量,
                    '单台提成（元）': record.单台提成,
                    '总提成（元）': record.总提成
                }));
                
                const unknownWs = XLSX.utils.json_to_sheet(unknownExportData);
                XLSX.utils.book_append_sheet(wb, unknownWs, '未知数据明细');
            }
            
            // 创建计算说明工作表
            const calculationExplanation = [
                { '分类': '数据来源', '项目': '销售数据表', '说明': '包含销售记录、促销员、门店、规格型号、销售数量等信息' },
                { '分类': '数据来源', '项目': '政策表', '说明': '包含规格型号与单台提成的对应关系' },
                { '分类': '数据来源', '项目': '渠道名单表', '说明': '包含部门、门店、导购人员1、导购人员2的配置信息' },
                { '分类': '', '项目': '', '说明': '' },
                { '分类': '计算流程', '项目': '步骤1', '说明': '读取销售数据，优先使用"规格型号"字段，如无则从"物料名称"自动提取型号' },
                { '分类': '计算流程', '项目': '步骤2', '说明': '在政策表中查找对应型号的单台提成（大小写不敏感）' },
                { '分类': '计算流程', '项目': '步骤3', '说明': '计算单条记录提成：单台提成 × 销售数量' },
                { '分类': '计算流程', '项目': '步骤4', '说明': '根据销售数据的门店字段或促销员字段，确定该条记录属于哪个门店' },
                { '分类': '计算流程', '项目': '步骤5', '说明': '按门店汇总：将所有销售记录按门店汇总，得到每个门店的总提成和总销售数量' },
                { '分类': '计算流程', '项目': '步骤6', '说明': '平均分配：门店总提成 ÷ 门店导购员数 = 每人分得的提成（从渠道名单读取导购员数）' },
                { '分类': '计算流程', '项目': '步骤7', '说明': '生成员工记录：根据渠道名单中配置的导购员，为每个导购员生成一条记录' },
                { '分类': '计算流程', '项目': '步骤8', '说明': '应用系数：分得的提成 × 门店系数 = 最终提成' },
                { '分类': '', '项目': '', '说明': '' },
                { '分类': '门店归属逻辑', '项目': '优先级1', '说明': '如果销售数据有"门店"字段且在渠道名单中能找到 → 直接使用' },
                { '分类': '门店归属逻辑', '项目': '优先级2', '说明': '如果没有门店但有"促销员"字段 → 在渠道名单中查找该促销员所属的门店' },
                { '分类': '门店归属逻辑', '项目': '关键特点', '说明': '不关心销售记录里的促销员是谁，只关心属于哪个门店，然后由渠道名单配置的导购员平分' },
                { '分类': '', '项目': '', '说明': '' },
                { '分类': '门店员工数规则', '项目': '数据来源', '说明': '从渠道名单配置读取，不是从销售数据统计' },
                { '分类': '门店员工数规则', '项目': '判断标准', '说明': '如果配置了导购人员1和2（非空）→员工数=2；只有导购人员1→员工数=1' },
                { '分类': '门店员工数规则', '项目': '重要', '说明': '即使导购员2没有销售记录，也会显示在汇总表中并参与平分' },
                { '分类': '', '项目': '', '说明': '' },
                { '分类': '汇总表字段', '项目': '来源表', '说明': '数据来源的销售文件名（每个员工在每个文件中都会有单独的一行）' },
                { '分类': '汇总表字段', '项目': '部门', '说明': '从渠道名单读取该门店的部门信息' },
                { '分类': '汇总表字段', '项目': '门店', '说明': '从渠道名单读取（或从销售数据确定）' },
                { '分类': '汇总表字段', '项目': '员工姓名', '说明': '从渠道名单的导购人员字段读取（导购人员1或导购人员2）' },
                { '分类': '汇总表字段', '项目': '销售数量', '说明': '该文件中该门店的总销售数量（同一文件同一门店的所有导购员显示相同数量）' },
                { '分类': '汇总表字段', '项目': '个人提成', '说明': '已经平分后的提成 = 该文件中门店总提成 ÷ 门店员工数' },
                { '分类': '汇总表字段', '项目': '门店员工数', '说明': '从渠道名单配置读取（导购人员1和2的数量）' },
                { '分类': '汇总表字段', '项目': '门店总提成', '说明': '该文件中该门店所有销售记录的提成总和' },
                { '分类': '汇总表字段', '项目': '平均分配提成', '说明': '与"个人提成"相同，都是平分后的金额' },
                { '分类': '汇总表字段', '项目': '门店提成系数', '说明': '杭州临平兴达店 = 1.1，其他门店 = 1.0' },
                { '分类': '汇总表字段', '项目': '合计', '说明': '平均分配提成 × 门店提成系数' },
                { '分类': '汇总表字段', '项目': '总计', '说明': '合计 + 其他（如有）' },
                { '分类': '', '项目': '', '说明': '' },
                { '分类': '重要说明', '项目': '分文件显示', '说明': '表格按来源文件分开显示，如果同一员工出现在多个文件中，会显示多行（每个文件一行）' },
                { '分类': '重要说明', '项目': '门店优先原则', '说明': '先按文件和门店汇总所有提成，再根据渠道名单配置的导购员平分' },
                { '分类': '重要说明', '项目': '平分规则', '说明': '同一文件同一门店的所有导购员平分该门店的总提成，与谁做的销售无关' },
                { '分类': '重要说明', '项目': '销售数量显示', '说明': '同一文件同一门店的所有导购员显示相同的销售数量（该文件中门店总数量）' },
                { '分类': '重要说明', '项目': '零销售也平分', '说明': '即使导购员2没有任何销售记录，也会显示在表中并平分提成' },
                { '分类': '重要说明', '项目': '导购员数量', '说明': '从渠道名单配置读取，不是从销售数据统计' },
                { '分类': '重要说明', '项目': '门店判断', '说明': '判断是否同一家门店看"门店"字段，不是看"部门"或"促销员"字段' },
                { '分类': '', '项目': '', '说明': '' },
                { '分类': '员工在职期间判断', '项目': '数据来源', '说明': '系统根据渠道名单中的"导购人员1入职日期"、"导购人员2入职日期"、"导购人员1离职日期"、"导购人员2离职日期"判断订单是否在员工在职期间' },
                { '分类': '员工在职期间判断', '项目': '入职前订单', '说明': '订单日期早于员工入职日期的订单，有效提成为0，备注标注"入职前订单"' },
                { '分类': '员工在职期间判断', '项目': '离职后订单', '说明': '订单日期晚于员工离职日期的订单，有效提成为0，备注标注"离职后订单"' },
                { '分类': '员工在职期间判断', '项目': '在职期订单', '说明': '订单日期在员工入职-离职期间的订单，正常计算提成，备注中显示在职日期范围' },
                { '分类': '员工在职期间判断', '项目': '非在职期订单处理', '说明': '非在职期订单仍会按配置的员工分配和显示，但有效提成为0，并在备注中详细标注原因' },
                { '分类': '员工在职期间判断', '项目': '向后兼容', '说明': '如果渠道名单中没有配置入职/离职日期字段，系统不会对该员工的订单进行日期限制' },
                { '分类': '', '项目': '', '说明': '' },
                { '分类': '特殊情况备注', '项目': '兴达表特殊处理', '说明': '所有文件名包含"兴达"关键词的销售表，其所有订单提成都归到巩建勋名下' },
                { '分类': '特殊情况备注', '项目': '兴达表门店设置', '说明': '自动设置门店为"杭州临平兴达"，员工为"巩建勋"' },
                { '分类': '特殊情况备注', '项目': '兴达表提成系数', '说明': '该门店提成系数为1.1（自动应用）' },
                { '分类': '特殊情况备注', '项目': '兴达表配置要求', '说明': '需要在渠道名单中配置：部门、门店=杭州临平兴达、导购人员=巩建勋' },
                { '分类': '', '项目': '', '说明': '' },
                { '分类': '特殊情况备注', '项目': '圣都表特殊处理', '说明': '所有文件名包含"圣都"关键词的销售表（如"圣都采购单明细导出导出数据-XXXXXX"），其所有订单提成都归到曾兴容名下' },
                { '分类': '特殊情况备注', '项目': '圣都表门店设置', '说明': '自动设置门店为"杭州圣都"，员工为"曾兴容"' },
                { '分类': '特殊情况备注', '项目': '圣都表提成系数', '说明': '该门店提成系数为1.0（普通系数）' },
                { '分类': '特殊情况备注', '项目': '圣都表配置要求', '说明': '需要在渠道名单中配置：部门、门店=杭州圣都、导购人员=曾兴容' },
                { '分类': '', '项目': '', '说明': '' },
                { '分类': '特殊情况备注', '项目': '湖州天猫店特殊处理', '说明': '所有文件名包含"湖州天猫"关键词的销售表，其所有订单提成都归到陈春艳名下' },
                { '分类': '特殊情况备注', '项目': '湖州天猫店门店设置', '说明': '自动设置门店为"湖州天猫店"，员工为"陈春艳"' },
                { '分类': '特殊情况备注', '项目': '湖州天猫店提成系数', '说明': '该门店提成系数为1.0（普通系数）' },
                { '分类': '特殊情况备注', '项目': '湖州天猫店配置要求', '说明': '需要在渠道名单中配置：部门、门店=湖州天猫店、导购人员=陈春艳' },
                { '分类': '', '项目': '', '说明': '' },
                { '分类': '特殊情况备注', '项目': '金华商城店', '说明': '京东电器城市旗舰店金华商城店（原江南店/金华店，2025年9月更名）' },
                { '分类': '特殊情况备注', '项目': '人员调整', '说明': '叶黄鹤于2025年3月调整到该店' },
                { '分类': '特殊情况备注', '项目': '促销员补充', '说明': '如该店销售记录促销员为空，自动填入"叶黄鹤"' },
                { '分类': '特殊情况备注', '项目': '注意事项', '说明': '请确保渠道名单中该门店配置了正确的导购员信息' },
                { '分类': '', '项目': '', '说明': '' },
                { '分类': '门店名称合并', '项目': '合并规则', '说明': '"京东电器城市旗舰店金华商城店"和"金华五星江南店"在统计时会被视为同一家店' },
                { '分类': '门店名称合并', '项目': '数据汇总', '说明': '两个门店的销售数据会合并汇总到"京东电器城市旗舰店金华商城店"名下' },
                { '分类': '门店名称合并', '项目': '提成分配', '说明': '提成会按照渠道名单中"京东电器城市旗舰店金华商城店"配置的导购员进行分配' }
            ];
            const explanationWs = XLSX.utils.json_to_sheet(calculationExplanation);
            XLSX.utils.book_append_sheet(wb, explanationWs, '计算说明');
            
            // 创建总体汇总表
            let totalRecords = 0;
            let grandTotalCommission = 0;
            let totalMatched = 0;
            let totalUnmatched = 0;
            
            Object.values(allResults).forEach(result => {
                totalRecords += result.recordCount;
                grandTotalCommission += result.totalCommission;
                if (result.debugInfo) {
                    totalMatched += result.debugInfo.matchedRecords;
                    totalUnmatched += result.debugInfo.unmatchedRecords;
                }
            });
            
            const overallSummaryData = [
                { '统计项': '处理文件数', '数值': salesFiles.length },
                { '统计项': '总记录数', '数值': totalRecords },
                { '统计项': '匹配成功', '数值': totalMatched },
                { '统计项': '未匹配', '数值': totalUnmatched },
                { '统计项': '总体匹配率', '数值': `${((totalMatched / totalRecords) * 100).toFixed(1)}%` },
                { '统计项': '总提成金额', '数值': `¥${grandTotalCommission.toFixed(2)}` }
            ];
            
            const overallSummaryWs = XLSX.utils.json_to_sheet(overallSummaryData);
            XLSX.utils.book_append_sheet(wb, overallSummaryWs, '总体汇总');
            
            // 创建文件汇总表
            const summaryData = Object.entries(allResults).map(([fileName, result]) => {
                const fileMatchRate = result.debugInfo ? 
                    ((result.debugInfo.matchedRecords / result.debugInfo.processedRecords) * 100).toFixed(1) : 0;
                return {
                    '文件名': fileName,
                    '记录数': result.recordCount,
                    '匹配成功': result.debugInfo ? result.debugInfo.matchedRecords : 0,
                    '未匹配': result.debugInfo ? result.debugInfo.unmatchedRecords : 0,
                    '匹配率': `${fileMatchRate}%`,
                    '总提成': result.totalCommission
                };
            });
            
            const summaryWs = XLSX.utils.json_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, summaryWs, '文件汇总');
            
            // 为每个文件创建工作表
            salesFiles.forEach((fileObj, index) => {
                if (fileObj.results) {
                    const exportData = fileObj.results.data.map(row => ({
                        '日期': row.date,
                        '单据编号': row.orderNo,
                        '用户姓名': row.userName,
                        '门店': row.store,
                        '促销员': row.salesPerson,
                        '促销员来源': row.salesPersonSource === 'direct' ? '直接' : 
                                    row.salesPersonSource === 'store' ? '门店匹配促销员' : 
                                    row.salesPersonSource === 'department' ? '部门匹配' : 
                                    row.salesPersonSource === 'special' ? '特殊规则' :
                                    row.salesPersonSource === 'employee_to_store' ? '促销员匹配门店' :
                                    row.salesPersonSource === 'xingda_special' ? '兴达特殊处理' :
                                    row.salesPersonSource === 'shengdu_special' ? '圣都特殊处理' :
                                    row.salesPersonSource === 'huzhou_special' ? '湖州天猫特殊处理' : '',
                        '物料名称': row.materialName,
                        '规格型号': row.model,
                        '型号来源': row.modelSource === 'model' ? '规格型号' : row.modelSource === 'material' ? '物料提取' : '未知',
                        '标准化型号': row.normalizedModel,
                        '销售数量': row.quantity,
                        '单台提成': row.unitCommission,
                        '原始提成': row.totalCommission,
                        '有效提成': row.effectiveCommission,
                        '备注': row.remark || '',
                        '匹配状态': row.isMatched ? '已匹配' : '未匹配'
                    }));
                    
                    const ws = XLSX.utils.json_to_sheet(exportData);
                    const sheetName = fileObj.name.replace(/\.[^/.]+$/, '').substring(0, 31); // Excel工作表名称限制
                    XLSX.utils.book_append_sheet(wb, ws, sheetName);
                }
            });
            
            // 添加全部未匹配型号汇总
            const allUnmatchedModels = new Set();
            Object.values(matchingDebugInfo).forEach(debugInfo => {
                if (debugInfo.unmatchedModels) {
                    debugInfo.unmatchedModels.forEach(model => allUnmatchedModels.add(model));
                }
            });
            
            if (allUnmatchedModels.size > 0) {
                const unmatchedData = Array.from(allUnmatchedModels).sort().map(model => ({
                    '原始型号': model,
                    '标准化型号': normalizeModel(model)
                }));
                
                const unmatchedWs = XLSX.utils.json_to_sheet(unmatchedData);
                XLSX.utils.book_append_sheet(wb, unmatchedWs, '全部未匹配型号');
            }
            
            // 添加政策表型号列表
            if (matchingDebugInfo.policy && matchingDebugInfo.policy.policyModels.length > 0) {
                const policyData = matchingDebugInfo.policy.policyModels.map(item => ({
                    '原始型号': item.original,
                    '标准化型号': item.normalized,
                    '单台提成': item.commission
                }));
                
                const policyWs = XLSX.utils.json_to_sheet(policyData);
                XLSX.utils.book_append_sheet(wb, policyWs, '政策表型号');
            }
            
            const fileName = `批量提成计算结果_${new Date().toLocaleDateString().replace(/\//g, '-')}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showSuccess(`已导出所有结果到文件：${fileName}`);
        }
        
        // 分别导出每个文件的结果
        function exportSeparateResults() {
            let exportCount = 0;
            
            salesFiles.forEach((fileObj, index) => {
                if (fileObj.results) {
                    exportSingleResult(index);
                    exportCount++;
                }
            });
            
            if (exportCount > 0) {
                showSuccess(`已分别导出 ${exportCount} 个文件的计算结果`);
            } else {
                showError('没有可导出的结果');
            }
        }
        
        // 工具函数
        function showError(message) {
            const errorDiv = document.getElementById('errorMsg');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }
        
        function showSuccess(message) {
            const successDiv = document.getElementById('successMsg');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => successDiv.style.display = 'none', 3000);
        }
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            window.addEventListener('error', function(event) {
                try { hideLoading(); } catch (_) {}
                const msg = (event && event.error && event.error.message) ? event.error.message : (event && event.message ? event.message : '发生未知错误');
                showError(`页面错误：${msg}（可打开控制台查看详情）`);
                console.error('页面错误:', event && event.error ? event.error : event);
            });
            
            window.addEventListener('unhandledrejection', function(event) {
                try { hideLoading(); } catch (_) {}
                const reason = event && event.reason;
                const msg = reason && reason.message ? reason.message : (typeof reason === 'string' ? reason : 'Promise 未处理异常');
                showError(`页面错误：${msg}（可打开控制台查看详情）`);
                console.error('Promise 未处理异常:', reason);
            });

            setupFileUpload();
            bindPersistMappingListeners();
            restorePersistedWorkbook('policy');
            restorePersistedWorkbook('storeList');
            updateWorkflowStatus();
        });
    </script>
    
    </body>
    </html>
