<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>菜品监控系统</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header" role="banner">
            <h1>🍽️ 菜品监控系统</h1>
            <p>上传、管理和监控您的菜品数据</p>
        </div>

        <section class="upload-section" aria-labelledby="uploadTitle">
            <div class="upload-area" id="uploadArea" role="button" tabindex="0" aria-describedby="uploadHelp">
                <div class="upload-icon">📁</div>
                <h3 id="uploadTitle">上传菜品数据</h3>
                <p>拖拽 CSV / Excel 文件到此处，或点击选择文件</p>
                <p id="uploadHelp" class="help-text">支持格式：图片URL, 菜品名称, 分类, 价格</p>
                <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" class="visually-hidden" aria-hidden="true">
                <button class="btn btn-primary mt-3" onclick="document.getElementById('fileInput').click()">
                    选择文件
                </button>
            </div>
        </section>

        <section class="controls" role="region" aria-label="筛选与搜索">
            <div class="control-group">
                <label for="categoryFilter">分类筛选</label>
                <select id="categoryFilter" aria-label="分类筛选">
                    <option value="">全部分类</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>价格范围</label>
                <div class="inline">
                    <input type="number" id="minPrice" class="input-compact" placeholder="最低价格" aria-label="最低价格">
                    <input type="number" id="maxPrice" class="input-compact" placeholder="最高价格" aria-label="最高价格">
                </div>
            </div>
            
            <div class="control-group">
                <label for="sortBy">排序方式</label>
                <select id="sortBy" aria-label="排序方式">
                    <option value="name">按名称</option>
                    <option value="price-asc">价格从低到高</option>
                    <option value="price-desc">价格从高到低</option>
                    <option value="category">按分类</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="searchInput">搜索</label>
                <input type="text" id="searchInput" placeholder="搜索菜品名称..." aria-label="搜索菜品名称">
            </div>
            
            <button class="btn btn-success" onclick="applyFilters()">应用筛选</button>
            <button class="btn btn-danger" onclick="clearFilters()">清除筛选</button>
            <button class="btn btn-danger" onclick="clearAllData()">清空数据</button>
        </section>

        <section class="ai-settings" role="region" aria-labelledby="aiSettingsTitle">
            <h3 id="aiSettingsTitle">🤖 AI 设置</h3>
            <div class="ai-form-row">
                <div class="ai-input-group">
                    <label for="aiBaseUrl">Base URL</label>
                    <input type="text" id="aiBaseUrl" placeholder="例如：https://api.openai.com 或 https://openrouter.ai/api" autocomplete="off">
                </div>
                <div class="ai-input-group">
                    <label for="aiApiKey">API Key</label>
                    <div class="inline">
                        <input type="password" id="aiApiKey" placeholder="请输入 API Key" style="flex:1;">
                        <button id="toggleKeyVisibility" class="btn btn-outline" title="显示/隐藏">👁</button>
                    </div>
                </div>
                <div class="ai-input-group">
                    <label for="aiModelId">Model ID</label>
                    <input type="text" id="aiModelId" placeholder="例如：gpt-4o-mini / deepseek-chat / llama-3.1-70b" autocomplete="off">
                </div>
                <div class="ai-actions">
                    <button id="saveAIConfigBtn" class="btn btn-primary">保存设置</button>
                    <button id="testAIConfigBtn" class="btn btn-secondary">测试连接</button>
                    <button id="clearAIConfigBtn" class="btn btn-danger">清除凭据</button>
                </div>
            </div>
            <div class="help-text">提示：测试连接可能调用一次最小对话接口，产生极少量 token 消耗；请确认目标服务允许浏览器跨域（CORS）。</div>
        </section>

        <section class="stats" id="stats" role="contentinfo" aria-label="统计概览">
            <div class="stat-item">
                <div class="stat-number" id="totalDishes">0</div>
                <div class="stat-label">总菜品数</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="totalCategories">0</div>
                <div class="stat-label">分类数量</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="avgPrice">¥0</div>
                <div class="stat-label">平均价格</div>
            </div>
        </section>

        <main class="dish-grid" id="dishGrid" aria-live="polite">
            <div class="empty-state">
                <div class="empty-icon">🍽️</div>
                <h3>暂无菜品数据</h3>
                <p>请上传CSV或Excel文件来添加菜品信息</p>
            </div>
        </main>
    </div>

    <!-- 菜品详情模态弹窗 -->
    <div id="dishDetailOverlay" class="modal-overlay" tabindex="-1" aria-hidden="true"></div>
    <div id="dishDetailModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="detailName">
        <button class="modal-close" id="dishDetailCloseBtn" title="关闭" aria-label="关闭">×</button>
        <img id="detailImage" class="detail-image" alt="菜品图片" decoding="async" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDMwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjhGOUZBIi8+CjxwYXRoIGQ9Ik0xNTAgMTAwQzE1MCA4Ni4xOTI5IDE1MCA3Mi4zODU4IDE1MCA1OC41Nzg3QzE1MCA0NC43NzE2IDE1MCAzMC45NjQ1IDE1MCAyMC4xNTc0QzE1MCA5LjM1MDMgMTUwIDAgMTUwIDBIMTUwQzE1MCA5LjM1MDMgMTUwIDE4LjcwMDYgMTUwIDI4LjA1MDlDMTUwIDM3LjQwMTIgMTUwIDQ2Ljc1MTUgMTUwIDU2LjEwMThDMTUwIDY1LjQ1MjEgMTUwIDc0LjgwMjQgMTUwIDg0LjE1MjdDMTUwIDkzLjUwMyAxNTAgMTAyLjg1MyAxNTAgMTEyLjIwM0MxNTAgMTIxLjU1MyAxNTAgMTMwLjkwMyAxNTAgMTQwLjI1M0MxNTAgMTQ5LjYwMyAxNTAgMTU4Ljk1MyAxNTAgMTY4LjMwM0MxNTAgMTc3LjY1MyAxNTAgMTg3LjAwMyAxNTAgMTk2LjM1M0MxNTAgMjAwIDE1MCAyMDAgMTUwIDIwMEgxNTBDMTUwIDIwMCAxNTAgMjAwIDE1MCAyMDBWMTAwWiIgZmlsbD0iI0RFRTJFNiIvPgo8dGV4dCB4PSIxNTAiIHk9IjEwNSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzZDNzU3RCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0Ij7lm77niYfkuI3lrZjlnKg8L3RleHQ+Cjwvc3ZnPgo='">
        <div class="detail-body">
            <h2 id="detailName" class="detail-name"></h2>
            <div class="detail-rows">
              <div class="detail-row"><span class="label">日文名</span><span id="detailNameJP" class="value"></span></div>
              <div class="detail-row"><span class="label">中文名</span><span id="detailNameCN" class="value"></span></div>
              <div class="detail-row"><span class="label">价格</span><span id="detailPrice" class="value dish-price"></span></div>
              <div class="detail-row"><span class="label">店名</span><span id="detailShop" class="value"></span></div>
              <div class="detail-row"><span class="label">分类</span><span id="detailCategory" class="value dish-category"></span></div>
            </div>
            <p id="detailDesc" class="detail-desc" style="display:none;"></p>
        </div>
    </div>

    <!-- 漂浮聊天控件 -->
    <button class="chat-toggle" id="chatToggleBtn" title="AI 助手" aria-label="打开 AI 助手">🤖</button>
    <div class="chat-panel" id="chatPanel" role="dialog" aria-labelledby="chatTitle" aria-modal="false">
        <div class="chat-header">
            <span class="title" id="chatTitle">AI 菜品助理</span>
            <button class="close-btn" id="chatCloseBtn" title="关闭" aria-label="关闭聊天">×</button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="chat-message assistant">
                <div class="bubble">你好！我可以基于本页的菜品数据回答问题。例如：
- “烤牛五花与内脏盖饭”的店名是什么？
- 最便宜的定食是什么？
- 价格高于 900 的菜有哪些？
- 按分类列出每类平均价格</div>
            </div>
        </div>
        <div class="chat-input">
            <div class="footer">
                <label class="toggle">
                    <input type="checkbox" id="useFiltered" checked>
                    仅使用当前筛选结果
                </label>
                <span id="dataSummary" style="font-size:12px;color:#6c757d;">数据：0 条</span>
            </div>
            <div class="row">
                <textarea id="chatInput" placeholder="请输入你的问题，Enter 发送，Shift+Enter 换行"></textarea>
                <button id="chatSendBtn" class="btn btn-primary">发送</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="script.js"></script>
</body>
</html>
