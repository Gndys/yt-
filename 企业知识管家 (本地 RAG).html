<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>🤖 企业知识管家 - 本地 RAG</title>
<style>
  * { box-sizing: border-box; }
  body { 
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    max-width: 1000px; margin: 0 auto; padding: 20px;
    background: #f8f9fa; color: #333;
  }
  .header { 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px;
    text-align: center;
  }
  .card { 
    background: white; padding: 25px; border-radius: 12px; 
    box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;
  }
  .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
  .tab { 
    padding: 12px 24px; border: none; border-radius: 8px;
    background: #e9ecef; cursor: pointer; transition: all 0.3s;
  }
  .tab.active { background: #007bff; color: white; }
  .tab-content { display: none; }
  .tab-content.active { display: block; }
  
  .upload-zone { 
    border: 2px dashed #007bff; border-radius: 12px; padding: 40px;
    text-align: center; cursor: pointer; transition: all 0.3s;
    background: #f8f9ff;
  }
  .upload-zone:hover { border-color: #0056b3; background: #e6f0ff; }
  .upload-zone.dragover { border-color: #28a745; background: #e8f5e9; }
  
  input[type="password"], input[type="text"], textarea {
    width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;
    font-size: 14px; margin: 10px 0;
  }
  button { 
    background: #007bff; color: white; border: none; padding: 12px 24px;
    border-radius: 8px; cursor: pointer; font-size: 14px; transition: all 0.3s;
  }
  button:hover { background: #0056b3; }
  button:disabled { background: #6c757d; cursor: not-allowed; }
  
  .doc-list { margin-top: 20px; }
  .doc-item { 
    display: flex; justify-content: space-between; align-items: center;
    padding: 12px; border: 1px solid #eee; border-radius: 8px; margin: 8px 0;
    background: #f8f9fa;
  }
  .doc-item .info { flex: 1; }
  .doc-item .actions { display: flex; gap: 8px; }
  .doc-item button { padding: 6px 12px; font-size: 12px; }
  
  .chat-container { max-height: 400px; overflow-y: auto; border: 1px solid #eee; 
                    border-radius: 8px; padding: 15px; background: #fafafa; }
  .message { margin: 10px 0; padding: 12px; border-radius: 8px; }
  .user-msg { background: #007bff; color: white; margin-left: 20%; }
  .ai-msg { background: white; border: 1px solid #eee; margin-right: 20%; }
  .loading { text-align: center; color: #666; font-style: italic; }
  
  .stats { display: flex; gap: 20px; text-align: center; }
  .stat-item { flex: 1; padding: 15px; background: #e9ecef; border-radius: 8px; }
  .stat-number { font-size: 24px; font-weight: bold; color: #007bff; }
</style>
</head>
<body>
  <div class="header">
    <h1>🤖 企业知识管家</h1>
    <p>上传文档，智能问答 - 本地 RAG 系统</p>
  </div>

  <!-- API Key 配置 -->
  <div class="card">
    <h3>🔑 DeepSeek API 配置</h3>
    <input type="password" id="apiKey" placeholder="请输入 DeepSeek API Key (sk-...)" />
    <button onclick="saveApiKey()">保存密钥</button>
    <span id="keyStatus" style="margin-left: 10px;"></span>
  </div>

  <!-- 标签页 -->
  <div class="tabs">
    <button class="tab active" onclick="switchTab('upload')">📁 文档管理</button>
    <button class="tab" onclick="switchTab('chat')">💬 智能问答</button>
    <button class="tab" onclick="switchTab('stats')">📊 统计信息</button>
  </div>

  <!-- 文档上传页面 -->
  <div id="upload" class="tab-content active">
    <div class="card">
      <h3>📤 上传文档</h3>
      <div class="upload-zone" id="uploadZone">
        <p>📄 拖拽文件到此处或点击选择</p>
        <p style="color: #666; font-size: 14px;">支持 .txt, .md 格式</p>
        <input type="file" id="fileInput" multiple accept=".txt,.md" style="display: none;" />
      </div>
      
      <div class="doc-list">
        <h4>📚 已上传文档 (<span id="docCount">0</span>)</h4>
        <div id="docList"></div>
      </div>
    </div>
  </div>

  <!-- 智能问答页面 -->
  <div id="chat" class="tab-content">
    <div class="card">
      <h3>💬 智能问答</h3>
      <div class="chat-container" id="chatContainer"></div>
      <textarea id="questionInput" placeholder="请输入您的问题..." rows="3"></textarea>
      <button onclick="askQuestion()" id="askBtn">🚀 提问</button>
      <button onclick="clearChat()" style="background: #6c757d;">🗑️ 清空对话</button>
    </div>
  </div>

  <!-- 统计信息页面 -->
  <div id="stats" class="tab-content">
    <div class="card">
      <h3>📊 系统统计</h3>
      <div class="stats">
        <div class="stat-item">
          <div class="stat-number" id="totalDocs">0</div>
          <div>文档数量</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="totalChunks">0</div>
          <div>文本段落</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="totalQuestions">0</div>
          <div>问答次数</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 全局变量
    let db;
    let apiKey = localStorage.getItem('deepseek_key') || '';
    let chatHistory = [];
    let questionCount = parseInt(localStorage.getItem('question_count') || '0');

    // 初始化 IndexedDB
    async function initDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open('KnowledgeBase', 1);
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
          db = request.result;
          resolve(db);
        };
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains('documents')) {
            db.createObjectStore('documents', { keyPath: 'id' });
          }
          if (!db.objectStoreNames.contains('chunks')) {
            db.createObjectStore('chunks', { keyPath: 'id' });
          }
        };
      });
    }

    // 页面初始化
    window.onload = async function() {
      await initDB();
      loadApiKey();
      loadDocuments();
      updateStats();
      setupEventListeners();
    };

    function loadApiKey() {
      if (apiKey) {
        document.getElementById('apiKey').value = apiKey;
        document.getElementById('keyStatus').innerHTML = '✅ 已保存';
        document.getElementById('keyStatus').style.color = 'green';
      }
    }

    function saveApiKey() {
      apiKey = document.getElementById('apiKey').value.trim();
      if (apiKey.startsWith('sk-')) {
        localStorage.setItem('deepseek_key', apiKey);
        document.getElementById('keyStatus').innerHTML = '✅ 保存成功';
        document.getElementById('keyStatus').style.color = 'green';
      } else {
        alert('请输入有效的 API Key (以 sk- 开头)');
      }
    }

    function setupEventListeners() {
      const uploadZone = document.getElementById('uploadZone');
      const fileInput = document.getElementById('fileInput');

      uploadZone.onclick = () => fileInput.click();
      fileInput.onchange = handleFileSelect;

      uploadZone.ondragover = (e) => {
        e.preventDefault();
        uploadZone.classList.add('dragover');
      };
      uploadZone.ondragleave = () => uploadZone.classList.remove('dragover');
      uploadZone.ondrop = (e) => {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        handleFileSelect({ target: { files: e.dataTransfer.files } });
      };

      document.getElementById('questionInput').onkeypress = (e) => {
        if (e.key === 'Enter' && e.ctrlKey) askQuestion();
      };
    }

    async function handleFileSelect(event) {
      const files = Array.from(event.target.files);
      for (const file of files) {
        if (file.type === 'text/plain' || file.name.endsWith('.md') || file.name.endsWith('.txt')) {
          await processFile(file);
        } else {
          alert(`不支持的文件格式: ${file.name}`);
        }
      }
      loadDocuments();
      updateStats();
    }

    async function processFile(file) {
      const text = await file.text();
      const docId = 'doc_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      
      // 保存文档信息
      const docInfo = {
        id: docId,
        name: file.name,
        size: file.size,
        uploadTime: new Date().toISOString(),
        content: text
      };

      const transaction = db.transaction(['documents', 'chunks'], 'readwrite');
      await transaction.objectStore('documents').add(docInfo);

      // 文本分段
      const chunks = chunkText(text, 300);
      for (let i = 0; i < chunks.length; i++) {
        const chunkId = docId + '_chunk_' + i;
        const chunkData = {
          id: chunkId,
          docId: docId,
          content: chunks[i],
          index: i,
          embedding: await getEmbedding(chunks[i]) // 这里简化处理，实际可以调用 DeepSeek embedding
        };
        await transaction.objectStore('chunks').add(chunkData);
      }
      
      await transaction.complete;
      addMessage('system', `✅ 文档 "${file.name}" 上传成功，已分割为 ${chunks.length} 个段落`);
    }

    function chunkText(text, maxLength) {
      const sentences = text.split(/[。！？\n]+/).filter(s => s.trim());
      const chunks = [];
      let currentChunk = '';

      for (const sentence of sentences) {
        if (currentChunk.length + sentence.length > maxLength && currentChunk) {
          chunks.push(currentChunk.trim());
          currentChunk = sentence;
        } else {
          currentChunk += (currentChunk ? '。' : '') + sentence;
        }
      }
      if (currentChunk) chunks.push(currentChunk.trim());
      return chunks;
    }

    // 简化的嵌入向量生成（实际应该调用 DeepSeek API）
    async function getEmbedding(text) {
      // 这里使用简单的文本特征作为向量（生产环境应调用真实的 embedding API）
      const words = text.toLowerCase().match(/\w+/g) || [];
      const vector = new Array(100).fill(0);
      for (let i = 0; i < words.length && i < 100; i++) {
        vector[i] = words[i].charCodeAt(0) / 255;
      }
      return vector;
    }

    function cosineSimilarity(a, b) {
      let dotProduct = 0, normA = 0, normB = 0;
      for (let i = 0; i < a.length; i++) {
        dotProduct += a[i] * b[i];
        normA += a[i] * a[i];
        normB += b[i] * b[i];
      }
      return dotProduct / (Math.sqrt(normA) * Math.sqrt(normB));
    }

    async function loadDocuments() {
      const transaction = db.transaction(['documents'], 'readonly');
      const docs = await getAllFromStore(transaction.objectStore('documents'));
      
      const docList = document.getElementById('docList');
      const docCount = document.getElementById('docCount');
      
      docCount.textContent = docs.length;
      docList.innerHTML = docs.map(doc => `
        <div class="doc-item">
          <div class="info">
            <strong>${doc.name}</strong>
            <div style="font-size: 12px; color: #666;">
              ${(doc.size / 1024).toFixed(1)} KB · ${new Date(doc.uploadTime).toLocaleString()}
            </div>
          </div>
          <div class="actions">
            <button onclick="deleteDocument('${doc.id}')" style="background: #dc3545;">删除</button>
          </div>
        </div>
      `).join('');
    }

    async function deleteDocument(docId) {
      if (!confirm('确定要删除这个文档吗？')) return;
      
      const transaction = db.transaction(['documents', 'chunks'], 'readwrite');
      await transaction.objectStore('documents').delete(docId);
      
      // 删除相关的文本段落
      const chunkStore = transaction.objectStore('chunks');
      const chunks = await getAllFromStore(chunkStore);
      for (const chunk of chunks) {
        if (chunk.docId === docId) {
          await chunkStore.delete(chunk.id);
        }
      }
      
      await transaction.complete;
      loadDocuments();
      updateStats();
      addMessage('system', '🗑️ 文档删除成功');
    }

    async function askQuestion() {
      const question = document.getElementById('questionInput').value.trim();
      if (!question) return;
      if (!apiKey) {
        alert('请先配置 DeepSeek API Key');
        return;
      }

      document.getElementById('questionInput').value = '';
      addMessage('user', question);
      
      const askBtn = document.getElementById('askBtn');
      askBtn.disabled = true;
      askBtn.textContent = '🤔 思考中...';

      try {
        // 检索相关文档段落
        const relevantChunks = await searchRelevantChunks(question, 3);
        const context = relevantChunks.map(chunk => chunk.content).join('\n---\n');
        
        // 调用 DeepSeek API
        const answer = await callDeepSeekAPI(question, context);
        addMessage('ai', answer);
        
        questionCount++;
        localStorage.setItem('question_count', questionCount.toString());
        updateStats();
        
      } catch (error) {
        addMessage('ai', `❌ 出错了: ${error.message}`);
      } finally {
        askBtn.disabled = false;
        askBtn.textContent = '🚀 提问';
      }
    }

    async function searchRelevantChunks(query, topK) {
      const queryEmbedding = await getEmbedding(query);
      const transaction = db.transaction(['chunks'], 'readonly');
      const chunks = await getAllFromStore(transaction.objectStore('chunks'));
      
      // 计算相似度并排序
      const scored = chunks.map(chunk => ({
        ...chunk,
        similarity: cosineSimilarity(queryEmbedding, chunk.embedding)
      })).sort((a, b) => b.similarity - a.similarity);
      
      return scored.slice(0, topK);
    }

    async function callDeepSeekAPI(question, context) {
      const messages = [
        {
          role: 'system',
          content: `你是一个企业知识助手。请基于以下文档内容回答用户问题，如果文档中没有相关信息，请诚实地说明。

文档内容：
${context}

请用中文回答，语言要专业但易懂。`
        },
        { role: 'user', content: question }
      ];

      const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: 'deepseek-chat',
          messages: messages,
          temperature: 0.3,
          max_tokens: 2000
        })
      });

      if (!response.ok) {
        throw new Error(`API 调用失败: ${response.status}`);
      }

      const data = await response.json();
      return data.choices[0].message.content;
    }

    function addMessage(type, content) {
      const chatContainer = document.getElementById('chatContainer');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type === 'user' ? 'user-msg' : 'ai-msg'}`;
      
      const prefix = type === 'user' ? '👤 ' : type === 'ai' ? '🤖 ' : 'ℹ️ ';
      messageDiv.innerHTML = prefix + content.replace(/\n/g, '<br>');
      
      chatContainer.appendChild(messageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function clearChat() {
      document.getElementById('chatContainer').innerHTML = '';
      chatHistory = [];
    }

    async function updateStats() {
      const docTransaction = db.transaction(['documents'], 'readonly');
      const docs = await getAllFromStore(docTransaction.objectStore('documents'));
      
      const chunkTransaction = db.transaction(['chunks'], 'readonly');
      const chunks = await getAllFromStore(chunkTransaction.objectStore('chunks'));
      
      document.getElementById('totalDocs').textContent = docs.length;
      document.getElementById('totalChunks').textContent = chunks.length;
      document.getElementById('totalQuestions').textContent = questionCount;
    }

    function switchTab(tabName) {
      // 隐藏所有标签页内容
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // 显示选中的标签页
      document.getElementById(tabName).classList.add('active');
      event.target.classList.add('active');
    }

    // 辅助函数：从 IndexedDB store 获取所有数据
    function getAllFromStore(store) {
      return new Promise((resolve, reject) => {
        const request = store.getAll();
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }
  </script>
</body>
</html>