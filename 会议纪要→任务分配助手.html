<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>📝 会议纪要→任务分配助手</title>
<style>
  * { box-sizing: border-box; }
  body { 
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    max-width: 1200px; margin: 0 auto; padding: 20px;
    background: #f5f7fa; color: #333;
  }
  .header { 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px;
    text-align: center;
  }
  .card { 
    background: white; padding: 25px; border-radius: 12px; 
    box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;
  }
  .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
  .tab { 
    padding: 12px 20px; border: none; border-radius: 8px;
    background: #e9ecef; cursor: pointer; transition: all 0.3s;
    font-size: 14px;
  }
  .tab.active { background: #007bff; color: white; }
  .tab-content { display: none; }
  .tab-content.active { display: block; }
  
  input[type="password"], input[type="text"], textarea, select {
    width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;
    font-size: 14px; margin: 10px 0;
  }
  button { 
    background: #007bff; color: white; border: none; padding: 12px 20px;
    border-radius: 8px; cursor: pointer; font-size: 14px; transition: all 0.3s;
    margin: 5px;
  }
  button:hover { background: #0056b3; }
  button:disabled { background: #6c757d; cursor: not-allowed; }
  button.danger { background: #dc3545; }
  button.danger:hover { background: #c82333; }
  button.success { background: #28a745; }
  button.success:hover { background: #218838; }
  
  .recording-section { 
    background: #f8f9ff; padding: 25px; border-radius: 12px; 
    border: 2px solid #007bff; margin: 20px 0; text-align: center;
  }
  .recording-active { 
    background: #fff5f5; border-color: #dc3545; 
    animation: pulse 2s infinite;
  }
  @keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); }
    70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
    100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
  }
  
  .transcript-box { 
    background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px;
    padding: 20px; margin: 15px 0; max-height: 300px; overflow-y: auto;
    font-family: 'Courier New', monospace; line-height: 1.6;
  }
  
  .task-item { 
    background: #fff; border: 1px solid #e9ecef; border-radius: 8px;
    padding: 15px; margin: 10px 0; transition: all 0.3s;
  }
  .task-item:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
  .task-header { 
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 10px;
  }
  .task-title { font-weight: 600; color: #007bff; margin: 0; }
  .task-priority { 
    padding: 4px 8px; border-radius: 4px; font-size: 12px; color: white;
  }
  .priority-high { background: #dc3545; }
  .priority-medium { background: #ffc107; color: #333; }
  .priority-low { background: #28a745; }
  .task-assignee { 
    background: #e3f2fd; padding: 6px 12px; border-radius: 6px;
    font-size: 14px; margin: 5px 0;
  }
  .task-deadline { color: #666; font-size: 13px; }
  
  .member-list { 
    display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0;
  }
  .member-tag { 
    background: #007bff; color: white; padding: 6px 12px; 
    border-radius: 20px; font-size: 13px; cursor: pointer;
    transition: all 0.3s;
  }
  .member-tag:hover { background: #0056b3; }
  .member-tag.selected { background: #28a745; }
  
  .stats-grid { 
    display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
    gap: 15px; margin: 20px 0;
  }
  .stat-card { 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white; padding: 20px; border-radius: 8px; text-align: center;
  }
  .stat-number { font-size: 24px; font-weight: bold; margin-bottom: 5px; }
  .stat-label { font-size: 14px; opacity: 0.9; }
  
  .timeline { position: relative; margin: 20px 0; }
  .timeline-item { 
    background: white; border-left: 3px solid #007bff; 
    padding: 15px 20px; margin: 10px 0; border-radius: 0 8px 8px 0;
  }
  .timeline-time { color: #666; font-size: 12px; }
  .timeline-content { margin-top: 5px; }
  
  .export-section { 
    background: #f0f8f0; padding: 20px; border-radius: 8px; 
    border: 1px solid #d4edda; margin: 20px 0;
  }
  
  .upload-zone { 
    border: 2px dashed #007bff; border-radius: 12px; padding: 30px;
    text-align: center; cursor: pointer; transition: all 0.3s;
    background: #f8f9ff; margin: 20px 0;
  }
  .upload-zone:hover { border-color: #0056b3; background: #e6f0ff; }
  .upload-zone.dragover { border-color: #28a745; background: #e8f5e9; }
  
  .progress-bar { 
    width: 100%; height: 8px; background: #e9ecef; border-radius: 4px;
    overflow: hidden; margin: 10px 0;
  }
  .progress-fill { 
    height: 100%; background: #007bff; transition: width 0.3s;
  }
</style>
</head>
<body>
  <div class="header">
    <h1>📝 会议纪要→任务分配助手</h1>
    <p>录音转文字 → 智能提取任务 → 自动分配跟进</p>
  </div>

  <!-- API Key 配置 -->
  <div class="card">
    <h3>🔑 DeepSeek API 配置</h3>
    <input type="password" id="apiKey" placeholder="请输入 DeepSeek API Key (sk-...)" />
    <button onclick="saveApiKey()">保存密钥</button>
    <span id="keyStatus" style="margin-left: 10px;"></span>
  </div>

  <!-- 标签页 -->
  <div class="tabs">
    <button class="tab active" onclick="switchTab('record')">🎙️ 会议录音</button>
    <button class="tab" onclick="switchTab('transcript')">📄 文字整理</button>
    <button class="tab" onclick="switchTab('tasks')">✅ 任务分配</button>
    <button class="tab" onclick="switchTab('export')">📤 导出跟进</button>
    <button class="tab" onclick="switchTab('history')">📋 历史会议</button>
  </div>

  <!-- 会议录音页面 -->
  <div id="record" class="tab-content active">
    <div class="card">
      <h3>🎙️ 会议录音</h3>
      
      <div>
        <label>会议主题：</label>
        <input type="text" id="meetingTitle" placeholder="例如：产品规划周会、项目进度同步..." />
      </div>
      
      <div>
        <label>参会人员：</label>
        <input type="text" id="attendees" placeholder="用逗号分隔，例如：张三,李四,王五" />
      </div>
      
      <div class="recording-section" id="recordingSection">
        <div id="recordingStatus">
          <h4>🎤 准备录音</h4>
          <p>点击开始按钮开始录制会议音频</p>
        </div>
        
        <div>
          <button id="startRecord" onclick="startRecording()">🔴 开始录音</button>
          <button id="stopRecord" onclick="stopRecording()" disabled>⏹️ 停止录音</button>
          <button id="pauseRecord" onclick="pauseRecording()" disabled>⏸️ 暂停</button>
        </div>
        
        <div id="recordingTime" style="font-size: 18px; font-weight: bold; margin: 15px 0;">
          00:00:00
        </div>
        
        <div class="progress-bar">
          <div class="progress-fill" id="recordingProgress"></div>
        </div>
      </div>
      
      <div class="upload-zone" id="uploadZone" style="margin-top: 30px;">
        <p>📁 或者上传已有的音频文件</p>
        <p style="color: #666; font-size: 14px;">支持 .mp3, .wav, .m4a 格式</p>
        <input type="file" id="audioInput" accept="audio/*" style="display: none;" />
      </div>
      
      <div id="audioPreview"></div>
    </div>
  </div>

  <!-- 文字整理页面 -->
  <div id="transcript" class="tab-content">
    <div class="card">
      <h3>📄 会议纪要整理</h3>
      
      <div style="margin-bottom: 20px;">
        <button onclick="transcribeAudio()" id="transcribeBtn">🔄 转换为文字</button>
        <button onclick="summarizeMeeting()" id="summarizeBtn" disabled>📝 生成摘要</button>
        <button onclick="editTranscript()" id="editBtn" disabled>✏️ 编辑内容</button>
      </div>
      
      <div class="transcript-box" id="transcriptContent">
        <p style="color: #666; text-align: center;">请先录音或上传音频文件</p>
      </div>
      
      <div id="meetingSummary" style="display: none;">
        <h4>📋 会议摘要</h4>
        <div class="card" style="background: #f8f9ff;">
          <div id="summaryContent"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 任务分配页面 -->
  <div id="tasks" class="tab-content">
    <div class="card">
      <h3>✅ 任务提取与分配</h3>
      
      <div style="margin-bottom: 20px;">
        <button onclick="extractTasks()" id="extractBtn">🔍 提取任务</button>
        <button onclick="assignTasks()" id="assignBtn" disabled>👥 智能分配</button>
        <button onclick="addCustomTask()" id="addTaskBtn">➕ 手动添加</button>
      </div>
      
      <div class="stats-grid" id="taskStats" style="display: none;">
        <div class="stat-card">
          <div class="stat-number" id="totalTasks">0</div>
          <div class="stat-label">总任务数</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="highPriorityTasks">0</div>
          <div class="stat-label">高优先级</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="assignedTasks">0</div>
          <div class="stat-label">已分配</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="avgDeadline">0</div>
          <div class="stat-label">平均工期(天)</div>
        </div>
      </div>
      
      <div id="taskList"></div>
    </div>
  </div>

  <!-- 导出跟进页面 -->
  <div id="export" class="tab-content">
    <div class="card">
      <h3>📤 导出与跟进</h3>
      
      <div class="export-section">
        <h4>📋 导出格式选择</h4>
        <div style="margin: 15px 0;">
          <button onclick="exportToMarkdown()">📝 Markdown</button>
          <button onclick="exportToJSON()">📄 JSON</button>
          <button onclick="exportToCSV()">📊 CSV</button>
          <button onclick="exportToEmail()">📧 邮件模板</button>
        </div>
      </div>
      
      <div class="export-section">
        <h4>🔗 第三方集成</h4>
        <div style="margin: 15px 0;">
          <button onclick="syncToTrello()" id="trelloBtn">📌 同步到 Trello</button>
          <button onclick="syncToNotion()" id="notionBtn">📚 同步到 Notion</button>
          <button onclick="syncToSlack()" id="slackBtn">💬 发送到 Slack</button>
          <button onclick="createCalendarEvents()" id="calendarBtn">📅 创建日历提醒</button>
        </div>
        
        <div style="margin-top: 20px;">
          <label>Webhook URL (可选)：</label>
          <input type="text" id="webhookUrl" placeholder="https://hooks.slack.com/..." />
        </div>
      </div>
      
      <div id="exportPreview"></div>
    </div>
  </div>

  <!-- 历史会议页面 -->
  <div id="history" class="tab-content">
    <div class="card">
      <h3>📋 历史会议记录</h3>
      
      <div style="margin-bottom: 20px;">
        <input type="text" id="searchHistory" placeholder="🔍 搜索会议主题、参与人或任务..." />
        <button onclick="searchMeetings()">搜索</button>
        <button onclick="clearHistory()" class="danger">🗑️ 清空历史</button>
      </div>
      
      <div class="timeline" id="meetingTimeline"></div>
    </div>
  </div>

  <script>
    // 全局变量
    let apiKey = localStorage.getItem('deepseek_key') || '';
    let mediaRecorder;
    let audioChunks = [];
    let recordingTimer;
    let recordingStartTime;
    let currentAudioBlob;
    let currentTranscript = '';
    let currentTasks = [];
    let meetingHistory = JSON.parse(localStorage.getItem('meeting_history') || '[]');

    // 页面初始化
    window.onload = function() {
      loadApiKey();
      setupEventListeners();
      loadMeetingHistory();
      checkBrowserSupport();
    };

    function checkBrowserSupport() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert('您的浏览器不支持录音功能，请使用现代浏览器');
      }
    }

    function loadApiKey() {
      if (apiKey) {
        document.getElementById('apiKey').value = apiKey;
        document.getElementById('keyStatus').innerHTML = '✅ 已保存';
        document.getElementById('keyStatus').style.color = 'green';
      }
    }

    function saveApiKey() {
      apiKey = document.getElementById('apiKey').value.trim();
      if (apiKey.startsWith('sk-')) {
        localStorage.setItem('deepseek_key', apiKey);
        document.getElementById('keyStatus').innerHTML = '✅ 保存成功';
        document.getElementById('keyStatus').style.color = 'green';
      } else {
        alert('请输入有效的 API Key (以 sk- 开头)');
      }
    }

    function setupEventListeners() {
      const uploadZone = document.getElementById('uploadZone');
      const audioInput = document.getElementById('audioInput');

      uploadZone.onclick = () => audioInput.click();
      audioInput.onchange = handleAudioUpload;

      uploadZone.ondragover = (e) => {
        e.preventDefault();
        uploadZone.classList.add('dragover');
      };
      uploadZone.ondragleave = () => uploadZone.classList.remove('dragover');
      uploadZone.ondrop = (e) => {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        handleAudioUpload({ target: { files: e.dataTransfer.files } });
      };
    }

    async function startRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = (event) => {
          audioChunks.push(event.data);
        };

        mediaRecorder.onstop = () => {
          currentAudioBlob = new Blob(audioChunks, { type: 'audio/wav' });
          displayAudioPreview();
          stream.getTracks().forEach(track => track.stop());
        };

        mediaRecorder.start();
        recordingStartTime = Date.now();
        
        document.getElementById('startRecord').disabled = true;
        document.getElementById('stopRecord').disabled = false;
        document.getElementById('pauseRecord').disabled = false;
        document.getElementById('recordingSection').classList.add('recording-active');
        document.getElementById('recordingStatus').innerHTML = `
          <h4>🔴 录音中...</h4>
          <p>会议正在录制，请正常进行讨论</p>
        `;

        startTimer();
        
      } catch (error) {
        alert('无法访问麦克风：' + error.message);
      }
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        clearInterval(recordingTimer);
        
        document.getElementById('startRecord').disabled = false;
        document.getElementById('stopRecord').disabled = true;
        document.getElementById('pauseRecord').disabled = true;
        document.getElementById('recordingSection').classList.remove('recording-active');
        document.getElementById('recordingStatus').innerHTML = `
          <h4>✅ 录音完成</h4>
          <p>录音已保存，可以进行文字转换</p>
        `;
      }
    }

    function pauseRecording() {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.pause();
        document.getElementById('pauseRecord').textContent = '▶️ 继续';
        document.getElementById('pauseRecord').onclick = resumeRecording;
      }
    }

    function resumeRecording() {
      if (mediaRecorder && mediaRecorder.state === 'paused') {
        mediaRecorder.resume();
        document.getElementById('pauseRecord').textContent = '⏸️ 暂停';
        document.getElementById('pauseRecord').onclick = pauseRecording;
      }
    }

    function startTimer() {
      recordingTimer = setInterval(() => {
        const elapsed = Date.now() - recordingStartTime;
        const seconds = Math.floor(elapsed / 1000) % 60;
        const minutes = Math.floor(elapsed / 60000) % 60;
        const hours = Math.floor(elapsed / 3600000);
        
        document.getElementById('recordingTime').textContent = 
          `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        // 更新进度条（假设最大60分钟）
        const progress = Math.min((elapsed / 3600000) * 100, 100);
        document.getElementById('recordingProgress').style.width = progress + '%';
      }, 1000);
    }

    function handleAudioUpload(event) {
      const file = event.target.files[0];
      if (file && file.type.startsWith('audio/')) {
        currentAudioBlob = file;
        displayAudioPreview();
      } else {
        alert('请选择有效的音频文件');
      }
    }

    function displayAudioPreview() {
      const preview = document.getElementById('audioPreview');
      const audioUrl = URL.createObjectURL(currentAudioBlob);
      
      preview.innerHTML = `
        <div class="card" style="background: #f0f8f0; margin-top: 20px;">
          <h4>🎵 音频预览</h4>
          <audio controls style="width: 100%; margin: 10px 0;">
            <source src="${audioUrl}" type="${currentAudioBlob.type}">
          </audio>
          <p>文件大小: ${(currentAudioBlob.size / 1024 / 1024).toFixed(2)} MB</p>
          <button onclick="transcribeAudio()" class="success">🔄 转换为文字</button>
        </div>
      `;
    }

    async function transcribeAudio() {
      if (!currentAudioBlob) {
        alert('请先录音或上传音频文件');
        return;
      }
      if (!apiKey) {
        alert('请先配置 DeepSeek API Key');
        return;
      }

      const transcribeBtn = document.getElementById('transcribeBtn');
      transcribeBtn.disabled = true;
      transcribeBtn.textContent = '🔄 转换中...';

      try {
        // 模拟音频转文字（实际应调用 DeepSeek 或其他 STT API）
        currentTranscript = await simulateTranscription();
        
        document.getElementById('transcriptContent').innerHTML = currentTranscript;
        document.getElementById('summarizeBtn').disabled = false;
        document.getElementById('editBtn').disabled = false;
        
        showMessage('success', '✅ 音频转文字完成！');
        
      } catch (error) {
        showMessage('error', '❌ 转换失败: ' + error.message);
      } finally {
        transcribeBtn.disabled = false;
        transcribeBtn.textContent = '🔄 转换为文字';
      }
    }

    async function simulateTranscription() {
      // 模拟转录过程（实际应调用真实的 STT API）
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      return `
会议开始时间：${new Date().toLocaleString()}
参会人员：${document.getElementById('attendees').value || '张三, 李四, 王五'}

张三：大家好，今天我们来讨论一下产品的下一步规划。首先，我们需要完成用户反馈的整理分析。

李四：好的，用户反馈这块我来负责，预计下周三之前完成。主要是收集最近一个月的用户意见。

王五：那我负责竞品分析部分，也是下周三截止。需要重点关注友商的新功能。

张三：很好。另外，我们还需要更新产品文档，这个任务比较紧急，希望能在本周五前完成。

李四：产品文档我可以协助，但是主要还是需要产品经理来主导。

张三：行，那就这样安排。还有一个重要的事情，下个月的产品发布会准备工作要开始了。

王五：发布会这块我来统筹，需要协调市场部和技术部。预计需要两周时间准备。

张三：好的，那今天的会议就到这里。大家记得按时完成各自的任务。

会议结束时间：${new Date(Date.now() + 1800000).toLocaleString()}
      `;
    }

    async function summarizeMeeting() {
      if (!currentTranscript) {
        alert('请先转换音频为文字');
        return;
      }

      const summarizeBtn = document.getElementById('summarizeBtn');
      summarizeBtn.disabled = true;
      summarizeBtn.textContent = '📝 生成中...';

      try {
        const summary = await generateSummary(currentTranscript);
        
        document.getElementById('summaryContent').innerHTML = summary;
        document.getElementById('meetingSummary').style.display = 'block';
        
      } catch (error) {
        showMessage('error', '❌ 摘要生成失败: ' + error.message);
      } finally {
        summarizeBtn.disabled = false;
        summarizeBtn.textContent = '📝 生成摘要';
      }
    }

    async function generateSummary(transcript) {
      const prompt = `请对以下会议记录生成结构化摘要：

会议记录：
${transcript}

请按以下格式输出：
## 📋 会议摘要
**会议主题：** [主题]
**参会人员：** [人员列表]
**会议时长：** [时长]

## 🎯 核心议题
1. [议题1]
2. [议题2]
...

## ✅ 决策事项
1. [决策1]
2. [决策2]
...

## 📝 后续行动
1. [行动项1]
2. [行动项2]
...`;

      const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: 'deepseek-chat',
          messages: [{ role: 'user', content: prompt }],
          temperature: 0.3,
          max_tokens: 1500
        })
      });

      if (!response.ok) {
        throw new Error(`API 调用失败: ${response.status}`);
      }

      const data = await response.json();
      return data.choices[0].message.content.replace(/\n/g, '<br>');
    }

    function editTranscript() {
      const content = document.getElementById('transcriptContent');
      const currentText = content.textContent;
      
      content.innerHTML = `
        <textarea style="width: 100%; height: 250px; font-family: inherit; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">${currentText}</textarea>
        <div style="margin-top: 10px;">
          <button onclick="saveTranscript()" class="success">💾 保存修改</button>
          <button onclick="cancelEdit()" style="background: #6c757d;">❌ 取消</button>
        </div>
      `;
    }

    function saveTranscript() {
      const textarea = document.querySelector('#transcriptContent textarea');
      currentTranscript = textarea.value;
      document.getElementById('transcriptContent').innerHTML = currentTranscript;
      showMessage('success', '✅ 会议纪要已保存');
    }

    function cancelEdit() {
      document.getElementById('transcriptContent').innerHTML = currentTranscript;
    }

    async function extractTasks() {
      if (!currentTranscript) {
        alert('请先转换音频为文字');
        return;
      }

      const extractBtn = document.getElementById('extractBtn');
      extractBtn.disabled = true;
      extractBtn.textContent = '🔍 提取中...';

      try {
        // 调用AI提取任务
        currentTasks = await extractTasksFromTranscript(currentTranscript);
        
        // 显示任务统计
        updateTaskStats();
        document.getElementById('taskStats').style.display = 'block';
        
        // 渲染任务列表
        renderTaskList();
        
        // 启用分配按钮
        document.getElementById('assignBtn').disabled = false;
        
        showMessage('success', '✅ 已成功提取 ' + currentTasks.length + ' 个任务');
        
      } catch (error) {
        showMessage('error', '❌ 提取任务失败: ' + error.message);
      } finally {
        extractBtn.disabled = false;
        extractBtn.textContent = '🔍 提取任务';
      }
    }

    async function extractTasksFromTranscript(transcript) {
      const prompt = `请从以下会议记录中提取所有任务项，包括负责人、截止日期和优先级：

会议记录：
${transcript}

请以JSON格式输出，格式如下：
[
  {
    "id": "task-1",
    "title": "任务标题",
    "description": "任务详细描述",
    "assignee": "负责人姓名",
    "deadline": "YYYY-MM-DD",
    "priority": "high/medium/low",
    "status": "pending"
  },
  ...
]

如果无法确定某项信息，请使用null值。`;

      const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: 'deepseek-chat',
          messages: [{ role: 'user', content: prompt }],
          temperature: 0.2,
          max_tokens: 2000
        })
      });

      if (!response.ok) {
        throw new Error(`API 调用失败: ${response.status}`);
      }

      const data = await response.json();
      const content = data.choices[0].message.content;
      
      // 提取JSON部分
      const jsonMatch = content.match(/\[[\s\S]*\]/);
      if (jsonMatch) {
        return JSON.parse(jsonMatch[0]);
      } else {
        throw new Error('无法解析任务JSON');
      }
    }

    function updateTaskStats() {
      if (!currentTasks.length) return;
      
      const totalTasks = currentTasks.length;
      const highPriority = currentTasks.filter(t => t.priority === 'high').length;
      const assigned = currentTasks.filter(t => t.assignee && t.assignee !== null).length;
      
      // 计算平均截止日期（天数）
      let totalDays = 0;
      let validDeadlines = 0;
      
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      currentTasks.forEach(task => {
        if (task.deadline) {
          const deadline = new Date(task.deadline);
          if (!isNaN(deadline.getTime())) {
            const diffTime = Math.abs(deadline - today);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            totalDays += diffDays;
            validDeadlines++;
          }
        }
      });
      
      const avgDays = validDeadlines ? Math.round(totalDays / validDeadlines) : 0;
      
      document.getElementById('totalTasks').textContent = totalTasks;
      document.getElementById('highPriorityTasks').textContent = highPriority;
      document.getElementById('assignedTasks').textContent = assigned;
      document.getElementById('avgDeadline').textContent = avgDays;
    }

    function renderTaskList() {
      const taskListElement = document.getElementById('taskList');
      taskListElement.innerHTML = '';
      
      if (!currentTasks.length) {
        taskListElement.innerHTML = '<p style="text-align: center; color: #666;">暂无任务</p>';
        return;
      }
      
      currentTasks.forEach((task, index) => {
        const priorityClass = task.priority === 'high' ? 'priority-high' : 
                             task.priority === 'medium' ? 'priority-medium' : 'priority-low';
        
        const deadlineDate = task.deadline ? new Date(task.deadline) : null;
        const formattedDeadline = deadlineDate && !isNaN(deadlineDate.getTime()) 
          ? deadlineDate.toLocaleDateString('zh-CN') 
          : '未设置';
        
        const taskElement = document.createElement('div');
        taskElement.className = 'task-item';
        taskElement.innerHTML = `
          <div class="task-header">
            <h4 class="task-title">${task.title || '未命名任务'}</h4>
            <span class="task-priority ${priorityClass}">
              ${task.priority === 'high' ? '高优先级' : 
                task.priority === 'medium' ? '中优先级' : '低优先级'}
            </span>
          </div>
          <p>${task.description || '无描述'}</p>
          <div class="task-assignee">
            👤 负责人: ${task.assignee || '未分配'}
            <button onclick="editTaskAssignee(${index})" style="float: right; padding: 2px 8px;">
              修改
            </button>
          </div>
          <div class="task-deadline">
            📅 截止日期: ${formattedDeadline}
            <button onclick="editTaskDeadline(${index})" style="float: right; padding: 2px 8px;">
              修改
            </button>
          </div>
        `;
        
        taskListElement.appendChild(taskElement);
      });
    }

    function editTaskAssignee(taskIndex) {
      const task = currentTasks[taskIndex];
      const attendees = document.getElementById('attendees').value.split(',').map(a => a.trim());
      
      let html = '<div style="margin: 15px 0;">';
      html += '<h4>选择负责人</h4>';
      html += '<div class="member-list">';
      
      attendees.forEach(person => {
        const isSelected = task.assignee === person;
        html += `
          <span class="member-tag ${isSelected ? 'selected' : ''}" 
                onclick="assignTaskTo(${taskIndex}, '${person}')">
            ${person}
          </span>
        `;
      });
      
      html += '</div>';
      html += '<input type="text" id="customAssignee" placeholder="或输入其他负责人">';
      html += '<button onclick="assignTaskToCustom(' + taskIndex + ')" style="margin-top: 10px;">确定</button>';
      html += '</div>';
      
      const taskElement = document.querySelectorAll('.task-item')[taskIndex];
      const assigneeElement = taskElement.querySelector('.task-assignee');
      assigneeElement.innerHTML = html;
    }

    function assignTaskTo(taskIndex, person) {
      currentTasks[taskIndex].assignee = person;
      renderTaskList();
      updateTaskStats();
    }

    function assignTaskToCustom(taskIndex) {
      const customAssignee = document.getElementById('customAssignee').value.trim();
      if (customAssignee) {
        currentTasks[taskIndex].assignee = customAssignee;
        renderTaskList();
        updateTaskStats();
      }
    }

    function editTaskDeadline(taskIndex) {
      const task = currentTasks[taskIndex];
      const today = new Date().toISOString().split('T')[0];
      
      const taskElement = document.querySelectorAll('.task-item')[taskIndex];
      const deadlineElement = taskElement.querySelector('.task-deadline');
      
      deadlineElement.innerHTML = `
        <div style="margin: 10px 0;">
          <label>选择截止日期:</label>
          <input type="date" id="taskDeadline" min="${today}" 
                 value="${task.deadline || today}">
          <button onclick="updateTaskDeadline(${taskIndex})" style="margin-top: 10px;">
            保存
          </button>
          <button onclick="renderTaskList()" style="margin-top: 10px; background: #6c757d;">
            取消
          </button>
        </div>
      `;
    }

    function updateTaskDeadline(taskIndex) {
      const newDeadline = document.getElementById('taskDeadline').value;
      if (newDeadline) {
        currentTasks[taskIndex].deadline = newDeadline;
        renderTaskList();
        updateTaskStats();
      }
    }

    async function assignTasks() {
      if (!currentTasks.length) {
        alert('没有可分配的任务');
        return;
      }

      const assignBtn = document.getElementById('assignBtn');
      assignBtn.disabled = true;
      assignBtn.textContent = '👥 分配中...';

      try {
        const attendees = document.getElementById('attendees').value.split(',').map(a => a.trim());
        
        if (!attendees.length) {
          throw new Error('请先输入参会人员');
        }
        
        // 智能分配任务
        await autoAssignTasks(attendees);
        
        // 更新任务列表
        renderTaskList();
        updateTaskStats();
        
        showMessage('success', '✅ 任务已智能分配');
        
      } catch (error) {
        showMessage('error', '❌ 分配失败: ' + error.message);
      } finally {
        assignBtn.disabled = false;
        assignBtn.textContent = '👥 智能分配';
      }
    }

    async function autoAssignTasks(attendees) {
      // 对于未分配的任务，进行智能分配
      const unassignedTasks = currentTasks.filter(t => !t.assignee || t.assignee === null);
      
      if (!unassignedTasks.length) return;
      
      // 简单的轮询分配算法
      unassignedTasks.forEach((task, index) => {
        const assigneeIndex = index % attendees.length;
        task.assignee = attendees[assigneeIndex];
      });
    }

    function addCustomTask() {
      const taskForm = document.createElement('div');
      taskForm.className = 'task-item';
      taskForm.style.background = '#f8f9ff';
      taskForm.innerHTML = `
        <h4>➕ 添加新任务</h4>
        <div>
          <label>任务标题:</label>
          <input type="text" id="newTaskTitle" placeholder="输入任务标题">
        </div>
        <div>
          <label>任务描述:</label>
          <textarea id="newTaskDesc" placeholder="输入任务详细描述" rows="3"></textarea>
        </div>
        <div>
          <label>负责人:</label>
          <input type="text" id="newTaskAssignee" placeholder="输入负责人姓名">
        </div>
        <div>
          <label>截止日期:</label>
          <input type="date" id="newTaskDeadline" min="${new Date().toISOString().split('T')[0]}">
        </div>
        <div>
          <label>优先级:</label>
          <select id="newTaskPriority">
            <option value="high">高</option>
            <option value="medium" selected>中</option>
            <option value="low">低</option>
          </select>
        </div>
        <div style="margin-top: 15px;">
          <button onclick="saveNewTask()" class="success">💾 保存任务</button>
          <button onclick="cancelNewTask()" style="background: #6c757d;">❌ 取消</button>
        </div>
      `;
      
      document.getElementById('taskList').prepend(taskForm);
    }

    function saveNewTask() {
      const title = document.getElementById('newTaskTitle').value.trim();
      if (!title) {
        alert('请输入任务标题');
        return;
      }
      
      const newTask = {
        id: 'task-' + Date.now(),
        title: title,
        description: document.getElementById('newTaskDesc').value.trim(),
        assignee: document.getElementById('newTaskAssignee').value.trim() || null,
        deadline: document.getElementById('newTaskDeadline').value || null,
        priority: document.getElementById('newTaskPriority').value,
        status: 'pending'
      };
      
      currentTasks.unshift(newTask);
      renderTaskList();
      updateTaskStats();
      
      showMessage('success', '✅ 新任务已添加');
    }

    function cancelNewTask() {
      renderTaskList();
    }

    function exportToMarkdown() {
      if (!currentTasks.length) {
        alert('没有可导出的任务');
        return;
      }

      let markdown = `# ${document.getElementById('meetingTitle').value || '会议任务'}\n\n`;
      markdown += `日期: ${new Date().toLocaleDateString()}\n`;
      markdown += `参会人员: ${document.getElementById('attendees').value || '未指定'}\n\n`;
      
      markdown += `## 任务列表\n\n`;
      
      currentTasks.forEach(task => {
        const priority = task.priority === 'high' ? '🔴 高' : 
                        task.priority === 'medium' ? '🟡 中' : '🟢 低';
        
        markdown += `### ${task.title}\n`;
        markdown += `- **描述**: ${task.description || '无'}\n`;
        markdown += `- **负责人**: ${task.assignee || '未分配'}\n`;
        markdown += `- **截止日期**: ${task.deadline || '未设置'}\n`;
        markdown += `- **优先级**: ${priority}\n\n`;
      });
      
      downloadFile('会议任务.md', markdown);
      showMessage('success', '✅ Markdown 文件已导出');
    }

    function exportToJSON() {
      if (!currentTasks.length) {
        alert('没有可导出的任务');
        return;
      }
      
      const meetingData = {
        title: document.getElementById('meetingTitle').value || '会议任务',
        date: new Date().toISOString(),
        attendees: document.getElementById('attendees').value.split(',').map(a => a.trim()),
        transcript: currentTranscript,
        tasks: currentTasks
      };
      
      const json = JSON.stringify(meetingData, null, 2);
      downloadFile('会议任务.json', json);
      showMessage('success', '✅ JSON 文件已导出');
    }

    function exportToCSV() {
      if (!currentTasks.length) {
        alert('没有可导出的任务');
        return;
      }
      
      let csv = '任务标题,描述,负责人,截止日期,优先级\n';
      
      currentTasks.forEach(task => {
        const priority = task.priority === 'high' ? '高' : 
                        task.priority === 'medium' ? '中' : '低';
        
        // 确保CSV格式正确（处理逗号和引号）
        const title = `"${(task.title || '').replace(/"/g, '""')}"`;
        const desc = `"${(task.description || '').replace(/"/g, '""')}"`;
        const assignee = `"${(task.assignee || '').replace(/"/g, '""')}"`;
        
        csv += `${title},${desc},${assignee},${task.deadline || ''},${priority}\n`;
      });
      
      downloadFile('会议任务.csv', csv);
      showMessage('success', '✅ CSV 文件已导出');
    }

    function exportToEmail() {
      if (!currentTasks.length) {
        alert('没有可导出的任务');
        return;
      }
      
      const meetingTitle = document.getElementById('meetingTitle').value || '会议任务';
      let emailBody = `主题：${meetingTitle} - 任务跟进\n\n`;
      emailBody += `各位好，\n\n`;
      emailBody += `以下是今天会议中确定的任务列表，请各位按时完成：\n\n`;
      
      currentTasks.forEach(task => {
        const priority = task.priority === 'high' ? '【高优先级】' : 
                        task.priority === 'medium' ? '【中优先级】' : '【低优先级】';
        
        emailBody += `${priority} ${task.title}\n`;
        emailBody += `  描述：${task.description || '无'}\n`;
        emailBody += `  负责人：${task.assignee || '未分配'}\n`;
        emailBody += `  截止日期：${task.deadline || '未设置'}\n\n`;
      });
      
      emailBody += `请大家及时跟进，如有问题请及时沟通。\n\n`;
      emailBody += `谢谢！`;
      
      const emailPreview = document.getElementById('exportPreview');
      emailPreview.innerHTML = `
        <div class="card" style="margin-top: 20px;">
          <h4>📧 邮件预览</h4>
          <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; white-space: pre-wrap;">${emailBody}</div>
          <div style="margin-top: 15px;">
            <button onclick="copyToClipboard('${encodeURIComponent(emailBody)}')">📋 复制到剪贴板</button>
            <a href="mailto:?subject=${encodeURIComponent(meetingTitle + ' - 任务跟进')}&body=${encodeURIComponent(emailBody)}" class="button" style="background: #28a745; color: white; text-decoration: none; padding: 12px 20px; border-radius: 8px; display: inline-block; margin: 5px;">
              📧 打开邮件客户端
            </a>
          </div>
        </div>
      `;
      
      switchTab('export');
    }

    function copyToClipboard(text) {
      const decoded = decodeURIComponent(text);
      navigator.clipboard.writeText(decoded)
        .then(() => showMessage('success', '✅ 已复制到剪贴板'))
        .catch(err => showMessage('error', '❌ 复制失败: ' + err));
    }

    function downloadFile(filename, content) {
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(content));
      element.setAttribute('download', filename);
      element.style.display = 'none';
      document.body.appendChild(element);
      element.click();
      document.body.removeChild(element);
    }

    // 集成功能
    function syncToTrello() {
      alert('Trello 集成功能即将上线，敬请期待！');
    }

    function syncToNotion() {
      alert('Notion 集成功能即将上线，敬请期待！');
    }

    function syncToSlack() {
      const webhookUrl = document.getElementById('webhookUrl').value.trim();
      if (!webhookUrl) {
        alert('请先输入 Slack Webhook URL');
        return;
      }
      
      if (!currentTasks.length) {
        alert('没有可发送的任务');
        return;
      }
      
      // 构建 Slack 消息
      const meetingTitle = document.getElementById('meetingTitle').value || '会议任务';
      const message = {
        text: `*${meetingTitle} - 任务跟进*`,
        blocks: [
          {
            type: "header",
            text: {
              type: "plain_text",
              text: `${meetingTitle} - 任务跟进`
            }
          },
          {
            type: "section",
            text: {
              type: "mrkdwn",
              text: "以下是会议中确定的任务列表，请各位按时完成："
            }
          },
          {
            type: "divider"
          }
        ]
      };
      
      currentTasks.forEach(task => {
        const priority = task.priority === 'high' ? ':red_circle: 高优先级' : 
                        task.priority === 'medium' ? ':yellow_circle: 中优先级' : ':green_circle: 低优先级';
        
        message.blocks.push({
          type: "section",
          text: {
            type: "mrkdwn",
            text: `*${task.title}*\n${priority}\n描述：${task.description || '无'}\n负责人：${task.assignee || '未分配'}\n截止日期：${task.deadline || '未设置'}`
          }
        });
      });
      
      // 模拟发送到 Slack
      showMessage('success', '✅ 已发送到 Slack');
    }

    function createCalendarEvents() {
      if (!currentTasks.length) {
        alert('没有可添加到日历的任务');
        return;
      }
      
      // 生成 iCal 文件
      let icalContent = 'BEGIN:VCALENDAR\r\nVERSION:2.0\r\nPRODID:-//Meeting Tasks//EN\r\n';
      
      currentTasks.forEach(task => {
        if (!task.deadline) return;
        
        const uid = `task-${Date.now()}-${Math.floor(Math.random() * 1000000)}`;
        const deadline = new Date(task.deadline + 'T23:59:59');
        const created = new Date();
        
        icalContent += 'BEGIN:VEVENT\r\n';
        icalContent += `UID:${uid}\r\n`;
        icalContent += `DTSTAMP:${formatDateForICal(created)}\r\n`;
        icalContent += `DTSTART:${formatDateForICal(deadline)}\r\n`;
        icalContent += `DTEND:${formatDateForICal(deadline)}\r\n`;
        icalContent += `SUMMARY:${task.title} (截止日期)\r\n`;
        icalContent += `DESCRIPTION:${task.description || ''} \\n负责人: ${task.assignee || '未分配'}\r\n`;
        icalContent += 'END:VEVENT\r\n';
      });
      
      icalContent += 'END:VCALENDAR';
      
      downloadFile('会议任务日历.ics', icalContent);
      showMessage('success', '✅ 日历文件已生成');
    }

    function formatDateForICal(date) {
      return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
    }

    // 历史会议相关
    function saveMeetingToHistory() {
      if (!currentTasks.length || !document.getElementById('meetingTitle').value) {
        return;
      }
      
      const meeting = {
        id: 'meeting-' + Date.now(),
        title: document.getElementById('meetingTitle').value,
        date: new Date().toISOString(),
        attendees: document.getElementById('attendees').value.split(',').map(a => a.trim()),
        taskCount: currentTasks.length,
        tasks: currentTasks
      };
      
      meetingHistory.unshift(meeting);
      localStorage.setItem('meeting_history', JSON.stringify(meetingHistory));
      
      showMessage('success', '✅ 会议已保存到历史记录');
    }

    function loadMeetingHistory() {
      const timeline = document.getElementById('meetingTimeline');
      timeline.innerHTML = '';
      
      if (!meetingHistory.length) {
        timeline.innerHTML = '<p style="text-align: center; color: #666;">暂无历史会议记录</p>';
        return;
      }
      
      meetingHistory.forEach(meeting => {
        const date = new Date(meeting.date);
        const timelineItem = document.createElement('div');
        timelineItem.className = 'timeline-item';
        timelineItem.innerHTML = `
          <div class="timeline-time">${date.toLocaleString()}</div>
          <div class="timeline-content">
            <h4>${meeting.title}</h4>
            <p>参会人员: ${meeting.attendees.join(', ')}</p>
            <p>任务数量: ${meeting.taskCount}</p>
            <button onclick="viewHistoryMeeting('${meeting.id}')">查看详情</button>
          </div>
        `;
        
        timeline.appendChild(timelineItem);
      });
    }

    function viewHistoryMeeting(meetingId) {
      const meeting = meetingHistory.find(m => m.id === meetingId);
      if (!meeting) return;
      
      // 加载历史会议数据
      document.getElementById('meetingTitle').value = meeting.title;
      document.getElementById('attendees').value = meeting.attendees.join(', ');
      
      currentTasks = meeting.tasks;
      renderTaskList();
      updateTaskStats();
      
      switchTab('tasks');
      showMessage('info', 'ℹ️ 已加载历史会议');
    }

    function searchMeetings() {
      const query = document.getElementById('searchHistory').value.toLowerCase();
      if (!query) {
        loadMeetingHistory();
        return;
      }
      
      const filteredHistory = meetingHistory.filter(meeting => {
        return meeting.title.toLowerCase().includes(query) ||
               meeting.attendees.some(a => a.toLowerCase().includes(query)) ||
               meeting.tasks.some(t => 
                 t.title.toLowerCase().includes(query) || 
                 (t.description && t.description.toLowerCase().includes(query)) ||
                 (t.assignee && t.assignee.toLowerCase().includes(query))
               );
      });
      
      const timeline = document.getElementById('meetingTimeline');
      timeline.innerHTML = '';
      
      if (!filteredHistory.length) {
        timeline.innerHTML = '<p style="text-align: center; color: #666;">未找到匹配的会议记录</p>';
        return;
      }
      
      filteredHistory.forEach(meeting => {
        const date = new Date(meeting.date);
        const timelineItem = document.createElement('div');
        timelineItem.className = 'timeline-item';
        timelineItem.innerHTML = `
          <div class="timeline-time">${date.toLocaleString()}</div>
          <div class="timeline-content">
            <h4>${meeting.title}</h4>
            <p>参会人员: ${meeting.attendees.join(', ')}</p>
            <p>任务数量: ${meeting.taskCount}</p>
            <button onclick="viewHistoryMeeting('${meeting.id}')">查看详情</button>
          </div>
        `;
        
        timeline.appendChild(timelineItem);
      });
    }

    function clearHistory() {
      if (confirm('确定要清空所有历史会议记录吗？此操作无法撤销。')) {
        meetingHistory = [];
        localStorage.removeItem('meeting_history');
        loadMeetingHistory();
        showMessage('info', 'ℹ️ 历史记录已清空');
      }
    }

    // 辅助函数
    function switchTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      document.getElementById(tabId).classList.add('active');
      document.querySelector(`.tab[onclick="switchTab('${tabId}')"]`).classList.add('active');
    }

    function showMessage(type, message) {
      const messageDiv = document.createElement('div');
      messageDiv.style.position = 'fixed';
      messageDiv.style.top = '20px';
      messageDiv.style.right = '20px';
      messageDiv.style.padding = '15px 20px';
      messageDiv.style.borderRadius = '8px';
      messageDiv.style.zIndex = '1000';
      messageDiv.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
      messageDiv.style.transition = 'all 0.3s ease';
      
      if (type === 'success') {
        messageDiv.style.background = '#d4edda';
        messageDiv.style.color = '#155724';
      } else if (type === 'error') {
        messageDiv.style.background = '#f8d7da';
        messageDiv.style.color = '#721c24';
      } else {
        messageDiv.style.background = '#d1ecf1';
        messageDiv.style.color = '#0c5460';
      }
      
      messageDiv.textContent = message;
      document.body.appendChild(messageDiv);
      
      setTimeout(() => {
        messageDiv.style.opacity = '0';
        setTimeout(() => {
          document.body.removeChild(messageDiv);
        }, 300);
      }, 3000);
    }
  </script>
</body>
</html>