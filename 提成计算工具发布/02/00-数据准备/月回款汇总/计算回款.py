import pandas as pd
import os

# 设置显示选项
pd.set_option('display.max_columns', None)
pd.set_option('display.width', None)
pd.set_option('display.max_colwidth', None)

# 读取收款单和退款单
print("正在读取数据...")
收款单 = pd.read_excel('中冠8月收款单_2025100716461852_1306802.xlsx')
退款单 = pd.read_excel('中冠8月收款退款单_2025100716453612_1306802.xlsx')

print(f"收款单数据行数: {len(收款单)}")
print(f"退款单数据行数: {len(退款单)}")

# 提取往来单位与客户所属区域的对应关系（从收款单）
往来单位区域映射 = 收款单[['往来单位', '客户所属区域']].drop_duplicates()

# 提取收款数据的关键字段
收款汇总 = 收款单.groupby(['销售员', '销售组织', '销售部门', '往来单位', '客户所属区域']).agg({
    '收款金额': 'sum'
}).reset_index()
收款汇总.rename(columns={'收款金额': '总收款'}, inplace=True)

print("\n收款汇总数据示例:")
print(收款汇总.head())

# 提取退款数据的关键字段（退款单没有客户所属区域字段，需要通过往来单位映射）
退款汇总 = 退款单.groupby(['销售员', '销售组织', '销售部门', '往来单位']).agg({
    '退款金额': 'sum'
}).reset_index()
退款汇总.rename(columns={'退款金额': '总退款'}, inplace=True)

# 将客户所属区域信息添加到退款汇总中
退款汇总 = pd.merge(退款汇总, 往来单位区域映射, on='往来单位', how='left')

print("\n退款汇总数据示例:")
print(退款汇总.head())

# 合并收款和退款数据
回款汇总 = pd.merge(
    收款汇总,
    退款汇总,
    on=['销售员', '销售组织', '销售部门', '往来单位', '客户所属区域'],
    how='outer'
)

# 填充缺失值为0
回款汇总['总收款'] = 回款汇总['总收款'].fillna(0)
回款汇总['总退款'] = 回款汇总['总退款'].fillna(0)

# 计算回款 = 收款 - 退款
回款汇总['回款'] = 回款汇总['总收款'] - 回款汇总['总退款']

# 调整列顺序
回款汇总 = 回款汇总[['销售员', '销售组织', '销售部门', '往来单位', '客户所属区域', '总收款', '总退款', '回款']]

# =============================================================================
# 1. 按销售员汇总
# =============================================================================
销售员汇总 = 回款汇总.groupby(['销售员', '销售组织', '销售部门']).agg({
    '总收款': 'sum',
    '总退款': 'sum',
    '回款': 'sum'
}).reset_index()

销售员汇总 = 销售员汇总.sort_values('回款', ascending=False)

print("\n" + "="*100)
print("销售员回款汇总表")
print("="*100)
print(销售员汇总)

# 保存销售员汇总表
销售员汇总文件 = '销售员回款汇总表.xlsx'
销售员汇总.to_excel(销售员汇总文件, index=False, engine='openpyxl')
print(f"\n✓ 销售员汇总结果已保存到: {销售员汇总文件}")

# =============================================================================
# 2. 按往来单位汇总
# =============================================================================
往来单位汇总 = 回款汇总.groupby(['往来单位', '客户所属区域', '销售员']).agg({
    '总收款': 'sum',
    '总退款': 'sum',
    '回款': 'sum'
}).reset_index()

# 调整列顺序，将销售员放在往来单位后面
往来单位汇总 = 往来单位汇总[['往来单位', '客户所属区域', '销售员', '总收款', '总退款', '回款']]

往来单位汇总 = 往来单位汇总.sort_values('回款', ascending=False)

print("\n" + "="*100)
print("往来单位回款汇总表")
print("="*100)
print(往来单位汇总)

# 保存往来单位汇总表
往来单位汇总文件 = '往来单位回款汇总表.xlsx'
往来单位汇总.to_excel(往来单位汇总文件, index=False, engine='openpyxl')
print(f"\n✓ 往来单位汇总结果已保存到: {往来单位汇总文件}")

# 打印统计信息
print("\n" + "="*100)
print("统计信息")
print("="*100)
print(f"总收款金额: {回款汇总['总收款'].sum():,.2f}")
print(f"总退款金额: {回款汇总['总退款'].sum():,.2f}")
print(f"净回款金额: {回款汇总['回款'].sum():,.2f}")
print(f"销售员人数: {回款汇总['销售员'].nunique()}")
print(f"往来单位数: {回款汇总['往来单位'].nunique()}")

