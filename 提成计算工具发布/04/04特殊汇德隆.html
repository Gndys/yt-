<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>汇德隆提成计算工具</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .upload-section {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .upload-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .upload-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 2px dashed #dee2e6;
            text-align: center;
            transition: border-color 0.3s;
        }

        .upload-item:hover {
            border-color: #667eea;
        }

        .upload-item input[type="file"] {
            display: none;
        }

        .upload-label {
            display: block;
            cursor: pointer;
            padding: 10px;
            color: #495057;
        }

        .upload-label:hover {
            color: #667eea;
        }

        .file-info {
            margin-top: 10px;
            font-size: 12px;
            color: #6c757d;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .toggle-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .toggle {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .results-section {
            padding: 20px;
        }

        .table-container {
            overflow-x: auto;
            max-height: 600px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
            white-space: nowrap;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .model-column {
            background: #e3f2fd;
        }

        .commission-column {
            background: #f3e5f5;
        }

        .explanation-column {
            background: #fff3e0;
            max-width: 200px;
            white-space: normal;
            word-wrap: break-word;
        }

        .kitchen-appliance {
            background: #ffebee;
        }

        .status-info {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-size: 14px;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .hidden {
            display: none;
        }

        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .summary-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .summary-label {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>汇德隆提成计算工具</h1>
            <p>自动匹配型号、计算提成、匹配导购人员，支持佳尼特特殊规则和厨电邮件审批</p>
        </div>

        <div class="upload-section">
            <div class="upload-group">
                <div class="upload-item">
                    <label for="detailFile" class="upload-label">
                        <strong>📊 汇德隆销售业绩明细表</strong><br>
                        点击选择Excel文件
                    </label>
                    <input type="file" id="detailFile" accept=".xlsx,.xls,.csv">
                    <div class="file-info" id="detailFileInfo">未选择文件</div>
                </div>

                <div class="upload-item">
                    <label for="policyFile" class="upload-label">
                        <strong>📋 渠道政策表</strong><br>
                        点击选择Excel文件
                    </label>
                    <input type="file" id="policyFile" accept=".xlsx,.xls,.csv">
                    <div class="file-info" id="policyFileInfo">未选择文件</div>
                </div>

                <div class="upload-item">
                    <label for="janitFile" class="upload-label">
                        <strong>🏪 各店佳尼特标准表</strong><br>
                        点击选择Excel文件
                    </label>
                    <input type="file" id="janitFile" accept=".xlsx,.xls,.csv">
                    <div class="file-info" id="janitFileInfo">未选择文件</div>
                </div>

                <div class="upload-item">
                    <label for="staffFile" class="upload-label">
                        <strong>👥 门店导购人员表</strong><br>
                        点击选择Excel文件
                    </label>
                    <input type="file" id="staffFile" accept=".xlsx,.xls,.csv">
                    <div class="file-info" id="staffFileInfo">未选择文件</div>
                </div>
            </div>

            <div class="controls">
                <button class="btn btn-primary" onclick="processData()">🔄 开始处理</button>
                <button class="btn btn-success" onclick="exportResults()" id="exportBtn" disabled>📥 导出结果</button>
                
                <div class="toggle-group">
                    <div class="toggle">
                        <input type="checkbox" id="showExplanation" checked onchange="toggleColumns()">
                        <label for="showExplanation">显示说明列</label>
                    </div>
                    <div class="toggle">
                        <input type="checkbox" id="showOriginal" onchange="toggleColumns()">
                        <label for="showOriginal">显示原始提成</label>
                    </div>
                </div>
            </div>
        </div>

        <div class="results-section">
            <div id="statusInfo"></div>
            <div id="summary" class="summary hidden"></div>
            <div class="table-container">
                <table id="resultsTable">
                    <thead id="tableHeader"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let detailData = [];
        let policyData = [];
        let janitData = [];
        let staffData = [];
        let processedData = [];

        // 文件上传处理
        document.getElementById('detailFile').addEventListener('change', (e) => handleFileUpload(e, 'detail'));
        document.getElementById('policyFile').addEventListener('change', (e) => handleFileUpload(e, 'policy'));
        document.getElementById('janitFile').addEventListener('change', (e) => handleFileUpload(e, 'janit'));
        document.getElementById('staffFile').addEventListener('change', (e) => handleFileUpload(e, 'staff'));

        function handleFileUpload(event, type) {
            const file = event.target.files[0];
            const infoElement = document.getElementById(type + 'FileInfo');
            
            if (file) {
                infoElement.textContent = `已选择: ${file.name} (${(file.size/1024).toFixed(1)}KB)`;
                readExcelFile(file, type);
            } else {
                infoElement.textContent = '未选择文件';
            }
        }

        function readExcelFile(file, type) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                    
                    // 转换为对象数组
                    const headers = jsonData[0];
                    const rows = jsonData.slice(1).filter(row => row.some(cell => cell !== undefined && cell !== ''));
                    const objectData = rows.map(row => {
                        const obj = {};
                        headers.forEach((header, index) => {
                            obj[header] = row[index] || '';
                        });
                        return obj;
                    });

                    switch(type) {
                        case 'detail':
                            detailData = objectData;
                            break;
                        case 'policy':
                            policyData = objectData;
                            break;
                        case 'janit':
                            janitData = objectData;
                            break;
                        case 'staff':
                            staffData = objectData;
                            break;
                    }

                    const typeName = type === 'detail' ? '销售明细' : 
                                    type === 'policy' ? '渠道政策' : 
                                    type === 'janit' ? '佳尼特标准' : 
                                    type === 'staff' ? '门店导购人员' : '未知';
                    showStatus(`${typeName}表加载成功，共${objectData.length}条记录`, 'success');
                } catch (error) {
                    showStatus(`文件读取失败: ${error.message}`, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // 提取型号的函数
        function extractModel(productName) {
            if (!productName) return '';

            // 统一清洗：去掉品牌/品类等中文词汇，保留字母/数字/连接符
            let cleaned = String(productName)
                // 品牌
                .replace(/A\.?\s*O\.?\s*史密斯|A\.O史密斯|史密斯/gi, ' ')
                // 常见品类词
                .replace(/净水机|电热水器|电热|燃热|油烟机|燃气灶|灶具|洗碗机|蒸烤一体机|空气能热水器|空净|天然气强排热水器|佳尼特电热水器/gi, ' ')
                // 括号、中文标点等
                .replace(/[（）()\[\]【】、，；：]/g, ' ');

            // 非法字符替换为空格，仅保留字母数字与 - _ . 三种连接符
            cleaned = cleaned.replace(/[^A-Za-z0-9\-_.]/g, ' ');

            // 提取所有候选：至少1个字母开头，包含字母数字，允许通过 - _ . 连接
            const candidates = cleaned.match(/[A-Za-z][A-Za-z0-9]*(?:[\-_.][A-Za-z0-9]+)*/g);
            if (!candidates) return '';

            // 优先包含数字的，并选择去除连接符后的最长者（避免只取到 J1、HC1 这类后缀）
            let filtered = candidates.filter(s => /\d/.test(s));
            if (filtered.length === 0) filtered = candidates;

            const best = filtered.reduce((prev, curr) => {
                const p = prev.replace(/[\-_.]/g, '');
                const c = curr.replace(/[\-_.]/g, '');
                return c.length > p.length ? curr : prev;
            });

            // 保留原始大小写，统一下划线为连字符
            return best.replace(/_/g, '-');
        }

        // 判断是否为厨电
        function isKitchenAppliance(productName) {
            const kitchenKeywords = ['油烟机', '灶具', '洗碗机', '蒸烤一体机', '燃气灶', 'CXW', 'JZT', 'DWQ', 'KZQ'];
            return kitchenKeywords.some(keyword => productName.includes(keyword));
        }

        // 模糊匹配型号（大小写不敏感）
        function findModelMatch(targetModel, dataArray, modelField) {
            if (!targetModel) return null;
            
            // 精确匹配
            let match = dataArray.find(item => 
                item[modelField] && item[modelField].toUpperCase() === targetModel.toUpperCase()
            );
            
            if (match) return match;
            
            // 模糊匹配（去除特殊字符）
            const cleanTarget = targetModel.replace(/[-_]/g, '').toUpperCase();
            match = dataArray.find(item => {
                if (!item[modelField]) return false;
                const cleanModel = item[modelField].replace(/[-_]/g, '').toUpperCase();
                return cleanModel === cleanTarget;
            });
            
            return match;
        }

        // 处理数据的主函数
        function processData() {
            if (!detailData.length || !policyData.length) {
                showStatus('请先上传销售明细表和渠道政策表', 'error');
                return;
            }

            showStatus('正在处理数据...', 'warning');
            
            processedData = detailData.map((row, index) => {
                const result = {...row};
                
                // 匹配导购人员（如果有门店导购人员表）
                const storeName = row['部门'] || row['门店'] || row['门店名称'] || row['店铺'] || row['销售订单中门店名称'] || '';
                if (staffData.length > 0 && storeName) {
                    const staffMatch = staffData.find(item => {
                        // 尝试多个字段进行匹配
                        const dept = item['部门'] || '';
                        const store = item['门店'] || item['门店名称'] || item['店铺'] || '';
                        const orderStore = item['销售订单中门店名称'] || '';
                        
                        return dept === storeName || store === storeName || orderStore === storeName;
                    });
                    
                    if (staffMatch) {
                        // 支持带空格和不带空格的列名
                        result['导购人员1'] = staffMatch['导购人员 1'] || staffMatch['导购人员1'] || staffMatch['导购1'] || '';
                        result['导购人员2'] = staffMatch['导购人员 2'] || staffMatch['导购人员2'] || staffMatch['导购2'] || '';
                    } else {
                        result['导购人员1'] = '';
                        result['导购人员2'] = '';
                    }
                } else {
                    result['导购人员1'] = '';
                    result['导购人员2'] = '';
                }
                
                // 提取型号
                const productName = row['商品名称'] || row['商品简码'] || '';
                result['型号'] = extractModel(productName);
                result['型号提取说明'] = `从"${productName}"中提取型号${result['型号']}`;
                
                // 判断是否为厨电
                const isKitchen = isKitchenAppliance(productName);
                result['是否厨电'] = isKitchen ? '是' : '否';
                
                if (isKitchen) {
                    result['单台提成（核对）'] = '需邮件审批';
                    result['提成（核对）'] = '需邮件审批';
                    result['匹配说明'] = '汇德隆厨电需邮件审批';
                    return result;
                }
                
                // 在政策表中查找匹配
                const policyMatch = findModelMatch(result['型号'], policyData, '型号');
                
                if (policyMatch) {
                    const commission = policyMatch['提成'];
                    
                    if (commission === '以渠道备案提成为准') {
                        // 查找佳尼特标准
                        if (janitData.length > 0) {
                            const janitMatch = janitData.find(item => 
                                item['店铺'] === '汇德隆' && 
                                item['型号'] && 
                                item['型号'].toUpperCase() === result['型号'].toUpperCase()
                            );
                            
                            if (janitMatch) {
                                result['单台提成（核对）'] = parseFloat(janitMatch['导购提成']) || 0;
                                result['匹配说明'] = `佳尼特特殊规则，从佳尼特标准表匹配到提成${janitMatch['导购提成']}`;
                            } else {
                                result['单台提成（核对）'] = 0;
                                result['匹配说明'] = '佳尼特特殊规则，但在佳尼特标准表中未找到匹配';
                            }
                        } else {
                            result['单台提成（核对）'] = 0;
                            result['匹配说明'] = '佳尼特特殊规则，但未上传佳尼特标准表';
                        }
                    } else {
                        result['单台提成（核对）'] = parseFloat(commission) || 0;
                        result['匹配说明'] = `从渠道政策表匹配到提成${commission}`;
                    }
                } else {
                    result['单台提成（核对）'] = 0;
                    result['匹配说明'] = `型号"${result['型号']}"在渠道政策表中未找到匹配`;
                }
                
                // 计算总提成
                const quantity = parseFloat(row['销售数量']) || 0;
                const unitCommission = parseFloat(result['单台提成（核对）']) || 0;
                result['提成（核对）'] = isNaN(unitCommission) ? '需邮件审批' : (quantity * unitCommission).toFixed(2);
                
                return result;
            });

            displayResults();
            showSummary();
            document.getElementById('exportBtn').disabled = false;
            showStatus('数据处理完成！', 'success');
        }

        // 显示结果表格
        function displayResults() {
            const table = document.getElementById('resultsTable');
            const header = document.getElementById('tableHeader');
            const body = document.getElementById('tableBody');
            
            if (processedData.length === 0) return;
            
            // 构建表头
            const originalColumns = Object.keys(processedData[0]).filter(key => 
                !['导购人员1', '导购人员2', '型号', '单台提成（核对）', '提成（核对）', '型号提取说明', '匹配说明', '是否厨电'].includes(key)
            );
            
            const staffColumns = ['导购人员1', '导购人员2'];
            const newColumns = ['型号', '单台提成（核对）', '提成（核对）'];
            const explanationColumns = ['型号提取说明', '匹配说明'];
            
            let headerHTML = '<tr>';
            
            // 原始列
            originalColumns.forEach(col => {
                headerHTML += `<th class="${document.getElementById('showOriginal').checked ? '' : 'hidden'}">${col}</th>`;
            });
            
            // 导购人员列
            staffColumns.forEach(col => {
                headerHTML += `<th style="background: #e8f5e9;">${col}</th>`;
            });
            
            // 新增列
            newColumns.forEach(col => {
                const className = col.includes('型号') ? 'model-column' : 'commission-column';
                headerHTML += `<th class="${className}">${col}</th>`;
            });
            
            // 说明列
            explanationColumns.forEach(col => {
                headerHTML += `<th class="explanation-column ${document.getElementById('showExplanation').checked ? '' : 'hidden'}">${col}</th>`;
            });
            
            headerHTML += '<th>是否厨电</th></tr>';
            header.innerHTML = headerHTML;
            
            // 构建表体
            let bodyHTML = '';
            processedData.forEach(row => {
                const isKitchen = row['是否厨电'] === '是';
                bodyHTML += `<tr class="${isKitchen ? 'kitchen-appliance' : ''}">`;
                
                // 原始列
                originalColumns.forEach(col => {
                    bodyHTML += `<td class="${document.getElementById('showOriginal').checked ? '' : 'hidden'}">${row[col] || ''}</td>`;
                });
                
                // 导购人员列
                staffColumns.forEach(col => {
                    bodyHTML += `<td style="background: #e8f5e9;">${row[col] || ''}</td>`;
                });
                
                // 新增列
                newColumns.forEach(col => {
                    const className = col.includes('型号') ? 'model-column' : 'commission-column';
                    bodyHTML += `<td class="${className}">${row[col] || ''}</td>`;
                });
                
                // 说明列
                explanationColumns.forEach(col => {
                    bodyHTML += `<td class="explanation-column ${document.getElementById('showExplanation').checked ? '' : 'hidden'}">${row[col] || ''}</td>`;
                });
                
                bodyHTML += `<td>${row['是否厨电']}</td></tr>`;
            });
            
            body.innerHTML = bodyHTML;
        }

        // 显示汇总信息
        function showSummary() {
            const summaryDiv = document.getElementById('summary');
            const totalRows = processedData.length;
            const matchedRows = processedData.filter(row => 
                parseFloat(row['单台提成（核对）']) > 0 || row['单台提成（核对）'] === '需邮件审批'
            ).length;
            const kitchenRows = processedData.filter(row => row['是否厨电'] === '是').length;
            const totalCommission = processedData.reduce((sum, row) => {
                const commission = parseFloat(row['提成（核对）']);
                return sum + (isNaN(commission) ? 0 : commission);
            }, 0);
            
            summaryDiv.innerHTML = `
                <div class="summary-item">
                    <div class="summary-value">${totalRows}</div>
                    <div class="summary-label">总记录数</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value">${matchedRows}</div>
                    <div class="summary-label">匹配成功</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value">${kitchenRows}</div>
                    <div class="summary-label">厨电产品</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value">${totalCommission.toFixed(2)}</div>
                    <div class="summary-label">总提成金额</div>
                </div>
            `;
            summaryDiv.classList.remove('hidden');
        }

        // 切换列显示
        function toggleColumns() {
            displayResults();
        }

        // 导出结果
        function exportResults() {
            if (processedData.length === 0) {
                showStatus('没有数据可导出', 'error');
                return;
            }
            
            const ws = XLSX.utils.json_to_sheet(processedData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '提成计算结果');
            
            const fileName = `汇德隆提成计算结果_${new Date().toISOString().slice(0,10)}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showStatus('导出成功！', 'success');
        }

        // 显示状态信息
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusInfo');
            statusDiv.className = `status-info status-${type}`;
            statusDiv.textContent = message;
            
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.textContent = '';
                    statusDiv.className = '';
                }, 3000);
            }
        }
    </script>
</body>
</html>