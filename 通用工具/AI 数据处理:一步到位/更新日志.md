

# 1.0

基于原数据处理优化

修改核心功能，用户可以输入要求，然后ai 理解需求，然后处理表格数据


已完成“用户输入要求→AI 理解→直接处理表格数据”的核心功能升级，并保持对原有手动筛选与AI回填UI流程的兼容。

实现概述
- 新增“AI 一键执行”：用户输入中文需求，AI 解析输出JSON计划并自动执行数据处理流水线。
- 数据处理能力扩展：
  - 过滤操作符：>, <, >=, <=, ==, !=, contains, startswith, endswith, regex, in, between, isnull, notnull
  - 排序 sort：支持多列升/降序
  - 去重 drop_duplicates：subset+keep(first/last/False)
  - TopN/limit：取前N行
  - 分组聚合 groupby：by+多聚合(sum/mean/count/min/max)，自动扁平化列名(列_聚合)
  - 列重命名 rename：按映射重命名输出列
- 主要新增/改造点：
  - 新函数 filter_rows_ext：支持扩展过滤操作符并处理类型转换与容错。
  - 新线程 AIApplyWorker：按顺序执行 rename → filters → drop_duplicates → groupby → sort → columns_to_keep → limit，逐步记录日志与形状变化。
  - AIWorker 提示词与Schema扩展：约束模型仅输出严格JSON，包含 columns_to_keep、filters、sort、drop_duplicates、limit、groupby、rename。
  - UI新增按钮“AI 一键执行”，移除硬编码API Key，默认读取环境变量 DEEPSEEK_API_KEY。
  - 保留“AI 解析需求”仅回填UI（不支持的高级条件记录到日志，建议用“一键执行”）。
- 健壮性：
  - 缺失列自动忽略并日志提示。
  - 数值/区间自动尝试数值转换，失败回退字符串逻辑。
  - regex/contains 字符串处理统一使用 astype(str)，na=False。
  - 任何步骤出错不中断整体流程，通过日志提示。

使用说明
1) 加载Excel与工作表，等待数据加载完成。
2) 在“AI 智能筛选”填写 Base URL(默认https://api.deepseek.com/v1)、Model(deepseek-chat)、API Key（建议环境变量DEEPSEEK_API_KEY）与中文需求描述。
3) 点击“AI 一键执行”直接应用计划并在右侧预览结果；或用“AI 解析需求”仅回填UI再手动“应用筛选”。
4) 到“保存结果”选择路径并保存为 .xlsx 或 .csv。

示例需求
- 只要上海 2024 年 6 月的销售订单，保留订单号、客户名、金额，金额>1000，按金额降序取前100行
- 客户名包含“科技”，去重按订单号保留最新，按客户分组统计 金额sum 和 订单数count
- 状态 in(已支付,已完成) 且 日期 between[2024-01-01, 2024-06-30]，按日期升序

依赖
- Python 包：pandas、numpy、openpyxl、requests、PyQt5、tqdm
- 若缺失请先安装后再运行。

已更新文件
- excel_filter_gui.py：已写入并保存，包含上述全部改动。