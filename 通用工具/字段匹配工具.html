<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>æ™ºèƒ½è¡¨æ ¼åŒ¹é…å·¥å…·ï¼ˆæ€§èƒ½ä¼˜åŒ–ç‰ˆï¼‰</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<script>
/*
è¯´æ˜ï¼ˆæœ¬ç‰ˆæœ¬è¾ƒä¸Šä¸€ç‰ˆçš„æ ¸å¿ƒæ–°å¢ï¼‰ï¼š
1. ä½¿ç”¨ Web Worker è¿›è¡Œæ–‡ä»¶è§£æä¸åŒ¹é…ï¼Œé¿å…ä¸»çº¿ç¨‹å¡æ­»â€œæ­¤é¡µé¢æ²¡æœ‰å“åº”â€
2. è§£æåˆ†ä¸ºâ€œé¢„è§ˆè§£æ (åªè¯»å‰ PREVIEW_LIMIT è¡Œ)â€ ä¸ â€œå®Œæ•´åŒ¹é…è§£æâ€ ä¸¤é˜¶æ®µ
3. é¢„è§ˆè¡¨æ ¼é‡‡ç”¨è¡Œè™šæ‹ŸåŒ–ï¼ˆä»…æ¸²æŸ“å¯è§†åŒºçš„è¡Œï¼‰ï¼Œæ”¯æŒ 10ä¸‡+ è¡Œä¸å¡ç•Œé¢
4. åŒ¹é…è¿‡ç¨‹åˆ†å— / æ—¶é—´åˆ‡ç‰‡ï¼Œå®æ—¶è¿›åº¦åé¦ˆ
5. å¤§æ•°æ®é›†å¯¼å‡ºï¼šè¡Œ*åˆ— > é˜ˆå€¼æ—¶è‡ªåŠ¨å›é€€ä¸º CSV å¯¼å‡ºï¼Œå‡å°‘å†…å­˜å ç”¨
6. å¢åŠ è¶…å¤§æ–‡ä»¶æç¤ºã€å†…å­˜ä¼°ç®—ã€å¯å–æ¶ˆçš„å¼‚æ­¥ä»»åŠ¡
7. ä¸»çº¿ç¨‹ä¸å†ä¿å­˜æ‰€æœ‰åŸå§‹æ•°æ®ï¼ˆä»…å­˜é¢„è§ˆ + é€‰æ‹©ä¿¡æ¯ï¼‰ï¼Œå®Œæ•´æ•°æ®é©»ç•™åœ¨ Worker å†…
*/
</script>
<style>
*{box-sizing:border-box}body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;background:#f3f5f9;color:#222}
header{background:linear-gradient(120deg,#4caf50,#2196f3);padding:18px 22px;color:#fff}
h1{font-size:1.4rem;margin:0}
small.muted{opacity:.8}
.container{max-width:1400px;margin:16px auto;padding:0 16px}
.panel{background:#fff;border-radius:14px;padding:20px 22px;margin-bottom:22px;box-shadow:0 4px 18px -6px rgba(0,0,0,.08)}
.panel h2{margin:0 0 12px;font-size:1.1rem;display:flex;align-items:center;gap:6px}
.flex{display:flex;gap:16px;flex-wrap:wrap}
.upload-box{flex:1;min-width:260px;border:2px dashed #cfd8dc;border-radius:10px;padding:26px;text-align:center;cursor:pointer;position:relative;transition:.25s;background:#fafbfc}
.upload-box:hover{border-color:#4caf50;background:#f1faf2}
.upload-box.active{border-color:#4caf50;background:#e8f5e9}
.upload-box input{display:none}
.badge{display:inline-block;padding:2px 8px;border-radius:14px;font-size:12px;background:#e3f2fd;color:#1976d2;margin-left:4px}
.note{font-size:12px;color:#666;line-height:1.5;margin-top:6px}
.sheet-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:8px;margin-top:8px}
.sheet-item{border:1px solid #d0d7de;border-radius:8px;padding:8px 10px;font-size:13px;display:flex;flex-direction:column;gap:2px;cursor:pointer;background:#fff;transition:.2s}
.sheet-item:hover{border-color:#4caf50;background:#f4fbf5}
.sheet-item.active{border-color:#4caf50;background:#e8f5e9}
.sheet-item .meta{font-size:11px;color:#555;display:flex;gap:6px;flex-wrap:wrap}
.hidden{display:none !important}
.btn{border:none;background:#4caf50;color:#fff;padding:10px 20px;font-size:14px;border-radius:8px;cursor:pointer;transition:.25s;display:inline-flex;align-items:center;gap:6px}
.btn:hover{background:#43a047}
.btn:disabled{background:#bdbdbd;cursor:not-allowed}
.btn.secondary{background:#607d8b}.btn.secondary:hover{background:#546e7a}
.btn.danger{background:#f44336}.btn.danger:hover{background:#e53935}
.btn.light{background:#eceff1;color:#333}.btn.light:hover{background:#e0e3e6}
.inline{display:inline-flex;gap:8px;flex-wrap:wrap}
.form-row{display:flex;gap:16px;flex-wrap:wrap;margin-top:12px}
.form-row>div{flex:1;min-width:200px}
select,input[type=text]{width:100%;padding:8px 10px;font-size:14px;border:1px solid #cfd8dc;border-radius:6px;background:#fff}
.field-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;margin-top:12px;max-height:260px;overflow:auto;border:1px solid #eee;padding:8px;border-radius:8px;background:#fff}
.field-item{display:flex;align-items:center;gap:6px;font-size:13px}
.progress-wrap{margin:14px 0}
.progress-bar{height:18px;background:#e0e0e0;border-radius:10px;overflow:hidden;position:relative}
.progress-fill{height:100%;width:0;background:linear-gradient(90deg,#4caf50,#2196f3);transition:width .35s}
.progress-text{position:absolute;left:50%;top:0;transform:translateX(-50%);font-size:11px;line-height:18px;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.4)}
.stat-cards{display:flex;flex-wrap:wrap;gap:14px;margin-top:12px}
.stat{flex:1;min-width:140px;background:#fff;border-radius:12px;padding:14px 12px;box-shadow:0 2px 10px rgba(0,0,0,.06);text-align:center}
.stat .num{font-size:1.6rem;font-weight:600;color:#4caf50}
.log-box{background:#111;color:#c8e6c9;font-family:ui-monospace,monospace;font-size:11px;padding:8px 10px;border-radius:8px;max-height:150px;overflow:auto;line-height:1.45;margin-top:10px;white-space:pre-wrap}
.warn{background:#fff3cd;border:1px solid #ffe58f;padding:10px 14px;border-radius:8px;font-size:13px;color:#795548;margin-top:10px}
.danger-box{background:#ffebee;border:1px solid #ffcdd2;color:#c62828;padding:10px 14px;font-size:13px;border-radius:8px;margin-top:10px}
.flex-between{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.virtual-table-container{position:relative;border:1px solid #d0d7de;border-radius:10px;background:#fff;margin-top:14px;height:360px;overflow:auto;font-size:12px}
.virtual-table{border-collapse:collapse;min-width:100%}
.virtual-table th,.virtual-table td{border-bottom:1px solid #eee;padding:6px 8px;text-align:left;max-width:260px;word-break:break-all}
.virtual-table thead th{position:sticky;top:0;background:#f5f7fa;z-index:2}
.shadow-fade{position:absolute;left:0;right:0;height:18px;pointer-events:none}
.shadow-top{top:0;background:linear-gradient(#ffffffcc,#ffffff00)}
.shadow-bottom{bottom:0;background:linear-gradient(#ffffff00,#ffffffcc)}
.small{font-size:12px;opacity:.8}
.label{font-size:12px;color:#555;margin-bottom:4px;display:block}
.toggle-group{display:flex;gap:8px;flex-wrap:wrap}
.tag{display:inline-block;background:#eee;color:#555;font-size:10px;padding:2px 6px;border-radius:4px;margin-left:6px}
.pill{background:#4caf50;color:#fff;font-size:11px;padding:2px 8px;border-radius:20px;margin-left:6px}
.link-btn{background:none;border:none;color:#1976d2;cursor:pointer;font-size:12px;padding:0}
footer{padding:30px 0;font-size:12px;text-align:center;color:#888}
.loading-inline{display:inline-flex;align-items:center;gap:6px}
.spinner{width:16px;height:16px;border:2px solid #cfd8dc;border-top-color:#4caf50;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<header>
<h1>ğŸ”— æ™ºèƒ½è¡¨æ ¼åŒ¹é…å·¥å…·ï¼ˆå¤šå·¥ä½œè¡¨å¢å¼ºç‰ˆ Â· æ€§èƒ½ä¼˜åŒ–ï¼‰</h1>
<small class="muted">Web Worker + è™šæ‹Ÿæ»šåŠ¨ + åˆ†å—åŒ¹é…ï¼Œè§£å†³â€œé¡µé¢æ— å“åº”â€é—®é¢˜</small>
</header>
<div class="container">

<!-- æ­¥éª¤ 1ï¼šä¸Šä¼  -->
<div class="panel" id="panel-upload">
  <h2>ğŸ“ æ­¥éª¤1 ä¸Šä¼ æ–‡ä»¶</h2>
  <div class="flex">
    <label class="upload-box" id="u1">
      <strong>ä¸»è¡¨æ–‡ä»¶</strong><br><small id="u1-info">ç‚¹å‡»é€‰æ‹© (.xlsx/.xls/.csv)</small>
      <input type="file" id="file1" accept=".xlsx,.xls,.csv">
    </label>
    <label class="upload-box" id="u2">
      <strong>åŒ¹é…è¡¨æ–‡ä»¶</strong><br><small id="u2-info">ç‚¹å‡»é€‰æ‹© (.xlsx/.xls/.csv)</small>
      <input type="file" id="file2" accept=".xlsx,.xls,.csv">
    </label>
  </div>
  <div class="note">
    è§£æç­–ç•¥ï¼šå…ˆå¿«é€Ÿè¯»å–å‰ 200 è¡Œç”¨äºé¢„è§ˆï¼ŒçœŸæ­£åŒ¹é…æ—¶å†å…¨é‡è§£æï¼Œé¿å…æå‰åŠ è½½å…¨éƒ¨æ•°æ®ã€‚<br>
    å¦‚æœæ–‡ä»¶éå¸¸å¤§ï¼ˆ> 20MB æˆ– > 10 ä¸‡è¡Œï¼‰ä¼šæç¤ºä½¿ç”¨ CSV + åˆ†å—å¤„ç† / æˆ–æ‹†åˆ†ä¸ºå¤šæ–‡ä»¶ã€‚
  </div>
  <div id="bigFileTips" class="warn hidden"></div>
  <div id="sheetArea1" class="hidden">
    <h3>ä¸»è¡¨å·¥ä½œè¡¨é€‰æ‹©</h3>
    <div class="sheet-list" id="sheetList1"></div>
  </div>
  <div id="sheetArea2" class="hidden">
    <h3>åŒ¹é…è¡¨å·¥ä½œè¡¨é€‰æ‹©</h3>
    <div class="sheet-list" id="sheetList2"></div>
  </div>
  <div id="previewArea" class="flex">
    <div style="flex:1;min-width:320px" class="hidden" id="previewWrap1">
      <div class="flex-between">
        <h3 style="margin:10px 0 6px;font-size:14px">ä¸»è¡¨é¢„è§ˆ <span id="pvMeta1" class="small"></span></h3>
        <button class="link-btn" data-preview-refresh="1">é‡æ–°æ¸…æ´—</button>
      </div>
      <div id="tablePreview1" class="virtual-table-container"></div>
    </div>
    <div style="flex:1;min-width:320px" class="hidden" id="previewWrap2">
      <div class="flex-between">
        <h3 style="margin:10px 0 6px;font-size:14px">åŒ¹é…è¡¨é¢„è§ˆ <span id="pvMeta2" class="small"></span></h3>
        <button class="link-btn" data-preview-refresh="2">é‡æ–°æ¸…æ´—</button>
      </div>
      <div id="tablePreview2" class="virtual-table-container"></div>
    </div>
  </div>
  <div id="uploadLog" class="log-box hidden"></div>
</div>

<!-- æ­¥éª¤ 2ï¼šé…ç½® -->
<div class="panel hidden" id="panel-config">
  <h2>âš™ï¸ æ­¥éª¤2 é…ç½®åŒ¹é…è§„åˆ™</h2>
  <div class="warn" id="configHint">
    å·²é€‰å·¥ä½œè¡¨ï¼š<strong id="selSheet1">-</strong> / <strong id="selSheet2">-</strong><br>
    è‹¥å­—æ®µè¯†åˆ«ä¸æ­£ç¡®ï¼Œå¯å›åˆ°ä¸Šä¸€æ­¥é‡æ–°é€‰æ‹©æˆ–æ¢ç”¨ CSVã€‚
  </div>
  <div class="form-row">
    <div>
      <label class="label">ä¸»è¡¨åŒ¹é…å­—æ®µ</label>
      <select id="key1"></select>
    </div>
    <div>
      <label class="label">åŒ¹é…è¡¨åŒ¹é…å­—æ®µ</label>
      <select id="key2"></select>
    </div>
    <div>
      <label class="label">åŒ¹é…æ¨¡å¼</label>
      <select id="matchMode">
        <option value="exact">ç²¾ç¡®</option>
        <option value="fuzzy">æ¨¡ç³Š(å»é¦–å°¾ç©ºæ ¼/å¿½ç•¥å¤§å°å†™)</option>
        <option value="smart">æ™ºèƒ½(å†å»å†…éƒ¨ç©ºç™½)</option>
      </select>
    </div>
    <div>
      <label class="label">æœªåŒ¹é…å¡«å……å€¼</label>
      <input type="text" id="unmatchedFill" placeholder="é»˜è®¤ç©ºå­—ç¬¦ä¸²">
    </div>
  </div>
  <div style="margin-top:16px">
    <strong>é€‰æ‹©è¦è¿½åŠ çš„å­—æ®µ <span class="tag">æ¥è‡ªåŒ¹é…è¡¨</span></strong>
    <div class="inline" style="margin-top:6px">
      <button class="btn light" id="btnAll">å…¨é€‰</button>
      <button class="btn light" id="btnNone">å…¨ä¸é€‰</button>
      <button class="btn light" id="btnInvert">åé€‰</button>
    </div>
    <div id="fieldGrid" class="field-grid"></div>
  </div>
  <div style="margin-top:20px" class="inline">
    <button class="btn" id="btnStartMatch">ğŸ” å¼€å§‹åŒ¹é…</button>
    <button class="btn secondary" id="btnBack">â¬…ï¸ è¿”å›ä¸Šä¸€æ­¥</button>
    <button class="btn danger hidden" id="btnCancelTask">â›” å–æ¶ˆè¿›è¡Œä¸­ä»»åŠ¡</button>
  </div>
  <div id="matchLog" class="log-box hidden"></div>
</div>

<!-- æ­¥éª¤ 3ï¼šç»“æœ -->
<div class="panel hidden" id="panel-result">
  <h2>ğŸ“Š æ­¥éª¤3 åŒ¹é…ç»“æœ</h2>
  <div class="progress-wrap">
    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div><div class="progress-text" id="progressText">0%</div></div>
    <div class="small" id="progressDetail"></div>
  </div>
  <div class="stat-cards">
    <div class="stat"><div class="num" id="statTotal">0</div><div>æ€»è¡Œæ•°</div></div>
    <div class="stat"><div class="num" id="statMatched">0</div><div>åŒ¹é…æˆåŠŸ</div></div>
    <div class="stat"><div class="num" id="statUnmatched">0</div><div>æœªåŒ¹é…</div></div>
    <div class="stat"><div class="num" id="statRate">0%</div><div>åŒ¹é…ç‡</div></div>
  </div>
  <div class="warn" id="exportHint" style="margin-top:14px"></div>
  <div style="margin-top:18px" class="inline">
    <button class="btn" id="btnDownload">ğŸ’¾ ä¸‹è½½ç»“æœ</button>
    <button class="btn secondary" id="btnDownloadUnmatched">ğŸ“¤ å¯¼å‡ºæœªåŒ¹é…</button>
    <button class="btn danger" id="btnResetAll">ğŸ”„ é‡æ–°å¼€å§‹</button>
  </div>
  <h3 style="margin:24px 0 6px;font-size:14px">ç»“æœé¢„è§ˆï¼ˆå‰ 150 è¡Œï¼‰</h3>
  <div id="resultPreview" class="virtual-table-container"></div>
  <div id="resultLog" class="log-box hidden"></div>
</div>

<footer>
  æ€§èƒ½æç¤ºï¼šè¶…å¤§æ–‡ä»¶è¯·ä¼˜å…ˆè½¬æ¢ä¸º CSVï¼›ä¹Ÿå¯åˆ†æ‰¹å¯¼å…¥å¤šæ¬¡åˆå¹¶ã€‚å½“å‰ç‰ˆæœ¬æ”¯æŒåä¸‡çº§è¡Œæµè§ˆä¸åŒ¹é…ï¼ˆè§†æµè§ˆå™¨å†…å­˜è€Œå®šï¼‰ã€‚
</footer>
</div>

<script>
/* ------------------ å¸¸é‡é…ç½® ------------------- */
const PREVIEW_LIMIT = 200;              // é¢„è§ˆè¯»å–è¡Œï¼ˆå«è¡¨å¤´ï¼‰
const VIRTUAL_ROW_HEIGHT = 28;          // ä¼°ç®—å•è¡Œé«˜åº¦ï¼ˆPXï¼‰
const BLOCK_MATCH_SIZE = 2000;          // æ¯æ‰¹åŒ¹é…è¡Œæ•°ï¼ˆæ—¶é—´åˆ‡ç‰‡ï¼‰
const LARGE_DATA_CELL_THRESHOLD = 5_000_000; // è¡Œ*åˆ— è¶…è¿‡åˆ™å¯¼å‡º CSV
const BIG_FILE_SIZE_WARN = 20 * 1024 * 1024;
let worker = null;
let fileBuffers = {1:null,2:null}; // ArrayBuffer
let selectedSheet = {1:null,2:null};
let previewMeta = {1:null,2:null};
let headers = {1:[],2:[]};
let fieldSelectionCache = [];
let currentTaskId = 0;
let resultMeta = null;
let lastResultPreview = null;
let exportedBlobInfo = null;

/* ------------------ åˆå§‹åŒ– Worker ------------------- */
function createWorker(){
const code = `
self.importScripts('https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js');
const PREVIEW_LIMIT = ${PREVIEW_LIMIT};
function parseArrayBuffer(buf,isCSV,filename){
  if(isCSV){
    const decoder = new TextDecoder('utf-8');
    const text = decoder.decode(buf);
    return {wb:null,csvText:text};
  }else{
    const data = new Uint8Array(buf);
    const arr = [];
    for(let i=0;i<data.length;i++) arr[i] = String.fromCharCode(data[i]);
    const bstr = arr.join('');
    const wb = XLSX.read(bstr,{type:'binary',dense:true});
    return {wb,csvText:null};
  }
}
function aoaFromSheet(sheet){
  return XLSX.utils.sheet_to_json(sheet,{header:1,raw:false,blankrows:false});
}
function cleanAndDetectHeader(data){
  if(!data||!data.length) return [];
  let arr = data.map(r=>Array.isArray(r)?r:[r]);
  const isEmptyRow = r=>!r||r.every(c=> (c===undefined||c===null||(''+c).trim()===''));
  while(arr.length && isEmptyRow(arr[0])) arr.shift();
  while(arr.length && isEmptyRow(arr[arr.length-1])) arr.pop();
  const candidate = Math.min(6,arr.length);
  let bestI=0,bestScore=-1;
  for(let i=0;i<candidate;i++){
    const nonEmpty = arr[i].filter(c=> (c!==undefined && c!==null && (''+c).trim()!=='')).length;
    if(nonEmpty>bestScore){bestScore=nonEmpty;bestI=i;}
  }
  if(arr.length>=2){
    const f = arr[0].filter(c=> (c||'').toString().trim()!=='').length;
    const s = arr[1].filter(c=> (c||'').toString().trim()!=='').length;
    if(f<=1 && s>=Math.max(2,f+1)) bestI=1;
  }
  const header = (arr[bestI]||[]).map(c=>(c||'').toString().trim());
  arr = arr.slice(bestI+1).filter(r=>!isEmptyRow(r));
  let colCount = Math.max(header.length,...arr.map(r=>r.length));
  const colEmpty = [];
  for(let c=0;c<colCount;c++){
    let any=false;
    if(header[c] && header[c].toString().trim()!=='') any=true;
    for(let r=0;r<arr.length && !any;r++){
      const v = arr[r][c];
      if(v!==undefined && v!==null && (''+v).trim()!=='') any=true;
    }
    colEmpty[c]=!any;
  }
  while(colEmpty.length && colEmpty[0]){colEmpty.shift();header.shift();arr.forEach(r=>r.shift());}
  while(colEmpty.length && colEmpty[colEmpty.length-1]){colEmpty.pop();header.pop();arr.forEach(r=>r.pop());}
  const finalLen = header.length;
  const normalized = arr.map(r=>{
    const nr = new Array(finalLen);
    for(let i=0;i<finalLen;i++) nr[i] = (r[i]!==undefined && r[i]!==null)?(''+r[i]).trim():'';
    return nr;
  });
  const seen={};
  const uniqHeader = header.map((h,i)=>{
    const base = h || ('åˆ—'+(i+1));
    if(!seen[base]){seen[base]=1;return base;}
    const newName = base+'_'+seen[base];seen[base]++;return newName;
  });
  return [uniqHeader,...normalized];
}
function buildPreview(aoa){
  const cleaned = cleanAndDetectHeader(aoa);
  if(!cleaned.length) return {header:[],rows:[],rawRows:0,cleanRows:0};
  const header = cleaned[0];
  const rows = cleaned.slice(1,1+PREVIEW_LIMIT-1);
  return {header,rows,rawRows:aoa.length,cleanRows:cleaned.length-1};
}
function normalizeKey(key,mode){
  if(key===undefined||key===null) return '';
  let v=''+key;
  if(mode==='exact') return v;
  v = v.toLowerCase().trim();
  if(mode==='smart') v = v.replace(/\\s+/g,'');
  return v;
}
function toCSV(aoa){
  return aoa.map(r=> r.map(c=>{
    if(c==null) return '';
    const s=''+c;
    if(/[",\\n]/.test(s)) return '"'+s.replace(/"/g,'""')+'"';
    return s;
  }).join(',')).join('\\r\\n');
}
let storedFull = {
  // key: task-specific or (fileId|sheetName)
};
self.onmessage = async (e)=>{
  const {cmd,taskId} = e.data;
  try{
    if(cmd==='preview'){
      const {fileId,buffer,isCSV,filename} = e.data;
      const parsed = parseArrayBuffer(buffer,isCSV,filename);
      let sheetsMeta=[];
      if(isCSV){
        // CSV å½“åšå• sheet
        const lines = parsed.csvText.split(/\\r?\\n/).map(l=>l.split(','));
        const preview = buildPreview(lines);
          sheetsMeta.push({
            name:'Sheet1',
            header:preview.header,
            previewRows:preview.rows,
            rawRows:preview.rawRows,
            cleanRows:preview.cleanRows
          });
        storedFull[fileId]={buffer,isCSV,filename};
      }else{
        const wb = parsed.wb;
        storedFull[fileId]={buffer,isCSV:false,filename,sheetNames:wb.SheetNames};
        wb.SheetNames.forEach(sn=>{
          try{
            const sheet = wb.Sheets[sn];
            const aoa = aoaFromSheet(sheet);
            const preview = buildPreview(aoa);
            sheetsMeta.push({
              name:sn,
              header:preview.header,
              previewRows:preview.rows,
              rawRows:aoa.length,
              cleanRows:preview.cleanRows
            });
          }catch(err){
            sheetsMeta.push({name:sn,error:err.message});
          }
        });
      }
      postMessage({cmd:'preview-done',taskId,fileId,sheetsMeta});
    }
    else if(cmd==='refreshPreviewSheet'){
      const {fileId,sheetName} = e.data;
      const stored = storedFull[fileId];
      if(!stored) throw new Error('æœªæ‰¾åˆ°æ–‡ä»¶ç¼“å­˜');
      if(stored.isCSV){
        const decoder = new TextDecoder('utf-8');
        const txt = new TextDecoder().decode(stored.buffer);
        const lines = txt.split(/\\r?\\n/).map(l=>l.split(','));
        const preview = buildPreview(lines);
        postMessage({cmd:'refreshPreview-done',taskId,fileId,sheetName:'Sheet1',header:preview.header,previewRows:preview.rows,rawRows:preview.rawRows,cleanRows:preview.cleanRows});
      }else{
        const data = new Uint8Array(stored.buffer);
        const arr=[];for(let i=0;i<data.length;i++) arr[i]=String.fromCharCode(data[i]);
        const wb = XLSX.read(arr.join(''),{type:'binary',dense:true});
        const sheet = wb.Sheets[sheetName];
        const aoa = aoaFromSheet(sheet);
        const preview = buildPreview(aoa);
        postMessage({cmd:'refreshPreview-done',taskId,fileId,sheetName,header:preview.header,previewRows:preview.rows,rawRows:aoa.length,cleanRows:preview.cleanRows});
      }
    }
    else if(cmd==='startMatch'){
      const {file1,file2,sheet1,sheet2,key1,key2,mode,fields,unmatchedFill} = e.data;
      // é‡æ–°å…¨é‡è§£æ
      function fullClean(fileId,sheet){
        const rec = storedFull[fileId];
          if(!rec) throw new Error('æ–‡ä»¶ç¼“å­˜ä¸å­˜åœ¨:'+fileId);
          if(rec.isCSV){
            const txt = new TextDecoder().decode(rec.buffer);
            const lines = txt.split(/\\r?\\n/).map(l=>l.split(','));
            return cleanAndDetectHeader(lines);
          }else{
            const u8 = new Uint8Array(rec.buffer);
            const arr=[];for(let i=0;i<u8.length;i++) arr[i]=String.fromCharCode(u8[i]);
            const wb = XLSX.read(arr.join(''),{type:'binary',dense:true});
            const target = wb.Sheets[sheet];
            if(!target) throw new Error('æ‰¾ä¸åˆ°å·¥ä½œè¡¨:'+sheet);
            const aoa = aoaFromSheet(target);
            return cleanAndDetectHeader(aoa);
          }
      }
      const t1 = fullClean(file1,sheet1);
      const t2 = fullClean(file2,sheet2);
      const h1 = t1[0]; const h2 = t2[0];
      const d1 = t1.slice(1);
      const d2 = t2.slice(1);
      // å»ºç«‹ç´¢å¼•
      const map = new Map();
      for(const r of d2){
        const k = normalizeKey(r[key2],mode);
        if(!map.has(k)) map.set(k,[]);
        map.get(k).push(r);
      }
      const newHeader = h1.concat(fields.map(i=>h2[i]));
      const total = d1.length;
      let matched=0;
      const previewOut = [newHeader];
      let outRowsCount=0;
      // å› ä¸ºå®Œæ•´ç»“æœå¯èƒ½å¾ˆå¤§ï¼Œä¸æŠŠå…¨éƒ¨è¡Œå­˜åœ¨ä¸»çº¿ç¨‹ï¼›åœ¨ worker ä¸­æ„å»ºæœ€ç»ˆå¯¼å‡ºæ•°æ®
      const exportAoa = [newHeader];
      const startTime = Date.now();
      for(let i=0;i<total;i++){
        if(i % ${BLOCK_MATCH_SIZE} === 0 && i>0){
          const pct = ((i/total)*100).toFixed(2);
          postMessage({cmd:'match-progress',taskId,progress:i,total,percent:pct,matched,elapsed:Date.now()-startTime});
        }
        const r1 = d1[i];
        const k = normalizeKey(r1[key1],mode);
          const base = r1.slice();
          if(map.has(k)){
            const mr = map.get(k)[0];
            for(const f of fields) base.push(mr[f] ?? '');
            matched++;
          }else{
            for(const _ of fields) base.push(unmatchedFill);
          }
        exportAoa.push(base);
        if(previewOut.length<151) previewOut.push(base); // ç»“æœé¢„è§ˆå‰ 150 è¡Œ
      }
      const unmatched = total - matched;
      const matchRate = total? (matched/total):0;
      // åˆ¤æ–­å¯¼å‡ºæ–¹å¼
      const cellCount = exportAoa.length * newHeader.length;
      let exportType = 'xlsx';
      if(cellCount > ${LARGE_DATA_CELL_THRESHOLD}){
        exportType='csv';
      }
      // ç”Ÿæˆå¯¼å‡º blob
      let blob;
      if(exportType==='xlsx'){
        const ws = XLSX.utils.aoa_to_sheet(exportAoa);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb,ws,'åŒ¹é…ç»“æœ');
        const wbout = XLSX.write(wb,{bookType:'xlsx',type:'array'});
        blob = new Blob([wbout],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
      }else{
        const csv = toCSV(exportAoa);
        blob = new Blob([csv],{type:'text/csv;charset=utf-8'});
      }
      const unmatchedAoa = [newHeader];
      const baseLen = h1.length;
      for(let i=1;i<exportAoa.length;i++){
        const row = exportAoa[i];
        let allEmpty=true;
        for(let c=baseLen;c<row.length;c++){
          if(row[c] && (''+row[c]).trim()!==''){allEmpty=false;break;}
        }
        if(allEmpty) unmatchedAoa.push(row);
      }
      let unmatchedBlob=null;
      if(unmatchedAoa.length>1){
        if(exportType==='xlsx'){
          const wsU = XLSX.utils.aoa_to_sheet(unmatchedAoa);
          const wbU = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wbU,wsU,'æœªåŒ¹é…');
          const outU = XLSX.write(wbU,{bookType:'xlsx',type:'array'});
          unmatchedBlob = new Blob([outU],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
        }else{
          unmatchedBlob = new Blob([toCSV(unmatchedAoa)],{type:'text/csv;charset=utf-8'});
        }
      }
      postMessage({
        cmd:'match-done',
        taskId,
        total,
        matched,
          unmatched,
        rate:matchRate,
        header:newHeader,
        previewRows:previewOut.slice(1),
        exportType,
        blob,
        unmatchedBlob,
        elapsed:Date.now()-startTime
      });
    }
    else if(cmd==='cancel'){
      // ç”±äºç®—æ³•æ˜¯åŒæ­¥å¾ªç¯ï¼ŒçœŸæ­£å–æ¶ˆéœ€è¦åœ¨å¾ªç¯ä¸­æ£€æŸ¥æ ‡å¿—ã€‚æ­¤ç®€åŒ–ç‰ˆæœ¬æç¤ºæ— æ³•ä¸­æ–­å·²ç»åœ¨æ‰§è¡Œçš„å¯†é›†å—ã€‚
      // è¿™é‡Œé¢„ç•™æ ‡å¿—ä½å®ç°(å¯æ‰©å±•åˆ†å—+ async)
      postMessage({cmd:'cancel-ack',taskId});
    }
  }catch(err){
    postMessage({cmd:'error',taskId,message:err.message,stack:err.stack});
  }
};
`;
worker = new Worker(URL.createObjectURL(new Blob([code],{type:'application/javascript'})));
worker.onmessage = handleWorkerMessage;
}
createWorker();

/* ------------------ å·¥å…·å‡½æ•° ------------------- */
function log(areaId,msg){
const box = document.getElementById(areaId);
if(!box) return;
if(box.classList.contains('hidden')) box.classList.remove('hidden');
const time = new Date().toLocaleTimeString();
box.textContent += '['+time+'] '+msg + '\\n';
box.scrollTop = box.scrollHeight;
}
function bytesToSize(bytes){
if(bytes<1024) return bytes+' B';
if(bytes<1024*1024) return (bytes/1024).toFixed(1)+' KB';
return (bytes/1024/1024).toFixed(2)+' MB';
}
function estMemory(rows,cols){
const perCell = 40; // ç²—ä¼°å­—ç¬¦ä¸²/å¯¹è±¡å¼€é”€
return (rows*cols*perCell/1024/1024).toFixed(1)+' MB (ä¼°ç®—)';
}
function setHidden(id,flag){document.getElementById(id).classList.toggle('hidden',flag);}
function escapeHTML(str){
return (str==null?'':(''+str).replace(/[&<>"']/g,s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s])));
}

/* ------------------ ä¸Šä¼ ä¸é¢„è§ˆ ------------------- */
document.getElementById('file1').addEventListener('change',e=>handleFile(1,e));
document.getElementById('file2').addEventListener('change',e=>handleFile(2,e));

function handleFile(idx,e){
const file = e.target.files[0];
if(!file) return;
fileBuffers[idx]=null; // reset
selectedSheet[idx]=null;
headers[idx]=[];
setUploadStatus(idx,'è§£æä¸­...');
const isCSV = /\.csv$/i.test(file.name);
if(file.size > BIG_FILE_SIZE_WARN){
  const t = document.getElementById('bigFileTips');
  t.innerHTML = 'âš ï¸ æ–‡ä»¶ '+escapeHTML(file.name)+' å¤§å° '+bytesToSize(file.size)+'ï¼Œå»ºè®®ï¼š1) è½¬ CSV æ˜¾è‘—åŠ é€Ÿ 2) ç¡®ä¿åªä¿ç•™å¿…è¦åˆ— 3) æ‹†åˆ†åé€ä¸ªåŒ¹é…ã€‚';
  t.classList.remove('hidden');
}
const fr = new FileReader();
fr.onload = ev=>{
  fileBuffers[idx] = ev.target.result;
  const taskId = ++currentTaskId;
  worker.postMessage({cmd:'preview',taskId,fileId:'f'+idx,buffer:fileBuffers[idx],isCSV,isCSVOriginal:isCSV,filename:file.name});
  log('uploadLog','å¼€å§‹è§£ææ–‡ä»¶('+idx+')ï¼š'+file.name);
};
fr.readAsArrayBuffer(file);
}
function setUploadStatus(idx,text){
const box = document.getElementById('u'+idx);
const info = document.getElementById('u'+idx+'-info');
info.textContent = text;
box.classList.add('active');
}

function handleWorkerMessage(e){
const d = e.data;
if(d.cmd==='error'){
  log('uploadLog','âŒ ä»»åŠ¡'+d.taskId+' é”™è¯¯ï¼š'+d.message);
  alert('Worker é”™è¯¯ï¼š'+d.message);
  return;
}
if(d.cmd==='preview-done'){
  log('uploadLog','æ–‡ä»¶é¢„è§ˆå®Œæˆ fileId='+d.fileId+' sheets='+d.sheetsMeta.length);
  const idx = d.fileId==='f1'?1:2;
  buildSheetList(idx,d.sheetsMeta);
}
if(d.cmd==='refreshPreview-done'){
  const idx = d.fileId==='f1'?1:2;
  applyPreview(idx,{
    name:d.sheetName,
    header:d.header,
    previewRows:d.previewRows,
    rawRows:d.rawRows,
    cleanRows:d.cleanRows
  });
  log('uploadLog','é‡æ–°æ¸…æ´—å®Œæˆ '+d.sheetName+' è¡Œ:'+d.cleanRows);
}
if(d.cmd==='match-progress'){
  const pct = d.percent;
  updateProgress(pct,d.progress,d.total,d.matched);
}
if(d.cmd==='match-done'){
  resultMeta = d;
  updateProgress(100,d.total,d.total,d.matched,true);
  showMatchStats(d);
  buildVirtualTable('resultPreview',[d.header,...d.previewRows]);
  setHidden('panel-result',false);
  log('resultLog','åŒ¹é…å®Œæˆ è€—æ—¶ '+(d.elapsed/1000).toFixed(2)+'s å¯¼å‡ºç±»å‹='+d.exportType);
  exportedBlobInfo = {
    blob:d.blob,
    unmatchedBlob:d.unmatchedBlob,
    exportType:d.exportType,
    filename: d.exportType==='xlsx' ? 'è¡¨æ ¼åŒ¹é…ç»“æœ.xlsx' : 'è¡¨æ ¼åŒ¹é…ç»“æœ.csv',
    unmatchedFilename: d.exportType==='xlsx' ? 'æœªåŒ¹é…è¡Œ.xlsx' : 'æœªåŒ¹é…è¡Œ.csv'
  };
  document.getElementById('exportHint').textContent = 'å¯¼å‡ºç±»å‹ï¼š'+(d.exportType==='xlsx'?'Excel (è¡Œåˆ—é‡é€‚ä¸­)':'CSV (æ•°æ®é‡è¶…å¤§è‡ªåŠ¨ä½¿ç”¨ CSV)')+
    ' ï½œ é¢„è§ˆä»…å‰ 150 è¡Œ';
  document.getElementById('btnDownload').disabled = false;
  document.getElementById('btnDownloadUnmatched').disabled = !d.unmatchedBlob;
  document.getElementById('btnCancelTask').classList.add('hidden');
}
if(d.cmd==='cancel-ack'){
  log('matchLog','æ”¶åˆ°å–æ¶ˆå“åº”ï¼ˆå½“å‰å®ç°ä¸ºåŒæ­¥åŒ¹é…ï¼Œå¯èƒ½æ— æ³•ç«‹å³ä¸­æ–­ï¼‰');
}
}

function buildSheetList(idx,meta){
const areaId = idx===1?'sheetArea1':'sheetArea2';
setHidden(areaId,false);
const list = document.getElementById(idx===1?'sheetList1':'sheetList2');
list.innerHTML='';
meta.forEach(m=>{
  const div = document.createElement('div');
  div.className='sheet-item';
  div.innerHTML = '<strong>'+escapeHTML(m.name)+'</strong>'+
    (m.error?('<div class="danger-box">è§£æå¤±è´¥:'+escapeHTML(m.error)+'</div>'):
    ('<div class="meta">'+
      (m.header?.length?('åˆ—:'+m.header.length):'')+
      (m.cleanRows!=null?(' è¡Œ:'+m.cleanRows):'')+
    '</div>'));
  if(!m.error){
    div.addEventListener('click',()=>applyPreview(idx,m,div));
  }else{
    div.style.opacity=.6;
  }
  list.appendChild(div);
});
}

function applyPreview(idx,meta,divEl){
// é€‰ä¸­æ ·å¼
const list = document.getElementById(idx===1?'sheetList1':'sheetList2');
list.querySelectorAll('.sheet-item').forEach(el=>el.classList.remove('active'));
if(divEl) divEl.classList.add('active');
selectedSheet[idx]=meta.name;
previewMeta[idx]=meta;
headers[idx]=meta.header||[];
// æ¸²æŸ“è™šæ‹Ÿè¡¨
buildVirtualTable(idx===1?'tablePreview1':'tablePreview2',[meta.header,...meta.previewRows]);
document.getElementById(idx===1?'previewWrap1':'previewWrap2').classList.remove('hidden');
document.getElementById(idx===1?'pvMeta1':'pvMeta2').textContent = 'åˆ—:'+meta.header.length+' é¢„è§ˆè¡Œ:'+meta.previewRows.length+' æ€»(æ¸…æ´—å)è¡Œ:'+meta.cleanRows+' ä¼°ç®—å†…å­˜:'+estMemory(meta.cleanRows,meta.header.length);
log('uploadLog','é€‰æ‹©å·¥ä½œè¡¨ '+meta.name+' (æ–‡ä»¶'+idx+')');
maybeEnableConfig();
}

function maybeEnableConfig(){
if(selectedSheet[1] && selectedSheet[2]){
  // å¡«å……å­—æ®µä¸‹æ‹‰
  fillSelectOptions('key1',headers[1]);
  fillSelectOptions('key2',headers[2]);
  buildFieldGrid();
  document.getElementById('selSheet1').textContent = selectedSheet[1];
  document.getElementById('selSheet2').textContent = selectedSheet[2];
  setHidden('panel-config',false);
  document.getElementById('panel-config').scrollIntoView({behavior:'smooth'});
}
}

function fillSelectOptions(id,arr){
const sel = document.getElementById(id);
sel.innerHTML='';
arr.forEach((h,i)=>{
  const op = document.createElement('option');
  op.value=i; op.textContent=h;
  sel.appendChild(op);
});
}

function buildFieldGrid(){
const grid = document.getElementById('fieldGrid');
grid.innerHTML='';
headers[2].forEach((h,i)=>{
  const labelId = 'fld_'+i;
  const wrap = document.createElement('div');
  wrap.className='field-item';
  wrap.innerHTML=`<input type="checkbox" id="${labelId}" value="${i}" checked><label for="${labelId}">${escapeHTML(h)}</label>`;
  grid.appendChild(wrap);
});
}

/* ------------------ è™šæ‹Ÿè¡¨æ ¼æ¸²æŸ“ ------------------- */
function buildVirtualTable(containerIdOrElem,data){
const container = typeof containerIdOrElem==='string'?document.getElementById(containerIdOrElem):containerIdOrElem;
if(!data || !data.length){container.innerHTML='<div class="small" style="padding:8px">æ— æ•°æ®</div>';return;}
const header = data[0];
const rows = data.slice(1);
container.innerHTML='';
// æ¡†æ¶
const table = document.createElement('table');
table.className='virtual-table';
const thead = document.createElement('thead');
const trh = document.createElement('tr');
header.forEach(h=>{
  const th = document.createElement('th'); th.textContent = h; trh.appendChild(th);
});
thead.appendChild(trh);
const tbody = document.createElement('tbody');
table.appendChild(thead);
table.appendChild(tbody);
container.appendChild(table);
container.appendChild(Object.assign(document.createElement('div'),{className:'shadow-fade shadow-top'}));
container.appendChild(Object.assign(document.createElement('div'),{className:'shadow-fade shadow-bottom'}));
// è™šæ‹Ÿæ»šåŠ¨
const total = rows.length;
const viewportHeight = container.clientHeight;
const visibleCount = Math.ceil(viewportHeight / VIRTUAL_ROW_HEIGHT) + 8;
let startIndex=0;
const spacerTop = document.createElement('tr');
const spacerBottom = document.createElement('tr');
function render(){
  tbody.innerHTML='';
  const end = Math.min(total,startIndex+visibleCount);
  // top spacer
  const topHeight = startIndex * VIRTUAL_ROW_HEIGHT;
  spacerTop.innerHTML = `<td colspan="${header.length}" style="height:${topHeight}px;padding:0;border:none;background:transparent;"></td>`;
  tbody.appendChild(spacerTop);
  for(let i=startIndex;i<end;i++){
    const tr = document.createElement('tr');
    const row = rows[i];
    for(let c=0;c<header.length;c++){
      const td = document.createElement('td');
      td.textContent = row?.[c] ?? '';
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }
  const bottomHeight = (total - end) * VIRTUAL_ROW_HEIGHT;
  spacerBottom.innerHTML = `<td colspan="${header.length}" style="height:${bottomHeight}px;padding:0;border:none;background:transparent;"></td>`;
  tbody.appendChild(spacerBottom);
}
function onScroll(){
  const scrollTop = container.scrollTop;
  const newStart = Math.floor(scrollTop / VIRTUAL_ROW_HEIGHT);
  if(Math.abs(newStart-startIndex) > 3){
    startIndex = Math.max(0,Math.min(total,newStart));
    render();
  }
}
container.addEventListener('scroll',onScroll);
render();
}

/* ------------------ é…ç½®æ“ä½œ ------------------- */
document.getElementById('btnAll').addEventListener('click',()=>{
document.querySelectorAll('#fieldGrid input[type=checkbox]').forEach(cb=>cb.checked=true);
});
document.getElementById('btnNone').addEventListener('click',()=>{
document.querySelectorAll('#fieldGrid input[type=checkbox]').forEach(cb=>cb.checked=false);
});
document.getElementById('btnInvert').addEventListener('click',()=>{
document.querySelectorAll('#fieldGrid input[type=checkbox]').forEach(cb=>cb.checked=!cb.checked);
});
document.getElementById('btnBack').addEventListener('click',()=>{
document.getElementById('panel-upload').scrollIntoView({behavior:'smooth'});
});

document.querySelectorAll('[data-preview-refresh]').forEach(btn=>{
btn.addEventListener('click',()=>{
  const idx = parseInt(btn.getAttribute('data-preview-refresh'),10);
  if(!selectedSheet[idx]) return;
  const taskId = ++currentTaskId;
  worker.postMessage({cmd:'refreshPreviewSheet',taskId,fileId:'f'+idx,sheetName:selectedSheet[idx]});
  log('uploadLog','é‡æ–°æ¸…æ´—è¯·æ±‚ file '+idx+' sheet '+selectedSheet[idx]);
});
});

/* ------------------ å¼€å§‹åŒ¹é… ------------------- */
document.getElementById('btnStartMatch').addEventListener('click',()=>{
const k1 = parseInt(document.getElementById('key1').value,10);
const k2 = parseInt(document.getElementById('key2').value,10);
const mode = document.getElementById('matchMode').value;
const unmatchedFill = document.getElementById('unmatchedFill').value;
const fields = [];
document.querySelectorAll('#fieldGrid input[type=checkbox]:checked').forEach(cb=>fields.push(parseInt(cb.value,10)));
if(fields.length===0){alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¿½åŠ å­—æ®µ');return;}
if(!selectedSheet[1] || !selectedSheet[2]){alert('è¯·å…ˆé€‰æ‹©ä¸¤ä¸ªå·¥ä½œè¡¨');return;}
document.getElementById('btnStartMatch').disabled = true;
document.getElementById('btnCancelTask').classList.remove('hidden');
log('matchLog','å¼€å§‹åŒ¹é…...');
setHidden('matchLog',false);
setHidden('panel-result',false);
buildVirtualTable('resultPreview',[['å¤„ç†ä¸­...']]);
updateProgress(0,0,0,0);
const taskId = ++currentTaskId;
worker.postMessage({
  cmd:'startMatch',
  taskId,
  file1:'f1',
  file2:'f2',
  sheet1:selectedSheet[1],
  sheet2:selectedSheet[2],
  key1:k1,
  key2:k2,
  mode,
  fields,
  unmatchedFill
});
});

document.getElementById('btnCancelTask').addEventListener('click',()=>{
const taskId = ++currentTaskId;
worker.postMessage({cmd:'cancel',taskId});
});

function updateProgress(pct,done,total,matched,finished){
document.getElementById('progressFill').style.width = pct+'%';
document.getElementById('progressText').textContent = pct+'%';
document.getElementById('progressDetail').textContent = finished
  ? 'åŒ¹é…å®Œæˆ è¡Œ:'+total+' æˆåŠŸ:'+matched
  : 'å¤„ç†ä¸­... å·²å¤„ç† '+done+'/'+total+' è¡Œ åŒ¹é…:'+matched;
}

function showMatchStats(d){
document.getElementById('statTotal').textContent = d.total;
document.getElementById('statMatched').textContent = d.matched;
document.getElementById('statUnmatched').textContent = d.unmatched;
document.getElementById('statRate').textContent = (d.rate*100).toFixed(2)+'%';
}

/* ------------------ ä¸‹è½½å¯¼å‡º ------------------- */
document.getElementById('btnDownload').addEventListener('click',()=>{
if(!exportedBlobInfo){alert('å°šæ— ç»“æœ');return;}
saveBlob(exportedBlobInfo.blob,exportedBlobInfo.filename);
});
document.getElementById('btnDownloadUnmatched').addEventListener('click',()=>{
if(!exportedBlobInfo || !exportedBlobInfo.unmatchedBlob){
  alert('æ²¡æœ‰æœªåŒ¹é…è¡Œæˆ–æœªç”Ÿæˆ');return;
}
saveBlob(exportedBlobInfo.unmatchedBlob,exportedBlobInfo.unmatchedFilename);
});
function saveBlob(blob,filename){
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href=url; a.download=filename;
document.body.appendChild(a);
a.click();
setTimeout(()=>{URL.revokeObjectURL(url);a.remove();},500);
}

/* ------------------ é‡ç½® ------------------- */
document.getElementById('btnResetAll').addEventListener('click',resetAll);
function resetAll(){
fileBuffers={1:null,2:null};
selectedSheet={1:null,2:null};
previewMeta={1:null,2:null};
headers={1:[],2:[]};
exportedBlobInfo=null;
document.getElementById('file1').value='';
document.getElementById('file2').value='';
['sheetArea1','sheetArea2','previewWrap1','previewWrap2','panel-config','panel-result','bigFileTips'].forEach(id=>setHidden(id,true));
document.getElementById('uploadLog').textContent='';
document.getElementById('matchLog').textContent='';
document.getElementById('resultLog').textContent='';
document.getElementById('u1-info').textContent='ç‚¹å‡»é€‰æ‹© (.xlsx/.xls/.csv)';
document.getElementById('u2-info').textContent='ç‚¹å‡»é€‰æ‹© (.xlsx/.xls/.csv)';
document.getElementById('u1').classList.remove('active');
document.getElementById('u2').classList.remove('active');
log('uploadLog','å·²é‡ç½®ã€‚');
window.scrollTo({top:0,behavior:'smooth'});
}

/* ------------------ å…¶ä»– ------------------- */
window.addEventListener('error',e=>{
log('uploadLog','é¡µé¢é”™è¯¯: '+e.message);
});
</script>
</body>
</html>