<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>æ•°æ®è¡¨æ ¼AIåˆ†æåŠ©æ‰‹ - å…¨æ–°å¢å¼ºUI</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <meta name="color-scheme" content="light dark">
  <style>
    :root {
      --brand: #6366f1;
      --brand-accent: #8b5cf6;
      --gradient: linear-gradient(135deg,#6366f1 0%,#8b5cf6 100%);
      --bg: #f5f7fb;
      --bg-alt: #ffffff;
      --bg-soft: #f1f5f9;
      --bg-hover: #f8fafc;
      --border: #e2e8f0;
      --border-strong: #cbd5e1;
      --text: #1e293b;
      --text-soft: #64748b;
      --radius-sm: 6px;
      --radius: 12px;
      --radius-lg: 18px;
      --shadow-sm: 0 2px 4px -1px rgba(0,0,0,0.05),0 1px 3px -1px rgba(0,0,0,0.05);
      --shadow: 0 4px 16px -2px rgba(15,23,42,0.12);
      --shadow-focus: 0 0 0 3px rgba(99,102,241,0.35);
      --danger: #ef4444;
      --success: #10b981;
      --warn: #f59e0b;
      --info: #0ea5e9;
      --code: #0f172a;
      --font-stack: "Segoe UI","SF Pro Display","Helvetica Neue",Arial,"PingFang SC","Microsoft YaHei",sans-serif;
      --transition: .25s cubic-bezier(.4,0,.2,1);
    }
    body.dark {
      --bg: #0f172a;
      --bg-alt: #182233;
      --bg-soft: #1e293b;
      --bg-hover: #24324a;
      --border: #253447;
      --border-strong: #2f4157;
      --text: #f1f5f9;
      --text-soft: #94a3b8;
      --shadow: 0 4px 16px -2px rgba(0,0,0,0.6);
      --code: #e2e8f0;
    }
    * { box-sizing: border-box; }
    html,body { margin:0; padding:0; height:100%; }
    body {
      font-family: var(--font-stack);
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      line-height: 1.5;
    }
    /* å…¨å±€å¸ƒå±€ */
    .app-shell {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      gap: 14px;
      padding: clamp(12px,1.8vw,28px);
      transition: background var(--transition),color var(--transition);
    }
    .app-header {
      background: var(--gradient);
      color: #fff;
      border-radius: var(--radius-lg);
      padding: clamp(18px,2.2vw,34px) clamp(20px,2.4vw,42px);
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 14px;
      isolation: isolate;
    }
    .app-header:before,
    .app-header:after {
      content:"";
      position:absolute;
      width:480px;
      height:480px;
      background: radial-gradient(circle at center,rgba(255,255,255,0.25),transparent 70%);
      top:-220px;
      right:-160px;
      filter: blur(8px);
      opacity:.6;
      animation: float 18s linear infinite;
    }
    .app-header:after {
      top:auto;
      bottom:-240px;
      right:auto;
      left:-180px;
      animation-duration: 26s;
      animation-direction: reverse;
    }
    @keyframes float {
      0% { transform: rotate(0deg) scale(1); }
      50% { transform: rotate(180deg) scale(1.05); }
      100% { transform: rotate(360deg) scale(1); }
    }
    .top-toolbar {
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
    }
    .brand-title {
      font-size: clamp(1.6rem,2.4vw,2.6rem);
      font-weight: 700;
      letter-spacing: .5px;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .brand-title span.badge {
      font-size:.65em;
      background: rgba(255,255,255,0.18);
      padding:4px 10px;
      border-radius: 999px;
      font-weight:500;
      backdrop-filter: blur(4px);
    }
    .header-sub {
      font-size: clamp(.85rem,1.05vw,1.05rem);
      opacity: .92;
      font-weight: 500;
      display:flex;
      flex-wrap:wrap;
      gap:14px;
      align-items:center;
    }
    .header-sub .pill {
      background: rgba(255,255,255,0.18);
      padding:6px 14px;
      border-radius: 999px;
      font-size: .75em;
      letter-spacing:.5px;
    }
    /* ä¸»ä½“åŒºåŸŸ */
    .layout {
      display: grid;
      grid-template-columns: minmax(380px, 520px) 1fr 400px;
      gap: 18px;
      flex: 1;
      min-height: 0;
    }
    /* é¢æ¿é€šç”¨ */
    .panel {
      background: var(--bg-alt);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      display: flex;
      flex-direction: column;
      min-height: 0;
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      transition: background var(--transition),border-color var(--transition),box-shadow var(--transition);
    }
    body.dark .panel { box-shadow: none; }
    .panel-header {
      padding: 16px 20px 10px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap:12px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(to bottom, var(--bg-soft), transparent);
    }
    .panel-title {
      font-size: .95rem;
      font-weight: 600;
      letter-spacing:.5px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .panel-title i {
      width:24px;
      height:24px;
      display:grid;
      place-items:center;
      background: var(--gradient);
      color:#fff;
      font-style:normal;
      font-size:.9rem;
      border-radius: 8px;
      box-shadow: 0 4px 10px -2px rgba(99,102,241,0.4);
    }
    .panel-body {
      padding: 16px 20px 22px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--brand) transparent;
    }
    .panel-body::-webkit-scrollbar {
      width: 10px;
    }
    .panel-body::-webkit-scrollbar-track {
      background: transparent;
    }
    .panel-body::-webkit-scrollbar-thumb {
      background: linear-gradient(var(--brand),var(--brand-accent));
      border-radius: 20px;
      border: 3px solid var(--bg-alt);
    }
    /* ä¸Šä¼ åŒºåŸŸ */
    .upload-area {
      border: 2px dashed var(--border-strong);
      border-radius: var(--radius);
      padding: 38px 26px;
      text-align: center;
      cursor: pointer;
      background: linear-gradient(145deg,var(--bg-soft),var(--bg-alt));
      position: relative;
      transition: var(--transition);
    }
    .upload-area:hover {
      border-color: var(--brand);
      background: linear-gradient(145deg,var(--bg-alt),var(--bg-soft));
      box-shadow: var(--shadow-sm);
    }
    .upload-area.dragover {
      border-color: var(--brand-accent);
      background: linear-gradient(135deg,rgba(99,102,241,0.1),rgba(139,92,246,0.15));
    }
    .upload-icon {
      width:60px;height:60px;
      margin:0 auto 14px;
      background: radial-gradient(circle at 30% 30%,var(--brand) 0%,var(--brand-accent) 70%);
      border-radius: 22px;
      display:grid;
      place-items:center;
      font-size: 30px;
      color:#fff;
      box-shadow: 0 10px 25px -4px rgba(99,102,241,0.55);
      position: relative;
      overflow:hidden;
    }
    .upload-icon:after {
      content:"";
      position:absolute;
      inset:0;
      background:
        linear-gradient(120deg,rgba(255,255,255,0) 0%,rgba(255,255,255,.55) 45%,rgba(255,255,255,0) 60%);
      transform: translateX(-100%) rotate(10deg);
      animation: shine 4s infinite;
    }
    @keyframes shine {
      0% { transform: translateX(-100%) rotate(10deg); }
      60% { transform: translateX(120%) rotate(10deg); }
      100% { transform: translateX(120%) rotate(10deg); }
    }
    .upload-area p {
      margin:4px 0;
      font-size:.85rem;
    }
    .upload-area p.hint {
      color: var(--text-soft);
      font-size: .75rem;
      letter-spacing:.5px;
    }
    /* æŒ‰é’® */
    .btn-row {
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      margin-bottom: 14px;
    }
    button.btn {
      --btn-bg: var(--gradient);
      --btn-color: #fff;
      border:none;
      outline:none;
      font: 500 .75rem/1 var(--font-stack);
      letter-spacing:.5px;
      padding: 10px 16px;
      border-radius: 10px;
      background: var(--btn-bg);
      color: var(--btn-color);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      position:relative;
      overflow:hidden;
      transition: var(--transition);
      box-shadow: 0 4px 10px -3px rgba(99,102,241,0.5);
    }
    button.btn:before {
      content:"";
      position:absolute;
      inset:0;
      background:linear-gradient(135deg,rgba(255,255,255,.2),rgba(255,255,255,0));
      opacity:0;
      transition: var(--transition);
    }
    button.btn:hover:before { opacity:1; }
    button.btn:hover { transform: translateY(-2px); }
    button.btn:active { transform: translateY(0); }
    button.btn.secondary {
      --btn-bg: linear-gradient(135deg,#64748b,#475569);
      box-shadow: 0 4px 10px -3px rgba(71,85,105,0.5);
    }
    button.btn.outline {
      --btn-bg: var(--bg-alt);
      --btn-color: var(--text);
      border:1px solid var(--border-strong);
      box-shadow:none;
    }
    button.btn.outline:hover {
      background: var(--bg-hover);
    }
    button.btn.danger {
      --btn-bg: linear-gradient(135deg,#ef4444,#dc2626);
      box-shadow:0 4px 10px -3px rgba(239,68,68,0.5);
    }
    button.icon-btn {
      padding:8px 10px;
      min-width:40px;
      justify-content:center;
      font-size:.8rem;
    }
    /* æ–°å¢ï¼šoutline æ¿€æ´»æ€ */
    button.btn.outline.active {
      background: linear-gradient(135deg,var(--brand),var(--brand-accent));
      color:#fff;
      border-color: var(--brand);
      box-shadow: 0 4px 12px -4px rgba(99,102,241,0.6);
    }
    button.btn.outline.active:before { opacity:.25; }
    /* è¾“å…¥æ§ä»¶ */
    .form-grid {
      display:grid;
      gap: 14px;
    }
    .config-group {
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .config-group label {
      font-size:.7rem;
      text-transform: uppercase;
      letter-spacing:.9px;
      color: var(--text-soft);
      font-weight:600;
    }
    .config-group input,
    .config-group select {
      background: var(--bg-soft);
      border:1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      font-size:.8rem;
      transition: var(--transition);
      color: var(--text);
    }
    .config-group input:focus,
    .config-group select:focus {
      outline:none;
      border-color: var(--brand);
      box-shadow: var(--shadow-focus);
      background: var(--bg-alt);
    }
    /* çŠ¶æ€æ¡ */
    .status {
      margin-top: 10px;
      padding: 10px 14px;
      border-radius: 10px;
      font-size: .72rem;
      letter-spacing:.5px;
      font-weight:500;
      display:flex;
      align-items:center;
      gap:8px;
      border:1px solid transparent;
      background: var(--bg-soft);
    }
    .status.success { background: rgba(16,185,129,.12); color:#059669; border-color: rgba(16,185,129,.3); }
    .status.error { background: rgba(239,68,68,.15); color:#dc2626; border-color: rgba(239,68,68,.35); }
    .status.info { background: rgba(14,165,233,.15); color:#0284c7; border-color: rgba(14,165,233,.35); }
    .status.warning { background: rgba(245,158,11,.15); color:#b45309; border-color: rgba(245,158,11,.4); }
    .loading {
      width:18px;height:18px;
      border:3px solid rgba(255,255,255,.4);
      border-top-color:#fff;
      border-radius:50%;
      animation: spin .85s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg);} }
    /* æ•°æ®ç»Ÿè®¡å¡ç‰‡å¢å¼º */
    .stats-grid {
      display:grid;
      gap:14px;
      grid-template-columns:repeat(auto-fill,minmax(130px,1fr));
      margin-top:4px;
    }
    .stat-card {
      position:relative;
      border:1px solid var(--border);
      background: linear-gradient(145deg,var(--bg-soft),var(--bg-alt));
      padding:14px 14px 12px;
      border-radius: 14px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      gap:6px;
      transition: var(--transition);
    }
    .stat-card:hover {
      border-color: var(--brand);
      box-shadow: var(--shadow-sm);
      transform: translateY(-3px);
    }
    .stat-card .label {
      font-size: .65rem;
      letter-spacing:.8px;
      font-weight:600;
      color: var(--text-soft);
      text-transform: uppercase;
    }
    .stat-card .value {
      font-size: 1.65rem;
      font-weight: 700;
      background: linear-gradient(90deg,var(--brand),var(--brand-accent));
      -webkit-background-clip: text;
      color: transparent;
      letter-spacing: .5px;
    }
    .progress-bar {
      height:6px;
      border-radius:4px;
      background: var(--bg-soft);
      overflow:hidden;
      position: relative;
    }
    .progress-bar span {
      position:absolute;
      inset:0;
      width:0;
      background: linear-gradient(90deg,var(--brand),var(--brand-accent));
      animation: grow 1.4s ease forwards;
      box-shadow: 0 0 0 1px rgba(255,255,255,.3) inset;
    }
    @keyframes grow { to { width: var(--w); } }
    /* ç­–ç•¥æ¡ */
    .strategy-box {
      margin-top:18px;
      border:1px solid var(--border-strong);
      border-radius: 14px;
      padding: 18px 20px;
      background: linear-gradient(130deg,rgba(99,102,241,0.12),rgba(139,92,246,0.12));
      position:relative;
      overflow:hidden;
    }
    .strategy-box:before {
      content:"";
      position:absolute;
      width:220px;height:220px;
      border-radius:50%;
      background: radial-gradient(circle at center,rgba(99,102,241,0.5),transparent 70%);
      top:-120px;right:-90px;
      filter: blur(12px);
      opacity:.35;
    }
    .strategy-title {
      font-weight:600;
      font-size:.85rem;
      letter-spacing:.6px;
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:8px;
    }
    .strategy-title i {
      width:26px;height:26px;
      border-radius: 9px;
      display:grid;
      place-items:center;
      background: var(--gradient);
      color:#fff;
      font-style:normal;
      font-size:.85rem;
      box-shadow: 0 6px 16px -4px rgba(99,102,241,0.5);
    }
    .strategy-text {
      font-size:.75rem;
      color: var(--text);
      line-height:1.55;
      text-wrap: pretty;
    }
    /* è¡¨æ ¼é¢„è§ˆ */
    .preview-toolbar {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-bottom:12px;
    }
    .table-shell {
      border:1px solid var(--border);
      border-radius: 14px;
      overflow:hidden;
      background: var(--bg-alt);
      position:relative;
    }
    .table-scroll {
      max-height: 400px;
      overflow:auto;
      scrollbar-width: thin;
      scrollbar-color: var(--brand) transparent;
    }
    .table-scroll::-webkit-scrollbar {
      width:10px;
      height:10px;
    }
    .table-scroll::-webkit-scrollbar-thumb {
      background: linear-gradient(var(--brand),var(--brand-accent));
      border-radius:10px;
      border:2px solid var(--bg-alt);
    }
    table {
      width:100%;
      border-collapse: collapse;
      font-size:.72rem;
      table-layout: fixed;
    }
    thead th {
      position:sticky; top:0; z-index:10;
      background: linear-gradient(90deg,var(--bg-soft),var(--bg-alt));
      backdrop-filter: blur(4px);
      font-weight:600;
      text-align:left;
      padding:10px 10px;
      border-bottom: 1px solid var(--border-strong);
      letter-spacing:.4px;
    }
    tbody td {
      padding:8px 10px;
      border-bottom:1px solid var(--border);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    tbody tr:nth-child(even) {
      background: var(--bg-soft);
    }
    tbody tr:hover {
      background: var(--brand);
      color:#fff;
    }
    .table-footer {
      padding:10px 12px;
      font-size:.65rem;
      color: var(--text-soft);
      background: var(--bg-soft);
      border-top:1px solid var(--border);
      text-align:center;
    }
    /* åˆ†éš”çº¿/æ‹–æ‹½æ¡ (ä¸­é—´å¯è°ƒ) */
    .resizer {
      width:10px;
      cursor: col-resize;
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .resizer:after {
      content:"";
      width:3px;
      height:60%;
      border-radius:4px;
      background: linear-gradient(var(--brand),var(--brand-accent));
      opacity:.5;
      transition: var(--transition);
    }
    .resizer:hover:after,
    .resizer.active:after {
      opacity:1;
      box-shadow: 0 0 0 4px rgba(99,102,241,0.2);
    }
    /* Chat */
    .chat-root {
      display:flex;
      flex-direction:column;
      gap:16px;
      height:100%;
      min-height:0;
    }
    .chat-history {
      flex:1;
      min-height:0;
      overflow-y:auto;
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 18px 18px 10px;
      background: linear-gradient(160deg,var(--bg-soft),var(--bg-alt));
      display:flex;
      flex-direction:column;
      gap:14px;
      position:relative;
    }
    .chat-history::-webkit-scrollbar {
      width:10px;
    }
    .chat-history::-webkit-scrollbar-thumb {
      background: linear-gradient(var(--brand),var(--brand-accent));
      border-radius:10px;
      border:2px solid var(--bg-alt);
    }
    .msg {
      max-width: 88%;
      padding: 12px 15px 14px;
      border-radius: 14px;
      font-size:.78rem;
      line-height:1.55;
      position:relative;
      display:flex;
      flex-direction:column;
      gap:6px;
      animation: fadeIn .4s ease;
    }
    @keyframes fadeIn {
      from { opacity:0; transform: translateY(6px); }
      to { opacity:1; transform: translateY(0); }
    }
    .msg.user {
      margin-left:auto;
      background: linear-gradient(135deg,var(--brand),var(--brand-accent));
      color:#fff;
      box-shadow: 0 4px 14px -4px rgba(99,102,241,0.7);
      border-bottom-right-radius: 4px;
    }
    .msg.ai {
      background: var(--bg-alt);
      border:1px solid var(--border);
      border-bottom-left-radius:4px;
    }
    body.dark .msg.ai {
      background: #1e293b;
    }
    .msg.system {
      align-self:center;
      background: linear-gradient(135deg,#fef08a,#fde047);
      color:#854d0e;
      border:1px solid #fcd34d;
      font-style:italic;
      font-weight:500;
      max-width:100%;
    }
    .msg .tools {
      display:flex;
      gap:6px;
      opacity:0;
      transition: var(--transition);
    }
    .msg:hover .tools { opacity:1; }
    .mini-btn {
      border:none;
      background: var(--bg-soft);
      color: var(--text-soft);
      border-radius: 6px;
      font-size:.6rem;
      padding:4px 8px;
      cursor:pointer;
      letter-spacing:.5px;
      font-weight:500;
    }
    .mini-btn:hover {
      background: var(--brand);
      color:#fff;
    }
    .markdown p { margin:0 0 6px; }
    .markdown code {
      font-family: ui-monospace,Menlo,Consolas,monospace;
      background: #0f172a10;
      padding:2px 6px;
      border-radius:6px;
      font-size:.68rem;
    }
    body.dark .markdown code {
      background:#1e293b;
      color:#e2e8f0;
    }
    .chat-input-row {
      display:flex;
      align-items:flex-end;
      gap:10px;
    }
    .chat-textarea-wrap {
      flex:1;
      position:relative;
    }
    textarea.chat-input {
      width:100%;
      resize:none;
      border:1px solid var(--border);
      background: var(--bg-alt);
      min-height:80px;
      padding: 14px 16px 42px 14px;
      border-radius: 16px;
      font: 500 .8rem/1.55 var(--font-stack);
      letter-spacing:.3px;
      color: var(--text);
      transition: var(--transition);
    }
    textarea.chat-input:focus {
      outline:none;
      border-color: var(--brand);
      box-shadow: var(--shadow-focus);
    }
    .char-counter {
      position:absolute;
      bottom:8px;
      right:12px;
      font-size:.55rem;
      color: var(--text-soft);
      letter-spacing:.5px;
    }
    .chat-actions {
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    /* ä¸»é¢˜åˆ‡æ¢ */
    .theme-toggle {
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 14px;
      background: rgba(255,255,255,.16);
      color:#fff;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.3);
      font-size:.7rem;
      font-weight:600;
      letter-spacing:.5px;
      cursor:pointer;
      backdrop-filter: blur(8px);
      transition: var(--transition);
    }
    .theme-toggle:hover {
      background: rgba(255,255,255,.24);
    }
    body.dark .theme-toggle {
      background: rgba(255,255,255,.08);
      border-color: rgba(255,255,255,.15);
    }
    /* å“åº”å¼ */
    @media (max-width:1400px) {
      .layout {
        grid-template-columns: minmax(360px,480px) 1fr 380px;
      }
    }
    @media (max-width:1180px) {
      .layout {
        grid-template-columns: minmax(340px,440px) 1fr;
      }
      .panel.chat-panel {
        order:3;
        grid-column: 1 / -1;
        min-height:480px;
      }
    }
    @media (max-width:860px) {
      .layout {
        grid-template-columns: 1fr;
      }
      .resizer { display:none; }
      .panel {
        min-height:auto;
      }
      .app-header {
        padding:28px 22px;
      }
      .chat-history { max-height:380px; }
    }
    @media (max-width:520px) {
      .header-sub { flex-direction:column; align-items:flex-start; }
      .brand-title { font-size:1.85rem; }
      button.btn { padding:9px 13px; font-size:.68rem; }
      .upload-area { padding:32px 20px; }
    }
    /* è½»å¾®åŠ¨æ•ˆ */
    .fade-in {
      animation: fade .6s ease;
    }
    @keyframes fade {
      from { opacity:0; transform: translateY(10px); }
      to { opacity:1; transform: translateY(0); }
    }
    /* éšè—æ–‡ä»¶è¾“å…¥ */
    input[type=file] { display:none; }
    /* ä»£ç é€‰æ‹©é«˜äº® */
    ::selection {
      background: var(--brand);
      color:#fff;
    }
    /* æ— æ•°æ®å ä½ */
    .placeholder {
      padding:46px 20px;
      text-align:center;
      font-size:.8rem;
      color: var(--text-soft);
    }
    /* æ–°å¢ï¼šå…¨é‡ä¸Šä¸‹æ–‡æç¤ºå¾½ç«  */
    .full-context-badge {
      display:inline-flex;
      align-items:center;
      gap:6px;
      background: linear-gradient(135deg,#dc2626,#ef4444);
      color:#fff;
      padding:6px 10px;
      border-radius:8px;
      font-size:.6rem;
      font-weight:600;
      letter-spacing:.5px;
      margin-left:8px;
      box-shadow:0 4px 10px -3px rgba(239,68,68,0.5);
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- é¡¶éƒ¨å¤´éƒ¨ -->
    <header class="app-header">
      <div class="top-toolbar">
        <div>
          <div class="brand-title">
            ğŸ“Š æ•°æ®è¡¨æ ¼AIåˆ†æåŠ©æ‰‹
            <span class="badge">Enhanced</span>
          </div>
          <div class="header-sub">
            <span class="pill">æ™ºèƒ½æ•°æ®é‡‡æ ·</span>
            <span class="pill">ç»“æ„åŒ–ä¸Šä¸‹æ–‡</span>
            <span class="pill">æ·±åº¦æ´å¯Ÿ</span>
            <span id="fullContextBadge" style="display:none;" class="full-context-badge" title="å½“å‰å¯¹è¯å°†å‘é€å…¨éƒ¨æ•°æ®è¡Œï¼Œå¯èƒ½æ¶ˆè€—å¤§é‡ Token">âš  å…¨é‡ä¸Šä¸‹æ–‡å·²å¼€å¯</span>
          </div>
        </div>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <button id="themeToggle" class="theme-toggle" type="button" aria-label="åˆ‡æ¢ä¸»é¢˜">
            <span id="themeIcon">ğŸŒ™</span>
            <span id="themeLabel">æ·±è‰²æ¨¡å¼</span>
          </button>
          <button class="btn outline icon-btn" id="clearChatBtn" title="æ¸…ç©ºå¯¹è¯">
            ğŸ§¹ æ¸…ç©º
          </button>
        </div>
      </div>
    </header>

    <!-- ä¸»ä½“å¸ƒå±€ -->
    <div class="layout" id="layoutRoot">
      <!-- å·¦ä¾§ï¼šä¸Šä¼  + æ•°æ®æ¦‚è§ˆ + é¢„è§ˆ -->
      <div class="panel" id="leftPanel">
        <div class="panel-header">
          <div class="panel-title">
            <i>ğŸ“‚</i> ä¸Šä¼ ä¸æ•°æ®æ¦‚è§ˆ
          </div>
        </div>
        <div class="panel-body">
          <!-- ä¸Šä¼  -->
          <div class="upload-area" id="uploadArea" tabindex="0" role="button" aria-label="ä¸Šä¼ æ•°æ®æ–‡ä»¶">
            <div class="upload-icon">ğŸ“„</div>
            <p><strong>ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</strong></p>
            <p class="hint">æ”¯æŒ CSV, XLSX, XLS</p>
            <input type="file" id="fileInput" accept=".csv,.xlsx,.xls">
          </div>
          <div id="fileStatus" class="fade-in"></div>

          <!-- ç»Ÿè®¡ -->
          <div style="margin-top:28px;">
            <h3 style="font-size:.85rem;letter-spacing:.8px;font-weight:700;color:var(--text-soft);text-transform:uppercase;display:flex;align-items:center;gap:8px;margin:0 0 10px;">
              <span style="background:var(--gradient);color:#fff;width:28px;height:28px;display:grid;place-items:center;border-radius:8px;font-size:.8rem;box-shadow:0 5px 14px -4px rgba(99,102,241,0.6)">ğŸ“ˆ</span>
              æ•°æ®æ¦‚è§ˆ
            </h3>
            <div id="dataStats"></div>
            <div id="dataStrategy"></div>
          </div>

          <!-- é¢„è§ˆ -->
          <div style="margin-top:32px;">
            <h3 style="font-size:.85rem;letter-spacing:.8px;font-weight:700;color:var(--text-soft);text-transform:uppercase;display:flex;align-items:center;gap:8px;margin:0 0 10px;">
              <span style="background:var(--gradient);color:#fff;width:28px;height:28px;display:grid;place-items:center;border-radius:8px;font-size:.8rem;box-shadow:0 5px 14px -4px rgba(99,102,241,0.6)">ğŸ‘€</span>
              æ•°æ®é¢„è§ˆ
            </h3>
            <div class="preview-toolbar">
              <button class="btn outline" onclick="showDataSample('head')">å‰10è¡Œ</button>
              <button class="btn outline" onclick="showDataSample('tail')">å10è¡Œ</button>
              <button class="btn outline" onclick="showDataSample('random')">éšæœº10è¡Œ</button>
              <button class="btn outline" onclick="showDataSample('full')">å®Œæ•´é¢„è§ˆ</button>
              <button class="btn outline" onclick="downloadSample()" title="å¯¼å‡ºå½“å‰é¢„è§ˆ">å¯¼å‡ºé¢„è§ˆ</button>
            </div>
            <div id="tablePreview" class="table-shell fade-in">
              <div class="placeholder">è¯·å…ˆä¸Šä¼ æ•°æ®æ–‡ä»¶</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ä¸­é—´ï¼šé…ç½® -->
      <div class="panel" id="centerPanel">
        <div class="panel-header">
          <div class="panel-title">
            <i>ğŸ› </i> AI API é…ç½®
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button class="btn outline icon-btn" onclick="testConnection()">ğŸ” æµ‹è¯•</button>
            <button class="btn outline icon-btn" onclick="saveConfig()">ğŸ’¾ ä¿å­˜</button>
            <!-- æ–°å¢ï¼šå…¨é‡ä¸Šä¸‹æ–‡åˆ‡æ¢æŒ‰é’® -->
            <button id="fullDataToggle" class="btn outline icon-btn" type="button" title="å¯ç”¨åå°†æŠŠå…¨éƒ¨æ•°æ®è¡Œä¼ ç»™ AIï¼ˆå¯èƒ½éå¸¸è€—è´¹ Tokenï¼‰">ğŸ“¤ å…¨é‡</button>
          </div>
        </div>
        <div class="panel-body">
          <div class="form-grid">
            <div class="config-group">
              <label for="baseUrl">Base URL</label>
              <input id="baseUrl" placeholder="https://api.openai.com/v1" value="https://api.openai.com/v1">
            </div>
            <div class="config-group">
              <label for="apiKey">API Key</label>
              <input id="apiKey" type="password" placeholder="sk-...">
            </div>
            <div class="config-group">
              <label for="modelId">æ¨¡å‹ ID</label>
              <input id="modelId" value="gpt-3.5-turbo">
            </div>
            <div class="config-group">
              <label for="dataStrategySelect">æ•°æ®ä¼ è¾“ç­–ç•¥</label>
              <select id="dataStrategySelect">
                <option value="smart">æ™ºèƒ½é‡‡æ · (æ¨è)</option>
                <option value="full">å®Œæ•´æ•°æ® (å°æ–‡ä»¶)</option>
                <option value="summary">ç»Ÿè®¡æ‘˜è¦</option>
                <option value="structured">ç»“æ„åŒ–é‡‡æ ·</option>
              </select>
            </div>
          </div>
          <div id="connectionStatus"></div>
          <div style="margin-top:30px;">
            <h4 style="font-size:.7rem;letter-spacing:.8px;text-transform:uppercase;color:var(--text-soft);margin:0 0 12px;font-weight:700;">åˆ—ç‰¹å¾åˆ†æ</h4>
            <div id="columnProfiles" style="display:grid;gap:10px;"></div>
          </div>
        </div>
      </div>

      <!-- æ‹–æ‹½åˆ†éš”æ¡ï¼ˆä¸­é—´å¯è°ƒå®½ï¼‰ -->
      <div class="resizer" id="resizer" aria-label="æ‹–æ‹½è°ƒæ•´é¢æ¿å®½åº¦"></div>

      <!-- å³ä¾§ï¼šå¯¹è¯ -->
      <div class="panel chat-panel" id="chatPanel">
        <div class="panel-header">
          <div class="panel-title">
            <i>ğŸ’¬</i> AI å¯¹è¯
          </div>
          <div style="display:flex;gap:8px;">
            <button class="btn outline icon-btn" onclick="toggleWrap()" id="wrapBtn" title="åˆ‡æ¢æ¢è¡Œ">â†©ï¸ æ¢è¡Œ</button>
            <button class="btn outline icon-btn" onclick="scrollChatBottom()" title="æ»šåŠ¨åˆ°åº•éƒ¨">â¤“ åº•éƒ¨</button>
          </div>
        </div>
        <div class="panel-body" style="display:flex;flex-direction:column;gap:14px;">
          <div class="chat-root">
            <div class="chat-history" id="chatMessages">
              <div class="msg system">ğŸ‘‹ æ‚¨å¥½ï¼è¯·ä¸Šä¼ æ•°æ®æ–‡ä»¶ï¼Œæˆ‘å°†è¿›è¡Œæ™ºèƒ½åˆ†æã€‚æ”¯æŒå¤šç§é‡‡æ ·ä¸ç»Ÿè®¡ç­–ç•¥ã€‚</div>
            </div>
            <div class="chat-input-row">
              <div class="chat-textarea-wrap">
                <textarea id="chatInput" class="chat-input" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜ï¼ŒShift+Enter æ¢è¡Œ..." rows="3" maxlength="4000"></textarea>
                <div class="char-counter" id="charCounter">0 / 4000</div>
              </div>
              <div class="chat-actions">
                <button class="btn" onclick="sendMessage()">å‘é€ â–¶</button>
                <button class="btn secondary" onclick="stopRequest()" id="stopBtn" disabled>åœæ­¢ â¹</button>
              </div>
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;">
              <button class="btn outline" onclick="quickAsk('è¯·è¿›è¡Œæ•°æ®å­—æ®µå«ä¹‰çŒœæµ‹ä¸æ•´ä½“è´¨é‡è¯„ä¼°ã€‚')">å­—æ®µå«ä¹‰</button>
              <button class="btn outline" onclick="quickAsk('è¯·ç»™å‡ºå…³é”®æ•°å€¼åˆ—çš„ç»Ÿè®¡æ‘˜è¦ã€‚')">åˆ—ç»Ÿè®¡</button>
              <button class="btn outline" onclick="quickAsk('è¯·è¯†åˆ«æ½œåœ¨å¼‚å¸¸å€¼ä¸æ•°æ®è´¨é‡é—®é¢˜ã€‚')">å¼‚å¸¸æ£€æµ‹</button>
              <button class="btn outline" onclick="quickAsk('è¯·ç”Ÿæˆé€‚åˆæ­¤æ•°æ®é›†çš„å¯è§†åŒ–å›¾è¡¨å»ºè®®åˆ—è¡¨ã€‚')">å¯è§†åŒ–å»ºè®®</button>
            </div>
          </div>
        </div>
      </div>
    </div><!-- layout -->
  </div><!-- app-shell -->

  <!-- ä¿®å¤åçš„XLSXåº“å¼•ç”¨ -->
  <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    /**********************
     * å…¨å±€çŠ¶æ€
     **********************/
    let currentData = null;
    let currentFileName = '';
    let dataStats = {};
    let abortController = null;
    let wrapEnabled = true;
    // æ–°å¢ï¼šæ˜¯å¦å¼ºåˆ¶å…¨é‡ä¸Šä¸‹æ–‡
    let forceFullData = false;

    /**********************
     * DOM å¼•ç”¨
     **********************/
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const fileStatus = document.getElementById('fileStatus');
    const dataStatsDiv = document.getElementById('dataStats');
    const dataStrategyDiv = document.getElementById('dataStrategy');
    const tablePreview = document.getElementById('tablePreview');
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const charCounter = document.getElementById('charCounter');
    const dataStrategySelect = document.getElementById('dataStrategySelect');
    const columnProfiles = document.getElementById('columnProfiles');
    const stopBtn = document.getElementById('stopBtn');
    const fullDataToggle = document.getElementById('fullDataToggle');
    const fullContextBadge = document.getElementById('fullContextBadge');

    /**********************
     * ä¸»é¢˜åˆ‡æ¢
     **********************/
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const themeLabel = document.getElementById('themeLabel');

    function applyTheme(theme) {
      if(theme === 'dark') {
        document.body.classList.add('dark');
        themeIcon.textContent = 'ğŸŒ';
        themeLabel.textContent = 'æµ…è‰²æ¨¡å¼';
      } else {
        document.body.classList.remove('dark');
        themeIcon.textContent = 'ğŸŒ™';
        themeLabel.textContent = 'æ·±è‰²æ¨¡å¼';
      }
      localStorage.setItem('app-theme', theme);
    }
    themeToggle.addEventListener('click', () => {
      const isDark = document.body.classList.toggle('dark');
      applyTheme(isDark ? 'dark':'light');
    });
    (function initTheme(){
      const saved = localStorage.getItem('app-theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark':'light');
      applyTheme(saved);
    })();

    /**********************
     * é…ç½®æŒä¹…åŒ–
     **********************/
    function saveConfig() {
      const cfg = {
        baseUrl: document.getElementById('baseUrl').value.trim(),
        apiKey: document.getElementById('apiKey').value.trim(),
        modelId: document.getElementById('modelId').value.trim(),
        strategy: dataStrategySelect.value,
        forceFullData
      };
      localStorage.setItem('ai-config', JSON.stringify(cfg));
      showStatus(fileStatus,'âœ… é…ç½®å·²ä¿å­˜','success');
    }

    function loadConfig() {
      const raw = localStorage.getItem('ai-config');
      if(!raw) return;
      try {
        const cfg = JSON.parse(raw);
        if(cfg.baseUrl) document.getElementById('baseUrl').value = cfg.baseUrl;
        if(cfg.apiKey) document.getElementById('apiKey').value = cfg.apiKey;
          if(cfg.modelId) document.getElementById('modelId').value = cfg.modelId;
        if(cfg.strategy) dataStrategySelect.value = cfg.strategy;
        if(typeof cfg.forceFullData === 'boolean') {
          forceFullData = cfg.forceFullData;
          updateFullDataToggle();
        }
      } catch(e){}
    }
    loadConfig();

    /**********************
     * å…¨é‡ä¸Šä¸‹æ–‡æŒ‰é’®é€»è¾‘
     **********************/
    function updateFullDataToggle() {
      if(forceFullData) {
        fullDataToggle.classList.add('active');
        fullDataToggle.textContent = 'ğŸ“¤ å…¨é‡ ON';
        fullDataToggle.title = 'å·²å¯ç”¨ï¼šå…¨éƒ¨æ•°æ®è¡Œå°†å‘é€ç»™ AI';
        fullContextBadge.style.display = 'inline-flex';
      } else {
        fullDataToggle.classList.remove('active');
          fullDataToggle.textContent = 'ğŸ“¤ å…¨é‡';
        fullDataToggle.title = 'ç‚¹å‡»å¯ç”¨å…¨é‡æ•°æ®ä¸Šä¸‹æ–‡';
        fullContextBadge.style.display = 'none';
      }
    }
    fullDataToggle.addEventListener('click', ()=>{
      if(!currentData) {
        addSystemMessage('âš ï¸ è¯·å…ˆä¸Šä¼ æ•°æ®åå†å¯ç”¨å…¨é‡ä¸Šä¸‹æ–‡');
        return;
      }
      forceFullData = !forceFullData;
      updateFullDataToggle();
      saveConfig();
      if(forceFullData) {
        addSystemMessage(`âš  å·²å¼€å¯å…¨é‡ä¸Šä¸‹æ–‡ï¼šå°†å‘é€å…¨éƒ¨ ${currentData.length-1} è¡Œæ•°æ®ã€‚è¯·æ³¨æ„ Token ä¸è´¹ç”¨æ¶ˆè€—ã€‚`);
      } else {
        addSystemMessage('â„¹ å·²å…³é—­å…¨é‡ä¸Šä¸‹æ–‡ï¼Œæ¢å¤æ‰€é€‰ç­–ç•¥é‡‡æ ·ã€‚');
      }
    });

    /**********************
     * æ–‡ä»¶ä¸Šä¼ ä¸è§£æ
     **********************/
    uploadArea.addEventListener('click',()=> fileInput.click());
    uploadArea.addEventListener('keydown', e => { if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); fileInput.click(); }});
    uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.classList.add('dragover'); });
    uploadArea.addEventListener('dragleave', e => { e.preventDefault(); uploadArea.classList.remove('dragover'); });
    uploadArea.addEventListener('drop', e => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      if(e.dataTransfer.files.length) processFile(e.dataTransfer.files[0]);
    });
    fileInput.addEventListener('change', e => {
      if(e.target.files[0]) processFile(e.target.files[0]);
    });

    function processFile(file) {
      currentFileName = file.name;
      showStatus(fileStatus,`ğŸ“¥ æ­£åœ¨å¤„ç†æ–‡ä»¶: ${file.name}`,'info');
      
      // ç­‰å¾…XLSXåº“åŠ è½½å®Œæˆ
      if (typeof XLSX === 'undefined') {
        showStatus(fileStatus,'â³ æ­£åœ¨åŠ è½½Excelè§£æåº“ï¼Œè¯·ç¨å€™...','info');
        setTimeout(() => processFile(file), 1000);
        return;
      }
      
      const reader = new FileReader();
      if(/\.csv$/i.test(file.name)) {
        reader.onload = e => {
          try {
            const csv = e.target.result;
            const data = parseCSV(csv);
            processData(data);
          } catch(err) {
            showStatus(fileStatus,'âŒ è§£æå¤±è´¥: '+err.message,'error');
          }
        };
        reader.readAsText(file);
      } else if(/\.(xlsx|xls)$/i.test(file.name)) {
        reader.onload = e => {
          try {
            const u8 = new Uint8Array(e.target.result);
            const wb = XLSX.read(u8,{type:'array'});
            const first = wb.SheetNames[0];
            const ws = wb.Sheets[first];
            const json = XLSX.utils.sheet_to_json(ws,{header:1});
            processData(json);
          } catch(err) {
            showStatus(fileStatus,'âŒ è§£æå¤±è´¥: '+err.message,'error');
          }
        };
        reader.readAsArrayBuffer(file);
      } else {
        showStatus(fileStatus,'âŒ ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹','error');
      }
    }

    function parseCSV(str) {
      // ç®€æ˜“ CSV è§£æï¼Œæ”¯æŒåŸºæœ¬çš„é€—å·åˆ†éš”
      const lines = str.split(/\r?\n/).filter(l => l.trim().length);
      const result = [];
      
      for(let line of lines) {
        // ç®€å•çš„CSVè§£æï¼Œå¯ä»¥å¤„ç†åŸºæœ¬æƒ…å†µ
        const row = [];
        let current = '';
        let inQuotes = false;
        
        for(let i = 0; i < line.length; i++) {
          const char = line[i];
          if(char === '"') {
            inQuotes = !inQuotes;
          } else if(char === ',' && !inQuotes) {
            row.push(current.trim());
            current = '';
          } else {
            current += char;
          }
        }
        row.push(current.trim());
        result.push(row);
      }
      return result;
    }

    function processData(data) {
      currentData = data;
      computeStats(data);
      renderStats();
      renderStrategyAdvice();
      renderColumnProfiles();
      showDataSample('head');
      showStatus(fileStatus,`âœ… ä¸Šä¼ æˆåŠŸï¼š${data.length-1} è¡Œï¼Œ${data[0]?data[0].length:0} åˆ—`,'success');
      addSystemMessage(`ğŸ“Š å·²åŠ è½½æ–‡ä»¶ "${currentFileName}"ã€‚è¡Œæ•°: ${data.length-1}ï¼Œåˆ—æ•°: ${data[0]?data[0].length:0}ã€‚æ‚¨å¯ä»¥å¼€å§‹æé—®ã€‚`);
      // è‹¥ä¹‹å‰æœªå¯ç”¨å…¨é‡ï¼Œç¡®ä¿æŒ‰é’®çŠ¶æ€åˆ·æ–°
      updateFullDataToggle();
    }

    /**********************
     * æ•°æ®ç»Ÿè®¡
     **********************/
    function computeStats(data) {
      if(!data || !data.length) return;
      const headers = data[0];
      const rows = data.slice(1);
      dataStats = {
        totalRows: rows.length,
        totalColumns: headers.length,
        headers,
        nonEmptyRows: rows.filter(r => r.some(c=>c!==undefined && c!==null && c!=='')).length,
        columnStats:{}
      };
      headers.forEach((h,i)=>{
        const col = rows.map(r=>r[i]).filter(v=>v!==undefined && v!==null && v!=='');
        const numeric = col.filter(v => !isNaN(parseFloat(v)) && isFinite(v));
        const isNumeric = numeric.length > col.length * 0.7;
        let min,max,avg,median;
          if(isNumeric && numeric.length){
            const nums = numeric.map(Number).sort((a,b)=>a-b);
            min = nums[0];
            max = nums[nums.length-1];
            avg = nums.reduce((a,b)=>a+b,0)/nums.length;
            median = nums.length%2===0 ? (nums[nums.length/2-1]+nums[nums.length/2])/2 : nums[(nums.length-1)/2];
          }
        dataStats.columnStats[h] = {
          nonEmpty: col.length,
          empty: rows.length-col.length,
          unique: new Set(col).size,
          sample: col.slice(0,5),
          isNumeric,
          min,max,avg,median
        };
      });
    }

    function renderStats() {
      if(!dataStats.totalRows) { dataStatsDiv.innerHTML=''; return; }
      const complete = ((dataStats.nonEmptyRows / dataStats.totalRows)*100).toFixed(1);
      const numericCols = Object.values(dataStats.columnStats).filter(c=>c.isNumeric).length;
      const html = `
        <div class="stats-grid">
          ${statCard('æ€»è¡Œæ•°', dataStats.totalRows)}
          ${statCard('æ€»åˆ—æ•°', dataStats.totalColumns)}
          ${statCard('å®Œæ•´åº¦', complete+'%', complete)}
          ${statCard('æ•°å€¼åˆ—', numericCols)}
        </div>
      `;
      dataStatsDiv.innerHTML = html;
    }

    function statCard(label,value,progress) {
      const prog = progress ? `
        <div class="progress-bar" style="--w:${Math.min(100,progress)}%;">
          <span></span>
        </div>` : '';
      return `
        <div class="stat-card">
          <div class="label">${label}</div>
          <div class="value">${value}</div>
          ${prog}
        </div>
      `;
    }

    function renderStrategyAdvice() {
      if(!dataStats.totalRows) { dataStrategyDiv.innerHTML=''; return; }
      let msg;
      if(dataStats.totalRows <= 100) {
        msg = 'æ•°æ®é‡è¾ƒå°ï¼Œå¯ç›´æ¥ä½¿ç”¨ "å®Œæ•´æ•°æ®" ç­–ç•¥ä¼ è¾“å…¨éƒ¨è®°å½•ä»¥è¿›è¡Œç²¾ç¡®åˆ†æã€‚';
      } else if(dataStats.totalRows <= 1000) {
        msg = 'æ•°æ®é‡é€‚ä¸­ï¼Œæ¨èä½¿ç”¨ "æ™ºèƒ½é‡‡æ ·" ç­–ç•¥ï¼ˆå¤´éƒ¨+ä¸­é—´éšæœº+å°¾éƒ¨+åˆ—ç»Ÿè®¡ï¼‰ã€‚';
      } else {
        msg = 'æ•°æ®é‡è¾ƒå¤§ï¼Œå»ºè®®ä½¿ç”¨ "ç»“æ„åŒ–é‡‡æ ·" ä¸ç»Ÿè®¡æ‘˜è¦ç»“åˆï¼Œé™ä½Tokenæ¶ˆè€—ã€‚';
      }
      if(forceFullData) {
        msg = 'å·²å¼ºåˆ¶å¯ç”¨å…¨é‡ä¸Šä¸‹æ–‡ï¼Œå°†ç›´æ¥å‘é€å…¨éƒ¨æ•°æ®è¡Œã€‚è¯·ç¡®è®¤æ¨¡å‹ä¸Šä¸‹æ–‡ä¸è´¹ç”¨å¯æ¥å—ã€‚';
      }
      dataStrategyDiv.innerHTML = `
        <div class="strategy-box fade-in">
          <div class="strategy-title"><i>ğŸ’¡</i> æ¨èåˆ†æç­–ç•¥</div>
          <div class="strategy-text">${msg}</div>
        </div>
      `;
    }

    function renderColumnProfiles() {
      if(!dataStats.totalRows) { columnProfiles.innerHTML=''; return; }
      let html = '';
      Object.entries(dataStats.columnStats).forEach(([name,st])=>{
        const completeness = ((st.nonEmpty / dataStats.totalRows)*100).toFixed(1);
        html += `
          <div style="border:1px solid var(--border);background:var(--bg-alt);border-radius:12px;padding:10px 12px;display:flex;flex-direction:column;gap:6px;font-size:.65rem;">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:6px;">
              <strong style="font-size:.7rem;letter-spacing:.5px;">${name}</strong>
              <span style="padding:4px 8px;border-radius:6px;background:${st.isNumeric?'linear-gradient(135deg,#10b981,#059669)':'linear-gradient(135deg,#6366f1,#8b5cf6)'};color:#fff;font-weight:600;">${st.isNumeric?'æ•°å€¼':'æ–‡æœ¬'}</span>
            </div>
            <div style="display:flex;flex-wrap:wrap;gap:10px;">
              <span>å®Œæ•´: ${completeness}%</span>
              <span>éç©º: ${st.nonEmpty}</span>
              <span>å”¯ä¸€: ${st.unique}</span>
            </div>
            ${st.isNumeric && st.min!==undefined ? `
            <div style="display:flex;flex-wrap:wrap;gap:8px;">
              <span>èŒƒå›´: ${st.min} ~ ${st.max}</span>
              <span>å‡å€¼: ${st.avg.toFixed(2)}</span>
              <span>ä¸­ä½æ•°: ${st.median}</span>
            </div>` : `<div style="color:var(--text-soft);">ç¤ºä¾‹: ${st.sample.slice(0,3).join(', ')}</div>`}
            <div class="progress-bar" style="--w:${Math.min(100,completeness)}%;margin-top:4px;"><span></span></div>
          </div>
        `;
      });
      columnProfiles.innerHTML = html;
    }

    /**********************
     * æ•°æ®é¢„è§ˆ
     **********************/
    function showDataSample(type) {
      if(!currentData) {
        tablePreview.innerHTML = '<div class="placeholder">å°šæœªåŠ è½½æ•°æ®</div>';
        return;
      }
      let sample = [];
      let title = '';
      switch(type) {
        case 'head':
          sample = currentData.slice(0, Math.min(11,currentData.length));
          title = 'å‰10è¡Œ';
          break;
        case 'tail':
          const start = Math.max(1, currentData.length - 10);
          sample = [currentData[0], ...currentData.slice(start)];
          title = 'å10è¡Œ';
          break;
        case 'random':
          const rows = currentData.slice(1);
          const size = Math.min(10, rows.length);
          const idxs = new Set();
          while(idxs.size < size) {
            idxs.add(Math.floor(Math.random()*rows.length));
          }
          sample = [currentData[0], ...Array.from(idxs).sort((a,b)=>a-b).map(i=>rows[i])];
          title = 'éšæœº10è¡Œ';
          break;
        case 'full':
          sample = currentData;
          title = 'å®Œæ•´æ•°æ® (å¯èƒ½æˆªæ–­æ˜¾ç¤º)';
          break;
      }
      renderTable(sample,title);
    }

    function renderTable(data,title) {
      if(!data || !data.length) {
        tablePreview.innerHTML = '<div class="placeholder">æ•°æ®ä¸ºç©º</div>';
        return;
      }
      const maxRows = Math.min(data.length-1,500);
      let thead = '<thead><tr>'+ data[0].map(h=>`<th title="${escapeHtml(h||'')}">${escapeHtml(h||'')}</th>`).join('') + '</tr></thead>';
      let body = '<tbody>';
      for(let i=1;i<=maxRows;i++) {
        const row = data[i] || [];
        body += '<tr>' + data[0].map((_,c)=> `<td title="${escapeHtml(row[c]||'')}">${escapeHtml(row[c]||'')}</td>`).join('') + '</tr>';
      }
      body += '</tbody>';
      tablePreview.innerHTML = `
        <div class="table-shell">
          <div style="padding:10px 12px;font-size:.7rem;font-weight:600;letter-spacing:.6px;background:var(--bg-soft);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;">
            <span>ğŸ“„ ${title}</span>
            <span style="color:var(--text-soft);font-weight:500;">æ˜¾ç¤º ${maxRows} / ${data.length-1} è¡Œ</span>
          </div>
          <div class="table-scroll">
            <table>${thead}${body}</table>
          </div>
          ${data.length-1>500?'<div class="table-footer">å·²æˆªæ–­æ˜¾ç¤ºå‰500è¡Œ</div>':''}
        </div>`;
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, s=>({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      })[s]);
    }

    function downloadSample() {
      const table = tablePreview.querySelector('table');
      if(!table) return;
      let csv = [];
      const rows = table.querySelectorAll('tr');
      rows.forEach(r=>{
        const cells = Array.from(r.children).map(c=>`"${c.textContent.replace(/"/g,'""')}"`);
        csv.push(cells.join(','));
      });
      const blob = new Blob([csv.join('\n')],{type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = (currentFileName.replace(/\.(csv|xlsx?|)$/i,'') || 'data')+'_preview.csv';
      a.click();
    }

    /**********************
     * Chat ç›¸å…³
     **********************/
    function addSystemMessage(msg) {
      const div = document.createElement('div');
      div.className='msg system';
      div.textContent = msg;
      chatMessages.appendChild(div);
      scrollChatBottom();
    }
    function addUserMessage(msg) {
      const div = document.createElement('div');
      div.className='msg user';
      div.textContent = msg;
      chatMessages.appendChild(div);
      scrollChatBottom();
    }
    function addAIMessage(msg) {
      const div = document.createElement('div');
      div.className='msg ai';
      div.innerHTML = `<div class="markdown">${renderMarkdown(msg)}</div>
        <div class="tools">
          <button class="mini-btn" onclick="copyText(this)">å¤åˆ¶</button>
        </div>`;
      chatMessages.appendChild(div);
      scrollChatBottom();
    }
    function addLoadingMessage() {
      const div = document.createElement('div');
      div.className='msg ai';
      div.id='loadingMessage';
      div.innerHTML='<div style="display:flex;align-items:center;gap:10px;"><div class="loading" style="border-color:rgba(99,102,241,.2);border-top-color:var(--brand);"></div><span>AI æ­£åœ¨åˆ†ææ•°æ®...</span></div>';
      chatMessages.appendChild(div);
      scrollChatBottom();
    }
    function removeLoadingMessage() {
      const el = document.getElementById('loadingMessage');
      if(el) el.remove();
    }
    function scrollChatBottom() {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function copyText(btn) {
      const parent = btn.closest('.msg');
      if(!parent) return;
      const text = parent.innerText;
      navigator.clipboard.writeText(text).then(()=>{
        btn.textContent='å·²å¤åˆ¶';
        setTimeout(()=> btn.textContent='å¤åˆ¶',1500);
      });
    }

    function quickAsk(q) {
      chatInput.value = q;
      sendMessage();
    }

    chatInput.addEventListener('input', ()=>{
      charCounter.textContent = `${chatInput.value.length} / 4000`;
    });

    chatInput.addEventListener('keydown', e => {
      if(e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    function toggleWrap() {
      wrapEnabled = !wrapEnabled;
      chatMessages.style.whiteSpace = wrapEnabled? 'pre-wrap':'pre';
      document.getElementById('wrapBtn').textContent = wrapEnabled? 'â†©ï¸ æ¢è¡Œ':'â†ªï¸ å•è¡Œ';
    }

    document.getElementById('clearChatBtn').addEventListener('click', ()=>{
      if(confirm('ç¡®è®¤æ¸…ç©ºå…¨éƒ¨å¯¹è¯ï¼Ÿ')) {
        chatMessages.innerHTML = '<div class="msg system">ğŸ—‘ï¸ å¯¹è¯å·²æ¸…ç©ºï¼Œå¯ä»¥ç»§ç»­æ–°çš„åˆ†æã€‚</div>';
      }
    });

    function stopRequest() {
      if(abortController) {
        abortController.abort();
        stopBtn.disabled = true;
        addSystemMessage('â¹ å·²å°è¯•åœæ­¢è¯·æ±‚');
      }
    }

    async function sendMessage() {
      const msg = chatInput.value.trim();
        if(!msg) return;
        if(!currentData) {
          addSystemMessage('âŒ è¯·å…ˆä¸Šä¼ æ•°æ®æ–‡ä»¶');
          return;
        }
        const baseUrl = document.getElementById('baseUrl').value.trim();
        const apiKey = document.getElementById('apiKey').value.trim();
        const modelId = document.getElementById('modelId').value.trim();
        if(!baseUrl || !apiKey || !modelId) {
          addSystemMessage('âŒ è¯·å®Œå–„ API é…ç½®');
          return;
        }
        addUserMessage(msg);
        chatInput.value='';
        charCounter.textContent = '0 / 4000';

        addLoadingMessage();
        stopBtn.disabled = false;

        const strategy = dataStrategySelect.value;
        const dataContext = buildDataContext(currentData,strategy);

        abortController = new AbortController();

        try {
          const res = await fetch(`${baseUrl}/chat/completions`,{
            method:'POST',
            headers:{
              'Content-Type':'application/json',
              'Authorization':'Bearer '+apiKey
            },
            body: JSON.stringify({
              model: modelId,
              temperature: 0.7,
              max_tokens: 2000,
              messages: [
                {
                  role:'system',
                  content: `ä½ æ˜¯èµ„æ·±æ•°æ®åˆ†æåŠ©æ‰‹ã€‚ç”¨æˆ·å·²ä¸Šä¼ æ–‡ä»¶ "${currentFileName}"ã€‚
æ•°æ®ç»Ÿè®¡:
- è¡Œæ•°: ${dataStats.totalRows}
- åˆ—æ•°: ${dataStats.totalColumns}
- å®Œæ•´åº¦: ${((dataStats.nonEmptyRows/dataStats.totalRows)*100).toFixed(1)}%

${dataContext}

è¯·åŸºäºä¸Šè¿°ä¸Šä¸‹æ–‡è¿›è¡Œä¸¥è°¨ã€ç»“æ„åŒ–ã€å¯éªŒè¯çš„å›ç­”ã€‚å¯ä½¿ç”¨æ¡ç›®ã€è¦ç‚¹ã€åˆ†æ®µã€å¿…è¦æ—¶ç»™å‡ºè¿›ä¸€æ­¥æ¢ç´¢å»ºè®®ã€‚${forceFullData?'(æ³¨æ„ï¼šå·²ä¼ è¾“å…¨é‡æ•°æ®ï¼Œè¯·ä¾§é‡å‡†ç¡®æ€»ç»“)':''}`
                },
                { role:'user', content: msg }
              ]
            }),
            signal: abortController.signal
          });
          removeLoadingMessage();
          stopBtn.disabled = true;
          if(!res.ok) throw new Error(`APIé”™è¯¯ ${res.status} ${res.statusText}`);
          const data = await res.json();
          const content = data.choices?.[0]?.message?.content || '(æ— å†…å®¹è¿”å›)';
          addAIMessage(content);
        } catch(err) {
          removeLoadingMessage();
          stopBtn.disabled = true;
          if(err.name === 'AbortError') {
            addSystemMessage('âš ï¸ è¯·æ±‚å·²ä¸­æ­¢');
          } else {
            addSystemMessage('âŒ è¯·æ±‚å¤±è´¥: '+err.message);
          }
        } finally {
          abortController = null;
        }
      }

      function buildDataContext(data,strategy) {
        if(!data || !data.length) return 'æ•°æ®ä¸ºç©º';
        // è‹¥å¯ç”¨å¼ºåˆ¶å…¨é‡ï¼Œå¿½ç•¥ç­–ç•¥
        if(forceFullData) {
          return fullDataAll(data);
        }
        const headers = data[0];
        const rows = data.slice(1);
        let ctx = `æ•°æ®åˆ—: ${headers.join(', ')}\nç­–ç•¥: ${strategy}\n\n`;
        switch(strategy) {
          case 'full':
            if(rows.length <= 100) {
              ctx += 'å®Œæ•´æ•°æ®:\n'+headers.join(' | ')+'\n';
              rows.forEach(r=>ctx += r.join(' | ')+'\n');
            } else {
              ctx += 'æ•°æ®è¾ƒå¤§ï¼Œè‡ªåŠ¨é™çº§ä¸ºæ™ºèƒ½é‡‡æ ·ã€‚\n'+smartSample(data);
            }
            break;
          case 'smart':
            ctx += smartSample(data);
            break;
          case 'summary':
            ctx += statSummary(data);
            break;
          case 'structured':
            ctx += structuredSample(data);
            break;
          default:
            ctx += smartSample(data);
        }
        return ctx;
      }

      function fullDataAll(data) {
        const headers = data[0];
        let s = `å…¨é‡æ•°æ®ä¸Šä¸‹æ–‡ (è¡Œ:${data.length-1} åˆ—:${headers.length})\n${headers.join(' | ')}\n`;
        for(let i=1;i<data.length;i++){
          s += data[i].join(' | ') + '\n';
        }
        // é™„åŠ åˆ—ç»Ÿè®¡
        s += '\nåˆ—ç»Ÿè®¡:\n';
        headers.forEach(h=>{
          const st = dataStats.columnStats[h];
          s += `${h}: éç©º${st.nonEmpty}, å”¯ä¸€${st.unique}` + (st.isNumeric?`, èŒƒå›´[${st.min}-${st.max}], å‡å€¼${st.avg.toFixed(2)}, ä¸­ä½æ•°${st.median}`:` ç¤ºä¾‹(${st.sample.slice(0,3).join(', ')})`) + '\n';
        });
        return s;
      }

      function smartSample(data) {
        const headers = data[0];
        const rows = data.slice(1);
        let s = '';
        // å¤´éƒ¨
        s += 'å¤´éƒ¨æ ·æœ¬(å‰5è¡Œ):\n'+headers.join(' | ')+'\n';
        rows.slice(0,5).forEach(r=> s+= r.join(' | ')+'\n');
        // ä¸­é—´éšæœº
        if(rows.length>20) {
          s += '\nä¸­éƒ¨éšæœº(5è¡Œ):\n'+headers.join(' | ')+'\n';
          const midStart = Math.floor(rows.length*0.25);
          const midEnd = Math.floor(rows.length*0.75);
          const midRows = rows.slice(midStart,midEnd);
          const picks = [];
          while(picks.length < Math.min(5,midRows.length)) {
            const candidate = midRows[Math.floor(Math.random()*midRows.length)];
            if(!picks.includes(candidate)) picks.push(candidate);
          }
          picks.forEach(r=> s+= r.join(' | ')+'\n');
        }
        // å°¾éƒ¨
        if(rows.length > 10) {
          s += '\nå°¾éƒ¨æ ·æœ¬(å3è¡Œ):\n'+headers.join(' | ')+'\n';
          rows.slice(-3).forEach(r=> s+= r.join(' | ')+'\n');
        }
        // åˆ—ç»Ÿè®¡
        s += '\nåˆ—ç»Ÿè®¡:\n';
        headers.forEach(h=>{
          const st = dataStats.columnStats[h];
          s += `${h}: éç©º${st.nonEmpty}, å”¯ä¸€${st.unique}`;
          if(st.isNumeric) {
            s+= `, èŒƒå›´[${st.min}-${st.max}], å‡å€¼${st.avg.toFixed(2)}, ä¸­ä½æ•°${st.median}`;
          } else {
            s+= `, ç¤ºä¾‹(${st.sample.slice(0,3).join(', ')})`;
          }
          s+='\n';
        });
        return s;
      }

      function statSummary(data) {
        const headers = data[0];
        let s = 'ç»Ÿè®¡æ‘˜è¦:\n';
        headers.forEach(h=>{
          const st = dataStats.columnStats[h];
          s += `\n[${h}] ç±»å‹:${st.isNumeric?'æ•°å€¼':'æ–‡æœ¬'} éç©º:${st.nonEmpty}/${dataStats.totalRows} å”¯ä¸€:${st.unique}\n`;
          if(st.isNumeric) s+= `æœ€å°:${st.min} æœ€å¤§:${st.max} å‡å€¼:${st.avg.toFixed(2)} ä¸­ä½æ•°:${st.median}\n`;
          else s+= `ç¤ºä¾‹:${st.sample.slice(0,5).join(', ')}\n`;
        });
        return s;
      }

      function structuredSample(data) {
        const headers = data[0];
        const rows = data.slice(1);
        let s = 'ç»“æ„åŒ–é‡‡æ ·:\n';
        const sampleSize = Math.min(50, Math.max(10, Math.floor(rows.length * 0.1)));
        const interval = Math.max(1, Math.floor(rows.length / sampleSize));
        s += `åˆ†å±‚å‘¨æœŸ:${interval} å…±:${sampleSize}\n${headers.join(' | ')}\n`;
        for(let i=0;i<sampleSize && i*interval < rows.length;i++) {
          s+= rows[i*interval].join(' | ')+'\n';
        }
        s+='\n'+statSummary(data);
        return s;
      }

      /**********************
       * Markdown æ¸²æŸ“(ç®€æ˜“)
       **********************/
      function renderMarkdown(text) {
        if(!text) return '';
        let html = escapeHtml(text);
        // ç²—ä½“ **text**
        html = html.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
        // ä»£ç å— ```...```
        html = html.replace(/```([\s\S]*?)```/g, (m,code)=> `<pre style="background:#0f172a15;padding:10px 12px;border-radius:10px;overflow:auto;font-size:.65rem;"><code>${escapeHtml(code.trim())}</code></pre>`);
        // è¡Œå†…ä»£ç 
        html = html.replace(/`([^`]+?)`/g,'<code>$1</code>');
        // æ— åºåˆ—è¡¨ (ç®€å•æ›¿æ¢)
        html = html.replace(/(^|\n)- (.+)/g,'$1â€¢ $2');
        // æ¢è¡Œ -> æ®µ
        html = html.replace(/\n{2,}/g,'</p><p>');
        html = '<p>'+html+'</p>';
        return html;
      }

      /**********************
       * çŠ¶æ€æ¶ˆæ¯
       **********************/
      function showStatus(container,msg,type='info') {
        container.innerHTML = `<div class="status ${type}">${msg}</div>`;
      }

      /**********************
       * è¿æ¥æµ‹è¯•
       **********************/
      async function testConnection() {
        const baseUrl = document.getElementById('baseUrl').value.trim();
        const apiKey = document.getElementById('apiKey').value.trim();
        const modelId = document.getElementById('modelId').value.trim();
        const statusDiv = document.getElementById('connectionStatus');
        if(!baseUrl || !apiKey || !modelId) {
          statusDiv.innerHTML = '<div class="status error">âŒ è¯·å¡«å†™å®Œæ•´é…ç½®</div>';
          return;
        }
        statusDiv.innerHTML = '<div class="status info"><div class="loading"></div> æ­£åœ¨æµ‹è¯•...</div>';
        try {
          const res = await fetch(`${baseUrl}/chat/completions`,{
            method:'POST',
            headers:{
              'Content-Type':'application/json',
              'Authorization':'Bearer '+apiKey
            },
            body: JSON.stringify({
              model:modelId,
              max_tokens: 10,
              messages:[{role:'user',content:'è¯·å›å¤: è¿æ¥æˆåŠŸ'}]
            })
          });
          if(res.ok) statusDiv.innerHTML = '<div class="status success">âœ… è¿æ¥æˆåŠŸ</div>';
          else throw new Error(res.status+' '+res.statusText);
        } catch(err) {
          statusDiv.innerHTML = `<div class="status error">âŒ å¤±è´¥: ${err.message}</div>`;
        }
      }

      /**********************
       * æ‹–æ‹½è°ƒæ•´é¢æ¿å®½åº¦
       **********************/
      const resizer = document.getElementById('resizer');
      const leftPanel = document.getElementById('leftPanel');
      const centerPanel = document.getElementById('centerPanel');
      let isResizing = false;
      resizer.addEventListener('mousedown', e=>{
        isResizing = true;
        resizer.classList.add('active');
        document.body.style.userSelect='none';
      });
      window.addEventListener('mousemove', e=>{
        if(!isResizing) return;
        const layoutRect = document.getElementById('layoutRoot').getBoundingClientRect();
        const min = 280;
        const max = 640;
        let newWidth = e.clientX - layoutRect.left;
        if(newWidth < min) newWidth = min;
        if(newWidth > max) newWidth = max;
        leftPanel.style.width = newWidth+'px';
        leftPanel.style.flex = '0 0 '+newWidth+'px';
      });
      window.addEventListener('mouseup', ()=>{
        if(isResizing) {
          isResizing = false;
          resizer.classList.remove('active');
          document.body.style.userSelect='';
        }
      });

      /**********************
       * åˆå§‹åŒ–
       **********************/
      dataStrategySelect.addEventListener('change', ()=>{
        saveConfig();
        if(!forceFullData) renderStrategyAdvice();
      });

      // åˆå§‹æŒ‰é’®çŠ¶æ€
      updateFullDataToggle();
  </script>
</body>
</html>