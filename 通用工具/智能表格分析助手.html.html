<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>数据表格AI分析助手 - 全新增强UI</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <meta name="color-scheme" content="light dark">
  <style>
    :root {
      --brand: #6366f1;
      --brand-accent: #8b5cf6;
      --gradient: linear-gradient(135deg,#6366f1 0%,#8b5cf6 100%);
      --bg: #f5f7fb;
      --bg-alt: #ffffff;
      --bg-soft: #f1f5f9;
      --bg-hover: #f8fafc;
      --border: #e2e8f0;
      --border-strong: #cbd5e1;
      --text: #1e293b;
      --text-soft: #64748b;
      --radius-sm: 6px;
      --radius: 12px;
      --radius-lg: 18px;
      --shadow-sm: 0 2px 4px -1px rgba(0,0,0,0.05),0 1px 3px -1px rgba(0,0,0,0.05);
      --shadow: 0 4px 16px -2px rgba(15,23,42,0.12);
      --shadow-focus: 0 0 0 3px rgba(99,102,241,0.35);
      --danger: #ef4444;
      --success: #10b981;
      --warn: #f59e0b;
      --info: #0ea5e9;
      --code: #0f172a;
      --font-stack: "Segoe UI","SF Pro Display","Helvetica Neue",Arial,"PingFang SC","Microsoft YaHei",sans-serif;
      --transition: .25s cubic-bezier(.4,0,.2,1);
    }
    body.dark {
      --bg: #0f172a;
      --bg-alt: #182233;
      --bg-soft: #1e293b;
      --bg-hover: #24324a;
      --border: #253447;
      --border-strong: #2f4157;
      --text: #f1f5f9;
      --text-soft: #94a3b8;
      --shadow: 0 4px 16px -2px rgba(0,0,0,0.6);
      --code: #e2e8f0;
    }
    * { box-sizing: border-box; }
    html,body { margin:0; padding:0; height:100%; }
    body {
      font-family: var(--font-stack);
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      line-height: 1.5;
    }
    /* 全局布局 */
    .app-shell {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      gap: 14px;
      padding: clamp(12px,1.8vw,28px);
      transition: background var(--transition),color var(--transition);
    }
    .app-header {
      background: var(--gradient);
      color: #fff;
      border-radius: var(--radius-lg);
      padding: clamp(18px,2.2vw,34px) clamp(20px,2.4vw,42px);
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 14px;
      isolation: isolate;
    }
    .app-header:before,
    .app-header:after {
      content:"";
      position:absolute;
      width:480px;
      height:480px;
      background: radial-gradient(circle at center,rgba(255,255,255,0.25),transparent 70%);
      top:-220px;
      right:-160px;
      filter: blur(8px);
      opacity:.6;
      animation: float 18s linear infinite;
    }
    .app-header:after {
      top:auto;
      bottom:-240px;
      right:auto;
      left:-180px;
      animation-duration: 26s;
      animation-direction: reverse;
    }
    @keyframes float {
      0% { transform: rotate(0deg) scale(1); }
      50% { transform: rotate(180deg) scale(1.05); }
      100% { transform: rotate(360deg) scale(1); }
    }
    .top-toolbar {
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
    }
    .brand-title {
      font-size: clamp(1.6rem,2.4vw,2.6rem);
      font-weight: 700;
      letter-spacing: .5px;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .brand-title span.badge {
      font-size:.65em;
      background: rgba(255,255,255,0.18);
      padding:4px 10px;
      border-radius: 999px;
      font-weight:500;
      backdrop-filter: blur(4px);
    }
    .header-sub {
      font-size: clamp(.85rem,1.05vw,1.05rem);
      opacity: .92;
      font-weight: 500;
      display:flex;
      flex-wrap:wrap;
      gap:14px;
      align-items:center;
    }
    .header-sub .pill {
      background: rgba(255,255,255,0.18);
      padding:6px 14px;
      border-radius: 999px;
      font-size: .75em;
      letter-spacing:.5px;
    }
    /* 主体区域 */
    .layout {
      display: grid;
      grid-template-columns: minmax(380px, 520px) 1fr 400px;
      gap: 18px;
      flex: 1;
      min-height: 0;
    }
    /* 面板通用 */
    .panel {
      background: var(--bg-alt);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      display: flex;
      flex-direction: column;
      min-height: 0;
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      transition: background var(--transition),border-color var(--transition),box-shadow var(--transition);
    }
    body.dark .panel { box-shadow: none; }
    .panel-header {
      padding: 16px 20px 10px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap:12px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(to bottom, var(--bg-soft), transparent);
    }
    .panel-title {
      font-size: .95rem;
      font-weight: 600;
      letter-spacing:.5px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .panel-title i {
      width:24px;
      height:24px;
      display:grid;
      place-items:center;
      background: var(--gradient);
      color:#fff;
      font-style:normal;
      font-size:.9rem;
      border-radius: 8px;
      box-shadow: 0 4px 10px -2px rgba(99,102,241,0.4);
    }
    .panel-body {
      padding: 16px 20px 22px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--brand) transparent;
    }
    .panel-body::-webkit-scrollbar {
      width: 10px;
    }
    .panel-body::-webkit-scrollbar-track {
      background: transparent;
    }
    .panel-body::-webkit-scrollbar-thumb {
      background: linear-gradient(var(--brand),var(--brand-accent));
      border-radius: 20px;
      border: 3px solid var(--bg-alt);
    }
    /* 上传区域 */
    .upload-area {
      border: 2px dashed var(--border-strong);
      border-radius: var(--radius);
      padding: 38px 26px;
      text-align: center;
      cursor: pointer;
      background: linear-gradient(145deg,var(--bg-soft),var(--bg-alt));
      position: relative;
      transition: var(--transition);
    }
    .upload-area:hover {
      border-color: var(--brand);
      background: linear-gradient(145deg,var(--bg-alt),var(--bg-soft));
      box-shadow: var(--shadow-sm);
    }
    .upload-area.dragover {
      border-color: var(--brand-accent);
      background: linear-gradient(135deg,rgba(99,102,241,0.1),rgba(139,92,246,0.15));
    }
    .upload-icon {
      width:60px;height:60px;
      margin:0 auto 14px;
      background: radial-gradient(circle at 30% 30%,var(--brand) 0%,var(--brand-accent) 70%);
      border-radius: 22px;
      display:grid;
      place-items:center;
      font-size: 30px;
      color:#fff;
      box-shadow: 0 10px 25px -4px rgba(99,102,241,0.55);
      position: relative;
      overflow:hidden;
    }
    .upload-icon:after {
      content:"";
      position:absolute;
      inset:0;
      background:
        linear-gradient(120deg,rgba(255,255,255,0) 0%,rgba(255,255,255,.55) 45%,rgba(255,255,255,0) 60%);
      transform: translateX(-100%) rotate(10deg);
      animation: shine 4s infinite;
    }
    @keyframes shine {
      0% { transform: translateX(-100%) rotate(10deg); }
      60% { transform: translateX(120%) rotate(10deg); }
      100% { transform: translateX(120%) rotate(10deg); }
    }
    .upload-area p {
      margin:4px 0;
      font-size:.85rem;
    }
    .upload-area p.hint {
      color: var(--text-soft);
      font-size: .75rem;
      letter-spacing:.5px;
    }
    /* 按钮 */
    .btn-row {
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      margin-bottom: 14px;
    }
    button.btn {
      --btn-bg: var(--gradient);
      --btn-color: #fff;
      border:none;
      outline:none;
      font: 500 .75rem/1 var(--font-stack);
      letter-spacing:.5px;
      padding: 10px 16px;
      border-radius: 10px;
      background: var(--btn-bg);
      color: var(--btn-color);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      position:relative;
      overflow:hidden;
      transition: var(--transition);
      box-shadow: 0 4px 10px -3px rgba(99,102,241,0.5);
    }
    button.btn:before {
      content:"";
      position:absolute;
      inset:0;
      background:linear-gradient(135deg,rgba(255,255,255,.2),rgba(255,255,255,0));
      opacity:0;
      transition: var(--transition);
    }
    button.btn:hover:before { opacity:1; }
    button.btn:hover { transform: translateY(-2px); }
    button.btn:active { transform: translateY(0); }
    button.btn.secondary {
      --btn-bg: linear-gradient(135deg,#64748b,#475569);
      box-shadow: 0 4px 10px -3px rgba(71,85,105,0.5);
    }
    button.btn.outline {
      --btn-bg: var(--bg-alt);
      --btn-color: var(--text);
      border:1px solid var(--border-strong);
      box-shadow:none;
    }
    button.btn.outline:hover {
      background: var(--bg-hover);
    }
    button.btn.danger {
      --btn-bg: linear-gradient(135deg,#ef4444,#dc2626);
      box-shadow:0 4px 10px -3px rgba(239,68,68,0.5);
    }
    button.icon-btn {
      padding:8px 10px;
      min-width:40px;
      justify-content:center;
      font-size:.8rem;
    }
    /* 新增：outline 激活态 */
    button.btn.outline.active {
      background: linear-gradient(135deg,var(--brand),var(--brand-accent));
      color:#fff;
      border-color: var(--brand);
      box-shadow: 0 4px 12px -4px rgba(99,102,241,0.6);
    }
    button.btn.outline.active:before { opacity:.25; }
    /* 输入控件 */
    .form-grid {
      display:grid;
      gap: 14px;
    }
    .config-group {
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .config-group label {
      font-size:.7rem;
      text-transform: uppercase;
      letter-spacing:.9px;
      color: var(--text-soft);
      font-weight:600;
    }
    .config-group input,
    .config-group select {
      background: var(--bg-soft);
      border:1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      font-size:.8rem;
      transition: var(--transition);
      color: var(--text);
    }
    .config-group input:focus,
    .config-group select:focus {
      outline:none;
      border-color: var(--brand);
      box-shadow: var(--shadow-focus);
      background: var(--bg-alt);
    }
    /* 状态条 */
    .status {
      margin-top: 10px;
      padding: 10px 14px;
      border-radius: 10px;
      font-size: .72rem;
      letter-spacing:.5px;
      font-weight:500;
      display:flex;
      align-items:center;
      gap:8px;
      border:1px solid transparent;
      background: var(--bg-soft);
    }
    .status.success { background: rgba(16,185,129,.12); color:#059669; border-color: rgba(16,185,129,.3); }
    .status.error { background: rgba(239,68,68,.15); color:#dc2626; border-color: rgba(239,68,68,.35); }
    .status.info { background: rgba(14,165,233,.15); color:#0284c7; border-color: rgba(14,165,233,.35); }
    .status.warning { background: rgba(245,158,11,.15); color:#b45309; border-color: rgba(245,158,11,.4); }
    .loading {
      width:18px;height:18px;
      border:3px solid rgba(255,255,255,.4);
      border-top-color:#fff;
      border-radius:50%;
      animation: spin .85s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg);} }
    /* 数据统计卡片增强 */
    .stats-grid {
      display:grid;
      gap:14px;
      grid-template-columns:repeat(auto-fill,minmax(130px,1fr));
      margin-top:4px;
    }
    .stat-card {
      position:relative;
      border:1px solid var(--border);
      background: linear-gradient(145deg,var(--bg-soft),var(--bg-alt));
      padding:14px 14px 12px;
      border-radius: 14px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      gap:6px;
      transition: var(--transition);
    }
    .stat-card:hover {
      border-color: var(--brand);
      box-shadow: var(--shadow-sm);
      transform: translateY(-3px);
    }
    .stat-card .label {
      font-size: .65rem;
      letter-spacing:.8px;
      font-weight:600;
      color: var(--text-soft);
      text-transform: uppercase;
    }
    .stat-card .value {
      font-size: 1.65rem;
      font-weight: 700;
      background: linear-gradient(90deg,var(--brand),var(--brand-accent));
      -webkit-background-clip: text;
      color: transparent;
      letter-spacing: .5px;
    }
    .progress-bar {
      height:6px;
      border-radius:4px;
      background: var(--bg-soft);
      overflow:hidden;
      position: relative;
    }
    .progress-bar span {
      position:absolute;
      inset:0;
      width:0;
      background: linear-gradient(90deg,var(--brand),var(--brand-accent));
      animation: grow 1.4s ease forwards;
      box-shadow: 0 0 0 1px rgba(255,255,255,.3) inset;
    }
    @keyframes grow { to { width: var(--w); } }
    /* 策略条 */
    .strategy-box {
      margin-top:18px;
      border:1px solid var(--border-strong);
      border-radius: 14px;
      padding: 18px 20px;
      background: linear-gradient(130deg,rgba(99,102,241,0.12),rgba(139,92,246,0.12));
      position:relative;
      overflow:hidden;
    }
    .strategy-box:before {
      content:"";
      position:absolute;
      width:220px;height:220px;
      border-radius:50%;
      background: radial-gradient(circle at center,rgba(99,102,241,0.5),transparent 70%);
      top:-120px;right:-90px;
      filter: blur(12px);
      opacity:.35;
    }
    .strategy-title {
      font-weight:600;
      font-size:.85rem;
      letter-spacing:.6px;
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:8px;
    }
    .strategy-title i {
      width:26px;height:26px;
      border-radius: 9px;
      display:grid;
      place-items:center;
      background: var(--gradient);
      color:#fff;
      font-style:normal;
      font-size:.85rem;
      box-shadow: 0 6px 16px -4px rgba(99,102,241,0.5);
    }
    .strategy-text {
      font-size:.75rem;
      color: var(--text);
      line-height:1.55;
      text-wrap: pretty;
    }
    /* 表格预览 */
    .preview-toolbar {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-bottom:12px;
    }
    .table-shell {
      border:1px solid var(--border);
      border-radius: 14px;
      overflow:hidden;
      background: var(--bg-alt);
      position:relative;
    }
    .table-scroll {
      max-height: 400px;
      overflow:auto;
      scrollbar-width: thin;
      scrollbar-color: var(--brand) transparent;
    }
    .table-scroll::-webkit-scrollbar {
      width:10px;
      height:10px;
    }
    .table-scroll::-webkit-scrollbar-thumb {
      background: linear-gradient(var(--brand),var(--brand-accent));
      border-radius:10px;
      border:2px solid var(--bg-alt);
    }
    table {
      width:100%;
      border-collapse: collapse;
      font-size:.72rem;
      table-layout: fixed;
    }
    thead th {
      position:sticky; top:0; z-index:10;
      background: linear-gradient(90deg,var(--bg-soft),var(--bg-alt));
      backdrop-filter: blur(4px);
      font-weight:600;
      text-align:left;
      padding:10px 10px;
      border-bottom: 1px solid var(--border-strong);
      letter-spacing:.4px;
    }
    tbody td {
      padding:8px 10px;
      border-bottom:1px solid var(--border);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    tbody tr:nth-child(even) {
      background: var(--bg-soft);
    }
    tbody tr:hover {
      background: var(--brand);
      color:#fff;
    }
    .table-footer {
      padding:10px 12px;
      font-size:.65rem;
      color: var(--text-soft);
      background: var(--bg-soft);
      border-top:1px solid var(--border);
      text-align:center;
    }
    /* 分隔线/拖拽条 (中间可调) */
    .resizer {
      width:10px;
      cursor: col-resize;
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .resizer:after {
      content:"";
      width:3px;
      height:60%;
      border-radius:4px;
      background: linear-gradient(var(--brand),var(--brand-accent));
      opacity:.5;
      transition: var(--transition);
    }
    .resizer:hover:after,
    .resizer.active:after {
      opacity:1;
      box-shadow: 0 0 0 4px rgba(99,102,241,0.2);
    }
    /* Chat */
    .chat-root {
      display:flex;
      flex-direction:column;
      gap:16px;
      height:100%;
      min-height:0;
    }
    .chat-history {
      flex:1;
      min-height:0;
      overflow-y:auto;
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 18px 18px 10px;
      background: linear-gradient(160deg,var(--bg-soft),var(--bg-alt));
      display:flex;
      flex-direction:column;
      gap:14px;
      position:relative;
    }
    .chat-history::-webkit-scrollbar {
      width:10px;
    }
    .chat-history::-webkit-scrollbar-thumb {
      background: linear-gradient(var(--brand),var(--brand-accent));
      border-radius:10px;
      border:2px solid var(--bg-alt);
    }
    .msg {
      max-width: 88%;
      padding: 12px 15px 14px;
      border-radius: 14px;
      font-size:.78rem;
      line-height:1.55;
      position:relative;
      display:flex;
      flex-direction:column;
      gap:6px;
      animation: fadeIn .4s ease;
    }
    @keyframes fadeIn {
      from { opacity:0; transform: translateY(6px); }
      to { opacity:1; transform: translateY(0); }
    }
    .msg.user {
      margin-left:auto;
      background: linear-gradient(135deg,var(--brand),var(--brand-accent));
      color:#fff;
      box-shadow: 0 4px 14px -4px rgba(99,102,241,0.7);
      border-bottom-right-radius: 4px;
    }
    .msg.ai {
      background: var(--bg-alt);
      border:1px solid var(--border);
      border-bottom-left-radius:4px;
    }
    body.dark .msg.ai {
      background: #1e293b;
    }
    .msg.system {
      align-self:center;
      background: linear-gradient(135deg,#fef08a,#fde047);
      color:#854d0e;
      border:1px solid #fcd34d;
      font-style:italic;
      font-weight:500;
      max-width:100%;
    }
    .msg .tools {
      display:flex;
      gap:6px;
      opacity:0;
      transition: var(--transition);
    }
    .msg:hover .tools { opacity:1; }
    .mini-btn {
      border:none;
      background: var(--bg-soft);
      color: var(--text-soft);
      border-radius: 6px;
      font-size:.6rem;
      padding:4px 8px;
      cursor:pointer;
      letter-spacing:.5px;
      font-weight:500;
    }
    .mini-btn:hover {
      background: var(--brand);
      color:#fff;
    }
    .markdown p { margin:0 0 6px; }
    .markdown code {
      font-family: ui-monospace,Menlo,Consolas,monospace;
      background: #0f172a10;
      padding:2px 6px;
      border-radius:6px;
      font-size:.68rem;
    }
    body.dark .markdown code {
      background:#1e293b;
      color:#e2e8f0;
    }
    .chat-input-row {
      display:flex;
      align-items:flex-end;
      gap:10px;
    }
    .chat-textarea-wrap {
      flex:1;
      position:relative;
    }
    textarea.chat-input {
      width:100%;
      resize:none;
      border:1px solid var(--border);
      background: var(--bg-alt);
      min-height:80px;
      padding: 14px 16px 42px 14px;
      border-radius: 16px;
      font: 500 .8rem/1.55 var(--font-stack);
      letter-spacing:.3px;
      color: var(--text);
      transition: var(--transition);
    }
    textarea.chat-input:focus {
      outline:none;
      border-color: var(--brand);
      box-shadow: var(--shadow-focus);
    }
    .char-counter {
      position:absolute;
      bottom:8px;
      right:12px;
      font-size:.55rem;
      color: var(--text-soft);
      letter-spacing:.5px;
    }
    .chat-actions {
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    /* 主题切换 */
    .theme-toggle {
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 14px;
      background: rgba(255,255,255,.16);
      color:#fff;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.3);
      font-size:.7rem;
      font-weight:600;
      letter-spacing:.5px;
      cursor:pointer;
      backdrop-filter: blur(8px);
      transition: var(--transition);
    }
    .theme-toggle:hover {
      background: rgba(255,255,255,.24);
    }
    body.dark .theme-toggle {
      background: rgba(255,255,255,.08);
      border-color: rgba(255,255,255,.15);
    }
    /* 响应式 */
    @media (max-width:1400px) {
      .layout {
        grid-template-columns: minmax(360px,480px) 1fr 380px;
      }
    }
    @media (max-width:1180px) {
      .layout {
        grid-template-columns: minmax(340px,440px) 1fr;
      }
      .panel.chat-panel {
        order:3;
        grid-column: 1 / -1;
        min-height:480px;
      }
    }
    @media (max-width:860px) {
      .layout {
        grid-template-columns: 1fr;
      }
      .resizer { display:none; }
      .panel {
        min-height:auto;
      }
      .app-header {
        padding:28px 22px;
      }
      .chat-history { max-height:380px; }
    }
    @media (max-width:520px) {
      .header-sub { flex-direction:column; align-items:flex-start; }
      .brand-title { font-size:1.85rem; }
      button.btn { padding:9px 13px; font-size:.68rem; }
      .upload-area { padding:32px 20px; }
    }
    /* 轻微动效 */
    .fade-in {
      animation: fade .6s ease;
    }
    @keyframes fade {
      from { opacity:0; transform: translateY(10px); }
      to { opacity:1; transform: translateY(0); }
    }
    /* 隐藏文件输入 */
    input[type=file] { display:none; }
    /* 代码选择高亮 */
    ::selection {
      background: var(--brand);
      color:#fff;
    }
    /* 无数据占位 */
    .placeholder {
      padding:46px 20px;
      text-align:center;
      font-size:.8rem;
      color: var(--text-soft);
    }
    /* 新增：全量上下文提示徽章 */
    .full-context-badge {
      display:inline-flex;
      align-items:center;
      gap:6px;
      background: linear-gradient(135deg,#dc2626,#ef4444);
      color:#fff;
      padding:6px 10px;
      border-radius:8px;
      font-size:.6rem;
      font-weight:600;
      letter-spacing:.5px;
      margin-left:8px;
      box-shadow:0 4px 10px -3px rgba(239,68,68,0.5);
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- 顶部头部 -->
    <header class="app-header">
      <div class="top-toolbar">
        <div>
          <div class="brand-title">
            📊 数据表格AI分析助手
            <span class="badge">Enhanced</span>
          </div>
          <div class="header-sub">
            <span class="pill">智能数据采样</span>
            <span class="pill">结构化上下文</span>
            <span class="pill">深度洞察</span>
            <span id="fullContextBadge" style="display:none;" class="full-context-badge" title="当前对话将发送全部数据行，可能消耗大量 Token">⚠ 全量上下文已开启</span>
          </div>
        </div>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <button id="themeToggle" class="theme-toggle" type="button" aria-label="切换主题">
            <span id="themeIcon">🌙</span>
            <span id="themeLabel">深色模式</span>
          </button>
          <button class="btn outline icon-btn" id="clearChatBtn" title="清空对话">
            🧹 清空
          </button>
        </div>
      </div>
    </header>

    <!-- 主体布局 -->
    <div class="layout" id="layoutRoot">
      <!-- 左侧：上传 + 数据概览 + 预览 -->
      <div class="panel" id="leftPanel">
        <div class="panel-header">
          <div class="panel-title">
            <i>📂</i> 上传与数据概览
          </div>
        </div>
        <div class="panel-body">
          <!-- 上传 -->
          <div class="upload-area" id="uploadArea" tabindex="0" role="button" aria-label="上传数据文件">
            <div class="upload-icon">📄</div>
            <p><strong>点击或拖拽文件到此处</strong></p>
            <p class="hint">支持 CSV, XLSX, XLS</p>
            <input type="file" id="fileInput" accept=".csv,.xlsx,.xls">
          </div>
          <div id="fileStatus" class="fade-in"></div>

          <!-- 统计 -->
          <div style="margin-top:28px;">
            <h3 style="font-size:.85rem;letter-spacing:.8px;font-weight:700;color:var(--text-soft);text-transform:uppercase;display:flex;align-items:center;gap:8px;margin:0 0 10px;">
              <span style="background:var(--gradient);color:#fff;width:28px;height:28px;display:grid;place-items:center;border-radius:8px;font-size:.8rem;box-shadow:0 5px 14px -4px rgba(99,102,241,0.6)">📈</span>
              数据概览
            </h3>
            <div id="dataStats"></div>
            <div id="dataStrategy"></div>
          </div>

          <!-- 预览 -->
          <div style="margin-top:32px;">
            <h3 style="font-size:.85rem;letter-spacing:.8px;font-weight:700;color:var(--text-soft);text-transform:uppercase;display:flex;align-items:center;gap:8px;margin:0 0 10px;">
              <span style="background:var(--gradient);color:#fff;width:28px;height:28px;display:grid;place-items:center;border-radius:8px;font-size:.8rem;box-shadow:0 5px 14px -4px rgba(99,102,241,0.6)">👀</span>
              数据预览
            </h3>
            <div class="preview-toolbar">
              <button class="btn outline" onclick="showDataSample('head')">前10行</button>
              <button class="btn outline" onclick="showDataSample('tail')">后10行</button>
              <button class="btn outline" onclick="showDataSample('random')">随机10行</button>
              <button class="btn outline" onclick="showDataSample('full')">完整预览</button>
              <button class="btn outline" onclick="downloadSample()" title="导出当前预览">导出预览</button>
            </div>
            <div id="tablePreview" class="table-shell fade-in">
              <div class="placeholder">请先上传数据文件</div>
            </div>
          </div>
        </div>
      </div>

      <!-- 中间：配置 -->
      <div class="panel" id="centerPanel">
        <div class="panel-header">
          <div class="panel-title">
            <i>🛠</i> AI API 配置
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button class="btn outline icon-btn" onclick="testConnection()">🔍 测试</button>
            <button class="btn outline icon-btn" onclick="saveConfig()">💾 保存</button>
            <!-- 新增：全量上下文切换按钮 -->
            <button id="fullDataToggle" class="btn outline icon-btn" type="button" title="启用后将把全部数据行传给 AI（可能非常耗费 Token）">📤 全量</button>
          </div>
        </div>
        <div class="panel-body">
          <div class="form-grid">
            <div class="config-group">
              <label for="baseUrl">Base URL</label>
              <input id="baseUrl" placeholder="https://api.openai.com/v1" value="https://api.openai.com/v1">
            </div>
            <div class="config-group">
              <label for="apiKey">API Key</label>
              <input id="apiKey" type="password" placeholder="sk-...">
            </div>
            <div class="config-group">
              <label for="modelId">模型 ID</label>
              <input id="modelId" value="gpt-3.5-turbo">
            </div>
            <div class="config-group">
              <label for="dataStrategySelect">数据传输策略</label>
              <select id="dataStrategySelect">
                <option value="smart">智能采样 (推荐)</option>
                <option value="full">完整数据 (小文件)</option>
                <option value="summary">统计摘要</option>
                <option value="structured">结构化采样</option>
              </select>
            </div>
          </div>
          <div id="connectionStatus"></div>
          <div style="margin-top:30px;">
            <h4 style="font-size:.7rem;letter-spacing:.8px;text-transform:uppercase;color:var(--text-soft);margin:0 0 12px;font-weight:700;">列特征分析</h4>
            <div id="columnProfiles" style="display:grid;gap:10px;"></div>
          </div>
        </div>
      </div>

      <!-- 拖拽分隔条（中间可调宽） -->
      <div class="resizer" id="resizer" aria-label="拖拽调整面板宽度"></div>

      <!-- 右侧：对话 -->
      <div class="panel chat-panel" id="chatPanel">
        <div class="panel-header">
          <div class="panel-title">
            <i>💬</i> AI 对话
          </div>
          <div style="display:flex;gap:8px;">
            <button class="btn outline icon-btn" onclick="toggleWrap()" id="wrapBtn" title="切换换行">↩️ 换行</button>
            <button class="btn outline icon-btn" onclick="scrollChatBottom()" title="滚动到底部">⤓ 底部</button>
          </div>
        </div>
        <div class="panel-body" style="display:flex;flex-direction:column;gap:14px;">
          <div class="chat-root">
            <div class="chat-history" id="chatMessages">
              <div class="msg system">👋 您好！请上传数据文件，我将进行智能分析。支持多种采样与统计策略。</div>
            </div>
            <div class="chat-input-row">
              <div class="chat-textarea-wrap">
                <textarea id="chatInput" class="chat-input" placeholder="请输入您的问题，Shift+Enter 换行..." rows="3" maxlength="4000"></textarea>
                <div class="char-counter" id="charCounter">0 / 4000</div>
              </div>
              <div class="chat-actions">
                <button class="btn" onclick="sendMessage()">发送 ▶</button>
                <button class="btn secondary" onclick="stopRequest()" id="stopBtn" disabled>停止 ⏹</button>
              </div>
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;">
              <button class="btn outline" onclick="quickAsk('请进行数据字段含义猜测与整体质量评估。')">字段含义</button>
              <button class="btn outline" onclick="quickAsk('请给出关键数值列的统计摘要。')">列统计</button>
              <button class="btn outline" onclick="quickAsk('请识别潜在异常值与数据质量问题。')">异常检测</button>
              <button class="btn outline" onclick="quickAsk('请生成适合此数据集的可视化图表建议列表。')">可视化建议</button>
            </div>
          </div>
        </div>
      </div>
    </div><!-- layout -->
  </div><!-- app-shell -->

  <!-- 修复后的XLSX库引用 -->
  <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    /**********************
     * 全局状态
     **********************/
    let currentData = null;
    let currentFileName = '';
    let dataStats = {};
    let abortController = null;
    let wrapEnabled = true;
    // 新增：是否强制全量上下文
    let forceFullData = false;

    /**********************
     * DOM 引用
     **********************/
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const fileStatus = document.getElementById('fileStatus');
    const dataStatsDiv = document.getElementById('dataStats');
    const dataStrategyDiv = document.getElementById('dataStrategy');
    const tablePreview = document.getElementById('tablePreview');
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const charCounter = document.getElementById('charCounter');
    const dataStrategySelect = document.getElementById('dataStrategySelect');
    const columnProfiles = document.getElementById('columnProfiles');
    const stopBtn = document.getElementById('stopBtn');
    const fullDataToggle = document.getElementById('fullDataToggle');
    const fullContextBadge = document.getElementById('fullContextBadge');

    /**********************
     * 主题切换
     **********************/
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const themeLabel = document.getElementById('themeLabel');

    function applyTheme(theme) {
      if(theme === 'dark') {
        document.body.classList.add('dark');
        themeIcon.textContent = '🌞';
        themeLabel.textContent = '浅色模式';
      } else {
        document.body.classList.remove('dark');
        themeIcon.textContent = '🌙';
        themeLabel.textContent = '深色模式';
      }
      localStorage.setItem('app-theme', theme);
    }
    themeToggle.addEventListener('click', () => {
      const isDark = document.body.classList.toggle('dark');
      applyTheme(isDark ? 'dark':'light');
    });
    (function initTheme(){
      const saved = localStorage.getItem('app-theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark':'light');
      applyTheme(saved);
    })();

    /**********************
     * 配置持久化
     **********************/
    function saveConfig() {
      const cfg = {
        baseUrl: document.getElementById('baseUrl').value.trim(),
        apiKey: document.getElementById('apiKey').value.trim(),
        modelId: document.getElementById('modelId').value.trim(),
        strategy: dataStrategySelect.value,
        forceFullData
      };
      localStorage.setItem('ai-config', JSON.stringify(cfg));
      showStatus(fileStatus,'✅ 配置已保存','success');
    }

    function loadConfig() {
      const raw = localStorage.getItem('ai-config');
      if(!raw) return;
      try {
        const cfg = JSON.parse(raw);
        if(cfg.baseUrl) document.getElementById('baseUrl').value = cfg.baseUrl;
        if(cfg.apiKey) document.getElementById('apiKey').value = cfg.apiKey;
          if(cfg.modelId) document.getElementById('modelId').value = cfg.modelId;
        if(cfg.strategy) dataStrategySelect.value = cfg.strategy;
        if(typeof cfg.forceFullData === 'boolean') {
          forceFullData = cfg.forceFullData;
          updateFullDataToggle();
        }
      } catch(e){}
    }
    loadConfig();

    /**********************
     * 全量上下文按钮逻辑
     **********************/
    function updateFullDataToggle() {
      if(forceFullData) {
        fullDataToggle.classList.add('active');
        fullDataToggle.textContent = '📤 全量 ON';
        fullDataToggle.title = '已启用：全部数据行将发送给 AI';
        fullContextBadge.style.display = 'inline-flex';
      } else {
        fullDataToggle.classList.remove('active');
          fullDataToggle.textContent = '📤 全量';
        fullDataToggle.title = '点击启用全量数据上下文';
        fullContextBadge.style.display = 'none';
      }
    }
    fullDataToggle.addEventListener('click', ()=>{
      if(!currentData) {
        addSystemMessage('⚠️ 请先上传数据后再启用全量上下文');
        return;
      }
      forceFullData = !forceFullData;
      updateFullDataToggle();
      saveConfig();
      if(forceFullData) {
        addSystemMessage(`⚠ 已开启全量上下文：将发送全部 ${currentData.length-1} 行数据。请注意 Token 与费用消耗。`);
      } else {
        addSystemMessage('ℹ 已关闭全量上下文，恢复所选策略采样。');
      }
    });

    /**********************
     * 文件上传与解析
     **********************/
    uploadArea.addEventListener('click',()=> fileInput.click());
    uploadArea.addEventListener('keydown', e => { if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); fileInput.click(); }});
    uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.classList.add('dragover'); });
    uploadArea.addEventListener('dragleave', e => { e.preventDefault(); uploadArea.classList.remove('dragover'); });
    uploadArea.addEventListener('drop', e => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      if(e.dataTransfer.files.length) processFile(e.dataTransfer.files[0]);
    });
    fileInput.addEventListener('change', e => {
      if(e.target.files[0]) processFile(e.target.files[0]);
    });

    function processFile(file) {
      currentFileName = file.name;
      showStatus(fileStatus,`📥 正在处理文件: ${file.name}`,'info');
      
      // 等待XLSX库加载完成
      if (typeof XLSX === 'undefined') {
        showStatus(fileStatus,'⏳ 正在加载Excel解析库，请稍候...','info');
        setTimeout(() => processFile(file), 1000);
        return;
      }
      
      const reader = new FileReader();
      if(/\.csv$/i.test(file.name)) {
        reader.onload = e => {
          try {
            const csv = e.target.result;
            const data = parseCSV(csv);
            processData(data);
          } catch(err) {
            showStatus(fileStatus,'❌ 解析失败: '+err.message,'error');
          }
        };
        reader.readAsText(file);
      } else if(/\.(xlsx|xls)$/i.test(file.name)) {
        reader.onload = e => {
          try {
            const u8 = new Uint8Array(e.target.result);
            const wb = XLSX.read(u8,{type:'array'});
            const first = wb.SheetNames[0];
            const ws = wb.Sheets[first];
            const json = XLSX.utils.sheet_to_json(ws,{header:1});
            processData(json);
          } catch(err) {
            showStatus(fileStatus,'❌ 解析失败: '+err.message,'error');
          }
        };
        reader.readAsArrayBuffer(file);
      } else {
        showStatus(fileStatus,'❌ 不支持的文件类型','error');
      }
    }

    function parseCSV(str) {
      // 简易 CSV 解析，支持基本的逗号分隔
      const lines = str.split(/\r?\n/).filter(l => l.trim().length);
      const result = [];
      
      for(let line of lines) {
        // 简单的CSV解析，可以处理基本情况
        const row = [];
        let current = '';
        let inQuotes = false;
        
        for(let i = 0; i < line.length; i++) {
          const char = line[i];
          if(char === '"') {
            inQuotes = !inQuotes;
          } else if(char === ',' && !inQuotes) {
            row.push(current.trim());
            current = '';
          } else {
            current += char;
          }
        }
        row.push(current.trim());
        result.push(row);
      }
      return result;
    }

    function processData(data) {
      currentData = data;
      computeStats(data);
      renderStats();
      renderStrategyAdvice();
      renderColumnProfiles();
      showDataSample('head');
      showStatus(fileStatus,`✅ 上传成功：${data.length-1} 行，${data[0]?data[0].length:0} 列`,'success');
      addSystemMessage(`📊 已加载文件 "${currentFileName}"。行数: ${data.length-1}，列数: ${data[0]?data[0].length:0}。您可以开始提问。`);
      // 若之前未启用全量，确保按钮状态刷新
      updateFullDataToggle();
    }

    /**********************
     * 数据统计
     **********************/
    function computeStats(data) {
      if(!data || !data.length) return;
      const headers = data[0];
      const rows = data.slice(1);
      dataStats = {
        totalRows: rows.length,
        totalColumns: headers.length,
        headers,
        nonEmptyRows: rows.filter(r => r.some(c=>c!==undefined && c!==null && c!=='')).length,
        columnStats:{}
      };
      headers.forEach((h,i)=>{
        const col = rows.map(r=>r[i]).filter(v=>v!==undefined && v!==null && v!=='');
        const numeric = col.filter(v => !isNaN(parseFloat(v)) && isFinite(v));
        const isNumeric = numeric.length > col.length * 0.7;
        let min,max,avg,median;
          if(isNumeric && numeric.length){
            const nums = numeric.map(Number).sort((a,b)=>a-b);
            min = nums[0];
            max = nums[nums.length-1];
            avg = nums.reduce((a,b)=>a+b,0)/nums.length;
            median = nums.length%2===0 ? (nums[nums.length/2-1]+nums[nums.length/2])/2 : nums[(nums.length-1)/2];
          }
        dataStats.columnStats[h] = {
          nonEmpty: col.length,
          empty: rows.length-col.length,
          unique: new Set(col).size,
          sample: col.slice(0,5),
          isNumeric,
          min,max,avg,median
        };
      });
    }

    function renderStats() {
      if(!dataStats.totalRows) { dataStatsDiv.innerHTML=''; return; }
      const complete = ((dataStats.nonEmptyRows / dataStats.totalRows)*100).toFixed(1);
      const numericCols = Object.values(dataStats.columnStats).filter(c=>c.isNumeric).length;
      const html = `
        <div class="stats-grid">
          ${statCard('总行数', dataStats.totalRows)}
          ${statCard('总列数', dataStats.totalColumns)}
          ${statCard('完整度', complete+'%', complete)}
          ${statCard('数值列', numericCols)}
        </div>
      `;
      dataStatsDiv.innerHTML = html;
    }

    function statCard(label,value,progress) {
      const prog = progress ? `
        <div class="progress-bar" style="--w:${Math.min(100,progress)}%;">
          <span></span>
        </div>` : '';
      return `
        <div class="stat-card">
          <div class="label">${label}</div>
          <div class="value">${value}</div>
          ${prog}
        </div>
      `;
    }

    function renderStrategyAdvice() {
      if(!dataStats.totalRows) { dataStrategyDiv.innerHTML=''; return; }
      let msg;
      if(dataStats.totalRows <= 100) {
        msg = '数据量较小，可直接使用 "完整数据" 策略传输全部记录以进行精确分析。';
      } else if(dataStats.totalRows <= 1000) {
        msg = '数据量适中，推荐使用 "智能采样" 策略（头部+中间随机+尾部+列统计）。';
      } else {
        msg = '数据量较大，建议使用 "结构化采样" 与统计摘要结合，降低Token消耗。';
      }
      if(forceFullData) {
        msg = '已强制启用全量上下文，将直接发送全部数据行。请确认模型上下文与费用可接受。';
      }
      dataStrategyDiv.innerHTML = `
        <div class="strategy-box fade-in">
          <div class="strategy-title"><i>💡</i> 推荐分析策略</div>
          <div class="strategy-text">${msg}</div>
        </div>
      `;
    }

    function renderColumnProfiles() {
      if(!dataStats.totalRows) { columnProfiles.innerHTML=''; return; }
      let html = '';
      Object.entries(dataStats.columnStats).forEach(([name,st])=>{
        const completeness = ((st.nonEmpty / dataStats.totalRows)*100).toFixed(1);
        html += `
          <div style="border:1px solid var(--border);background:var(--bg-alt);border-radius:12px;padding:10px 12px;display:flex;flex-direction:column;gap:6px;font-size:.65rem;">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:6px;">
              <strong style="font-size:.7rem;letter-spacing:.5px;">${name}</strong>
              <span style="padding:4px 8px;border-radius:6px;background:${st.isNumeric?'linear-gradient(135deg,#10b981,#059669)':'linear-gradient(135deg,#6366f1,#8b5cf6)'};color:#fff;font-weight:600;">${st.isNumeric?'数值':'文本'}</span>
            </div>
            <div style="display:flex;flex-wrap:wrap;gap:10px;">
              <span>完整: ${completeness}%</span>
              <span>非空: ${st.nonEmpty}</span>
              <span>唯一: ${st.unique}</span>
            </div>
            ${st.isNumeric && st.min!==undefined ? `
            <div style="display:flex;flex-wrap:wrap;gap:8px;">
              <span>范围: ${st.min} ~ ${st.max}</span>
              <span>均值: ${st.avg.toFixed(2)}</span>
              <span>中位数: ${st.median}</span>
            </div>` : `<div style="color:var(--text-soft);">示例: ${st.sample.slice(0,3).join(', ')}</div>`}
            <div class="progress-bar" style="--w:${Math.min(100,completeness)}%;margin-top:4px;"><span></span></div>
          </div>
        `;
      });
      columnProfiles.innerHTML = html;
    }

    /**********************
     * 数据预览
     **********************/
    function showDataSample(type) {
      if(!currentData) {
        tablePreview.innerHTML = '<div class="placeholder">尚未加载数据</div>';
        return;
      }
      let sample = [];
      let title = '';
      switch(type) {
        case 'head':
          sample = currentData.slice(0, Math.min(11,currentData.length));
          title = '前10行';
          break;
        case 'tail':
          const start = Math.max(1, currentData.length - 10);
          sample = [currentData[0], ...currentData.slice(start)];
          title = '后10行';
          break;
        case 'random':
          const rows = currentData.slice(1);
          const size = Math.min(10, rows.length);
          const idxs = new Set();
          while(idxs.size < size) {
            idxs.add(Math.floor(Math.random()*rows.length));
          }
          sample = [currentData[0], ...Array.from(idxs).sort((a,b)=>a-b).map(i=>rows[i])];
          title = '随机10行';
          break;
        case 'full':
          sample = currentData;
          title = '完整数据 (可能截断显示)';
          break;
      }
      renderTable(sample,title);
    }

    function renderTable(data,title) {
      if(!data || !data.length) {
        tablePreview.innerHTML = '<div class="placeholder">数据为空</div>';
        return;
      }
      const maxRows = Math.min(data.length-1,500);
      let thead = '<thead><tr>'+ data[0].map(h=>`<th title="${escapeHtml(h||'')}">${escapeHtml(h||'')}</th>`).join('') + '</tr></thead>';
      let body = '<tbody>';
      for(let i=1;i<=maxRows;i++) {
        const row = data[i] || [];
        body += '<tr>' + data[0].map((_,c)=> `<td title="${escapeHtml(row[c]||'')}">${escapeHtml(row[c]||'')}</td>`).join('') + '</tr>';
      }
      body += '</tbody>';
      tablePreview.innerHTML = `
        <div class="table-shell">
          <div style="padding:10px 12px;font-size:.7rem;font-weight:600;letter-spacing:.6px;background:var(--bg-soft);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;">
            <span>📄 ${title}</span>
            <span style="color:var(--text-soft);font-weight:500;">显示 ${maxRows} / ${data.length-1} 行</span>
          </div>
          <div class="table-scroll">
            <table>${thead}${body}</table>
          </div>
          ${data.length-1>500?'<div class="table-footer">已截断显示前500行</div>':''}
        </div>`;
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, s=>({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      })[s]);
    }

    function downloadSample() {
      const table = tablePreview.querySelector('table');
      if(!table) return;
      let csv = [];
      const rows = table.querySelectorAll('tr');
      rows.forEach(r=>{
        const cells = Array.from(r.children).map(c=>`"${c.textContent.replace(/"/g,'""')}"`);
        csv.push(cells.join(','));
      });
      const blob = new Blob([csv.join('\n')],{type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = (currentFileName.replace(/\.(csv|xlsx?|)$/i,'') || 'data')+'_preview.csv';
      a.click();
    }

    /**********************
     * Chat 相关
     **********************/
    function addSystemMessage(msg) {
      const div = document.createElement('div');
      div.className='msg system';
      div.textContent = msg;
      chatMessages.appendChild(div);
      scrollChatBottom();
    }
    function addUserMessage(msg) {
      const div = document.createElement('div');
      div.className='msg user';
      div.textContent = msg;
      chatMessages.appendChild(div);
      scrollChatBottom();
    }
    function addAIMessage(msg) {
      const div = document.createElement('div');
      div.className='msg ai';
      div.innerHTML = `<div class="markdown">${renderMarkdown(msg)}</div>
        <div class="tools">
          <button class="mini-btn" onclick="copyText(this)">复制</button>
        </div>`;
      chatMessages.appendChild(div);
      scrollChatBottom();
    }
    function addLoadingMessage() {
      const div = document.createElement('div');
      div.className='msg ai';
      div.id='loadingMessage';
      div.innerHTML='<div style="display:flex;align-items:center;gap:10px;"><div class="loading" style="border-color:rgba(99,102,241,.2);border-top-color:var(--brand);"></div><span>AI 正在分析数据...</span></div>';
      chatMessages.appendChild(div);
      scrollChatBottom();
    }
    function removeLoadingMessage() {
      const el = document.getElementById('loadingMessage');
      if(el) el.remove();
    }
    function scrollChatBottom() {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function copyText(btn) {
      const parent = btn.closest('.msg');
      if(!parent) return;
      const text = parent.innerText;
      navigator.clipboard.writeText(text).then(()=>{
        btn.textContent='已复制';
        setTimeout(()=> btn.textContent='复制',1500);
      });
    }

    function quickAsk(q) {
      chatInput.value = q;
      sendMessage();
    }

    chatInput.addEventListener('input', ()=>{
      charCounter.textContent = `${chatInput.value.length} / 4000`;
    });

    chatInput.addEventListener('keydown', e => {
      if(e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    function toggleWrap() {
      wrapEnabled = !wrapEnabled;
      chatMessages.style.whiteSpace = wrapEnabled? 'pre-wrap':'pre';
      document.getElementById('wrapBtn').textContent = wrapEnabled? '↩️ 换行':'↪️ 单行';
    }

    document.getElementById('clearChatBtn').addEventListener('click', ()=>{
      if(confirm('确认清空全部对话？')) {
        chatMessages.innerHTML = '<div class="msg system">🗑️ 对话已清空，可以继续新的分析。</div>';
      }
    });

    function stopRequest() {
      if(abortController) {
        abortController.abort();
        stopBtn.disabled = true;
        addSystemMessage('⏹ 已尝试停止请求');
      }
    }

    async function sendMessage() {
      const msg = chatInput.value.trim();
        if(!msg) return;
        if(!currentData) {
          addSystemMessage('❌ 请先上传数据文件');
          return;
        }
        const baseUrl = document.getElementById('baseUrl').value.trim();
        const apiKey = document.getElementById('apiKey').value.trim();
        const modelId = document.getElementById('modelId').value.trim();
        if(!baseUrl || !apiKey || !modelId) {
          addSystemMessage('❌ 请完善 API 配置');
          return;
        }
        addUserMessage(msg);
        chatInput.value='';
        charCounter.textContent = '0 / 4000';

        addLoadingMessage();
        stopBtn.disabled = false;

        const strategy = dataStrategySelect.value;
        const dataContext = buildDataContext(currentData,strategy);

        abortController = new AbortController();

        try {
          const res = await fetch(`${baseUrl}/chat/completions`,{
            method:'POST',
            headers:{
              'Content-Type':'application/json',
              'Authorization':'Bearer '+apiKey
            },
            body: JSON.stringify({
              model: modelId,
              temperature: 0.7,
              max_tokens: 2000,
              messages: [
                {
                  role:'system',
                  content: `你是资深数据分析助手。用户已上传文件 "${currentFileName}"。
数据统计:
- 行数: ${dataStats.totalRows}
- 列数: ${dataStats.totalColumns}
- 完整度: ${((dataStats.nonEmptyRows/dataStats.totalRows)*100).toFixed(1)}%

${dataContext}

请基于上述上下文进行严谨、结构化、可验证的回答。可使用条目、要点、分段、必要时给出进一步探索建议。${forceFullData?'(注意：已传输全量数据，请侧重准确总结)':''}`
                },
                { role:'user', content: msg }
              ]
            }),
            signal: abortController.signal
          });
          removeLoadingMessage();
          stopBtn.disabled = true;
          if(!res.ok) throw new Error(`API错误 ${res.status} ${res.statusText}`);
          const data = await res.json();
          const content = data.choices?.[0]?.message?.content || '(无内容返回)';
          addAIMessage(content);
        } catch(err) {
          removeLoadingMessage();
          stopBtn.disabled = true;
          if(err.name === 'AbortError') {
            addSystemMessage('⚠️ 请求已中止');
          } else {
            addSystemMessage('❌ 请求失败: '+err.message);
          }
        } finally {
          abortController = null;
        }
      }

      function buildDataContext(data,strategy) {
        if(!data || !data.length) return '数据为空';
        // 若启用强制全量，忽略策略
        if(forceFullData) {
          return fullDataAll(data);
        }
        const headers = data[0];
        const rows = data.slice(1);
        let ctx = `数据列: ${headers.join(', ')}\n策略: ${strategy}\n\n`;
        switch(strategy) {
          case 'full':
            if(rows.length <= 100) {
              ctx += '完整数据:\n'+headers.join(' | ')+'\n';
              rows.forEach(r=>ctx += r.join(' | ')+'\n');
            } else {
              ctx += '数据较大，自动降级为智能采样。\n'+smartSample(data);
            }
            break;
          case 'smart':
            ctx += smartSample(data);
            break;
          case 'summary':
            ctx += statSummary(data);
            break;
          case 'structured':
            ctx += structuredSample(data);
            break;
          default:
            ctx += smartSample(data);
        }
        return ctx;
      }

      function fullDataAll(data) {
        const headers = data[0];
        let s = `全量数据上下文 (行:${data.length-1} 列:${headers.length})\n${headers.join(' | ')}\n`;
        for(let i=1;i<data.length;i++){
          s += data[i].join(' | ') + '\n';
        }
        // 附加列统计
        s += '\n列统计:\n';
        headers.forEach(h=>{
          const st = dataStats.columnStats[h];
          s += `${h}: 非空${st.nonEmpty}, 唯一${st.unique}` + (st.isNumeric?`, 范围[${st.min}-${st.max}], 均值${st.avg.toFixed(2)}, 中位数${st.median}`:` 示例(${st.sample.slice(0,3).join(', ')})`) + '\n';
        });
        return s;
      }

      function smartSample(data) {
        const headers = data[0];
        const rows = data.slice(1);
        let s = '';
        // 头部
        s += '头部样本(前5行):\n'+headers.join(' | ')+'\n';
        rows.slice(0,5).forEach(r=> s+= r.join(' | ')+'\n');
        // 中间随机
        if(rows.length>20) {
          s += '\n中部随机(5行):\n'+headers.join(' | ')+'\n';
          const midStart = Math.floor(rows.length*0.25);
          const midEnd = Math.floor(rows.length*0.75);
          const midRows = rows.slice(midStart,midEnd);
          const picks = [];
          while(picks.length < Math.min(5,midRows.length)) {
            const candidate = midRows[Math.floor(Math.random()*midRows.length)];
            if(!picks.includes(candidate)) picks.push(candidate);
          }
          picks.forEach(r=> s+= r.join(' | ')+'\n');
        }
        // 尾部
        if(rows.length > 10) {
          s += '\n尾部样本(后3行):\n'+headers.join(' | ')+'\n';
          rows.slice(-3).forEach(r=> s+= r.join(' | ')+'\n');
        }
        // 列统计
        s += '\n列统计:\n';
        headers.forEach(h=>{
          const st = dataStats.columnStats[h];
          s += `${h}: 非空${st.nonEmpty}, 唯一${st.unique}`;
          if(st.isNumeric) {
            s+= `, 范围[${st.min}-${st.max}], 均值${st.avg.toFixed(2)}, 中位数${st.median}`;
          } else {
            s+= `, 示例(${st.sample.slice(0,3).join(', ')})`;
          }
          s+='\n';
        });
        return s;
      }

      function statSummary(data) {
        const headers = data[0];
        let s = '统计摘要:\n';
        headers.forEach(h=>{
          const st = dataStats.columnStats[h];
          s += `\n[${h}] 类型:${st.isNumeric?'数值':'文本'} 非空:${st.nonEmpty}/${dataStats.totalRows} 唯一:${st.unique}\n`;
          if(st.isNumeric) s+= `最小:${st.min} 最大:${st.max} 均值:${st.avg.toFixed(2)} 中位数:${st.median}\n`;
          else s+= `示例:${st.sample.slice(0,5).join(', ')}\n`;
        });
        return s;
      }

      function structuredSample(data) {
        const headers = data[0];
        const rows = data.slice(1);
        let s = '结构化采样:\n';
        const sampleSize = Math.min(50, Math.max(10, Math.floor(rows.length * 0.1)));
        const interval = Math.max(1, Math.floor(rows.length / sampleSize));
        s += `分层周期:${interval} 共:${sampleSize}\n${headers.join(' | ')}\n`;
        for(let i=0;i<sampleSize && i*interval < rows.length;i++) {
          s+= rows[i*interval].join(' | ')+'\n';
        }
        s+='\n'+statSummary(data);
        return s;
      }

      /**********************
       * Markdown 渲染(简易)
       **********************/
      function renderMarkdown(text) {
        if(!text) return '';
        let html = escapeHtml(text);
        // 粗体 **text**
        html = html.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
        // 代码块 ```...```
        html = html.replace(/```([\s\S]*?)```/g, (m,code)=> `<pre style="background:#0f172a15;padding:10px 12px;border-radius:10px;overflow:auto;font-size:.65rem;"><code>${escapeHtml(code.trim())}</code></pre>`);
        // 行内代码
        html = html.replace(/`([^`]+?)`/g,'<code>$1</code>');
        // 无序列表 (简单替换)
        html = html.replace(/(^|\n)- (.+)/g,'$1• $2');
        // 换行 -> 段
        html = html.replace(/\n{2,}/g,'</p><p>');
        html = '<p>'+html+'</p>';
        return html;
      }

      /**********************
       * 状态消息
       **********************/
      function showStatus(container,msg,type='info') {
        container.innerHTML = `<div class="status ${type}">${msg}</div>`;
      }

      /**********************
       * 连接测试
       **********************/
      async function testConnection() {
        const baseUrl = document.getElementById('baseUrl').value.trim();
        const apiKey = document.getElementById('apiKey').value.trim();
        const modelId = document.getElementById('modelId').value.trim();
        const statusDiv = document.getElementById('connectionStatus');
        if(!baseUrl || !apiKey || !modelId) {
          statusDiv.innerHTML = '<div class="status error">❌ 请填写完整配置</div>';
          return;
        }
        statusDiv.innerHTML = '<div class="status info"><div class="loading"></div> 正在测试...</div>';
        try {
          const res = await fetch(`${baseUrl}/chat/completions`,{
            method:'POST',
            headers:{
              'Content-Type':'application/json',
              'Authorization':'Bearer '+apiKey
            },
            body: JSON.stringify({
              model:modelId,
              max_tokens: 10,
              messages:[{role:'user',content:'请回复: 连接成功'}]
            })
          });
          if(res.ok) statusDiv.innerHTML = '<div class="status success">✅ 连接成功</div>';
          else throw new Error(res.status+' '+res.statusText);
        } catch(err) {
          statusDiv.innerHTML = `<div class="status error">❌ 失败: ${err.message}</div>`;
        }
      }

      /**********************
       * 拖拽调整面板宽度
       **********************/
      const resizer = document.getElementById('resizer');
      const leftPanel = document.getElementById('leftPanel');
      const centerPanel = document.getElementById('centerPanel');
      let isResizing = false;
      resizer.addEventListener('mousedown', e=>{
        isResizing = true;
        resizer.classList.add('active');
        document.body.style.userSelect='none';
      });
      window.addEventListener('mousemove', e=>{
        if(!isResizing) return;
        const layoutRect = document.getElementById('layoutRoot').getBoundingClientRect();
        const min = 280;
        const max = 640;
        let newWidth = e.clientX - layoutRect.left;
        if(newWidth < min) newWidth = min;
        if(newWidth > max) newWidth = max;
        leftPanel.style.width = newWidth+'px';
        leftPanel.style.flex = '0 0 '+newWidth+'px';
      });
      window.addEventListener('mouseup', ()=>{
        if(isResizing) {
          isResizing = false;
          resizer.classList.remove('active');
          document.body.style.userSelect='';
        }
      });

      /**********************
       * 初始化
       **********************/
      dataStrategySelect.addEventListener('change', ()=>{
        saveConfig();
        if(!forceFullData) renderStrategyAdvice();
      });

      // 初始按钮状态
      updateFullDataToggle();
  </script>
</body>
</html>